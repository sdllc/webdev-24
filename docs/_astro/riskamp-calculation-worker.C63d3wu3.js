/*! RiskAMP Web v31.1.0. Copyright 2018-2024 Structured Data, LLC. All rights reserved. */var e='var ks=Object.create;var Ur=Object.defineProperty;var Es=Object.getOwnPropertyDescriptor;var Ts=Object.getOwnPropertyNames;var Us=Object.getPrototypeOf,Vs=Object.prototype.hasOwnProperty;var Ds=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports),Is=(o,e)=>{for(var t in e)Ur(o,t,{get:e[t],enumerable:!0})},Fs=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ts(e))!Vs.call(o,i)&&i!==t&&Ur(o,i,{get:()=>e[i],enumerable:!(r=Es(e,i))||r.enumerable});return o};var Ls=(o,e,t)=>(t=o!=null?ks(Us(o)):{},Fs(e||!o||!o.__esModule?Ur(t,"default",{value:o,enumerable:!0}):t,o));var As=Ds(Rr=>{"use strict";Rr.byteLength=La;Rr.toByteArray=Pa;Rr.fromByteArray=Ga;var be=[],ce=[],Fa=typeof Uint8Array<"u"?Uint8Array:Array,Mi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(tt=0,Cs=Mi.length;tt<Cs;++tt)be[tt]=Mi[tt],ce[Mi.charCodeAt(tt)]=tt;var tt,Cs;ce[45]=62;ce[95]=63;function Ss(o){var e=o.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=o.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function La(o){var e=Ss(o),t=e[0],r=e[1];return(t+r)*3/4-r}function Na(o,e,t){return(e+t)*3/4-t}function Pa(o){var e,t=Ss(o),r=t[0],i=t[1],n=new Fa(Na(o,r,i)),s=0,a=i>0?r-4:r,l;for(l=0;l<a;l+=4)e=ce[o.charCodeAt(l)]<<18|ce[o.charCodeAt(l+1)]<<12|ce[o.charCodeAt(l+2)]<<6|ce[o.charCodeAt(l+3)],n[s++]=e>>16&255,n[s++]=e>>8&255,n[s++]=e&255;return i===2&&(e=ce[o.charCodeAt(l)]<<2|ce[o.charCodeAt(l+1)]>>4,n[s++]=e&255),i===1&&(e=ce[o.charCodeAt(l)]<<10|ce[o.charCodeAt(l+1)]<<4|ce[o.charCodeAt(l+2)]>>2,n[s++]=e>>8&255,n[s++]=e&255),n}function za(o){return be[o>>18&63]+be[o>>12&63]+be[o>>6&63]+be[o&63]}function Oa(o,e,t){for(var r,i=[],n=e;n<t;n+=3)r=(o[n]<<16&16711680)+(o[n+1]<<8&65280)+(o[n+2]&255),i.push(za(r));return i.join("")}function Ga(o){for(var e,t=o.length,r=t%3,i=[],n=16383,s=0,a=t-r;s<a;s+=n)i.push(Oa(o,s,s+n>a?a:s+n));return r===1?(e=o[t-1],i.push(be[e>>2]+be[e<<4&63]+"==")):r===2&&(e=(o[t-2]<<8)+o[t-1],i.push(be[e>>10]+be[e>>4&63]+be[e<<2&63]+"=")),i.join("")}});var Z=o=>o!==null&&typeof o=="object"&&"row"in o&&"column"in o;var M=class o{start_;end_;constructor(e,t=e,r=!1){this.end_=this.PatchNull(t),this.start_=this.PatchNull(e),r&&this.Normalize()}static FromColumn(e){return new o({row:1/0,column:e})}static FromRow(e){return new o({row:e,column:1/0})}static ColumnToLabel(e){let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}static CellAddressToLabel(e,t=!1){if(e.row===1/0&&e.column===1/0)throw new Error("this is going to break something");let r=t?`${e.sheet_id||0}!`:"";return e.row===1/0?r+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column):e.column===1/0?r+(e.absolute_row?"$":"")+(e.row+1):r+(e.absolute_column?"$":"")+this.ColumnToLabel(e.column)+(e.absolute_row?"$":"")+(e.row+1)+(e.spill?"#":"")}static Join(e,...t){let r=new o(e.start,e.end);for(let i of t)i&&(r.ConsumeAddress(i.start),r.ConsumeAddress(i.end));return r}static Bleed(e,t=1){return new o({row:Math.max(0,e.start.row-t),column:Math.max(0,e.start.column-t),sheet_id:e.start.sheet_id},{row:e.end.row+t,column:e.end.column+t})}static PatchArea(e,t){let{before_column:r,column_count:i,before_row:n,row_count:s}=t,a=new o(e.start,e.end),l=e.start.sheet_id;if(i&&r<=a.end.column){if(i>0)r<=a.start.column?a.Shift(0,i):r>a.start.column&&r<=a.end.column?a.ConsumeAddress({row:a.end.row,column:a.end.column+i}):console.warn("AA X case 1",r,i,JSON.stringify(a));else if(i<0)if(r-i<=a.start.column)a.Shift(0,i);else{if(r<=a.start.column&&r-i>a.end.column)return!1;if(r<=a.start.column){let u=r-i-1;a=new o({row:a.start.row,column:u+1+i,sheet_id:l},{row:a.end.row,column:a.end.column+i})}else r<=a.end.column?r-i-1>=a.end.column?a=new o({row:a.start.row,column:a.start.column,sheet_id:l},{row:a.end.row,column:r-1}):a=new o({row:a.start.row,column:a.start.column,sheet_id:l},{row:a.end.row,column:a.start.column+a.columns+i-1}):console.warn("AA X case 2",r,i,JSON.stringify(a))}}if(s&&n<=a.end.row){if(s>0)n<=a.start.row?a.Shift(s,0):n>a.start.row&&n<=a.end.row?a.ConsumeAddress({row:a.end.row+s,column:a.end.column}):console.warn("AA X case 3",n,s,JSON.stringify(a));else if(s<0)if(n-s<=a.start.row)a.Shift(s,0);else{if(n<=a.start.row&&n-s>a.end.row)return!1;if(n<=a.start.row){let u=n-s-1;a=new o({column:a.start.column,row:u+1+s,sheet_id:l},{column:a.end.column,row:a.end.row+s})}else n<=a.end.row?n-s-1>=a.end.row?a=new o({column:a.start.column,row:a.start.row,sheet_id:l},{column:a.end.column,row:n-1}):a=new o({column:a.start.column,row:a.start.row,sheet_id:l},{column:a.end.column,row:a.start.row+a.rows+s-1}):console.warn("AA X case 4",n,s,JSON.stringify(a))}}return a}get start(){return{...this.start_}}set start(e){this.start_=e}get end(){return{...this.end_}}set end(e){this.end_=e}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(e){let t={...e};return t.row===null&&(t.row=1/0),t.column===null&&(t.column=1/0),t}SetSheetID(e){this.start_.sheet_id=e}Normalize(){let e={...this.start_},t={...this.end_};e.row===1/0||t.row===1/0?e.row=t.row=1/0:e.row>t.row&&(e.row=this.end_.row,e.absolute_row=this.end_.absolute_row,t.row=this.start_.row,t.absolute_row=this.start_.absolute_row),e.column===1/0||t.column===1/0?e.column=t.column=1/0:e.column>t.column&&(e.column=this.end_.column,e.absolute_column=this.end_.absolute_column,t.column=this.start_.column,t.absolute_column=this.start_.absolute_column),this.start_=e,this.end_=t}TopLeft(){let e={row:0,column:0};return this.entire_row||(e.column=this.start.column),this.entire_column||(e.row=this.start.row),e}BottomRight(){let e={row:0,column:0};return this.entire_row||(e.column=this.end.column),this.entire_column||(e.row=this.end.row),e}ContainsRow(e){return this.entire_column||e>=this.start_.row&&e<=this.end_.row}ContainsColumn(e){return this.entire_row||e>=this.start_.column&&e<=this.end_.column}Contains(e){return(this.entire_column||e.row>=this.start_.row&&e.row<=this.end_.row)&&(this.entire_row||e.column>=this.start_.column&&e.column<=this.end_.column)}ContainsArea(e){return this.start.column<=e.start.column&&this.end.column>=e.end.column&&this.start.row<=e.start.row&&this.end.row>=e.end.row}Intersects(e){return!(e.start.column>this.end.column||this.start.column>e.end.column||e.start.row>this.end.row||this.start.row>e.end.row)}Equals(e){return e.start_.row===this.start_.row&&e.start_.column===this.start_.column&&e.end_.row===this.end_.row&&e.end_.column===this.end_.column}Equals2(e){return e.start.row===this.start_.row&&e.start.column===this.start_.column&&e.end.row===this.end_.row&&e.end.column===this.end_.column}Clone(){return new o(this.start,this.end)}get left(){let e=new o(this.start_,this.end_);return e.end_.column=e.start_.column,e}get right(){let e=new o(this.start_,this.end_);return e.start_.column=e.end_.column,e}get top(){let e=new o(this.start_,this.end_);return e.end_.row=e.start_.row,e}get bottom(){let e=new o(this.start_,this.end_);return e.start_.row=e.end_.row,e}Shift(e,t){return this.start_.row+=e,this.start_.column+=t,this.end_.row+=e,this.end_.column+=t,this}ConsumeAddress(e){this.entire_row||(e.column<this.start_.column&&(this.start_.column=e.column),e.column>this.end_.column&&(this.end_.column=e.column)),this.entire_column||(e.row<this.start_.row&&(this.start_.row=e.row),e.row>this.end_.row&&(this.end_.row=e.row))}Reshape(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}ConsumeArea(e){this.ConsumeAddress(e.start),this.ConsumeAddress(e.end)}Resize(e,t){return this.end_.row=this.start_.row+e-1,this.end_.column=this.start_.column+t-1,this}[Symbol.iterator](){if(this.entire_row||this.entire_column)throw new Error("don\'t iterate infinite area");let e=this.start_.row,t=this.start_.column;return{next:()=>{let r={column:t,row:e,sheet_id:this.start_.sheet_id};return t>this.end_.column?{done:!0,value:void 0}:(++e>this.end_.row&&(e=this.start_.row,t++),{value:r})}}}get spreadsheet_label(){let e;return this.entire_sheet?"":this.entire_column?(e=o.ColumnToLabel(this.start_.column),e+=":"+o.ColumnToLabel(this.end_.column),e):this.entire_row?(e=String(this.start_.row+1),e+=":"+(this.end_.row+1),e):(e=o.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?e+":"+o.CellAddressToLabel(this.end_):e)}toJSON(){return{start:{...this.start_},end:{...this.end_}}}};var rt=o=>typeof o=="object"&&!!o&&typeof o.real=="number"&&typeof o.imaginary=="number";var Vr=o=>typeof o=="object"&&!!o&&typeof o.value=="number"&&typeof o.unit=="string",Ns=o=>typeof o=="object"&&o.type==="function",Dr=["undefined","formula","string","number","boolean","object","function","error","complex","array","dimensioned_quantity"];var re=o=>{switch(typeof o){case"undefined":return 0;case"number":return 3;case"boolean":return 4;case"object":return o===null?0:Ns(o)?10:rt(o)?7:Vr(o)?9:5;case"string":return o[0]==="="?1:2;default:return 6}};var K=class{static StringToColumn(e){let t=0;e=e.toUpperCase();for(let r=0;r<e.length;r++)t*=26,t+=e.charCodeAt(r)-64;return t-1}value;type=0;calculated;calculated_type;formatted;rendered_type;style;area;spill;merge_area;table;renderer_data;render_clean=[];note;hyperlink;editing;render_function;click_function;constructor(e,t){typeof e<"u"&&this.Set(e,t)}ValueIsNumber(){return this.type===3}ValueIsFormula(){return this.type===1}ValueIsBoolean(){return this.type===4}ValueIsComplex(){return this.type===7}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_clean=[]}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_clean=[]}Reset(){this.type=0,this.value=this.spill=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_clean=[]}Set(e,t=re(e)){this.value=e,this.type=t,this.spill=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_clean=[]}SetCalculatedValue(e,t=re(e)){e===void 0&&(e=0,t=3),this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_clean=[])}GetValue(){return this.calculated_type?this.calculated:typeof this.value=="string"&&this.value[0]==="\'"?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===1?{type:3,value:0}:{type:this.type,value:typeof this.value=="string"&&this.value[0]==="\'"?this.value.slice(1):this.value}}SetNote(e){this.note=e,this.render_clean=[]}SetCalculationError(e="ERR"){this.SetCalculatedValue(e,6)}SetArray(e){this.type=0,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}SetArrayHead(e,t){this.type=re(t),this.value=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}};var Ps=o=>!o.cells,Ir=o=>!!o[0]&&Ps(o[0]),Fr=o=>!!o[0]&&o[0].row!==void 0,zs=Dr.map((o,e)=>({[o]:e})).reduce((o,e)=>({...o,...e}),{}),It=class{data=[];rows_=0;columns_=0;get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(e){this.rows_=Math.max(e+1,this.rows_)}EnsureColumn(e){this.columns_=Math.max(e+1,this.columns_)}InsertColumns(e=0,t=1){this.data=this.data.map(r=>{if(r.length>=e){let i=r.slice(0,e),n=e+t,s=r.slice(e);for(let a=0;a<s.length;a++)i[n++]=s[a];return i}return r}),this.columns_+=t}DeleteColumns(e,t=1){this.data.forEach(r=>r.splice(e,t)),this.columns_-=t}DeleteRows(e,t=1){this.data.splice(e,t),this.rows_-=t}InsertRows(e=0,t=1){let r=[e,0,[]];for(let i=1;i<t;i++)r.push([]);Array.prototype.splice.apply(this.data,r),this.rows_+=t}GetCell(e,t){let{row:r,column:i}=e;if(!this.data[r])if(t)this.data[r]=[],this.rows_=Math.max(this.rows_,r+1);else return;return this.data[r][i]||t&&(this.data[r][i]=new K,this.columns_=Math.max(this.columns_,i+1)),this.data[r][i]}EnsureCell(e){let{row:t,column:r}=e,i=this.data[t];i||(this.data[t]=i=[],this.rows_=Math.max(this.rows_,t+1));let n=i[r];return n||(n=i[r]=new K,this.columns_=Math.max(this.columns_,r+1)),n}FromArray(e=[],t=!1){this.data=[];let r=0,i=0;if(t){i=e.length;for(let n=0;n<i;n++){let s=e[n];r=Math.max(r,s.length);for(let a=0;a<s.length;a++)this.data[a]||(this.data[a]=[]),this.data[a][n]=new K(s[a])}}else{r=e.length;for(let n=0;n<r;n++){let s=[],a=e[n];i=Math.max(i,a.length);for(let l=0;l<a.length;l++)s[l]=new K(a[l]);this.data[n]=s}}this.rows_=r,this.columns_=i}SerializedTypeToValueType(e){if(e)return typeof e=="number"?e:zs[e]||void 0}ValueTypeToSerializedType(e){return e?Dr[e]:void 0}FromJSON(e=[],t){if(this.data=[],!Ir(e)){let i=[];if(Fr(e))for(let n of e)for(let s of n.cells)i.push({...s,row:n.row});else for(let n of e)for(let s of n.cells)i.push({...s,column:n.column});e=i}let r=[];for(let i of e){this.data[i.row]||(this.data[i.row]=[]);let n=new K(i.value);if(typeof i.calculated<"u"&&(n.SetCalculatedValue(i.calculated,this.SerializedTypeToValueType(i.calculated_type)),i.spill&&(n.spill=new M(i.spill.start,i.spill.end))),t&&typeof i.style_ref<"u"&&(n.style=t[i.style_ref]),typeof i.note<"u"&&(n.note=i.note),typeof i.hyperlink<"u"&&(n.hyperlink=i.hyperlink),this.data[i.row][i.column]&&this.data[i.row][i.column].area&&(n.area=this.data[i.row][i.column].area),this.data[i.row][i.column]=n,i.area){let s=new M(i.area.start,i.area.end);for(let a=s.start.row;a<=s.end.row;a++)for(let l=s.start.column;l<=s.end.column;l++)this.data[a]||(this.data[a]=[]),this.data[a][l]||(this.data[a][l]=new K),this.data[a][l].area=s}if(i.table&&r.push({...i.table}),i.merge_area){let s=new M(i.merge_area.start,i.merge_area.end);for(let a=s.start.row;a<=s.end.row;a++)for(let l=s.start.column;l<=s.end.column;l++)this.data[a]||(this.data[a]=[]),this.data[a][l]||(this.data[a][l]=new K),this.data[a][l].merge_area=s}}for(let i of r)for(let n=i.area.start.row;n<=i.area.end.row;n++)for(let s=i.area.start.column;s<=i.area.end.column;s++)this.data[n]||(this.data[n]=[]),this.data[n][s]||(this.data[n][s]=new K),this.data[n][s].table=i;this.rows_=this.data.length,this.columns_=this.data.reduce((i,n)=>Math.max(i,n.length),0)}toJSON(e={}){let t=0,r=0,i=this.data.length-1,n;e.subset&&(t=e.subset.start.column,r=e.subset.start.row,i=e.subset.end.row);let s=[],a=-1,l=-1,u={},c={};for(let h=r;h<=i;h++)if(this.data[h]){let f=this.data[h];n=f.length-1,e.subset&&(n=e.subset.end.column);for(let d=t;d<=n;d++){let m=f[d],_=m&&m.merge_area&&m.merge_area.start.row===h&&m.merge_area.start.column===d,y=m&&m.area&&m.area.start.row===h&&m.area.start.column===d,v=m&&m.table&&m.table.area.start.row===h&&m.table.area.start.column===d,w=m?m.type===2&&!m.value:!0;if(m&&(!w||e.preserve_empty_strings)&&(_||m.type||m.calculated_type&&e.expand_arrays||m.calculated_type&&e.calculated_value||m.note||e.decorated_cells&&m.style&&(m.style.fill||m.style.border_bottom||m.style.border_top||m.style.border_left||m.style.border_right))){let x={row:h,column:d,value:m.value};m.note&&(x.note=m.note),m.hyperlink&&(x.hyperlink=m.hyperlink),e.preserve_type&&(x.type=this.ValueTypeToSerializedType(m.type)),e.sheet_id&&(x.sheet_id=e.sheet_id),e.calculated_value&&typeof m.calculated<"u"&&(x.calculated=m.calculated,m.spill&&(x.spill=m.spill.toJSON()),(e.preserve_type||m.calculated_type===6)&&(x.calculated_type=this.ValueTypeToSerializedType(m.calculated_type))),m.table&&v&&e.tables&&(x.table=JSON.parse(JSON.stringify(m.table))),m.area&&y&&(x.area=m.area.toJSON()),m.merge_area&&(x.merge_area=m.merge_area.toJSON()),e.cell_style_refs&&e.cell_style_refs[d]&&e.cell_style_refs[d][h]&&(x.style_ref=e.cell_style_refs[d][h],e.cell_style_refs[d][h]=0),u[h]=h,c[d]=d,a=Math.max(h,a),l=Math.max(d,l),s.push(x)}}}if(e.nested){let h=Object.keys(u),f=Object.keys(c);if(h.length<=f.length&&h.length){let d={},m=[];for(let _ of s){let{row:y,...v}=_;d[_.row]||(d[_.row]=[]),d[_.row].push(v)}for(let _ of h){let y=Number(_);m.push({row:y,cells:d[y]})}return{data:m,rows:a,columns:l+1}}else if(f.length){let d={},m=[];for(let _ of s){let{column:y,...v}=_;d[_.column]||(d[_.column]=[]),d[_.column].push(v)}for(let _ of f){let y=Number(_);m.push({column:y,cells:d[y]})}return{data:m,rows:a,columns:l+1}}}return{data:s,rows:a+1,columns:l+1}}GetAll(e=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},e)}Normalize(e,t){return e={...e,row:e.row==1/0?0:e.row,column:e.column==1/0?0:e.column},t&&(t={...t,row:t.row==1/0?this.rows_-1:t.row,column:t.column==1/0?this.columns_-1:t.column}),{from:e,to:t}}RawValue(e,t=e){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].value:void 0;let r=[],i=this.data.slice(e.row,t.row+1),n=e.column,s=t.column+1;for(let a of i){let l=[];for(let u=n,c=0;u<s;u++,c++){let h=a[u];l.push(h?h.value:void 0)}r.push(l)}return r}GetRange(e,t,r=!1){if({from:e,to:t}=this.Normalize(e,t),!t||e===t||e.column===t.column&&e.row===t.row)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue():void 0;let i=[];if(r)for(let n=e.column;n<=t.column;n++){let s=[];for(let a=e.row;a<=t.row;a++)this.data[a]&&this.data[a][n]?s.push(this.data[a][n].GetValue()):s.push(void 0);i.push(s)}else for(let n=e.row;n<=t.row;n++){let s=[];for(let a=e.column;a<=t.column;a++)this.data[n]&&this.data[n][a]?s.push(this.data[n][a].GetValue()):s.push(void 0);i.push(s)}return i}GetRange4(e,t=e,r=!1){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue4():{value:void 0,type:0};let i=[];if(r)for(let n=e.column;n<=t.column;n++){let s=[];for(let a=e.row;a<=t.row;a++)this.data[a]&&this.data[a][n]?s.push(this.data[a][n].GetValue4()):s.push({type:0});i.push(s)}else for(let n=e.row;n<=t.row;n++){let s=[];for(let a=e.column;a<=t.column;a++)this.data[n]&&this.data[n][a]?s.push(this.data[n][a].GetValue4()):s.push({type:0});i.push(s)}return{type:8,value:i}}SetArea(e,t){if(ArrayBuffer.isView(t))throw new Error("ABIV");if(Array.isArray(t))for(let r=e.start.row,i=0;r<=e.end.row;r++,i++){this.data[r]||(this.data[r]=[]);let n=this.data[r];if(t[i])for(let s=e.start.column,a=0;s<=e.end.column;s++,a++)n[s]||(n[s]=new K),n[s].Set(t[i][a])}else{let r=re(t);for(let i=e.start.row;i<=e.end.row;i++){this.data[i]||(this.data[i]=[]);let n=this.data[i];for(let s=e.start.column;s<=e.end.column;s++)n[s]||(n[s]=new K),n[s].Set(t,r)}}this.rows_=Math.max(this.rows_,e.end.row+1),this.columns_=Math.max(this.columns_,e.end.column+1)}*IterateRC(e,t=!1){if(!e&&t&&(e=new M({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e)if(t)for(let r=e.start.row;r<=e.end.row;r++){this.data[r]||(this.data[r]=[]);let i=this.data[r];for(let n=e.start.column;n<=e.end.column;n++)i[n]||(i[n]=new K),yield{cell:i[n],row:r,column:n}}else for(let r=e.start.row;r<=e.end.row;r++){let i=this.data[r];if(i)for(let n=e.start.column;n<=e.end.column;n++){let s=i[n];s&&(yield{cell:s,row:r,column:n})}}else for(let[r,i]of this.data.entries())if(i)for(let[n,s]of i.entries())s&&(yield{cell:s,row:r,column:n})}*Iterate(e,t=!1){if(!e&&t&&(e=new M({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e){Z(e)&&(e=new M(e)),(e.entire_column||e.entire_row)&&(e=new M(e.start,e.end),e.start.column===1/0&&(e.start.column=0,e.end.column=this.columns_-1),e.start.row===1/0&&(e.start.row=0,e.end.row=this.rows_-1));let r=e.start,i=e.end;if(t)for(let n=r.row;n<=i.row;n++){this.data[n]||(this.data[n]=[]);let s=this.data[n];for(let a=r.column;a<=i.column;a++)s[a]||(s[a]=new K),yield s[a]}else for(let n=r.row;n<=i.row;n++)if(this.data[n]){let s=this.data[n];for(let a=r.column;a<=i.column;a++)s[a]&&(yield s[a])}}else for(let r of this.data)if(r)for(let i of r)i&&(yield i)}FlushCellStyles(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushStyle()}FlushCachedValues(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushCache()}};var F=class{static locale="en-us";static decimal_separator=".";static argument_separator=",";static grouping_separator=",";static date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]};static UpdateLocale(e){if(e)this.locale=e;else if(typeof self<"u"){let i=self?.document?.location;if(i&&i.search&&/locale=([^?&]+?)(?:\\?|$|&)/.test(i.search)){let n=i.search.match(/locale=(.*?)(?:\\?|$|&)/);n&&(this.locale=n[1]),console.info("override locale",this.locale)}else typeof navigator<"u"&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}this.locale==="C"&&(console.warn("Locale not set, defaulting to en-us"),this.locale="en-us");let t=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\\d/g,"");this.decimal_separator=t===","?",":".",this.decimal_separator===","?(this.argument_separator=";",this.grouping_separator=" "):(this.argument_separator=",",this.grouping_separator=",");let r=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,r),r=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,r),r=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,r),r=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,r),r=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,r),r=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,r),r=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,r),r=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,r),r=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,r),r=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,r),r=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,r),r=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,r)}static UpdateDateComponent(e,t,r){t>=0&&(this.date_components.short_days[t]=r.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[t]=r.toLocaleString(this.locale,{weekday:"long"})),e>=0&&(this.date_components.short_months[e]=r.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[e]=r.toLocaleString(this.locale,{month:"long"}))}};F.UpdateLocale();var me=class o{constructor(e=0,t=0,r=0,i=0){this.left=e;this.top=t;this.width=r;this.height=i}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(e){return new o(e.left||0,e.top||0,e.width||0,e.height||0)}static IsRectangle(e){return!!e&&typeof e=="object"&&typeof e.left=="number"&&typeof e.top=="number"&&typeof e.width=="number"&&typeof e.height=="number"}Shift(e=0,t=0){return new o(this.left+e,this.top+t,this.width,this.height)}Scale(e=1,t=e){return new o(this.left*e,this.top*t,this.width*e,this.height*t)}Expand(e=0,t=0){return new o(this.left,this.top,this.width+e,this.height+t)}Combine(e){return new o(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right)-Math.min(this.left,e.left),Math.max(this.bottom,e.bottom)-Math.min(this.top,e.top))}Contains(e,t,r=0){return e>=this.left-r&&e<=this.left+this.width+r&&t>=this.top-r&&t<=this.top+this.height+r}ContextFill(e){e.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(e){e.strokeRect(this.left,this.top,this.width,this.height)}Clamp(e,t){return e=Math.min(Math.max(e,this.left),this.right),t=Math.min(Math.max(t,this.top),this.bottom),{x:e,y:t}}ApplyStyle(e){e.style.top=this.top+"px",e.style.left=this.left+"px",e.style.width=this.width+"px",e.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}};var Os=JSON.stringify({});var ie=o=>!!o&&typeof o.text=="string",Lr=o=>!!o&&typeof o.theme<"u";var P={DefaultProperties:{horizontal_align:"",vertical_align:"",number_format:"General",nan:"NaN",font_size:{unit:"em",value:1},bold:!1,italic:!1,underline:!1,strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},CompositeBorders:o=>({top:{width:o.border_top||0,color:o.border_top_fill||{}},left:{width:o.border_left||0,color:o.border_left_fill||{}},right:{width:o.border_right||0,color:o.border_right_fill||{}},bottom:{width:o.border_bottom||0,color:o.border_bottom_fill||{}}}),Merge:(o,e,t=!0)=>{let r=t?{...o,...e}:{...e};return JSON.parse(JSON.stringify(r))},Composite:o=>JSON.parse(JSON.stringify(o.reduce((e,t)=>({...e,...t}),{}))),Empty:o=>JSON.stringify(o)===Os,ParseFontSize:(o="",e="em")=>{let t=o.match(/(-*[\\d.]+)\\s*(\\S*)/);if(t){let r=Number(t[1]);if(!r||isNaN(r)||r<0)return{};let i=t[2].toLowerCase()||e;if(i==="pt"||i==="em"||i==="%"||i==="px")return{font_size:{unit:i,value:r}}}return{}},RelativeFontSize:(o,e)=>{let t=12,r=12;switch(o.font_size?.unit){case"pt":if(!o.font_size.value)return 1;r=o.font_size.value;break;case"px":if(!o.font_size.value)return 1;r=Math.round(o.font_size.value*300/4)/100;break;case"em":return o.font_size.value||1;case"%":return(o.font_size.value||100)/100;default:return 1}switch(e.font_size?.unit){case"pt":if(!e.font_size.value)return 1;t=e.font_size.value;break;case"px":if(!e.font_size.value)return 1;t=Math.round(e.font_size.value*300/4)/100;break;default:return 1}return r/t},FontSize:(o,e=!0)=>{let t=o.font_size?.value;switch(o.font_size?.unit){case"pt":return(t||12)+"pt";case"px":return e?Math.round((t||16)*300/4)/100+"pt":(t||16)+"px";case"em":return(t||1)+"em";case"%":return(t||100)+"%"}return""},CompositeFontSize:(o,e,t=1,r=!1)=>{let i={...o};return e.unit==="pt"||e.unit==="px"?i={...e}:(i.value=e.value*o.value,e.unit==="%"&&(i.value/=100)),i.unit==="px"&&r&&(i.value=Math.round((i.value||16)*300/4)/100),i.value*=t,i},CompositeFont:(o,e,t,r)=>{let i,n,s,a=[];e.bold&&a.push("bold"),e.italic&&a.push("italic");let l=e.font_face||"stack:default";if(l.startsWith("stack:")){let u=r.font_stacks[l.substring(6)||"default"];u||(u=r.font_stacks.default),u&&(n=e.font_size,s=P.CompositeFontSize(u.size,e.font_size||{unit:"pt",value:10},t),a.push(s.value.toFixed(2)+s.unit),a.push(u.font||""),i=u.variants)}else s=P.CompositeFontSize(o,e.font_size||{unit:"pt",value:10},t),a.push(s.value.toFixed(2)+s.unit),a.push(l||"");return{font:a.join(" "),variants:i,base:o,size:e.font_size,scale:t,stack_size:n,font_size:s}}};var Nr=o=>!!o&&Array.isArray(o)&&Array.isArray(o[0]),G=(o,e)=>(typeof e>"u"&&(e=re(o)),{value:o,type:e}),X=o=>o.imaginary?{type:7,value:o}:{type:3,value:o.real};var Gs="http://www.w3.org/2000/svg",ne=class o{static instances=[];static GetInstance(e){for(let r of this.instances)if(r.doc===e)return r;let t=new o(e);return this.instances.push(t),t}doc;view;get HTMLElement(){return this.view?.HTMLElement}constructor(e){e&&(this.doc=e,this.view=e?.defaultView)}GetSelection(){return this.view?.getSelection()}Div(e,t,r){return this.Create("div",e,t,r)}ClassNames(e,t){e.classList.add(...(Array.isArray(t)?t:[t]).reduce((r,i)=>[...r,...i.split(/\\s+/g)],[]))}SVG(e,t,r){let i=this.doc.createElementNS(Gs,e);return t&&this.ClassNames(i,t),r&&r.appendChild(i),i}Text(e){return this.doc.createTextNode(e)}Fragment(){return this.doc.createDocumentFragment()}Create(e,t,r,i){let n=this.doc.createElement(e);if(t&&this.ClassNames(n,t),i){if(i.attrs)for(let[s,a]of Object.entries(i.attrs))n.setAttribute(s,a);if(i.data)for(let[s,a]of Object.entries(i.data))n.dataset[s]=a;if(i.text&&(n.textContent=i.text),i.html&&(n.innerHTML=i.html),i.events)for(let[s,a]of Object.entries(i.events))n.addEventListener(s,a);if(i.style)for(let[s,a]of Object.entries(i.style))n.style[s]=a}return r&&r.appendChild(n),n}};var Bs=1e3,Ge=class{constructor(e=!1,t){this.verbose=e;this.log_id=t}queue=[];dispatched=!1;subscribers=[];Publish(e){this.verbose&&console.info(`es publish (${this.log_id})`,e),Array.isArray(e)?this.queue.push(...e):this.queue.push(e),this.dispatched||(this.dispatched=!0,Promise.resolve().then(()=>{let t=this.queue.slice(0);this.dispatched=!1,this.queue=[];for(let r of t)for(let i of this.subscribers)i.subscriber(r)}))}Subscribe(e){let t=Bs++;return this.subscribers.push({subscriber:e,token:t}),t}Cancel(e){this.subscribers=this.subscribers.filter(t=>t.token!==e)}CancelAll(){this.subscribers=[]}};var ye=class{static color_measurement_canvas;static text_measurement_node;static color_cache={};static MeasureColorARGB(e){let t=this.MeasureColor(e),r="FF";for(let i=0;i<3;i++){let n=t[i].toString(16);n.length===0?r+="00":n.length===1?r+=`0${n}`:r+=n}return r.toUpperCase()}static MeasureColor(e){let t=this.color_cache[e];if(t)return t;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);let r=this.color_measurement_canvas.getContext("2d",{willReadFrequently:!0});return r?(r.fillStyle="#fff",r.fillRect(0,0,1,1),r.fillStyle=e,r.fillRect(0,0,1,1),t=new Uint8ClampedArray(r.getImageData(0,0,1,1).data),this.color_cache[e]=t,t):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){let e=document.querySelector(".treb-chart-measurement-node");e?this.text_measurement_node=e:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.height="initial",this.text_measurement_node.style.width="initial",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(e,t=!1,r=400){let i=`${t?"italic":""} ${r} 20pt ${e}`,n=this.MeasureText(`${i}, sans-serif`,"check font"),s=this.MeasureText(`${i}, serif`,"check font"),a=this.MeasureText(`${i}, monospace`,"check font");return n.width===s.width&&s.width===a.width}static MeasureText(e,t,r=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=e,/\\n/.test(t)?(t=t.replace(/\\n/g,"<BR/>"),this.text_measurement_node.innerHTML=t):this.text_measurement_node.textContent=t,this.text_measurement_node.style.lineHeight="1em",r?this.text_measurement_node.style.transform=`rotate(${r}deg)`:this.text_measurement_node.style.transform="";let i=this.text_measurement_node.getBoundingClientRect();return{width:i.width,height:i.height}}};var Hs={data:!0,same_origin:!0,remote:!1},Ui=(o,e={})=>{let t={...Hs,...e};try{let r=new URL(o,document.location.href);return r.protocol==="data:"?t.data?r.href:void 0:r.origin===document.location.origin?t.same_origin?r.href:void 0:t.remote?r.hash:void 0}catch(r){console.error(r)}};var Ft=(o,e,t=6.5,r=!1,i=!1)=>{if(e===o)e++,o&&o--;else{let h=Math.round(e*1e5)/1e5;Math.abs(h-e)/(e-o)<1e-5&&(e=h)}let n=e-o,s=Math.log(n)/Math.log(10),a=Math.floor(Math.abs(s))*(s<0?-1:1)-1;i&&(a=Math.max(0,a));let l=i?[1,2,5,10,15,20,25,50,100]:[.1,.25,.5,1,2.5,5,10,25,50,100],u=-1,c=0;for(let h of l){let f=h*Math.pow(10,a),d=Math.floor(o/f)*f,_=(Math.ceil(e/f)*f-d)/f,y=Math.abs(_-t);(u<0||y<c)&&(!r||_<=t)&&(c=y,u=f)}return o=Math.floor(o/u)*u,e=Math.ceil(e/u)*u,t=Math.round((e-o)/u),{scale:a,step:u,count:t,min:o,max:e}};var Vi={spreadsheet_semantics:!0,dimensioned_quantities:!1,fractions:!0,decimal_mark:".",argument_separator:",",boolean_true:"TRUE",boolean_false:"FALSE"};var Te=/[\\s-+=<>!()]/;var Pr=34,zr=39,qs=160,Di=32,js=9,$s=10,Js=13,ge=48,ft=57,Or=46,Gr=43,mt=45,Ii=40,Br=41,pt=44,Ws=37,Hr=95,Lt=36,Qs=123,Zs=125,_t=91,Fi=93,Ks=63,Xs=33,Li=59,qr=35,Ys=64,it=65,bt=97,eo=69,to=101,Nt=90,Pt=122,ro=105,jr=192,$r=382,Jr={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},io={"@":50,"-":100,"+":100},no=[...Object.keys(Jr),"@"].sort((o,e)=>e.length-o.length),zt=class{get argument_separator(){return this.flags.argument_separator}get decimal_mark(){return this.flags.decimal_mark}flags={...Vi};r1c1_regex=/[rR]((?:\\[[-+]{0,1}\\d+\\]|\\d*))[cC]((?:\\[[-+]{0,1}\\d+\\]|\\d*))$/;argument_separator_char=pt;decimal_mark_char=Or;imaginary_char=ro;imaginary_number="i";id_counter=0;expression="";data=[];index=0;length=0;valid=!0;error_position;error;dependencies={addresses:{},ranges:{}};address_refcount={};full_reference_list=[];parser_state_cache=[];SetLocaleSettings(e,t){if(typeof t>"u"&&(t=e===","?";":","),t===e)throw new Error("invalid locale setting");this.flags.argument_separator=t,this.flags.decimal_mark=e}Save(){this.parser_state_cache.push(JSON.stringify(this.flags))}Restore(){let e=this.parser_state_cache.shift();if(e)try{this.flags=JSON.parse(e)}catch(t){console.error(t)}else console.warn("No parser state to restore")}Walk2(e,t){let r=t(e);if(typeof r=="object")return r;switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":break;case"dimensioned":r&&(e.expression=this.Walk2(e.expression,t),e.unit=this.Walk2(e.unit,t));break;case"range":t(e)&&(e.start=this.Walk2(e.start,t),e.end=this.Walk2(e.end,t));break;case"binary":t(e)&&(e.left=this.Walk2(e.left,t),e.right=this.Walk2(e.right,t));break;case"unary":t(e)&&(e.operand=this.Walk2(e.operand,t));break;case"group":t(e)&&(e.elements=e.elements.map(i=>this.Walk2(i,t)));break;case"implicit-call":t(e)&&(e.call=this.Walk2(e.call,t),e.args=e.args.map(i=>this.Walk2(i,t)));break;case"call":t(e)&&(e.args=e.args.map(i=>this.Walk2(i,t)));break}return e}Walk(e,t){switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":t(e);return;case"dimensioned":t(e)&&(this.Walk(e.expression,t),this.Walk(e.unit,t));return;case"range":t(e)&&(this.Walk(e.start,t),this.Walk(e.end,t));return;case"binary":t(e)&&(this.Walk(e.left,t),this.Walk(e.right,t));return;case"unary":t(e)&&this.Walk(e.operand,t);return;case"group":if(t(e))for(let r of e.elements)this.Walk(r,t);return;case"implicit-call":if(t(e)){this.Walk(e.call,t);for(let r of e.args)this.Walk(r,t)}return;case"call":if(t(e))for(let r of e.args)this.Walk(r,t)}}Transpose(e){let t=e.length,r=[],i=0;for(let n=0;n<t;n++)Array.isArray(e[n])&&(i=Math.max(i,e[n].length));for(let n=0;n<i;n++){r[n]=[];for(let s=0;s<t;s++)r[n][s]=e[s]?e[s][n]:void 0}return r}Render(e,t={}){let r=t.offset||{rows:0,columns:0},i=t.missing??"(missing)",{convert_decimal:n,convert_argument_separator:s,long_structured_references:a,table_name:l}=t,u=this.flags.argument_separator+" ";s===","?u=", ":s===";"&&(u="; ");let c=n===","?",":".",h=this.flags.decimal_mark===","?/,/:/\\./,f=this.flags.decimal_mark===","?/,/g:/\\./g;switch(e.type){case"address":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e,t.r1c1_base):this.AddressLabel(e,r);case"range":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e.start,t.r1c1_base)+":"+this.R1C1Label(e.end,t.r1c1_base):this.AddressLabel(e.start,r)+":"+this.AddressLabel(e.end,r);case"missing":return i;case"array":return"{"+this.Transpose(e.values).map(d=>d.map(m=>typeof m=="string"?\'"\'+m+\'"\':m).join(", ")).join("; ")+"}";case"binary":return this.Render(e.left,t)+" "+e.operator+" "+this.Render(e.right,t);case"unary":return e.operator+this.Render(e.operand,t);case"complex":if(e.text)return n?e.text.replace(f,c):e.text;{let d=Math.abs(e.imaginary).toString();if((n===","||this.flags.decimal_mark===",")&&(d=d.replace(/\\./,",")),e.real){let m=e.real.toString();(n===","||this.flags.decimal_mark===",")&&(m=m.replace(/\\./,","));let _=Math.abs(e.imaginary);return`${m}${e.imaginary<0?" - ":" + "}${_===1?"":d}i`}else return e.imaginary===-1?"-i":e.imaginary===1?"i":`${e.imaginary<0?"-":""}${d}i`}break;case"literal":if(typeof e.value=="string")return\'"\'+e.value.replace(/"/g,\'""\')+\'"\';if(typeof e.value=="boolean")return e.value?t.boolean_true||this.flags.boolean_true||"true":t.boolean_false||this.flags.boolean_false||"false";if(n&&typeof e.value=="number")if(e.text){let d=e.text;return n===","&&this.flags.decimal_mark==="."&&(d=d.replace(/,/g,"")),d.replace(h,c)}else return e.value.toString().replace(/\\./,c);else if(e.text)return e.text;return e.value.toString();case"identifier":return e.name;case"operator":return"["+e.operator+"]";case"group":return e.explicit?"("+e.elements.map(d=>this.Render(d,t)).join(u)+")":e.elements.map(d=>this.Render(d,t)).join(u);case"implicit-call":return this.Render(e.call,t)+"("+e.args.map(d=>this.Render(d,t)).join(u)+")";case"call":return e.name+"("+e.args.map(d=>this.Render(d,t)).join(u)+")";case"dimensioned":return this.Render(e.expression)+" "+this.Render(e.unit);case"structured-reference":{let d=e.column;/[^A-Za-z]/.test(d)&&(d="["+d+"]");let m=e.table;switch(!m&&a&&l&&(m=l),e.scope){case"all":return`${m}[[#all],${d}]`;case"row":return a?`${m}[[#this row],${d}]`:`${m}[@${d}]`;case"column":return`${m}[${d}]`}throw new Error("unhandled scope in structured reference")}}return"??"}Parse(e){switch(e=e.trim(),e[0]==="="&&(e=e.substr(1).trim()),this.expression=e,this.data=[],this.length=e.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.flags.argument_separator){case";":this.argument_separator_char=Li;break;default:this.argument_separator_char=pt;break}switch(this.flags.decimal_mark){case",":this.decimal_mark_char=pt;break;default:this.decimal_mark_char=Or;break}for(let i=0;i<this.length;i++)this.data[i]=e.charCodeAt(i);let t=this.ParseGeneric(),r={};for(let i of Object.keys(this.dependencies.addresses))this.address_refcount[i]&&(r[i]=this.dependencies.addresses[i]);return this.dependencies.addresses=r,{expression:t||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.flags.argument_separator,decimal_mark:this.flags.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(e){if(e===1/0)return"";let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}R1C1Label(e,t){let r="";e.sheet&&(r=(Te.test(e.sheet)?"\'"+e.sheet+"\'":e.sheet)+"!");let i=e.offset_row?`[${e.row}]`:e.row+1,n=e.offset_column?`[${e.column}]`:e.column+1;return r+=`R${i}C${n}`,r}AddressLabel(e,t){let r=e.column;!e.absolute_column&&e.column!==1/0&&(r+=t.columns);let i=e.row;if(!e.absolute_row&&e.row!==1/0&&(i+=t.rows),i<0||r<0||i===1/0&&r===1/0)return"#REF";let n="";return e.sheet&&(n=(Te.test(e.sheet)?"\'"+e.sheet+"\'":e.sheet)+"!"),i===1/0?n+(e.absolute_column?"$":"")+this.ColumnLabel(r):r===1/0?n+(e.absolute_row?"$":"")+(i+1):n+(e.absolute_column?"$":"")+this.ColumnLabel(r)+(e.absolute_row?"$":"")+(i+1)+(e.spill?"#":"")}ParseGeneric(e=[0],t=!1){let r=[];for(;this.index<this.length;){let i=this.ParseNext(r.length===0);if(typeof i=="number"){if(e.some(n=>i===n))break;if(i===Ii){this.index++;let n=this.ParseGeneric([Br],!0);this.index++,n&&r.push({type:"group",id:this.id_counter++,elements:[n],explicit:!0})}else{let n=this.ConsumeOperator();n?r.push(n):t&&i===this.argument_separator_char?(r.push({type:"group-separator",position:this.index,id:this.id_counter++}),this.index++):(this.error=`unexpected character [1]: ${String.fromCharCode(i)}, 0x${i.toString(16)}`,this.valid=!1,this.index++)}}else r.push(i)}if(r.length){if(r=this.BinaryToRange2(r),this.flags.fractions){let i=[],n=a=>a.type==="literal"&&typeof a.value=="number"&&a.value%1===0,s=0;for(;s<r.length-3;s++)if(n(r[s])&&n(r[s+1])&&r[s+2].type==="operator"&&r[s+2].operator==="/"&&n(r[s+3])){let a=r[s],l=r[s+1],u=r[s+3],c=(a.value<0?-1:1)*(l.value/u.value);s+=3,i.push({id:r[s].id,type:"literal",text:this.expression.substring(a.position,u.position+1),value:a.value+c,position:a.position})}else i.push(r[s]);for(;s<r.length;s++)i.push(r[s]);r=i}if(r=r.map(i=>i.type==="identifier"&&i.name===this.imaginary_number?{type:"complex",real:0,imaginary:1,position:i.position,text:i.name,id:this.id_counter++}:i),this.flags.dimensioned_quantities){let i=[],n;for(let s=0;s<r.length;s++){let a=r[s];if(!n)n=a;else if(a.type==="identifier"&&(n.type==="literal"||n.type==="group"||n.type==="call")){let l=a;for(;r[s+1]?.type==="identifier";)l.name+=" "+r[++s].name;i.push({type:"dimensioned",expression:n,unit:a,id:this.id_counter++}),n=void 0}else i.push(n),n=a}n&&i.push(n),r=i}}return r.length===0?null:r.length===1?r[0]:this.BinaryToComplex(this.ArrangeUnits(r))}UnitToAddress(e){if(e.type==="literal"){if(typeof e.value=="number"&&e.value>0&&!/\\./.test(e.text||""))return{type:"address",position:e.position,label:e.value.toString(),row:e.value-1,id:this.id_counter++,column:1/0}}else{let t,r=e.name,i=r.split("!");if(i.length>1&&(t=i.slice(0,i.length-1).join("!"),r=r.substr(t.length+1),t[0]==="\'"))if(t.length>1&&t[t.length-1]==="\'")t=t.substr(1,t.length-2);else return;let n=r[0]==="$";r=(n?r.substr(1):r).toUpperCase();let s=Number(r);if(isNaN(s)){if(/[A-Z]{1,3}/.test(r)){let a=-1;for(let l=0;l<r.length;l++){let u=r[l].charCodeAt(0);a=26*(1+a)+(u-it)}return{type:"address",position:e.position,absolute_column:n,label:e.name,column:a,id:this.id_counter++,row:1/0,sheet:t}}}else if(s>0&&s!==1/0&&!/\\./.test(r))return{type:"address",position:e.position,absolute_row:n,label:e.name,row:s-1,id:this.id_counter++,column:1/0,sheet:t}}}BinaryToRange2(e){let t=[];for(let r=0;r<e.length;r++){let i=e[r],n=e[r+1],s=e[r+2],a,l="",u;if(i&&n&&s&&n.type==="operator"&&n.operator===":"){if(i.type==="address"&&s.type==="address"){let c=i.position+i.label.length,h=s.position;a={type:"range",id:this.id_counter++,position:i.position,start:i,end:s,label:i.label+this.expression.substring(c,h)+s.label},l=a.start.label+":"+a.end.label,this.address_refcount[a.start.label]--,this.address_refcount[a.end.label]--;let f=[i.position,s.position];this.full_reference_list=this.full_reference_list.filter(d=>d.position!==f[0]&&d.position!==f[1])}else if((i.type==="literal"||i.type==="identifier")&&(s.type==="literal"||s.type==="identifier")){let c=this.UnitToAddress(i);if(!c&&i.type==="literal"&&typeof i.value=="number"&&i.value<0){let f={...i,text:(i.text||"").replace(/^-/,""),position:i.position+1,value:-i.value};c=this.UnitToAddress(f),c&&(u={type:"operator",operator:"-",position:i.position,id:this.id_counter++})}let h=this.UnitToAddress(s);c&&h&&(c.column===1/0&&h.column===1/0||c.row===1/0&&h.row===1/0)&&(l=c.label+":"+h.label,a={type:"range",id:this.id_counter++,position:c.position,start:c,end:h,label:l})}}a?(u&&t.push(u),t.push(a),this.dependencies.ranges[l]=a,this.full_reference_list.push(a),r+=2):t.push(i)}return t}BinaryToComplex(e){if(e.type==="binary")if((e.operator==="+"||e.operator==="-")&&e.left.type==="literal"&&typeof e.left.value=="number"&&e.right.type==="complex"&&!e.right.composited){let t="";t=this.expression.substring(e.left.position,e.right.position+(e.right.text?.length||0));let r=e.right.imaginary;return e.operator==="-"&&(r=-r),{type:"complex",position:e.left.position,text:t,id:this.id_counter++,imaginary:r,real:e.left.value,composited:!0}}else e.left=this.BinaryToComplex(e.left),e.right=this.BinaryToComplex(e.right);else if(e.type==="unary"&&(e.operator==="-"||e.operator==="+")&&e.operand.type==="complex"&&e.operand.text===this.imaginary_number)return{...e.operand,position:e.position,text:this.expression.substring(e.position,e.operand.position+(e.operand.text||"").length),imaginary:e.operand.imaginary*(e.operator==="-"?-1:1)};return e}ArrangeUnits(e){if(e.length===0)return{type:"missing",id:this.id_counter++};if(e.length===1)return e[0];let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(i.type!=="group-separator"){if(i.type==="operator")if(t.length===0||t[t.length-1].type==="operator")if(io[i.operator]){let n=this.BinaryToComplex(this.ArrangeUnits(e.slice(r+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:e,explicit:!1};n.type==="binary"?(n.left={type:"unary",id:this.id_counter++,operator:i.operator,operand:n.left,position:i.position},i=n):i={type:"unary",id:this.id_counter++,operator:i.operator,operand:n,position:i.position},r=e.length}else return this.error=`unexpected character [2]: ${i.operator}`,this.error_position=i.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};else{t.push(i);continue}if(t.length<2){if(t.length===1){let n=t[0].type;if(i.type==="group"&&i.explicit&&(n==="address"||n==="call"||n==="identifier"||n==="implicit-call")){let s=i.elements;s.length===1&&s[0].type==="group"&&!s[0].explicit&&(s=s[0].elements),t[0]={type:"implicit-call",call:t[0],args:s,id:this.id_counter++,position:t[0].position};continue}}t.push(i)}else if(t[t.length-1].type==="operator"){let n=t[t.length-2],s=t[t.length-1],a=s.operator,l={type:"binary",id:this.id_counter++,left:n,operator:a,position:s.position,right:i};n.type==="binary"&&Jr[a]>Jr[n.operator]&&(l.left=n.left,l.operator=n.operator,l.position=n.position,l.right={type:"binary",id:this.id_counter++,left:n.right,right:i,operator:a,position:s.position}),t.splice(-2,2,l)}else t.push(i)}}return t.length>1?{type:"group",id:this.id_counter++,elements:t,explicit:!1}:t[0]}ParseNext(e=!0){this.ConsumeWhiteSpace();let t=this.data[this.index];if(t===Pr)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(t>=ge&&t<=ft||t===this.decimal_mark_char)return this.ConsumeNumber();if(t===Qs)return this.ConsumeArray();if(e&&(t===mt||t===Gr)){let r=this.data[this.index+1];if(r>=ge&&r<=ft||r===this.decimal_mark_char)return this.ConsumeNumber()}else if(t>=it&&t<=Nt||t>=bt&&t<=Pt||t===Hr||t===qr||t===zr||t===Lt||t===_t||t>=jr&&t<=$r)return this.ConsumeToken(t);return t}ConsumeArray(){let e={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let t=0,r=0;for(;this.index<this.length;){let i=this.ParseNext(),n=this.index;if(typeof i=="number")switch(this.index++,i){case Li:r++,t=0;break;case pt:t++;break;case Zs:return e;default:this.valid&&(this.error="invalid character in array literal",this.error_position=n,this.valid=!1);break}else switch(i.type){case"literal":e.values[t]||(e.values[t]=[]),e.values[t][r]=i.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=n,this.valid=!1);break}}return e}ConsumeOperator(){for(let e of no)if(this.expression.substr(this.index,e.length)===e){let t=this.index;return this.index+=e.length,{type:"operator",id:this.id_counter++,operator:e,position:t}}return null}ConsumeArguments(){this.index++;let e=0,t=[];for(;this.index<this.length;){let r=this.ParseGeneric([this.argument_separator_char,Br]);r!==null&&t.push(r);let i=this.data[this.index];if(i===this.argument_separator_char){this.index++,e++;for(let n=t.length;n<e;n++)t.push({type:"missing",id:this.id_counter++})}else if(i===Br)return this.index++,t}return t}ConsumeToken(e){let t=[e],r=this.index,i=e===zr,n=0,s=!1;for(e===_t&&(n=1,s=!0),++this.index;this.index<this.length;this.index++){let h=this.data[this.index];if(h>=it&&h<=Nt||h>=bt&&h<=Pt||h>=jr&&h<=$r||h===Hr||h===Lt||h===Or||h===Xs||i||h>=ge&&h<=ft||h===_t||n>0&&h===Fi||h===mt&&this.flags.r1c1&&n===1||n>0&&h===Ys&&this.data[this.index-1]===_t||n===1&&(h===pt||h===Di)||n>1||h===Ks&&n===0)t.push(h),h===_t&&(n++,s=!0),h===Fi&&n--,h===zr&&(i=!1);else break}this.data[this.index]===qr&&t.push(this.data[this.index++]);let a=t.map(h=>String.fromCharCode(h)).join("");if(i)return this.error="unbalanced single quote",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:a,position:r};if(n)return this.error="unbalanced square bracket",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:a,position:r};if(this.ConsumeWhiteSpace(),this.flags.spreadsheet_semantics){let h=this.ConsumeAddress(a,r);if(h)return h}if(this.data[this.index]===Ii){let h=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:a,args:h,position:r,end:this.index}}if(this.flags.spreadsheet_semantics&&s){let h=this.ConsumeStructuredReference(a,r);if(h)return h}let u=a.toLowerCase();if(u==="true"||this.flags.boolean_true&&u===this.flags.boolean_true.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:r};if(u==="false"||this.flags.boolean_false&&u===this.flags.boolean_false.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:r};let c={type:"identifier",id:this.id_counter++,name:a,position:r};return this.full_reference_list.push(c),c}ConsumeStructuredReference(e,t){let r=e.length,i=e,n="",s=0;for(;s<r;s++){if(e[s]==="["){e=e.substring(s);break}n+=e[s]}if(e[0]!=="["||e[e.length-1]!=="]")return;e=e.substring(1,e.length-1);let a=e.split(",").map(h=>h.trim()),l="column",u="";if(a.length>2)return;a.length===2?(/\\[#this row\\]/i.test(a[0])?l="row":/\\[#all\\]/i.test(a[0])&&(l="all"),u=a[1]):(u=a[0],u[0]==="@"&&(l="row",u=u.substring(1,u.length))),u[0]==="["&&u[u.length-1]==="]"&&(u=u.substring(1,u.length-1));let c={type:"structured-reference",id:this.id_counter++,label:i,position:t,scope:l,column:u,table:n};return this.full_reference_list.push(c),c}ConsumeAddress(e,t){let r=t,i=e.length,n,s=e.split("!");if(s.length>1&&(n=s.slice(0,s.length-1).join("!"),t+=n.length+1),this.flags.r1c1){let h=s[s.length-1].match(this.r1c1_regex);if(h){let f={type:"address",id:this.id_counter++,label:e,row:0,column:0,position:r,sheet:n,r1c1:!0};return h[1][0]==="["?(f.offset_row=!0,f.row=Number(h[1].substring(1,h[1].length-1))):h[1]?f.row=Number(h[1])-1:(f.offset_row=!0,f.row=0),h[2][0]==="["?(f.offset_column=!0,f.column=Number(h[2].substring(1,h[2].length-1))):h[2]?f.column=Number(h[2])-1:(f.offset_column=!0,f.column=0),f}}let a=this.ConsumeAddressColumn(t);if(!a)return null;t=a.position;let l=this.ConsumeAddressRow(t);if(!l||(t=l.position,a.column===8508&&l.row===9))return null;let u=n?n+e.substr(n.length,t-r).toUpperCase():e.substr(0,t-r).toUpperCase();n&&n[0]==="\'"&&(n=n.substr(1,n.length-2));let c={type:"address",id:this.id_counter++,label:u,row:l.row,column:a.column,absolute_row:l.absolute,absolute_column:a.absolute,position:r,sheet:n,spill:l.spill};return i!==t-r?null:(this.dependencies.addresses[c.label]=c,this.address_refcount[c.label]=(this.address_refcount[c.label]||0)+1,this.full_reference_list.push(c),c)}ConsumeAddressRow(e){let t=this.data[e]===Lt;t&&e++;let r=e,i=0;for(;;e++){let s=this.data[e];if(s>=ge&&s<=ft)i*=10,i+=s-ge;else break}if(r===e||i===0)return!1;let n=!1;return this.data[e]===qr&&(e++,n=!0),{absolute:t,row:i-1,position:e,spill:n}}ConsumeAddressColumn(e){let t=-1,r=0,i=this.data[e]===Lt;for(i&&e++;;e++,r++){if(r>=4)return!1;let n=this.data[e];if(n>=it&&n<=Nt)t=26*(1+t)+(n-it);else if(n>=bt&&n<=Pt)t=26*(1+t)+(n-bt);else break}return t<0?!1:{absolute:i,column:t,position:e}}ConsumeNumber(){let e=this.index,t=0,r=!1,i=!1,n=0,s=0,a=0,l="integer",u=0,c=!1,h=this.index;for(;this.index<this.length;this.index++,u++){let d=this.data[this.index];if(d===this.decimal_mark_char)if(l==="integer")l="fraction";else break;else if(d===Ws){n/=100,a/=100,this.index++;break}else if(d===Gr||d===mt)if(u===0)d===mt&&(i=!0);else break;else if(d===eo||d===to)if(l==="integer"||l==="fraction")l="exponent",this.index<this.length-1&&(this.data[this.index+1]===Gr?this.index++:this.data[this.index+1]===mt&&(this.index++,r=!0));else break;else if(d===this.imaginary_char){let m=this.data[this.index+1];if(m>=it&&m<=Nt||m>=bt&&m<=Pt||m>=jr&&m<=$r||m===Hr)break;if(l==="integer"||l==="fraction"){this.index++,c=!0;break}}else if(d>=ge&&d<=ft)switch(l){case"integer":n=n*10+(d-ge);break;case"fraction":a=a*10+(d-ge),s++;break;case"exponent":t=t*10+(d-ge);break}else break}let f=n+a/Math.pow(10,s);return l==="exponent"&&(f=f*Math.pow(10,(r?-1:1)*t)),c?{type:"complex",id:this.id_counter++,position:e,imaginary:i?-f:f,real:0,text:this.expression.substring(h,this.index)||""}:{type:"literal",id:this.id_counter++,position:e,value:i?-f:f,text:this.expression.substring(h,this.index)||""}}ConsumeString(){this.index++;let e=[];for(;this.index<this.length;this.index++){let t=this.data[this.index];if(t===Pr&&(this.index++,this.index>=this.length||this.data[this.index]!==Pr))break;e.push(t)}return e.map(t=>String.fromCharCode(t)).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){let e=this.data[this.index];if(e===Di||e===js||e===$s||e===Js||e===qs)this.index++;else return}}};var Gt=class o{static _instance=new o;constructor(){}static get instance(){return this._instance}HTML(e,t={}){t={br:!0,...t};let r=[];for(let i of e){let n=[];for(let s of i)s.pre&&n.push("<pre>"),s.emphasis&&n.push("<em>"),s.strong&&n.push("<strong>"),s.strike&&n.push("<strike>"),n.push(s.text),s.strike&&n.push("</strike>"),s.strong&&n.push("</strong>"),s.emphasis&&n.push("</em>"),s.pre&&n.push("</pre>");r.push(n.join(""))}return r.join(t.br?`<br/>\n`:`\n`)}Dummy(e=""){return e.split(/\\n/).map(t=>[{text:t}])}Parse(e=""){let t=this.Tokenize(e);for(let r=0;r<t.length;r++){let i=t[r];if(i.type==="delimeter"){let n=t[r-1],s=t[r+1],a=!n||n.type==="whitespace"||n.type==="newline",l=n&&n.type==="text"&&/[^\\w\\d]$/.test(n.text),u=!s||s.type==="whitespace"||s.type==="newline",c=s&&s.type==="text"&&/^[^\\w\\d]/.test(s.text);i.left_flanking=!u&&(!c||a),i.right_flanking=!a&&(!l||u||c)}}return this.ApplyFormatting(t),this.Consolidate(t)}IsWhitespace(e){return e===" "||e==="	"}IsNewline(e){return e==="\\r"||e===`\n`}IsDelimeter(e){return e==="*"||e==="_"||e==="~"}Consolidate(e){let t=[],r={},i=[],n={type:"text",text:""};for(let s of e)if(s.type==="newline")n.text.length&&i.push(n),n={...r,text:"",type:"text"},t.push(i),i=[];else switch((!!r.strong!=!!s.strong||!!r.emphasis!=!!s.emphasis||!!r.strike!=!!s.strike)&&(r.strong=!!s.strong,r.emphasis=!!s.emphasis,r.strike=!!s.strike,n.text.length&&i.push(n),n={...r,text:"",type:"text"}),s.type){case"text":case"whitespace":n.text+=s.text;break;case"delimeter":for(let a=0;a<s.length;a++)n.text+=s.char;break}return n.text.length&&i.push(n),i.length&&t.push(i),t}ApplyFormatting(e,t){let r=0,i=e.length;for(r=0;r<i;r++){let n=e[r];if(n.type==="delimeter"){if(t&&n.right_flanking&&t.char===n.char&&n.length>0)return{index:r,token:n};if(n.left_flanking){let s=this.ApplyFormatting(e.slice(r+1),n);if(s.token){let a=Math.min(s.token.length,n.length),l=n.char==="~",u=!l&&!!(a%2),c=!l&&a>=2;for(let h=r+1;h<=r+s.index;h++)e[h].strong=!!e[h].strong||c,e[h].emphasis=!!e[h].emphasis||u,e[h].strike=!!e[h].strike||l;s.token.length-=a,n.length-=a,n.length>0?r--:r+=s.index}}}}return{index:r}}Tokenize(e=""){let t=[],r=e.length,i=0,n=!1,s="";for(i=0;i<r;i++){let a=e[i];if(this.IsWhitespace(a)){s&&t.push({type:"text",text:s});let l=a;for(;;){let u=e[i+1];if(this.IsWhitespace(u))l+=u,i++;else break}t.push({type:"whitespace",text:l}),n=!1,s=""}else if(this.IsNewline(a)){s&&t.push({type:"text",text:s}),t.push({type:"newline",text:a});let l="";for(;;){let u=e[i+1];if(this.IsNewline(u))l+=u,i++;else break}l.length&&t.push({type:"newline",text:l}),n=!1,s=""}else if(n)s+=a,n=!1;else if(this.IsDelimeter(a)){s&&t.push({type:"text",text:s});let l=a;for(;;){let u=e[i+1];if(u===a)l+=u,i++;else break}t.push({type:"delimeter",text:l,char:a,length:l.length}),n=!1,s=""}else a==="\\\\"?n=!0:s+=a}return s&&t.push({type:"text",text:s}),t}};var ve=class{date_format=!1;string_format=!1;fraction_format=!1;twelve_hour=!1;fraction_denominator=0;fraction_integer=!0;fraction_align=0;fraction_denominator_digits=0;integer_min_digits=0;decimal_min_digits=0;decimal_max_digits=0;grouping=!1;has_number_format=!1;prefix=[{text:""}];suffix=[{text:""}];scaling=0;percent=!1;exponential=!1;has_asterisk=!1};var Pi=42,zi=95,Wr=63,Bt=48,Oi=46,Qr=44,Gi=37,Zr=34,yt=35,Bi=59,Ht=92,Hi=64,so=91,oo=93,qi=69,ji=101,ao=72,lo=104,uo=77,co=109,ho=83,fo=115,mo=68,po=100,_o=89,bo=121,yo=65,go=97;var qt=class{static date_pattern=!1;static pattern="";static char_index=0;static characters=[];static sections=[];static current_section=new ve;static preserve_formatting_characters=!1;static decimal_mark=Oi;static group_separator=Qr;static Parse(e){if(this.pattern=e,this.characters=e.split("").map(t=>t.charCodeAt(0)),this.char_index=0,this.current_section=new ve,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new ve,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let e="";for(this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Ht:this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(e+=this.pattern[++this.char_index]);break;case Zr:return this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated string")}static ConsumeFormatting(){let e="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Ht:throw new Error("invalid escape character in formatting block");case oo:return this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated format")}static ScanFractionFormat(){let e=/^([#?]+ +){0,1}([#?]+)\\/([#?0-9]+)(?:$|[^#?0-9])/,r=this.pattern.substr(this.char_index).match(e);if(!r)return!1;let i=(r[1]||"").length+r[2].length+r[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!r[1];let n=Number(r[3]);return isNaN(n)||(this.current_section.fraction_denominator=n),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=r[3].length,this.char_index+=i,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let e=0;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let r=!1;for(let i=this.char_index+1;!r&&i<this.characters.length;i++){let n=this.characters[i];if(n===this.decimal_mark||n===yt||n===Bt)r=!0;else if(n!==Qr)break}if(r){if(e===1)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=(this.current_section.scaling||1)*1e3}break;case this.decimal_mark:if(e===1)throw new Error("too many decimal marks");e=1;break;case yt:e===1?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case Bt:e===1?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(e=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],e&&this.char_index++}static AppendString(e){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=e:this.current_section.prefix[this.current_section.prefix.length-1].text+=e}static AppendTextPart(e){this.current_section.has_number_format?(this.current_section.suffix.push(e),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(e),this.current_section.prefix.push({text:""}))}static ConsumeChar(){let e=this.characters[this.char_index];if(!((e===Wr||e===yt)&&!this.current_section.has_number_format&&!this.current_section.string_format&&this.ScanFractionFormat()))switch(e){case Bi:this.char_index++,this.current_section=new ve,this.sections.length===3&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case Hi:this.char_index++,this.AppendTextPart({text:"@",flag:5}),this.current_section.string_format=!0;break;case Bt:case yt:case Oi:case Qr:!this.current_section.has_number_format&&!this.current_section.string_format?(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0):this.AppendCharAsText();break;case so:this.AppendTextPart({text:this.ConsumeFormatting(),flag:6});break;case Zr:this.AppendString(this.ConsumeString());break;case Wr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case zi:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case Pi:if(this.current_section.has_asterisk)throw new Error("we don\'t support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case ji:case qi:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case Gi:!this.current_section.exponential&&!this.current_section.string_format&&(this.current_section.percent=!0),this.AppendCharAsText();break;case Ht:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(let e of this.sections)for(let t of e.prefix)t.flag&&t.flag&7&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach((e,t)=>{if(e.flag===3&&(e.text==="mm"||e.text==="m")){if(t)for(let r=t-1;r;r--){let i=this.sections[0].prefix[r];if(i.flag===3){/h/i.test(i.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}if(t<this.sections[0].prefix.length-1)for(let r=t+1;r<this.sections[0].prefix.length;r++){let i=this.sections[0].prefix[r];if(i.flag===3){/s/i.test(i.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}}})),this.date_pattern}static ConsumeDatePart(){let e=this.pattern[this.char_index++],t=e.toLowerCase(),r={text:e,flag:3};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===t;)r.text+=this.pattern[this.char_index++];if(t==="s"&&this.pattern[this.char_index]===".")for(r.text+=this.pattern[this.char_index++];this.pattern[this.char_index]==="0";)r.text+=this.pattern[this.char_index++];return r}static ConsumeAMPM(){let e=this.pattern.substr(this.char_index,5);if(e==="am/pm"||e==="AM/PM")return this.char_index+=5,this.sections[0].twelve_hour=!0,{text:e,flag:3};if(e=this.pattern.substr(this.char_index,3),e==="a/p"||e==="A/P")return this.char_index+=3,this.sections[0].twelve_hour=!0,{text:e,flag:3}}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case Bi:this.char_index=this.characters.length;break;case Bt:case yt:case ji:case qi:case Gi:case Hi:this.date_pattern=!1;break;case ao:case lo:case uo:case co:case ho:case fo:case mo:case po:case _o:case bo:this.AppendTextPart(this.ConsumeDatePart());break;case yo:case go:{let t=this.ConsumeAMPM();t?this.AppendTextPart(t):this.AppendCharAsText()}break;case Zr:this.AppendString(this.ConsumeString());break;case Wr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case zi:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case Pi:if(this.current_section.has_asterisk)throw new Error("we don\'t support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case Ht:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}};var Be=o=>(o>=60&&o--,new Date(-22090752e5+864e5*o)),we=(o,e=!0)=>{if(e){let t=new Date(o);o=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()).getTime()}return o=(o+22090752e5)/864e5,o>=60&&o++,o},Ue=class o{static grouping_regexp=/\\d{1,3}(?=(\\d{3})+(?!\\d))/g;static fraction_limits=[9,99,999,9999];static imaginary_character="\\u{1D456}";static minus_character="-";magic_decimal=!1;transform_value;_pattern="";sections;decimal_zero_regexp=[];cloned=[];get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}constructor(e){if(this._pattern=e,this.sections=qt.Parse(e),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new ve),this.sections[1]||(this.sections[1]={...this.sections[0]},this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]={...this.sections[0]},this.cloned[2]=!0),!this.sections[3]){for(let t of this.sections[0].prefix)if(t.flag===5){this.sections[3]={...this.sections[0]},this.sections[3].string_format=!0,this.cloned[3]=!0;break}}this.decimal_zero_regexp=this.sections.map(t=>{if(t.decimal_max_digits>t.decimal_min_digits)return new RegExp(`0{1,${t.decimal_max_digits-t.decimal_min_digits}}(?:$|e)`)})}static FormatPartsAsText(e,t=0){let r=-1,i=e.map((n,s)=>{switch(n.flag){case 2:return r=s,n.text;case 1:return n.text.replace(/./g," ");case 6:return"";default:return n.text}});if(r>=0&&t){let n=i.reduce((a,l,u)=>u===r?a:a+l.length,0),s="";for(let a=0;a<t-n;a++)s+=i[r];i[r]=s}return i.join("")}SetDecimal(e){for(let t of this.sections)t.fraction_format||(t.decimal_min_digits=e,t.decimal_max_digits=e)}IncreaseDecimal(){this.sections.forEach(e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.min(e.fraction_denominator_digits+1,4)):(e.decimal_min_digits++,e.decimal_max_digits=e.decimal_min_digits)})}DecreaseDecimal(){this.sections.forEach(e=>{e.fraction_format?e.fraction_denominator||(e.fraction_denominator_digits=Math.max(e.fraction_denominator_digits-1,1)):(e.decimal_min_digits=Math.max(0,e.decimal_min_digits-1),e.decimal_max_digits=e.decimal_min_digits)})}AddGrouping(){this.sections.forEach(e=>{e.grouping=!0})}RemoveGrouping(){this.sections.forEach(e=>{e.grouping=!1})}ToggleGrouping(){let e=!this.sections[0].grouping;this.sections.forEach(t=>{t.grouping=e})}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter((e,t)=>!this.cloned[t]).map(e=>{let t="",r=0;if(e.fraction_format){e.fraction_integer&&(t+="? ");let i="";for(let n=0;n<e.fraction_denominator_digits;n++)i+="#";t+=i,t+="/",e.fraction_denominator?t+=e.fraction_denominator:t+=i}else if(e.has_number_format){for(r=0;r<e.integer_min_digits;r++)t+="0";if(e.grouping&&(t.length<4&&(t=("####"+t).slice(-4)),t=t.replace(/[\\d#]{1,3}(?=([\\d#]{3})+(?![\\d#]))/g,"$&,")),e.decimal_max_digits||e.decimal_min_digits){for(t+=".",r=0;r<e.decimal_min_digits;r++)t+="0";for(;r<e.decimal_max_digits;r++)t+="#"}if(e.scaling){let i=Math.log10(e.scaling)/3;for(r=0;r<i;r++)t+=","}e.exponential&&(t+="e")}return e.prefix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.flag===6?"["+i.text+"]":i.text).join("")+t+e.suffix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.text).join("")}).join(";")}FormatDimensionedQuantity(e){if(this.transform_value){let r=this.transform_value(e);if(Vr(r))e=r;else return typeof r=="string"?r:this.FormatParts(r)}let t=this.FormatParts(e.value||0);return e.unit&&t.push({text:" "},{text:e.unit}),t}FormatComplex(e){if(e.imaginary===1/0||e.imaginary===-1/0||e.real===1/0||e.real===-1/0)return[{text:"Infinity"}];let t=[],r=[],i=!1,n=!!e.imaginary;n&&(t=this.FormatParts(e.imaginary),n=t.some(l=>/[1-9]/.test(l.text)),t.length===1&&this.sections[0].integer_min_digits<=1&&t[0].text==="1"?(t[0].text="",i=!0):t.length===1&&this.sections[1].integer_min_digits<=1&&t[0].text==="-1"&&(t[0].text="-",i=!0));let s=!!e.real;s&&(r=this.FormatParts(e.real),s=r.some(l=>/[1-9]/.test(l.text)));let a=[];if(s||!s&&!n){if(a.push(...r),n){a.push({text:e.imaginary<0?` ${o.minus_character} `:" + "});let l=i?[]:this.FormatParts(Math.abs(e.imaginary));a.push(...l,{text:o.imaginary_character})}}else n&&a.push(...t,{text:o.imaginary_character});return a}FormatParts(e){if(typeof e!="number"&&!this.sections[3])return[{text:(e??"").toString()}];let{parts:t,section:r}=this.BaseFormat(e),i=[];if(r.date_format||r.string_format)for(let n of t)typeof n=="string"?i.push({text:n}):i.push(n);else this.magic_decimal&&t[1]===""&&t.splice(1,1),i=[...r.prefix.map(n=>({...n})),{text:r.has_number_format?t.join(F.decimal_separator):""},...r.suffix.map(n=>({...n}))];for(let n=1;n<i.length;n++)i[n].flag===i[n-1].flag&&(i[n].text=i[n-1].text+i[n].text,i[n-1].text="");return i.filter(n=>n.text)}Format(e,t=0){return o.FormatPartsAsText(this.FormatParts(e),t)}ZeroPad(e,t){for(;e.length<t;)e="0"+e;return e}DateFormat(e){let t=Be(e),r=this.sections[0],i=t.getUTCHours();return r.twelve_hour&&(i>12&&(i-=12),i===0&&(i=12)),{parts:r.prefix.map(s=>{if(s.flag===4)return s.text==="mm"?{text:this.ZeroPad(t.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(t.getUTCMinutes().toString(),1)};if(s.flag===3){switch(s.text.toLowerCase()){case"am/pm":case"a/p":{let l=s.text.split("/");return{text:t.getUTCHours()>12?l[1]:l[0]}}case"mmmmm":return{text:F.date_components.long_months[t.getUTCMonth()][0]};case"mmmm":return s.text==="MMMM"?{text:F.date_components.long_months[t.getUTCMonth()].toUpperCase()}:{text:F.date_components.long_months[t.getUTCMonth()]};case"mmm":return s.text==="MMM"?{text:F.date_components.short_months[t.getUTCMonth()].toUpperCase()}:{text:F.date_components.short_months[t.getUTCMonth()]};case"mm":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((t.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return s.text==="DDDDD"||s.text==="DDDD"?{text:F.date_components.long_days[t.getUTCDay()].toUpperCase()}:{text:F.date_components.long_days[t.getUTCDay()]};case"ddd":return s.text==="DDD"?{text:F.date_components.short_days[t.getUTCDay()].toUpperCase()}:{text:F.date_components.short_days[t.getUTCDay()]};case"dd":return{text:this.ZeroPad(t.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(t.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:t.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((t.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(i.toString(),2)};case"h":return{text:this.ZeroPad(i.toString(),1)};case"ss":return{text:this.ZeroPad(t.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(t.getUTCSeconds().toString(),1)}}let a=s.text.match(/^(s+)\\.(0+)$/);if(a)return{text:this.ZeroPad(t.getUTCSeconds().toString(),a[1].length)+F.decimal_separator+(t.getUTCMilliseconds()/1e3).toFixed(a[2].length).substr(2)}}return{...s}}),section:r}}StringFormat(e,t){let r=[];for(let i of t.prefix)i.flag===5?r.push({text:e}):r.push({...i});return{parts:r,section:t}}Round2(e,t){let r=Math.pow(10,t);return Math.round(r*e)/r}FormatFraction(e,t){t.percent&&(e*=100);let r={denominator:1,numerator:Math.round(e),error:Math.abs(Math.round(e)-e)};if(t.fraction_denominator)r.denominator=t.fraction_denominator,r.numerator=Math.round(e*r.denominator);else if(r.error){let n=o.fraction_limits[t.fraction_denominator_digits-1]||o.fraction_limits[0];for(let s=2;s<=n;s++){let a=Math.round(e*s),l=Math.abs(a/s-e);if(l<r.error&&(r={numerator:a,denominator:s,error:l},!l))break}}let i=[];if(t.fraction_integer){let n=Math.floor(r.numerator/r.denominator);r.numerator%=r.denominator,(n||!r.numerator)&&(i.push(n.toString()),r.numerator&&i.push(" "))}else r.numerator||i.push("0");return r.numerator&&(i.push(r.numerator.toString()),i.push("/"),i.push(r.denominator.toString())),i.join("")}BaseFormat(e){if(this.sections[0].date_format)return this.DateFormat(Number(e));if(typeof e!="number")return this.StringFormat((e??"").toString(),this.sections[3]);let t=this.sections[0],r=this.decimal_zero_regexp[0];e<0&&(t=this.sections[1]);let i=t.percent?t.decimal_max_digits+2:t.decimal_max_digits,n=Math.pow(10,-i)/2,s=Math.abs(e);if(s<n&&(t=this.sections[2],r=this.decimal_zero_regexp[2]),t.scaling&&(s/=t.scaling,s<n&&(t=this.sections[2],r=this.decimal_zero_regexp[2])),t.string_format)return this.StringFormat(e.toString(),t);let a="";if(t.fraction_format)return{parts:[this.FormatFraction(s,t)],section:t};t.exponential?a=s.toExponential(t.decimal_max_digits):(t.percent&&(s*=100),a=this.Round2(s,t.decimal_max_digits).toFixed(t.decimal_max_digits)),r&&(a=a.replace(r,""));let l=a.split(".");for(;l[0].length<t.integer_min_digits;)l[0]=("0000000000000000"+l[0]).slice(-t.integer_min_digits);return t.integer_min_digits===0&&l[0]==="0"&&(l[0]=""),t.grouping&&(l[0]=l[0].replace(o.grouping_regexp,"$&"+F.grouping_separator)),{parts:l,section:t}}};var he=class{static cache={};static complex_general;static symbolc_name_map={};static base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"};static aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"};static Get(e,t=!1){if(t&&e==="General")return this.complex_general;let r=this.symbolc_name_map[e.toLowerCase()],i=this.cache[r||e];return i||(i=new Ue(e),this.cache[e]=i),i}static Equals(e,t){if(e===t)return!0;let r=this.Get(e),i=this.Get(t);return r.pattern===i.pattern}static Translate(e){let t=this.symbolc_name_map[e.toLowerCase()];return t?this.cache[t].toString():e}static SymbolicName(e){for(let t of Object.keys(this.base_formats))if(e===this.base_formats[t])return t;return null}static InitCache(){for(let e of Object.keys(this.base_formats))this.cache[e]=new Ue(this.base_formats[e]),this.symbolc_name_map[e.toLowerCase()]=e;this.cache.General.magic_decimal=!0,this.complex_general=new Ue("0.###"),this.complex_general.magic_decimal=!0;for(let e of Object.keys(this.aliases))this.cache[e]=this.cache[this.aliases[e]],this.symbolc_name_map[e.toLowerCase()]=e}};he.InitCache();var $i=new Date().getUTCFullYear(),Xr=class{compare_day;compare_month;TestDate(e){let t=Date.parse(e);if(isNaN(t))return!1;let r=new Date(t),n=e.replace(/[\\d\\-\\\\/,.\\s]+/g," ").toLocaleLowerCase().split(/\\s+/).map(l=>l.trim()).filter(l=>!!l);if(!n.length)return t;if(!this.compare_month){this.compare_month={};for(let l=0;l<12;l++)this.compare_month[F.date_components.long_months[l].toLocaleLowerCase().replace(/\\./,"")]=l,this.compare_month[F.date_components.short_months[l].toLocaleLowerCase().replace(/\\./,"")]=l}if(!this.compare_day){this.compare_day={};for(let l=0;l<7;l++)this.compare_day[F.date_components.long_days[l].toLocaleLowerCase().replace(/\\./,"")]=l,this.compare_day[F.date_components.short_days[l].toLocaleLowerCase().replace(/\\./,"")]=l}let s=!1,a=!1;for(let l of n){let u=!1;for(let[c,h]of Object.entries(this.compare_month))if(l===c){if(s||r.getUTCMonth()!==h)return!1;u=!0,s=!0}if(!u){for(let[c,h]of Object.entries(this.compare_day))if(l===c){if(a||r.getUTCDay()!==h)return!1;u=!0,a=!0}}if(!u)return!1}return a&&!s?!1:t}TryParse(e=""){let t={};if(e[0]==="\'")return{value:e,type:2};if(e==="")return{value:e,type:2};if(e==="NaN")return{value:NaN,type:3,hints:{Nan:!0}};let r=e.trim(),i=r.match(/^[$](.*?)$/);i&&(r=i[1],t.Currency=!0);let n=r.match(/^\\((.*?)\\)$/);n&&(r=n[1],t.Parens=!0);let s=r.match(/^(.*?)%\\s*$/);s&&(r=s[1],t.Percent=!0),F.decimal_separator==="."?/,/.test(r)&&(r=r.replace(/,/g,""),t.Grouping=!0):(r=r.replace(/(\\d)\\s+/g,"$1"),r=r.replace(/\\./g,""),r=r.replace(/,/,"."));let a=Number(r);if(a===null||isNaN(a)){let l=e.toLowerCase();if(l==="false")return{value:!1,type:4};if(l==="true")return{value:!0,type:4};let u=this.TestDate(e);if(u!==!1&&!isNaN(u)){let c=new Date(u),h=c.getUTCFullYear();if(h>=$i-200&&h<=$i+200)return t={Date:!0},(c.getHours()||c.getMinutes()||c.getSeconds())&&(t.Time=!0),{value:we(u,!0),type:3,hints:t}}return{value:e,type:2}}if(n&&(a=-a),s){let l=a<0?-1:1,u=(l*a).toString().split(".");u[0]=("00"+u[0]).replace(/(\\d\\d)$/,".$1"),a=Number(u.join(""))*l}return/e/.test(e)&&(t.Exponential=!0),{value:a,type:3,hints:t}}},He=new Xr;var gt=class o extends Ge{constructor(t,r,i){super();this.model=t;this.view=r;this.autocomplete=i;this.parser=t.parser}static FormulaChars=("$^&*(-+={[<>/~%@"+F.argument_separator).split("");active_cell;autocomplete_matcher;container_node;active_editor;nodes=[];target_address;assume_formula=!1;text_formula=!1;get selecting(){if(this.assume_formula)return!0;if(!this.text_formula)return!1;if(this.active_editor&&this.active_editor.node===this.active_editor.node.ownerDocument.activeElement){let t=this.active_editor.node.ownerDocument.defaultView,r=t.getSelection();if(r?.rangeCount){let s=r?.getRangeAt(0);if((s?.endContainer instanceof t.HTMLElement?s.endContainer:s.endContainer?.parentElement)?.dataset.reference!==void 0)return!0;if(s?.startContainer instanceof t.Text){let l=(s.startContainer.textContent?.substring(0,s.startOffset)||"").trim();if(l.length&&o.FormulaChars.includes(l[l.length-1]))return!0}else console.info("mark 21",s)}let n=this.SubstringToCaret2(this.active_editor.node)[1].trim();if(n.length){let s=n[n.length-1];return o.FormulaChars.includes(s)}}return!1}composite_dependencies=[];get dependencies(){return this.composite_dependencies}parser;FocusEditor(){this.active_editor&&this.active_editor.node.focus()}RegisterListener(t,r,i){t.node.addEventListener(r,i),t.listeners||(t.listeners=new Map),t.listeners.set(r,i)}SelectAll(t){let i=t.ownerDocument.defaultView.getSelection(),n=t.ownerDocument.createRange();n.selectNode(t),i?.removeAllRanges(),i?.addRange(n)}SetCaret(t,r){let i=t.node.ownerDocument,n=i?.defaultView,s=n.getSelection(),a=i?.createRange(),l=c=>{let h=c;for(;h&&!(h instanceof n.Text)&&h.firstChild;)h=h.firstChild;return h},u=l(t.node);if(r){let c=l(r.node);s&&a&&(a.setStart(u,t.offset),a.setEnd(c,r.offset),s.removeAllRanges(),s.addRange(a))}else s&&a&&(a.setStart(u,t.offset),a.setEnd(u,t.offset),a.collapse(!0),s.removeAllRanges(),s.addRange(a))}InsertReference(t){if(!this.active_editor)return;let r=this.active_editor.node.ownerDocument.defaultView,i=r.getSelection();if(!i)throw new Error("error getting selection");if(i.rangeCount===0)return"";let n=i.getRangeAt(0),s=this.active_editor.node.textContent||"";if(n.startContainer instanceof r.Text)if(!n.collapsed&&n.startOffset<n.endOffset){let a=this.SubstringToCaret2(this.active_editor.node);this.active_editor.node.textContent=a[0]+t+s.substring(a[1].length),this.SetCaret({node:this.active_editor.node,offset:a[0].length},{node:this.active_editor.node,offset:a[0].length+t.length})}else{let a=n.startContainer.parentElement;if(a instanceof r.HTMLElement&&a.dataset.reference)a.textContent=t,this.SetCaret({node:a,offset:t.length});else{let l=this.SubstringToCaret2(this.active_editor.node)[1],u="",c=l.trim();if(c.length){let h=c[c.length-1];o.FormulaChars.includes(h)||(l.length===c.length?u=" +":u="+")}this.active_editor.node.textContent=l+u+t+s.substring(l.length),this.SetCaret({node:this.active_editor.node,offset:l.length+t.length+u.length})}}else n.startContainer instanceof r.HTMLElement?(n.startContainer.textContent=t,this.SetCaret({node:n.startContainer,offset:t.length})):console.warn("unexpected range start container",n.startContainer);this.UpdateText(this.active_editor),this.UpdateColors(),this.active_editor.node.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}UpdateColors(t=!1,r=!1){let i=new Map,n=new Map;for(let a of this.nodes)for(let l of a.references||[]){let u=this.model.AddressToLabel(l);i.has(u)||(i.set(u,l),n.set(u,n.size))}for(let a of this.nodes){for(let l of Array.from(a.node.childNodes)){let u=l.ownerDocument?.defaultView;if(u&&l instanceof u.HTMLElement&&l.dataset.reference){let c=n.get(l.dataset.reference);l.dataset.highlightIndex=typeof c=="number"?(c%5+1).toString():"?"}}a.check=a.node.innerHTML.length}let s=Array.from(i.values());!t&&JSON.stringify(this.composite_dependencies)===JSON.stringify(s)||(this.composite_dependencies=s,r||this.Publish({type:"update",dependencies:this.composite_dependencies}))}UpdateDependencies(t,r){let i=[];for(let l of r.full_reference_list||[])switch(l.type){case"address":case"range":{let u=l.type==="range"?l.start:l;u.sheet_id||(u.sheet?u.sheet_id=this.model.sheets.Find(u.sheet)?.id||0:u.sheet_id=this.view.active_sheet.id),i.push(l);break}case"structured-reference":if(this.target_address){let u=this.model.ResolveStructuredReference(l,this.target_address);u&&i.push(u)}else console.info("target address not set");break;case"identifier":{let u=this.model.GetName(l.name,this.view.active_sheet.id);u?.type==="range"&&(u.area.count===1?i.push({type:"address",...u.area.start,label:l.name,position:l.position,id:l.id}):i.push({type:"range",start:{type:"address",position:l.position,id:l.id,label:l.name,...u.area.start},end:{type:"address",position:l.position,label:l.name,id:l.id,...u.area.end},label:l.name,position:l.position,id:l.id}));break}}i.sort((l,u)=>l.position-u.position);let n=[],s=new Set,a=new Map;for(let l of i){let u=this.model.AddressToLabel(l),c=Z(l)?new M(l):new M(l.start,l.end);s.has(u)||(n.push(c),s.add(u)),a.set(l.label,u)}return this.UpdateReferences(t,n),a}UpdateReferences(t,r=[]){t.node.dataset.references=JSON.stringify(r.map(i=>this.model.AddressToLabel(i))),t.references=r}UpdateText(t,r={}){let i=t.node,n=i.textContent||"",s=ne.GetInstance(i.ownerDocument);if(this.text_formula=n[0]==="=",this.active_editor&&!this.assume_formula&&(this.active_editor.node.spellcheck=!this.text_formula,!this.text_formula)||n===t.formatted_text)return;let[a,l]=this.SubstringToCaret2(i),u=a.length,c=l.length;if(u===0&&c===0&&(c=n.length),!n)this.UpdateReferences(t);else{let f=this.parser.Parse(n);if(f.expression){let d=this.UpdateDependencies(t,f),m=n[0]==="="?1:0,_=0,y,v,w=0,x,C=s.Fragment(),A=(S,p="text",b="",g=!1)=>{let D=s.Text(S);if((g||(u>w||u===0&&w===0)&&u<=w+S.length)&&(y={offset:u-w,node:D}),c>w&&c<=w+S.length&&(v={offset:c-w,node:D}),p!=="text"){let I=s.Create("span",p);b&&(I.dataset.reference=b),I.appendChild(D),C.appendChild(I)}else C.appendChild(D);x=D,w+=S.length};this.parser.Walk(f.expression,S=>{if(S.type==="missing"||S.type==="group"||S.type==="dimensioned")return!0;let p=S.position+m,b=n.substring(_,p),g="",D=S.type,I="";switch(S.type){case"identifier":g=n.substring(p,p+S.name.length),I=d.get(S.name)||"";break;case"call":g=n.substring(p,p+S.name.length);break;case"literal":if(typeof S.value=="string")g=n.substring(p,p+S.value.length+2),D="string";else return!1;break;case"address":case"range":case"structured-reference":I=d.get(S.label)||"???",g=r.rewrite_addresses?S.label:n.substring(p,p+S.label.length);break;default:return!0}return A(b),A(g,D,I),_=p+g.length,S.type!=="range"}),_<n.length&&A(n.substring(_)),y||(x?y={node:x,offset:(x.data||"").length}:A("",void 0,"",!0)),i.textContent="",i.appendChild(C),y&&!r.format_only&&i===this.active_editor?.node&&this.SetCaret(y,v)}}t.formatted_text=n;let h=this.autocomplete_matcher;h&&Promise.resolve().then(()=>{let f=h.Exec({text:n,cursor:l.length}),d=this.NodeAtIndex(f.completions?.length?f.position||0:f.function_position||0);this.Autocomplete(f,d)})}NodeAtIndex(t){let r=this.active_editor?.node.childNodes||[];for(let i=0;i<r.length;i++){let n=r[i].textContent?.length||0;if(n>t)return r[i];t-=n}}AcceptAutocomplete(t){if(!this.active_editor)return;let r;if(t.data&&t.data.completions){for(let c of t.data.completions)if(c.name.toLowerCase()===t.value?.toLowerCase()){r=c.type;break}}let i=t.data?.position||0,n=i+(t.data?.token?.length||0),s=r==="token"?t.value:t.value+"(",a=this.active_editor.node.textContent||"",l=a.substring(0,i)+s,u=l.length;l+=a.substring(n),this.active_editor.node.textContent=l,this.SetCaret({node:this.active_editor.node,offset:u}),this.autocomplete?.Hide(),this.UpdateText(this.active_editor),this.UpdateColors()}Autocomplete(t,r){if(!this.container_node||!this.autocomplete)return;let i;r?.nodeType===Node.ELEMENT_NODE?i=r.getBoundingClientRect():i=this.container_node.getBoundingClientRect();let n=new me(Math.round(i.left),Math.round(i.top),i.width,i.height);this.autocomplete.Show(this.AcceptAutocomplete.bind(this),t,n)}SubstringToCaret2(t,r=!1){let i=["",""];if(!r&&t!==t.ownerDocument.activeElement||t!==this.active_editor?.node)return i;let s=t.ownerDocument.defaultView,a=[!1,!1],l=(c,h)=>{if(c===h.startContainer&&c===h.endContainer&&!(c instanceof s.Text)){a[0]=a[1]=!0,i[0]+=c.textContent,i[1]+=c.textContent;return}if(c===h.startContainer&&(i[0]+=(c.textContent||"").substring(0,h.startOffset),a[0]=!0),c===h.endContainer&&(i[1]+=(c.textContent||"").substring(0,h.endOffset),a[1]=!0),!(a[0]&&a[1])){if(c instanceof s.Text){let f=c.textContent||"";a[0]||(i[0]+=f),a[1]||(i[1]+=f)}else if(c.hasChildNodes()){for(let f of Array.from(c.childNodes))if(l(f,h),a[0]&&a[1])return}}},u=s.getSelection();if(u?.rangeCount??!1){let c=u?.getRangeAt(0);c&&l(t,c)}return i}};var wo=typeof navigator>"u"?"":navigator.appVersion,xe=typeof navigator>"u"?"":navigator.userAgent,Yr=class{is_edge=/Edge/.test(wo);is_ipad=/iPad|iPhone/.test(xe);is_android=/android|samsung/i.test(xe);is_mobile=this.is_ipad||this.is_android;is_firefox=/firefox/i.test(xe);is_safari=/safari/i.test(xe)&&!/edg/i.test(xe);is_mac=/macintosh/i.test(xe);is_chrome=/Chrome/i.test(xe);is_windows=/win64|win32|windows\\s+nt/i.test(xe);is_modern=!this.is_edge&&!(this.is_firefox&&this.is_android)&&/webkit|firefox/i.test(xe)},xo={is_edge:!1,is_ipad:!1,is_android:!1,is_firefox:!1,is_safari:!1,is_mac:!1,is_chrome:!1,trident:!1,is_windows:!1,is_modern:!0,is_node:!0,is_mobile:!1},$t=typeof navigator>"u"?xo:new Yr;var Wi=new Map,nt,ei=(o,e)=>{let t=o,r=Wi.get(t);return r||(r=Co(o,e),Wi.set(t,r),r)};var Co=(o,e)=>{nt||typeof document<"u"&&(nt=document.createElement("canvas")),nt&&(e?nt.style.fontVariant=e:nt.style.fontVariant="");let t=nt?.getContext("2d",{alpha:!1});if(!t)throw new Error("invalid context");t.textBaseline="alphabetic",t.textAlign="center",t.font=o;let r=t.measureText("("),i=r.actualBoundingBoxRight+r.actualBoundingBoxLeft;r=t.measureText("#");let n=r.actualBoundingBoxRight+r.actualBoundingBoxLeft;return r=t.measureText("Mljy!"),{paren:i,hash:n,ascent:r.fontBoundingBoxAscent,descent:r.fontBoundingBoxDescent,height:r.fontBoundingBoxAscent+r.fontBoundingBoxDescent}};var Jt=class{get list(){return this.sheets_.slice(0)}get length(){return this.sheets_.length}names=new Map;ids=new Map;sheets_=[];Assign(e){this.sheets_=[...e],this.UpdateIndexes()}Add(e){this.sheets_.push(e),this.UpdateIndexes()}Splice(e,t,...r){this.sheets_.splice(e,t,...r),this.UpdateIndexes()}Find(e){return typeof e=="string"?this.names.get(e.toLocaleUpperCase()):this.ids.get(e)}Name(e){return this.ids.get(e)?.name||void 0}ID(e){return this.names.get(e.toLocaleUpperCase())?.id||void 0}UpdateIndexes(){this.names.clear(),this.ids.clear();for(let e of this.sheets_){let t=e.name.toLocaleUpperCase();this.names.set(t,e),this.ids.set(e.id,e)}}};var Wt=class{constructor(e){this.parser=e}named=new Map;get list(){return this.named.values()}SetNamedExpression(e,t,r){return this.SetName({type:"expression",name:e,expression:t,scope:r})}SetNamedRange(e,t,r){return this.SetName({type:"range",name:e,area:new M(t.start,t.end),scope:r})}SetName(e){let t=e.name;return this.ValidateNamed(t)?(this.named.set(this.ScopedName(t,e.scope),e),!0):(console.warn("invalid name",{name:t}),!1)}ScopedName(e,t){return typeof t=="number"?t+":"+e.toLowerCase():e.toLowerCase()}ClearName(e,t){typeof t=="number"?this.named.delete(this.ScopedName(e,t)):this.named.delete(e.toLowerCase())}RemoveRangesForSheet(e){let t=[];for(let[r,i]of this.named)(i.type==="range"&&i.area.start.sheet_id===e||i.scope===e)&&t.push(r);for(let r of t)this.named.delete(r)}Reset(){this.named.clear()}Get_(e,t,r=!1){return r?this.named.get(this.ScopedName(e,t)):this.named.get(this.ScopedName(e,t))||this.named.get(e.toLowerCase())}ValidateNamed(e){return e=e.trim().toUpperCase(),!e.length||/[^A-Z\\d_.?]/.test(e)||/^[^A-Z_]/.test(e)||e==="R"||e==="C"||/^[A-Z]{1,3}[1-9]\\d*$/.test(e)||/^R[[\\]\\d]+C/.test(e)?!1:e}MatchSelection(e,t){if(!e.start.sheet_id)throw new Error("match selection without sheet id");let r;for(let i of this.named.values())if(i.type==="range"&&i.area.start.sheet_id===e.start.sheet_id&&(e.Equals(i.area)&&(r=i.name),t?.Equals(i.area)))return i.name;return r}PatchNamedRanges(e,t,r,i,n){let s=[...this.list];for(let a of s){if(a.type==="expression")continue;let l=a.name,u=a.area;if(u.start.sheet_id!==e){console.info("skipping name",l);continue}if(r&&t<=u.end.column){if(r>0)t<=u.start.column?u.Shift(0,r):t>u.start.column&&t<=u.end.column?u.ConsumeAddress({row:u.end.row,column:u.end.column+r}):console.warn("PNR X case 1",t,r,JSON.stringify(u));else if(r<0)if(t-r<=u.start.column)u.Shift(0,r);else if(t<=u.start.column&&t-r>u.end.column)this.ClearName(l);else if(t<=u.start.column){let c=t-r-1;this.SetName({type:"range",area:new M({row:u.start.row,column:c+1+r,sheet_id:e},{row:u.end.row,column:u.end.column+r}),name:l})}else t<=u.end.column?t-r-1>=u.end.column?this.SetName({type:"range",area:new M({row:u.start.row,column:u.start.column,sheet_id:e},{row:u.end.row,column:t-1}),name:l}):this.SetName({type:"range",name:l,area:new M({row:u.start.row,column:u.start.column,sheet_id:e},{row:u.end.row,column:u.start.column+u.columns+r-1})}):console.warn("PNR X case 2",t,r,JSON.stringify(u))}if(n&&i<=u.end.row){if(n>0)i<=u.start.row?u.Shift(n,0):i>u.start.row&&i<=u.end.row?u.ConsumeAddress({row:u.end.row+n,column:u.end.column}):console.warn("PNR X case 3",i,n,JSON.stringify(u));else if(n<0)if(i-n<=u.start.row)u.Shift(n,0);else if(i<=u.start.row&&i-n>u.end.row)this.ClearName(l);else if(i<=u.start.row){let c=i-n-1;this.SetNamedRange(l,new M({column:u.start.column,row:c+1+n,sheet_id:e},{column:u.end.column,row:u.end.row+n}))}else i<=u.end.row?i-n-1>=u.end.row?this.SetNamedRange(l,new M({column:u.start.column,row:u.start.row,sheet_id:e},{column:u.end.column,row:i-1})):this.SetNamedRange(l,new M({column:u.start.column,row:u.start.row,sheet_id:e},{column:u.end.column,row:u.start.row+u.rows+n-1})):console.warn("PNR X case 4",i,n,JSON.stringify(u))}}}};var vt=class{parser=new zt;language_model;document_name;user_data;sheets=new Jt;named=new Wt(this.parser);macro_functions=new Map;view_count=0;theme_style_properties=JSON.parse(JSON.stringify(P.DefaultProperties));tables=new Map;GetName(e,t){let r=e.split(/!/);if(r.length===1)return this.named.Get_(e,t);let i=r[0];/^\'.*?\'$/.test(i)&&(i=i.substring(1,i.length-1));let n=this.sheets.ID(i);return this.named.Get_(r[1],n||0,!0)}UnserializeNames(e,t,r=!1){this.parser.Save(),r&&this.parser.SetLocaleSettings(".",",");for(let i of e){if(!i.expression)continue;let n=this.parser.Parse(i.expression);if(n.expression){let s=typeof i.scope=="string"?this.sheets.ID(i.scope):void 0;if(n.expression.type==="address"||n.expression.type==="range"){let[a,l]=n.expression.type==="range"?[n.expression.start,n.expression.end]:[n.expression,n.expression];if(a.sheet)if(/^\\[\\d+\\]/.test(a.sheet))console.warn("named range refers to an external file");else{let u=new M({...a,sheet_id:this.sheets.ID(a.sheet)},l);u.start.sheet_id?this.named.SetNamedRange(i.name,u,s):console.warn("missing sheet ID?",a)}else console.warn("missing sheet name?",a)}else this.parser.Walk(n.expression,a=>a.type==="address"||a.type==="range"?(a.type==="range"&&(a=a.start),a.sheet_id||a.sheet&&(a.sheet_id=this.sheets.ID(a.sheet)),a.sheet_id||(a.sheet_id=t?.id),!1):!0),this.named.SetNamedExpression(i.name,n.expression,s)}}this.parser.Restore()}SerializeNames(e){let t=[];for(let r of this.named.list){let i={name:r.name,expression:"",type:r.type};if(r.scope&&(i.scope=this.sheets.Name(r.scope)),r.type==="expression")this.parser.Walk(r.expression,n=>{if(n.type==="address"||n.type==="range"){let s=n.type==="range"?n.start:n;return s.absolute_column=s.absolute_row=!0,s.sheet||(s.sheet_id&&(s.sheet=this.sheets.Name(s.sheet_id)),s.sheet||(s.sheet=e?.name)),n.type==="range"&&(n.end.absolute_column=n.end.absolute_row=!0),!1}return!0}),i.expression=this.parser.Render(r.expression,{missing:""});else{let n={start:{...r.area.start,absolute_column:!0,absolute_row:!0},end:{...r.area.end,absolute_column:!0,absolute_row:!0}};i.expression=this.AddressToLabel(n)}t.push(i)}return t}ResolveStructuredReference(e,t){let r;if(e.table?r=this.tables.get(e.table.toLowerCase()):t.sheet_id&&(r=this.sheets.Find(t.sheet_id)?.CellData(t)?.table),!r)return;let i=e.column.toLowerCase(),n=-1;if(r.columns){for(let s=0;s<r.columns.length;s++)if(i===r.columns[s]){n=r.area.start.column+s;break}}if(!(n<0))if(e.scope==="row"){let s=t.row;return s<r.area.start.row||s>r.area.end.row?void 0:{label:e.label,type:"address",row:s,column:n,sheet_id:r.area.start.sheet_id,id:e.id,position:e.position}}else{let s=r.area.start.row,a=r.area.end.row;return e.scope==="column"&&(s++,r.totals_row&&a--),{label:e.label,type:"range",position:e.position,id:e.id,start:{type:"address",row:s,column:n,sheet_id:r.area.start.sheet_id,label:e.label,position:e.position,id:0},end:{type:"address",row:a,column:n,label:e.label,position:e.position,id:0}}}}AddressToLabel(e){let t=Z(e)?e:e.start,r=Z(e)?[M.CellAddressToLabel(e)]:[M.CellAddressToLabel(e.start),M.CellAddressToLabel(e.end)],i=this.sheets.Find(t.sheet_id||0),n=i?.name?Te.test(i.name)?`\'${i.name}\'`:i.name:"";return n+(n?"!":"")+(r[0]===r[1]?r[0]:r.join(":"))}ResolveSheetID(e,t,r){let i=e.type==="address"?e:e.start;if(i.sheet_id)return!0;if(i.sheet){let n=this.sheets.Find(i.sheet);if(n)return i.sheet_id=n.id,!0}else{if(t?.sheet_id)return i.sheet_id=t.sheet_id,!0;if(r?.id)return i.sheet_id=r.id,!0}return!1}ResolveArea(e,t,r){let i=this.ResolveAddress(e,t,r);return Z(i)?new M(i):new M(i.start,i.end)}ResolveAddress(e,t,r){if(typeof e=="string"){r?.r1c1&&(this.parser.Save(),this.parser.flags.r1c1=!0);let i=this.parser.Parse(e);if(r?.r1c1&&this.parser.Restore(),i.expression&&i.expression.type==="address")return this.ResolveSheetID(i.expression,void 0,t),{row:i.expression.row,column:i.expression.column,sheet_id:i.expression.sheet_id};if(i.expression&&i.expression.type==="range")return this.ResolveSheetID(i.expression,void 0,t),{start:{row:i.expression.start.row,column:i.expression.start.column,sheet_id:i.expression.start.sheet_id},end:{row:i.expression.end.row,column:i.expression.end.column}};if(i.expression&&i.expression.type==="identifier"){let n=this.GetName(i.expression.name,t.id);if(n?.type==="range")return n.area}return{row:0,column:0}}return e}AddConnectedElement(e){let t=this.connected_element_id++;return this.connected_elements.set(t,e),t}RemoveConnectedElement(e){let t=this.connected_elements.get(e);return this.connected_elements.delete(e),t}connected_element_id=100;connected_elements=new Map;language_map;reverse_language_map;SetLanguageMap(e){if(!e)this.language_map=this.reverse_language_map=void 0;else{let t=Object.keys(e);this.language_map={};for(let r of t)this.language_map[r.toUpperCase()]=e[r];this.reverse_language_map={};for(let r of t){let i=e[r];this.reverse_language_map[i.toUpperCase()]=r}}}TranslateFunction(e,t){return this.language_map?this.TranslateInternal(e,this.language_map,this.language_model?.boolean_true,this.language_model?.boolean_false,t):e}UntranslateFunction(e,t){return this.reverse_language_map?this.TranslateInternal(e,this.reverse_language_map,"TRUE","FALSE",t):e}UntranslateData(e,t){return Array.isArray(e)?Nr(e)?e.map(r=>r.map(i=>i&&typeof i=="string"&&i[0]==="="?this.UntranslateFunction(i,t):i)):e.map(r=>r&&typeof r=="string"&&r[0]==="="?this.UntranslateFunction(r,t):r):(e&&typeof e=="string"&&e[0]==="="&&(e=this.UntranslateFunction(e,t)),e)}TranslateInternal(e,t,r,i,n){this.parser.Save(),this.parser.flags.r1c1=n?.r1c1;let s=this.parser.Parse(e);if(s.expression){let a=!1;if(this.parser.Walk(s.expression,l=>{if(l.type==="call"){let u=t[l.name.toUpperCase()];u&&(a=!0,l.name=u)}else l.type==="literal"&&typeof l.value=="boolean"&&(a=!0);return!0}),a)return"="+this.parser.Render(s.expression,{missing:"",boolean_true:r,boolean_false:i,r1c1:n?.r1c1})}return this.parser.Restore(),e}SetLanguage(e){if(this.language_model=e,!e)this.SetLanguageMap(),this.parser.flags.boolean_true="TRUE",this.parser.flags.boolean_false="FALSE";else{let t={};if(e.functions)for(let r of e.functions||[])t[r.base.toUpperCase()]=r.name;this.SetLanguageMap(t),e.boolean_false||(e.boolean_false=t.FALSE),e.boolean_true||(e.boolean_true=t.TRUE),this.parser.flags.boolean_true=e.boolean_true||"TRUE",this.parser.flags.boolean_false=e.boolean_false||"FALSE"}for(let t of this.sheets.list)t.FlushCellStyles()}};var Qi=()=>({target:{row:0,column:0},area:new M({row:0,column:0}),empty:!0});var So=100,Zi={move_with_cells:!0,resize_with_cells:!0,movable:!0,resizable:!0,removable:!0,selectable:!0},qe=class{data={...Zi};get key(){return this.key_}rect;scaled_rect;temp={};view=[];dirty;key_=So++;constructor(e={}){this.data={...Zi,...JSON.parse(JSON.stringify(e))},e.rect&&(this.rect=me.Create(e.rect))}toJSON(){return{...this.data,rect:this.rect}}};var Ao=100,Ki=60,je=class o{static base_id=100;static default_sheet_name="Sheet1";default_style_properties;annotations=[];freeze={rows:0,columns:0};visible=!0;default_column_width=100;default_row_height=25;cells=new It;selection=Qi();scroll_offset={x:0,y:0};name=o.default_sheet_name;tab_color;background_image;_image=void 0;flush_conditional_formats=!1;get image(){return this._image}conditional_formats=[];data_validation=[];outline;id_;row_height_map=new Map;column_width_=[];row_headers=[];column_headers=[];row_header_width=100;column_header_height=25;style_map=[];style_json_map=[];sheet_style={};row_styles={};column_styles={};row_pattern=[];cell_style=[];conditional_format_cache=[];conditional_format_checklist=[];get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(e){this.id_=e,this.id>=o.base_id&&(o.base_id=this.id+1)}constructor(e){this.default_style_properties=e,this.default_column_width=Ao,this.row_header_width=Ki,this.id_=o.base_id++}static Reset(){this.base_id=100}static Blank(e,t,r=30,i=20,n){let s=new o(e);return n&&s.UpdateDefaultRowHeight(n),t&&(s.name=t),r=Math.max(r,1),i=Math.max(i,1),s.cells.EnsureCell({row:r-1,column:i-1}),s}static UpdateStyle(e){if(typeof e.horizontal_align=="number"){let t=["","left","center","right"];e.horizontal_align=t[e.horizontal_align]||void 0}if(typeof e.vertical_align=="number"){let t=["","top","bottom","middle"];e.vertical_align=t[e.vertical_align]||void 0}}static FromJSON(e,t,r){let i=typeof e=="string"?JSON.parse(e):e,n=(u,c)=>{Object.keys(c).forEach(h=>{let f=Number(h)||0;u[f]=c[h]})};r||(r=new o(t)),i.default_column_width&&(r.default_column_width=i.default_column_width),i.default_row_height&&(r.default_row_height=i.default_row_height),i.conditional_formats&&(r.conditional_formats=i.conditional_formats),r.data_validation=(i.data_validations||[]).map(u=>({...u,target:(u.target||[]).map(c=>new M(c.start,c.end))})),i.id&&(r.id=i.id),i.name&&(r.name=i.name),i.tab_color&&(r.tab_color=i.tab_color),i.background_image&&(r.background_image=i.background_image);let s=u=>{let c=u;this.UpdateStyle(c),(c.font_size_value||c.font_size_unit)&&(c.font_size={unit:c.font_size_unit||"pt",value:c.font_size_value||10},c.font_size_unit=void 0,c.font_size_value=void 0),c.font_bold&&(c.bold=!0,c.font_bold=void 0),c.font_italic&&(c.italic=!0,c.font_italic=void 0),c.font_underline&&(c.underline=!0,c.font_underline=void 0),c.font_strike&&(c.strike=!0,c.font_strike=void 0),c.text_color&&(c.text_color!=="none"&&(c.text={text:c.text_color}),c.text_color=void 0),c.background&&(c.background!=="none"&&(c.fill={text:c.background}),c.background=void 0),c.border_top_color&&(c.border_top_color!=="none"&&(c.border_top_fill={text:c.border_top_color}),c.border_top_color=void 0),c.border_left_color&&(c.border_left_color!=="none"&&(c.border_left_fill={text:c.border_left_color}),c.border_left_color=void 0),c.border_bottom_color&&(c.border_bottom_color!=="none"&&(c.border_bottom_fill={text:c.border_bottom_color}),c.border_bottom_color=void 0),c.border_right_color&&(c.border_right_color!=="none"&&(c.border_right_fill={text:c.border_right_color}),c.border_right_color=void 0)},a=i.styles||i.cell_style_refs||[];for(let u of a)s(u);if(r.cell_style=[],a&&(i.cell_styles||[]).forEach(u=>{typeof u.ref=="number"&&(u.style=JSON.parse(JSON.stringify(a[u.ref])))}),r.cells.FromJSON(i.data),i.rows&&r.cells.EnsureRow(i.rows-1),i.columns&&r.cells.EnsureColumn(i.columns-1),i.data)if(Ir(i.data))for(let u of i.data)u.style_ref&&(r.cell_style[u.column]||(r.cell_style[u.column]=[]),r.cell_style[u.column][u.row]=JSON.parse(JSON.stringify(a[u.style_ref])));else if(Fr(i.data))for(let u of i.data){let c=u.row;for(let h of u.cells){let f=h.column;h.style_ref&&(r.cell_style[f]||(r.cell_style[f]=[]),r.cell_style[f][c]=JSON.parse(JSON.stringify(a[h.style_ref])))}}else for(let u of i.data){let c=u.column;for(let h of u.cells){let f=h.row;h.style_ref&&(r.cell_style[c]||(r.cell_style[c]=[]),r.cell_style[c][f]=JSON.parse(JSON.stringify(a[h.style_ref])))}}r.freeze.rows=0,r.freeze.columns=0,i.freeze&&(r.freeze.rows=i.freeze.rows||0,r.freeze.columns=i.freeze.columns||0),r.scroll_offset=i.scroll?{...i.scroll}:{x:0,y:0};for(let u of i.cell_styles||[])if(u.style&&(r.cell_style[u.column]||(r.cell_style[u.column]=[]),r.cell_style[u.column][u.row]=u.style,u.rows))for(let c=1;c<u.rows;c++)r.cell_style[u.column][u.row+c]=JSON.parse(JSON.stringify(u.style));r.sheet_style=i.sheet_style||{},r.column_styles={},r.row_styles={};let l=(u,c)=>{for(let h of Object.keys(u)){let f=Number(h),d=u[f];if(typeof d=="number"){let m=a[d];m&&(c[f]=JSON.parse(JSON.stringify(m)),s(c[f]))}else d&&(c[f]=d,s(c[f]))}};l(i.row_style,r.row_styles),l(i.column_style,r.column_styles),r.row_pattern=i.row_pattern||[],s(r.sheet_style||{});for(let u of r.row_pattern)s(u);if(r.row_height_map=new Map,i.row_height)for(let[u,c]of Object.entries(i.row_height))r.row_height_map.set(Number(u),c);if(r.row_height_map.size>0){let u=Math.max(...r.row_height_map.keys());r.cells.EnsureRow(u)}return r.column_width_=[],n(r.column_width_,i.column_width||{}),r.column_width_.length&&r.cells.EnsureColumn(r.column_width_.length-1),r.annotations=(i.annotations||[]).map(u=>new qe(u)),i.selection&&(r.selection=JSON.parse(JSON.stringify(i.selection))),r.visible=!0,typeof i.visible<"u"&&(r.visible=!!i.visible),r}AddValidation(e){this.data_validation.push({...e,target:(e.target||[]).map(t=>new M(t.start,t.end))})}RemoveValidations(e){let t=new M(e.start,e.end);this.data_validation=this.data_validation.filter(r=>(r.target=r.target.filter(i=>!t.Equals2(i)),r.target.length>0))}GetValidation(e){let t=[];for(let r of this.data_validation)for(let i of r.target)if(i.Contains(e)){t.push(r);break}return t}Activate(e){if(this.background_image){let t=Ui(this.background_image);t&&(this._image=e.Create("img"),this._image.src=t)}}MergeCells(e){e=e.Clone();let t=[...this.cells.Iterate(e,!0)];for(let[r,i]of t.entries())i.merge_area=e,i.render_clean=[],r&&i.Reset()}UnmergeCells(e){for(let t of this.cells.Iterate(e,!1))if(!t.merge_area||!e.Equals(t.merge_area)){console.warn("area mismatch");return}for(let t of this.cells.Iterate(e,!1))t.merge_area=void 0,t.render_clean=[]}UpdateDefaultRowHeight(e,t=1){if(typeof window<"u"){let r=P.Composite([this.default_style_properties,this.sheet_style]),i=P.CompositeFont(e.grid_cell_font_size,r,t,e),s=ei(i.font,i.variants).height*1.25;this.default_row_height<s&&(this.default_row_height=s)}}SetRowHeaders(e){this.row_headers=e.map(t=>t===void 0?"":t.toString()),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(e){this.column_headers=e.map(t=>t===void 0?"":t.toString()),e&&this.cells.EnsureColumn(e.length-1)}RowHeader(e){return this.row_headers?this.row_headers.length>e?this.row_headers[e]:"":e+1}ColumnHeader(e){let t="";if(this.column_headers)return this.column_headers.length>e?this.column_headers[e]:"";for(;;){let r=e%26;if(t=String.fromCharCode(65+r)+t,e=Math.floor(e/26),e)e--;else break}return t}GetRowHeight(e){let t=this.row_height_map.get(e);return typeof t>"u"?this.default_row_height:t}SetRowHeight(e,t){return this.row_height_map.set(e,t),this.cells.EnsureRow(e),t}GetColumnWidth(e){let t=this.column_width_[e];return typeof t>"u"?this.default_column_width:t}SetColumnWidth(e,t){return this.column_width_[e]=t,this.cells.EnsureColumn(e),t}Delta(e,t){let r={},i=[...Object.keys(e),...Object.keys(t)];for(let n of i){let s=e[n],a=t[n];typeof s=="object"&&typeof a=="object"?JSON.stringify(s)!==JSON.stringify(a)&&(r[n]=a):s!==a&&(r[n]=a)}return r}UpdateCellStyle(e,t,r=!0){let{row:i,column:n}=e;this.cell_style[n]||(this.cell_style[n]=[]);let s=this.CompositeStyleForCell(e,!1,!1,void 0,!1),a=P.Composite([this.default_style_properties,s,P.Merge(this.cell_style[n][i]||{},t,r)]),l=this.Delta(s,a);this.cell_style[n][i]=l,this.BleedFlush({start:e,end:e})}Invalidate(e){for(let t of this.cells.Iterate(this.RealArea(e),!1))t.render_clean=[]}UpdateAreaStyle(e,t={},r=!0){if(e)if(e.entire_sheet)this.UpdateSheetStyle(t,r);else if(e.entire_column)for(let i=e.start.column;i<=e.end.column;i++)this.UpdateColumnStyle(i,t,r);else if(e.entire_row)for(let i=e.start.row;i<=e.end.row;i++)this.UpdateRowStyle(i,t,r);else for(let i of e)this.UpdateCellStyle(i,t,r)}HasCellStyle(e){return!!(this.cell_style[e.column]&&this.cell_style[e.column][e.row]||this.row_styles[e.row]||this.column_styles[e.column]||this.row_pattern.length)}NextVisibleColumn(e){for(++e;this.column_width_[e]===0;e++);return e}PreviousVisibleColumn(e){for(--e;e>=0&&this.column_width_[e]===0;e--);return e}NextVisibleRow(e){for(++e;this.GetRowHeight(e)===0;e++);return e}PreviousVisibleRow(e){for(--e;e>=0&&this.GetRowHeight(e)===0;e--);return e}TableRow(e,t){let r={alternate:!1,header:t===e.area.start.row,last:!1,totals:e.totals_row&&t===e.area.end.row};if(r.header||r.totals)return r;if(!(e.totals_row&&this.GetRowHeight(e.area.end.row)>0)){let a=e.area.end.row;for(;a>=e.area.start.row;a--)if(this.GetRowHeight(a)){r.last=a===t;break}}let n=e.area.start.row+1,s=t-n;for(let[a,l]of this.row_height_map.entries())if(!(a<n)){if(a>e.area.end.row)break;l||s--}return r.alternate=s%2===1,r}SurroundingStyle(e,t){let r=[{},{},{},{},{},{},{},{},{},{}],i=e.column+1,n=e.column-1,s=e.row+1,a=e.row-1;for(;this.column_width_[i]===0;i++);for(;this.GetRowHeight(s)===0;s++);for(;n>=0&&this.column_width_[n]===0;n--);for(;a>=0&&this.GetRowHeight(a)===0;a--);return n>=0&&a>=0&&(r[7]=this.CellStyleData({row:a,column:n},t)||{}),n>=0&&(r[4]=this.CellStyleData({row:e.row,column:n},t)||{},r[1]=this.CellStyleData({row:s,column:n},t)||{}),a>=0&&(r[8]=this.CellStyleData({row:a,column:e.column},t)||{},r[9]=this.CellStyleData({row:a,column:i},t)||{}),r[6]=this.CellStyleData({row:e.row,column:i},t)||{},r[2]=this.CellStyleData({row:s,column:e.column},t)||{},r[3]=this.CellStyleData({row:s,column:i},t)||{},r}CellStyleData(e,t){let r=this.cells.GetCell(e);if(r){if(!r.style){let i=this.GetStyleIndex(this.CompositeStyleForCell(e));r.style=this.style_map[i]}if(r.table){let i=r.table.theme||t;if(i){let n=JSON.parse(JSON.stringify(r.style)),s=this.TableRow(r.table,e.row);return s.header?i.header&&(n=P.Composite([n,i.header])):s.totals?i.total&&(n=P.Composite([n,i.total])):s.alternate?i.odd&&(n=P.Composite([n,i.odd])):i.even&&(n=P.Composite([n,i.even])),n}}return r.style}}GetCopyStyle(e){return this.CompositeStyleForCell(e,!0,!1,void 0,!1)}CellData(e){let t=this.cells.EnsureCell(e);if(t.rendered_type)return t;let r,i;if(t.calculated_type?(i=t.calculated,r=t.calculated_type):(i=t.value,r=t.type),!t.style){let n=this.GetStyleIndex(this.CompositeStyleForCell(e));t.style=this.style_map[n]}if(!r||i===null||typeof i>"u")t.formatted="",t.rendered_type=2;else if(r===3)isNaN(i)?t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan:t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=3;else if(r===6)t.formatted="#"+(i||"ERR?"),t.rendered_type=6;else if(r===4)t.formatted=i.toString().toUpperCase(),t.rendered_type=4;else if(r===1&&t.calculated===void 0)t.formatted="",t.rendered_type=2;else if(r===7){let n=i;if(isNaN(n.real)||isNaN(n.imaginary))t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan;else{let s=he.Get(t.style.number_format||"",!0);t.formatted=s.FormatComplex(n)}t.rendered_type=7}else if(r===9){if(isNaN(i.value))t.formatted=typeof t.style.nan>"u"?"NaN":t.style.nan,t.formatted+=" "+i.unit;else{let n=he.Get(t.style.number_format||"",!0);t.formatted=n.FormatDimensionedQuantity(i)}t.rendered_type=9}else r===10?(t.formatted="\\u{1D453}()",t.rendered_type=2):(t.formatted=this.FormatNumber(i,t.style.number_format),t.rendered_type=2);return t}FormatNumber(e,t=""){let r=he.Get(t).FormatParts(e);return r.length?r.length===1&&!r[0].flag?r[0].text||"":r:""}SetHeaderSize(e=Ki,t=this.default_row_height){this.row_header_width=e,this.column_header_height=t}GetStyle(e){return this.style_map[e]}InsertRows(e=0,t=1){if(e)for(let u=0;u<this.cells.columns;u++){let c=this.cells.GetCell({row:e-1,column:u},!1);if(c&&c.area){let h=this.cells.GetCell({row:e,column:u},!1);if(h&&h.area&&h.area.Equals(c.area))return!1}}t<0?this.cells.DeleteRows(e,-t):this.cells.InsertRows(e,t);let r={},i={};for(let u=e;u<this.cells.rows;u++)for(let c=0;c<this.cells.columns;c++){let h=this.cells.GetCell({row:u,column:c},!1);h&&(h.area&&!i[h.area.spreadsheet_label]&&(i[h.area.spreadsheet_label]=h.area),h.merge_area&&!r[h.merge_area.spreadsheet_label]&&(r[h.merge_area.spreadsheet_label]=h.merge_area))}for(let u of Object.keys(i)){let c=i[u],h=new M({row:c.start.row+t,column:c.start.column},{row:c.end.row+t,column:c.end.column});for(let f of h){let d=this.cells.GetCell(f,!0);d.area=h}}for(let u of Object.keys(r)){let c=r[u],h={row:c.start.row,column:c.start.column};c.start.row>=e&&(h.row+=t);let f=new M(h,{row:c.end.row+t,column:c.end.column});for(let d of f){let m=this.cells.GetCell(d,!0);m.merge_area=f}}let n=Object.keys(this.row_styles),s={};n.forEach(u=>{let c=Number(u);c<e?s[c]=this.row_styles[c]:t<0&&c<e-t||(s[c+t]=this.row_styles[c])}),this.row_styles=s;let a=[];if(t<0)a=[e,-t];else{a=[e,0];for(let u=0;u<t;u++)a.push(void 0)}this.cell_style.forEach(u=>{u&&u.length>=e&&u.splice.apply(u,a)});let l=new Map;if(t>0)for(let[u,c]of this.row_height_map)u>=e?l.set(u+t,c):l.set(u,c);else if(t<0)for(let[u,c]of this.row_height_map)u>=e?u>=e-t&&l.set(u+t,c):l.set(u,c);return this.row_height_map=l,this.FlushCellStyles(),!0}InsertColumns(e=0,t=1){if(e)for(let l=0;l<this.cells.rows;l++){let u=this.cells.GetCell({row:l,column:e-1},!1);if(u&&u.area){let c=this.cells.GetCell({row:l,column:e},!1);if(c&&c.area&&c.area.Equals(u.area))return!1}}t<0?this.cells.DeleteColumns(e,-t):this.cells.InsertColumns(e,t);let r={},i={};for(let l=e;l<this.cells.columns;l++)for(let u=0;u<this.cells.rows;u++){let c=this.cells.GetCell({row:u,column:l},!1);c&&(c.area&&!i[c.area.spreadsheet_label]&&(i[c.area.spreadsheet_label]=c.area),c.merge_area&&!r[c.merge_area.spreadsheet_label]&&(r[c.merge_area.spreadsheet_label]=c.merge_area))}for(let l of Object.keys(i)){let u=i[l],c=new M({row:u.start.row,column:u.start.column+t},{row:u.end.row,column:u.end.column+t});for(let h of c){let f=this.cells.GetCell(h,!0);f.area=c}}for(let l of Object.keys(r)){let u=r[l],c={row:u.start.row,column:u.start.column};u.start.column>=e&&(c.column+=t);let h=new M(c,{row:u.end.row,column:u.end.column+t});for(let f of h){let d=this.cells.GetCell(f,!0);d.merge_area=h}}let n=Object.keys(this.column_styles),s={};n.forEach(l=>{let u=Number(l);u<e?s[u]=this.column_styles[u]:t<0&&u<e-t||(s[u+t]=this.column_styles[u])}),this.column_styles=s;let a=[];if(t<0)a=[e,-t];else{a=[e,0];for(let l=0;l<t;l++)a.push(void 0)}return this.cell_style.splice.apply(this.cell_style,a),this.column_width_.splice.apply(this.column_width_,a),this.FlushCellStyles(),!0}ClearArea(e){for(let t of this.cells.Iterate(this.RealArea(e),!1))t.Reset()}SetAreaValues2(e,t){e=this.RealArea(e),this.cells.SetArea(e,t)}SetArrayValue(e,t){e=this.RealArea(e);for(let i of this.cells.Iterate(e,!0))i.SetArray(e);this.cells.GetCell(e.start,!0).SetArrayHead(e,t)}SetCellValue(e,t){this.cells.GetCell(e,!0).Set(t)}TablesFromArea(e,t=!1){if(Z(e)){let i=this.cells.GetCell(e,!1);return i?.table&&(!t||e.row===i.table.area.start.row)?[i.table]:[]}let r=new Set;for(let i=e.start.row;i<=e.end.row;i++)for(let n=e.start.column;n<=e.end.column;n++){let s=this.cells.GetCell({row:i,column:n},!1);s?.table&&!r.has(s.table)&&(!t||i===s.table.area.start.row)&&r.add(s.table)}return Array.from(r.values())}RealArea(e,t=!1){let r=e.start,i=e.end;return e.entire_row&&(r.column=0,r.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),e.entire_column&&(r.row=0,r.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),t&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new M(r,i)}GetCellStyle(e,t=!1){if(Z(e))return this.CompositeStyleForCell(e,!0,!1,t);if(e.start.row===e.end.row&&e.start.column===e.end.column)return[[this.CompositeStyleForCell(e.start,!0,!1,t)]];let r=[];for(let i=e.start.row;i<=e.end.row;i++){let n=[];for(let s=e.start.column;s<=e.end.column;s++)n.push(this.CompositeStyleForCell({row:i,column:s},!0,!1,t));r.push(n)}return r}FormattedCellValue(e){let t=this.CellData(e);if(t)return typeof t.formatted=="string"?t.formatted:t.formatted?t.formatted.map(r=>{switch(r.flag){case 1:return" ";case 2:return" ";default:return r.text}}).join(""):t.value}GetFormattedRange(e,t=e){if(e.row===t.row&&e.column===t.column)return this.FormattedCellValue(e);let r=[];for(let i=e.row;i<=t.row;i++){let n=[];for(let s=e.column;s<=t.column;s++)n.push(this.FormattedCellValue({row:i,column:s}));r.push(n)}return r}NumberFormatsAndColors(e,t){let r=i=>{i.number_format&&(t[i.number_format]=1),ie(i.text)&&(e[i.text.text]=1),ie(i.fill)&&(e[i.fill.text]=1),ie(i.border_top_fill)&&(e[i.border_top_fill.text]=1),ie(i.border_left_fill)&&(e[i.border_left_fill.text]=1),ie(i.border_right_fill)&&(e[i.border_right_fill.text]=1),ie(i.border_bottom_fill)&&(e[i.border_bottom_fill.text]=1)};r(this.sheet_style);for(let i in this.row_styles)r(this.row_styles[i]);for(let i in this.column_styles)r(this.column_styles[i]);for(let i of this.row_pattern)r(i);for(let i of this.cell_style)if(i)for(let n of i)n&&r(n)}CompressCellStyles(e){let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(i)for(let n=0;n<i.length;n++){let s=i[n];if(s){let a=n+1;for(;a<i.length&&i[a]===s;a++);a>n+1?t.push({row:n,column:r,ref:s,rows:a-n}):t.push({row:n,column:r,ref:s}),n=a-1}}}return t}toJSON(e={}){let t=(p,b)=>{let g={};for(let D=0;D<p.length;D++)typeof p[D]<"u"&&p[D]!==b&&(g[D]=p[D]);if(Object.keys(g).length)return g},r=[{}],i={},n=[],s=JSON.stringify({});for(let p=0;p<this.cell_style.length;p++){let b=this.cell_style[p];if(b){n[p]=[];for(let g=0;g<b.length;g++)if(b[g]){let D=JSON.stringify(b[g]);if(D!==s){let I=i[D];typeof I!="number"&&(i[D]=I=r.length,r.push(b[g])),n[p][g]=I}}}}let a=p=>{let b=JSON.stringify(p);if(b===s)return 0;let g=i[b];return typeof g!="number"&&(i[b]=g=r.length,r.push(p)),g};r=JSON.parse(JSON.stringify(r));let l=JSON.parse(JSON.stringify(this.sheet_style)),u=JSON.parse(JSON.stringify(this.row_pattern)),c={},h={};for(let p of Object.keys(this.column_styles)){let b=Number(p),g=this.column_styles[b];if(g){let D=a(g);D&&(c[b]=D)}}if(this.row_pattern&&this.row_pattern.length&&e.apply_row_pattern){let p=this.rows+1;for(let b of Object.keys(this.row_styles)){let g=Number(b);!isNaN(g)&&g>=p&&(p=g+1)}for(let b=0;b<p;b++){let g=this.row_pattern[b%this.row_pattern.length],D=this.row_styles[b]||{},I=P.Composite([g,D]),U=a(I);U&&(h[b]=U)}}else for(let p of Object.keys(this.row_styles)){let b=Number(p),g=this.row_styles[b];if(g){let D=a(g);D&&(h[b]=D)}}let f=(p={},b={})=>{let g={...b,...p};if(ie(g))return g.text=ye.MeasureColorARGB(g.text),g;if(Lr(g))return g};if(e.export_colors){let p=[];for(let b of[r,[l],u])if(Array.isArray(b))for(let g of b)p.push(g);else for(let g of Object.keys(b))p.push(b[g]);for(let b of p){let g=f(b.border_top_fill,P.DefaultProperties.border_top_fill);g!==void 0&&(b.border_top_fill=g),g=f(b.border_left_fill,P.DefaultProperties.border_left_fill),g!==void 0&&(b.border_left_fill=g),g=f(b.border_right_fill,P.DefaultProperties.border_right_fill),g!==void 0&&(b.border_right_fill=g),g=f(b.border_bottom_fill,P.DefaultProperties.border_bottom_fill),g!==void 0&&(b.border_bottom_fill=g),ie(b.fill)&&(b.fill.text=ye.MeasureColorARGB(b.fill.text)),ie(b.text)&&(b.text.text=ye.MeasureColorARGB(b.text.text))}}let d={calculated_value:!!e.rendered_values,preserve_type:!!e.preserve_type,expand_arrays:!!e.expand_arrays,decorated_cells:!!e.decorated_cells,nested:!0,cell_style_refs:n,tables:!!e.tables},m=this.cells.toJSON(d),_=m.data,{rows:y,columns:v}=m;e.shrink?(y+=2,v+=1):(y=this.rows,v=this.columns);for(let p of this.annotations)p.data.extent||this.CalculateAnnotationExtent(p),p.data.extent&&(y=Math.max(y,p.data.extent.row+1),v=Math.max(v,p.data.extent.column+1));let w=this.CompressCellStyles(n),x=this.conditional_formats.length?JSON.parse(JSON.stringify(this.conditional_formats.map(p=>({...p,internal:void 0})))):void 0,C=this.data_validation.length?JSON.parse(JSON.stringify(this.data_validation)):void 0,A={};for(let[p,b]of this.row_height_map.entries())A[p]=b;let S={id:this.id,name:this.name,tab_color:this.tab_color,data:_,sheet_style:l,rows:y,columns:v,cell_styles:w,styles:r,row_style:h,column_style:c,conditional_formats:x,data_validations:C,row_pattern:u.length?u:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:A,column_width:t(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(S.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(S.scroll=this.scroll_offset),this.background_image&&(S.background_image=this.background_image),(this.freeze.rows||this.freeze.columns)&&(S.freeze=this.freeze),S}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(e){let t=e.styles;e.outline&&(this.outline=e.outline);let r=e.sheet_style;r&&this.UpdateAreaStyle(new M({row:1/0,column:1/0},{row:1/0,column:1/0}),t[r]);let i=e.column_styles;if(i)for(let s=0;s<i.length;s++)i[s]&&this.UpdateAreaStyle(new M({row:1/0,column:s},{row:1/0,column:s}),t[i[s]]);if(e.row_styles)for(let[s,a]of e.row_styles.entries())a&&this.UpdateAreaStyle(new M({row:s,column:1/0}),t[a]);this.cells.FromJSON(e.cells),e.name&&(this.name=e.name||""),e.tab_color&&(this.tab_color=e.tab_color);let n=this.cell_style;for(let s of e.cells)s.style_ref&&(n[s.column]||(n[s.column]=[]),n[s.column][s.row]=t[s.style_ref]);for(let s=0;s<e.column_widths.length;s++)typeof e.column_widths[s]<"u"&&this.SetColumnWidth(s,e.column_widths[s]);for(let s=0;s<e.row_heights.length;s++)typeof e.row_heights[s]<"u"&&this.SetRowHeight(s,e.row_heights[s]);for(let s of e.annotations||[])this.annotations.push(new qe(s));for(let s of e.conditional_formats||[])this.conditional_formats.push(s);for(let s of e.data_validations||[])this.AddValidation(s);e.hidden&&(this.visible=!1)}CalculateAnnotationExtent(e){if(e.data.layout){e.data.extent={...e.data.layout.br.address};return}let t=1e3;e.data.extent={row:0,column:0};let r=e.rect?.right;if(r&&this.default_column_width){for(let n=0;r>=0&&n<t;n++)if(r-=this.GetColumnWidth(n),r<0){e.data.extent.column=n;break}}let i=e.rect?.bottom;if(i&&this.default_row_height){for(let n=0;i>=0&&n<t;n++)if(i-=this.GetRowHeight(n),i<0){e.data.extent.row=n;break}}}UpdateSheetStyle(e,t=!0){this.sheet_style=P.Merge(this.sheet_style,e,t);let r=Object.keys(e);for(let i of this.cell_style)if(i)for(let n of i)n&&r.forEach(s=>delete n[s]);for(let i of Object.keys(this.row_styles))r.forEach(n=>delete this.row_styles[i][n]);for(let i of Object.keys(this.column_styles))r.forEach(n=>delete this.column_styles[i][n]);this.FlushCellStyles()}UpdateRowStyle(e,t,r=!0){this.row_styles[e]=P.Merge(this.row_styles[e]||{},t,r);let i=Object.keys(t);for(let n of this.cell_style)n&&n[e]&&i.forEach(s=>delete n[e][s]);for(let n=0;n<this.cells.columns;n++)if(this.column_styles[n]){let s=this.column_styles[n],a=this.cell_style[n]?this.cell_style[n][e]||{}:{};for(let l of i)typeof s[l]<"u"&&(a[l]=t[l]);Object.keys(a).length&&(this.cell_style[n]||(this.cell_style[n]=[]),this.cell_style[n][e]=JSON.parse(JSON.stringify(a)))}for(let n of this.cells.Iterate(this.RealArea(M.FromRow(e))))n.FlushStyle()}UpdateColumnStyle(e,t,r=!0){this.column_styles[e]=P.Merge(this.column_styles[e]||{},t,r);let i=Object.keys(t);if(this.cell_style[e])for(let n of this.cell_style[e])n&&i.forEach(s=>delete n[s]);for(let n of this.cells.Iterate(this.RealArea(M.FromColumn(e))))n.FlushStyle()}BleedFlush(e){let t=[Math.max(0,e.start.row-1),e.end.row+1],r=[Math.max(0,e.start.column-1),e.end.column+1];for(let i=t[0];i<=t[1];i++)for(let n=r[0];n<=r[1];n++)this.cells.GetCell({row:i,column:n},!1)?.FlushStyle()}FlushConditionalFormats(){this.flush_conditional_formats=!0}ApplyConditionalFormats(){let e=this.flush_conditional_formats;for(let i of this.conditional_formats)if(i.internal?.vertex?.updated){e=!0;break}if(!e)return;this.flush_conditional_formats=!1;let t=[],r=[...this.conditional_format_checklist];this.conditional_format_checklist=[];for(let i of this.conditional_formats){i.internal?.vertex?.updated&&(i.internal.vertex.updated=!1);let n=JSON.parse(JSON.stringify(i.area));(n.start.row===null||n.end.row===null)&&(n.start.row=0,n.end.row=this.cells.rows-1),(n.start.column===null||n.end.column===null)&&(n.start.column=0,n.end.column=this.cells.columns-1);let s=i.internal?.vertex?.result;if(i.type==="gradient"){if(s&&i.internal?.gradient){let a=i.property??"fill";if(s.type===8)for(let l=n.start.row;l<=n.end.row;l++)for(let u=n.start.column;u<=n.end.column;u++){let c=s.value[u-n.start.column][l-n.start.row];if(c.type===3){t[l]||(t[l]=[]),t[l][u]||(t[l][u]=[]);let h=i.internal.gradient.Interpolate(c.value);t[l][u].push({[a]:h})}}else if(s.type===3){let l=i.internal.gradient.Interpolate(s.value);for(let u=n.start.row;u<=n.end.row;u++){t[u]||(t[u]=[]);for(let c=n.start.column;c<=n.end.column;c++)t[u][c]||(t[u][c]=[]),t[u][c].push({[a]:l})}}r.push(n),this.conditional_format_checklist.push(n)}}else if(s){if(s.type===8)for(let a=n.start.row;a<=n.end.row;a++)for(let l=n.start.column;l<=n.end.column;l++){let u=s.value[l-n.start.column][a-n.start.row];u&&(u.type===4||u.type===3)&&u.value&&(t[a]||(t[a]=[]),t[a][l]||(t[a][l]=[]),t[a][l].push(i.style))}else if((s.type===4||s.type===3)&&s.value)for(let a=n.start.row;a<=n.end.row;a++){t[a]||(t[a]=[]);for(let l=n.start.column;l<=n.end.column;l++)t[a][l]||(t[a][l]=[]),t[a][l].push(i.style)}r.push(n),this.conditional_format_checklist.push(n)}}for(let i of r)this.BleedFlush(i);this.conditional_format_cache=t}ConditionalFormatForCell(e){return this.conditional_format_cache[e.row]?this.conditional_format_cache[e.row][e.column]||[]:[]}CompositeStyleForCell(e,t=!0,r=!0,i=!0,n=!0){let{row:s,column:a}=e,l=[];return i&&l.push(this.default_style_properties),l.push(this.sheet_style),r&&this.row_pattern.length&&l.push(this.row_pattern[s%this.row_pattern.length]),this.row_styles[s]&&l.push(this.row_styles[s]),this.column_styles[a]&&l.push(this.column_styles[a]),t&&this.cell_style[a]&&this.cell_style[a][s]&&l.push(this.cell_style[a][s]),n&&l.push(...this.ConditionalFormatForCell(e)),P.Composite(l)}GetStyleIndex(e){let t=JSON.stringify(e);for(let i=0;i<this.style_json_map.length;i++)if(t===this.style_json_map[i])return i;let r=this.style_map.length;return this.style_map.push(JSON.parse(t)),this.style_json_map.push(t),r}};var Qt={};Is(Qt,{Iterate:()=>Eo});function*Eo(o){if(o.start.row===1/0||o.end.row===1/0)throw new Error("don\'t iterate infinite area");let e=o.start.sheet_id;for(let t=o.start.row;t<=o.end.row;t++)for(let r=o.start.column;r<=o.end.column;r++)yield{row:t,column:r,sheet_id:e}}var ti=class{constructor(e=0){this.m_w=0,this.m_z=0,this.Seed(e)}Seed(e=0){e?(this.m_w=Math.round(e&2863311530)||1,this.m_z=Math.round(e&1431655765)||1):(this.m_w=Math.round(Math.random()*1e5),this.m_z=Math.round(new Date().getTime()))}Next(){this.m_z=36969*(this.m_z&65535)+(this.m_z>>16)&4294967295,this.m_w=18e3*(this.m_w&65535)+(this.m_w>>16)&4294967295;let e=(this.m_z<<16)+this.m_w&4294967295;return e/=4294967296,e+.5}GetState(){return[this.m_w,this.m_z]}},B=new ti;var Ve=class{static Sort(e,t){this.QuickSort(e,t,0,e.length)}static Partition(e,t,r,i){let n=e[i-1],s=r;for(let a=r;a<i-1;a+=1)e[a]<=n&&(this.Swap(e,t,a,s),s+=1);return this.Swap(e,t,s,i-1),s}static Swap(e,t,r,i){let n=e[r];e[r]=e[i],e[i]=n,n=t[r],t[r]=t[i],t[i]=n}static QuickSort(e,t,r,i){if(r<i){let n=this.Partition(e,t,r,i);this.QuickSort(e,t,r,n),this.QuickSort(e,t,n+1,i)}}};var Ce=class{static Sort(e){return this.QuickSort(e,0,e.length-1),e}static Swap(e,t,r){let i=e[t];e[t]=e[r],e[r]=i}static Partition(e,t,r){let i=e[Math.floor((r+t)/2)];for(;t<=r;){for(;e[t]<i;)t++;for(;e[r]>i;)r--;t<=r&&(this.Swap(e,t,r),t++,r--)}return t}static QuickSort(e,t,r){var i;return e.length>1&&(i=this.Partition(e,t,r),t<i-1&&this.QuickSort(e,t,i-1),i<r&&this.QuickSort(e,i,r)),e}};var To={min:0,max:0,range:0,median:0,mean:0,N:0,variance:0,stdev:0,skewness:0,kurtosis:0,stderr:0,percentiles:{0:0,5:0,10:0,15:0,20:0,25:0,30:0,35:0,40:0,45:0,50:0,55:0,60:0,65:0,70:0,75:0,80:0,85:0,90:0,95:0,100:0},zero:0,discrete:!0,mode:0},H=class{static Correlation(e,t){let r=0,i=0,n=0,s=0,a=0,l=0;for(let u=0;u<e.length;u++)i+=e[u]*t[u],n+=e[u],s+=t[u],a+=e[u]*e[u],l+=t[u]*t[u];return r=e.length*i-n*s,r&&(r/=Math.sqrt((e.length*a-n*n)*(e.length*l-s*s))),r}static TickRange(e,t,r=!1){let i=e/(t-1),n=Math.ceil(this.Log10(i)-1),s=Math.pow(10,n);return Math.ceil(i/s)*s}static Log10(e){return Math.log(e)/Math.LN10}static Log2(e){return Math.log(e)/Math.LN2}static Percentiles(e,t){let r=Ce.Sort(e.slice(0)),i=r.length,n=new Array(101);for(let s=0;s<100;s++)n[s]=r[Math.round(i*s/100)];return n[100]=r[i-1],n}static Percentile(e,t){let r=Ce.Sort(e.slice(0)),i=r.length,n=Math.max(0,Math.min(i-1,Math.round(i*t)));return r[n]}static Interval(e){let t=0;if(!e.data||!e.data.length)return 0;if(typeof e.min>"u"){if(typeof e.max>"u")return 1;for(let r of e.data)r<=e.max&&t++}else if(typeof e.max>"u")for(let r of e.data)r>=e.min&&t++;else for(let r of e.data)r>=e.min&&r<=e.max&&t++;return t/e.data.length}static R22(e,t){let r=[!0,!0];for(let i=0;i<e.length&&!(e[i]!==e[0]&&(r[0]=!1,!r[1])||t[i]!==t[0]&&(r[1]=!1,!r[0]));i++);return r[0]||r[1]?{error:!0}:{r2:this.R2(e,t),error:!1}}static R2(e,t){let r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0;for(let h=0;h<e.length;h++)i=t[h],n=e[h],s+=i*n,a+=i,l+=n,u+=i*i,c+=n*n;return r=e.length*s-a*l,r&&(r/=Math.sqrt((e.length*u-a*a)*(e.length*c-l*l))),r=r*r,r}static ToSD(e,t=2){if(t=t||2,e===0)return e;let r=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/r)*r}static Statistics(e,t=!1){let r=this.Range(e),i=e.length;if(i===0)return JSON.parse(JSON.stringify(To));let n=!0,s=0,a=0,l=0,u=0,c=t?e:Ce.Sort(e.slice(0)),h=0;i%2?h=e[Math.floor(i/2)]:h=(e[i/2]+e[i/2-1])/2;for(let S=0;S<i;S++)s+=e[S];s/=i;let f=s;for(let S=0;S<i;S++){let p=e[S]-s;a+=p*p,u+=p*p*p,l+=p*p*p*p,n&&e[S]%1&&(n=!1)}let d;if(n){let S=[];for(let b=0;b<e.length;b++)S[e[b]]=(S[e[b]]||0)+1;let p=[];for(let b=0;b<S.length;b++)S[b]&&p.push([b,S[b]]);p.length||(d=0),p.sort((b,g)=>g[1]-b[1]),d=p[0][0]}let m=i,_=a/i,y=Math.sqrt(a/i),v=u/((i-1)*Math.pow(y,3)),w=l/((i-1)*Math.pow(y,4)),x=Math.sqrt(a/i)/Math.sqrt(i),C={};for(let S=5;S<100;S+=5)C[S]=c[Math.round(i*S/100)];C[0]=c[0],C[100]=c[i-1];let A=this.Interval({data:e,max:0});return Object.assign(Object.assign({},r),{median:h,mean:f,N:m,variance:_,stdev:y,skewness:v,kurtosis:w,stderr:x,percentiles:C,zero:A,discrete:n,mode:d})}static Truncate(e,t,r){let i=Ce.Sort(e.slice(0));return i.slice(Math.round(i.length*t/100),Math.round(i.length*r/100))}static Histogram(e,t="sturges"){let r=!0;for(let a=0;r&&a<e.length;a++)r=r&&e[a]===Math.round(e[a]);let i=this.Range(e);if(typeof t=="string"||!t)if(t==="fd"){let a=this.FD(e);a===0||i.range===0?t=1:t=Math.round(i.range/a+1)}else t=this.Sturges(e);let n=[],s=[];if(r&&t>i.range){t=i.range+1;for(let a=0;a<t;a++)n[a]=0,s[a]=i.min+a;for(let a of e)n[a-i.min]++}else{let a=this.TickRange(i.range,t),l=this.FirstBin(i.max,i.min,t,a),u=Math.ceil(this.Log10(a)-1);for(let h=0;h<t;h++)n[h]=0,s[h]=(l+h*a).toFixed(Math.max(0,-u));let c=l-a;for(let h of e)n[Math.floor((h-c)/a)]++}return{bins:n,labels:s}}static Sturges(e){return Math.ceil(this.Log2(e.length)+1)}static IQR(e){let t=this.Quantiles(e,[.25,.75]);return t[1]-t[0]}static Quantiles(e,t=[0,.25,.5,.75,1]){let r=Ce.Sort(e.slice(0));return t.map(i=>r[Math.floor((r.length-1)*i)])}static FD(e){return 2*this.IQR(e)*Math.pow(e.length,-1/3)}static FirstBin(e,t,r,i){let n=(Math.floor(t/i)+1)*i,s=n+(r-2)*i,a=Math.floor((n+(r-1)*i-e)/i);return a>=2?n-a/2*i:n}static Range(e){let t=e.length,r=t>0?e[0]:0,i=t>0?e[0]:0;for(let n=1;n<t;n++)e[n]>i&&(i=e[n]),e[n]<r&&(r=e[n]);return{min:r,max:i,range:i-r}}};H.EPSILON_DOUBLE=2220446049250313e-31;H.QUIET_NAN=Number.NaN;H.s_undefined="undefined";H.s_object="object";H.s_number="number";var Id=Math.pow(2,-52),De=class o{constructor(){this.rows=0,this.columns=0,this.data=[]}static Zero(e,t=e){return new o().Reset(e,t)}static Identity(e){let t=this.Zero(e,e);for(let r=0;r<e;r++)t.data[r][r]=1;return t}static Clone(e){let t=new o;t.rows=e.rows,t.columns=e.columns;for(let r of e.data)t.data.push(new Float64Array(r));return t}static FromArray(e,t=!1){let r=e[0].length,i=e.length;if(t){let n=this.Zero(r,i);for(let s=0;s<i;s++)for(let a=0;a<r;a++)n.data[s][a]=e[s][a];return n}else{let n=this.Zero(i,r);for(let s=0;s<i;s++)for(let a=0;a<r;a++)n.data[a][s]=e[s][a]||0;return n}}Reset(e,t){this.data=new Array(t);for(let r=0;r<t;r++)this.data[r]=new Float64Array(e);return this.rows=e,this.columns=t,this}CopyTo(e){e.rows=this.rows,e.columns=this.columns,e.data=new Array(this.columns);for(let t of this.data)e.data.push(new Float64Array(t));return e}GetColumn(e){return this.data[e]}SetColumn(e,t){this.data[e]=new Float64Array(t)}Transpose(){let e=o.Zero(this.columns,this.rows);for(let t=0;t<this.columns;t++)for(let r=0;r<this.rows;r++)e.data[t][r]=this.data[r][t];return e}Symmetrize(e=!1){let t=this.Transpose(),r=o.Clone(this);if(e)for(let i=1;i<this.columns;i++)for(let n=0;n<i;n++)r.data[n][i]=t.data[n][i];else for(let i=1;i<this.rows;i++)for(let n=0;n<i;n++)r.data[i][n]=t.data[i][n];return r}Cholesky(e=!1){if(this.rows!==this.columns)throw new Error("matrix not square");let t=this.rows,r=o.Zero(t);for(let i=0;i<t;i++){let n=0;for(let s=0;s<i;s++){let a=0;for(let l=0;l<s;l++)a+=r.data[s][l]*r.data[i][l];if(r.data[i][s]=a=(this.data[i][s]-a)/r.data[s][s],n=n+a*a,this.data[s][i]!==this.data[i][s])throw new Error("matrix not symmetrical")}if(n=this.data[i][i]-n,n<=0)throw new Error(`matrix not pos-def (${n})`);r.data[i][i]=n>0?Math.sqrt(n):0;for(let s=i+1;s<t;s++)r.data[i][s]=0}return e?r.Transpose():r}Multiply(e){let t=0,r=0,i=o.Zero(this.rows,e.columns);for(let n=0;n<this.rows;n++)for(let s=0;s<e.columns;s++){for(r=t=0;t<this.columns;t++)r+=this.data[t][n]*e.data[s][t];i.data[s][n]=r}return i}Inverse(){if(this.rows!==this.columns)throw new Error("invalid matrix");let e=o.Clone(this),t=0,r=e.rows;for(let i=1;i<r;i++)e.data[i][0]/=e.data[0][0];for(let i=1;i<r;i++){for(let n=i;n<r;n++){t=0;for(let s=0;s<i;s++)t+=e.data[s][n]*e.data[i][s];e.data[i][n]-=t}if(i!==r-1)for(let n=i+1;n<r;n++){t=0;for(let s=0;s<i;s++)t+=e.data[s][i]*e.data[n][s];e.data[n][i]=(e.data[n][i]-t)/e.data[i][i]}}for(let i=0;i<r;i++)for(let n=i;n<r;n++){let s=1;if(i!==n){s=0;for(let a=i;a<n;a++)s-=e.data[a][n]*e.data[i][a]}e.data[i][n]=s/e.data[n][n]}for(let i=0;i<r;i++)for(let n=i;n<r;n++)if(i!==n){t=0;for(let s=i;s<n;s++)t+=e.data[n][s]*(i===s?1:e.data[s][i]);e.data[n][i]=-t}for(let i=0;i<r;i++)for(let n=0;n<r;n++){t=0;for(let s=i>n?i:n;s<r;s++)t+=(n===s?1:e.data[s][n])*e.data[i][s];e.data[i][n]=t}return e}SortColumns(e=!1){let t=o.Clone(this),r=e?(i,n)=>n-i:(i,n)=>i-n;for(let i of t.data)i.sort(r);return t}Rank(e=!1){let t=o.Clone(this),r=new Int32Array(this.rows);for(let i=0;i<this.rows;i++)r[i]=i;for(let i=0;i<this.columns;i++){let n=new Int32Array(r);Ve.Sort(t.data[i],n),e&&n.reverse();for(let s=0;s<this.rows;s++)t.data[i][n[s]]=s}return t}Rank2(e=!1,t){let r=o.Zero(this.rows,this.columns),i=new Int32Array(this.rows);for(let n=0;n<this.rows;n++)i[n]=n;for(let n=0;n<this.columns;n++){let s=new Int32Array(i);Ve.Sort(this.data[n],s),e&&s.reverse();for(let a=0;a<this.rows;a++)r.data[n][s[a]]=t.data[n][a]}return r}Correl(){let e=o.Zero(this.columns,this.columns);for(let t=0;t<this.columns;t++){e.data[t][t]=1;for(let r=0;r<t;r++)e.data[r][t]=H.Correlation(this.data[t],this.data[r])}return e.Symmetrize()}IsSymmetric(){if(this.rows!==this.columns)return!1;for(let e=0;e<this.columns;e++)for(let t=0;t<this.rows;t++)if(this.data[e][t]!==this.data[t][e])return!1;return!0}toString(e){let t="";e=e||2;for(let r=0;r<this.rows;r++){for(let i=0;i<this.columns;i++){let n=this.data[i][r];n>=0&&(t+=" "),t+=n.toFixed(e),t+=" "}t+=`\n`}return t}};Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});var $e=class{static Guid(){let e="";for(let t=0;t<8;t++)e+=Math.round(Math.random()*256).toString(16);return e}static Log10(e){return Math.log(e)/Math.LN10}static ToSD(e,t=2){if(t=t||2,e===0)return e;let r=e<0?-1:1;e*=r;let i=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/i)*i*r}static ToSDCeil(e,t=2){if(t=t||2,e===0)return e;let r=e<0?-1:1;e*=r;let i=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.ceil(e/i)*i*r}static SuggestDecimals(e){if(typeof e!="number"){let r=e[0],i=e[0];for(let n of e)r=Math.min(r,n),i=Math.max(i,n);e=i-r}let t=Math.ceil(this.Log10(e));return console.log(t),t<=0?1-t:1}static YearFraction(e){let t=new Date(e.getTime());return t.setMonth(11,31),(t.getTime()-e.getTime())/this.MILLIS_YEAR}};$e.DEFAULT_NUMBER_FORMAT="(0,0.00)";$e.DEFAULT_PCT_FORMAT="0.00";$e.DEFAULT_CURRENCY_FORMAT="(0,0)";$e.MILLIS_YEAR=1e3*60*60*24*365.25;var Je=class{constructor(e){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];let t=e.length;this.order=t,this.vectors=[];let r=!0;for(let i=0;r&&i<t;i++){if(e[i].length!==t)throw new Error("not square");for(let n=0;n<t;n++)e[i][n]!==e[n][i]&&(r=!1)}if(r){for(let i=0;i<t;i++)Array.isArray(e[i])?this.vectors.push(e[i].slice(0)):this.vectors.push(Array.from(e[i]));this.tred2(),this.tql2()}else{let i=[],n=[];for(let s=0;s<t;s++){Array.isArray(e[s])?i.push(e[s].slice(0)):i.push(Array.from(e[s])),this.vectors.push([]);for(let a=0;a<t;a++)this.vectors[s][a]=0;n.push(0)}this.orthes(i,n),this.hqr2(i,n)}}GetDiagonal(){let e=[];for(let t=0;t<this.order;t++){e.push([]);for(let r=0;r<this.order;r++)e[t][r]=0;e[t][t]=this.realvalues[t],this.ivalues[t]>0?e[t][t+1]=this.ivalues[t]:this.ivalues[t]<0&&(e[t][t-1]=this.ivalues[t])}return e}tred2(){let e=0,t=0,r=0,i=0,n=0,s=this.order,a=this.vectors,l=this.realvalues,u=this.ivalues;for(let c=0;c<s;c++)l[c]=a[s-1][c];for(let c=s-1;c>0;c--){r=0,i=0;for(let h=0;h<c;h++)r=r+Math.abs(l[h]);if(r===0){u[c]=l[c-1];for(let h=0;h<c;h++)l[h]=a[c-1][h],a[c][h]=0,a[h][c]=0}else{for(let h=0;h<c;h++)l[h]/=r,i+=l[h]*l[h];e=l[c-1],t=Math.sqrt(i),e>0&&(t=-t),u[c]=r*t,i=i-e*t,l[c-1]=e-t;for(let h=0;h<c;h++)u[h]=0;for(let h=0;h<c;h++){e=l[h],a[h][c]=e;let f=u[h]+a[h][h]*e;for(let d=h+1;d<=c-1;d++)f+=a[d][h]*l[d],u[d]+=a[d][h]*e;u[h]=f}e=0;for(let h=0;h<c;h++)u[h]/=i,e+=u[h]*l[h];n=e/(i+i);for(let h=0;h<c;h++)u[h]-=n*l[h];for(let h=0;h<c;h++){e=l[h],t=u[h];for(let f=h;f<=c-1;f++)a[f][h]-=e*u[f]+t*l[f];l[h]=a[c-1][h],a[c][h]=0}}l[c]=i}for(let c=0;c<s-1;c++){if(a[s-1][c]=a[c][c],a[c][c]=1,i=l[c+1],i!==0){for(let h=0;h<=c;h++)l[h]=a[h][c+1]/i;for(let h=0;h<=c;h++){t=0;for(let f=0;f<=c;f++)t+=a[f][c+1]*a[f][h];for(let f=0;f<=c;f++)a[f][h]-=t*l[f]}}for(let h=0;h<=c;h++)a[h][c+1]=0}for(let c=0;c<s;c++)l[c]=a[s-1][c],a[s-1][c]=0;a[s-1][s-1]=1,u[0]=0}tql2(){let e,t,r,i,n,s,a,l,u,c,h,f,d,m,_,y,v,w,x,C,A=this.order,S=this.vectors,p=this.realvalues,b=this.ivalues;for(e=1;e<A;e++)b[e-1]=b[e];for(b[A-1]=0,a=0,l=0,u=Math.pow(2,-52),t=0;t<A;t++){for(l=Math.max(l,Math.abs(p[t])+Math.abs(b[t])),s=t;s<A&&!(Math.abs(b[s])<=u*l);)s++;if(s>t){c=0;do{for(c=c+1,h=p[t],i=(p[t+1]-h)/(2*b[t]),f=Math.hypot(i,1),i<0&&(f=-f),p[t]=b[t]/(i+f),p[t+1]=b[t]*(i+f),d=p[t+1],m=h-p[t],e=t+2;e<A;e++)p[e]-=m;for(a=a+m,i=p[s],_=1,y=_,v=_,w=b[t+1],x=0,C=0,e=s-1;e>=t;e--)for(v=y,y=_,C=x,h=_*b[e],m=_*i,f=Math.hypot(i,b[e]),b[e+1]=x*f,x=b[e]/f,_=i/f,i=_*p[e]-x*h,p[e+1]=m+x*(_*h+x*p[e]),r=0;r<A;r++)m=S[r][e+1],S[r][e+1]=x*S[r][e]+_*m,S[r][e]=_*S[r][e]-x*m;i=-x*C*v*w*b[t]/d,b[t]=x*i,p[t]=_*i}while(Math.abs(b[t])>u*l)}p[t]=p[t]+a,b[t]=0}for(e=0;e<A-1;e++){for(r=e,i=p[e],n=e+1;n<A;n++)p[n]<i&&(r=n,i=p[n]);if(r!==e)for(p[r]=p[e],p[e]=i,n=0;n<A;n++)i=S[n][e],S[n][e]=S[n][r],S[n][r]=i}}orthes(e,t){let r=this.order,i=this.vectors,n=this.realvalues,s=this.ivalues,a=0,l=r-1,u,c,h,f,d,m,_;for(m=a+1;m<=l-1;m++){for(_=0,f=m;f<=l;f++)_=_+Math.abs(e[f][m-1]);if(_!==0){for(h=0,f=l;f>=m;f--)t[f]=e[f][m-1]/_,h+=t[f]*t[f];for(c=Math.sqrt(h),t[m]>0&&(c=-c),h=h-t[m]*c,t[m]=t[m]-c,d=m;d<r;d++){for(u=0,f=l;f>=m;f--)u+=t[f]*e[f][d];for(u=u/h,f=m;f<=l;f++)e[f][d]-=u*t[f]}for(f=0;f<=l;f++){for(u=0,d=l;d>=m;d--)u+=t[d]*e[f][d];for(u=u/h,d=m;d<=l;d++)e[f][d]-=u*t[d]}t[m]=_*t[m],e[m][m-1]=_*c}}for(f=0;f<r;f++)for(d=0;d<r;d++)i[f][d]=f===d?1:0;for(m=l-1;m>=a+1;m--)if(e[m][m-1]!==0){for(f=m+1;f<=l;f++)t[f]=e[f][m-1];for(d=m;d<=l;d++){for(c=0,f=m;f<=l;f++)c+=t[f]*i[f][d];for(c=c/t[m]/e[m][m-1],f=m;f<=l;f++)i[f][d]+=c*t[f]}}}cdiv(e,t,r,i){let n=0,s=0;return Math.abs(r)>Math.abs(i)?(n=i/r,s=r+n*i,{r:(e+n*t)/s,i:(t-n*e)/s}):(n=r/i,s=i+n*r,{r:(n*e+t)/s,i:(n*t-e)/s})}hqr2(e,t){let r=this.order,i=this.vectors,n=this.realvalues,s=this.ivalues,a=r,l=a-1,u=0,c=a-1,h=Math.pow(2,-52),f=0,d=0,m=0,_=0,y=0,v=0,w,x,C,A,S,p,b,g,D,I,U,O=0;for(p=0;p<a;p++)for((p<u||p>c)&&(n[p]=e[p][p],s[p]=0),b=Math.max(p-1,0);b<a;b++)O=O+Math.abs(e[p][b]);for(D=0;l>=u;){for(I=l;I>u&&(y=Math.abs(e[I-1][I-1])+Math.abs(e[I][I]),y===0&&(y=O),!(Math.abs(e[I][I-1])<h*y));)I--;if(I===l)e[l][l]=e[l][l]+f,n[l]=e[l][l],s[l]=0,l--,D=0;else if(I===l-1){if(x=e[l][l-1]*e[l-1][l],d=(e[l-1][l-1]-e[l][l])/2,m=d*d+x,v=Math.sqrt(Math.abs(m)),e[l][l]=e[l][l]+f,e[l-1][l-1]=e[l-1][l-1]+f,C=e[l][l],m>=0){for(d>=0?v=d+v:v=d-v,n[l-1]=C+v,n[l]=n[l-1],v!==0&&(n[l]=C-x/v),s[l-1]=0,s[l]=0,C=e[l][l-1],y=Math.abs(C)+Math.abs(v),d=C/y,m=v/y,_=Math.sqrt(d*d+m*m),d=d/_,m=m/_,b=l-1;b<a;b++)v=e[l-1][b],e[l-1][b]=m*v+d*e[l][b],e[l][b]=m*e[l][b]-d*v;for(p=0;p<=l;p++)v=e[p][l-1],e[p][l-1]=m*v+d*e[p][l],e[p][l]=m*e[p][l]-d*v;for(p=u;p<=c;p++)v=i[p][l-1],i[p][l-1]=m*v+d*i[p][l],i[p][l]=m*i[p][l]-d*v}else n[l-1]=C+d,n[l]=C+d,s[l-1]=v,s[l]=-v;l=l-2,D=0}else{if(C=e[l][l],A=0,x=0,I<l&&(A=e[l-1][l-1],x=e[l][l-1]*e[l-1][l]),D===10){for(f+=C,p=u;p<=l;p++)e[p][p]-=C;y=Math.abs(e[l][l-1])+Math.abs(e[l-1][l-2]),C=A=.75*y,x=-.4375*y*y}if(D===30&&(y=(A-C)/2,y=y*y+x,y>0)){for(y=Math.sqrt(y),A<C&&(y=-y),y=C-x/((A-C)/2+y),p=u;p<=l;p++)e[p][p]-=y;f+=y,C=A=x=.964}for(D=D+1,U=l-2;U>=I&&(v=e[U][U],_=C-v,y=A-v,d=(_*y-x)/e[U+1][U]+e[U][U+1],m=e[U+1][U+1]-v-_-y,_=e[U+2][U+1],y=Math.abs(d)+Math.abs(m)+Math.abs(_),d=d/y,m=m/y,_=_/y,!(U===I||Math.abs(e[U][U-1])*(Math.abs(m)+Math.abs(_))<h*(Math.abs(d)*(Math.abs(e[U-1][U-1])+Math.abs(v)+Math.abs(e[U+1][U+1])))));)U--;for(p=U+2;p<=l;p++)e[p][p-2]=0,p>U+2&&(e[p][p-3]=0);for(g=U;g<=l-1;g++){let j=g!==l-1;if(g!==U&&(d=e[g][g-1],m=e[g+1][g-1],_=j?e[g+2][g-1]:0,C=Math.abs(d)+Math.abs(m)+Math.abs(_),C!==0&&(d=d/C,m=m/C,_=_/C)),C===0)break;if(y=Math.sqrt(d*d+m*m+_*_),d<0&&(y=-y),y!==0){for(g!==U?e[g][g-1]=-y*C:I!==U&&(e[g][g-1]=-e[g][g-1]),d=d+y,C=d/y,A=m/y,v=_/y,m=m/d,_=_/d,b=g;b<a;b++)d=e[g][b]+m*e[g+1][b],j&&(d=d+_*e[g+2][b],e[g+2][b]=e[g+2][b]-d*v),e[g][b]=e[g][b]-d*C,e[g+1][b]=e[g+1][b]-d*A;for(p=0;p<=Math.min(l,g+3);p++)d=C*e[p][g]+A*e[p][g+1],j&&(d=d+v*e[p][g+2],e[p][g+2]=e[p][g+2]-d*_),e[p][g]=e[p][g]-d,e[p][g+1]=e[p][g+1]-d*m;for(p=u;p<=c;p++)d=C*i[p][g]+A*i[p][g+1],j&&(d=d+v*i[p][g+2],i[p][g+2]=i[p][g+2]-d*_),i[p][g]=i[p][g]-d,i[p][g+1]=i[p][g+1]-d*m}}}}if(O!==0){for(l=a-1;l>=0;l--)if(d=n[l],m=s[l],m===0)for(I=l,e[l][l]=1,p=l-1;p>=0;p--){for(x=e[p][p]-d,_=0,b=I;b<=l;b++)_=_+e[p][b]*e[b][l];if(s[p]<0)v=x,y=_;else if(I=p,s[p]===0?x!==0?e[p][l]=-_/x:e[p][l]=-_/(h*O):(C=e[p][p+1],A=e[p+1][p],m=(n[p]-d)*(n[p]-d)+s[p]*s[p],w=(C*y-v*_)/m,e[p][l]=w,Math.abs(C)>Math.abs(v)?e[p+1][l]=(-_-x*w)/C:e[p+1][l]=(-y-A*w)/v),w=Math.abs(e[p][l]),h*w*w>1)for(b=p;b<=l;b++)e[b][l]=e[b][l]/w}else if(m<0)for(I=l-1,Math.abs(e[l][l-1])>Math.abs(e[l-1][l])?(e[l-1][l-1]=m/e[l][l-1],e[l-1][l]=-(e[l][l]-d)/e[l][l-1]):(S=this.cdiv(0,-e[l-1][l],e[l-1][l-1]-d,m),e[l-1][l-1]=S.r,e[l-1][l]=S.i),e[l][l-1]=0,e[l][l]=1,p=l-2;p>=0;p--){let j,te,fe,T;for(j=0,te=0,b=I;b<=l;b++)j=j+e[p][b]*e[b][l-1],te=te+e[p][b]*e[b][l];if(x=e[p][p]-d,s[p]<0)v=x,_=j,y=te;else if(I=p,s[p]===0?(S=this.cdiv(-j,-te,x,m),e[p][l-1]=S.r,e[p][l]=S.i):(C=e[p][p+1],A=e[p+1][p],fe=(n[p]-d)*(n[p]-d)+s[p]*s[p]-m*m,T=(n[p]-d)*2*m,fe===0&&T===0&&(fe=h*O*(Math.abs(x)+Math.abs(m)+Math.abs(C)+Math.abs(A)+Math.abs(v))),S=this.cdiv(C*_-v*j+m*te,C*y-v*te-m*j,fe,T),e[p][l-1]=S.r,e[p][l]=S.i,Math.abs(C)>Math.abs(v)+Math.abs(m)?(e[p+1][l-1]=(-j-x*e[p][l-1]+m*e[p][l])/C,e[p+1][l]=(-te-x*e[p][l]-m*e[p][l-1])/C):(S=this.cdiv(-_-A*e[p][l-1],-y-A*e[p][l],v,m),e[p+1][l-1]=S.r,e[p+1][l]=S.i)),w=Math.max(Math.abs(e[p][l-1]),Math.abs(e[p][l])),h*w*w>1)for(b=p;b<=l;b++)e[b][l-1]=e[b][l-1]/w,e[b][l]=e[b][l]/w}for(p=0;p<a;p++)if(p<u||p>c)for(b=p;b<a;b++)i[p][b]=e[p][b];for(b=a-1;b>=u;b--)for(p=u;p<=c;p++){for(v=0,g=u;g<=Math.min(b,c);g++)v=v+i[p][g]*e[g][b];i[p][b]=v}}}};var Uo=Math.pow(2,-52),ae=class o{constructor(){this.rows=0,this.columns=0,this._data=[]}static FromArray(e){let t=e[0].length,r=e.length,i=this.Zero(r,t);for(let n=0;n<r;n++)for(let s=0;s<t;s++)i._data[n][s]=e[n][s]||0;return i}static Zero(e,t=e){return new o().Reset(e,t)}static Identity(e){let t=this.Zero(e);for(let r=0;r<e;r++)t._data[r][r]=1;return t}static Clone(e){let t=this.Zero(e.rows,e.columns);for(let r=0;r<e.rows;r++)t._data[r]=new Float64Array(e._data[r]);return t}Reset(e,t=e){this._data=new Array(e);for(let r=0;r<e;r++)this._data[r]=new Float64Array(t);return this.rows=e,this.columns=t,this}CopyTo(e){e.rows=this.rows,e.columns=this.columns,e._data=[];for(let t=0;t<this.rows;t++)e._data[t]=new Float64Array(this._data[t]);return e}Row(e,t){return typeof t<"u"&&(this._data[e]=new Float64Array(t)),Array.from(this._data[e])}Column(e,t){if(typeof t<"u")for(let i=0;i<this.rows;i++)this._data[i][e]=arguments[1][i];let r=new Array(this.rows);for(let i=0;i<this.rows;i++)r[i]=this._data[i][e];return r}Transpose(){let e=o.Zero(this.columns,this.rows);for(let t=0;t<this.rows;t++)for(let r=0;r<this.columns;r++)e._data[r][t]=this._data[t][r];return e}ToArray(e=!1){let t=[];if(e)for(let r=0;r<this.columns;r++)t.push(this.Column(r));else for(let r=0;r<this.rows;r++)t.push(this.Row(r));return t}EigenSystem(){return new Je(this._data)}IsPosDef(){return new Je(this._data).realvalues.every(t=>t>0)}MakePosDef(e=Uo){var t=new Je(this._data),r=t.realvalues.length,i=o.Zero(r),n=o.Zero(r),s,a,l=0,u=o.Zero(r);for(t.vectors.forEach((f,d)=>u.Row(d,f)),s=0;s<r;s++){for(a=0;a<r;a++)i._data[s][a]=e;t.realvalues[s]>e&&(i._data[s][s]=t.realvalues[s])}for(s=0;s<r;s++){for(l=0,a=0;a<r;a++)n._data[s][a]=0,l+=t.vectors[s][a]*t.vectors[s][a]*i._data[a][a];n._data[s][s]=Math.sqrt(1/l)}for(s=0;s<r;s++)i._data[s][s]=Math.sqrt(i._data[s][s]);var c=n.Multiply(u.Multiply(i)),h=c.Multiply(c.Transpose()).Symmetrize();for(let f=0;f<h.rows;f++)h._data[f][f]=1;return h}Symmetrize(e=!1){var t=this.Transpose(),r=o.Clone(this),i,n;if(e)for(i=1;i<this.rows;i++)for(n=0;n<i;n++)r._data[i][n]=t._data[i][n];else for(n=1;n<this.columns;n++)for(i=0;i<n;i++)r._data[i][n]=t._data[i][n];return r}Cholesky(e=!1){if(this.rows!==this.columns)throw new Error("matrix not square");var t,r,i,n,s,a=this.rows,l=o.Zero(a);for(n=0;n<a;n++){for(r=0,s=0;s<n;s++){for(t=0,i=0;i<s;i++)t+=l._data[i][s]*l._data[i][n];if(l._data[s][n]=t=(this._data[s][n]-t)/l._data[s][s],r=r+t*t,this._data[s][n]!=this._data[n][s])throw new Error("matrix not symmetrical")}if(r=this._data[n][n]-r,r<=0)throw new Error("matrix not pos-def");for(l._data[n][n]=r>0?Math.sqrt(r):0,s=n+1;s<a;s++)l._data[s][n]=0}return e?l.Transpose():l}Multiply(e){var t,r,i,n,s=o.Zero(this.rows,e.columns);for(t=0;t<this.rows;t++)for(r=0;r<e.columns;r++){for(n=i=0;i<this.columns;i++)n+=this._data[t][i]*e._data[i][r];s._data[t][r]=n}return s}Inverse(){if(this.rows!==this.columns)throw new Error("invalid matrix");let e=o.Clone(this);var t,r,i,n,s=e.rows;for(r=1;r<s;r++)e._data[0][r]/=e._data[0][0];for(r=1;r<s;r++){for(i=r;i<s;i++){for(t=0,n=0;n<r;n++)t+=e._data[i][n]*e._data[n][r];e._data[i][r]-=t}if(r!=s-1)for(i=r+1;i<s;i++){for(t=0,n=0;n<r;n++)t+=e._data[r][n]*e._data[n][i];e._data[r][i]=(e._data[r][i]-t)/e._data[r][r]}}for(r=0;r<s;r++)for(i=r;i<s;i++){var a=1;if(r!=i)for(a=0,n=r;n<i;n++)a-=e._data[i][n]*e._data[n][r];e._data[i][r]=a/e._data[i][i]}for(r=0;r<s;r++)for(i=r;i<s;i++)if(r!=i){for(t=0,n=r;n<i;n++)t+=e._data[n][i]*(r==n?1:e._data[r][n]);e._data[r][i]=-t}for(r=0;r<s;r++)for(i=0;i<s;i++){for(t=0,n=r>i?r:i;n<s;n++)t+=(i==n?1:e._data[i][n])*e._data[n][r];e._data[i][r]=t}return e}SortColumns(e=!1){var t=o.Clone(this),r=e?(i,n)=>n-i:(i,n)=>i-n;for(let i=0;i<this.columns;i++)t.Column(i,this.Column(i).sort(r));return t}Rank(e=!1){for(var t=o.Clone(this),r,i=new Array(this.rows),n=new Array(this.rows),s=0;s<this.columns;s++){for(r=0;r<this.rows;r++)n[r]=r,i[r]=this._data[r][s];for(Ve.Sort(i,n),e&&n.reverse(),r=0;r<this.rows;r++)t._data[n[r]][s]=r}return t}Correl(){for(var e=new Array(this.columns),t=0;t<this.columns;t++)e[t]=this.Column(t);for(var r=o.Zero(this.columns),i=0;i<this.columns;i++){r._data[i][i]=1;for(var n=0;n<i;n++)r._data[i][n]=H.Correlation(e[i],e[n])}return r.Symmetrize()}IsSymmetric(){if(this.rows!=this.columns)return!1;for(var e=0;e<this.rows;e++)for(var t=0;t<this.columns;t++)if(this._data[e][t]!==this._data[t][e])return!1;return!0}};Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});var Vo=.08333333333333333,Do=-.002777777777777778,Io=.0007936507936507937,Fo=-.0005952380952380953,Lo=[0,.08106146679532726,.04134069595540929,.02767792568499834,.02079067210376509,.01664469118982119,.01387612882307075,.01189670994589177,.01041126526197209,.009255462182712733,.00833056343336287,.007573675487951841,.00694284010720953,.006408994188004207,.005951370112758848,.005554733551962801,.00520765591960964,.004901395948434738,.004629153749334029,.004385560249232324,.004166319691996922,.00396795421864086,.00378761806844443,.00362296022468309,.00347202138297877,.00333315563672809,.00320497022805504,.00308627868260878,.00297606398355041,.00287344936235247,.00277767492975269],Zt=o=>{let e,t;return o>30?(e=1/o,t=e*e,e*(Vo+t*(Do+t*(Io+t*Fo)))):Lo[o]},en=-1,tn=-1,Se=0,Ae=0,ri=0,Ie=0,rn=-1,nn=-1,sn=0,le=0,Kt=0,wt=0,ii=0,We=0,Xt=0,xt=0,Yt=0,er=0,tr=0,Qe=0,st=0,rr=0,ir=0,on=0,an=0,No=.3333333333333333,Po=.625,zo=.16666666666666666,Oo=20,ln=(o,e)=>{let t=0,r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0,f=0,d=0;if(o!=en||e!=rn){if(en=o,rn=e,Se=Math.min(e,1-e),Ie=1-Se,Ae=o*Se,Ae<=0)return-1;l=Ae+Se,le=Math.floor(l),Ae<10?(ri=Math.exp(o*Math.log(Ie)),t=Math.floor(Ae+10*Math.sqrt(Ae*Ie)),sn=Math.min(o,t)):(ii=(o+1)*(wt=Se/Ie),We=Ae*Ie,r=Math.floor(2.195*Math.sqrt(We)-4.6*Ie),Xt=le+.5,xt=le-r,Yt=le+r+1,a=(l-xt)/(l-xt*Se),er=a*(1+.5*a),a=(Yt-l)/(Yt*Ie),tr=a*(1+.5*a),Qe=.134+20.5/(15.3+le),st=r+.5,rr=st*(1+Qe+Qe),ir=rr+Qe/er,on=ir+Qe/tr)}if(Ae<=0)return-1;if(Ae<10){let m;for(i=0,m=ri,u=B.Next();u>m;)++i,i>sn?(u=B.Next(),i=0,m=ri):(u-=m,m=(o-i+1)*Se*m/(i*Ie));return e>.5?o-i:i}for(;;){if(c=B.Next(),(u=B.Next()*on)<=st)return i=Math.floor(Xt-u+st*c),e>.5?o-i:i;if(u<=rr){if(h=xt+(u-st)/Qe,(c=c*Qe+1-Math.abs(Xt-h)/st)>=1)continue;i=Math.floor(h)}else if(u<=ir){if((h=xt+Math.log(c)/er)<0)continue;i=Math.floor(h),c*=(u-rr)*er}else{if((i=Math.floor(Yt-Math.log(c)/tr))>o)continue;c*=(u-ir)*tr}if((n=Math.abs(i-le))<=Oo||n+n+2>=We){if(a=1,le<i)for(r=le;r<i&&!((a*=ii/++r-wt)<c););else for(r=i;r<le&&!((c*=ii/++r-wt)>a););if(c<=a)break}else if(c=Math.log(c),f=-n*n/(We+We),d=n/We*((n*(n*No+Po)+zo)/We+.5),c<=f-d||c<=f+d&&((o!=tn||Se!=nn)&&(tn=o,nn=Se,Kt=o-le+1,an=Xt*Math.log((le+1)/(wt*Kt))+Zt(le+1)+Zt(Kt)),s=o-i+1,c<=an+(o+1)*Math.log(Kt/s)+(i+.5)*Math.log(s*wt/(i+1))-Zt(i+1)-Zt(s)))break}return e>.5?o-i:i};var un=-1,cn=-1,Ze=0,nr=0,hn=0,ni=0,pe=0,W=0,sr=0,Fe=0,Ct=0,Go=.0416666664,Bo=.0208333723,Ho=.0079849875,qo=.0015746717,jo=-.0003349403,$o=.0003340332,Jo=.0006053049,Wo=-.0004701849,Qo=171032e-9,dn=.333333333,fn=-.249999949,mn=.199999867,pn=-.166677482,_n=.142873973,bn=-.124385581,yn=.11036831,gn=-.112750886,vn=.104089866,Zo=1,Ko=.499999994,Xo=.166666848,Yo=.041664508,ea=.008345522,ta=.001353826,ra=247453e-9,or=(o,e)=>{let t=0,r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0,f=0,d=0;if(o<=0||e<=0)return-1;if(o<1){for(Ze=1+.36788794412*o;;)if(r=Ze*B.Next(),r<=1){if(t=Math.exp(Math.log(r)/o),Math.log(B.Next())<=-t)return t/e}else if(t=-Math.log((Ze-r)/o),Math.log(B.Next())<=(o-1)*Math.log(t))return t/e}else{o!=un&&(un=o,Fe=o-.5,W=Math.sqrt(Fe),hn=5.656854249-12*W);do h=2*B.Next()-1,f=2*B.Next()-1,d=h*h+f*f;while(d>1);if(n=h*Math.sqrt(-2*Math.log(d)/d),c=W+.5*n,t=c*c,n>=0||(a=B.Next(),hn*a<=n*n*n)||(o!=cn&&(cn=o,pe=1/o,Ct=((((((((Qo*pe+Wo)*pe+Jo)*pe+$o)*pe+jo)*pe+qo)*pe+Ho)*pe+Bo)*pe+Go)*pe,o>3.686?o>13.022?(Ze=1.77,sr=.75,nr=.1515/W):(Ze=1.654+.0076*Fe,sr=1.68/W+.275,nr=.062/W+.024):(Ze=.463+W-.178*Fe,sr=1.235,nr=.195/W-.079+.016*W)),c>0&&(l=n/(W+W),Math.abs(l)>.25?i=Ct-W*n+.25*n*n+(Fe+Fe)*Math.log(1+l):i=Ct+.5*n*n*((((((((vn*l+gn)*l+yn)*l+bn)*l+_n)*l+pn)*l+mn)*l+fn)*l+dn)*l,Math.log(1-a)<=i)))return t/e;for(;;){do ni=-Math.log(B.Next()),a=B.Next(),a=a+a-1,s=a>0?1:-1,n=Ze+ni*sr*s;while(n<=-.71874483771719);if(l=n/(W+W),Math.abs(l)>.25?i=Ct-W*n+.25*n*n+(Fe+Fe)*Math.log(1+l):i=Ct+.5*n*n*((((((((vn*l+gn)*l+yn)*l+bn)*l+_n)*l+pn)*l+mn)*l+fn)*l+dn)*l,!(i<=0)&&(i>.5?u=Math.exp(i)-1:u=((((((ra*i+ta)*i+ea)*i+Yo)*i+Xo)*i+Ko)*i+Zo)*i,nr*a*s<=u*Math.exp(ni-.5*n*n)))return c=W+.5*n,c*c/e}}};var si=-1,wn=2e9,xn=[0,0,0],ia=[76.18009172947146,-86.50532032941678,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18],Cn=o=>{let e,t=o-1,r=t+5.5;r-=(t+.5)*Math.log(r);let i=1.000000000190015;for(e=0;e<=5;e++)t+=1,i+=ia[e]/t;return-r+Math.log(2.5066282746310007*i)},na=()=>{let o,e,t;do e=2*B.Next()-1,t=2*B.Next()-1,o=e*e+t*t;while(o>1);let r=Math.sqrt(-2*Math.log(o)/o);return t*r},ar=o=>{let e,t,r,[i,n,s]=xn,a=si;if(o==-1)return 0;if(o<12){o!=a&&(si=o,s=Math.exp(-o)),e=-1,t=1;do e+=1,t*=B.Next();while(t>s)}else if(o<wn){o!=a&&(si=o,i=Math.sqrt(2*o),n=Math.log(o),s=o*n-Cn(o+1));do{do r=Math.tan(Math.PI*B.Next()),e=i*r+o;while(e<0);e=Math.floor(e),t=.9*(1+r*r)*Math.exp(e*n-Cn(e+1)-s)}while(B.Next()>t)}else e=o+Math.sqrt(o)*na(),Math.floor(e)<0&&(e=Math.floor(o)>=0?o:wn);return xn=[i,n,s],Math.floor(e)};var Sn=(o,e)=>e===1?0:ar(or(o,e/(1-e)));var k=class o{static SetRNG(e){this.rng=e}static Binomial(e,t){let r=[];for(let i=0;i<e;i++)r.push(ln(t.n,t.p));return r}static NegativeBinomial(e,t){let r=[];for(let i=0;i<e;i++)r.push(Sn(t.n,t.p));return r}static Poisson(e,t){let r=[];for(let i=0;i<e;i++)r.push(ar(t.m));return r}static Gamma(e,t){let r=[];for(let i=0;i<e;i++)r.push(or(t.a,t.lambda));return r}static Normal(e,t={}){let r=Object.assign({mean:0,sd:1,lhs:!1,ordered:!1},t);return(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered)).map(n=>this.InverseNormal2(n)*r.sd+r.mean)}static ReverseInverseNormal2(e,t=40){let i=[0,Math.min(1,Math.max(0,.5+e*.125)),1],n=i.map(s=>this.InverseNormal2(s));for(let s=0;s<t;s++){if(Math.abs(n[1]-e)<=1e-6)return i[1];n[1]<e?(i=[i[1],(i[1]+i[2])/2,i[2]],n=[n[1],this.InverseNormal2(i[1]),n[2]]):(i=[i[0],(i[0]+i[1])/2,i[1]],n=[n[0],this.InverseNormal2(i[1]),n[1]])}return i[1]}static TruncatedNormal(e,t={}){let r=Object.assign({mean:0,sd:1,lhs:!1,ordered:!1},t),i=r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered),n=0,s=1;typeof r.min=="number"&&(n=this.ReverseInverseNormal2((r.min-r.mean)/r.sd,r.max_iterations)),typeof r.max=="number"&&(s=this.ReverseInverseNormal2((r.max-r.mean)/r.sd,r.max_iterations));let a=s-n;return i=i.map(l=>l*a+n),i.map(l=>this.InverseNormal2(l)*r.sd+r.mean)}static LogNormal(e,t={}){let r=Object.assign({mean:1,sd:1,lhs:!1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered);for(let n=0;n<i.length;n++)i[n]=Math.exp(this.InverseNormal2(i[n])*r.sd+r.mean);return i}static LogNormalReturn(e,t={}){let r=Object.assign({mean:1,sd:1,lhs:!1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered);r.mean+=1;let n=r.mean*r.mean,s=r.sd*r.sd,a=Math.log(n/Math.sqrt(n+s)),l=Math.sqrt(Math.log((n+s)/n));for(let u=0;u<e;u++)i[u]=Math.exp(this.InverseNormal2(i[u])*l+a)-1;return i}static Triangular(e,t={}){let r=Object.assign({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},t);return(r.field||(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered))).map(n=>this.InverseTriangular(n,r.a,r.b,r.c))}static PERT(e,t={}){let r=Object.assign({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},t),i=r.field||(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered));return this.InversePERTField(i,r.a,r.b,r.c,r.lambda)}static Uniform(e,t={}){let r=Object.assign({lhs:!1,min:0,max:1,ordered:!1},t),i=r.lhs?this.LHSFieldDouble(e,r.ordered):this.UniformField(e,r.ordered),n=r.max-r.min;for(let s=0;s<i.length;s++)i[s]=i[s]*n+r.min;return i}static Bernoulli(e,t={}){let r=Object.assign({lhs:!1,p:.5},t);return this.Uniform(e,{lhs:r.lhs,min:0,max:1}).map(n=>n<=r.p)}static Beta(e,t={}){let r=Object.assign({lhs:!1,a:0,b:1,ordered:!1},t);return(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered)).map(n=>this.InverseBeta(n,r.a,r.b))}static Weibull(e,t={}){let r=Object.assign({lhs:!1,a:1,b:1,ordered:!1},t);return(r.lhs?this.LHSField(e,r.ordered):this.UniformField(e,r.ordered)).map(n=>this.InverseWeibull(n,r.a,r.b))}static Discretize(e,t){let r=e.slice(0);t=t||Math.round;for(let i=0;i<r.length;i++)r[i]=t(r[i]);return r}static Constant(e,t){let r=new Array(e);for(let i=0;i<e;i++)r[i]=t;return r}static Fixed(e,t={}){t=Object.assign({value:0},t);let r=new Array(e);for(let i=0;i<e;i++)r[i]=t.value;return r}static Conditional(e,t,r,i,n=0,s){let a=s||this.Bernoulli(e,{lhs:!0,p:t}),l=Math.ceil(e*t),u=r(l,i),c=new Array(e);for(let h=0,f=0;h<e;h++)c[h]=a[h]?u[f++]:n;return c}static Correlate(e,t,r=!1){var i,n=t.length,s=t[0].length,a=[];let l=ae.Zero(s,n);for(i=0;i<n;i++)l.Column(i,this.VDWField(s));let u=l.Multiply(e.Cholesky(!0).Multiply(l.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return r?a=t.map((c,h)=>{let f=new Array(c.length),d=u.Column(h);for(i=0;i<d.length;i++)f[i]=c[d[i]];return f}):a=t.map((c,h)=>{let f=c.slice(0).sort((_,y)=>_-y),d=new Array(c.length),m=u.Column(h);for(i=0;i<m.length;i++)d[i]=f[m[i]];return d}),a}static CorrelateCDM(e,t,r=!1){var i,n=t.length,s=t[0].length;let a=De.Zero(s,n);for(i=0;i<n;i++)a.SetColumn(i,this.VDWField(s));let l=new De;if(l.rows=s,l.columns=n,l.data=t.map(u=>new Float64Array(u)),!r)throw new Error("E_NOTIMPL: correlateCDM !ordered");return a.Multiply(e.Cholesky(!0).Multiply(a.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data}static P80Pert(e,t,r,i){let n=this.PERTParameters(e,t,r,i),s=(n.max-n.min)/(this.InverseBeta(.9,n.v,n.w)-this.InverseBeta(.1,n.v,n.w)),a=n.min-this.InverseBeta(.1,n.v,n.w)*s,l=n.max+(1-this.InverseBeta(.9,n.v,n.w))*s;return{a:a/n.scale,b:l/n.scale,c:r}}static PERTPercentileParameters(e,t,r,i){if(e.value>=r||t.value<=r||e.value>=t.value||e.percentile>=t.percentile)throw new Error("invalid parameters");let n=this.PERTParameters(e.value,t.value,r,i),s=(n.max-n.min)/(this.InverseBeta(t.percentile,n.v,n.w)-this.InverseBeta(e.percentile,n.v,n.w)),a=n.min-this.InverseBeta(e.percentile,n.v,n.w)*s,l=n.max+(1-this.InverseBeta(t.percentile,n.v,n.w))*s;return{a:a/n.scale,b:l/n.scale,c:r}}static TriangularParameterTest(e,t,r=.1,i=1){let n=i*Math.pow(t-e,2)/(t-1),s=(-n+Math.sqrt(n*(n+4)))/2,a=(-n-Math.sqrt(n*(n+4)))/2;if(s<0&&a<0)throw new Error("double roots");let l=s<0?s:a,u=l*l/((t-l)*(1-l))-r;return{a:l,error:u,negative:u<0}}static TriangularPercentileParameters(e,t,r){if(e.value>=r||t.value<=r||e.value>=t.value||e.percentile>=t.percentile)throw new Error("invalid parameters");let i=e.value,n=t.value,s=e.value;i=0,r-=s,n-=s;let a=r;r=1,i/=a,n/=a;let l=e.percentile/(1-t.percentile),u=64,c=1e-8,h=n*1.5,f=this.TriangularParameterTest(n,h,e.percentile,l),d=f.error<0?h-n:(n-h)/2;for(let m=0;m<u;m++){h+=d;let _=this.TriangularParameterTest(n,h,e.percentile,l);if(Math.abs(_.error)<c){f=_;break}_.negative!==f.negative&&(d=-d/2),f=_}return i=f.a*a+s,n=h*a+s,{a:i,b:n,c:a+s}}static P80Triangular(e,t,r){let i=0,n=1,s=(r-e)/(t-e),a=s<.5;a&&(s=1-s);let l=-.1596122+2.1266864*s-2.1742909*s*s+1.1087738*s*s*s;a&&(l=1-l);let u=.6890868-.4434898*s+.35757*s*s,c=(t-e)/u;return i=r-l*c,n=i+c,{a:i,b:n,c:r}}static BetaDensity(e,t,r){if(typeof e!="number"){let i=new Array(e.length);for(let n=0;n<e.length;n++)e[n]<=0||e[n]>=1?i[n]=0:i[n]=Math.exp((t-1)*Math.log(e[n])+(r-1)*Math.log(1-e[n])-this.LnGamma(t)-this.LnGamma(r)+this.LnGamma(t+r));return i}return e<=0||e>=1?0:Math.exp((t-1)*Math.log(e)+(r-1)*Math.log(1-e)-this.LnGamma(t)-this.LnGamma(r)+this.LnGamma(t+r))}static PERTDensity(e,t,r,i,n=4){var s,a,l=(t+r+n*i)/(n+2);return i===l?s=n/2+1:s=(l-t)*(2*i-t-r)/((i-l)*(r-t)),a=s*(r-l)/(l-t),this.BetaDensity(e,s,a)}static NormalDensity(e){if(typeof e!="number"){let t=new Array(e.length);for(let r=0;r<e.length;r++)t[r]=.398942280401433*Math.exp(-e[r]*e[r]/2);return t}else return .398942280401433*Math.exp(-e*e/2)}static Shuffle(e){var t=e.length,r,i,n;for(i=t-1;i>=0;i--)r=Math.floor(this.rng.Next()*(i+1)),n=e[i],e[i]=e[r],e[r]=n;return e}static VDWField(e){if(this.vdw_cache.length!==e){this.vdw_cache=new Float64Array(e);for(var t=0;t<e;t++)this.vdw_cache[t]=this.InverseNormal2((t+1)/(e+1))}let r=new Float64Array(this.vdw_cache);return this.Shuffle(r)}static LHSFieldDouble(e,t=!1){for(var r=1/e,i=new Float64Array(e),n=0;n<e;n++)i[n]=this.rng.Next()*r+n*r;return t||this.Shuffle(i),i}static LHSField(e,t=!1){for(var r=1/e,i=new Array(e),n=0;n<e;n++)i[n]=this.rng.Next()*r+n*r;return t||this.Shuffle(i),i}static UniformField(e,t=!1){for(var r=new Array(e),i=0;i<e;i++)r[i]=this.rng.Next();return t&&r.sort((n,s)=>n-s),r}static InverseTriangular(e,t,r,i){return t===r?t:e<=(i-t)/(r-t)?t+Math.sqrt((r-t)*(i-t)*e):r-Math.sqrt((r-t)*(r-i)*(1-e))}static InverseNormal(e){if(e===.5)return 0;var t,r,i;return t=e<1&&e>.5?1-e:e,r=Math.sqrt(Math.log(1/Math.pow(t,2))),i=r-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3)),e>.5?i:-i}static InverseNormal2(e){var t,r,i=e-.5;return Math.abs(i)<=.425?(r=.180625-i*i,i*(((((((2509.0809287301227*r+33430.57558358813)*r+67265.7709270087)*r+45921.95393154987)*r+13731.69376550946)*r+1971.5909503065513)*r+133.14166789178438)*r+3.3871328727963665)/(((((((5226.495278852854*r+28729.085735721943)*r+39307.89580009271)*r+21213.794301586597)*r+5394.196021424751)*r+687.1870074920579)*r+42.31333070160091)*r+1)):(r=i<0?e:1-e,r<=0?0:(r=Math.sqrt(-Math.log(r)),r<=5?(r=r-1.6,t=(((((((.0007745450142783414*r+.022723844989269184)*r+.2417807251774506)*r+1.2704582524523684)*r+3.6478483247632045)*r+5.769497221460691)*r+4.630337846156546)*r+1.4234371107496835)/(((((((10507500716444169e-25*r+.0005475938084995345)*r+.015198666563616457)*r+.14810397642748008)*r+.6897673349851)*r+1.6763848301838038)*r+2.053191626637759)*r+1)):(r=r-5,t=(((((((20103343992922881e-23*r+27115555687434876e-21)*r+.0012426609473880784)*r+.026532189526576124)*r+.29656057182850487)*r+1.7848265399172913)*r+5.463784911164114)*r+6.657904643501103)/(((((((20442631033899397e-31*r+1421511758316446e-22)*r+18463183175100548e-21)*r+.0007868691311456133)*r+.014875361290850615)*r+.1369298809227358)*r+.599832206555888)*r+1)),i<0?-t:t))}static Log1p(e){let t=1+e;return Math.log(t)-(t-1-e)/t}static BetaContFrac(e,t,r,i){var n=512,s=2*Number.MIN_VALUE,a=0,l,u=1,c=1-(e+t)*r/(e+1);for(Math.abs(c)<s&&(c=o.QUIET_NAN),c=1/c,l=c;a<n;){var h=a+1,f=h*(t-h)*r/((e-1+2*h)*(e+2*h)),d;if(c=1+f*c,u=1+f/u,Math.abs(c)<s&&(c=o.QUIET_NAN),Math.abs(u)<s&&(u=o.QUIET_NAN),c=1/c,d=c*u,l*=d,f=-(e+h)*(e+t+h)*r/((e+2*h)*(e+2*h+1)),c=1+f*c,u=1+f/u,Math.abs(c)<s&&(c=o.QUIET_NAN),Math.abs(u)<s&&(u=o.QUIET_NAN),c=1/c,d=c*u,l*=d,Math.abs(d-1)<2*o.EPSILON_DOUBLE||l*Math.abs(d-1)<i)break;++a}return a>=n?o.QUIET_NAN:l}static BetaCDF(e,t,r){if(e<=0)return 0;if(e>=1)return 1;var i=1,n=0;if(e===0)return i*0+n;if(e===1)return i*1+n;var s,a,l,u=this.LnGamma(t)+this.LnGamma(r)-this.LnGamma(t+r),c=-u+t*Math.log(e)+r*this.Log1p(-e),h=Math.exp(c);return e<(t+1)/(t+r+2)?(s=Math.abs(n/(i*h/t))*o.EPSILON_DOUBLE,a=this.BetaContFrac(t,r,e,s),i*(h*a/t)+n):(s=Math.abs((i+n)/(i*h/r))*o.EPSILON_DOUBLE,a=this.BetaContFrac(r,t,1-e,s),l=h*a/r,i===-n?-i*l:i*(1-l)+n)}static LnGamma(e){var t=e-1,r=t+5.5;r-=(t+.5)*Math.log(r);var i=1;return t+=1,i+=76.18009173/t,t+=1,i+=-86.50532033/t,t+=1,i+=24.01409822/t,t+=1,i+=-1.231739516/t,t+=1,i+=.00120858003/t,t+=1,i+=-536382e-11/t,-r+Math.log(2.50662827465*i)}static BetaPDF(e,t,r){return e<0||e>1?0:Math.exp(this.LnGamma(t+r)-this.LnGamma(t)-this.LnGamma(r))*Math.pow(e,t-1)*Math.pow(1-e,r-1)}static InverseWeibull(e,t,r){return t*Math.pow(-Math.log(1-e),1/r)}static InverseBeta(e,t,r){var i,n,s,a,l,u=0,c,h,f;if(e<0||e>1||t<0||r<0||e===0)return 0;if(e===1)return 1;if(e>.5){var d=1-e;return d>.5?this.InverseBeta(1-d,t,r):1-this.InverseBeta(d,r,t)}if(n=t/(t+r),e<.1){var m=(Math.log(t)+this.LnGamma(t)+this.LnGamma(r)-this.LnGamma(t+r)+Math.log(e))/t;m<=0?(i=Math.exp(m),i*=Math.pow(1-i,-(r-1)/t)):i=n,i>n&&(i=n)}else i=n;do{if(a=e-this.BetaCDF(i,t,r),l=this.BetaPDF(i,t,r),a===0||u++>64)return i;s=a/Math.max(2*Math.abs(a/i),l),h=s,f=-((t-1)/i-(r-1)/(1-i))*s*s/2,c=h,Math.abs(f)<Math.abs(h)?c+=f:c*=2*Math.abs(h/f),i+c>0&&i+c<1?i+=c:i=Math.sqrt(i)*Math.sqrt(n)}while(Math.abs(h)>1e-10*i);return i}static InversePERTField(e,t,r,i,n){if(r<=t)return e.map(()=>t);try{let s=this.PERTParameters(t,r,i,n);return e.map(a=>(this.InverseBeta(a,s.v,s.w)*(s.max-s.min)+s.min)/s.scale)}catch{return t===r?e.map(a=>t):e.map(a=>0)}}static PERTParameters(e,t,r,i=4){if(e>=t||i<0||r<e||r>t)throw new Error("Invalid parameters");for(var n,s,a,l=1,u,c;Math.abs(e)<1&&Math.abs(t)<1;)l*=10,e*=10,t*=10,r*=10;n=(e+t+i*r)/(i+2);var h;return r===0?h=Math.abs(n-r):h=Math.abs((n-r)/r),h<=1e-12?s=i/2+1:(u=(n-e)*(2*r-e-t),c=(r-n)*(t-e),s=u/c),u=s*(t-n),c=n-e,a=u/c,{v:s,w:a,min:e,max:t,scale:l}}static InversePERT(e,t,r,i,n=4){let s=this.PERTParameters(t,r,i,n);return(this.InverseBeta(e,s.v,s.w)*(s.max-s.min)+s.min)/s.scale}};k.rng=B;k.EPSILON_DOUBLE=2220446049250313e-31;k.QUIET_NAN=Number.NaN;k.M_LN_SQRT_2PI=.9189385332046728;k.M_1_SQRT_2PI=.3989422804014327;k.vdw_cache=new Float64Array(0);var sa=new Array(256);for(let o=0;o<256;++o)sa[o]=(o+256).toString(16).substr(1);var oi=0xffffffffffffffffn,oa=(o=0)=>{let e=BigInt(o);return()=>{e=e+0x9E3779B97F4A7C15n&oi;let t=e;return t=(t^t>>30n)*0xBF58476D1CE4E5B9n&oi,t=(t^t>>27n)*0x94D049BB133111EBn&oi,t^t>>31n}},ai=(o=0)=>{o||(o=Math.round(new Date().getTime()+Math.random()*1e6));let e=oa(o),t=[],r=0n,i=0n;for(let n=0;n<8;n++)for(i<<=4n;;){let s=e()&0xfn;if(s&&!t.includes(s)){t.push(s),i+=s,r=s;break}}for(let n=0;n<8;n++)for(i<<=4n;;){let s=e()&0xfn;if(s&&s!==r){i+=s,r=s;break}}return i},aa="AGFzbQEAAAABDQJgAn5+AXxgA35+fwADAwIAAQUDAQABBx4DBm1lbW9yeQIABnNhbXBsZQAACHNhbXBsZV9uAAEKqQECbwEEfiAAIAF+IgIiAyABfCEEIAIgAn4gA3wiAkIgiiICIAJ+IAR8IgJCIIoiAiACfiADfCICQiCKIgIgAn4gBHwiAiIFQiCKIgIgAn4gA3xCIIggBYVCDIhCgICAgICAgPg/hL9EAAAAAAAA8D+hCzcBAX9BACEDA0ACQEEAIAJGDQAgAyAAIAEQADkDAEEIIANqIQNCASAAfCEAIAJBAWshAgwBCwsL",la=Uint8Array.from(atob(aa||""),o=>o.charCodeAt(0)),ua=new WebAssembly.Module(la),ca=new WebAssembly.Instance(ua),An=ca.exports,ha=new Float64Array(An.memory.buffer),Rn=class{key=0n;counter=0n;cache_size=1024*2;cache=new Float64Array(this.cache_size);cache_pointer=this.cache_size;fills=0;constructor(o,e=0){this.Reset(o,BigInt(e))}Reset(o,e=0){this.key=o,this.counter=BigInt(e),this.cache_pointer=this.cache_size}Next(){return this.cache_pointer>=this.cache_size&&(this.Fill(this.cache_size,this.cache),this.cache_pointer=0),this.cache[this.cache_pointer++]}NextN(o,e,t=this.cache_size){e||(e=new Float64Array(o));let r=0;if(this.cache_pointer<this.cache_size){let i=Math.min(o,this.cache_size-this.cache_pointer);if(e.set(this.cache.subarray(this.cache_pointer,this.cache_pointer+i)),this.cache_pointer+=i,i===o)return e;r=i}for(;r<o;){let i=e.subarray(r),n=Math.min(t,o-r);this.Fill(n,i),r+=n}return e}Fill(o,e){An.sample_n(this.counter,this.key,o),e.set(ha.subarray(0,o)),this.counter+=BigInt(o),this.fills++}};var lr=class o{static type="vertex";type=o.type;color=0;edges_in=new Set;edges_out=new Set;get has_inbound_edges(){return this.edges_in.size>0}get has_outbound_edges(){return this.edges_out.size>0}Reset(){for(let e of this.edges_out)e.RemoveDependency(this);for(let e of this.edges_in)e.RemoveDependent(this);this.edges_out.clear(),this.edges_in.clear()}ClearDependencies(){for(let e of this.edges_in)e.RemoveDependent(this);this.edges_in.clear()}AddDependent(e){e!==this&&(this.edges_out.has(e)||this.edges_out.add(e))}RemoveDependent(e){this.edges_out.delete(e)}AddDependency(e){e!==this&&(this.edges_in.has(e)||this.edges_in.add(e))}RemoveDependency(e){this.edges_in.delete(e)}LinkTo(e){this.AddDependent(e),e.AddDependency(this)}DependsOn(e){this.AddDependency(e),e.AddDependent(this)}LoopCheck(){let e=[this];for(;e.length;){let t=e[e.length-1],r=!0;if(t.color!==2){t.color=1;for(let i of t.edges_out){if(i.color===1)return this.color=0,!0;i.color===0&&i.edges_out.size&&(e.push(i),r=!1)}}r&&(t.color=2,e.pop())}return this.color=2,!1}};var ot=class extends lr{dirty=!1};var Mn={error:"NOTIMPL"},ue=()=>({type:6,value:"N/A"}),ee=()=>({type:6,value:"EXPR"}),V=()=>({type:6,value:"DATA"}),se=()=>({type:6,value:"DIV/0"}),R=()=>({type:6,value:"ARG"}),E=()=>({type:6,value:"VALUE"}),z=()=>({type:6,value:"REF"}),St=()=>({type:6,value:"NAME"}),kn=()=>({type:6,value:"SPILL"}),ur=()=>({type:6,value:"UNK"});var Re=class o extends ot{static type="spreadsheet-vertex";reference;error=0;address;result={type:0};expression={type:"missing",id:-1};expression_error=!1;short_circuit=!1;type=o.type;get array_head(){return this.address?!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row:!1}TakeReferenceValue(){this.reference&&(this.result=G(this.reference.GetValue()))}Calculate(e){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){this.reference&&(this.array_head||this.reference.type===1)&&this.reference.SetCalculationError("LOOP");for(let t of this.edges_out)t.Calculate(e);return}for(let t of this.edges_in)if(t.dirty)return;if(this.reference){if(this.reference.type===1){this.short_circuit=!1;let t=e.CalculationCallback.call(e,this);if(this.result=t.value,this.short_circuit)return;t.volatile&&e.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)e.SpreadCallback.call(e,this,this.result);else if(this.reference.type===1)if(this.result.type===8){let t=e.SpillCallback.call(e,this,this.result);if(t)for(let r of t)for(let i of r.edges_out)i.dirty=!0,i.Calculate(e)}else this.reference.SetCalculatedValue(this.result.value,this.result.type)}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(let t of this.edges_out)t.dirty&&e.calculation_list.push(t)}}};var Ke=class o extends ot{static type="array-vertex";static list=[];type=o.type;area;static GetVertex(e){for(let t of this.list)if(t.area.start.sheet_id===e.start.sheet_id&&t.area.Equals(e))return[t,!1];return[new o(e),!0]}static Clear(){this.list=[]}static GetContainingArrays(e){let t=[];for(let r of this.list)r.area.start.sheet_id===e.sheet_id&&r.area.Contains(e)&&t.push(r);return t}static CreateImplicitEdges(e,t){for(let r of this.list)r.area.start.sheet_id===t.sheet_id&&r.area.Contains(t)&&r.DependsOn(e)}constructor(e){super(),this.area=e.Clone(),o.list.push(this)}RemoveDependent(e){super.RemoveDependent(e),this.edges_out.size||(this.Reset(),o.list=o.list.filter(t=>t!==this))}Calculate(e){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){for(let t of this.edges_out)t.Calculate(e);return}for(let t of this.edges_in)if(t.dirty)return;this.dirty=!1;for(let t of this.edges_out)t.Calculate(e)}}};var at=class o extends Re{static type="calculation-leaf-vertex";type=o.type;address={row:-1,column:-1};use;updated=!1;color=2;Calculate(e){if(!this.dirty)return;for(let r of this.edges_in)if(r.dirty)return;let t=e.CalculationCallback.call(e,this);this.result=t.value,this.dirty=!1,this.updated=!0}AddDependent(){throw new Error("leaf vertex cannot have dependents")}};var hr=class{vertices=[[]];volatile_list=[];calculation_list=[];spill_data=[];loop_hint;leaf_vertices=new Set;dirty_list=[];loop_check_required=!1;IsSpreadsheetVertex(e){return e.type===Re.type}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices.clear(),Ke.Clear()}ResolveArrayHead(e){if(!e.sheet_id)throw new Error("resolve array head with no sheet id");let t=this.model.sheets.Find(e.sheet_id)?.cells;if(!t)throw new Error("no cells? sheet id "+e.sheet_id);let r=t.data[e.row];if(r){let i=r[e.column];if(i&&i.area){let n={row:i.area.start.row,column:i.area.start.column,sheet_id:e.sheet_id};return console.info("array head",e,n),n}}return e}*IterateVertices(e,t=!1){for(let r of Qt.Iterate(e)){let i=this.GetVertex(r,t);i&&(yield i)}}GetVertex(e,t){if(!e.sheet_id)throw console.info(JSON.stringify({address:e,create:t})),console.trace(),new Error("getvertex with no sheet id");let r=this.model.sheets.Find(e.sheet_id)?.cells;if(!r)throw new Error("no cells? sheet id "+e.sheet_id);if(!this.vertices[e.sheet_id]){if(!t)return;this.vertices[e.sheet_id]=[]}if(this.vertices[e.sheet_id][e.column]){let n=this.vertices[e.sheet_id][e.column][e.row];if(n)return n;if(!t)return}else{if(!t)return;this.vertices[e.sheet_id][e.column]=[]}let i=new Re;return i.address={row:e.row,column:e.column,absolute_row:e.absolute_row,absolute_column:e.absolute_column,sheet_id:e.sheet_id},i.reference=r.EnsureCell(e),this.vertices[e.sheet_id][e.column][e.row]=i,Ke.CreateImplicitEdges(i,e),i}RemoveVertex(e){if(!e.sheet_id)throw new Error("removevertex with no sheet id");let t=this.GetVertex(e,!1);t&&(t.Reset(),this.vertices[e.sheet_id][e.column][e.row]=void 0)}ResetVertex(e){let t=this.GetVertex(e,!1);t&&t.Reset()}RIBcount=0;ResetInbound(e,t=!1,r=!0,i=!1){this.RIBcount++;let n=this.GetVertex(e,r);if(!n){if(t){let a=Ke.GetContainingArrays(e);for(let l of a)this.SetVertexDirty(l)}return}let s=[];if(i&&(s=Array.from(n.edges_in)),n.ClearDependencies(),t&&this.SetVertexDirty(n),i){n.has_outbound_edges||this.RemoveVertex(e);for(let a of s)if(!a.has_inbound_edges&&!a.has_outbound_edges){let l=a;l.address&&this.RemoveVertex(l.address)}}}ResetLoopState(){for(let e of this.vertices)if(e){for(let t of e)if(t)for(let r of t)r&&(r.color=r.edges_out.size?0:2)}for(let e of this.leaf_vertices)e.color=2}LoopCheck(e=!1){if(!this.loop_check_required&&!e)return!1;let t=[];for(let i of this.vertices)if(i){for(let n of i)if(n)for(let s of n)s&&(s.color=s.edges_out.size?0:2,t.push(s))}let r=[];for(let i of t)if(i.color===0){for(i.color=1,r.push(i);r.length;){let n=r[r.length-1],s=!0;if(n.color!==2)for(let a of n.edges_out){if(a.color===1)return this.loop_hint=this.RenderAddress(i.address),console.info("loop detected @",this.loop_hint),!0;a.color===0&&(r.push(a),s=!1)}s&&(r.pop(),n.color=2)}i.color=2}return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(e){if(!e)return"undefined";let t="";if(e.sheet_id){let i=this.model.sheets.Find(e.sheet_id);i&&(t=i.name+"!")}let r=new M(e);return t+r.spreadsheet_label}CompositeAddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let[r,i]=Ke.GetVertex(e);if(t.DependsOn(r),this.loop_check_required=!0,!i)return;let n=this.vertices[e.start.sheet_id];if(n){if(e.entire_row){for(let s=0;s<n.length;s++)if(n[s])for(let a=e.start.row;a<=e.end.row;a++){let l=n[s][a];l&&r.DependsOn(l)}}else if(e.entire_column){for(let s=e.start.column;s<=e.end.column;s++)if(n[s])for(let a of n[s])a?.address&&r.DependsOn(a)}else for(let s=e.start.row;s<=e.end.row;s++)for(let a=e.start.column;a<=e.end.column;a++)if(n[a]){let l=n[a][s];l&&r.DependsOn(l)}}}AddLeafVertexArrayEdge(e,t){this.CompositeAddArrayEdge(e,t)}AddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let r=this.GetVertex(t,!0);this.CompositeAddArrayEdge(e,r)}AddEdge(e,t){let r=this.GetVertex(e,!0);this.GetVertex(t,!0).DependsOn(r),r.reference&&r.reference.area&&!r.array_head&&this.AddEdge({...e,row:r.reference.area.start.row,column:r.reference.area.start.column},t),this.loop_check_required=!0}RemoveEdge(e,t){let r=this.GetVertex(e,!1),i=this.GetVertex(t,!1);!r||!i||(r.RemoveDependent(i),i.RemoveDependency(r))}SetAreaDirty(e){if(e.start.column===1/0||e.end.column===1/0||e.start.row===1/0||e.end.row===1/0)throw new Error("don\'t iterate over infinite area");let t=e.start.sheet_id;if(!t)throw new Error("invalid area, missing sheet id");for(let r=e.start.column;r<=e.end.column;r++)for(let i=e.start.row;i<=e.end.row;i++){let n={row:i,column:r,sheet_id:t};this.GetVertex(n,!1)&&this.SetDirty(n)}}SetVertexDirty(e){if(!e.dirty){this.dirty_list.push(e),e.dirty=!0;for(let t of e.edges_out)this.SetVertexDirty(t)}}SetDirty(e){let t=this.GetVertex(e,!0);this.SetVertexDirty(t)}AddLeafVertex(e){this.leaf_vertices.add(e)}RemoveLeafVertex(e){this.leaf_vertices.delete(e)}AddLeafVertexEdge(e,t){let r=this.GetVertex(e,!0);return t.DependsOn(r),0}RemoveLeafVertexEdge(e,t){let r=this.GetVertex(e,!1);r&&(r.RemoveDependent(t),t.RemoveDependency(r))}InitializeGraph(){for(let e of this.dirty_list)this.IsSpreadsheetVertex(e)&&(e.TakeReferenceValue(),this.CheckVolatile(e)&&this.volatile_list.push(e)),e.dirty=!1;this.dirty_list=[]}Recalculate(){for(let e of this.volatile_list)this.SetVertexDirty(e);this.spill_data=this.spill_data.filter(({area:e,vertex:t})=>{if(t.dirty){t.Reset();let r=e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id)?.cells:void 0;if(r)for(let{cell:i,row:n,column:s}of r.IterateRC(new M(e.start,e.end)))i.spill&&(i.spill=void 0,typeof i.value>"u"&&i.Reset()),this.SetDirty({row:n,column:s,sheet_id:e.start.sheet_id});return!1}return!0}),this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let e=0;e<this.calculation_list.length;e++)this.calculation_list[e].Calculate(this);this.calculation_list=[]}};var da=o=>{let e={m:o,n:o,array:[]};for(let t=0;t<o;t++){let r=[];for(let i=0;i<o;i++)r.push({real:0,imaginary:0});e.array.push(r)}return e};var fa=o=>{let{r:e,theta:t}=o,r=e*Math.cos(t),i=e*Math.sin(t);return{real:r,imaginary:i}},dr=o=>{let e=Math.sqrt(o.real*o.real+o.imaginary*o.imaginary),t=Math.atan2(o.imaginary,o.real);return{r:e,theta:t}},Tn=o=>{let e={real:Math.sinh(o.real)*Math.cos(o.imaginary),imaginary:Math.cosh(o.real)*Math.sin(o.imaginary)},t={real:Math.cosh(o.real)*Math.cos(o.imaginary),imaginary:Math.sinh(o.real)*Math.sin(o.imaginary)};return Le(e,t)},Un=o=>Le({real:Math.tan(o.real),imaginary:Math.tanh(o.imaginary)},{real:1,imaginary:-(Math.tan(o.real)*Math.tanh(o.imaginary))}),Vn=o=>({real:Math.cosh(o.real)*Math.cos(o.imaginary),imaginary:Math.sinh(o.real)*Math.sin(o.imaginary)}),Dn=o=>({real:Math.cos(o.real)*Math.cosh(o.imaginary),imaginary:Math.sin(o.real)*Math.sinh(o.imaginary)}),In=o=>({real:Math.sinh(o.real)*Math.cos(o.imaginary),imaginary:Math.cosh(o.real)*Math.sin(o.imaginary)}),fr=o=>({real:Math.sin(o.real)*Math.cosh(o.imaginary),imaginary:Math.cos(o.real)*Math.sinh(o.imaginary)}),ui=o=>{if(o.imaginary===0)return{real:Math.asin(o.real),imaginary:0};let e=Math.hypot(o.real+1,o.imaginary)/2,t=Math.hypot(o.real-1,o.imaginary)/2,r=e+t,i=e-t,n={real:Math.asin(i),imaginary:Math.log(r+Math.sqrt(r*r-1))};return(o.imaginary<0||o.imaginary===0&&o.real>1)&&(n.imaginary=-n.imaginary),n},Fn=o=>{if(o.imaginary===0)return{real:Math.acos(o.real),imaginary:0};let e=ui(o);return{real:Math.PI/2-e.real,imaginary:e.imaginary}},Ln=o=>{let{real:e,imaginary:t}=o;if(e===0){if(t>1)return{real:Math.PI/2,imaginary:.5*Math.log((t-1)/(t+1))};if(t<-1)return{real:-Math.PI/2,imaginary:.5*Math.log((1-t)/(-1-t))}}let r=e*e,i=t*t,n=.5*Math.atan2(2*e,1-r-i),s=.25*Math.log((r+(t+1)*(t+1))/(r+(t-1)*(t-1)));return{real:n,imaginary:s}},Nn=(o,e)=>{if(e.real===0&&e.imaginary===0&&o.real===0&&o.imaginary===0)return!1;let t=e.real*e.real+e.imaginary*e.imaginary,r={real:(o.real*e.real+o.imaginary*e.imaginary)/t,imaginary:(o.imaginary*e.real-o.real*e.imaginary)/t},i=r.real*r.real,n=r.imaginary*r.imaginary,s={real:.5*Math.atan2(2*r.real,1-i-n),imaginary:.25*Math.log((i+(r.imaginary+1)*(r.imaginary+1))/(i+(r.imaginary-1)*(r.imaginary-1)))};return e.real<0&&(s.real+=o.real>=0||o.imaginary>=0?Math.PI:-Math.PI),s},Pn=(...o)=>{let e=o.shift();if(!e)return{real:0,imaginary:0};for(let t of o)e=$(e,t);return e},$=(o,e)=>({real:o.real*e.real-o.imaginary*e.imaginary,imaginary:o.real*e.imaginary+o.imaginary*e.real}),ma=(o,e)=>{let t=[];for(let r=0;r<o.m;r++){let i=[];for(let n=0;n<o.n;n++)i.push(o.array[r][n]+e.array[r][n]);t.push(i)}return{m:o.m,n:o.n,array:t}},li=(o,e)=>{let t=[];for(let r=0;r<o.m;r++){let i=[];for(let n=0;n<e.n;n++){let s=0;for(let a=0;a<o.n;a++)s+=o.array[r][a]*e.array[a][n];i.push(s)}t.push(i)}return{array:t,m:o.m,n:e.n}},zn=(o,e)=>{let t=[];for(let r=0;r<o.m;r++){let i=[];for(let n=0;n<e.n;n++){let s={real:0,imaginary:0};for(let a=0;a<o.n;a++)s.real+=o.array[r][a].real*e.array[a][n].real-o.array[r][a].imaginary*e.array[a][n].imaginary,s.imaginary+=o.array[r][a].real*e.array[a][n].imaginary+o.array[r][a].imaginary*e.array[a][n].real;i.push(s)}t.push(i)}return t},mr=o=>{let e={real:0,imaginary:0},t=o.n;if(t==2){let i=$(o.array[0][0],o.array[1][1]),n=$(o.array[1][0],o.array[0][1]);return{real:i.real-n.real,imaginary:i.imaginary-n.imaginary}}let r=da(o.n);for(let i=0;i<t;i++){let n=0;for(let l=1;l<t;l++){let u=0;for(let c=0;c<t;c++)c!=i&&(r.array[n][u]={...o.array[l][c]},u++);n++}r.m=r.n=t-1;let s=Math.pow(-1,i),a=$({real:o.array[0][i].real*s,imaginary:o.array[0][i].imaginary*s},mr(r));e.real+=a.real,e.imaginary+=a.imaginary}return e};var pa=o=>{let e={real_values:!1,imaginary_values:!1,square:o.m===o.n,unit_diagonal:!0},t={m:o.m,n:o.n,array:[]},r={m:o.m,n:o.n,array:[]};for(let i=0;i<o.m;i++){let n=o.array[i],s=[],a=[];for(let l=0;l<o.n;l++)n[l].real&&(e.real_values=!0),n[l].imaginary&&(e.imaginary_values=!0),l===i&&e.unit_diagonal&&(n[l].real!==1||n[l].imaginary!==0)&&(e.unit_diagonal=!1),s.push(n[l].real),a.push(n[l].imaginary);t.array.push(s),r.array.push(a)}return{real:t,imaginary:r,flags:e}},_a=o=>{let e=o.array.map(t=>t.slice(0));return{m:o.m,n:o.n,array:e}},En=o=>{if(o.m!==o.n)return;let e=_a(o),t=e.array,r=0,i=0,n=0,s=0,a=o.m;for(i=1;i<a;i++)t[0][i]/=t[0][0];for(i=1;i<a;i++){for(n=i;n<a;n++){for(r=0,s=0;s<i;s++)r+=t[n][s]*t[s][i];t[n][i]-=r}if(i!=a-1)for(n=i+1;n<a;n++){for(r=0,s=0;s<i;s++)r+=t[i][s]*t[s][n];t[i][n]=(t[i][n]-r)/t[i][i]}}for(i=0;i<a;i++)for(n=i;n<a;n++){let l=1;if(i!=n)for(l=0,s=i;s<n;s++)l-=t[n][s]*t[s][i];t[n][i]=l/t[n][n]}for(i=0;i<a;i++)for(n=i;n<a;n++)if(i!=n){for(r=0,s=i;s<n;s++)r+=t[s][n]*(i==s?1:t[i][s]);t[i][n]=-r}for(i=0;i<a;i++)for(n=0;n<a;n++){for(r=0,s=i>n?i:n;s<a;s++)r+=(n==s?1:t[n][s])*t[s][i];t[n][i]=r}return e},On=o=>{let e=[];if(o.m!==o.n)return;let{real:t,imaginary:r,flags:i}=pa(o),n=En(t);if(!n)return;if(!i.imaginary_values){for(let h=0;h<o.m;h++){let f=[];for(let d=0;d<o.n;d++)f.push({real:n.array[h][d],imaginary:0});e.push(f)}return e}let s=li(n,r),a=li(r,s),l=ma(t,a),u=En(l);if(!u)return;let c=li(s,u);for(let h=0;h<o.m;h++){let f=[];for(let d=0;d<o.n;d++)f.push({real:u.array[h][d],imaginary:-c.array[h][d]});e.push(f)}return e},Le=(o,e)=>{let t={real:e.real,imaginary:-e.imaginary},r=$(o,t),i=$(e,t);return{real:r.real/i.real,imaginary:r.imaginary/i.real}},At=o=>{let e=o.real||0,t=o.imaginary||0;return $({real:Math.exp(e),imaginary:0},{real:Math.cos(t),imaginary:Math.sin(t)})},ci=o=>{let e=dr(o);return{real:Math.log(e.r),imaginary:e.theta}},oe=(o,e)=>{if(e.imaginary)return At($(e,ci(o)));{let t=dr(o);return fa({r:Math.pow(t.r,e.real),theta:t.theta*e.real})}};var Gn=(o,e=0)=>o&&o.type===7?o:{type:7,value:{real:e,imaginary:0}},Xe=o=>o.imaginary?{type:7,value:o}:{type:3,value:o.real},Ye=(o,e)=>{if(o.type===6)return[0,0,o];if(e.type===6)return[0,0,e];let t=[0,0];switch(o.type){case 3:t[0]=o.value;break;case 4:t[0]=o.value?1:0;break;case 0:break;case 7:t[3]=o;break;default:return[0,0,E()]}switch(e.type){case 3:t[1]=e.value;break;case 4:t[1]=e.value?1:0;break;case 0:break;case 7:t[4]=e;break;default:return[0,0,E()]}return(t[3]||t[4])&&(t[3]=Gn(t[3],t[0]),t[4]=Gn(t[4],t[1])),t},ba=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);return i||(n&&s?Xe({real:n.value.real+s.value.real,imaginary:n.value.imaginary+s.value.imaginary}):{value:t+r,type:3})},fi=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);return i||(n&&s?Xe({real:n.value.real-s.value.real,imaginary:n.value.imaginary-s.value.imaginary}):{value:t-r,type:3})},ya=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);if(i)return i;if(n&&s)return Xe(oe(n.value,s.value));let a=Math.pow(t,r);return isNaN(a)?E():{type:3,value:a}},ga=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);if(i)return i;if(n&&s)return Xe(oe(n.value,s.value));if(t<0&&r!==0&&Math.abs(r)<1)return Xe(oe({real:t,imaginary:0},{real:r,imaginary:0}));let a=Math.pow(t,r);return isNaN(a)?E():{type:3,value:a}},hi=ya,va=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);return i||(n&&s?Xe($(n.value,s.value)):{value:t*r,type:3})},wa=(o,e)=>{let[t,r,i,n,s]=Ye(o,e);return i||(n&&s?s.value.real===0&&s.value.imaginary===0?se():Xe(Le(n.value,s.value)):r===0?se():{value:t/r,type:3})},xa=(o,e)=>{let[t,r,i]=Ye(o,e);return i||(r===0?se():{value:t%r,type:3})},di=(o,e)=>o.type===6?o:e.type===6?e:o.type===0&&(e.value===""||e.value===0||e.type===7&&e.value.real===0&&e.value.imaginary===0)||e.type===0&&(o.value===""||o.value===0||o.type===7&&o.value.real===0&&o.value.imaginary===0)?{type:4,value:!0}:o.type===7?e.type===7?{type:4,value:o.value.imaginary===e.value.imaginary&&o.value.real===e.value.real}:{type:4,value:!o.value.imaginary&&o.value.real===e.value}:e.type===7?{type:4,value:!e.value.imaginary&&o.value===e.value.real}:o.type===2&&e.type===2?{type:4,value:o.value.toLowerCase()===e.value.toLowerCase()}:{type:4,value:o.value==e.value},Bn=(o,e)=>{let t=di(o,e);return t.type===6?t:{type:4,value:!t.value}},Ca=(o,e)=>o.type===6?o:e.type===6?e:o.type===7||e.type===7?E():{type:4,value:(o.value||0)>(e.value||0)},mi=(o,e)=>!(o.type===7||o.type===8||o.type===9||o.type===5||e.type===7||e.type===8||e.type===9||e.type===5),Sa=(o,e)=>o.type===6?o:e.type===6?e:mi(o,e)?{type:4,value:(o.value||0)>=(e.value||0)}:E(),Aa=(o,e)=>o.type===6?o:e.type===6?e:mi(o,e)?{type:4,value:(o.value||0)<(e.value||0)}:E(),Ra=(o,e)=>o.type===6?o:e.type===6?e:mi(o,e)?{type:4,value:(o.value||0)<=(e.value||0)}:E(),Hn=()=>{hi=ga},qn=o=>{switch(o){case"+":return ba;case"-":return fi;case"*":return va;case"/":return wa;case"^":return hi;case"**":return hi;case"%":return xa;case"=":return di;case"==":return di;case"!=":return Bn;case"<>":return Bn;case">":return Ca;case">=":return Sa;case"<":return Aa;case"<=":return Ra}};var et=o=>!Array.isArray(o)&&o.type===5&&!!o.value.type,Y=o=>o.type===5&&o.key==="metadata",lt=class{constructor(e,t,r){this.data_model=e;this.library=t;this.parser=r}context={address:{row:-1,column:-1},volatile:!1,bindings:[]};Calculate(e,t,r,i=!1){return i||(this.context.address=t,this.context.volatile=!1,this.context.area=r),{value:this.CalculateExpression(e),volatile:this.context.volatile}}CellFunction2(e){if(!e.sheet_id)if(e.sheet)e.sheet_id=this.data_model.sheets.ID(e.sheet)||0;else return()=>z();let t=this.data_model.sheets.Find(e.sheet_id)?.cells;if(!t)return console.warn("missing cells reference @ "+e.sheet_id),()=>z();let r=t.GetCell(e);return r?e.spill&&r.spill&&r.spill.start.row===e.row&&r.spill.start.column===e.column?()=>r.spill?t.GetRange4(r.spill.start,r.spill.end,!0)||z():kn():()=>r.GetValue4():()=>({type:3,value:0})}CellFunction4(e,t){return e.sheet_id?this.data_model.sheets.Find(e.sheet_id)?.cells?.GetRange4(e,t,!0)||z():z()}GetMetadata(e,t){let r,i;switch(e.type){case"address":if(e.spill){let n;if(e.sheet_id&&(n=this.data_model.sheets.Find(e.sheet_id)),!n)return console.error("missing sheet [da6]"),z();let s=n.CellData(e);s.spill&&(i=s.spill)}else r=e;break;case"range":i=e;break;case"structured-reference":{let n=this.data_model.ResolveStructuredReference(e,this.context.address);n&&(n.type==="address"?r=n:n.type==="range"&&(i=n))}break;case"identifier":{let n=this.data_model.GetName(e.name,this.context.address.sheet_id||0);n?.type==="range"&&(n.area.count===1?r=n.area.start:i=n.area)}break;case"call":{let n=this.CalculateExpression(e,!0);if(et(n))if(n.value.type==="address")r=n.value;else if(n.value.type==="range")i=n.value;else return n;else return n}break;default:return this.CalculateExpression(e)}if(r){let n;if(r.sheet_id&&(n=this.data_model.sheets.Find(r.sheet_id)),!n)return console.error("missing sheet [ac8]"),z();let s=n.CellData(r),a=s.calculated_type?s.calculated:s.value,l={type:"metadata",address:{...r,position:0,id:0,type:"address",label:new M(r).spreadsheet_label},value:a,format:s.style?s.style.number_format:void 0,...t(s,r)};return{type:5,value:l,key:"metadata"}}else if(i){if(i.start.row===1/0||i.start.column===1/0)return z();let n;if(i.start.sheet_id&&(n=this.data_model.sheets.Find(i.start.sheet_id)),!n)throw new Error("missing sheet [ac9]");let s=[];for(let a=i.start.column;a<=i.end.column;a++){let l=[];for(let u=i.start.row;u<=i.end.row;u++){let c=n.CellData({row:u,column:a});r={...i.start,row:u,column:a};let h=c.calculated_type?c.calculated:c.value,f={type:"metadata",address:r,value:h,format:c.style?c.style.number_format:void 0,...t(c,r)};l.push({type:5,value:f,key:"metadata"})}s.push(l)}return{type:8,value:s}}return this.CalculateExpression(e)}RewriteMacro(e,t){let r;switch(e.type){case"identifier":if(r=t[e.name.toUpperCase()],r)return JSON.parse(JSON.stringify(r));break;case"binary":e.left=this.RewriteMacro(e.left,t),e.right=this.RewriteMacro(e.right,t);break;case"unary":e.operand=this.RewriteMacro(e.operand,t);break;case"group":e.elements=e.elements.map(i=>this.RewriteMacro(i,t));break;case"call":e.args=e.args.map(i=>this.RewriteMacro(i,t));break}return e}CallMacro(e,t){if(!t.expression)return()=>ee();let r=JSON.stringify(t.expression),i={},n=t.argument_names?.map(s=>s.toUpperCase())||[];return s=>{let a=JSON.parse(r);for(let l=0;l<n.length;l++)i[n[l]]=s.args[l]||{type:"missing",id:0};return this.CalculateExpression(this.RewriteMacro(a,i))}}ImplicitCall(){return e=>{e.type==="call"&&(e={type:"implicit-call",args:e.args,call:{type:"identifier",name:e.name,position:e.position,id:0},position:e.position,id:0});let t=this.CalculateExpression(e.call);if(t.type===10){let r=t.value;if(!r.func||!r.bindings)return ee();let i={};for(let s=0;s<r.bindings.length;s++){let a=r.bindings[s];if(a?.type==="identifier")i[a.name.toUpperCase()]=e.args[s]||{type:"missing"};else return ee()}let n=JSON.parse(JSON.stringify(r.func));return this.parser.Walk2(n,s=>{if(s.type==="identifier"){let a=s.name.toUpperCase(),l=i[a];if(l)return JSON.parse(JSON.stringify(l))}return!0}),this.CalculateExpression(n)}return ee()}}NormalizeBindings(e){let t={};for(let[r,i]of Object.entries(e))t[r.toUpperCase()]=i;return t}CallExpression(e,t=!1){let r=this.library.Get(e.name);if(!r){let i=e.name.toUpperCase();return this.LookupBinding(i)?this.ImplicitCall():this.data_model.GetName(i,this.context.address.sheet_id||0)?this.ImplicitCall():()=>St()}return i=>{this.context.volatile=this.context.volatile||!!r.volatile;let n=e.name.toLowerCase()==="if",s=-1,a,l=i.args,u=r.arguments||[],c;r.create_binding_context&&(c=r.create_binding_context.call(0,{args:i.args,descriptors:u}),c?(l=c.args,c.argument_descriptors&&(u=c.argument_descriptors),this.context.bindings.unshift(this.NormalizeBindings(c.context))):a=R());let h=l.map((d,m)=>{if(a)return;let _=u[Math.min(m,u.length-1)]||{};if(_.passthrough)return d;if(m===s)return _.boxed?{type:0}:void 0;if(typeof d>"u")return n&&m===0&&(s=1),_.boxed?{type:0}:void 0;if(_.address)return _.boxed?{type:2,value:this.parser.Render(d).replace(/\\$/g,"")}:this.parser.Render(d).replace(/\\$/g,"");if(_.metadata)return this.GetMetadata(d,()=>({}));{let y=this.CalculateExpression(d);if(y.type===6){if(_.allow_error)return y;a=y;return}if(n&&m===0&&y.type!==8){let v=!1;if(y.type===2){let w=y.value.toLowerCase().trim();v=w!=="false"&&w!=="f"}else v=!!y.value;s=v?2:1}return _.boxed?y:y.type===8?y.value.map(v=>v.map(w=>w.value)):y.value}});if(c&&this.context.bindings.shift(),a)return a;let f={address:{...this.context.address},area:this.context.area?{start:{...this.context.area.start},end:{...this.context.area.end}}:void 0};if(r.return_type==="reference"){let d=r.fn.apply(f,h);if(t)return d;if(et(d)){if(d.value.type==="address")return this.CellFunction2(d.value)();if(d.value.type==="range")return this.CellFunction4(d.value.start,d.value.end)}return d}return r.fn.apply(f,h)}}ResolveStructuredReference(e){let t=this.data_model.ResolveStructuredReference(e,this.context.address);if(t){if(t.type==="address")return this.CellFunction2(t);if(t.type==="range")return()=>this.CellFunction4(t.start,t.end)}return()=>z()}ResolveDimensionedQuantity(){return e=>{let t=this.CalculateExpression(e.expression);return{type:9,value:{value:t.value,unit:e.unit.name}}}}UnaryExpression(e,t=!1){switch(e.operator){case"+":return r=>this.CalculateExpression(r.operand);case"-":{let r=fi,i={type:3,value:0};return n=>{let s=this.CalculateExpression(n.operand);return s.type===8?{type:8,value:s.value.map(a=>a.map(l=>r(i,l)))}:r(i,s)}}case"@":return r=>{let i;switch(r.operand.type){case"address":if(r.operand.spill){let s=this.CellFunction2(r.operand)();if(s.type===8){let a=this.context.address.row??-1,l=this.context.address.column??-1;if(a>=r.operand.row&&a<r.operand.row+s.value[0]?.length&&s.value.length===1){if(!t)return s.value[0][a-r.operand.row];i={...r.operand,row:a,spill:!1}}else if(l>=r.operand.column&&l<r.operand.column+s.value.length&&s.value[0]?.length===1){if(!t)return s.value[l-r.operand.column][0];i={...r.operand,column:l,spill:!1}}else return E()}}break;case"range":{let s=this.context.address.row??-1,a=this.context.address.column??-1;if(s>=r.operand.start.row&&s<=r.operand.end.row&&r.operand.start.column===r.operand.end.column)i={...r.operand.start,row:s,spill:!1};else if(a>=r.operand.start.column&&a<=r.operand.end.column&&r.operand.start.row===r.operand.end.row)i={...r.operand.start,column:a,spill:!1};else return E()}}if(i)return t?{type:5,value:i}:this.CellFunction2(i)();let n=this.CalculateExpression(r.operand);return n.type===8?n.value[0][0]:n};default:return()=>(console.warn("unexpected unary operator:",e.operator),ee())}}RecycleArray(e,t,r){if(e[0].length<r){let i=e[0].length;for(let n of e)for(let s=i;s<r;s++)n[s]=n[s%i]}if(e.length<t){let i=e.length;for(let n=i;n<t;n++)e[n]=e[n%i].slice(0)}return e}ElementwiseBinaryExpression(e,t,r){let i=Math.max(t.value.length,r.value.length),n=Math.max(t.value[0].length,r.value[0].length),s=this.RecycleArray(t.value,i,n),a=this.RecycleArray(r.value,i,n),l=[];for(let u=0;u<i;u++){let c=[];for(let h=0;h<n;h++)c[h]=e(s[u][h]||{type:0},a[u][h]||{type:0});l.push(c)}return{type:8,value:l}}AsReference(e){switch(e.type){case"address":return e;case"range":if(e.start.row===e.end.row&&e.start.column===e.end.column)return e.start;break;default:{let t=this.CalculateExpression(e,!0);if(et(t)){if(t.value.type==="address")return t.value;if(t.value.type==="range"&&t.value.start.row===t.value.end.row&&t.value.start.column===t.value.end.column)return t.value.start}}break}}BinaryExpression(e){let t=e.operator==="&"?(r,i)=>{if(r.type===6)return r;if(i.type===6)return i;let n=[r,i].map(s=>s.type===0?"":s.type===4?s.value?this.data_model.language_model?.boolean_true||"TRUE":this.data_model.language_model?.boolean_false||"FALSE":s.value);return{type:2,value:`${n[0]}${n[1]}`}}:qn(e.operator);return t?r=>{let i=this.CalculateExpression(r.left),n=this.CalculateExpression(r.right);return i.type===8?n.type===8?this.ElementwiseBinaryExpression(t,i,n):this.ElementwiseBinaryExpression(t,i,{type:8,value:[[n]]}):n.type===8?this.ElementwiseBinaryExpression(t,{type:8,value:[[i]]},n):t(i,n)}:e.operator===":"?r=>{let i=this.AsReference(r.left),n=this.AsReference(r.right);return i&&n?this.CellFunction4(i,n):ee()}:()=>(console.info(`(unexpected binary operator: ${e.operator})`),ee())}Identifier(e){let t=e.name;if(t[0]==="#")return()=>z();let r=t.toUpperCase();switch(r){case"FALSE":case"F":return()=>({value:!1,type:4});case"TRUE":case"T":return()=>({value:!0,type:4});case"UNDEFINED":return()=>({value:void 0,type:0})}return()=>{let i=this.LookupBinding(r);if(i)return this.CalculateExpression(i);let n=this.data_model.GetName(r,this.context.address.sheet_id||0);switch(n?.type){case"range":return n.area.count===1?this.CellFunction4(n.area.start,n.area.start):this.CellFunction4(n.area.start,n.area.end);case"expression":return this.CalculateExpression(n.expression)}return St()}}LookupBinding(e){e=e.toUpperCase();for(let t of this.context.bindings){let r=t[e];if(r)return r}}GroupExpression(e){return!e.elements||e.elements.length!==1?(console.warn("Can\'t handle group !== 1"),()=>ee()):t=>this.CalculateExpression(t.elements[0])}CalculateExpression(e,t=!1){if(e.fn)return e.fn(e);switch(e.type){case"implicit-call":return(e.fn=this.ImplicitCall())(e);case"call":{let r=this.data_model.macro_functions.get(e.name.toUpperCase());return r?(e.fn=this.CallMacro(e,r))(e):(e.fn=this.CallExpression(e,t))(e)}case"address":return(e.fn=this.CellFunction2(e))();case"range":return(e.fn=r=>this.CellFunction4(r.start,r.end))(e);case"binary":return(e.fn=this.BinaryExpression(e))(e);case"unary":return(e.fn=this.UnaryExpression(e,t))(e);case"identifier":return(e.fn=this.Identifier(e))();case"missing":return(e.fn=()=>({value:void 0,type:0}))();case"dimensioned":return(e.fn=this.ResolveDimensionedQuantity())(e);case"literal":{let r={value:e.value,type:re(e.value)};return(e.fn=()=>r)()}case"group":return(e.fn=this.GroupExpression(e))(e);case"complex":{let r={value:{real:e.real,imaginary:e.imaginary},type:7};return(e.fn=()=>r)()}case"structured-reference":return(e.fn=this.ResolveStructuredReference(e))();case"array":return(e.fn=()=>({type:8,value:e.values.map(r=>(Array.isArray(r)?r:[r]).map(i=>({type:re(i),value:i})))}))();default:return console.warn("Unhandled parse expr:",e),ur()}}};var Yf=1e3*60*60*24;var Ne=o=>{let e=[],t=o.length,r=o[0].length;for(let i=0;i<r;i++){e[i]=[];for(let n=0;n<t;n++)e[i][n]=o[n][i]}return e},Rt=o=>{if(!o)return[];if(typeof o[0]>"u")return[];let e=[],t=o.length,r=o[0].length;for(let i=0;i<r;i++){e[i]=[];for(let n=0;n<t;n++)e[i][n]=o[n][i]}return e};var J=o=>{let e=[];for(let t of o)if(t?.type===8)for(let r of t.value)e=e.concat(J(r));else e.push(t);return e},L=(o,e=!1)=>Array.isArray(o)?o.reduce((t,r)=>typeof r>"u"&&!e?t:Array.isArray(r)?t.concat(L(r,e)):r instanceof Float32Array||r instanceof Float64Array?t.concat(Array.from(r)):t.concat([r]),[]):[o],q=o=>L(o).filter(e=>typeof e=="number"),pi=(o,e=!1)=>e?o.map(t=>{switch(typeof t){case"number":case"undefined":case"string":case"boolean":return t}}):o.filter(t=>{switch(typeof t){case"number":case"undefined":case"string":case"boolean":return!0}return!1}),Ma=o=>!!o&&typeof o=="object"&&o.type===8,$n=(o,e)=>(...t)=>{let r=[],i=[];for(let[n,s]of t.entries())if(s&&o[n]){let a=Array.isArray(s)?s:Ma(s)?s.value:void 0;a&&(r[n]=a,i.length||(i=a))}return r.length?{type:8,value:i.map((n,s)=>n.map((a,l)=>{let u=t.map((c,h)=>r[h]?r[h][s][l]??{type:0}:c);return e(...u)}))}:e(...t)},Mt=o=>{let e=[],t=o.length,r="[\\\\^$.|?*+()";for(let i=0;i<t;i++){let n=o[i];switch(n){case"*":e.push(".","*");break;case"?":e.push(".");break;case"~":n=o[++i]||"";default:for(let s=0;s<r.length;s++)if(n===r[s]){e.push("\\\\");break}e.push(n);break}}return e.join("")},Jn=o=>({type:2,value:o});var _r=class{functions={};Register(...e){for(let t of e)for(let r of Object.keys(t)){if(/[^a-zA-Z0-9._]/.test(r))throw new Error("invalid function name (invalid character)");if(r.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(r))throw new Error("invalid function name (start with an ascii letter)");let i=r.toLowerCase();if(this.functions[i])throw new Error(`function name (${i}) is already in use`);let n=t[r];if(n.canonical_name=r,!n.unrolled){let s=n.arguments?.map(a=>!!a.unroll);s?.some(a=>!!a)&&(n.fn=$n(s,n.fn),n.unrolled=!0)}this.functions[i]=n}}Get(e){let t=e.toLowerCase();return this.functions[t]}List(e=!0){let t={};for(let r of Object.keys(this.functions))e&&this.functions[r].visibility==="internal"||(t[r]=this.functions[r]);return t}Alias(e,t){let r=this.Get(t);if(!r)throw new Error(`referenced function ${t} does not exist`);this.Register({[e]:{...r}})}};var Et=class{static default_color="#888";static UnpackValues(e){if(Array.isArray(e)){let t=e[0];return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array?e.reduce((r,i)=>r.concat(this.UnpackValues(i)),[]):e.map(r=>isNaN(r)?void 0:r)}else{if(e instanceof Float32Array||e instanceof Float64Array)return Array.prototype.slice.call(e);if(e&&typeof e=="object"){let r=Object.keys(e).length;if(typeof e[0]<"u"&&typeof e[(r-1).toString()]<"u"){let i=[];for(let n=0;n<r;n++)i[n]=e[n.toString()];return i}}}return[]}static SparklineCommon(e,t){let r=[],i=ie(t.text)?t.text.text:this.default_color,n=[i,i];return Array.isArray(e.calculated)&&(r=this.UnpackValues(e.calculated[0]),typeof e.calculated[1]=="string"&&(n[0]=e.calculated[1]),typeof e.calculated[2]=="string"&&(n[1]=e.calculated[2])),{values:r,colors:n}}static RenderLine(e,t,r,i,n){let{values:s,colors:a}=this.SparklineCommon(i,n),l=.05,u=.1,c=1;Array.isArray(i.calculated)&&typeof i.calculated[2]=="number"&&(c=i.calculated[2]);let h=0,f=0,d=-1;for(let m=0;m<s.length;m++){let _=s[m];typeof _=="number"&&(d>=0?(h=Math.min(h,_),f=Math.max(f,_)):(d=m,h=f=_))}if(h===f&&(h&&(h-=1),f+=1),h!==f){let m=e*(1-2*l)/(s.length-1),_=f-h,y=t*(1-2*u),v=t*u;r.strokeStyle=a[0],r.lineWidth=c,r.lineCap="round",r.lineJoin="round",r.beginPath();let w=0;for(let x=d;x<s.length;x++){let C=s[x];if(typeof C=="number"){let A=e*l+m*x,S=t-(C-h)*y/_-v;w===0?(r.moveTo(A,S),w=1):r.lineTo(A,S)}else w=0}r.stroke()}}static RenderColumn(e,t,r,i,n){let{values:s,colors:a}=this.SparklineCommon(i,n),l=3,u=2.5,c=0,h=0,f=!1;for(let d of s)typeof d=="number"&&(f?(c=Math.min(c,d),h=Math.max(h,d)):(f=!0,c=h=d));if(c===h&&(c&&(c-=1),h+=1),s.length){let d=(e-2*l-2)/(s.length-0),m=t-2*u,_=u;if(c!==h)if(c<0&&h>0){let y=h-c,v=_+h/y*m;for(let w=0;w<s.length;w++){let x=s[w];if(typeof x=="number"){let C=l+w*d,A=Math.abs(x)/y*m;if(x>=0){r.fillStyle=a[0];let S=v-A;r.fillRect(C+2,S,d-2,A)}else{r.fillStyle=a[1];let S=v;r.fillRect(C+2,S,d-2,A)}}}}else if(h>0){r.fillStyle=a[0];let y=h-c;for(let v=0;v<s.length;v++){let w=s[v];if(typeof w=="number"){let x=l+v*d,C=Math.max(1,(w-c)/y*m),A=t-_-C;r.fillRect(x+2,A,d-2,C)}}}else{r.fillStyle=a[1];let y=h-c;for(let v=0;v<s.length;v++){let w=s[v];if(typeof w=="number"){let x=l+v*d,C=Math.max(1,Math.abs(h-w)/y*m),A=_;r.fillRect(x+2,A,d-2,C)}}}}}};var Wn=o=>{let{x:e,y:t,width:r,height:i,cell:n}=o,s={},a=3,l=Math.round(16*(o.scale||1));if(n&&r&&i&&e&&t){let u={x:a,y:i-a-l};if(n.style){switch(n.style.vertical_align){case"top":u.y=a;break;case"middle":u.y=Math.round((i-l)/2);break}switch(n.style.horizontal_align){case"right":u.x=Math.round(r-a-l);break;case"center":u.x=Math.round((r-l)/2);break}}e>=u.x&&e<=u.x+l&&t>=u.y&&t<=u.y+l&&(s.value=`=Checkbox(${n.calculated?"FALSE":"TRUE"})`,s.block_selection=!0)}return s},Qn=o=>{let{context:e,width:t,height:r,cell:i}=o,n=o.scale||1;e.lineJoin="round",e.lineCap="round";let s=3*n,a=16*n,l=s,u=r-s-a;if(i.style){switch(i.style.vertical_align){case"top":u=s;break;case"middle":u=(r-a)/2;break}switch(i.style.horizontal_align){case"right":l=t-s-a;break;case"center":l=(t-a)/2;break}}l=Math.floor(l)+.5,u=Math.floor(u)+.5;let c=Math.floor(l+a)+.5,h=Math.floor(u+a)+.5;if(i&&i.calculated){e.lineWidth=.5,e.fillStyle=e.strokeStyle,e.beginPath(),e.moveTo(l,u),e.lineTo(l+16*n,u),e.lineTo(l+16*n,u+16*n),e.lineTo(l,u+16*n),e.closePath(),e.moveTo(l+15*n,u+4*n);for(let f of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])e.lineTo(l+f[0]*n,u+f[1]*n);e.closePath(),e.fill()}else e.lineWidth=1,e.lineJoin="round",e.beginPath(),e.moveTo(l,u),e.lineTo(c,u),e.lineTo(c,h),e.lineTo(l,h),e.closePath(),e.stroke();return{handled:!0}};var Pe=o=>{switch(o.type){case 7:return o.value;case 3:return{real:o.value,imaginary:0};case 4:return{real:o.value?1:0,imaginary:0};case 0:return{real:0,imaginary:0}}return!1};var Zn=(o,e,t)=>{let r=new Date;return r.setMilliseconds(0),r.setSeconds(0),r.setMinutes(0),r.setHours(0),o<0||o>1e4||(o<1899&&(o+=1900),r.setFullYear(o),e<1||e>12)||(r.setMonth(e-1),t<1||t>31)?!1:(r.setDate(t),we(r.getTime()))};var Kn=(o,e)=>{let t=new Date(Be(o)),r=t.getUTCMonth()+e,i=t.getUTCFullYear();for(t.setUTCHours(12),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0);r<0;)r+=12,i--;for(;r>11;)r-=12,i++;if(t.setUTCMonth(r),t.setUTCFullYear(i),t.getUTCMonth()!==r){let s=t.getUTCDate();t=new Date(t.getTime()-s*86400*1e3)}return t},Xn=[{name:"Lookup value"},{name:"Table"},{name:"Result index"},{name:"Inexact",default:!0}],Yn=(o,e,t,r=!0,i=!1)=>{if(i&&(e=Rt(e)),t=Math.max(0,t-1),r){let n=e[t][0];if(typeof o=="number"){let s=Number(e[0][0]);if(isNaN(s)||s>o)return ue();for(let a=1;a<e[0].length&&(s=Number(e[0][a]),!(isNaN(s)||s>o));a++)n=e[t][a]}else{o=(o||"").toString().toLowerCase();let s=(e[0][0]||"").toString().toLowerCase();if(s.localeCompare(o)>0)return ue();for(let a=1;a<e[0].length&&(s=(e[0][a]||"").toString().toLowerCase(),!(s.localeCompare(o)>0));a++)n=e[t][a]}return G(n)}else{for(let n=0;n<e[0].length;n++)if(e[0][n]==o)return G(e[t][n]);return ue()}},br=(o,e=!1)=>{if(!o)return e;switch(o.type){case 3:return o.value;case 0:return e}return!1},Me=(o,e,t)=>({description:t,arguments:[{name:"number",boxed:!0,unroll:!0}],fn:r=>r.type===3?{type:3,value:o(r.value)}:r.type===7?{type:7,value:e(r.value)}:R()}),_i={Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:o=>{if(o.type===7){let e=oe(o.value,{real:.5,imaginary:0});return X(e)}else{if(o.type===0||!o.value)return{type:3,value:0};if(o.type===3&&o.value<0){let e=oe({real:o.value,imaginary:0},{real:.5,imaginary:0});return{type:7,value:e}}else if(o.type===3){let e=Math.sqrt(o.value);return isNaN(e)?E():{type:3,value:e}}else return E()}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(o,e)=>{if(o.type===3&&e.type===3&&(o.value>=0||e.value===0||Math.abs(e.value)>=1)){let i=Math.pow(o.value,e.value);return isNaN(i)?E():{type:3,value:i}}let t=Pe(o),r=Pe(e);if(t&&r){let i=oe(t,r);return X(i)}return E()}}},ut={True:{fn:()=>({type:4,value:!0})},False:{fn:()=>({type:4,value:!1})},Int:{fn:o=>({type:3,value:Math.floor(o)})},Rand:{volatile:!0,fn:()=>({type:3,value:Math.random()})},RandArray:{volatile:!0,arguments:[{name:"rows"},{name:"columns"},{name:"min"},{name:"max"},{name:"integer"}],description:"Returns an array of uniformly-distributed random numbers",fn:(o=1,e=1,t=0,r=1,i=!1)=>{let n=[];if(i){let s=r-t+1;for(let a=0;a<o;a++){let l=[];for(let u=0;u<e;u++)l.push({type:3,value:Math.floor(Math.random()*s+t)});n.push(l)}}else{let s=r-t;for(let a=0;a<o;a++){let l=[];for(let u=0;u<e;u++)l.push({type:3,value:Math.random()*s+t});n.push(l)}}return{type:8,value:n}}},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(o=0,e=1)=>{if(o>e){let t=o;o=e,e=t}return{type:3,value:Math.floor(Math.random()*(e+1-o)+o)}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...o)=>{let e={real:0,imaginary:0},t=J(o);for(let r of t)switch(r.type){case 3:e.real+=r.value;break;case 4:break;case 7:e.real+=r.value.real,e.imaginary+=r.value.imaginary;break;case 6:return r}return X(e)}},SumSQ:{description:"Returns the sum of the squares of all arguments",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...o)=>{let e={real:0,imaginary:0},t=J(o);for(let r of t)switch(r.type){case 3:e.real+=r.value*r.value;break;case 4:break;case 7:{let i=$(r.value,r.value);e.real+=i.real,e.imaginary+=i.imaginary}break;case 6:return r}return X(e)}},EDate:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(o,e=0)=>{if(typeof o!="number"||typeof e!="number")return R();let t=Kn(o,e);return{type:3,value:we(t.getTime(),!1)}}},EOMonth:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(o,e=0)=>{if(typeof o!="number"||typeof e!="number")return R();let t=Kn(o,e);switch(t.getUTCMonth()){case 1:{let i=t.getUTCFullYear();i%4===0&&(i===1900||i%400===0||i%100!==0)?t.setUTCDate(29):t.setUTCDate(28)}break;case 0:case 2:case 4:case 6:case 7:case 9:case 11:t.setUTCDate(31);break;default:t.setUTCDate(30);break}return{type:3,value:we(t.getTime(),!1)}}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:3,value:we(new Date().getTime())})},YearFrac:{description:"Returns the fraction of a year between two dates",arguments:[{name:"Start"},{name:"End"},{name:"Basis",default:0}],fn:(o,e,t)=>{if(e<o){let n=o;o=e,e=n}let r=Math.max(0,e-o),i=360;if(t&&t<0||t>4)return R();switch(t){case 1:break;case 2:break;case 3:i=365;break}return{type:3,value:r/i}}},Date:{description:"Constructs a date from year/month/day",arguments:[{name:"year",unroll:!0},{name:"month",unroll:!0},{name:"day",unroll:!0}],fn:(o,e,t)=>{let r=Zn(o,e,t);return r===!1?R():{type:3,value:r}}},Today:{description:"Returns current day",volatile:!0,fn:()=>{let o=new Date;return o.setMilliseconds(0),o.setSeconds(0),o.setMinutes(0),o.setHours(12),{type:3,value:we(o.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(o,e=0)=>o&&o.type===6?{value:e,type:re(e)}:o},IsNA:{description:"Checks if another cell contains a #NA error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...o)=>{let e=J(o);for(let t of e)if(t.type===6&&t.value==="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsErr:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...o)=>{let e=J(o);for(let t of e)if(t.type===6&&t.value!=="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...o)=>{let e=J(o);for(let t of e)if(t.type===6)return{type:4,value:!0};return{type:4,value:!1}}},Year:{description:"Returns year from date",arguments:[{name:"date",unroll:!0}],fn:o=>G(new Date(Be(o)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date",unroll:!0}],fn:o=>G(new Date(Be(o)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date",unroll:!0}],fn:o=>G(new Date(Be(o)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees",unroll:!0}],fn:o=>G(o*Math.PI/180)},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians",unroll:!0}],fn:o=>G(o/Math.PI*180)},CountA:{description:"Counts cells that are not empty",fn:(...o)=>G(L(o).reduce((e,t)=>typeof t>"u"?e:e+1,0))},Count:{description:"Counts cells that contain numbers",fn:(...o)=>G(L(o).reduce((e,t)=>typeof t=="number"||rt(t)?e+1:e,0))},Or:{fn:(...o)=>{let e=!1;o=L(o);for(let t of o)e=e||!!t;return G(e)}},And:{fn:(...o)=>{let e=!0;o=L(o);for(let t of o)e=e&&!!t;return G(e)}},Not:{arguments:[{unroll:!0,boxed:!0}],fn:o=>{let e=!1;if(o)switch(o.type){case 0:e=!1;break;case 2:case 4:case 3:e=!!o.value;break;case 6:return o}return G(!e)}},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(o,e={type:4,value:!0},t={type:4,value:!1})=>{let r=e.type===8,i=t.type===8;return o.type===8?{type:8,value:o.value.map((s,a)=>s.map((l,u)=>(l.type===2?l.value.toLowerCase()!=="false"&&l.value.toLowerCase()!=="f":!!l.value)?r?e.value[a][u]:e:i?t.value[a][u]:t))}:(o.type===2?o.value.toLowerCase()!=="false"&&o.value.toLowerCase()!=="f":!!o.value)?e:t}},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number",unroll:!0}],fn:o=>{o=Math.round(o);let e=1;for(;o>1;)e*=o,o--;return{type:3,value:e}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(o,e)=>{let t=Pe(o),r=Pe(e);if(!t||!r)return E();if(o.type===7||e.type===7)return X(oe(t,r));{let i=Math.pow(t.real,r.real);return isNaN(i)?E():{type:3,value:i}}}},Mod:{arguments:[{unroll:!0},{unroll:!0}],fn:(o,e)=>e?G(o%e):se()},Large:{description:"Returns the nth numeric value from the data, in descending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(o,e)=>{if(e<=0)return R();let t=q(o);return t.sort((r,i)=>i-r),e<=t.length?{type:3,value:t[e-1]}:R()}},Small:{description:"Returns the nth numeric value from the data, in ascending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(o,e)=>{if(e<=0)return R();let t=q(o);return t.sort((r,i)=>r-i),e<=t.length?{type:3,value:t[e-1]}:R()}},Filter:{description:"Filter an array using a second array.",arguments:[{name:"source",description:"Source array"},{name:"filter",description:"Filter array"}],fn:(o,e)=>{if(typeof o>"u"||typeof e>"u")return R();Array.isArray(o)||(o=[[o]]),Array.isArray(e)||(e=[[e]]);let t=o.length,r=o[0].length,i=e.length,n=e[0].length;if(r===n){let s=[];for(let a=0;a<t;a++)s.push([]);for(let[a,l]of e[0].entries())if(l)for(let u=0;u<t;u++)s[u].push(G(o[u][a]));return{type:8,value:s}}else if(t===i){let s=[];for(let[a,[l]]of e.entries())l&&s.push(o[a].map(u=>G(u)));return{type:8,value:s}}return R()}},Sort:{arguments:[{name:"values"}],fn:(...o)=>(o=L(o),o.every(e=>typeof e=="number")?o.sort((e,t)=>e-t):o.sort(),{type:8,value:[o.map(e=>G(e))]})},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:o=>o.type===8?{type:8,value:Ne(o.value)}:o},Max:{fn:(...o)=>({type:3,value:Math.max.apply(0,q(o))})},Min:{fn:(...o)=>({type:3,value:Math.min.apply(0,q(o))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...o)=>{let e=o.map(i=>L(i)),t=Math.max.apply(0,e.map(i=>i.length)),r=0;for(let i=0;i<t;i++)r+=e.reduce((n,s)=>{let a=s[i];return a===!0&&(a=1),typeof a=="number"?n*a:0},1);return{type:3,value:r}}},Row:{arguments:[{name:"reference",metadata:!0}],fn:function(o){if(!o)if(this?.area){let e=[];for(let t=this.area.start.column;t<=this.area.end.column;t++){let r=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)r.push({type:3,value:i+1});e.push(r)}return{type:8,value:e}}else return{type:3,value:this?this.address.row+1:-1};if(o.type===8){let e=o.value,t=e[0][0];if(Y(t))return{type:8,value:[e[0].map((r,i)=>({type:3,value:i+t.value.address.row+1}))]}}else if(Y(o))return{type:3,value:o.value.address.row+1};return R()}},Column:{arguments:[{name:"reference",metadata:!0}],fn:function(o){if(!o)if(this?.area){let e=[];for(let t=this.area.start.column;t<=this.area.end.column;t++){let r=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)r.push({type:3,value:t+1});e.push(r)}return{type:8,value:e}}else return{type:3,value:this?this.address.column+1:-1};if(o.type===8){let e=o.value,t=e[0][0];if(Y(t))return{type:8,value:e.map((r,i)=>[{type:3,value:i+t.value.address.column+1}])}}else if(Y(o))return{type:3,value:o.value.address.row+1};return R()}},Choose:{arguments:[{name:"Selected index"},{name:"Choice 1...",metadata:!0}],return_type:"reference",description:"Returns one of a list of choices",fn:(o,...e)=>{if(o<1||o>e.length)return E();let t=e[o-1];if(Y(t))return{type:5,value:t.value.address};if(t.type===8){let r=t.value,i=r.length,n=r[0].length,s=r[0][0],a=r[i-1][n-1];if(i===1&&n===1){if(Y(s))return{type:5,value:s.value.address}}else if(Y(s)&&Y(a))return{type:5,value:{type:"range",position:0,id:0,label:"",start:s.value.address,end:a.value.address}}}return{...t}}},XLOOKUP:{arguments:[{name:"Lookup value"},{name:"Lookup array"},{name:"Return array",metadata:!0},{name:"Not found",boxed:!0},{name:"Match mode",default:0},{name:"Search mode",default:1}],return_type:"reference",xlfn:!0,fn:(o,e,t,r,i=0,n=1)=>{if(!t)return R();let s;if(t.type===8){let c=t.value,h=c.length,f=c[0].length,d=c[0][0],m=c[h-1][f-1];Y(d)&&Y(m)&&(s=new M(d.value.address,m.value.address))}if(!s)return console.info("invalid range"),z();if(!Array.isArray(e))return console.info("lookup is not an array"),E();let a=e[0];if(!Array.isArray(a))return console.info("lookup is not a 2d array"),E();if(e.length!==1&&a.length!==1)return console.info("lookup array has invalid dimensions"),E();let l=e.length===1;l&&(e=Rt(e)),n<0&&e.reverse();let u=(c,h)=>{let f,d;if(l?(n<0&&(h=c.rows-1-h),h>=0&&h<c.rows&&(f={type:"address",position:0,id:1,label:"",row:c.start.row+h,column:c.start.column,sheet_id:c.start.sheet_id},d={type:"address",position:0,id:2,label:"",row:c.start.row+h,column:c.end.column,sheet_id:c.start.sheet_id})):(n<0&&(h=c.columns-1-h),h>=0&&h<c.columns&&(f={type:"address",position:0,id:1,label:"",row:c.start.row,column:c.start.column+h,sheet_id:c.start.sheet_id},d={type:"address",position:0,id:2,label:"",row:c.end.row,column:c.start.column+h,sheet_id:c.start.sheet_id})),f&&d){let m={type:"range",position:0,id:0,label:"",start:f,end:d};return{type:5,value:m}}return{type:0}};if(i===2&&typeof o!="string"&&(i=0),(i===1||i===-1)&&typeof o=="number"){let c=0,h=-1;for(let f=0;f<e.length;f++){let d=e[f][0];if(typeof d=="number"){if(d===o)return u(s,f);let m=Math.abs(d-o);(i===1&&d>o||i===-1&&d<o)&&(h<0||m<c)&&(c=m,h=f)}}if(h>=0)return u(s,h)}switch(i){case 2:{let c=Mt(o?.toString()||""),h=new RegExp("^"+c+"$","i");for(let f=0;f<e.length;f++){let d=e[f][0];if(typeof d=="string"&&h.exec(d))return u(s,f)}}break;case 0:typeof o=="string"&&(o=o.toLowerCase());for(let c=0;c<e.length;c++){let h=e[c][0];if(typeof h=="string"&&(h=h.toLowerCase()),h===o)return u(s,c)}break}return r&&r.type!==0?r:ue()}},HLookup:{arguments:[...Xn],fn:(o,e,t,r=!0)=>Yn(o,e,t,r,!0)},VLookup:{arguments:[...Xn],fn:(o,e,t,r=!0)=>Yn(o,e,t,r,!1)},Product:{arguments:[{boxed:!0}],fn:(...o)=>{let e={real:1,imaginary:0};o=J(o);for(let t of o)t.type===7?e=$(e,t.value):t.type===3&&(e.real*=t.value,e.imaginary*=t.value);return X(e)}},Log:{arguments:[{name:"number",unroll:!0},{name:"base",unroll:!0}],fn:(o,e=10)=>({type:3,value:Math.log(o)/Math.log(e)})},Log10:{arguments:[{name:"number",unroll:!0}],fn:o=>({type:3,value:Math.log(o)/Math.log(10)})},Ln:{arguments:[{name:"number",unroll:!0}],fn:o=>({type:3,value:Math.log(o)})},"Ceiling.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(o,e=1,t)=>{let r=0;return t&&o<0?r=-Math.ceil(-o/e)*e:r=Math.ceil(o/e)*e,{type:3,value:r}}},"Floor.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(o,e=1,t)=>{let r=0;return t&&o<0?r=-Math.floor(-o/e)*e:r=Math.floor(o/e)*e,{type:3,value:r}}},Floor:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(o,e=1)=>({type:3,value:Math.floor(o/e)*e})},Ceiling:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(o,e=1)=>({type:3,value:Math.ceil(o/e)*e})},Round:{arguments:[{unroll:!0},{unroll:!0}],fn:(o,e=0)=>{let t=Math.pow(10,e);return{type:3,value:Math.round(t*o)/t}}},RoundDown:{arguments:[{unroll:!0},{unroll:!0}],fn:(o,e=0)=>{let t=Math.pow(10,e),r=o>=0;return{type:3,value:r?Math.floor(t*o)/t:Math.ceil(t*o)/t}}},RoundUp:{arguments:[{unroll:!0},{unroll:!0}],fn:(o,e=0)=>{let t=Math.pow(10,e),r=o>=0;return{type:3,value:r?Math.ceil(t*o)/t:Math.floor(t*o)/t}}},Reverse:{arguments:[{boxed:!0}],fn:o=>o.type===8?(o.value.length===1?o.value[0].reverse():o.value.reverse(),o):{type:2,value:(o.value??"").toString().split("").reverse().join("")}},Exp:{arguments:[{boxed:!0,unroll:!0}],fn:o=>{if(o.type===7){let e=At(o.value);return X(e)}return o.type!==3?E():{type:3,value:Math.exp(o.value)}}},Abs:{arguments:[{boxed:!0,unroll:!0}],fn:o=>o.type===7?{type:3,value:Math.sqrt(o.value.real*o.value.real+o.value.imaginary*o.value.imaginary)}:o.type!==3?E():{type:3,value:Math.abs(o.value||0)}},Simplify:{arguments:[{name:"value",unroll:!0},{name:"significant digits",unroll:!0}],fn:(o,e=2)=>{if(e=e||2,o===0)return{type:3,value:o};let t=o<0?-1:1;o*=t;let r=Math.pow(10,Math.floor(Math.log10(o))+1-e);return{type:3,value:Math.round(o/r)*r*t}}},Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:o=>{if(o.type===7){let e=oe(o.value,{real:.5,imaginary:0});return X(e)}else{if(o.type===0||!o.value)return{type:3,value:0};if(o.type===3)return{type:3,value:Math.sqrt(o.value)}}return E()}},HexToDec:{arguments:[{description:"hexadecimal string",unroll:!0}],fn:o=>({type:3,value:parseInt(o,16)})},DecToHex:{arguments:[{description:"number",unroll:!0}],fn:o=>({type:2,value:o.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:Wn,render:Qn,fn:o=>({value:!!o,type:4})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:o=>(Et.RenderColumn(o.width,o.height,o.context,o.cell,o.style),{handled:!0}),fn:(...o)=>({type:5,value:o,key:"sparkline-data"})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:o=>(Et.RenderLine(o.width,o.height,o.context,o.cell,o.style),{handled:!0}),fn:(...o)=>({type:5,value:o,key:"sparkline-data"})},UniqueValues:{arguments:[{name:"range",boxed:!0}],visibility:"internal",fn:o=>{if(o.type===8){let e=n=>{if(n)switch(n.type){case 2:case 3:case 4:return n.value;case 0:return"";default:return console.info("check",n,n.value),n.value?.toString()||""}else return""},t=new Set,r=new Set;for(let n of o.value)for(let s of n){let a=e(s);t.has(a)?r.add(a):t.add(a)}let i=[];for(let n of o.value){let s=[];for(let a of n){let l=e(a);s.push({type:4,value:!r.has(l)})}i.push(s)}return{type:8,value:i}}return{type:4,value:!0}}},Between:{arguments:[{name:"target",boxed:!0,unroll:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(o,e=0,t=1)=>({type:4,value:o.type===3&&o.value>=e&&o.value<=t})},Gradient:{arguments:[{name:"range",boxed:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(o,e,t)=>{let r=J([o]),i=0,n=0,s=0;for(let c of r){if(c.type===6)return c;c.type===3&&(i===0?(n=c.value,s=c.value):(n=Math.min(n,c.value),s=Math.max(s,c.value)),i++)}typeof t=="number"&&(s=t),typeof e=="number"&&(n=e);let a=s-n,l=1,u=1;if(o.type===8){l=o.value.length,u=o.value[0]?.length||0;let c=[];for(let h=0;h<l;h++){let f=[];for(let d=0;d<u;d++){let m=o.value[h][d];if(m.type===3){let _=0;s===n?m.value>s?_=1:m.value<s?_=0:_=.5:a>0&&(_=(m.value-n)/a),f.push({type:3,value:_})}else f.push({type:0})}c.push(f)}return{type:8,value:c}}else return R()}},ATan2:{arguments:[{name:"y",boxed:!0,unroll:!0},{name:"x",boxed:!0,unroll:!0}],fn:(o,e)=>{if(o.type===3&&e.type===3)return{type:3,value:Math.atan2(o.value,e.value)};if(o.type===3&&(o={type:7,value:{real:o.value,imaginary:0}}),e.type===3&&(e={type:7,value:{real:e.value,imaginary:0}}),o.type===7&&e.type===7){let t=Nn(o.value,e.value);return t===!1?R():{type:7,value:t}}return R()}},Sin:Me(Math.sin,fr),SinH:Me(Math.sinh,In),ASin:Me(Math.asin,ui),Cos:Me(Math.cos,Dn),CosH:Me(Math.cosh,Vn),ACos:Me(Math.acos,Fn),Tan:Me(Math.tan,Un),TanH:Me(Math.tanh,Tn),ATan:Me(Math.atan,Ln),E:{fn:()=>({type:3,value:Math.E})},PI:{fn:()=>({type:3,value:Math.PI})},SQRT2:{fn:()=>({type:3,value:Math.SQRT2})},SQRT1_2:{fn:()=>({type:3,value:Math.SQRT1_2})},Sequence:{arguments:[{name:"rows",boxed:!0},{name:"columns",default:1,boxed:!0},{name:"start",default:1,boxed:!0},{name:"step",default:1,boxed:!0}],fn:(o,e,t,r)=>{let i=br(o,1),n=br(e,1),s=br(r,1),a=br(t,1);if(i===!1||n===!1||s===!1||a===!1)return R();let l=[];for(let u=0;u<n;u++){let c=[];for(let h=0;h<i;h++)c.push({type:3,value:a+h*s*n+u*s});l.push(c)}return{type:8,value:l}}}},es={};for(let o of Object.keys(ut))es[o.toLowerCase()]=o;var ka=["ceil","pow","ln10","ln2","log10","log10e","log1p","log2","log2e","random","imul","clz32","fround"],ts={};for(let o of ka)ts[o.toLowerCase()]=o;for(let o of Object.getOwnPropertyNames(Math)){let e=o.toLowerCase();if(es[e]||ts[e])continue;let t=Object.getOwnPropertyDescriptor(Math,o);if(!t)continue;let r=t.value,i=typeof r;switch(i){case"number":ut[o]={fn:()=>({type:3,value:r}),category:["Math Functions"]};break;case"function":ut[o]={fn:(...n)=>G(r(...n)),category:["Math Functions"]};break;default:console.info("unexpected type:",i,o);break}}Math.log10||(Math.log10=o=>Math.log(o)/Math.log(10));var Tt=(o,e,t=0,r=0,i=0)=>i?-(t*(o/(1-Math.pow(1+o,-e))))/(1+o)-r*(1/((1+o)*((Math.pow(1+o,e)-1)/o))):-(t*o*Math.pow(1+o,e)+r*o)/(Math.pow(1+o,e)-1),is=(o,e,t,r=0,i=0)=>i?(1+o)*-t/o*(Math.pow(1+o,e)-1)-r*Math.pow(1+o,e):-t/o*(Math.pow(1+o,e)-1)-r*Math.pow(1+o,e),bi=(o,e,t,r=0,i=0,n=0)=>{if(e<1)return NaN;if(e===1&&n)return 0;let s=Tt(o,t,r,i,n),a=is(o,e-1,s,r,n)*o;return n?a/(1+o):a},rs=(o,e,t,r=0,i=0,n=0)=>Tt(o,t,r,i,n)-bi(o,e,t,r,i,n),ns={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(o=0,...e)=>{let t=0,r=L(e);for(let i=0;i<r.length;i++){let n=r[i];typeof n=="number"&&(t+=Math.pow(1+o,-(i+1))*n)}return{type:3,value:t}}},XNPV:{description:"returns the NPV of a nonperiodic stream of payments at a given rate",arguments:[{name:"Discount rate"},{name:"Values"},{name:"Dates"}],fn:(o,e,t)=>{if(typeof o!="number")return R();if(e=L(e),t=L(t),e.length!==t.length)return R();let r=[];for(let s of e){if(typeof s!="number")return R();r.push(s)}let i=[];for(let s of t){if(typeof s!="number")return R();i.push(Math.floor(s))}let n=0;for(let s=0;s<r.length;s++)n+=(r[s]||0)/Math.pow(1+o,(i[s]-i[0])/365);return{type:3,value:n}}},XIRR:{description:"returns the internal rate of return of a nonperiodic stream of payments",arguments:[{name:"Values"},{name:"Dates"},{name:"Guess",default:.1}],fn:(o,e,t=.1)=>{if(o=L(o),e=L(e),o.length!==e.length)return R();let r=0,i=0,n=[];for(let h of o){if(typeof h!="number")return R();h>0&&r++,h<0&&i++,n.push(h)}if(r<=0||i<=0)return R();let s=[];for(let h of e){if(typeof h!="number")return R();s.push(Math.floor(h))}let a=s[0];for(let h of s)if(h<a)return R();let l=.1,u=[{found:!1,value:0},{found:!1,value:0}],c=n.length;for(let h=0;h<100;h++){let f=0;for(let d=0;d<c;d++)f+=(n[d]||0)/Math.pow(1+t,(s[d]-s[0])/365);if(Math.abs(f)<=1e-6)return{type:3,value:t};if(f>0){if(u[0].value=u[0].found?Math.max(u[0].value,t):t,u[0].found=!0,!u[1].found){t+=l;continue}}else if(u[1].value=u[1].found?Math.min(u[1].value,t):t,u[1].found=!0,!u[0].found){t-=l;continue}t=u[0].value+(u[1].value-u[0].value)/2}return E()}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(o,e=.1)=>{let t=L(o).map(n=>typeof n=="number"?n:0),r=.1,i=[{found:!1,value:0},{found:!1,value:0}];for(let n=0;n<50;n++){let s=0;for(let a=0;a<t.length;a++)s+=Math.pow(1+e,-(a+1))*t[a];if(Math.abs(s)<=.00125)return{type:3,value:e};if(s>0){if(i[0].value=i[0].found?Math.max(i[0].value,e):e,i[0].found=!0,!i[1].found){e+=r;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,e):e,i[1].found=!0,!i[0].found){e-=r;continue}e=i[0].value+(i[1].value-i[0].value)/2}return{type:6,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(o,e,t,r,i,n=0)=>{let s=0;for(let a=r;a<=i;a++)s+=rs(o,a,e,t,0,n);return{type:3,value:s}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(o,e,t,r,i,n=0)=>{let s=0;for(let a=r;a<=i;a++)s+=bi(o,a,e,t,0,n);return{type:3,value:s}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t,r=0,i=0,n=0)=>({type:3,value:bi(o,e,t,r,i,n)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t,r=0,i=0,n=0)=>({type:3,value:rs(o,e,t,r,i,n)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t=0,r=0,i=0)=>{let n=.25,s=[-1,1],a=32,l=1e-6;for(let u=0;u<a;u++){let c=Tt(n,o,t,r,i);if(Math.abs(c-e)<=l)return{type:3,value:n};let h=Tt(s[1],o,t,r,i);e>=c&&e<=h||e>=h&&e<=c?s[0]=n:s[1]=n,n=s[0]+(s[1]-s[0])/2}return{type:3,value:n}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(o,e,t,r=0,i=0)=>({type:3,value:is(o,e,t,r,i)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t,r=0,i=0)=>i?(t+=r*(1/((1+o)*((Math.pow(1+o,e)-1)/o))),{type:3,value:-(t+t/o*(1-Math.pow(1+o,-(e-1))))}):{type:3,value:-(r+t/o*(Math.pow(1+o,e)-1))/Math.pow(1+o,e)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t=0,r=0,i=0)=>i?{type:3,value:1+(-Math.log(1+o*(1-t/-e))+Math.log(1+r*o/(-e*(1+o))))/Math.log(1+o)}:{type:3,value:(Math.log(Math.pow(1-t*o/-e,-1))+Math.log(1+r*o/-e))/Math.log(1+o)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(o,e,t,r=0,i=0)=>({type:3,value:Tt(o,e,t,r,i)})}};var ss={Char:{arguments:[{name:"number"}],fn:o=>({type:2,value:String.fromCodePoint(o||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:o=>({type:3,value:o.codePointAt(0)||0}),category:["text"]},Value:{arguments:[{name:"text"}],fn:o=>{let e=He.TryParse(o);return e.type===3?{type:3,value:e.value}:R()},category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(o,e="0.00####")=>({type:2,value:he.Get(e).Format(o||0)}),category:["text"]},WildcardMatch:{visibility:"internal",arguments:[{name:"text",unroll:!0},{name:"text",unroll:!0},{name:"invert"}],fn:(o,e,t=!1)=>{if(typeof o=="string"&&typeof e=="string"){let r=Mt(e),i=new RegExp("^"+r+"$","i").exec(o);return{type:4,value:t?!i:!!i}}return{type:4,value:o===e||o?.toString()===e?.toString()}}},Exact:{arguments:[{name:"text",boxed:!0,unroll:!0},{name:"text",boxed:!0,unroll:!0}],category:["text"],fn:(o,e)=>({type:4,value:o?.value?.toString()===e?.value?.toString()})},Len:{arguments:[{name:"string",unroll:!0}],fn:o=>({type:3,value:o.toString().length})},Substitute:{arguments:[{name:"text"},{name:"search"},{name:"replacement"},{name:"index"}],fn:(o,e,t,r)=>{if(typeof r=="number"){if(r<1)return E();let i=1;return{type:2,value:o.replaceAll(e,(...n)=>(console.info(n),i++===r?t:e))}}else return{type:2,value:o.replaceAll(e,t)}}},Left:{arguments:[{name:"string"},{name:"count"}],fn:(o,e=1)=>({type:2,value:o.substr(0,e)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(o,e=1)=>({type:2,value:o.slice(-e)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(o,e=0,t=1)=>({type:2,value:o.substr(Math.max(0,e-1),t)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(o,e,t=1)=>{if(t>=1){if(!o)return{type:3,value:t};let r=Mt(o),i=new RegExp(r,"i").exec(e.substr(t-1));if(i)return{type:3,value:i.index+t}}return E()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(o,e,t=1)=>{if(t>=1){if(!o)return{type:3,value:t};o=o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&");let r=new RegExp(o).exec(e.substr(t-1));if(r)return{type:3,value:r.index+t}}return E()}},Upper:{description:"Converts text to upper case",arguments:[{name:"text",unroll:!0}],fn:o=>o==null?{type:0}:{type:2,value:o.toString().toUpperCase()}},Lower:{description:"Converts text to lower case",arguments:[{name:"text",unroll:!0}],fn:o=>o==null?{type:0}:{type:2,value:o.toString().toLowerCase()}},Concat:{description:"Pastes strings together",fn:(...o)=>{let t=L(o).map(r=>{let i=r?.toString()||"";return typeof r=="number"&&F.decimal_separator===","?i.replace(/\\./,","):i}).join("");return{type:2,value:t}}}},yi={Concatenate:"Concat"};var yr=(o,e)=>({type:4,value:typeof e.value?.value===o}),gr=[{name:"Reference",metadata:!0,unroll:!0}],os={IsBlank:{description:"Returns true if the reference is blank",arguments:gr,fn:yr.bind(0,"undefined")},IsNumber:{description:"Returns true if the reference is a number",arguments:gr,fn:yr.bind(0,"number")},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:gr,fn:yr.bind(0,"boolean")},IsText:{description:"Returns true if the reference is text",arguments:gr,fn:yr.bind(0,"string")}};var ls=2220446049250313e-31,Ea=o=>{let e=1+o;return Math.log(e)-(e-1-o)/e},as=(o,e,t,r)=>{let i=2*Number.MIN_VALUE,n=0,s=1,a=1-(o+e)*t/(o+1);Math.abs(a)<i&&(a=Number.NaN),a=1/a,n=a;for(let l=1;l<=512;l++){let u=l*(e-l)*t/((o-1+2*l)*(o+2*l)),c=0;if(a=1+u*a,s=1+u/s,Math.abs(a)<i&&(a=Number.NaN),Math.abs(s)<i&&(s=Number.NaN),a=1/a,c=a*s,n*=c,u=-(o+l)*(o+e+l)*t/((o+2*l)*(o+2*l+1)),a=1+u*a,s=1+u/s,Math.abs(a)<i&&(a=Number.NaN),Math.abs(s)<i&&(s=Number.NaN),a=1/a,c=a*s,n*=c,Math.abs(c-1)<2*ls||n*Math.abs(c-1)<r)return n}return Number.NaN},gi=(o,e,t)=>{if(e<0||t<0)return Number.NaN;if(o<=0)return 0;if(o>=1)return 1;if(o>.5)return 1-gi(1-o,t,e);let r=e/(e+t),i=0;if(o<.1){let n=(Math.log(e)+de(e)+de(t)-de(e+t)+Math.log(o))/e;n<=0?(i=Math.exp(n),i*=Math.pow(1-i,-(t-1)/e)):i=r,i>r&&(i=r)}else i=r;for(let n=0;n<64;n++){let s=o-wi(i,e,t),a=vi(i,e,t);if(s===0)return i;let l=s/Math.max(2*Math.abs(s/i),a),u=l,c=-((e-1)/i-(t-1)/(1-i))*l*l/2,h=u;if(Math.abs(c)<Math.abs(u)?h+=c:h*=2*Math.abs(u/c),i+h>0&&i+h<1?i+=h:i=Math.sqrt(i)*Math.sqrt(r),Math.abs(u)<=1e-10*i)return i}return i},de=o=>{let e=o-1,t=e+5.5;t-=(e+.5)*Math.log(t);let r=1,i=[76.18009173,-86.50532033,24.01409822,-1.231739516,.00120858003,-536382e-11];for(let n of i)r+=n/++e;return-t+Math.log(2.50662827465*r)},vi=(o,e,t)=>o<0||o>1?0:Math.exp(de(e+t)-de(e)-de(t))*Math.pow(o,e-1)*Math.pow(1-o,t-1),wi=(o,e,t)=>{if(o<=0)return 0;if(o>=1)return 1;let i=-(de(e)+de(t)-de(e+t))+e*Math.log(o)+t*Ea(-o),n=Math.exp(i);if(o<(e+1)/(e+t+2)){let s=as(e,t,o,0);return n*s/e}else{let s=Math.abs(t/n)*ls,a=as(t,e,1-o,s);return 1-n*a/t}};var hs=o=>{let e=.254829592,t=-.284496736,r=1.421413741,i=-1.453152027,n=1.061405429,s=.3275911;o=Math.abs(o);let a=1/(1+s*o);return 1-((((n*a+i)*a+r)*a+t)*a+e)*a*Math.exp(-1*o*o)},Ta=Math.sqrt(2*Math.PI),xi=(o,e,t,r)=>{let i=0;return r?i=.5*(1+(o<e?-1:1)*hs(Math.abs(o-e)/(t*Math.sqrt(2)))):i=Math.exp(-1/2*Math.pow((o-e)/t,2))/(t*Ta),i},us=o=>{if(o===.5)return 0;let e=o<1&&o>.5?1-o:o,t=Math.sqrt(Math.log(1/Math.pow(e,2))),r=t-(2.515517+.802853*t+.010328*Math.pow(t,2))/(1+1.432788*t+.189269*Math.pow(t,2)+.001308*Math.pow(t,3));return o>.5?r:-r},Ci=o=>{let e=o.length;return e%2?o[Math.floor(e/2)]:(o[e/2]+o[e/2-1])/2},cs=(o,e=!0)=>{o.sort((i,n)=>i-n);let t=o.length,r=(i,n,s)=>{let a=n*i+s,l=a%1;if(l){let u=o[Math.floor(a)],c=o[Math.ceil(a)];return u+(c-u)*l}else return o[a]};return e?[o[0],r(.25,t-1,0),Ci(o),r(.75,t-1,0),o[t-1]]:t%1?[o[0],r(.25,t-2,0),Ci(o),r(.75,t-2,1),o[t-1]]:[o[0],r(.25,t-3,0),Ci(o),r(.75,t-3,2),o[t-1]]},Si=o=>{let e=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23],t=Math.PI,r=fr,i=Le,n=$,s=m=>({real:m,imaginary:0}),a=(m,_)=>({real:m.real+_.real,imaginary:m.imaginary+_.imaginary}),l=oe,u=At,c=m=>({real:-m.real,imaginary:-m.imaginary}),h=Pn;if(o.real<.5)return i(s(t),n(r(n(s(t),o)),Si({real:1-o.real,imaginary:-o.imaginary})));o.real-=1;let f=s(e[0]);for(let m=1;m<e.length;m++)f=a(f,i(s(e[m]),a(o,s(m))));let d=a(o,s(7.5));return h(s(Math.sqrt(2*t)),l(d,a(o,s(.5))),u(c(d)),f)},_e=(o,e=!1)=>{let t=o.length,r=0,i=0;for(let n=0;n<t;n++)r+=o[n];r/=t;for(let n=0;n<t;n++){let s=o[n]-r;i+=s*s}return e?i/(t-1):i/t},ds={Slope:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(o,e)=>{let t=q(e),r=q(o);if(t.length!==r.length)return R();let i=0,n=0,s=0,a=0;for(let u=0;u<t.length;u++){let c=t[u],h=r[u];s+=c*h,i+=c,n+=h,a+=c*c}let l=(t.length*s-i*n)/(t.length*a-i*i);return{type:3,value:l}}},Intercept:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(o,e)=>{let t=q(e),r=q(o);if(t.length!==r.length)return R();let i=t.length,n=0,s=0,a=0,l=0;for(let c=0;c<i;c++){let h=t[c],f=r[c];a+=h*f,n+=h,s+=f,l+=h*h}let u=i*a-n*s;return u/=i*l-n*n,{type:3,value:(s-u*n)/i}}},Phi:{arguments:[{name:"x",boxed:!0,unroll:!0}],fn:o=>o.type===3?{type:3,value:1/Math.sqrt(Math.PI*2)*Math.exp(-o.value*o.value/2)}:R()},"Z.Test":{arguments:[{name:"Array",boxed:!0},{name:"x",boxed:!0,unroll:!0},{name:"Sigma",boxed:!0,unroll:!0}],fn:(o,e,t)=>{let r=[];if(o.type===8)for(let i of o.value)for(let n of i)n.type===3&&r.push(n.value);else o.type===3&&r.push(o.value);if(r.length&&e.type===3){let i=0,n=r.length;for(let a of r)i+=a;i/=n;let s=t?.type===3?t.value:Math.sqrt(_e(r,!0));return{type:3,value:1-xi((i-e.value)/(s/Math.sqrt(n)),0,1,!0)}}return R()}},"Beta.Dist":{description:"beta distribution",arguments:[{name:"x",unroll:!0},{name:"a"},{name:"b"},{name:"cumulative"}],fn:(o,e,t,r)=>e<0||t<0?R():r?{type:3,value:wi(o,e,t)}:{type:3,value:vi(o,e,t)}},"Beta.Inv":{description:"Inverse of the beta distribution",arguments:[{name:"probability",unroll:!0},{name:"a"},{name:"b"}],fn:(o,e,t)=>e<0||t<0?R():{type:3,value:gi(o,e,t)}},Erf:{fn:o=>({type:3,value:hs(o)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],xlfn:!0,fn:(o,e=0,t=1)=>({type:3,value:us(o)*t+e})},"Norm.S.Inv":{description:"Inverse of the standard normal cumulative distribution",arguments:[{name:"probability"}],xlfn:!0,fn:o=>({type:3,value:us(o)})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1},{name:"cumulative",default:!0}],xlfn:!0,fn:(o,e=0,t=1,r=!0)=>({type:3,value:xi(o,e,t,r)})},"Norm.S.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"cumulative",default:!0}],xlfn:!0,fn:(o,e=!0)=>({type:3,value:xi(o,0,1,e)})},"StDev.P":{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...o)=>({type:3,value:Math.sqrt(_e(q(o),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...o)=>({type:3,value:Math.sqrt(_e(q(o),!0))})},"Var.P":{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...o)=>({type:3,value:_e(q(o),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...o)=>({type:3,value:_e(q(o),!0)})},Covar:{description:"Returns the covariance between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(o,e)=>{if(!Array.isArray(o)||!Array.isArray(e))return E();if(!Array.isArray(o[0])||!Array.isArray(e[0]))return E();if(o.length!==e.length)return R();let t=0,r=0,i={x:0,y:0},n={x:[],y:[]};for(let s=0;s<o.length;s++){if(!o[s]||!e[s])continue;if(o[s].length!==e[s].length)return R();let a=o[s].length;r+=a;for(let l=0;l<a;l++)i.x+=o[s][l]||0,i.y+=e[s][l]||0,n.x.push(o[s][l]||0),n.y.push(e[s][l]||0)}if(r===0)return ue();i.x/=r,i.y/=r;for(let s=0;s<r;s++)t+=(n.x[s]-i.x)*(n.y[s]-i.y);return{type:3,value:t/r}}},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(o,e)=>{if(!Array.isArray(o)||!Array.isArray(e))return E();if(!Array.isArray(o[0])||!Array.isArray(e[0]))return E();let t=0,r=0,i=0,n=0,s=0,a=0,l=0;for(let u=0;u<o.length;u++){if(!o[u]||!e[u])continue;let c=o[u].length;for(let h=0;h<c;h++){let f=Number(o[u][h]),d=Number(e[u][h]);isNaN(f)||isNaN(d)||(r+=f*d,i+=f,n+=d,s+=f*f,a+=d*d,l++)}}return t=l*r-i*n,t&&(t/=Math.sqrt((l*s-i*i)*(l*a-n*n))),{type:3,value:t}}},GeoMean:{description:"Returns the geometric mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...o)=>{o=J(o);let e=0,t={real:1,imaginary:0},r=!1,i=!1;for(let n of o)n.type===7?(r=!0,t=$(t,n.value),e++):n.type===3&&(n.value<0&&(i=!0),e++,t.real*=n.value,t.imaginary*=n.value);if(r){let n=oe(t,{real:1/e,imaginary:0});return n.imaginary?{type:7,value:n}:{type:3,value:n.real}}else return i?E():{type:3,value:Math.pow(t.real,1/e)}}},LCM:{description:"Retuns the least common mulitple of the arguments",arguments:[{boxed:!0}],fn:(...o)=>{o=J(o);let e=[];for(let i of o){if(i.type===6)return i;if(i.type===3)e.push(i.value);else if(i.type!==0)return console.info("RT",i.type),R()}let t=(i,n)=>i%n==0?n:t(n,i%n);if(e.length===0)return{type:3,value:0};let r=e[0];for(let i=1;i<e.length;i++)r=r*e[i]/t(r,e[i]);return{type:3,value:r}}},GammaLn:{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:o=>o.type===3?{type:3,value:de(o.value)}:R()},"GammaLn.Precise":{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:o=>{let e;if(o.type===3?e={real:o.value,imaginary:0}:o.type===7&&(e=o.value),e){let t=Si(e);return X(ci(t))}return R()}},Gamma:{description:"Returns the gamma function for the given value",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:o=>{let e={real:0,imaginary:0};if(o.type===7)e={...o.value};else if(o.type===3)e.real=o.value;else return R();if(e.imaginary===0&&e.real%1===0&&e.real<=0)return E();let t=Si(e);return Math.abs(t.imaginary)<=1e-7?{type:3,value:t.real}:{type:7,value:t}}},Delta:{arguments:[{name:"number"},{name:"number",default:0}],fn:(o,e=0)=>typeof o!="number"||typeof e!="number"?E():{type:3,value:o===e?1:0}},GCD:{description:"Finds the greatest common divisor of the arguments",arguments:[{boxed:!0}],fn:(...o)=>{o=J(o);let e=[];for(let i of o){if(i.type===6)return i;if(i.type===3)e.push(i.value);else if(i.type!==0)return console.info("RT",i.type),R()}let t=(i,n)=>i%n==0?n:t(n,i%n);if(e.length===0)return E();if(e.length===1)return{type:3,value:e[0]};let r=e[0];for(let i=1;i<e.length;i++)r=t(r,e[i]);return{type:3,value:r}}},HarMean:{description:"Returns the harmonic mean of the arguments",arguments:[{boxed:!0}],fn:(...o)=>{o=J(o);let e={real:0,imaginary:0},t=0;for(let r of o){if(r.type===6)return r;if(r.type===3&&(e.real+=1/r.value,t++),r.type===7){let i=Le({real:1,imaginary:0},r.value);e.real+=i.real,e.imaginary+=i.imaginary,t++}}return e.imaginary?{type:7,value:Le({real:t,imaginary:0},e)}:{type:3,value:t/e.real}}},Average:{description:"Returns the arithmetic mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...o)=>{o=J(o);let e={real:0,imaginary:0},t=0;for(let r of o){if(r.type===6)return r;r.type===3&&(e.real+=r.value,t++),r.type===7&&(e.real+=r.value.real,e.imaginary+=r.value.imaginary,t++)}return e.real/=t,e.imaginary/=t,e.imaginary?{type:7,value:e}:{type:3,value:e.real}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(o,e)=>{let t=q(o);t.sort((l,u)=>l-u);let r=t.length,i=Math.pow(10,8),n=Math.round((1+(r-1)*e)*i)/i,s=Math.floor(n),a=Math.ceil(n);return{type:3,value:(t[s-1]+t[a-1])/2}}},"Quartile.Inc":{description:"Returns the interpolated quartile of the data set (including median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(o,e)=>{if(typeof e!="number"||e<0||e>4||e%1)return R();let t=q(o),r=cs(t,!0);return{type:3,value:r[e]}}},"Quartile.Exc":{description:"Returns the interpolated quartile of the data set (excluding median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(o,e)=>{if(typeof e!="number"||e<1||e>3||e%1)return R();let t=q(o),r=cs(t,!1);return{type:3,value:r[e]}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...o)=>{let e=q(o);e.sort((s,a)=>s-a);let r=1+(e.length-1)*.5,i=Math.floor(r),n=Math.ceil(r);return{type:3,value:(e[i-1]+e[n-1])/2}}},Rank:{arguments:[{name:"Value"},{name:"Source"},{name:"Order"}],fn:(o,e,t=0)=>{if(typeof o!="number")return R();let r=q(e);r.sort(t?(i,n)=>i-n:(i,n)=>n-i);for(let i=0;i<r.length;i++)if(r[i]===o)return{type:3,value:i+1};return E()}}},Ai={Mean:"Average",StDev:"StDev.S",StDevA:"StDev.S",StDevPA:"StDev.P",Var:"Var.S",Quartile:"Quartile.Inc",NormSInv:"Norm.S.Inv",NormSDist:"Norm.S.Dist",NormDist:"Norm.Dist"};var fs={IsComplex:{description:"Returns true if the reference is a complex number",arguments:[{name:"Reference",metadata:!0,unroll:!0}],fn:o=>({type:4,value:!!o?.value&&rt(o.value.value)})},Real:{description:"Returns the real part of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:o=>o.type===3?{...o}:o.type===7?{type:3,value:o.value.real||0}:o.type===0||o.type===2&&o.value===""?{type:3,value:0}:E()},Imaginary:{description:"Returns the imaginary part of a complex number (as real)",arguments:[{boxed:!0,unroll:!0}],fn:o=>o.type===7?{type:3,value:o.value.imaginary||0}:o.type===3||o.type===0||o.type===2&&o.value===""?{type:3,value:0}:E()},Conjugate:{description:"Returns the conjugate of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:o=>{let e=Pe(o);return e?e.imaginary?{type:7,value:{real:e.real,imaginary:-e.imaginary}}:{type:3,value:e.real}:E()}},Arg:{description:"Returns the principal argument of a complex number (in radians)",arguments:[{boxed:!0,unroll:!0}],fn:o=>o.type===7?{type:3,value:Math.atan2(o.value.imaginary,o.value.real)}:o.type===3||o.type===0||o.type===2&&o.value===""?{type:3,value:Math.atan2(0,o.value||0)}:E()},Rectangular:{description:"Converts a complex number in polar form to rectangular form",arguments:[{name:"r"},{name:"\\u03B8 in radians"}],fn:(o=0,e=0)=>({type:7,value:{real:o*Math.cos(e),imaginary:o*Math.sin(e)}})},Complex:{description:"Ensures that the given value will be treated as a complex number",arguments:[{boxed:!0,unroll:!0}],fn:o=>{let e=Pe(o);return e?{type:7,value:e}:E()}},ComplexLog:{description:"Returns the principal value Log(z) of a complex number z",arguments:[{boxed:!0,unroll:!0}],fn:o=>{if(o.type===3){if(!o.value)return E();o={type:7,value:{real:o.value,imaginary:0}}}else if(o.type===0||o.type===2&&o.value==="")return E();if(o.type===7){let e=dr(o.value),t={real:Math.log(e.r),imaginary:e.theta};return t.imaginary?{type:7,value:t}:{type:3,value:t.real}}return E()}}};var vr=o=>{let e=[];o.type===8?e=o.value:e=[[o]];let t=e.length,r=t?e[0].length:0,i=[];if(!t||!r)return{m:t,n:r,array:i};for(let n=0;n<t;n++){let s=[];for(let a=0;a<r;a++){let l=e[n][a];if(l.type===7)s.push({...l.value});else if(l.type===3)s.push({real:l.value,imaginary:0});else if(l.type===0||l.value==="")s.push({real:0,imaginary:0});else return{m:t,n:r,error:!0,array:[]}}i.push(s)}return{m:t,n:r,array:i}},ms={MDeterm:{description:"Returns the determinant of a matrix",arguments:[{name:"matrix",boxed:!0}],fn:o=>{let e=vr(o);if(!e.array||!e.m||!e.n||e.m!==e.n||e.error)return E();let t=mr(e);return t?X(t):E()}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"matrix",boxed:!0}],fn:o=>{let e=vr(o);if(!e.array||!e.m||!e.n||e.m!==e.n||e.error)return E();let t=mr(e);if(t&&t.real===0&&t?.imaginary===0)return E();let r=On(e);return r?{type:8,value:r.map(i=>i.map(n=>X(n)))}:E()}},MMult:{description:"Returns the dot product A \\u22C5 B",arguments:[{name:"A",boxed:!0},{name:"B",boxed:!0}],fn:(o,e)=>{let t=vr(o),r=vr(e);if(!t.array||t.error||!r.array||r.error)return E();if(t.m!==r.n)return E();let i=zn(r,t);return{type:8,value:i.map(n=>n.map(s=>X(s)))}}}};var ps={RegexExtract:{description:"Extract text using a regular expression",arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"return mode",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],fn:(o,e,t=0,r=!1)=>{let i=[];r&&i.push("i"),t===1&&i.push("g");let n=new RegExp(e,i.length?i.join(""):void 0);switch(t){case 0:{let s=o.match(n);return{type:2,value:s===null?"":s[0]??""}}case 1:{let s=Array.from(o.matchAll(n));return console.info({result:s}),{type:8,value:[s.map(a=>({type:2,value:a[0]||""}))]}}case 2:{let s=o.match(n);if(s===null)return{type:2,value:""};let a=Array.from(s).slice(1);return{type:8,value:[a.map(l=>({type:2,value:l}))]}}default:return R()}}},RegexReplace:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"replacement",unroll:!0},{name:"occurrence",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],description:"Replace text in a string using a regex",fn:(o,e,t,r=0,i=!1)=>{let n=["g"];i&&n.push("i");let s=new RegExp(e,n.length?n.join(""):void 0);if(r===0)return{type:2,value:o.replaceAll(s,t)};if(r<0){let l=Array.from(o.matchAll(s)).length;r+=l+1}let a=o.replace(s,l=>--r===0?t:l);return{type:2,value:a}}},RegexTest:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"case insensitive",unroll:!0,default:!1}],description:"Match text against a regular expression",fn:(o,e,t=!1)=>{let r=new RegExp(e,t?"i":void 0);return{type:4,value:r.test(o)}}}};var _s={Lambda:{description:"Creates a function",arguments:[{name:"Argument",repeat:!0,boxed:!0,passthrough:!0},{name:"Function",boxed:!0,passthrough:!0}],fn:(...o)=>({type:10,value:{bindings:o.slice(0,o.length-1),func:o[o.length-1],alt:"LAMBDA",type:"function"}})},Let:{description:"Binds values to names for a calculation",arguments:[{name:"Name",repeat:!0},{name:"Value",repeat:!0},{name:"Calculation",boxed:!0}],create_binding_context:({args:o,descriptors:e})=>{if(o.length%2!==1)return;let t={};for(let r=0;r<o.length-1;r+=2){let i=o[r],n=o[r+1];if(i.type==="identifier")t[i.name]=n;else return}return{context:t,args:o.slice(-1),argument_descriptors:e.slice(-1)}},fn:o=>o||{type:0}}};var ct=class o extends Re{static type="state-leaf-vertex";state_id=0;type=o.type;color=2;Calculate(){if(this.dirty){for(let e of this.edges_in)if(e.dirty)return;this.state_id++,this.dirty=!1}}AddDependent(){throw new Error("leaf vertex cannot have dependents")}};var Ua=o=>{if(typeof o=="string")switch(o=o.toUpperCase(),o){case"AVERAGE":case"MEAN":o=101;break;case"COUNT":o=102;break;case"COUNTA":o=103;break;case"MAX":o=104;break;case"MIN":o=105;break;case"PRODUCT":o=106;break;case"STDEV":o=107;break;case"STDEVP":o=108;break;case"SUM":o=109;break;case"VAR":o=110;break;case"VARP":o=111;break;default:o=0;break}return o},Va={complex_numbers:"off",spill:!1},wr=class extends hr{constructor(t,r={}){super();this.model=t;if(this.expression_calculator=new lt(this.model,this.library,this.parser),this.options={...Va,...r},this.options.complex_numbers==="on"){for(let s of Object.keys(_i))ut[s]=_i[s];Hn()}this.UpdateLocale(),this.library.Register(ut,ss,ds,ns,os,fs,ms,ps,_s);for(let s of Object.keys(Ai))this.library.Alias(s,Ai[s]);for(let s of Object.keys(yi))this.library.Alias(s,yi[s]);let i=(s,a,...l)=>{let u=[];for(let d=0;d<l.length;d+=2)if(Array.isArray(l[d])){let m=n(l[d],l[d+1]);if(m.type!==8)return m;for(let[_,y]of m.value[0].entries())u[_]=!!y.value&&u[_]!==!1}let c=L(a,!0),h=0,f=0;for(let[d,m]of u.entries())if(m){h++;let _=c[d];typeof _=="number"&&(f+=_)}switch(s){case"count":return{type:3,value:h};case"sum":return{type:3,value:f};case"average":return h===0?se():{type:3,value:f/h}}},n=(s,a)=>{let l=L(s,!0),u,c,h="=";if(typeof a=="string"){a=a.trim();let d=a.match(/^([=<>]+)/);d&&(h=d[1],a=a.substring(h.length));let m=He.TryParse(a);if(m?.type===2?a=`"${m.value}"`:a=m?.value?.toString()||"",/[?*]/.test(a)){let _=this.parser.argument_separator;if(h==="="||h==="<>"){if(u=this.parser.Parse(`=WildcardMatch({}${_} ${a}${_} ${h==="<>"})`),c=u.expression,u.error||!c)return ee();c?.type==="call"&&c.args[0]?.type==="array"&&(c.args[0].values=[pi(l,!0)])}}}else a=(a||0).toString();if(!u){if(u=this.parser.Parse("{}"+h+a),c=u.expression,u.error||!c)return ee();if(c.type!=="binary")return console.warn("invalid expression [1]",c),ee();if(c.left.type!=="array")return console.warn("invalid expression [1]",c),ee();c.right.type==="identifier"&&(console.warn("will never happen"),c.right={...c.right,type:"literal",value:c.right.name}),c.left.values=[pi(l,!0)]}return c?this.CalculateExpression(c):E()};this.library.Register({Subtotal:{arguments:[{name:"type"},{name:"range",metadata:!0}],fn:(s,...a)=>{if(s=Ua(s),s>100&&(s-=100),s<1||s>11)return R();let l=J(a),u=[],c=0,h=0,f;for(let m of l){let _=m.value?.address;if(!_)return z();if(!f||f.id!==_.sheet_id){if(!_.sheet_id)return console.warn("invalid reference in metadata"),z();if(f=this.model.sheets.Find(_.sheet_id),!f)return console.warn("invalid sheet in metadata"),z()}if(!f.GetRowHeight(_.row))continue;let v=m.value?.value;typeof v>"u"||(c++,typeof v=="number"&&(h+=v,u.push(v)))}let d=0;switch(s){case 1:if(u.length===0)return se();d=h/u.length;break;case 2:d=u.length;break;case 3:d=c;break;case 4:if(u.length===0)return E();d=Math.max.apply(0,u);break;case 5:if(u.length===0)return E();d=Math.min.apply(0,u);break;case 6:if(u.length===0)return E();d=1;for(let m of u)d*=m;break;case 7:if(u.length<2)return se();d=Math.sqrt(_e(u,!0));break;case 8:if(u.length===0)return se();d=Math.sqrt(_e(u,!1));break;case 9:d=h;break;case 10:if(u.length<2)return se();d=_e(u,!0);break;case 11:if(u.length===0)return se();d=_e(u,!1);break}return{type:3,value:d}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return",unroll:!0},{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:(s,a)=>{if(!Y(a))return z();if(s)switch(s.toString().toLowerCase()){case"format":return a.value.format?{type:2,value:a.value.format}:z();case"address":{let l="";return a.value.address.sheet_id&&(l=this.model.sheets.Find(a.value.address.sheet_id)?.name||""),l&&(Te.test(l)&&(l=`\'${l}\'`),l+="!"),{type:2,value:"[]"+l+a.value.address.label.replace(/\\$/g,"")}}}return{type:6,value:Mn.error}}},Address:{arguments:[{name:"row"},{name:"column"},{name:"absolute"},{name:"a1"},{name:"sheet name"}],fn:(s=1,a=1,l=1,u=!0,c)=>{let h={type:"address",id:0,position:0,label:"",row:s-1,column:a-1};switch(l){case 2:h.absolute_row=!0;break;case 3:h.absolute_column=!0;break;case 4:break;default:h.absolute_column=!0,h.absolute_row=!0}return c&&(h.sheet=c),Jn(this.parser.Render(h,{r1c1:!u}))}},CountIfs:{arguments:[{name:"range"},{name:"criteria"},{name:"range"},{name:"criteria"}],fn:(...s)=>i("count",s[0],...s)},AverageIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(s,a,l)=>i("average",l||s,s,a)},AverageIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(s,...a)=>i("average",s,...a)},SumIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(s,a,l)=>i("sum",l||s,s,a)},SumIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(s,...a)=>i("sum",s,...a)},CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(s,a)=>i("count",s,s,a)},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"},{name:"height"},{name:"width"}],return_type:"reference",volatile:!0,fn:((s,a=0,l=0,u,c)=>{if(!s)return R();if(s.type===8){let f=typeof u=="number"?a+u:void 0,d=typeof c=="number"?l+c:void 0;return{type:8,value:s.value.slice(a,f).map(_=>_.slice(l,d))}}if(!Y(s))return console.info("e2",{reference:s}),z();let h=this.DynamicDependencies(s.value.address,this.expression_calculator.context.address,!0,a,l,c,u);if(!h)return console.info("e1",{check_result:h}),z();if(h.dirty){let f=this.GetVertex(this.expression_calculator.context.address,!0);return f.short_circuit=!0,{type:0,value:void 0}}if(h.area){let f={type:"address",...h.area.start,label:"",position:0,id:0},d={type:"address",...h.area.end,label:"",position:0,id:0},m=h.area.count===1?f:{type:"range",start:f,end:d,label:"",position:0,id:0};return{type:5,value:m}}return E()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:"reference",volatile:!0,fn:(s=>{if(!s||typeof s!="string")return R();let a=this.parser.Parse(s);if(a.error||!a.expression||a.expression.type!=="address"&&a.expression.type!=="range")return z();let l=this.DynamicDependencies(a.expression,this.expression_calculator.context.address);if(!l)return z();if(l.dirty){let u=this.GetVertex(this.expression_calculator.context.address,!0);return u.short_circuit=!0,{type:0,value:void 0}}return{type:5,value:a.expression}}).bind(this)},Match:{arguments:[{name:"value",boxed:!0},{name:"range",boxed:!0},{name:"type"}],fn:(s,a,l=0)=>{if(l)return console.warn("inexact match not supported",{value:s,range:a,type:l}),ue();if(a.type===8){if(a.value.length===1){let u=a.value[0];for(let c=0;c<u.length;c++)if(s.type==u[c].type&&s.value===u[c].value)return{type:3,value:c+1}}else for(let u=0;u<a.value.length;u++){let c=a.value[u];if(c.length!==1)return ue();if(s.type==c[0].type&&s.value===c[0].value)return{type:3,value:u+1}}return ue()}else return s.type===a.type&&s.value===a.value?{type:3,value:1}:ue();return R()}},Index:{arguments:[{name:"range",boxed:!0},{name:"row"},{name:"column"}],volatile:!1,fn:(s,a,l)=>{if(s&&s.type!==8&&(s={type:8,value:[[s]]}),a&&l){let u=s.value[l-1];if(u){let c=u[a-1];if(c)return c}}else if(a){let u=[];for(let c of s.value){if(!c[a-1])return R();u.push([c[a-1]])}return{type:8,value:u}}else if(l){let u=s.value[l-1];if(u)return{type:8,value:[u]}}return R()}},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:s=>{if(!s)return R();if(Array.isArray(s)){let a=s[0];return Array.isArray(a)?{type:3,value:a.length}:E()}return{type:3,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:s=>s?Array.isArray(s)?{type:3,value:s.length}:{type:3,value:1}:R()},FormulaText:{description:"Returns a formula as a string",arguments:[{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:s=>{if(!Y(s))return z();let a=this.model.sheets.Find(s.value?.address?.sheet_id||0);if(a){let l=a.cells.GetCell(s.value.address,!1);return{type:2,value:l?.value?.toString()||""}}return z()}},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",unroll:!0,metadata:!0}],fn:s=>{let a=s?.value?.address,l=this.model.sheets.Find(a?.sheet_id||0);if(a&&l){let u=l.cells.GetCell(a,!1);return{type:4,value:u?.type===1}}return{type:4,value:!1}}}})}get parser(){return this.model.parser}library=new _r;registered_libraries={};expression_calculator;full_rebuild_required=!1;options;grid_expanded=!1;ExportCalculatedValues(){let t={};for(let r of this.model.sheets.list){let i=r.cells.toJSON({calculated_value:!0}).data;t[r.id]=i.filter(n=>n.calculated!==void 0)}return t}ApplyCalculatedValues(t){for(let r of this.model.sheets.list){let i=t[r.id];if(!i)console.info("mismatch",r.id);else for(let n of i)r.cells.data[n.row][n.column].SetCalculatedValue(n.calculated)}}AttachSpillData(t,r){if(r||(r=(t.start.sheet_id?this.model.sheets.Find(t.start.sheet_id):void 0)?.cells),!r)throw new Error("invalid sheet ID in attach spill data");let i=new ct,n=0,s=!1;for(let{cell:a,row:l,column:u}of r.IterateRC(t,!0))n++&&(a.type!==0||a.area||a.merge_area||a.table)&&(s=!0),this.AddLeafVertexEdge({row:l,column:u,sheet_id:t.start.sheet_id},i);return this.spill_data.push({area:t,vertex:i}),{vertex:i,area:t,error:s}}SpillCallback(t,r){let{reference:i,address:n}=t,{value:s}=r,a=[];if(!i)return console.error("invalid reference in spill callback"),a;if(!n||!n.sheet_id)return console.error("invalid address in spill callback"),a;if(s.length===1&&s[0].length===1||!this.options.spill)return i.SetCalculatedValue(s[0][0].value),a;let l=this.model.sheets.Find(n.sheet_id),u=l?.cells;if(u){let c=r.value.length,h=r.value[0].length,f=new M(n).Reshape(h,c),{error:d}=this.AttachSpillData(f,u);if(d)return i.SetCalculationError("SPILL"),a;l.rows<f.end.row+1&&(l.cells.EnsureRow(f.end.row+1),this.grid_expanded=!0),l.columns<f.end.column+1&&(l.cells.EnsureColumn(f.end.column+1),this.grid_expanded=!0);let m=n.sheet_id;for(let{row:_,column:y}of u.IterateRC(f)){if(_===n.row&&y===n.column)continue;let v=this.GetVertex({sheet_id:m,row:_,column:y},!1);v&&(v.dirty||a.push(v))}for(let{cell:_,row:y,column:v}of u.IterateRC(f)){_.spill=f,y-=n.row,v-=n.column;let w=r.value[v][y];switch(w.type){case 5:case 8:case 10:break;default:_.SetCalculatedValue(w.value,w.type);break}}return a}return console.error("invalid cell reference in spill callback"),i.SetCalculationError("SPILL"),[]}SpreadCallback(t,r){if(!t.address||!t.address.sheet_id)throw new Error("spread callback called without sheet id");let i=this.model.sheets.Find(t.address.sheet_id)?.cells;if(!i)throw new Error("spread callback called without cells");if(!t||!t.reference)return;let n=t.reference.area;if(n){let s=n.rows,a=n.columns;if(r.type===8){let l=Ne(r.value);for(let u=0;u<s;u++)if(l[u]){let c=0;for(;c<a&&c<l[u].length;c++){let h=l[u][c];switch(h.type===8&&(h=h.value[0][0]),h.type){case 8:case 5:case 10:i.data[u+n.start.row][c+n.start.column].SetCalculatedValue(void 0);break;default:i.data[u+n.start.row][c+n.start.column].SetCalculatedValue(h.value,h.type)}}for(;c<a;c++)i.data[u+n.start.row][c+n.start.column].SetCalculatedValue(void 0,0)}else for(let c=0;c<a;c++)i.data[u+n.start.row][c+n.start.column].SetCalculatedValue(void 0,0)}else{let l={...r};(l.type===5||l.type===10)&&(l={type:0,value:void 0});for(let u=0;u<s;u++)for(let c=0;c<a;c++)i.data[u+n.start.row][c+n.start.column].SetCalculatedValue(l.value,l.type)}}}CalculationCallback(t){if(!t.address)throw new Error("vertex missing address");return t.expression_error?{value:ur()}:this.expression_calculator.Calculate(t.expression,t.address,t.reference?.area)}DynamicDependencies(t,r,i=!1,n=0,s=0,a=1,l=1){let u=this.ResolveExpressionAddress(t,r);if(!u)return;let c=!1,h;if(t.type==="address"||t.type==="range"){let d=t.type==="range"?t.start:t;d.sheet_id?h=this.model.sheets.Find(d.sheet_id):d.sheet&&(h=this.model.sheets.Find(d.sheet))}if(!h&&r?.sheet_id&&(h=this.model.sheets.Find(r.sheet_id)),!h)throw new Error("missing sheet in dynamic dependencies [b21]");u=h.RealArea(u);let f=u.start.sheet_id;i&&(u=new M({column:u.start.column+s,row:u.start.row+n,sheet_id:u.start.sheet_id},{column:u.start.column+s+a-1,row:u.start.row+n+l-1,sheet_id:u.end.sheet_id}));for(let d=u.start.row;d<=u.end.row;d++)for(let m=u.start.column;m<=u.end.column;m++){let _=this.GetVertex({row:d,column:m,sheet_id:f},!1);_&&_.dirty&&(this.AddEdge({row:d,column:m,sheet_id:f},this.expression_calculator.context.address),c=!0)}return{dirty:c,area:u}}UpdateLocale(){F.decimal_separator===","?this.parser.SetLocaleSettings(","):this.parser.SetLocaleSettings(".")}SupportedFunctions(){let t=this.library.List(),r=Object.keys(t).map(i=>{let n=t[i].canonical_name;return n||(n=i.replace(/_/g,".")),{name:n,description:t[i].description,arguments:(t[i].arguments||[]).map(s=>({name:s.name||""})),type:"function"}});for(let i of this.model.macro_functions.values())r.push({name:i.name,description:i.description,arguments:(i.argument_names||[]).map(n=>({name:n})),type:"function"});return r}RegisterLibrary(t,r){return this.registered_libraries[t]?!1:(this.RegisterFunction(r),this.registered_libraries[t]=!0,!0)}RegisterFunction(t){for(let r of Object.keys(t)){let i=t[r];this.library.Register({[r]:i})}}Calculate(t){if(t&&!t.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(t=void 0,this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.full_rebuild_required=!1),this.RebuildGraph(t),this.grid_expanded=!1;try{this.Recalculate()}catch(r){console.error(r),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.full_rebuild_required=!0}DecoratedFunctionList(){let t={},r=this.library.List();for(let i of Object.keys(r)){let n=r[i];n.xlfn?t[i]="_xlfn":n.extension&&(t[i]="_xll")}return t}Evaluate(t,r,i={},n=!1){let s=i?.preparsed;if(!s){this.parser.Save(),i.argument_separator&&(i.argument_separator===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(",")),i.r1c1&&(this.parser.flags.r1c1=i.r1c1);let a=this.parser.Parse(t);if(this.parser.Restore(),s=a.expression,a.error)throw new Error(a.error)}if(s){this.parser.Walk(s,l=>{if(l.type==="address"||l.type==="range"){if(l.type==="address"){if(l.offset_column||l.offset_row)throw new Error("Evaluate does not support offset references")}else if(l.start.offset_column||l.start.offset_row||l.end.offset_column||l.end.offset_row)throw new Error("Evaluate does not support offset references");this.model.ResolveSheetID(l,void 0,r)}return!0});let a=this.CalculateExpression(s,i.address);return n?a:a.type===8?a.value.map(l=>l.map(u=>u.value)):a.value}throw new Error("invalid expression")}CalculateExpression(t,r={row:-1,column:-1},i=!1){return this.expression_calculator.Calculate(t,r,void 0,i).value}RebuildClean(t=!1){this.full_rebuild_required=!1,this.RebuildGraph(),this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.InitializeGraph(),t&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(t){let r={},i=[];for(let n of t){let s={column:n.column,row:n.row,sheet_id:n.sheet_id},a=M.CellAddressToLabel(s,!0);r[a]||(r[a]=a,i.push(s))}return i}Unresolve(t,r,i=!0,n=!0){let s="",a=Z(t)?new M(t):new M(t.start,t.end);if(n){let c=this.model.named.MatchSelection(a);if(c)return c}if(s=a.spreadsheet_label,!i)return s;let l=a.start.sheet_id||r?.id,u=this.ResolveSheetName(l,!0);return u?u+"!"+s:s}ResolveSheetName(t,r=!1){let i=this.model.sheets.Find(t);if(i)return r&&Te.test(i.name)?`\'${i.name}\'`:i.name}RemoveConditional(t){if(t.type==="expression"){let r=t.internal?.vertex;r&&(r.Reset(),this.RemoveLeafVertex(r))}}RemoveConnectedELement(t){let r=t.internal;return r?.vertex?(this.RemoveLeafVertex(r.vertex),!0):!1}UpdateConnectedElements(t,r){if(t||(t=this.model.sheets.list[0]),r){let n=r.internal;n?.vertex&&this.RemoveLeafVertex(n.vertex)}let i=r?[r]:this.model.connected_elements.values();for(let n of i){let s=n.internal;s||(s={vertex:new ct},n.internal=s);let a=s.vertex;this.AddLeafVertex(a),this.UpdateLeafVertex(a,n.formula,t)}}UpdateConditionals(t,r){if(!t){for(let i of this.model.sheets.list)i.conditional_formats?.length&&this.UpdateConditionals(i.conditional_formats,i);return}if(!r)throw new Error("invalid call to update conditionals without context");t&&!Array.isArray(t)&&(t=[t]);for(let i of t){let n="";switch(i.type){case"cell-match":i.between?n=`BETWEEN(${[this.Unresolve(i.area,r,!0,!1),...i.between].join(", ")})`:n=this.Unresolve(i.area,r,!0,!1)+" "+i.expression;break;case"expression":n=i.expression;break;case"duplicate-values":n=`UniqueValues(${this.Unresolve(i.area,r,!0,!1)})`,i.unique||(n=`NOT(${n})`);break;case"gradient":n=`=Gradient(${[this.Unresolve(i.area,r,!0,!1),i.min??"",i.max??""].join(",")})`;break;default:continue}if(!n)continue;if(i.internal||(i.internal={}),!i.internal.vertex){let a=new at;a.use="conditional",i.internal.vertex=a;let l={argument_separator:","};i.type!=="gradient"&&i.type!=="duplicate-values"&&(l={...i.options,...l});let u=this.Evaluate(n,r,l,!0);i.internal.vertex.result=u,i.internal.vertex.updated=!0}let s=i.internal.vertex;this.AddLeafVertex(s),this.UpdateLeafVertex(s,n,r,".")}}RemoveAnnotation(t){let r=t.temp;r.vertex&&(r.vertex.Reset(),this.RemoveLeafVertex(r.vertex))}UpdateAnnotations(t,r){if(!t){for(let i of this.model.sheets.list)this.UpdateAnnotations(i.annotations,i);return}if(!r)throw new Error("invalid call to UpdateAnnotations with list but no sheet");typeof t<"u"&&!Array.isArray(t)&&(t=[t]);for(let i of t)if(i.data.formula){let n=i.temp;n.vertex||(n.vertex=new ct),this.AddLeafVertex(n.vertex),this.UpdateLeafVertex(n.vertex,i.data.formula,r)}}ResolveExpressionAddress(t,r){switch(t.type){case"address":if(this.model.ResolveSheetID(t,r))return new M(t);break;case"range":if(this.model.ResolveSheetID(t,r))return new M(t.start,t.end);break;case"identifier":{let i=this.model.GetName(t.name,r?.sheet_id||0);if(i&&i.type==="range")return new M(i.area.start,i.area.end)}break}}NamedRangeToAddressUnit(t,r){let i=t.name.toUpperCase(),n=this.model.GetName(i,r.sheet_id||0);if(n&&n.type==="range")return n.area.count===1?this.ConstructAddressUnit(n.area.start,i,t.id,t.position):{type:"range",start:this.ConstructAddressUnit(n.area.start,i,t.id,t.position),end:this.ConstructAddressUnit(n.area.end,i,t.id,t.position),label:i,id:t.id,position:t.position}}ConstructAddressUnit(t,r,i,n){return{type:"address",row:t.row,column:t.column,sheet_id:t.sheet_id,label:r,id:i,position:n}}RebuildDependencies(t,r,i,n={addresses:{},ranges:{}},s){if(!i){let a=this.model.sheets.Find(r);a&&(i=a.name)}switch(t.type){case"literal":case"missing":case"operator":break;case"identifier":{let a=this.model.GetName(t.name,s.sheet_id||0);if(a?.type==="expression")this.RebuildDependencies(a.expression,r,i,n,s);else{let l=this.NamedRangeToAddressUnit(t,s);l&&(l.type==="address"?n.addresses[l.label]=l:n.ranges[l.label]=l)}}break;case"structured-reference":{let a=this.model.ResolveStructuredReference(t,s);a&&(a.type==="address"?n.addresses[a.sheet_id+"!"+a.label]=a:n.ranges[a.label]=a);let l=this.model.tables.get(t.table.toLowerCase());if(l){let u=s.row;if(u<l.area.start.row||u>l.area.end.row)break;let c=t.column.toLowerCase(),h=-1;if(l.columns){for(let f=0;f<l.columns.length;f++)if(c===l.columns[f]){h=l.area.start.column+f;break}}if(h>=0){let f={label:t.label,type:"address",row:u,column:h,sheet_id:l.area.start.sheet_id,id:t.id,position:t.position};n.addresses[f.sheet_id+"!"+f.label]=f}}}break;case"address":if(!t.sheet_id)if(t.sheet){let a=this.model.sheets.Find(t.sheet);a&&(t.sheet_id=a.id)}else t.sheet_id=r,t.sheet=i;t.sheet_id?n.addresses[t.sheet_id+"!"+t.label]=t:console.warn("invalid address in range [9d]");break;case"range":if(!t.start.sheet_id)if(t.start.sheet){let a=this.model.sheets.Find(t.start.sheet);a&&(t.start.sheet_id=a.id)}else t.start.sheet_id=r,t.start.sheet=i;t.start.sheet_id?n.ranges[t.start.sheet_id+"!"+t.start.label+":"+t.end.label]=t:console.warn("invalid sheet in range",t);break;case"unary":this.RebuildDependencies(t.operand,r,i,n,s);break;case"binary":this.RebuildDependencies(t.left,r,i,n,s),this.RebuildDependencies(t.right,r,i,n,s);break;case"group":t.elements.forEach(a=>this.RebuildDependencies(a,r,i,n,s));break;case"implicit-call":{for(let a of t.args)this.RebuildDependencies(a,r,i,n,s);this.RebuildDependencies(t.call,r,i,n,s)}break;case"call":{let a=t.args.slice(0),l=this.library.Get(t.name);l&&l.arguments&&l.arguments.forEach((u,c)=>{u&&u.address&&(this.RebuildDependencies(a[c],r,i,void 0,s),a[c]={type:"missing",id:-1})}),a.forEach(u=>this.RebuildDependencies(u,r,i,n,s))}break}return n}UpdateLeafVertex(t,r,i,n){t.Reset(),n&&(this.parser.Save(),this.parser.SetLocaleSettings(n));let s=this.parser.Parse(r);if(s.expression){let a=this.RebuildDependencies(s.expression,i.id,i.name,void 0,{row:0,column:0});for(let l of Object.keys(a.ranges)){let u=a.ranges[l],c=new M(u.start,u.end);c.entire_column||c.entire_row||c.count>1?this.AddLeafVertexArrayEdge(c,t):this.AddLeafVertexEdge(c.start,t)}for(let l of Object.keys(a.addresses)){let u=a.addresses[l];this.AddLeafVertexEdge(u,t)}}t.expression=s.expression||{type:"missing",id:-1},t.expression_error=!s.valid,n&&this.parser.Restore()}RebuildGraphCell(t,r){if(t.spill&&this.options.spill&&(t.spill.start.row===r.row&&t.spill.start.column===r.column?this.AttachSpillData(new M(t.spill.start,t.spill.end)):this.AddEdge(t.spill.start,r)),t.area&&t.area.start.column===r.column&&t.area.start.row===r.row){let{start:i,end:n}=t.area,s=i.sheet_id||r.sheet_id;i.sheet_id||(i.sheet_id=s);for(let a=i.column;a<=n.column;a++)for(let l=i.row;l<=n.row;l++)this.ResetInbound({column:a,row:l,sheet_id:s},!0,!1);this.SetDirty(r);for(let a=i.column;a<=n.column;a++)for(let l=i.row;l<=n.row;l++)l===i.row&&a===i.column||this.AddEdge(i,{...i,row:l,column:a})}if(t.type===1){this.ResetInbound(r,!0);let i=this.parser.Parse(t.value);if(i.expression){if(i.expression.type==="call"){let a=this.library.Get(i.expression.name);a&&(a.render||a.click)&&(t.render_function=a.render,t.click_function=a.click)}let s=this.RebuildDependencies(i.expression,r.sheet_id,"",void 0,r);for(let a of Object.keys(s.ranges)){let l=s.ranges[a],u=new M(l.start,l.end);if(u.entire_row||u.entire_column)this.AddArrayEdge(u,r);else for(let c of u)this.AddEdge(c,r)}for(let a of Object.keys(s.addresses)){let l=s.addresses[a];this.AddEdge(l,r)}}let n=this.GetVertex(r,!0);n&&(n.expression=i.expression||{type:"missing",id:-1},n.expression_error=!i.valid)}else t.value!==t.calculated?this.ResetInbound(r,!0,!1):t.type===0&&this.ResetInbound(r,!0,!1,!0)}RebuildGraph(t){if(t){if(!t.start.sheet_id)throw new Error("subset missing sheet id");let r=this.model.sheets.Find(t.start.sheet_id)?.cells;if(r)for(let i=t.start.row;i<=t.end.row;i++){let n=r.data[i];if(n)for(let s=t.start.column;s<=t.end.column;s++){let a=n[s];a&&this.RebuildGraphCell(a,{row:i,column:s,sheet_id:t.start.sheet_id})}}}else for(let r of this.model.sheets.list||[]){let i=r.cells.data.length;for(let n=0;n<i;n++){let s=r.cells.data[n];if(s){let a=s.length;for(let l=0;l<a;l++){let u=s[l];u&&this.RebuildGraphCell(u,{row:n,column:l,sheet_id:r.id})}}}}}CheckVolatile(t){if(!t.expression||t.expression_error)return!1;let r=!1;return this.parser.Walk(t.expression,i=>{if(i.type==="call"){let n=this.library.Get(i.name);n&&n.volatile&&(r=!0)}return!r}),r}};var bs=o=>{let e=4+o.data.length,t=new Float64Array(e);return t[0]=o.column,t[1]=o.row,t[2]=o.sheet_id,t[3]=o.data.length,t.set(o.data,4),t},ys=o=>o.length===3+o[2]&&o[2]===5e3?(console.warn("old-style data"),{column:o[0],row:o[1],sheet_id:0,data:o.subarray(3)}):{column:o[0],row:o[1],sheet_id:o[2],data:o.subarray(4)};var ke=(o,e)=>{let t=[];for(let r=0;r<o;r++){let i=[];for(let n=0;n<e;n++)i.push(0);t.push(i)}return{m:o,n:e,data:t}},Ri=o=>{let e=ke(o,o);for(let t=0;t<o;t++)e.data[t][t]=1;return e},gs=o=>(o=JSON.parse(JSON.stringify(o)),{m:o.length,n:o[0].length,data:o}),Ut=o=>{let e=[];for(let t=0;t<o.n;t++){let r=[];for(let i=0;i<o.m;i++)r.push(o.data[i][t]);e.push(r)}return{m:o.n,n:o.m,data:e}},Vt=(o,e)=>{if(o.n!==e.m)throw new Error("invalid multiply");let t=ke(o.m,e.n);for(let r=0;r<o.m;r++)for(let i=0;i<e.n;i++){let n=0;for(let s=0;s<e.m;s++)n+=o.data[r][s]*e.data[s][i];t.data[r][i]=n}return t};var xr=class{constructor(e=ke(2,2),t=ke(1,1),r=ke(1,1)){this.j_matrix=e;this.q_matrix=t;this.r_matrix=r}Inverse(e){if(e.n!==e.m)throw new Error("matrix must be square");let t=Ri(e.m);return this.Decompose(e),this.Solve(t)}Solve(e){let t=Vt(Ut(this.q_matrix),e),r=this.r_matrix.n,i=ke(1,r);for(let n=r-1;n>=0;n--){i.data[0][n]=t.data[n][0];for(let s=n+1;s<r;s++)i.data[0][n]=i.data[0][n]-i.data[0][s]*this.r_matrix.data[n][s];i.data[0][n]=i.data[0][n]/this.r_matrix.data[n][n]}return i}Decompose(e){let t=e.m,r=e.n;t==r?r--:t<r&&(r=t-1),this.q_matrix=Ri(t),this.r_matrix=e;for(let i=0;i<r;i++)for(let n=i+1;n<t;n++)this.GivensRotation(this.r_matrix.data[i][i],this.r_matrix.data[n][i]),this.PreMultiplyGivens(this.r_matrix,i,n),this.PreMultiplyGivens(this.q_matrix,i,n);this.q_matrix=Ut(this.q_matrix)}GivensRotation(e,t){let r=0,i=0,n=0;t===0?(n=e>=0?1:-1,i=0):e===0?(n=0,i=t>=0?-1:1):Math.abs(t)>Math.abs(e)?(r=e/t,i=-1/Math.sqrt(1+r*r),n=-i*r):(r=t/e,n=1/Math.sqrt(1+r*r),i=-n*r),this.j_matrix.data[0][0]=n,this.j_matrix.data[0][1]=-i,this.j_matrix.data[1][0]=i,this.j_matrix.data[1][1]=n}PreMultiplyGivens(e,t,r){for(let i=0;i<e.n;i++){let n=e.data[t][i]*this.j_matrix.data[0][0]+e.data[r][i]*this.j_matrix.data[0][1];e.data[r][i]=e.data[t][i]*this.j_matrix.data[1][0]+e.data[r][i]*this.j_matrix.data[1][1],e.data[t][i]=n}}};var Cr=class{eta=0;are=0;mre=0;n=0;nn=0;nmi=0;zerok=!1;p=[];qp=[];k=[];qk=[];svk=[];sr=0;si=0;u=0;v=0;a=0;b=0;c=0;d=0;a1=0;a2=0;a3=0;a6=0;a7=0;e=0;f=0;g=0;h=0;szr=0;szi=0;lzr=0;lzi=0;findRoots(e,t,r,i){let n=0,s=0,a=0,l=0,u=[],c=0,h=0,f=[],d=0,m=0,_=0,y=0,v=0,w=0,x=0,C=0,A=0,S=0,p=0,b=0,g=0,D=0,I=0,U=0,O=0,j=0,te=0,fe=0,T=0,Q=0,Er=0,Ti=0,Tr=0,Dt=!1;if(j=2,this.eta=222e-18,U=34e37,O=12e-39,this.are=this.eta,this.mre=this.eta,d=O/this.eta,y=Math.sqrt(.5),v=-y,h=94,h*=.017453293,w=Math.cos(h),x=Math.sin(h),this.n=t,this.n<1||e[0]==0)return-1;for(;e[this.n]==0;)Q=t-this.n,r[Q]=0,i[Q]=0,this.n--;if(this.n===0)return t;for(u=[],f=[],this.p=[],this.qp=[],this.k=[],this.qk=[],this.svk=[],T=0;T<=this.n;T++)this.p[T]=e[T];e:for(;;){if(this.n==1)return r[t-1]=-this.p[1]/this.p[0],i[t-1]=0,this.n-=1,t-this.n;if(this.n==2){let Ee={sr:r[t-2],si:i[t-2],lr:r[t-1],li:i[t-1]};return this.quad(this.p[0],this.p[1],this.p[2],Ee),r[t-2]=Ee.sr,i[t-2]=Ee.si,r[t-1]=Ee.lr,i[t-1]=Ee.li,this.n-=2,t-this.n}for(m=0,_=U,T=0;T<=this.n;T++)A=Math.abs(this.p[T]),A>m&&(m=A),A!=0&&A<_&&(_=A);switch(!0){case!0:if(S=d/_,S>1&&U/S<m)break;if(S<=1){if(m<10)break;S==0&&(S=O)}if(Ti=Math.floor(Math.log(S)/Math.log(j)+.5),c=Math.pow(j,Ti),c!=1)for(T=0;T<=this.n;T++)this.p[T]=c*this.p[T]}for(T=0;T<=this.n;T++)f[T]=Math.abs(this.p[T]);for(f[this.n]=-f[this.n],A=Math.exp((Math.log(-f[this.n])-Math.log(f[0]))/this.n),f[this.n-1]!=0&&(b=-f[this.n]/f[this.n-1],b<A&&(A=b));;){for(b=A*.1,g=f[0],T=1;T<=this.n;T++)g=g*b+f[T];if(g<=0)break;A=b}for(I=A;Math.abs(I/A)>.005;){for(g=f[0],D=g,T=1;T<this.n;T++)g=g*A+f[T],D=D*A+g;g=g*A+f[this.n],I=g/D,A-=I}for(p=A,Tr=this.n-1,T=1;T<this.n;T++)this.k[T]=(this.n-T)*this.p[T]/this.n;for(this.k[0]=this.p[0],s=this.p[this.n],a=this.p[this.n-1],Dt=this.k[this.n-1]===0,Er=0;Er<5;Er++)if(l=this.k[this.n-1],Dt){for(T=0;T<Tr;T++)Q=this.n-T-1,this.k[Q]=this.k[Q-1];this.k[0]=0,Dt=this.k[this.n-1]===0}else{for(n=-s/l,T=0;T<Tr;T++)Q=this.n-T-1,this.k[Q]=n*this.k[Q-1]+this.p[Q];this.k[0]=this.p[0],Dt=Math.abs(this.k[this.n-1])<=Math.abs(a)*this.eta*10}for(T=0;T<this.n;T++)u[T]=this.k[T];for(te=0;te<20;te++){C=w*y-x*v,v=x*y+w*v,y=C,this.sr=p*y,this.si=p*v,this.u=-2*this.sr,this.v=p;{let Ee={nz:fe};this.fxshfr(20*(te+1),Ee),fe=Ee.nz}if(fe!=0){for(Q=t-this.n,r[Q]=this.szr,i[Q]=this.szi,this.n-=fe,T=0;T<=this.n;T++)this.p[T]=this.qp[T];fe!=1&&(r[Q+1]=this.lzr,i[Q+1]=this.lzi);continue e}for(T=0;T<this.n;T++)this.k[T]=u[T]}return t-this.n}}quad(e,t,r,i){let n=0,s=0,a=0;if(e==0){t!=0?i.sr=-r/t:i.sr=0,i.lr=0,i.si=0,i.li=0;return}if(r==0){i.sr=0,i.lr=-t/e,i.si=0,i.li=0;return}n=t/2,Math.abs(n)<Math.abs(r)?(r<0?a=-e:a=e,a=n*(n/Math.abs(r))-a,s=Math.sqrt(Math.abs(a))*Math.sqrt(Math.abs(r))):(a=1-e/n*(r/n),s=Math.sqrt(Math.abs(a))*Math.abs(n)),a<0?(i.sr=-n/e,i.lr=i.sr,i.si=Math.abs(s/e),i.li=-i.si):(n>=0&&(s=-s),i.lr=(-n+s)/e,i.sr=0,i.lr!=0&&(i.sr=r/i.lr/e),i.si=0,i.li=0)}fxshfr(e,t){let r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0,f=0,d=0,m=0,_=0,y=0,v=0,w=0,x=0,C=0,A=0,S=0,p=0,b=!1,g=!1,D=0,I=0;t.nz=0,u=.25,l=.25,c=this.sr,h=this.v;{let U={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,U),this.u=U.u,this.v=U.v,this.a=U.a,this.b=U.b}for(C=this.calcsc_(C),S=0;S<e;S++){C=this.nextk_(C),C=this.calcsc_(C);{let U={uu:n,vv:s};this.newest(C,U),n=U.uu,s=U.vv}switch(d=s,f=0,this.k[this.n-1]!=0&&(f=-this.p[this.n]/this.k[this.n-1]),_=1,m=1,!0){case!0:{if(S==0||C==3||(d!=0&&(_=Math.abs((d-h)/d)),f!=0&&(m=Math.abs((f-c)/f)),w=1,_<v&&(w=_*v),x=1,m<y&&(x=m*y),b=w<u,g=x<l,!(g||b)))break;for(r=this.u,i=this.v,A=0;A<this.n;A++)this.svk[A]=this.k[A];a=f,D=0,I=0;let U=!1;(g&&!b||x<w)&&(U=!0);e:for(;;){if(!U){{let O={uu:n,vv:s,nz:t.nz};this.quadit(O),n=O.uu,s=O.vv,t.nz=O.nz}if(t.nz>0)return;D=1,u*=.25}switch(!0){case!0:if(!U){if(I||!g)break;for(A=0;A<this.n;A++)this.k[A]=this.svk[A]}U=!1;{let O={sss:a,nz:t.nz,iflag:p};this.realit(O),a=O.sss,t.nz=O.nz,p=O.iflag}if(t.nz>0)return;if(I=1,l*=.25,p==0)break;n=-(a+a),s=a*a;continue e}for(this.u=r,this.v=i,A=0;A<this.n;A++)this.k[A]=this.svk[A];if(b&&!D)continue e;break}{let O={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,O),this.u=O.u,this.v=O.v,this.a=O.a,this.b=O.b}C=this.calcsc_(C)}}h=d,c=f,v=_,y=m}}quadit(e){let t=0,r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0,f=0,d=0;for(e.nz=0,d=0,this.u=e.uu,this.v=e.vv,f=0;;){{let m={sr:this.szr,si:this.szi,lr:this.lzr,li:this.lzi};this.quad(1,this.u,this.v,m),this.szr=m.sr,this.szi=m.si,this.lzr=m.lr,this.lzi=m.li}if(Math.abs(Math.abs(this.szr)-Math.abs(this.lzr))>.01*Math.max(Math.abs(this.lzr),.1))return;{let m={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,m),this.u=m.u,this.v=m.v,this.a=m.a,this.b=m.b}for(i=Math.abs(this.a-this.szr*this.b)+Math.abs(this.szi*this.b),u=Math.sqrt(Math.abs(this.v)),s=2*Math.abs(this.qp[0]),l=-this.szr*this.b,h=1;h<this.n;h++)s=s*u+Math.abs(this.qp[h]);if(s=s*u+Math.abs(this.a+l),s*=5*this.mre+4*this.are,s=s-(5*this.mre+2*this.are)*(Math.abs(this.a+l)+Math.abs(this.b)*u)+2*this.are*Math.abs(l),i<=20*s){e.nz=2;return}if(f++,f>20)return;switch(!0){case!0:if(f<2||a>.01||i<n||d)break;a<this.eta&&(a=this.eta),a=Math.sqrt(a),this.u=this.u-this.u*a,this.v=this.v+this.v*a;{let m={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,m),this.u=m.u,this.v=m.v,this.a=m.a,this.b=m.b}for(h=0;h<5;h++)c=this.calcsc_(c),c=this.nextk_(c);d=1,f=0}n=i,c=this.calcsc_(c),c=this.nextk_(c),c=this.calcsc_(c);{let m={uu:t,vv:r};this.newest(c,m),t=m.uu,r=m.vv}if(r==0)return;a=Math.abs((r-this.v)/r),this.u=t,this.v=r}}realit(e){let t=0,r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0;for(e.nz=0,n=e.sss,e.iflag=0,h=0;;){for(t=this.p[0],this.qp[0]=t,c=1;c<=this.n;c++)t=t*n+this.p[c],this.qp[c]=t;for(a=Math.abs(t),s=Math.abs(n),u=this.mre/(this.are+this.mre)*Math.abs(this.qp[0]),c=1;c<=this.n;c++)u=u*s+Math.abs(this.qp[c]);if(a<=20*((this.are+this.mre)*u-this.mre*a)){e.nz=1,this.szr=n,this.szi=0;return}if(h++,h>10)return;switch(!0){case!0:if(h<2||Math.abs(i)>.001*Math.abs(n-i)||a<l)break;e.iflag=1,e.sss=n;return}for(l=a,r=this.k[0],this.qk[0]=r,c=1;c<this.n;c++)r=r*n+this.k[c],this.qk[c]=r;if(Math.abs(r)<=Math.abs(this.k[this.n-1])*10*this.eta)for(this.k[0]=0,c=1;c<this.n;c++)this.k[c]=this.qk[c-1];else for(i=-t/r,this.k[0]=this.qp[0],c=1;c<this.n;c++)this.k[c]=i*this.qk[c-1]+this.qp[c];for(r=this.k[0],c=1;c<this.n;c++)r=r*n+this.k[c];i=0,Math.abs(r)>Math.abs(this.k[this.n-1]*10*this.eta)&&(i=-t/r),n+=i}}calcsc_(e){let t={u:this.u,v:this.v,a:this.c,b:this.d};switch(this.quadsd_(this.n-1,this.k,this.qk,t),this.u=t.u,this.v=t.v,this.c=t.a,this.d=t.b,!0){case!0:if(Math.abs(this.c)>Math.abs(this.k[this.n-1]*100*this.eta)||Math.abs(this.d)>Math.abs(this.k[this.n-2]*100*this.eta))break;return e=3,e}return Math.abs(this.d)<Math.abs(this.c)?(e=1,this.e=this.a/this.c,this.f=this.d/this.c,this.g=this.u*this.e,this.h=this.v*this.b,this.a3=this.a*this.e+(this.h/this.c+this.g)*this.b,this.a1=this.b-this.a*(this.d/this.c),this.a7=this.a+this.g*this.d+this.h*this.f,e):(e=2,this.e=this.a/this.d,this.f=this.c/this.d,this.g=this.u*this.b,this.h=this.v*this.b,this.a3=(this.a+this.g)*this.e+this.h*(this.b/this.d),this.a1=this.b*this.f-this.a,this.a7=(this.f+this.u)*this.a+this.h,e)}nextk_(e){let t=0,r=0;if(e===3){for(this.k[0]=0,this.k[1]=0,r=2;r<this.n;r++)this.k[r]=this.qk[r-2];return e}if(t=this.a,e===1&&(t=this.b),Math.abs(this.a1)<=Math.abs(t)*this.eta*10){for(this.k[0]=0,this.k[1]=-this.a7*this.qp[0],r=2;r<this.n;r++)this.k[r]=this.a3*this.qk[r-2]-this.a7*this.qp[r-1];return e}for(this.a7/=this.a1,this.a3/=this.a1,this.k[0]=this.qp[0],this.k[1]=this.qp[1]-this.a7*this.qp[0],r=2;r<this.n;r++)this.k[r]=this.a3*this.qk[r-2]-this.a7*this.qp[r-1]+this.qp[r];return e}newest(e,t){let r=0,i=0,n=0,s=0,a=0,l=0,u=0,c=0,h=0;if(e==3){t.uu=0,t.vv=0;return}if(e==2?(r=(this.a+this.g)*this.f+this.h,i=(this.f+this.u)*this.c+this.v*this.d):(r=this.a+this.u*this.b+this.h*this.f,i=this.c+(this.u+this.v*this.f)*this.d),n=-this.k[this.n-1]/this.p[this.n],s=-(this.k[this.n-2]+n*this.p[this.n-1])/this.p[this.n],a=this.v*s*this.a1,l=n*this.a7,u=n*n*this.a3,c=a-l-u,h=i+n*r-c,h==0){t.uu=0,t.vv=0;return}t.uu=this.u-(this.u*(u+l)+this.v*(n*this.a1+s*this.a7))/h,t.vv=this.v*(1+c/h)}quadsd_(e,t,r,i){let n=0,s=0;for(i.b=t[0],r[0]=i.b,i.a=t[1]-i.b*i.u,r[1]=i.a,s=2;s<=e;s++)n=t[s]-i.a*i.u-i.b*i.v,r[s]=n,i.b=i.a,i.a=n}};var ze=class{static Roots(e){let t=e.slice(0);for(t.reverse();t.length>0&&t[0]===0;)t.splice(0,1);let i=t.length-1,n=[],s=[],a=new Cr().findRoots(t,i,n,s),l=[];for(let u=0;u<a;u++)l.push({real:n[u]||0,imaginary:s[u]||0});return l}static Apply(e,t){if(e.length===0)return 0;let r=0,i=1;for(let n=0;n<e.length;n++)r+=i*e[n],i*=t;return r}static Fit(e,t,r){if(e.length!==t.length)throw new Error("invalid data (x.length !== y.length)");if(!e.length)throw new Error("invalid data (len = 0)");e=e.map(f=>typeof f=="number"?f:0),t=t.map(f=>typeof f=="number"?f:0),r++;let i=e.length,n=gs(t.map(f=>[f])),s=ke(i,r);for(let f=0;f<i;f++){let d=1;for(let m=0;m<r;m++)s.data[f][m]=d,d*=e[f]}let a=Ut(s),l=Vt(a,s),u=Vt(a,n),c=new xr;return c.Decompose(l),c.Solve(u).data[0]}};var ws=o=>{let e={},t=o.length;for(let r=0;r<t;r++){if(o[r].length!==t)return e.square=!1,e;if(Math.abs(o[r][r]-1)>1e-7)return e.unit_diagonal=!1,e}if(e.square=!0,e.unit_diagonal=!0,o.some(r=>r.some(i=>typeof i!="number"))){if(t>1&&o[0][1]!==void 0?(e.range="upper",o=Ne(o)):e.range="lower",t>1&&o[1][0]!==void 0)for(let r=0;r<t;r++)for(let i=r+1;i<t;i++){if(typeof o[r][i]<"u"&&o[r][i]!=="")return e.range=void 0,e;o[r][i]=o[i][r]}}else{e.range="full";for(let r=0;r<t;r++)for(let i=1;i<t;i++)if(o[r][i]!==o[i][r])return e;e.symmetric=!0}return e.data=o,e},Oe=(o,e,t)=>(o=Math.floor(o),e=Math.floor(e),t=Math.floor(t)+1,e=e+(e-o)/(t-o),[o,e,t]),ht=o=>{for(let e=0;e<o.length;e++)o[e]=Math.floor(o[e]);return o},xs=o=>{let e=k.Uniform(o),t=[];for(let r=0;r<o;r++)t[r]=r;for(let r=0;r<o;r++){let i=r+Math.floor(e[r]*(o-r)),n=t[r];t[r]=t[i],t[i]=n}return t},Sr=class{constructor(e){this.model=e;this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"UniformValue.Discrete":{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},WeibullValue:{description:"Returns a sample from the Weibull distribution",simulation_volatile:!0,arguments:[{name:"lambda",description:"Scale"},{name:"k",description:"Shape"}],fn:this.weibullvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BinomialValue:{description:"Returns a sample from the binomial distribution",simulation_volatile:!0,arguments:[{name:"Probability of success",description:"Probability of success in each trial"},{name:"Trials",description:"Number of trials"}],fn:this.binomialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NegativeBinomialValue:{description:"Returns a sample from the negative-binomial distribution",simulation_volatile:!0,arguments:[{name:"Probability of success",description:"Probability of success in each trial"},{name:"Target number of trials",description:"Target number of successful trials"}],fn:this.negativebinomialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PoisssonValue:{description:"Returns a sample from the poisson distribution",simulation_volatile:!0,arguments:[{name:"m",description:"Mean"}],fn:this.poissonvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.Discrete":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},ScaledLognormalValue:{description:"Returns a sample from the log-normal distribution, scaled to the desired mean and standard deviation",simulation_volatile:!0,arguments:[{name:"mean",description:"Target mean",default:0},{name:"stdev",description:"Standard deviation",default:1}],fn:this.scaledlognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"TriangularValue.Discrete":{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelationMatrix:{description:"Returns the correlation among a set of data, as a matrix",arguments:[{name:"range",description:"Range of data",collector:!0},{name:"full matrix",description:"Return the full matrix"}],fn:this.simulationcorrelationmatrix.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationIntercept:{arguments:[{name:"x",collector:!0},{name:"y",collector:!0}],fn:this.simulationintercept.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSlope:{arguments:[{name:"x",collector:!0},{name:"y",collector:!0}],fn:this.simulationslope.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMode:{description:"Returns the mode of the data from this cell in the simulation. Use for discrete data only.",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmode.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationGeometricMean:{description:"Returns the geometric mean of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationgeometricmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValue.Cumulative":{description:"Returns the value of this cell in the simulation at the given trial number (cumulative)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue_cumulative.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationHistogramBin:{arguments:[{name:"reference cell",collector:!0},{name:"count"},{name:"index"},{name:"round"}],fn:this.SimulationHistogramBin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationHistogramBinLabel:{arguments:[{name:"reference cell",collector:!0},{name:"count"},{name:"index"},{name:"round"}],fn:this.SimulationHistogramBinLabel.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},HasSimulationData:{description:"Returns TRUE if simulation data is available for a cell",fn:this.hassimulationdata.bind(this),arguments:[{name:"reference cell",description:"Source Cell",metadata:!0}],category:["RiskAMP Simulation Functions"],extension:!0,volatile:!0},"RiskAMP.IsPosDef":{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:t=>{let r=ws(t);if(!r.square||!r.range||!r.data)return E();let i=ae.FromArray(r.data);return{type:4,value:i.IsPosDef()}},extension:!0},"RiskAMP.MakePosDef":{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:t=>{let r=ws(t);if(!r.square||!r.range||!r.data)return E();let i=[],n=ae.FromArray(r.data);if(!n.IsPosDef())for(let s=0;s<8&&(n=n.MakePosDef(),!n.IsPosDef());s++);return i=n.ToArray(),{type:8,value:i.map(s=>s.map(a=>({type:3,value:a})))}},extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(t,r=!1)=>{if(!t||!Array.isArray(t))return R();let i=ae.FromArray(t).Cholesky(r).ToArray();return{type:8,value:i.map(n=>n.map(s=>({type:3,value:s})))}},extension:!0},Identity:{description:"Returns the identity matrix for a given size",arguments:[{name:"size",description:"size of matrix in rows/coulmns"},{name:"scale",default:1,description:"optionally multipy by a scalar value"}],fn:(t=0,r=1)=>{if(t<1)return R();let i={type:3,value:0},n=G(r),s=[];for(let a=0;a<t;a++){let l=[];for(let u=0;u<t;u++)l.push(a===u?n:i);s.push(l)}return{type:8,value:s}}},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:t=>{if(t.some(n=>n.some(s=>typeof s!="number")))return E();let i=ae.FromArray(t).EigenSystem();return{type:8,value:[i.realvalues.map(n=>({type:3,value:n}))]}},extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:t=>{if(t.some(n=>n.some(s=>typeof s!="number")))return E();let i=ae.FromArray(t).EigenSystem();return{type:8,value:i.vectors.map(n=>Array.from(n).map(s=>({type:3,value:s})))}},extension:!0},SimulationQuartiles:{description:"Returns the minimum, 1st quartile, median, 3rd quartile and maximum value",arguments:[{name:"reference cell",collector:!0}],fn:this.SimulationQuartiles.bind(this)},"RiskAMP.Task":{description:"Models a task with dependencies for project planning",arguments:[{name:"Sample"},{name:"Depdendency",repeat:!0}],fn:(t=0,...r)=>{let i=L(r),n=0;for(let s of i)typeof s=="number"&&s>n&&(n=s);return{type:3,value:t+n}},extension:!0},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0},{name:"type",default:1}],fn:this.HistogramTable.bind(this),extension:!0},"RiskAMP.Permutation":{description:"Creates a random permutation of source data",arguments:[{name:"range",boxed:!0}],fn:this.Permutation.bind(this),extension:!0,simulation_volatile:!0},"RiskAMP.Filter":{description:"Filter simulation results based on a second cell",arguments:[{name:"Source",description:"Data source cell",collector:!0},{name:"Filter",description:"Filter criteria cell",collector:!0}],extension:!0,fn:this.Filter.bind(this)},"RiskAMP.CountInRange":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"}],extension:!0,fn:this.CountInRange.bind(this)},"RiskAMP.IntervalStatistics":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"},{name:"Value reference",description:"Value reference",collector:!0}],extension:!0,fn:this.IntervalStatistics.bind(this)},"RiskAMP.IntervalInRange":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"},{name:"Value reference",description:"Value reference",collector:!0},{name:"Value min",description:"Value min"},{name:"Value max",description:"Value max"}],extension:!0,fn:this.IntervalInRange.bind(this)},"RiskAMP.Polynomial.Fit":{description:"Fit polynomial",arguments:[{name:"x",description:"x"},{name:"y",description:"y"},{name:"degree",description:"degree"}],extension:!0,fn:this.PolynomialFit.bind(this)},"RiskAMP.Polynomial.Apply":{description:"Apply polynomial",arguments:[{name:"coefficients"},{name:"x",boxed:!0}],extension:!0,fn:this.PolynomialApply.bind(this)},"RiskAMP.Polynomial.RealRoots":{description:"Find real roots of a polynomial",arguments:[],extension:!0,fn:this.PolynomialRealRoots.bind(this)},"RiskAMP.Polynomial.Roots":{description:"Find roots of a polynomial",arguments:[],extension:!0,fn:this.PolynomialRoots.bind(this)}},this.lv_functions={"Simulation.LV.Accepted":{description:"Count of accepted trials in a Las Vegas simulation",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVAccepted.bind(this)},"Simulation.LV.Rejected":{description:"Count of rejected trials in a Las Vegas simulation",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVRejected.bind(this)},"Simulation.LV.Succeeded":{description:"Returns TRUE if a Las Vegas simulation completed successfully",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVSucceeded.bind(this)}},this.aliases={IsPosDef:"RiskAMP.IsPosDef",MakePosDef:"RiskAMP.MakePosDef",ProbabilityValue:"BernoulliValue"}}bindings=[];address={row:0,column:0};area;volatile=!1;iteration=0;iterations=0;lhs=!1;state=0;lv_state;first_iteration=0;results=[];distribution_id=0;triples=[];elapsed=0;trials=0;set seed(e){k.rng.Seed(e)}distributions=new Map;correlation_data=new Map;functions;lv_functions;aliases;LVAccepted(){return{type:3,value:this.lv_state?.accepted||0}}LVRejected(){return{type:3,value:this.lv_state?.rejected||0}}LVSucceeded(){let e=!1;return this.lv_state&&(e=!!this.lv_state.succeeded),{type:4,value:e}}CallerArea(){let e=1,t=1,r;if(this.address.sheet_id){let i=this.model.sheets.Find(this.address.sheet_id);i&&i.cells.data[this.address.row]&&(r=i.cells.data[this.address.row][this.address.column])}return r?.area&&(e=r.area.rows,t=r.area.columns),{rows:e,columns:t}}ResetDistributions(){this.distributions.clear(),this.correlation_data.clear()}CorrelateDistributions(){for(let e of this.correlation_data.values()){e.addresses.sort((r,i)=>r.column===i.column?r.row-i.row:r.column-i.column);let t=e.addresses.map(r=>this.distributions.get(r.distribution_id)||[]);try{let r=k.CorrelateCDM(e.correlation,t,!0);for(let[i,n]of e.addresses.entries())this.distributions.set(n.distribution_id,r[i])}catch(r){console.warn(r)}}}StoreCellResults(e){if(e||(e=this.address),!e)return;if(!e.sheet_id)throw new Error("SCR called without sheet id");this.results[e.sheet_id]||(this.results[e.sheet_id]=[]),this.results[e.sheet_id][e.column]||(this.results[e.sheet_id][e.column]=[]);let t=this.results[e.sheet_id][e.column];return t[e.row]||(t[e.row]=[]),t[e.row]}PrepMultivariate(e,t){let r=this.correlation_data.get(e);if(!r){let i=De.FromArray(t);if(!i.IsSymmetric()){for(let n=1;n<t.length;n++)for(let s=0;s<n;s++)if(t[n][s]){console.warn("invalid lower-triangular matrix");break}i=i.Symmetrize(!0)}r={correlation:i,addresses:[]},this.correlation_data.set(e,r)}r.addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,distribution_id:this.distribution_id})}ValidateCorrelationMatrix(e){let t=ae.FromArray(e);return t.IsSymmetric()||(t=t.Symmetrize(!0)),!(e.some(r=>r.some(i=>typeof i!="number"&&typeof i<"u"))||!t.IsPosDef())}multivariate_normal(e,t,r=0,i=1,n,s){if(this.state===1)this.PrepMultivariate(e,t),typeof n<"u"||typeof s<"u"?this.distributions.set(this.distribution_id,k.TruncatedNormal(this.iterations,{mean:r,sd:i,lhs:this.lhs,ordered:!0,min:n,max:s})):this.distributions.set(this.distribution_id,k.Normal(this.iterations,{mean:r,sd:i,lhs:this.lhs,ordered:!0}));else if(this.state===2){let a=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:a}}return this.ValidateCorrelationMatrix(t)?typeof n<"u"||typeof s<"u"?{type:3,value:k.TruncatedNormal(1,{mean:r,sd:i,min:n,max:s})[0]}:{type:3,value:k.Normal(1,{mean:r,sd:i})[0]}:V()}multivariate_lognormal(e,t,r=0,i=1){if(this.state===1)this.PrepMultivariate(e,t),this.distributions.set(this.distribution_id,k.LogNormal(this.iterations,{mean:r,sd:i,lhs:this.lhs,ordered:!0}));else if(this.state===2){let n=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:n}}return this.ValidateCorrelationMatrix(t)?{type:3,value:k.LogNormal(1,{mean:r,sd:i})[0]}:V()}multivariate_beta(e,t,r=1,i=2){if(this.state===1)this.PrepMultivariate(e,t),this.distributions.set(this.distribution_id,k.Beta(this.iterations,{a:r,b:i,lhs:this.lhs,ordered:!0}));else if(this.state===2){let n=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:n}}return this.ValidateCorrelationMatrix(t)?{type:3,value:k.Beta(1,{a:r,b:i})[0]}:V()}multivariate_uniform(e,t,r=0,i=1,n=!1){if(this.state===1)this.PrepMultivariate(e,t),n?(r=Math.floor(r),i=Math.floor(i+1),this.distributions.set(this.distribution_id,ht(k.Uniform(this.iterations,{min:r,max:i,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,k.Uniform(this.iterations,{min:r,max:i,lhs:this.lhs,ordered:!0}));else if(this.state===2){let s=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:s}}return this.ValidateCorrelationMatrix(t)?n?{type:3,value:Math.floor(k.Uniform(1,{min:Math.floor(r),max:Math.floor(i+1)})[0])}:{type:3,value:k.Uniform(1,{min:r,max:i})[0]}:V()}multivariate_pert(e,t,r=0,i=.5,n=1,s=4,a=!1){if(this.state===1)this.PrepMultivariate(e,t),a?([r,i,n]=Oe(r,i,n),this.distributions.set(this.distribution_id,ht(k.PERT(this.iterations,{a:r,b:n,c:i,lambda:s,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,k.PERT(this.iterations,{a:r,b:n,c:i,lambda:s,lhs:this.lhs,ordered:!0}));else if(this.state===2){let l=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:l}}return this.ValidateCorrelationMatrix(t)?(a&&([r,i,n]=Oe(r,i,n)),{type:3,value:a?Math.floor(k.PERT(1,{a:r,b:n,c:i,lambda:s})[0]):k.PERT(1,{a:r,b:n,c:i,lambda:s})[0]}):V()}multivariate_triangular(e,t,r=0,i=.5,n=1,s=!1){if(this.state===1)this.PrepMultivariate(e,t),s?([r,i,n]=Oe(r,i,n),this.distributions.set(this.distribution_id,ht(k.Triangular(this.iterations,{a:r,b:n,c:i,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,k.Triangular(this.iterations,{a:r,b:n,c:i,lhs:this.lhs,ordered:!0}));else if(this.state===2){let a=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:a}}return this.ValidateCorrelationMatrix(t)?(s&&([r,i,n]=Oe(r,i,n)),{type:3,value:s?Math.floor(k.Triangular(1,{a:r,b:n,c:i})[0]):k.Triangular(1,{a:r,b:n,c:i})[0]}):V()}poissonvalue(e){if(this.state===1)this.distributions.set(this.distribution_id,k.Poisson(this.iterations,{m:e,lhs:this.lhs}));else if(this.state===2){let t=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:t}}return{type:3,value:k.Poisson(1,{m:e})[0]}}binomialvalue(e,t){if(e>1||t>0&&t<1)return R();if(this.state===1)this.distributions.set(this.distribution_id,k.Binomial(this.iterations,{n:t,p:e,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.Binomial(1,{n:t,p:e})[0]}}negativebinomialvalue(e,t){if(e>1||t>0&&t<1)return R();if(this.state===1)this.distributions.set(this.distribution_id,k.NegativeBinomial(this.iterations,{n:t,p:e,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.NegativeBinomial(1,{n:t,p:e})[0]}}uniformvalue(e=!1,t=0,r=1){if(this.state===1)e?(t=Math.floor(t),r=Math.floor(r)+1,this.distributions.set(this.distribution_id,ht(k.Uniform(this.iterations,{min:t,max:r,lhs:this.lhs})))):this.distributions.set(this.distribution_id,k.Uniform(this.iterations,{min:t,max:r,lhs:this.lhs}));else if(this.state===2){let i=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:i}}return{type:3,value:e?Math.floor(k.Uniform(1,{min:t,max:r+1})[0]):k.Uniform(1,{min:t,max:r})[0]}}bernoullivalue(e=.5){if(this.state===1)this.distributions.set(this.distribution_id,k.Bernoulli(this.iterations,{p:e,lhs:this.lhs}).map(t=>t?1:0));else if(this.state===2){let t=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:4,value:!!t}}return{type:4,value:k.Bernoulli(1,{p:e})[0]}}sequentialvalue(e,t=0){if(this.state!==1){if(this.state===2){let r=this.iteration+this.first_iteration;t>0&&(r=this.iteration%t);let i=e[0].length,n=Math.floor(r/i)%e.length,s=r%i;return{type:3,value:e[n][s]}}}return{type:3,value:e[0][0]}}indexvalue(e=0){if(this.state!==1){if(this.state===2)return e>0?{type:3,value:(this.iteration+this.first_iteration)%e+1}:{type:3,value:this.iteration+this.first_iteration+1}}return{type:3,value:1}}scaledlognormalvalue(e=0,t=1){let r=Math.log(e*e/Math.sqrt(e*e+t*t)),i=Math.sqrt(Math.log((e*e+t*t)/(e*e)));return this.lognormalvalue(r,i)}lognormalvalue(e=0,t=1){if(this.state===1)this.distributions.set(this.distribution_id,k.LogNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.LogNormal(1,{mean:e,sd:t})[0]}}truncatednormalvalue(e=0,t=1,r,i){if(this.state===1)this.distributions.set(this.distribution_id,k.TruncatedNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs,min:r,max:i}));else if(this.state===2){let n=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:n}}return{type:3,value:k.TruncatedNormal(1,{mean:e,sd:t,min:r,max:i})[0]}}normalvalue(e=0,t=1){if(this.state===1)this.distributions.set(this.distribution_id,k.Normal(this.iterations,{mean:e,sd:t,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.Normal(1,{mean:e,sd:t})[0]}}pertvalue(e=!1,t=0,r=.5,i=1,n=4){if(this.state===1)e?([t,r,i]=Oe(t,r,i),this.distributions.set(this.distribution_id,ht(k.PERT(this.iterations,{a:t,b:i,c:r,lambda:n,lhs:this.lhs})))):this.distributions.set(this.distribution_id,k.PERT(this.iterations,{a:t,b:i,c:r,lambda:n,lhs:this.lhs}));else if(this.state===2){let s=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:s}}return e&&([t,r,i]=Oe(t,r,i)),{type:3,value:e?Math.floor(k.PERT(1,{a:t,b:i,c:r,lambda:n})[0]):k.PERT(1,{a:t,b:i,c:r,lambda:n})[0]}}pertvalue_p(e=0,t=.5,r=1,i=4){if(this.state===1){let s=k.P80Pert(e,r,t,i);this.distributions.set(this.distribution_id,k.PERT(this.iterations,{...s,lambda:i,lhs:this.lhs}))}else if(this.state===2){let s=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:s}}let n=k.P80Pert(e,r,t,i);return{type:3,value:k.PERT(1,{...n,lambda:i})[0]}}triangularvalue(e=!1,t=0,r=.5,i=1){if(this.state===1)e?([t,r,i]=Oe(t,r,i),this.distributions.set(this.distribution_id,ht(k.Triangular(this.iterations,{a:t,b:i,c:r,lhs:this.lhs})))):this.distributions.set(this.distribution_id,k.Triangular(this.iterations,{a:t,b:i,c:r,lhs:this.lhs}));else if(this.state===2){let n=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:n}}return e&&([t,r,i]=Oe(t,r,i)),{type:3,value:e?Math.floor(k.Triangular(1,{a:t,b:i,c:r})[0]):k.Triangular(1,{a:t,b:i,c:r})[0]}}weibullvalue(e=1,t=1){if(this.state===1)this.distributions.set(this.distribution_id,k.Weibull(this.iterations,{a:e,b:t,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.Weibull(1,{a:e,b:t})[0]}}betavalue(e=1,t=1){if(this.state===1)this.distributions.set(this.distribution_id,k.Beta(this.iterations,{a:e,b:t,lhs:this.lhs}));else if(this.state===2){let r=this.distributions.get(this.distribution_id)?.[this.iteration]||0;return{type:3,value:r}}return{type:3,value:k.Beta(1,{a:e,b:t})[0]}}samplevalue(e){return this.uniformrangesample(e)}samplevalue_weighted(e,t){if(this.state===1)this.distributions.set(this.distribution_id,k.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));else{let r=0;if(this.state===2?r=this.distributions.get(this.distribution_id)?.[this.iteration]||0:r=k.Uniform(1,{min:0,max:1})[0],!e||!e.length)return{type:0,value:void 0};let i=L(t).reduce((a,l)=>typeof l>"u"?a:a+Number(l),0),n=r*i,s=0;for(let a=0;a<e.length;a++)for(let l=0;l<e[a].length;l++)if(s+=t[a][l],s>=n)return{type:3,value:e[a][l]}}return{type:3,value:e[0][0]}}uniformrangesample(e){this.state===1&&this.distributions.set(this.distribution_id,k.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));let t=0;if(this.state===2?t=this.distributions.get(this.distribution_id)?.[this.iteration]||0:t=k.Uniform(1,{min:0,max:1})[0],!e||!e.length)return{type:0,value:void 0};let r=Math.floor(e[0].length*e.length*t),i=e[r%e.length][Math.floor(r/e.length)]||"";return G(i)}hassimulationdata(e){let t=!1;return e?.type===5&&e.key==="metadata"&&(t=!!e.value?.simulation_data?.length),{type:4,value:t}}simulationtrials(){return{type:3,value:this.trials}}simulationtime(){return{type:3,value:this.elapsed/1e3}}PolynomialRoots(e,t=0){e=L(e),t&&(e[0]+=t);let r=ze.Roots(e);if(r.length){let i=[];for(let n of r)i.push({type:7,value:n});return{type:8,value:[i]}}return{type:0}}PolynomialRealRoots(e,t=0,r,i){e=L(e),t&&(e[0]+=t);let s=ze.Roots(e).filter(l=>Math.abs(l.imaginary)<1e-12).map(l=>l.real);return typeof r=="number"&&(s=s.filter(l=>l>=r)),typeof i=="number"&&(s=s.filter(l=>l<=i)),s.map(l=>[{type:3,value:l}]).length>0?{type:8,value:s.map(l=>[{type:3,value:l}])}:{type:0}}PolynomialApply(e,t){if(t.type===8){let r={type:8,value:[]};for(let i of t.value){let n=L(e),s=[];for(let a of i)a.type===3?s.push({type:3,value:ze.Apply(n,a.value)}):s.push({type:0});r.value.push(s)}return r}else if(t.type===3){let r=ze.Apply(L(e),t.value);return{type:3,value:r}}return R()}PolynomialFit(e,t,r){let i=[];if(!e||!t||!r)return R();Array.isArray(e)||(e=[Array.from(e)]),Array.isArray(t)||(t=[Array.from(t)]);let n=L(e),s=L(t);if(n.length===0||s.length===0)return V();i=ze.Fit(n,s,r);let a=i.map(l=>[{type:3,value:l}]);return a.length?{type:8,value:a}:{type:0}}MatchingRange(e,t,r,i){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(!i||!i.length)return V();if(i.length!==e.length)return V();let n=[],s=i.length;for(let a=0;a<s;a++)e[a]>=t&&e[a]<=r&&n.push({type:3,value:i[a]});return{type:8,value:[n]}}Filter(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!t||!t.length)return V();let r=[];for(let[i,n]of t.entries())n&&r.push(G(e[i]));return{type:8,value:[r]}}CountInRange(e,t,r){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let i=0,n=e.length;for(let s=0;s<n;s++)e[s]>=t&&e[s]<=r&&i++;return{type:3,value:i}}IntervalStatistics(e,t,r,i){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(!i||!i.length)return V();if(i=this.EnsureSingleCellData(i),e=this.EnsureSingleCellData(e),i.length!==e.length)return V();let n=e.length,s=0,a=[];for(let u=0;u<n;u++)e[u]>=t&&e[u]<=r&&(s+=i[u],a.push(i[u]));a.sort((u,c)=>u-c);let l=this.Quarties(a).map(u=>[{type:3,value:u}]);return{type:8,value:[[{type:3,value:a.length}],[{type:3,value:a.length?s/a.length:0}],...l]}}IntervalInRange(e,t,r,i,n,s){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(!i||!i.length)return V();if(i=this.EnsureSingleCellData(i),e=this.EnsureSingleCellData(e),i.length!==e.length)return V();let a=0,l=0,u=i.length;if(typeof n=="number"&&typeof s=="number")for(let c=0;c<u;c++)e[c]>=t&&e[c]<=r&&(l++,i[c]>=n&&i[c]<=s&&a++);else if(typeof s=="number")for(let c=0;c<u;c++)e[c]>=t&&e[c]<=r&&(l++,i[c]<=s&&a++);else{n=n||0;for(let c=0;c<u;c++)e[c]>=t&&e[c]<=r&&(l++,i[c]>=n&&a++)}return{type:3,value:l>0?a/l:0}}isDiscrete(e){for(let t of e)if(Math.floor(t)!==t)return!1;return!0}FindFirstBin(e,t,r,i){let n=Math.floor(t/i)*i,s=(t-n)/i,l=(n+r*i-e)/i+s;return l==1?n-=i:n-=l/2*i,n}RoundedTickRange(e,t,r){if(e==0)return 1;let i=e/(t-1),n=Math.ceil(Math.log10(i)-1),s=Math.pow(10,n),a=Math.ceil(i/s)*s;if(r){let l=a;return l<a&&l++,l}return a}SimulationHistogramBin(e,t=10,r=0){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();let i=0,n=e.length,s=0,a=e[0],l=e[0];for(let d of e)d<a&&(a=d),d>l&&(l=d);let u=this.RoundedTickRange(l-a,t,this.isDiscrete(e)),h=this.FindFirstBin(l,a,t,u)+u*(r-1),f=h+u;for(i=0;i<n;i++){let d=e[i];(i==0&&d>=h||d>h)&&d<=f&&s++}return{type:3,value:s}}SimulationHistogramBinLabel(e,t=10,r=0){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();let i=e[0],n=e[0];for(let c of e)c<i&&(i=c),c>n&&(n=c);let s=this.RoundedTickRange(n-i,t,this.isDiscrete(e)),u=this.FindFirstBin(n,i,t,s)+s*(r-1)+s;return{type:3,value:u}}simulationvaluesarray(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=[];for(let r=0;r<e.length;r++)t[r]={type:3,value:e[r]};return{type:8,value:[t]}}simulationvaluesarray_ordered(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||t&&!t.length)return V();if(e=this.EnsureSingleCellData(e),t&&(t=this.EnsureSingleCellData(t)),!t)return{type:8,value:[Array.prototype.slice.call(e,0).sort((i,n)=>i-n).map(i=>({type:3,value:i}))]};let r=Array.from(e).map((i,n)=>[i,t[n]]);return r.sort((i,n)=>i[1]-n[1]),{type:8,value:[r.map(i=>({type:3,value:i[0]}))]}}simulationrsquared(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!t||!t.length)return V();e=this.EnsureSingleCellData(e),t=this.EnsureSingleCellData(t);let{r2:r,error:i}=H.R22(e,t);return i?E():{type:3,value:r||0}}simulationcorrelation(e,t){return this.state!==0?{type:3,value:0}:!e||!e.length||!t||!t.length?V():(e=this.EnsureSingleCellData(e),t=this.EnsureSingleCellData(t),{type:3,value:H.Correlation(e,t)})}simulationcorrelationmatrix(e,t=!0){if(this.state!==0)return{type:3,value:0};if(!Array.isArray(e)||!Array.isArray(e[0]))return{type:3,value:1};if(e.length>1&&e[0].length>1)return R();let r=[],i=!1;for(let u of e)for(let c of u)r.push(c),c.length||(i=!0);if(i)return V();let n=r.length,s=[],a=0,l=0;for(a=0;a<n;a++){let u=[];for(l=0;l<=a;l++)u.push({type:3,value:a===l?1:H.Correlation(r[a],r[l])});for(;l<n;l++)u.push({type:0});s.push(u)}if(t)for(a=0;a<n;a++)for(l=a+1;l<n;l++)s[a][l]={type:3,value:s[l][a].value};else for(a=0;a<n;a++)for(l=a+1;l<n;l++)s[a][l]={type:2,value:""};return{type:8,value:Rt(s)}}sortedsimulationindex(e,t=1){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(e=this.EnsureSingleCellData(e),t<1||t>e.length)return R();let r=Array.from(e).map((i,n)=>[i,n+1]);return r.sort((i,n)=>i[0]-n[0]),{type:3,value:r[t-1][1]}}simulationvalue_cumulative(e,t=1){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(e=this.EnsureSingleCellData(e),t<1||t>e.length)return R();let r=0;for(let i=0;i<t;i++)r+=e[i];return{type:3,value:r}}simulationvalue(e,t=1){return this.state!==0?{type:3,value:0}:!e||!e.length?V():(e=this.EnsureSingleCellData(e),t<1||t>e.length?R():{type:3,value:e[t-1]})}simulationpercentile(e,t=.5){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e),e=e.slice(0),e.sort((n,s)=>n-s);let r=e.length,i=Math.floor(t*r);return i>=r&&(i=r-1),i<0&&(i=0),{type:3,value:e[i]}}EnsureSingleCellData(e){return Array.isArray(e)&&Array.isArray(e[0])?e[0][0]:e}simulationstandarddeviation(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=H.Statistics(e);return{type:3,value:t.stdev}}simulationvariance(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=H.Statistics(e);return{type:3,value:t.variance}}simulationskewness(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=H.Statistics(e);return{type:3,value:t.skewness}}simulationkurtosis(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=H.Statistics(e);return{type:3,value:t.kurtosis}}simulationmedian(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=e.slice(0);t.sort((n,s)=>n-s);let r=t.length,i=0;return r%2?i=t[Math.floor(r/2)]:i=(t[r/2]+t[r/2-1])/2,{type:3,value:i}}Quarties(e){if(!e.length)return[0,0,0,0,0];let t=n=>{let s=n.length;return s%2?n[Math.floor(s/2)]:(n[s/2]+n[s/2-1])/2},r=e.length,i=[e[0],0,t(e),0,e[r-1]];return r%2?(i[1]=t(e.slice(0,Math.ceil(r/2))),i[3]=t(e.slice(Math.floor(r/2)))):(i[1]=t(e.slice(0,r/2)),i[3]=t(e.slice(r/2))),i}SimulationQuartiles(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();if(e=this.EnsureSingleCellData(e),e.length<1)return R();e=e.slice(0),e.sort((r,i)=>r-i);let t=this.Quarties(e);return{type:8,value:[t.map(r=>({type:3,value:r}))]}}simulationslope(e,t){if(e&&(e=this.EnsureSingleCellData(e)),t&&(t=this.EnsureSingleCellData(t)),!e||!e.length||!t||!t.length||e.length!==t.length)return V();let r=e.length,i=0,n=0,s=0,a=0;for(let u=0;u<r;u++){let c=e[u],h=t[u];s+=c*h,i+=c,n+=h,a+=c*c}let l=(r*s-i*n)/(r*a-i*i);return{type:3,value:l}}simulationintercept(e,t){if(e&&(e=this.EnsureSingleCellData(e)),t&&(t=this.EnsureSingleCellData(t)),!e||!e.length||!t||!t.length||e.length!==t.length)return V();let r=e.length,i=0,n=0,s=0,a=0;for(let u=0;u<r;u++){let c=e[u],h=t[u];s+=c*h,i+=c,n+=h,a+=c*c}let l=r*s-i*n;return l/=r*a-i*i,{type:3,value:(n-l*i)/r}}simulationinterval(e,t,r){return this.state!==0?{type:3,value:0}:!e||!e.length?V():(e=this.EnsureSingleCellData(e),{type:3,value:H.Interval({data:e,min:t,max:r})})}simulationstandarderror(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=0,r=0;for(let n of e)t+=n||0;let i=t/e.length;for(let n of e){let s=n-i;r+=s*s}return{type:3,value:Math.sqrt(r/e.length)/Math.sqrt(e.length)}}simulationmin(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=e[0];for(let r of e)r<t&&(t=r);return{type:3,value:t}}simulationmax(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=e[0];for(let r of e)r>t&&(t=r);return{type:3,value:t}}simulationmode(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=[],r=[];for(let i of e){let n=Math.floor(i);t[n]=(t[n]||0)+1}return t.forEach((i,n)=>r.push([i,n])),r.sort((i,n)=>n[0]-i[0]),{type:3,value:r[0][1]}}simulationgeometricmean(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e),Array.isArray(e)||(e=Array.from(e));let t=1;for(let r of e)t*=Math.pow(r,1/e.length);return{type:3,value:t}}simulationmean(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return V();e=this.EnsureSingleCellData(e);let t=0;for(let r of e)t+=r;return{type:3,value:t/e.length}}Permutation(e){if(!e){let{rows:t,columns:r}=this.CallerArea(),i=t*r;if(i<=0)return R();let n=xs(i),s=[],a=0;for(let l=0;l<r;l++){let u=[];for(let c=0;c<t;c++)u.push({type:3,value:n[a++]});s.push(u)}return{type:8,value:s}}if(e.type===8){let t=e.value.length,r=e.value[0].length;if(!t||!r)return R();let i=e.value.reduce((u,c)=>c.concat(u),[]),n=t*r;if(i.length!==n)throw console.info("invalid?",n,e,i),new Error("invalid length");let s=xs(n),a=[],l=0;for(let u=0;u<t;u++){let c=[];for(let h=0;h<r;h++){let f=s[l++];c.push({...i[f]})}a.push(c)}return{type:8,value:a}}else return{...e}}Scale(e,t,r=!1){let{rows:i,columns:n}=this.CallerArea(),s=Math.max(i,n),a=e>t?Ft(t,e,s-1,!0,r):Ft(e,t,s-1,!0,r),l=a.min,u=[[]];if(a.count<s-1&&(l=a.min-Math.ceil((s-a.count)/2)*a.step),e>t)for(let c=0;c<s;c++){let h=l+c*a.step;u[0][s-1-c]={type:3,value:h}}else for(let c=0;c<s;c++){let h=l+c*a.step;u[0][c]={type:3,value:h}}return{type:8,value:i<n?Ne(u):u}}HistogramTable(e,t=1){let{rows:r,columns:i}=this.CallerArea(),n=Math.max(r,i),s=Math.min(r,i);if((typeof t!="number"||t<1||t>4)&&(t=1),Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array){if(e.length<=1)return{type:3,value:0};Array.isArray(e)||(e=Array.prototype.slice.call(e));let a=e;a.sort((y,v)=>y-v);let l=a[0]||0,u=a[a.length-1]||0,c=!0;for(let y of a)if(y%1!==0){c=!1;break}if(u===l)return{type:3,value:0};let h=[[],[]],f=Ft(l,u,n,!0,c),d=f.min,m=0;f.count<n&&(d=f.min-Math.ceil((n-f.count)/2)*f.step);let _=1;for(let y=0;y<n;y++){let v=d+(y+1)*f.step,w=0;for(;m<a.length&&a[m]<=v;m++,w++);t===2&&(w/=a.length),t===3&&(w/=a.length,_-=w,w=_),t===4&&(w/=a.length,_-=w,w=1-_),h[1][y]={type:3,value:w},h[0][y]={type:3,value:v}}return s===1&&(h=[h[1]]),{type:8,value:i>r?Ne(h):h}}return{type:3,value:0}}};var Ar=class extends lt{simulation_model;constructor(e,t,r){super(e,t,r),this.simulation_model=new Sr(e),this.context=this.simulation_model}CallExpression(e,t=!1){let r=this.library.Get(e.name);if(!r){let s=e.name.toUpperCase();return this.LookupBinding(s)?this.ImplicitCall():this.data_model.GetName(s,this.context.address.sheet_id||0)?this.ImplicitCall():()=>St()}let i=r.arguments||[];this.simulation_model.state===1&&e.args.forEach((s,a)=>{let l=i[a]||{};if(s&&l.collector){if(s.type==="address")this.simulation_model.StoreCellResults(s);else if(s.type==="range"){let u=new M(s.start,s.end);for(let c of u)this.simulation_model.StoreCellResults(c)}else if(s.type==="identifier"){let u=this.data_model.GetName(s.name,this.context.address.sheet_id||0);u?.type==="range"&&this.simulation_model.StoreCellResults(u.area.start)}else if(s.type==="call"){let u=this.CalculateExpression(s,!0);u&&et(u)&&(u.value.type==="address"?this.simulation_model.StoreCellResults(u.value):u.value.type==="range"&&this.simulation_model.StoreCellResults(u.value.start))}}});let n=this.simulation_model.state===0?0:this.simulation_model.distributions.size;return s=>{this.simulation_model.volatile=this.simulation_model.volatile||!!r.volatile||!!r.simulation_volatile&&this.simulation_model.state!==0;let a=e.name.toUpperCase()==="IF",l=-1,u,c=s.args,h=r.arguments||[],f;r.create_binding_context&&(f=r.create_binding_context.call(0,{args:s.args,descriptors:h}),f?(c=f.args,f.argument_descriptors&&(h=f.argument_descriptors),this.context.bindings.unshift(this.NormalizeBindings(f.context))):u=R());let d=c.map((_,y)=>{if(u)return;let v=h[Math.min(y,h.length-1)]||{};if(v.passthrough)return _;if(y===l)if(this.simulation_model.state===1){let w=!0;if(this.parser.Walk(_,x=>(x.type==="call"&&this.library.Get(x.name)?.simulation_volatile&&(w=!1),w)),w)return v.boxed?{type:0}:void 0}else return v.boxed?{type:0}:void 0;if(typeof _>"u")return a&&y===0&&(l=1),v.boxed?{type:0}:void 0;if(v.address)return v.boxed?{type:2,value:this.parser.Render(_).replace(/\\$/g,"")}:this.parser.Render(_).replace(/\\$/g,"");if(v.metadata)return this.GetMetadata(_,(w,x)=>({simulation_data:this.simulation_model.state===0?this.simulation_model.StoreCellResults(x):[]}));if(v.collector&&this.simulation_model.state===0){if(_.type==="address")return this.simulation_model.StoreCellResults(_);if(_.type==="range"){let w=[];for(let x=_.start.row;x<=_.end.row;x++){let C=[];for(let A=_.start.column;A<=_.end.column;A++)C.push(this.simulation_model.StoreCellResults({row:x,column:A,sheet_id:_.start.sheet_id}));w.push(C)}return w}else if(_.type==="identifier"){let w=this.data_model.GetName(_.name,this.context.address.sheet_id||0);if(w?.type==="range")return this.simulation_model.StoreCellResults(w.area.start)}else if(_.type==="call"){let w=this.CalculateExpression(_,!0);if(w&&et(w)){if(w.value.type==="address")return this.simulation_model.StoreCellResults(w.value);if(w.value.type==="range")return this.simulation_model.StoreCellResults(w.value.start)}}return u=z(),u}else{let w=this.CalculateExpression(_);if(w.type===6){if(v.allow_error)return w;u=w;return}if(a&&y===0&&w.type!==8){let x=!1;if(w.type===2){let C=w.value.toLowerCase().trim();x=C!=="false"&&C!=="f"}else x=!!w.value;l=x?2:1}return v.boxed?w:Array.isArray(w)?(console.warn("AAA 82394"),w.map(x=>x.map(C=>C.value))):w.type===8?w.value.map(x=>x.map(C=>C.value)):w.value}throw new Error("never")});if(u)return u;this.context.distribution_id=n;let m={address:{...this.context.address},area:this.context.area?{start:{...this.context.area.start},end:{...this.context.area.end}}:void 0};if(r.return_type==="reference"){let _=r.fn.apply(m,d);if(t)return _;if(et(_)){if(_.value.type==="address")return this.CellFunction2(_.value)();if(_.value.type==="range")return this.CellFunction4(_.value.start,_.value.end)}return _}return r.fn.apply(m,d)}}};var dt=Ls(As());var Rs=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],Ba=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];function ki(o){if(o.length%4)return null;for(var e="",t=0,r=0,i=typeof o=="string"?function(s,a){return s.charCodeAt(a)}:function(s,a){return s[a]};t<o.length;)if(r=r*256+i(o,t++),t%4===0){for(var n=52200625;n>=1;)e+=Rs[Math.floor(r/n)%85],n/=85;r=0}return e}function Ei(o){if(o.length%5)return null;for(var e=new Uint8Array(o.length*4/5),t=0,r=0,i=0;r<o.length;){if(!Rs.includes(o.charAt(r)))return null;var n=o.charCodeAt(r++)-32;if(i=i*85+Ba[n],r%5===0){for(var s=16777216;s>=1;)e[t++]=i/s%256,s/=256;i=0}}return e}var Mr=class extends wr{simulation_expression_calculator;last_simulation_data;constructor(e,t={}){super(e,t),this.expression_calculator=this.simulation_expression_calculator=new Ar(this.model,this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions);let r=this.simulation_expression_calculator.simulation_model.aliases;for(let i of Object.keys(r))this.library.Alias(i,r[i]);t.lv&&this.library.Register(this.simulation_expression_calculator.simulation_model.lv_functions)}RiskAMPFunctionList(){return[...Object.keys(this.simulation_expression_calculator.simulation_model.functions),...Object.keys(this.simulation_expression_calculator.simulation_model.lv_functions)]}CleanUpLVSimulation(e){e.accept?.vertex&&this.RemoveLeafVertex(e.accept.vertex),e.terminate?.vertex&&this.RemoveLeafVertex(e.terminate.vertex),e.fail?.vertex&&this.RemoveLeafVertex(e.fail.vertex)}InitLVSimulation(e,t){let r=n=>{if(n){let s=new at;s.use="lv",this.AddLeafVertex(s),this.UpdateLeafVertex(s,n,t);let a=this.Evaluate(n,t,{},!0);return s.result=a,s.updated=!0,{text:n,vertex:s}}};return{accept:r(e.accept),terminate:r(e.terminate),fail:r(e.fail)}}InitSimulation(e,t,r,i,n,s){let a=this.simulation_expression_calculator.simulation_model;if(a.ResetDistributions(),a.first_iteration=e,a.iterations=t,a.results=[],a.lhs=r,a.lv_state=void 0,typeof s=="number"&&(a.seed=s),this.Reset(),n&&n.length)for(let l of n){if(!l.sheet_id)throw new Error("additional cell passed without sheet id");let u=this.model.sheets.Find(l.sheet_id);u&&u.cells.GetCell(l,!1)&&a.StoreCellResults(l)}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return a.state=1,a.iteration=0,this.Recalculate(),a.CorrelateDistributions(),a.state=2,a.triples=[],a.results.forEach((l,u)=>{l.forEach((c,h)=>{c.forEach((f,d)=>{a.triples.push([u,h,d])})})}),0}Resample(){let e=this.simulation_expression_calculator.simulation_model;e.state=1,e.iteration=0,this.Recalculate(),e.CorrelateDistributions(),e.state=2}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(e,t,r){let i=this.simulation_expression_calculator.simulation_model;i.iteration=e;try{this.Recalculate();let n,s=0;if(r&&t){let a=!0,l=t.accept?.vertex?.result;if(l&&(l.value?(r.accepted++,a=!1):r.rejected++),l=t.terminate?.vertex?.result,l&&(l.type===3?r.accepted>=l.value&&(r.terminated=!0,r.succeeded=!0):l.value&&(r.terminated=!0,r.succeeded=!0)),l=t.fail?.vertex?.result,l&&(l.type===3?r.accepted+r.rejected>=l.value&&(r.failed=!0):l.value&&(r.failed=!0)),a)return{status:0,reference:null};e=r.accepted-1,this.simulation_expression_calculator.simulation_model.lv_state={...r}}for(let[a,l,u]of i.triples)if(s!==a&&(s=a,n=this.model.sheets.Find(a)?.cells),n){let c=n.GetCell({row:u,column:l});if(c){let h=c.GetValue();switch(typeof h){case"number":i.results[a][l][u][e]=h;break;case"boolean":i.results[a][l][u][e]=h?1:0;break;default:i.results[a][l][u][e]=0}}}return{status:0,reference:null}}catch(n){return console.info("calculation error trapped",n),{status:2,reference:null}}}FlattenedResults(){let e=this.simulation_expression_calculator.simulation_model,t=[];for(let r in e.results)for(let i in e.results[r]){let n=e.results[r][i];for(let s in n)t.push(bs({row:Number(s),column:Number(i),sheet_id:Number(r),data:n[s]}).buffer)}return t}FlushSimulationResults(){let e=this.simulation_expression_calculator.simulation_model;e.results=[],e.elapsed=0,e.trials=0,this.last_simulation_data=void 0}CollectorReferences(e,t){let r=[],i={row:0,column:0,sheet_id:t},n=this.parser.Parse(e);if(n.expression&&n.expression.type==="call"){let s=this.library.Get(n.expression.name);if(!s||!s.arguments)return[];for(let a=0;a<s.arguments.length;a++){let l=s.arguments[a];if(!l||!l.collector)continue;let u=n.expression.args[a];if(!u)continue;let c=this.ResolveExpressionAddress(u,i);c&&r.push(c.start)}}return r}ShiftSimulationResults(e,t,r,i){}SerializeSimulationData(e){let t={elapsed:this.last_simulation_data?.elapsed||0,trials:this.last_simulation_data?.trials||0,results:[]},r=this.last_simulation_data?.results||[];return e.float32?(t.bitness=32,t.results=r.map(i=>{let n=Float32Array.from(new Float64Array(i));return e.z85?ki(new Uint8Array(n.buffer))||"":dt.fromByteArray(new Uint8Array(n.buffer))})):t.results=r.map(i=>e.z85?ki(new Uint8Array(i))||"":dt.fromByteArray(new Uint8Array(i))),e.z85&&(t.encoding="z85"),t}UnserializeSimulationData(e){let t=e.encoding==="z85";this.last_simulation_data={...e,results:[]},e.bitness===32?this.last_simulation_data.results=(e.results||[]).map(r=>{if(t){let i=Ei(r);return i?Float64Array.from(i).buffer:new Float64Array().buffer}else{let i=new Float32Array(dt.toByteArray(r).buffer);return Float64Array.from(i).buffer}}):this.last_simulation_data.results=(e.results||[]).map(r=>{if(t){let i=Ei(r);return i?i.buffer:new Uint8Array().buffer}else return dt.toByteArray(r).buffer}),this.UpdateResults(!1)}ConsolidateLVState(e){let t={accepted:0,rejected:0,terminated:!1,failed:!1,iteration:0,succeeded:!1};for(let r of e)r&&(t.accepted+=r.accepted,t.rejected+=r.rejected,t.failed=t.failed||r.failed,t.terminated=t.terminated||r.terminated,t.succeeded=t.succeeded||r.succeeded);return this.simulation_expression_calculator.simulation_model.lv_state=t,{...t}}UpdateResults(e=!0){let t=this.simulation_expression_calculator.simulation_model,r=this.last_simulation_data;if(!r)t.results=[],t.elapsed=0,t.trials=0;else{t.results=[],t.elapsed=r.elapsed,t.trials=r.trials;for(let i of r.results){let n=i instanceof ArrayBuffer?ys(new Float64Array(i)):i;n.sheet_id||(n.sheet_id=this.model.sheets.list[0].id),t.results[n.sheet_id]||(t.results[n.sheet_id]=[]),t.results[n.sheet_id][n.column]||(t.results[n.sheet_id][n.column]=[]),t.results[n.sheet_id][n.column][n.row]=n.data,e&&this.SetDirty(n)}}}};var kr=class{constructor(e){this.base_worker=e;{let t=new Rn(ai());k.SetRNG({Next:t.Next.bind(t),Seed:r=>{t.Reset(ai(r))}})}}trials=0;first_trial=0;lhs=!1;lv_state=void 0;lv_config=void 0;data_model=new vt;active_sheet_id=0;calculator_options={lv:!0,spill:!0,complex_numbers:"on"};screen_updates=!1;calculator=new Mr(this.data_model,this.calculator_options);start_time=0;seed;additional_cells=[];iteration=0;Timestamp(){return self.performance?performance.now():Date.now()}OnMessage(e){let t=e.data;if(t)switch(t.type){case"configure":if(t.locale&&t.locale!==F.locale&&(F.UpdateLocale(t.locale),this.calculator.UpdateLocale()),this.data_model.sheets.Assign(t.sheets.map(r=>je.FromJSON(r,{}))),this.active_sheet_id=t.active_sheet,this.additional_cells=[],t.additional_cells&&(this.additional_cells=t.additional_cells),this.data_model.macro_functions.clear(),t.macro_functions)for(let r of t.macro_functions)this.data_model.macro_functions.set(r.name.toUpperCase(),r);this.data_model.named.Reset(),t.named&&this.data_model.UnserializeNames(t.named),this.seed=t.seed,t.lv_config&&(this.lv_state={...t.lv_config,iteration:0,accepted:0,rejected:0});break;case"step":this.SimulationStep();break;case"start":this.trials=t.trials||1e3,this.first_trial=t.first_trial||0,this.lhs=!!t.lhs,this.screen_updates=t.screen_updates||!1,this.Start();break}}Post(e,t=[]){this.base_worker.postMessage(e,t)}SimulationStep(){if(!this.lv_state&&this.iteration>=this.trials)return;let e=typeof this.screen_updates=="number"?this.screen_updates:1;if(this.lv_state)for(let n=0;n<e;n++){if(this.iteration>=this.trials&&(this.calculator.Resample(),this.iteration=0),this.calculator.SimulationTrial(this.iteration,this.lv_config,this.lv_state),this.lv_state.failed||this.lv_state.terminated){this.Finish();return}this.iteration++}else for(let n=0;n<e;n++)if(this.calculator.SimulationTrial(this.iteration),++this.iteration===this.trials){this.Finish();return}let t=Math.floor((this.iteration-1)/this.trials*100),r=this.calculator.FlattenedResults(),i=this.Timestamp()-this.start_time;this.Post({type:"update",percent_complete:t,trial_data:{results:r,trials:this.iteration,elapsed:i},lv_state:this.lv_state},r)}Start(){if(!this.trials)throw new Error("invalid trial count");this.start_time=this.Timestamp();let e=this.calculator.InitSimulation(this.first_trial,this.trials,this.lhs,this.data_model,this.additional_cells,this.seed);if(this.lv_state){let r=this.data_model.sheets.Find(this.active_sheet_id);r?this.lv_config=this.calculator.InitLVSimulation(this.lv_state,r):console.warn("Invalid active sheet ID",this.active_sheet_id)}if(this.seed=void 0,e!==0)throw new Error("graph failed");let t=0;if(this.screen_updates)this.iteration=0,this.SimulationStep();else if(this.lv_state)for(this.iteration=0;;){if(this.iteration>=this.trials&&(this.calculator.Resample(),this.iteration=0),this.calculator.SimulationTrial(this.iteration,this.lv_config,this.lv_state),this.lv_state.failed||this.lv_state.terminated){this.Finish();return}let r=Math.floor(this.iteration/this.trials*100);r!==t&&(t=r,this.Post({type:"progress",percent_complete:t,accepted:this.lv_state.accepted,rejected:this.lv_state.rejected})),this.iteration++}else{for(let r=0;r<this.trials;r++){this.calculator.SimulationTrial(r);let i=Math.floor(r/this.trials*100);i!==t&&(t=i,this.Post({type:"progress",percent_complete:t}))}this.Finish()}}Finish(){this.lv_config&&this.calculator.CleanUpLVSimulation(this.lv_config),this.Post({type:"progress",percent_complete:100});let e=this.calculator.FlattenedResults(),t=this.Timestamp()-this.start_time;this.Post({type:"complete",trial_data:{results:e,trials:this.lv_state?this.lv_state.iteration:this.trials,elapsed:t},lv_state:this.lv_state},e),this.lv_config=void 0,this.lv_state=void 0}};var Ms=self,ja=new kr(Ms);Ms.addEventListener("message",o=>ja.OnMessage(o));\n',t=async()=>new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"})));export{t as CreateWorker};
