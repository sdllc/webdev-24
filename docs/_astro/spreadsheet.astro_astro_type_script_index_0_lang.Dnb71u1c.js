const ws="modulepreload",xs=function(e){return"/webdev-24/"+e},ha={},pe=function(t,r,a){let i=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),n=o?.nonce||o?.getAttribute("nonce");i=Promise.allSettled(r.map(l=>{if(l=xs(l),l in ha)return;ha[l]=!0;const h=l.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const c=document.createElement("link");if(c.rel=h?"stylesheet":ws,h||(c.as="script"),c.crossOrigin="",c.href=l,n&&c.setAttribute("nonce",n),document.head.appendChild(c),h)return new Promise((u,m)=>{c.addEventListener("load",u),c.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(o){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=o,window.dispatchEvent(n),!n.defaultPrevented)throw o}return i.then(o=>{for(const n of o||[])n.status==="rejected"&&s(n.reason);return t().catch(s)})},Fr=(e,t,r)=>{const a=e[t];return a?typeof a=="function"?a():Promise.resolve(a):new Promise((i,s)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==r?". Note that variables only represent file names one level deep.":""))))})};var Cs=Object.create,ea=Object.defineProperty,ks=Object.getOwnPropertyDescriptor,Ss=Object.getOwnPropertyNames,Ms=Object.getPrototypeOf,As=Object.prototype.hasOwnProperty,Rs=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),zs=(e,t)=>{for(var r in t)ea(e,r,{get:t[r],enumerable:!0})},Ts=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ss(t))!As.call(e,i)&&i!==r&&ea(e,i,{get:()=>t[i],enumerable:!(a=ks(t,i))||a.enumerable});return e},Ds=(e,t,r)=>(r=e!=null?Cs(Ms(e)):{},Ts(!e||!e.__esModule?ea(r,"default",{value:e,enumerable:!0}):r,e)),Ls=Rs(e=>{e.byteLength=l,e.toByteArray=d,e.fromByteArray=m;var t=[],r=[],a=typeof Uint8Array<"u"?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(s=0,o=i.length;s<o;++s)t[s]=i[s],r[i.charCodeAt(s)]=s;var s,o;r[45]=62,r[95]=63;function n(f){var p=f.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var b=f.indexOf("=");b===-1&&(b=p);var w=b===p?0:4-b%4;return[b,w]}function l(f){var p=n(f),b=p[0],w=p[1];return(b+w)*3/4-w}function h(f,p,b){return(p+b)*3/4-b}function d(f){var p,b=n(f),w=b[0],y=b[1],g=new a(h(f,w,y)),v=0,x=y>0?w-4:w,_;for(_=0;_<x;_+=4)p=r[f.charCodeAt(_)]<<18|r[f.charCodeAt(_+1)]<<12|r[f.charCodeAt(_+2)]<<6|r[f.charCodeAt(_+3)],g[v++]=p>>16&255,g[v++]=p>>8&255,g[v++]=p&255;return y===2&&(p=r[f.charCodeAt(_)]<<2|r[f.charCodeAt(_+1)]>>4,g[v++]=p&255),y===1&&(p=r[f.charCodeAt(_)]<<10|r[f.charCodeAt(_+1)]<<4|r[f.charCodeAt(_+2)]>>2,g[v++]=p>>8&255,g[v++]=p&255),g}function c(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function u(f,p,b){for(var w,y=[],g=p;g<b;g+=3)w=(f[g]<<16&16711680)+(f[g+1]<<8&65280)+(f[g+2]&255),y.push(c(w));return y.join("")}function m(f){for(var p,b=f.length,w=b%3,y=[],g=16383,v=0,x=b-w;v<x;v+=g)y.push(u(f,v,v+g>x?x:v+g));return w===1?(p=f[b-1],y.push(t[p>>2]+t[p<<4&63]+"==")):w===2&&(p=(f[b-2]<<8)+f[b-1],y.push(t[p>>10]+t[p>>4&63]+t[p<<2&63]+"=")),y.join("")}}),Es=class{get list(){return this.sheets_.slice(0)}get length(){return this.sheets_.length}names=new Map;ids=new Map;sheets_=[];Assign(e){this.sheets_=[...e],this.UpdateIndexes()}Add(e){this.sheets_.push(e),this.UpdateIndexes()}Splice(e,t,...r){this.sheets_.splice(e,t,...r),this.UpdateIndexes()}Find(e){return typeof e=="string"?this.names.get(e.toLocaleUpperCase()):this.ids.get(e)}Name(e){return this.ids.get(e)?.name||void 0}ID(e){return this.names.get(e.toLocaleUpperCase())?.id||void 0}UpdateIndexes(){this.names.clear(),this.ids.clear();for(let e of this.sheets_){let t=e.name.toLocaleUpperCase();this.names.set(t,e),this.ids.set(e.id,e)}}},Fs={spreadsheet_semantics:!0,dimensioned_quantities:!1,fractions:!0,decimal_mark:".",argument_separator:",",boolean_true:"TRUE",boolean_false:"FALSE"},tt=/[\s-+=<>!()]/,Ns=/['*\\]/,cr=34,ur=39,Ps=160,da=32,Us=9,Is=10,Vs=13,ze=48,bt=57,mr=46,fr=43,gt=45,ca=40,pr=41,_t=44,Os=37,br=95,Nt=36,Hs=123,Gs=125,vt=91,ua=93,$s=63,Bs=33,ma=59,gr=35,qs=64,st=65,yt=97,js=69,Js=101,Pt=90,Ut=122,Ws=105,_r=192,vr=382,Nr={"==":6,"!=":6,"<>":6,"=":6,"<":7,">":7,"<=":7,">=":7,"+":9,"-":9,"&":9,"*":10,"/":10,"^":11,":":13},Zs={"@":50,"-":100,"+":100},Ks=[...Object.keys(Nr),"@"].sort((e,t)=>t.length-e.length),Di=class{get argument_separator(){return this.flags.argument_separator}get decimal_mark(){return this.flags.decimal_mark}flags={...Fs};r1c1_regex=/[rR]((?:\[[-+]{0,1}\d+\]|\d*))[cC]((?:\[[-+]{0,1}\d+\]|\d*))$/;argument_separator_char=_t;decimal_mark_char=mr;imaginary_char=Ws;imaginary_number="i";id_counter=0;expression="";data=[];index=0;length=0;valid=!0;error_position;error;dependencies={addresses:{},ranges:{}};address_refcount={};full_reference_list=[];parser_state_cache=[];SetLocaleSettings(e,t){if(typeof t>"u"&&(t=e===","?";":","),t===e)throw new Error("invalid locale setting");this.flags.argument_separator=t,this.flags.decimal_mark=e}Save(){this.parser_state_cache.push(JSON.stringify(this.flags))}Restore(){let e=this.parser_state_cache.shift();if(e)try{this.flags=JSON.parse(e)}catch(t){console.error(t)}else console.warn("No parser state to restore")}Walk2(e,t){let r=t(e);if(typeof r=="object")return r;switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":break;case"dimensioned":r&&(e.expression=this.Walk2(e.expression,t),e.unit=this.Walk2(e.unit,t));break;case"range":t(e)&&(e.start=this.Walk2(e.start,t),e.end=this.Walk2(e.end,t));break;case"binary":t(e)&&(e.left=this.Walk2(e.left,t),e.right=this.Walk2(e.right,t));break;case"unary":t(e)&&(e.operand=this.Walk2(e.operand,t));break;case"group":t(e)&&(e.elements=e.elements.map(a=>this.Walk2(a,t)));break;case"implicit-call":t(e)&&(e.call=this.Walk2(e.call,t),e.args=e.args.map(a=>this.Walk2(a,t)));break;case"call":t(e)&&(e.args=e.args.map(a=>this.Walk2(a,t)));break}return e}Walk(e,t){switch(e.type){case"address":case"missing":case"literal":case"complex":case"identifier":case"operator":case"structured-reference":t(e);return;case"dimensioned":t(e)&&(this.Walk(e.expression,t),this.Walk(e.unit,t));return;case"range":t(e)&&(this.Walk(e.start,t),this.Walk(e.end,t));return;case"binary":t(e)&&(this.Walk(e.left,t),this.Walk(e.right,t));return;case"unary":t(e)&&this.Walk(e.operand,t);return;case"group":if(t(e))for(let r of e.elements)this.Walk(r,t);return;case"implicit-call":if(t(e)){this.Walk(e.call,t);for(let r of e.args)this.Walk(r,t)}return;case"call":if(t(e))for(let r of e.args)this.Walk(r,t)}}Transpose(e){let t=e.length,r=[],a=0;for(let i=0;i<t;i++)Array.isArray(e[i])&&(a=Math.max(a,e[i].length));for(let i=0;i<a;i++){r[i]=[];for(let s=0;s<t;s++)r[i][s]=e[s]?e[s][i]:void 0}return r}Render(e,t={}){let r=t.offset||{rows:0,columns:0},a=t.missing??"(missing)",{convert_decimal:i,convert_argument_separator:s,long_structured_references:o,table_name:n}=t,l=this.flags.argument_separator+" ";s===","?l=", ":s===";"&&(l="; ");let h=i===","?",":".",d=this.flags.decimal_mark===","?/,/:/\./,c=this.flags.decimal_mark===","?/,/g:/\./g;switch(e.type){case"address":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e,t.r1c1_base):this.AddressLabel(e,r);case"range":return t.pass_through_addresses?e.label:t.r1c1?this.R1C1Label(e.start,t.r1c1_base)+":"+this.R1C1Label(e.end,t.r1c1_base):this.AddressLabel(e.start,r)+":"+this.AddressLabel(e.end,r);case"missing":return a;case"array":return"{"+this.Transpose(e.values).map(u=>u.map(m=>typeof m=="string"?'"'+m+'"':m).join(", ")).join("; ")+"}";case"binary":return this.Render(e.left,t)+" "+e.operator+" "+this.Render(e.right,t);case"unary":return e.operator+this.Render(e.operand,t);case"complex":if(e.text)return i?e.text.replace(c,h):e.text;{let u=Math.abs(e.imaginary).toString();if((i===","||this.flags.decimal_mark===",")&&(u=u.replace(/\./,",")),e.real){let m=e.real.toString();(i===","||this.flags.decimal_mark===",")&&(m=m.replace(/\./,","));let f=Math.abs(e.imaginary);return`${m}${e.imaginary<0?" - ":" + "}${f===1?"":u}i`}else return e.imaginary===-1?"-i":e.imaginary===1?"i":`${e.imaginary<0?"-":""}${u}i`}case"literal":if(typeof e.value=="string")return'"'+e.value.replace(/"/g,'""')+'"';if(typeof e.value=="boolean")return e.value?t.boolean_true||this.flags.boolean_true||"true":t.boolean_false||this.flags.boolean_false||"false";if(i&&typeof e.value=="number")if(e.text){let u=e.text;return i===","&&this.flags.decimal_mark==="."&&(u=u.replace(/,/g,"")),u.replace(d,h)}else return e.value.toString().replace(/\./,h);else if(e.text)return e.text;return e.value.toString();case"identifier":return e.name;case"operator":return"["+e.operator+"]";case"group":return e.explicit?"("+e.elements.map(u=>this.Render(u,t)).join(l)+")":e.elements.map(u=>this.Render(u,t)).join(l);case"implicit-call":return this.Render(e.call,t)+"("+e.args.map(u=>this.Render(u,t)).join(l)+")";case"call":return e.name+"("+e.args.map(u=>this.Render(u,t)).join(l)+")";case"dimensioned":return this.Render(e.expression)+" "+this.Render(e.unit);case"structured-reference":{let u=e.column;/[^A-Za-z]/.test(u)&&(u="["+u+"]");let m=e.table;switch(!m&&o&&n&&(m=n),e.scope){case"all":return`${m}[[#all],${u}]`;case"row":return o?`${m}[[#this row],${u}]`:`${m}[@${u}]`;case"column":return`${m}[${u}]`}throw new Error("unhandled scope in structured reference")}}return"??"}Parse(e){switch(e=e.trim(),e[0]==="="&&(e=e.substr(1).trim()),this.expression=e,this.data=[],this.length=e.length,this.index=0,this.valid=!0,this.error_position=void 0,this.error=void 0,this.dependencies.addresses={},this.dependencies.ranges={},this.address_refcount={},this.full_reference_list=[],this.id_counter=0,this.flags.argument_separator){case";":this.argument_separator_char=ma;break;default:this.argument_separator_char=_t;break}switch(this.flags.decimal_mark){case",":this.decimal_mark_char=_t;break;default:this.decimal_mark_char=mr;break}for(let a=0;a<this.length;a++)this.data[a]=e.charCodeAt(a);let t=this.ParseGeneric(),r={};for(let a of Object.keys(this.dependencies.addresses))this.address_refcount[a]&&(r[a]=this.dependencies.addresses[a]);return this.dependencies.addresses=r,{expression:t||void 0,valid:this.valid,error:this.error,error_position:this.error_position,dependencies:this.dependencies,separator:this.flags.argument_separator,decimal_mark:this.flags.decimal_mark,full_reference_list:this.full_reference_list.slice(0)}}ColumnLabel(e){if(e===1/0)return"";let t=String.fromCharCode(65+e%26);for(;e>25;)e=Math.floor(e/26)-1,t=String.fromCharCode(65+e%26)+t;return t}R1C1Label(e,t){let r="";e.sheet&&(r=(tt.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!");let a=e.offset_row?`[${e.row}]`:e.row+1,i=e.offset_column?`[${e.column}]`:e.column+1;return r+=`R${a}C${i}`,r}AddressLabel(e,t){let r=e.column;!e.absolute_column&&e.column!==1/0&&(r+=t.columns);let a=e.row;if(!e.absolute_row&&e.row!==1/0&&(a+=t.rows),a<0||r<0||a===1/0&&r===1/0)return"#REF";let i="";return e.sheet&&(i=(tt.test(e.sheet)?"'"+e.sheet+"'":e.sheet)+"!"),a===1/0?i+(e.absolute_column?"$":"")+this.ColumnLabel(r):r===1/0?i+(e.absolute_row?"$":"")+(a+1):i+(e.absolute_column?"$":"")+this.ColumnLabel(r)+(e.absolute_row?"$":"")+(a+1)+(e.spill?"#":"")}ParseGeneric(e=[0],t=!1){let r=[];for(;this.index<this.length;){let a=this.ParseNext(r.length===0);if(typeof a=="number"){if(e.some(i=>a===i))break;if(a===ca){this.index++;let i=this.ParseGeneric([pr],!0);this.index++,i&&r.push({type:"group",id:this.id_counter++,elements:[i],explicit:!0})}else{let i=this.ConsumeOperator();i?r.push(i):t&&a===this.argument_separator_char?(r.push({type:"group-separator",position:this.index,id:this.id_counter++}),this.index++):(this.error=`unexpected character [1]: ${String.fromCharCode(a)}, 0x${a.toString(16)}`,this.valid=!1,this.index++)}}else r.push(a)}if(r.length){if(r=this.BinaryToRange2(r),this.flags.fractions){let a=[],i=o=>o.type==="literal"&&typeof o.value=="number"&&o.value%1===0,s=0;for(;s<r.length-3;s++)if(i(r[s])&&i(r[s+1])&&r[s+2].type==="operator"&&r[s+2].operator==="/"&&i(r[s+3])){let o=r[s],n=r[s+1],l=r[s+3],h=(o.value<0?-1:1)*(n.value/l.value);s+=3,a.push({id:r[s].id,type:"literal",text:this.expression.substring(o.position,l.position+1),value:o.value+h,position:o.position})}else a.push(r[s]);for(;s<r.length;s++)a.push(r[s]);r=a}if(r=r.map(a=>a.type==="identifier"&&a.name===this.imaginary_number?{type:"complex",real:0,imaginary:1,position:a.position,text:a.name,id:this.id_counter++}:a),this.flags.dimensioned_quantities){let a=[],i;for(let s=0;s<r.length;s++){let o=r[s];if(!i)i=o;else if(o.type==="identifier"&&(i.type==="literal"||i.type==="group"||i.type==="call")){let n=o;for(;r[s+1]?.type==="identifier";)n.name+=" "+r[++s].name;a.push({type:"dimensioned",expression:i,unit:o,id:this.id_counter++}),i=void 0}else a.push(i),i=o}i&&a.push(i),r=a}}return r.length===0?null:r.length===1?r[0]:this.BinaryToComplex(this.ArrangeUnits(r))}UnitToAddress(e){if(e.type==="literal"){if(typeof e.value=="number"&&e.value>0&&!/\./.test(e.text||""))return{type:"address",position:e.position,label:e.value.toString(),row:e.value-1,id:this.id_counter++,column:1/0}}else{let t,r=e.name,a=r.split("!");if(a.length>1&&(t=a.slice(0,a.length-1).join("!"),r=r.substr(t.length+1),t[0]==="'"))if(t.length>1&&t[t.length-1]==="'")t=t.substr(1,t.length-2);else return;let i=r[0]==="$";r=(i?r.substr(1):r).toUpperCase();let s=Number(r);if(isNaN(s)){if(/[A-Z]{1,3}/.test(r)){let o=-1;for(let n=0;n<r.length;n++){let l=r[n].charCodeAt(0);o=26*(1+o)+(l-st)}return{type:"address",position:e.position,absolute_column:i,label:e.name,column:o,id:this.id_counter++,row:1/0,sheet:t}}}else if(s>0&&s!==1/0&&!/\./.test(r))return{type:"address",position:e.position,absolute_row:i,label:e.name,row:s-1,id:this.id_counter++,column:1/0,sheet:t}}}BinaryToRange2(e){let t=[];for(let r=0;r<e.length;r++){let a=e[r],i=e[r+1],s=e[r+2],o,n="",l;if(a&&i&&s&&i.type==="operator"&&i.operator===":"){if(a.type==="address"&&s.type==="address"){let h=a.position+a.label.length,d=s.position;o={type:"range",id:this.id_counter++,position:a.position,start:a,end:s,label:a.label+this.expression.substring(h,d)+s.label},n=o.start.label+":"+o.end.label,this.address_refcount[o.start.label]--,this.address_refcount[o.end.label]--;let c=[a.position,s.position];this.full_reference_list=this.full_reference_list.filter(u=>u.position!==c[0]&&u.position!==c[1])}else if((a.type==="literal"||a.type==="identifier")&&(s.type==="literal"||s.type==="identifier")){let h=this.UnitToAddress(a);if(!h&&a.type==="literal"&&typeof a.value=="number"&&a.value<0){let c={...a,text:(a.text||"").replace(/^-/,""),position:a.position+1,value:-a.value};h=this.UnitToAddress(c),h&&(l={type:"operator",operator:"-",position:a.position,id:this.id_counter++})}let d=this.UnitToAddress(s);h&&d&&(h.column===1/0&&d.column===1/0||h.row===1/0&&d.row===1/0)&&(n=h.label+":"+d.label,o={type:"range",id:this.id_counter++,position:h.position,start:h,end:d,label:n})}}o?(l&&t.push(l),t.push(o),this.dependencies.ranges[n]=o,this.full_reference_list.push(o),r+=2):t.push(a)}return t}BinaryToComplex(e){if(e.type==="binary")if((e.operator==="+"||e.operator==="-")&&e.left.type==="literal"&&typeof e.left.value=="number"&&e.right.type==="complex"&&!e.right.composited){let t="";t=this.expression.substring(e.left.position,e.right.position+(e.right.text?.length||0));let r=e.right.imaginary;return e.operator==="-"&&(r=-r),{type:"complex",position:e.left.position,text:t,id:this.id_counter++,imaginary:r,real:e.left.value,composited:!0}}else e.left=this.BinaryToComplex(e.left),e.right=this.BinaryToComplex(e.right);else if(e.type==="unary"&&(e.operator==="-"||e.operator==="+")&&e.operand.type==="complex"&&e.operand.text===this.imaginary_number)return{...e.operand,position:e.position,text:this.expression.substring(e.position,e.operand.position+(e.operand.text||"").length),imaginary:e.operand.imaginary*(e.operator==="-"?-1:1)};return e}ArrangeUnits(e){if(e.length===0)return{type:"missing",id:this.id_counter++};if(e.length===1)return e[0];let t=[];for(let r=0;r<e.length;r++){let a=e[r];if(a.type!=="group-separator"){if(a.type==="operator")if(t.length===0||t[t.length-1].type==="operator")if(Zs[a.operator]){let i=this.BinaryToComplex(this.ArrangeUnits(e.slice(r+1)));if(!this.valid)return{type:"group",id:this.id_counter++,elements:e,explicit:!1};i.type==="binary"?(i.left={type:"unary",id:this.id_counter++,operator:a.operator,operand:i.left,position:a.position},a=i):a={type:"unary",id:this.id_counter++,operator:a.operator,operand:i,position:a.position},r=e.length}else return this.error=`unexpected character [2]: ${a.operator}`,this.error_position=a.position,this.valid=!1,{type:"group",id:this.id_counter++,elements:e,explicit:!1};else{t.push(a);continue}if(t.length<2){if(t.length===1){let i=t[0].type;if(a.type==="group"&&a.explicit&&(i==="address"||i==="call"||i==="identifier"||i==="implicit-call")){let s=a.elements;s.length===1&&s[0].type==="group"&&!s[0].explicit&&(s=s[0].elements),t[0]={type:"implicit-call",call:t[0],args:s,id:this.id_counter++,position:t[0].position};continue}}t.push(a)}else if(t[t.length-1].type==="operator"){let i=t[t.length-2],s=t[t.length-1],o=s.operator,n={type:"binary",id:this.id_counter++,left:i,operator:o,position:s.position,right:a};i.type==="binary"&&Nr[o]>Nr[i.operator]&&(n.left=i.left,n.operator=i.operator,n.position=i.position,n.right={type:"binary",id:this.id_counter++,left:i.right,right:a,operator:o,position:s.position}),t.splice(-2,2,n)}else t.push(a)}}return t.length>1?{type:"group",id:this.id_counter++,elements:t,explicit:!1}:t[0]}ParseNext(e=!0){this.ConsumeWhiteSpace();let t=this.data[this.index];if(t===cr)return{type:"literal",id:this.id_counter++,position:this.index,value:this.ConsumeString()};if(t>=ze&&t<=bt||t===this.decimal_mark_char)return this.ConsumeNumber();if(t===Hs)return this.ConsumeArray();if(e&&(t===gt||t===fr)){let r=this.data[this.index+1];if(r>=ze&&r<=bt||r===this.decimal_mark_char)return this.ConsumeNumber()}else if(t>=st&&t<=Pt||t>=yt&&t<=Ut||t===br||t===gr||t===ur||t===Nt||t===vt||t>=_r&&t<=vr)return this.ConsumeToken(t);return t}ConsumeArray(){let e={type:"array",id:this.id_counter++,values:[],position:this.index};this.index++;let t=0,r=0;for(;this.index<this.length;){let a=this.ParseNext(),i=this.index;if(typeof a=="number")switch(this.index++,a){case ma:r++,t=0;break;case _t:t++;break;case Gs:return e;default:this.valid&&(this.error="invalid character in array literal",this.error_position=i,this.valid=!1);break}else switch(a.type){case"literal":e.values[t]||(e.values[t]=[]),e.values[t][r]=a.value;break;default:this.valid&&(this.error="invalid value in array literal",this.error_position=i,this.valid=!1);break}}return e}ConsumeOperator(){for(let e of Ks)if(this.expression.substr(this.index,e.length)===e){let t=this.index;return this.index+=e.length,{type:"operator",id:this.id_counter++,operator:e,position:t}}return null}ConsumeArguments(){this.index++;let e=0,t=[];for(;this.index<this.length;){let r=this.ParseGeneric([this.argument_separator_char,pr]);r!==null&&t.push(r);let a=this.data[this.index];if(a===this.argument_separator_char){this.index++,e++;for(let i=t.length;i<e;i++)t.push({type:"missing",id:this.id_counter++})}else if(a===pr)return this.index++,t}return t}ConsumeToken(e){let t=[e],r=this.index,a=e===ur,i=0,s=!1;for(e===vt&&(i=1,s=!0),++this.index;this.index<this.length;this.index++){let h=this.data[this.index];if(h>=st&&h<=Pt||h>=yt&&h<=Ut||h>=_r&&h<=vr||h===br||h===Nt||h===mr||h===Bs||a||h>=ze&&h<=bt||h===vt||i>0&&h===ua||h===gt&&this.flags.r1c1&&i===1||i>0&&h===qs&&this.data[this.index-1]===vt||i===1&&(h===_t||h===da)||i>1||h===$s&&i===0)t.push(h),h===vt&&(i++,s=!0),h===ua&&i--,h===ur&&(a=!1);else break}this.data[this.index]===gr&&t.push(this.data[this.index++]);let o=t.map(h=>String.fromCharCode(h)).join("");if(a)return this.error="unbalanced single quote",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:o,position:r};if(i)return this.error="unbalanced square bracket",this.error_position=r,this.valid=!1,{type:"identifier",id:this.id_counter++,name:o,position:r};if(this.ConsumeWhiteSpace(),this.flags.spreadsheet_semantics){let h=this.ConsumeAddress(o,r);if(h)return h}if(this.data[this.index]===ca){let h=this.ConsumeArguments();return{type:"call",id:this.id_counter++,name:o,args:h,position:r,end:this.index}}if(this.flags.spreadsheet_semantics&&s){let h=this.ConsumeStructuredReference(o,r);if(h)return h}let n=o.toLowerCase();if(n==="true"||this.flags.boolean_true&&n===this.flags.boolean_true.toLowerCase())return{type:"literal",id:this.id_counter++,value:!0,position:r};if(n==="false"||this.flags.boolean_false&&n===this.flags.boolean_false.toLowerCase())return{type:"literal",id:this.id_counter++,value:!1,position:r};let l={type:"identifier",id:this.id_counter++,name:o,position:r};return this.full_reference_list.push(l),l}ConsumeStructuredReference(e,t){let r=e.length,a=e,i="",s=0;for(;s<r;s++){if(e[s]==="["){e=e.substring(s);break}i+=e[s]}if(e[0]!=="["||e[e.length-1]!=="]")return;e=e.substring(1,e.length-1);let o=e.split(",").map(d=>d.trim()),n="column",l="";if(o.length>2)return;o.length===2?(/\[#this row\]/i.test(o[0])?n="row":/\[#all\]/i.test(o[0])&&(n="all"),l=o[1]):(l=o[0],l[0]==="@"&&(n="row",l=l.substring(1,l.length))),l[0]==="["&&l[l.length-1]==="]"&&(l=l.substring(1,l.length-1));let h={type:"structured-reference",id:this.id_counter++,label:a,position:t,scope:n,column:l,table:i};return this.full_reference_list.push(h),h}ConsumeAddress(e,t){let r=t,a=e.length,i,s=e.split("!");if(s.length>1&&(i=s.slice(0,s.length-1).join("!"),t+=i.length+1),this.flags.r1c1){let d=s[s.length-1].match(this.r1c1_regex);if(d){let c={type:"address",id:this.id_counter++,label:e,row:0,column:0,position:r,sheet:i,r1c1:!0};return d[1][0]==="["?(c.offset_row=!0,c.row=Number(d[1].substring(1,d[1].length-1))):d[1]?c.row=Number(d[1])-1:(c.offset_row=!0,c.row=0),d[2][0]==="["?(c.offset_column=!0,c.column=Number(d[2].substring(1,d[2].length-1))):d[2]?c.column=Number(d[2])-1:(c.offset_column=!0,c.column=0),c}}let o=this.ConsumeAddressColumn(t);if(!o)return null;t=o.position;let n=this.ConsumeAddressRow(t);if(!n||(t=n.position,o.column===8508&&n.row===9))return null;let l=i?i+e.substr(i.length,t-r).toUpperCase():e.substr(0,t-r).toUpperCase();i&&i[0]==="'"&&(i=i.substr(1,i.length-2));let h={type:"address",id:this.id_counter++,label:l,row:n.row,column:o.column,absolute_row:n.absolute,absolute_column:o.absolute,position:r,sheet:i,spill:n.spill};return a!==t-r?null:(this.dependencies.addresses[h.label]=h,this.address_refcount[h.label]=(this.address_refcount[h.label]||0)+1,this.full_reference_list.push(h),h)}ConsumeAddressRow(e){let t=this.data[e]===Nt;t&&e++;let r=e,a=0;for(;;e++){let s=this.data[e];if(s>=ze&&s<=bt)a*=10,a+=s-ze;else break}if(r===e||a===0)return!1;let i=!1;return this.data[e]===gr&&(e++,i=!0),{absolute:t,row:a-1,position:e,spill:i}}ConsumeAddressColumn(e){let t=-1,r=0,a=this.data[e]===Nt;for(a&&e++;;e++,r++){if(r>=4)return!1;let i=this.data[e];if(i>=st&&i<=Pt)t=26*(1+t)+(i-st);else if(i>=yt&&i<=Ut)t=26*(1+t)+(i-yt);else break}return t<0?!1:{absolute:a,column:t,position:e}}ConsumeNumber(){let e=this.index,t=0,r=!1,a=!1,i=0,s=0,o=0,n="integer",l=0,h=!1,d=this.index;for(;this.index<this.length;this.index++,l++){let u=this.data[this.index];if(u===this.decimal_mark_char)if(n==="integer")n="fraction";else break;else if(u===Os){i/=100,o/=100,this.index++;break}else if(u===fr||u===gt)if(l===0)u===gt&&(a=!0);else break;else if(u===js||u===Js)if(n==="integer"||n==="fraction")n="exponent",this.index<this.length-1&&(this.data[this.index+1]===fr?this.index++:this.data[this.index+1]===gt&&(this.index++,r=!0));else break;else if(u===this.imaginary_char){let m=this.data[this.index+1];if(m>=st&&m<=Pt||m>=yt&&m<=Ut||m>=_r&&m<=vr||m===br)break;if(n==="integer"||n==="fraction"){this.index++,h=!0;break}}else if(u>=ze&&u<=bt)switch(n){case"integer":i=i*10+(u-ze);break;case"fraction":o=o*10+(u-ze),s++;break;case"exponent":t=t*10+(u-ze);break}else break}let c=i+o/Math.pow(10,s);return n==="exponent"&&(c=c*Math.pow(10,(r?-1:1)*t)),h?{type:"complex",id:this.id_counter++,position:e,imaginary:a?-c:c,real:0,text:this.expression.substring(d,this.index)||""}:{type:"literal",id:this.id_counter++,position:e,value:a?-c:c,text:this.expression.substring(d,this.index)||""}}ConsumeString(){this.index++;let e=[];for(;this.index<this.length;this.index++){let t=this.data[this.index];if(t===cr&&(this.index++,this.index>=this.length||this.data[this.index]!==cr))break;e.push(t)}return e.map(t=>String.fromCharCode(t)).join("")}ConsumeWhiteSpace(){for(;this.index<this.length;){let e=this.data[this.index];if(e===da||e===Us||e===Is||e===Vs||e===Ps)this.index++;else return}}},Xs=(e,t=",")=>{let r=0,a=[],i="",s=[],o=e.length;if(/[\r\n"]/.test(t))throw new Error("invalid delimiter");for(let n=0;n<o;n++){let l=e[n];if(!(n===0&&l.charCodeAt(0)===65279))if(r===0)switch(l){case t:a.push(i),i="";break;case"\r":break;case`
`:a.push(i),i="",s.push(a),a=[];break;case'"':i.length===0?r=1:i+=l;break;default:i+=l;break}else l==='"'?n+1<o&&e[n+1]==='"'?(i+='"',n++):r=0:i+=l}return(a.length||i.length)&&(a.push(i),s.push(a)),s},or=class Li{static _instance=new Li;constructor(){}static get instance(){return this._instance}HTML(t,r={}){r={br:!0,...r};let a=[];for(let i of t){let s=[];for(let o of i)o.pre&&s.push("<pre>"),o.emphasis&&s.push("<em>"),o.strong&&s.push("<strong>"),o.strike&&s.push("<strike>"),s.push(o.text),o.strike&&s.push("</strike>"),o.strong&&s.push("</strong>"),o.emphasis&&s.push("</em>"),o.pre&&s.push("</pre>");a.push(s.join(""))}return a.join(r.br?`<br/>
`:`
`)}Dummy(t=""){return t.split(/\n/).map(r=>[{text:r}])}Parse(t=""){let r=this.Tokenize(t);for(let a=0;a<r.length;a++){let i=r[a];if(i.type==="delimeter"){let s=r[a-1],o=r[a+1],n=!s||s.type==="whitespace"||s.type==="newline",l=s&&s.type==="text"&&/[^\w\d]$/.test(s.text),h=!o||o.type==="whitespace"||o.type==="newline",d=o&&o.type==="text"&&/^[^\w\d]/.test(o.text);i.left_flanking=!h&&(!d||n),i.right_flanking=!n&&(!l||h||d)}}return this.ApplyFormatting(r),this.Consolidate(r)}IsWhitespace(t){return t===" "||t==="	"}IsNewline(t){return t==="\r"||t===`
`}IsDelimeter(t){return t==="*"||t==="_"||t==="~"}Consolidate(t){let r=[],a={},i=[],s={type:"text",text:""};for(let o of t)if(o.type==="newline")s.text.length&&i.push(s),s={...a,text:"",type:"text"},r.push(i),i=[];else switch((!!a.strong!=!!o.strong||!!a.emphasis!=!!o.emphasis||!!a.strike!=!!o.strike)&&(a.strong=!!o.strong,a.emphasis=!!o.emphasis,a.strike=!!o.strike,s.text.length&&i.push(s),s={...a,text:"",type:"text"}),o.type){case"text":case"whitespace":s.text+=o.text;break;case"delimeter":for(let n=0;n<o.length;n++)s.text+=o.char;break}return s.text.length&&i.push(s),i.length&&r.push(i),r}ApplyFormatting(t,r){let a=0,i=t.length;for(a=0;a<i;a++){let s=t[a];if(s.type==="delimeter"){if(r&&s.right_flanking&&r.char===s.char&&s.length>0)return{index:a,token:s};if(s.left_flanking){let o=this.ApplyFormatting(t.slice(a+1),s);if(o.token){let n=Math.min(o.token.length,s.length),l=s.char==="~",h=!l&&!!(n%2),d=!l&&n>=2;for(let c=a+1;c<=a+o.index;c++)t[c].strong=!!t[c].strong||d,t[c].emphasis=!!t[c].emphasis||h,t[c].strike=!!t[c].strike||l;o.token.length-=n,s.length-=n,s.length>0?a--:a+=o.index}}}}return{index:a}}Tokenize(t=""){let r=[],a=t.length,i=0,s=!1,o="";for(i=0;i<a;i++){let n=t[i];if(this.IsWhitespace(n)){o&&r.push({type:"text",text:o});let l=n;for(;;){let h=t[i+1];if(this.IsWhitespace(h))l+=h,i++;else break}r.push({type:"whitespace",text:l}),s=!1,o=""}else if(this.IsNewline(n)){o&&r.push({type:"text",text:o}),r.push({type:"newline",text:n});let l="";for(;;){let h=t[i+1];if(this.IsNewline(h))l+=h,i++;else break}l.length&&r.push({type:"newline",text:l}),s=!1,o=""}else if(s)o+=n,s=!1;else if(this.IsDelimeter(n)){o&&r.push({type:"text",text:o});let l=n;for(;;){let h=t[i+1];if(h===n)l+=h,i++;else break}r.push({type:"delimeter",text:l,char:n,length:l.length}),s=!1,o=""}else n==="\\"?s=!0:o+=n}return o&&r.push({type:"text",text:o}),r}},$=e=>e!==null&&typeof e=="object"&&"row"in e&&"column"in e,Pr=e=>e!==null&&typeof e=="object"&&"start"in e&&$(e.start)&&"end"in e&&$(e.end),k=class Q{start_;end_;constructor(t,r=t,a=!1){this.end_=this.PatchNull(r),this.start_=this.PatchNull(t),a&&this.Normalize()}static FromColumn(t){return new Q({row:1/0,column:t})}static FromRow(t){return new Q({row:t,column:1/0})}static ColumnToLabel(t){let r=String.fromCharCode(65+t%26);for(;t>25;)t=Math.floor(t/26)-1,r=String.fromCharCode(65+t%26)+r;return r}static CellAddressToLabel(t,r=!1){if(t.row===1/0&&t.column===1/0)throw new Error("this is going to break something");let a=r?`${t.sheet_id||0}!`:"";return t.row===1/0?a+(t.absolute_column?"$":"")+this.ColumnToLabel(t.column):t.column===1/0?a+(t.absolute_row?"$":"")+(t.row+1):a+(t.absolute_column?"$":"")+this.ColumnToLabel(t.column)+(t.absolute_row?"$":"")+(t.row+1)+(t.spill?"#":"")}static Join(t,...r){let a=new Q(t.start,t.end);for(let i of r)i&&(a.ConsumeAddress(i.start),a.ConsumeAddress(i.end));return a}static Bleed(t,r=1){return new Q({row:Math.max(0,t.start.row-r),column:Math.max(0,t.start.column-r),sheet_id:t.start.sheet_id},{row:t.end.row+r,column:t.end.column+r})}static PatchArea(t,r){let{before_column:a,column_count:i,before_row:s,row_count:o}=r,n=new Q(t.start,t.end),l=t.start.sheet_id;if(i&&a<=n.end.column){if(i>0)a<=n.start.column?n.Shift(0,i):a>n.start.column&&a<=n.end.column?n.ConsumeAddress({row:n.end.row,column:n.end.column+i}):console.warn("AA X case 1",a,i,JSON.stringify(n));else if(i<0)if(a-i<=n.start.column)n.Shift(0,i);else{if(a<=n.start.column&&a-i>n.end.column)return!1;if(a<=n.start.column){let h=a-i-1;n=new Q({row:n.start.row,column:h+1+i,sheet_id:l},{row:n.end.row,column:n.end.column+i})}else a<=n.end.column?a-i-1>=n.end.column?n=new Q({row:n.start.row,column:n.start.column,sheet_id:l},{row:n.end.row,column:a-1}):n=new Q({row:n.start.row,column:n.start.column,sheet_id:l},{row:n.end.row,column:n.start.column+n.columns+i-1}):console.warn("AA X case 2",a,i,JSON.stringify(n))}}if(o&&s<=n.end.row){if(o>0)s<=n.start.row?n.Shift(o,0):s>n.start.row&&s<=n.end.row?n.ConsumeAddress({row:n.end.row+o,column:n.end.column}):console.warn("AA X case 3",s,o,JSON.stringify(n));else if(o<0)if(s-o<=n.start.row)n.Shift(o,0);else{if(s<=n.start.row&&s-o>n.end.row)return!1;if(s<=n.start.row){let h=s-o-1;n=new Q({column:n.start.column,row:h+1+o,sheet_id:l},{column:n.end.column,row:n.end.row+o})}else s<=n.end.row?s-o-1>=n.end.row?n=new Q({column:n.start.column,row:n.start.row,sheet_id:l},{column:n.end.column,row:s-1}):n=new Q({column:n.start.column,row:n.start.row,sheet_id:l},{column:n.end.column,row:n.start.row+n.rows+o-1}):console.warn("AA X case 4",s,o,JSON.stringify(n))}}return n}get start(){return{...this.start_}}set start(t){this.start_=t}get end(){return{...this.end_}}set end(t){this.end_=t}get rows(){return this.start_.row===1/0||this.end_.row===1/0?1/0:this.end_.row-this.start_.row+1}get columns(){return this.start_.column===1/0||this.end_.column===1/0?1/0:this.end_.column-this.start_.column+1}get count(){return this.rows*this.columns}get entire_sheet(){return this.entire_row&&this.entire_column}get entire_column(){return this.start_.row===1/0}get entire_row(){return this.start_.column===1/0}PatchNull(t){let r={...t};return r.row===null&&(r.row=1/0),r.column===null&&(r.column=1/0),r}SetSheetID(t){this.start_.sheet_id=t}Normalize(){let t={...this.start_},r={...this.end_};t.row===1/0||r.row===1/0?t.row=r.row=1/0:t.row>r.row&&(t.row=this.end_.row,t.absolute_row=this.end_.absolute_row,r.row=this.start_.row,r.absolute_row=this.start_.absolute_row),t.column===1/0||r.column===1/0?t.column=r.column=1/0:t.column>r.column&&(t.column=this.end_.column,t.absolute_column=this.end_.absolute_column,r.column=this.start_.column,r.absolute_column=this.start_.absolute_column),this.start_=t,this.end_=r}TopLeft(){let t={row:0,column:0};return this.entire_row||(t.column=this.start.column),this.entire_column||(t.row=this.start.row),t}BottomRight(){let t={row:0,column:0};return this.entire_row||(t.column=this.end.column),this.entire_column||(t.row=this.end.row),t}ContainsRow(t){return this.entire_column||t>=this.start_.row&&t<=this.end_.row}ContainsColumn(t){return this.entire_row||t>=this.start_.column&&t<=this.end_.column}Contains(t){return(this.entire_column||t.row>=this.start_.row&&t.row<=this.end_.row)&&(this.entire_row||t.column>=this.start_.column&&t.column<=this.end_.column)}ContainsArea(t){return this.start.column<=t.start.column&&this.end.column>=t.end.column&&this.start.row<=t.start.row&&this.end.row>=t.end.row}Intersects(t){return!(t.start.column>this.end.column||this.start.column>t.end.column||t.start.row>this.end.row||this.start.row>t.end.row)}Equals(t){return t.start_.row===this.start_.row&&t.start_.column===this.start_.column&&t.end_.row===this.end_.row&&t.end_.column===this.end_.column}Equals2(t){return t.start.row===this.start_.row&&t.start.column===this.start_.column&&t.end.row===this.end_.row&&t.end.column===this.end_.column}Clone(){return new Q(this.start,this.end)}get left(){let t=new Q(this.start_,this.end_);return t.end_.column=t.start_.column,t}get right(){let t=new Q(this.start_,this.end_);return t.start_.column=t.end_.column,t}get top(){let t=new Q(this.start_,this.end_);return t.end_.row=t.start_.row,t}get bottom(){let t=new Q(this.start_,this.end_);return t.start_.row=t.end_.row,t}Shift(t,r){return this.start_.row+=t,this.start_.column+=r,this.end_.row+=t,this.end_.column+=r,this}ConsumeAddress(t){this.entire_row||(t.column<this.start_.column&&(this.start_.column=t.column),t.column>this.end_.column&&(this.end_.column=t.column)),this.entire_column||(t.row<this.start_.row&&(this.start_.row=t.row),t.row>this.end_.row&&(this.end_.row=t.row))}Reshape(t,r){return this.end_.row=this.start_.row+t-1,this.end_.column=this.start_.column+r-1,this}ConsumeArea(t){this.ConsumeAddress(t.start),this.ConsumeAddress(t.end)}Resize(t,r){return this.end_.row=this.start_.row+t-1,this.end_.column=this.start_.column+r-1,this}[Symbol.iterator](){if(this.entire_row||this.entire_column)throw new Error("don't iterate infinite area");let t=this.start_.row,r=this.start_.column;return{next:()=>{let a={column:r,row:t,sheet_id:this.start_.sheet_id};return r>this.end_.column?{done:!0,value:void 0}:(++t>this.end_.row&&(t=this.start_.row,r++),{value:a})}}}get spreadsheet_label(){let t;return this.entire_sheet?"":this.entire_column?(t=Q.ColumnToLabel(this.start_.column),t+=":"+Q.ColumnToLabel(this.end_.column),t):this.entire_row?(t=String(this.start_.row+1),t+=":"+(this.end_.row+1),t):(t=Q.CellAddressToLabel(this.start_),this.columns>1||this.rows>1?t+":"+Q.CellAddressToLabel(this.end_):t)}toJSON(){return{start:{...this.start_},end:{...this.end_}}}},Ne=e=>typeof e=="object"&&!!e&&typeof e.real=="number"&&typeof e.imaginary=="number",nr=e=>e.real?e.imaginary?e.imaginary>0?`${e.real} + ${e.imaginary}i`:`${e.real} - ${Math.abs(e.imaginary)}i`:e.real.toString():e.imaginary?e.imaginary+"i":"0",Ei=e=>typeof e=="object"&&!!e&&typeof e.value=="number"&&typeof e.unit=="string",Qs=e=>typeof e=="object"&&e.type==="function",Fi=["undefined","formula","string","number","boolean","object","function","error","complex","array","dimensioned_quantity"],qe=e=>{switch(typeof e){case"undefined":return 0;case"number":return 3;case"boolean":return 4;case"object":return e===null?0:Qs(e)?10:Ne(e)?7:Ei(e)?9:5;case"string":return e[0]==="="?1:2;default:return 6}},me=class{static StringToColumn(e){let t=0;e=e.toUpperCase();for(let r=0;r<e.length;r++)t*=26,t+=e.charCodeAt(r)-64;return t-1}value;type=0;calculated;calculated_type;formatted;rendered_type;style;area;spill;merge_area;table;renderer_data;render_clean=[];note;hyperlink;editing;render_function;click_function;constructor(e,t){typeof e<"u"&&this.Set(e,t)}ValueIsNumber(){return this.type===3}ValueIsFormula(){return this.type===1}ValueIsBoolean(){return this.type===4}ValueIsComplex(){return this.type===7}FlushStyle(){this.formatted=this.rendered_type=this.style=void 0,this.render_clean=[]}FlushArray(){this.area=void 0}FlushCache(){this.calculated=this.calculated_type=this.formatted=this.rendered_type=this.render_function=this.click_function=void 0,this.render_clean=[]}Reset(){this.type=0,this.value=this.spill=this.note=this.hyperlink=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.area=this.renderer_data=this.render_function=this.click_function=void 0,this.render_clean=[]}Set(e,t=qe(e)){this.value=e,this.type=t,this.spill=this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=this.render_function=this.click_function=this.area=void 0,this.render_clean=[]}SetCalculatedValue(e,t=qe(e)){e===void 0&&(e=0,t=3),this.calculated!==e&&(this.calculated=e,this.calculated_type=t,this.formatted=this.rendered_type=void 0,this.render_clean=[])}GetValue(){return this.calculated_type?this.calculated:typeof this.value=="string"&&this.value[0]==="'"?this.value.slice(1):this.value}GetValue4(){return this.calculated_type?{type:this.calculated_type,value:this.calculated}:this.type===1?{type:3,value:0}:{type:this.type,value:typeof this.value=="string"&&this.value[0]==="'"?this.value.slice(1):this.value}}SetNote(e){this.note=e,this.render_clean=[]}SetCalculationError(e="ERR"){this.SetCalculatedValue(e,6)}SetArray(e){this.type=0,this.value=this.formatted=this.rendered_type=this.style=this.hyperlink=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}SetArrayHead(e,t){this.type=qe(t),this.value=t,this.formatted=this.rendered_type=this.style=this.calculated=this.calculated_type=void 0,this.area=e,this.render_clean=[]}},Ni=e=>!e.cells,dr=e=>!!e[0]&&Ni(e[0]),ta=e=>!!e[0]&&e[0].row!==void 0,Ys=Fi.map((e,t)=>({[e]:t})).reduce((e,t)=>({...e,...t}),{}),eo=class{data=[];rows_=0;columns_=0;get rows(){return this.rows_}get columns(){return this.columns_}EnsureRow(e){this.rows_=Math.max(e+1,this.rows_)}EnsureColumn(e){this.columns_=Math.max(e+1,this.columns_)}InsertColumns(e=0,t=1){this.data=this.data.map(r=>{if(r.length>=e){let a=r.slice(0,e),i=e+t,s=r.slice(e);for(let o=0;o<s.length;o++)a[i++]=s[o];return a}return r}),this.columns_+=t}DeleteColumns(e,t=1){this.data.forEach(r=>r.splice(e,t)),this.columns_-=t}DeleteRows(e,t=1){this.data.splice(e,t),this.rows_-=t}InsertRows(e=0,t=1){let r=[e,0,[]];for(let a=1;a<t;a++)r.push([]);Array.prototype.splice.apply(this.data,r),this.rows_+=t}GetCell(e,t){let{row:r,column:a}=e;if(!this.data[r])if(t)this.data[r]=[],this.rows_=Math.max(this.rows_,r+1);else return;return this.data[r][a]||t&&(this.data[r][a]=new me,this.columns_=Math.max(this.columns_,a+1)),this.data[r][a]}EnsureCell(e){let{row:t,column:r}=e,a=this.data[t];a||(this.data[t]=a=[],this.rows_=Math.max(this.rows_,t+1));let i=a[r];return i||(i=a[r]=new me,this.columns_=Math.max(this.columns_,r+1)),i}FromArray(e=[],t=!1){this.data=[];let r=0,a=0;if(t){a=e.length;for(let i=0;i<a;i++){let s=e[i];r=Math.max(r,s.length);for(let o=0;o<s.length;o++)this.data[o]||(this.data[o]=[]),this.data[o][i]=new me(s[o])}}else{r=e.length;for(let i=0;i<r;i++){let s=[],o=e[i];a=Math.max(a,o.length);for(let n=0;n<o.length;n++)s[n]=new me(o[n]);this.data[i]=s}}this.rows_=r,this.columns_=a}SerializedTypeToValueType(e){if(e)return typeof e=="number"?e:Ys[e]||void 0}ValueTypeToSerializedType(e){return e?Fi[e]:void 0}FromJSON(e=[],t){if(this.data=[],!dr(e)){let a=[];if(ta(e))for(let i of e)for(let s of i.cells)a.push({...s,row:i.row});else for(let i of e)for(let s of i.cells)a.push({...s,column:i.column});e=a}let r=[];for(let a of e){this.data[a.row]||(this.data[a.row]=[]);let i=new me(a.value);if(typeof a.calculated<"u"&&(i.SetCalculatedValue(a.calculated,this.SerializedTypeToValueType(a.calculated_type)),a.spill&&(i.spill=new k(a.spill.start,a.spill.end))),t&&typeof a.style_ref<"u"&&(i.style=t[a.style_ref]),typeof a.note<"u"&&(i.note=a.note),typeof a.hyperlink<"u"&&(i.hyperlink=a.hyperlink),this.data[a.row][a.column]&&this.data[a.row][a.column].area&&(i.area=this.data[a.row][a.column].area),this.data[a.row][a.column]=i,a.area){let s=new k(a.area.start,a.area.end);for(let o=s.start.row;o<=s.end.row;o++)for(let n=s.start.column;n<=s.end.column;n++)this.data[o]||(this.data[o]=[]),this.data[o][n]||(this.data[o][n]=new me),this.data[o][n].area=s}if(a.table&&r.push({...a.table}),a.merge_area){let s=new k(a.merge_area.start,a.merge_area.end);for(let o=s.start.row;o<=s.end.row;o++)for(let n=s.start.column;n<=s.end.column;n++)this.data[o]||(this.data[o]=[]),this.data[o][n]||(this.data[o][n]=new me),this.data[o][n].merge_area=s}}for(let a of r)for(let i=a.area.start.row;i<=a.area.end.row;i++)for(let s=a.area.start.column;s<=a.area.end.column;s++)this.data[i]||(this.data[i]=[]),this.data[i][s]||(this.data[i][s]=new me),this.data[i][s].table=a;this.rows_=this.data.length,this.columns_=this.data.reduce((a,i)=>Math.max(a,i.length),0)}toJSON(e={}){let t=0,r=0,a=this.data.length-1,i;e.subset&&(t=e.subset.start.column,r=e.subset.start.row,a=e.subset.end.row);let s=[],o=-1,n=-1,l={},h={};for(let d=r;d<=a;d++)if(this.data[d]){let c=this.data[d];i=c.length-1,e.subset&&(i=e.subset.end.column);for(let u=t;u<=i;u++){let m=c[u],f=m&&m.merge_area&&m.merge_area.start.row===d&&m.merge_area.start.column===u,p=m&&m.area&&m.area.start.row===d&&m.area.start.column===u,b=m&&m.table&&m.table.area.start.row===d&&m.table.area.start.column===u,w=m?m.type===2&&!m.value:!0;if(m&&(!w||e.preserve_empty_strings)&&(f||m.type||m.calculated_type&&e.expand_arrays||m.calculated_type&&e.calculated_value||m.note||e.decorated_cells&&m.style&&(m.style.fill||m.style.border_bottom||m.style.border_top||m.style.border_left||m.style.border_right))){let y={row:d,column:u,value:m.value};m.note&&(y.note=m.note),m.hyperlink&&(y.hyperlink=m.hyperlink),e.preserve_type&&(y.type=this.ValueTypeToSerializedType(m.type)),e.sheet_id&&(y.sheet_id=e.sheet_id),e.calculated_value&&typeof m.calculated<"u"&&(y.calculated=m.calculated,m.spill&&(y.spill=m.spill.toJSON()),(e.preserve_type||m.calculated_type===6)&&(y.calculated_type=this.ValueTypeToSerializedType(m.calculated_type))),m.table&&b&&e.tables&&(y.table=JSON.parse(JSON.stringify(m.table))),m.area&&p&&(y.area=m.area.toJSON()),m.merge_area&&(y.merge_area=m.merge_area.toJSON()),e.cell_style_refs&&e.cell_style_refs[u]&&e.cell_style_refs[u][d]&&(y.style_ref=e.cell_style_refs[u][d],e.cell_style_refs[u][d]=0),l[d]=d,h[u]=u,o=Math.max(d,o),n=Math.max(u,n),s.push(y)}}}if(e.nested){let d=Object.keys(l),c=Object.keys(h);if(d.length<=c.length&&d.length){let u={},m=[];for(let f of s){let{row:p,...b}=f;u[f.row]||(u[f.row]=[]),u[f.row].push(b)}for(let f of d){let p=Number(f);m.push({row:p,cells:u[p]})}return{data:m,rows:o,columns:n+1}}else if(c.length){let u={},m=[];for(let f of s){let{column:p,...b}=f;u[f.column]||(u[f.column]=[]),u[f.column].push(b)}for(let f of c){let p=Number(f);m.push({column:p,cells:u[p]})}return{data:m,rows:o,columns:n+1}}}return{data:s,rows:o+1,columns:n+1}}GetAll(e=!1){return this.GetRange({row:0,column:0},{row:this.rows_-1,column:this.columns_-1},e)}Normalize(e,t){return e={...e,row:e.row==1/0?0:e.row,column:e.column==1/0?0:e.column},t&&(t={...t,row:t.row==1/0?this.rows_-1:t.row,column:t.column==1/0?this.columns_-1:t.column}),{from:e,to:t}}RawValue(e,t=e){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].value:void 0;let r=[],a=this.data.slice(e.row,t.row+1),i=e.column,s=t.column+1;for(let o of a){let n=[];for(let l=i,h=0;l<s;l++,h++){let d=o[l];n.push(d?d.value:void 0)}r.push(n)}return r}GetRange(e,t,r=!1){if({from:e,to:t}=this.Normalize(e,t),!t||e===t||e.column===t.column&&e.row===t.row)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue():void 0;let a=[];if(r)for(let i=e.column;i<=t.column;i++){let s=[];for(let o=e.row;o<=t.row;o++)this.data[o]&&this.data[o][i]?s.push(this.data[o][i].GetValue()):s.push(void 0);a.push(s)}else for(let i=e.row;i<=t.row;i++){let s=[];for(let o=e.column;o<=t.column;o++)this.data[i]&&this.data[i][o]?s.push(this.data[i][o].GetValue()):s.push(void 0);a.push(s)}return a}GetRange4(e,t=e,r=!1){if({from:e,to:t}=this.Normalize(e,t),e.row===t.row&&e.column===t.column)return this.data[e.row]&&this.data[e.row][e.column]?this.data[e.row][e.column].GetValue4():{value:void 0,type:0};let a=[];if(r)for(let i=e.column;i<=t.column;i++){let s=[];for(let o=e.row;o<=t.row;o++)this.data[o]&&this.data[o][i]?s.push(this.data[o][i].GetValue4()):s.push({type:0});a.push(s)}else for(let i=e.row;i<=t.row;i++){let s=[];for(let o=e.column;o<=t.column;o++)this.data[i]&&this.data[i][o]?s.push(this.data[i][o].GetValue4()):s.push({type:0});a.push(s)}return{type:8,value:a}}SetArea(e,t){if(ArrayBuffer.isView(t))throw new Error("ABIV");if(Array.isArray(t))for(let r=e.start.row,a=0;r<=e.end.row;r++,a++){this.data[r]||(this.data[r]=[]);let i=this.data[r];if(t[a])for(let s=e.start.column,o=0;s<=e.end.column;s++,o++)i[s]||(i[s]=new me),i[s].Set(t[a][o])}else{let r=qe(t);for(let a=e.start.row;a<=e.end.row;a++){this.data[a]||(this.data[a]=[]);let i=this.data[a];for(let s=e.start.column;s<=e.end.column;s++)i[s]||(i[s]=new me),i[s].Set(t,r)}}this.rows_=Math.max(this.rows_,e.end.row+1),this.columns_=Math.max(this.columns_,e.end.column+1)}*IterateRC(e,t=!1){if(!e&&t&&(e=new k({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e)if(t)for(let r=e.start.row;r<=e.end.row;r++){this.data[r]||(this.data[r]=[]);let a=this.data[r];for(let i=e.start.column;i<=e.end.column;i++)a[i]||(a[i]=new me),yield{cell:a[i],row:r,column:i}}else for(let r=e.start.row;r<=e.end.row;r++){let a=this.data[r];if(a)for(let i=e.start.column;i<=e.end.column;i++){let s=a[i];s&&(yield{cell:s,row:r,column:i})}}else for(let[r,a]of this.data.entries())if(a)for(let[i,s]of a.entries())s&&(yield{cell:s,row:r,column:i})}*Iterate(e,t=!1){if(!e&&t&&(e=new k({row:0,column:0},{row:this.rows_-1,column:this.columns-1})),e){$(e)&&(e=new k(e)),(e.entire_column||e.entire_row)&&(e=new k(e.start,e.end),e.start.column===1/0&&(e.start.column=0,e.end.column=this.columns_-1),e.start.row===1/0&&(e.start.row=0,e.end.row=this.rows_-1));let r=e.start,a=e.end;if(t)for(let i=r.row;i<=a.row;i++){this.data[i]||(this.data[i]=[]);let s=this.data[i];for(let o=r.column;o<=a.column;o++)s[o]||(s[o]=new me),yield s[o]}else for(let i=r.row;i<=a.row;i++)if(this.data[i]){let s=this.data[i];for(let o=r.column;o<=a.column;o++)s[o]&&(yield s[o])}}else for(let r of this.data)if(r)for(let a of r)a&&(yield a)}FlushCellStyles(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushStyle()}FlushCachedValues(){for(let e of this.data)if(e)for(let t of e)t&&t.FlushCache()}},G=class{static locale="en-us";static decimal_separator=".";static argument_separator=",";static grouping_separator=",";static date_components={short_days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],long_days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],long_months:["January","February","March","April","May","June","July","August","September","October","November","December"]};static UpdateLocale(e){if(e)this.locale=e;else if(typeof self<"u"){let a=self?.document?.location;if(a&&a.search&&/locale=([^?&]+?)(?:\?|$|&)/.test(a.search)){let i=a.search.match(/locale=(.*?)(?:\?|$|&)/);i&&(this.locale=i[1]),console.info("override locale",this.locale)}else typeof navigator<"u"&&(navigator.languages&&navigator.languages[0]?this.locale=navigator.languages[0]:this.locale=navigator.language)}this.locale==="C"&&(console.warn("Locale not set, defaulting to en-us"),this.locale="en-us");let t=new Intl.NumberFormat(this.locale,{minimumFractionDigits:1}).format(3.3).replace(/\d/g,"");this.decimal_separator=t===","?",":".",this.decimal_separator===","?(this.argument_separator=";",this.grouping_separator=" "):(this.argument_separator=",",this.grouping_separator=",");let r=new Date(2e3,0,2,12,0,0,0);this.UpdateDateComponent(0,0,r),r=new Date(2e3,1,7,12,0,0,0),this.UpdateDateComponent(1,1,r),r=new Date(2e3,2,7,12,0,0,0),this.UpdateDateComponent(2,2,r),r=new Date(2e3,3,5,12,0,0,0),this.UpdateDateComponent(3,3,r),r=new Date(2e3,4,4,12,0,0,0),this.UpdateDateComponent(4,4,r),r=new Date(2e3,5,2,12,0,0,0),this.UpdateDateComponent(5,5,r),r=new Date(2e3,6,1,12,0,0,0),this.UpdateDateComponent(6,6,r),r=new Date(2e3,7,1,12,0,0,0),this.UpdateDateComponent(7,-1,r),r=new Date(2e3,8,1,12,0,0,0),this.UpdateDateComponent(8,-1,r),r=new Date(2e3,9,1,12,0,0,0),this.UpdateDateComponent(9,-1,r),r=new Date(2e3,10,1,12,0,0,0),this.UpdateDateComponent(10,-1,r),r=new Date(2e3,11,1,12,0,0,0),this.UpdateDateComponent(11,-1,r)}static UpdateDateComponent(e,t,r){t>=0&&(this.date_components.short_days[t]=r.toLocaleString(this.locale,{weekday:"short"}),this.date_components.long_days[t]=r.toLocaleString(this.locale,{weekday:"long"})),e>=0&&(this.date_components.short_months[e]=r.toLocaleString(this.locale,{month:"short"}),this.date_components.long_months[e]=r.toLocaleString(this.locale,{month:"long"}))}};G.UpdateLocale();var ie=class ht{constructor(t=0,r=0,a=0,i=0){this.left=t,this.top=r,this.width=a,this.height=i}get right(){return this.left+this.width}get bottom(){return this.top+this.height}static Create(t){return new ht(t.left||0,t.top||0,t.width||0,t.height||0)}static IsRectangle(t){return!!t&&typeof t=="object"&&typeof t.left=="number"&&typeof t.top=="number"&&typeof t.width=="number"&&typeof t.height=="number"}Shift(t=0,r=0){return new ht(this.left+t,this.top+r,this.width,this.height)}Scale(t=1,r=t){return new ht(this.left*t,this.top*r,this.width*t,this.height*r)}Expand(t=0,r=0){return new ht(this.left,this.top,this.width+t,this.height+r)}Combine(t){return new ht(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right)-Math.min(this.left,t.left),Math.max(this.bottom,t.bottom)-Math.min(this.top,t.top))}Contains(t,r,a=0){return t>=this.left-a&&t<=this.left+this.width+a&&r>=this.top-a&&r<=this.top+this.height+a}ContextFill(t){t.fillRect(this.left,this.top,this.width,this.height)}ContextStroke(t){t.strokeRect(this.left,this.top,this.width,this.height)}Clamp(t,r){return t=Math.min(Math.max(t,this.left),this.right),r=Math.min(Math.max(r,this.top),this.bottom),{x:t,y:r}}ApplyStyle(t){t.style.top=this.top+"px",t.style.left=this.left+"px",t.style.width=this.width+"px",t.style.height=this.height+"px"}toJSON(){return{top:this.top,left:this.left,width:this.width,height:this.height}}},to=JSON.stringify({}),ro={Background:0,Text:1,Background2:2,Text2:3,Accent:4,Accent2:5,Accent3:6,Accent4:7,Accent5:8,Accent6:9},Pi=e=>typeof e.theme=="number"?e.theme:ro[e.theme]||0,oe=e=>!!e&&typeof e.text=="string",ra=e=>!!e&&typeof e.theme<"u",ao=e=>!!e&&(typeof e.text=="string"||typeof e.theme<"u"),H={DefaultProperties:{horizontal_align:"",vertical_align:"",number_format:"General",nan:"NaN",font_size:{unit:"em",value:1},bold:!1,italic:!1,underline:!1,strike:!1,text:{theme:1},border_top:0,border_left:0,border_right:0,border_bottom:0},CompositeBorders:e=>({top:{width:e.border_top||0,color:e.border_top_fill||{}},left:{width:e.border_left||0,color:e.border_left_fill||{}},right:{width:e.border_right||0,color:e.border_right_fill||{}},bottom:{width:e.border_bottom||0,color:e.border_bottom_fill||{}}}),Merge:(e,t,r=!0)=>{let a=r?{...e,...t}:{...t};return JSON.parse(JSON.stringify(a))},Composite:e=>JSON.parse(JSON.stringify(e.reduce((t,r)=>({...t,...r}),{}))),Empty:e=>JSON.stringify(e)===to,ParseFontSize:(e="",t="em")=>{let r=e.match(/(-*[\d.]+)\s*(\S*)/);if(r){let a=Number(r[1]);if(!a||isNaN(a)||a<0)return{};let i=r[2].toLowerCase()||t;if(i==="pt"||i==="em"||i==="%"||i==="px")return{font_size:{unit:i,value:a}}}return{}},RelativeFontSize:(e,t)=>{let r=12,a=12;switch(e.font_size?.unit){case"pt":if(!e.font_size.value)return 1;a=e.font_size.value;break;case"px":if(!e.font_size.value)return 1;a=Math.round(e.font_size.value*300/4)/100;break;case"em":return e.font_size.value||1;case"%":return(e.font_size.value||100)/100;default:return 1}switch(t.font_size?.unit){case"pt":if(!t.font_size.value)return 1;r=t.font_size.value;break;case"px":if(!t.font_size.value)return 1;r=Math.round(t.font_size.value*300/4)/100;break;default:return 1}return a/r},FontSize:(e,t=!0)=>{let r=e.font_size?.value;switch(e.font_size?.unit){case"pt":return(r||12)+"pt";case"px":return t?Math.round((r||16)*300/4)/100+"pt":(r||16)+"px";case"em":return(r||1)+"em";case"%":return(r||100)+"%"}return""},CompositeFontSize:(e,t,r=1,a=!1)=>{let i={...e};return t.unit==="pt"||t.unit==="px"?i={...t}:(i.value=t.value*e.value,t.unit==="%"&&(i.value/=100)),i.unit==="px"&&a&&(i.value=Math.round((i.value||16)*300/4)/100),i.value*=r,i},CompositeFont:(e,t,r,a)=>{let i,s,o,n=[];t.bold&&n.push("bold"),t.italic&&n.push("italic");let l=t.font_face||"stack:default";if(l.startsWith("stack:")){let h=a.font_stacks[l.substring(6)||"default"];h||(h=a.font_stacks.default),h&&(s=t.font_size,o=H.CompositeFontSize(h.size,t.font_size||{unit:"pt",value:10},r),n.push(o.value.toFixed(2)+o.unit),n.push(h.font||""),i=h.variants)}else o=H.CompositeFontSize(e,t.font_size||{unit:"pt",value:10},r),n.push(o.value.toFixed(2)+o.unit),n.push(l||"");return{font:n.join(" "),variants:i,base:e,size:t.font_size,scale:r,stack_size:s,font_size:o}}},Ui=e=>!!e&&Array.isArray(e)&&Array.isArray(e[0]),Y=(e,t)=>(typeof t>"u"&&(t=qe(e)),{value:e,type:t}),ve=e=>e.imaginary?{type:7,value:e}:{type:3,value:e.real},ee={Darken:(e,t,r,a,i=!1)=>{let{h:s,s:o,l:n}=ee.RGBToHSL(e,t,r);return i?n-=n*a/100:n-=a/100,n=Math.max(0,Math.min(1,n)),ee.HSLToRGB(s,o,n)},Lighten:(e,t,r,a,i=!1)=>{let{h:s,s:o,l:n}=ee.RGBToHSL(e,t,r);return i?n+=n*a/100:n+=a/100,n=Math.max(0,Math.min(1,n)),ee.HSLToRGB(s,o,n)},RGBToHSL:(e,t,r)=>{e/=255,t/=255,r/=255;let a=Math.max(e,t,r),i=Math.min(e,t,r),s=0,o=0,n=(a+i)/2;if(a===i)s=o=0;else{let l=a-i;switch(o=n>.5?l/(2-a-i):l/(a+i),a){case e:s=(t-r)/l+(t<r?6:0);break;case t:s=(r-e)/l+2;break;case r:s=(e-t)/l+4;break}s/=6}return{h:s*360,s:o,l:n}},HSLToRGB:(e,t,r)=>{let a,i,s;if(t===0)a=i=s=r;else{e=e/360;let o=r<.5?r*(1+t):r+t-r*t,n=2*r-o;a=ee.HueToRGB(n,o,e+.3333333333333333),i=ee.HueToRGB(n,o,e),s=ee.HueToRGB(n,o,e-.3333333333333333)}return{r:Math.round(a*255),g:Math.round(i*255),b:Math.round(s*255)}},HueToRGB:(e,t,r)=>(r<0&&(r+=1),r>1&&(r-=1),r<.16666666666666666?e+(t-e)*6*r:r<.5?t:r<.6666666666666666?e+(t-e)*(.6666666666666666-r)*6:e),GetLuminance:([e,t,r])=>{let a=[e,t,r].map(i=>(i/=255,i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)));return .2126*a[0]+.7152*a[1]+.0722*a[2]},WeightedLuminance:([e,t,r],a=[1,1,1])=>{let i=[e,t,r].map(s=>(s/=255,s<=.03928?s/12.92:Math.pow((s+.055)/1.055,2.4)));return .2126*i[0]*a[0]+.7152*i[1]*a[1]+.0722*i[2]*a[2]},GetContrastRatio:e=>(e.sort((t,r)=>r-t),(e[0]+.05)/(e[1]+.05)),GetTextColor:(e,t,r)=>{let a=[.4,.3,.3],i=ee.WeightedLuminance(e,a),s=ee.WeightedLuminance(t,a),o=ee.WeightedLuminance(r,a),n=ee.GetContrastRatio([s,i]),l=ee.GetContrastRatio([o,i]);return n>l?t:r}},io="http://www.w3.org/2000/svg",le=class Ii{static instances=[];static GetInstance(t){for(let a of this.instances)if(a.doc===t)return a;let r=new Ii(t);return this.instances.push(r),r}doc;view;get HTMLElement(){return this.view?.HTMLElement}constructor(t){t&&(this.doc=t,this.view=t?.defaultView)}GetSelection(){return this.view?.getSelection()}Div(t,r,a){return this.Create("div",t,r,a)}ClassNames(t,r){t.classList.add(...(Array.isArray(r)?r:[r]).reduce((a,i)=>[...a,...i.split(/\s+/g)],[]))}SVG(t,r,a){let i=this.doc.createElementNS(io,t);return r&&this.ClassNames(i,r),a&&a.appendChild(i),i}Text(t){return this.doc.createTextNode(t)}Fragment(){return this.doc.createDocumentFragment()}Create(t,r,a,i){let s=this.doc.createElement(t);if(r&&this.ClassNames(s,r),i){if(i.attrs)for(let[o,n]of Object.entries(i.attrs))s.setAttribute(o,n);if(i.data)for(let[o,n]of Object.entries(i.data))s.dataset[o]=n;if(i.text&&(s.textContent=i.text),i.html&&(s.innerHTML=i.html),i.events)for(let[o,n]of Object.entries(i.events))s.addEventListener(o,n);if(i.style)for(let[o,n]of Object.entries(i.style))s.style[o]=n}return a&&a.appendChild(s),s}},so=1e3,ut=class{constructor(e=!1,t){this.verbose=e,this.log_id=t}queue=[];dispatched=!1;subscribers=[];Publish(e){this.verbose&&console.info(`es publish (${this.log_id})`,e),Array.isArray(e)?this.queue.push(...e):this.queue.push(e),this.dispatched||(this.dispatched=!0,Promise.resolve().then(()=>{let t=this.queue.slice(0);this.dispatched=!1,this.queue=[];for(let r of t)for(let a of this.subscribers)a.subscriber(r)}))}Subscribe(e){let t=so++;return this.subscribers.push({subscriber:e,token:t}),t}Cancel(e){this.subscribers=this.subscribers.filter(t=>t.token!==e)}CancelAll(){this.subscribers=[]}},Ue=class{static color_measurement_canvas;static text_measurement_node;static color_cache={};static MeasureColorARGB(e){let t=this.MeasureColor(e),r="FF";for(let a=0;a<3;a++){let i=t[a].toString(16);i.length===0?r+="00":i.length===1?r+=`0${i}`:r+=i}return r.toUpperCase()}static MeasureColor(e){let t=this.color_cache[e];if(t)return t;this.color_measurement_canvas||(this.color_measurement_canvas=document.createElement("canvas"),this.color_measurement_canvas.width=1,this.color_measurement_canvas.height=1);let r=this.color_measurement_canvas.getContext("2d",{willReadFrequently:!0});return r?(r.fillStyle="#fff",r.fillRect(0,0,1,1),r.fillStyle=e,r.fillRect(0,0,1,1),t=new Uint8ClampedArray(r.getImageData(0,0,1,1).data),this.color_cache[e]=t,t):new Uint8ClampedArray(3)}static EnsureMeasurementNode(){if(!this.text_measurement_node){let e=document.querySelector(".treb-chart-measurement-node");e?this.text_measurement_node=e:(this.text_measurement_node=document.createElement("div"),this.text_measurement_node.classList.add("treb-chart-measurement-node"),this.text_measurement_node.style.margin="0px",this.text_measurement_node.style.padding="0px",this.text_measurement_node.style.height="initial",this.text_measurement_node.style.width="initial",this.text_measurement_node.style.whiteSpace="nowrap",this.text_measurement_node.style.position="fixed",this.text_measurement_node.style.border="0px",this.text_measurement_node.style.border="1px solid red",this.text_measurement_node.style.boxSizing="content-box",this.text_measurement_node.style.top=this.text_measurement_node.style.left="-1000px",document.body.appendChild(this.text_measurement_node))}}static FontLoaded(e,t=!1,r=400){let a=`${t?"italic":""} ${r} 20pt ${e}`,i=this.MeasureText(`${a}, sans-serif`,"check font"),s=this.MeasureText(`${a}, serif`,"check font"),o=this.MeasureText(`${a}, monospace`,"check font");return i.width===s.width&&s.width===o.width}static MeasureText(e,t,r=0){this.EnsureMeasurementNode(),this.text_measurement_node.style.font=e,/\n/.test(t)?(t=t.replace(/\n/g,"<BR/>"),this.text_measurement_node.innerHTML=t):this.text_measurement_node.textContent=t,this.text_measurement_node.style.lineHeight="1em",r?this.text_measurement_node.style.transform=`rotate(${r}deg)`:this.text_measurement_node.style.transform="";let a=this.text_measurement_node.getBoundingClientRect();return{width:a.width,height:a.height}}},yr,Vi=e=>{let t=new Map;for(let r=0;r<e.length;r++){let a=e[r];t.set(a,e.getPropertyValue(a))}return t},oo=(e,t,r)=>{let a=new Map,i=Vi(t);for(let[s,o]of i.entries())o!==r.get(s)&&a.set(s,o);return(Array.from(a.entries()).map(([s,o])=>`${s}: ${o}`).join("; ")+"; "+(e.getAttribute("style")||"")).trim().replace(/"/g,"'")},Oi=(e,t)=>{let r=e.cloneNode(!1),a=getComputedStyle(e),i=oo(e,a,t);r.removeAttribute("class"),r.setAttribute("style",i);let s;return Array.prototype.forEach.call(e.childNodes,o=>{switch(o.nodeType){case Node.ELEMENT_NODE:s||(s=Vi(a)),r.appendChild(Oi(o,s));break;case Node.TEXT_NODE:e.textContent&&r.appendChild(document.createTextNode(e.textContent));break;case Node.COMMENT_NODE:break;default:console.warn("unhandled node type in serialize",o)}}),r},no=e=>{if(!yr){let r=new Map,a=document.createElement("iframe");a.style.width="10px",a.style.height="10px",a.style.position="absolute",a.style.left="-100px",document.body.appendChild(a);let i=a.contentDocument;if(i){let s=i.createElement("div");i.body.appendChild(s);let o=getComputedStyle(s);Array.prototype.forEach.call(o,n=>r.set(n,o[n]))}document.body.removeChild(a),yr=r}let t=Oi(e,yr);return t instanceof Element&&t.tagName==="svg"&&(t.hasAttribute("version")||t.setAttribute("version","1.1"),t.hasAttribute("xmlns")||t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.hasAttribute("xmlns:xlink")||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),t},lo={data:!0,same_origin:!0,remote:!1},Hi=(e,t={})=>{let r={...lo,...t};try{let a=new URL(e,document.location.href);return a.protocol==="data:"?r.data?a.href:void 0:a.origin===document.location.origin?r.same_origin?a.href:void 0:r.remote?a.hash:void 0}catch(a){console.error(a)}},ar=(e,t,r=6.5,a=!1,i=!1)=>{if(t===e)t++,e&&e--;else{let c=Math.round(t*1e5)/1e5;Math.abs(c-t)/(t-e)<1e-5&&(t=c)}let s=t-e,o=Math.log(s)/Math.log(10),n=Math.floor(Math.abs(o))*(o<0?-1:1)-1;i&&(n=Math.max(0,n));let l=i?[1,2,5,10,15,20,25,50,100]:[.1,.25,.5,1,2.5,5,10,25,50,100],h=-1,d=0;for(let c of l){let u=c*Math.pow(10,n),m=Math.floor(e/u)*u,f=(Math.ceil(t/u)*u-m)/u,p=Math.abs(f-r);(h<0||p<d)&&(!a||f<=r)&&(d=p,h=u)}return e=Math.floor(e/h)*h,t=Math.ceil(t/h)*h,r=Math.round((t-e)/h),{scale:n,step:h,count:r,min:e,max:t}},At=class{date_format=!1;string_format=!1;fraction_format=!1;twelve_hour=!1;fraction_denominator=0;fraction_integer=!0;fraction_align=0;fraction_denominator_digits=0;integer_min_digits=0;decimal_min_digits=0;decimal_max_digits=0;grouping=!1;has_number_format=!1;prefix=[{text:""}];suffix=[{text:""}];scaling=0;percent=!1;exponential=!1;has_asterisk=!1},fa=42,pa=95,wr=63,It=48,ba=46,xr=44,ga=37,Cr=34,wt=35,_a=59,Vt=92,va=64,ho=91,co=93,ya=69,wa=101,uo=72,mo=104,fo=77,po=109,bo=83,go=115,_o=68,vo=100,yo=89,wo=121,xo=65,Co=97,ko=class{static date_pattern=!1;static pattern="";static char_index=0;static characters=[];static sections=[];static current_section=new At;static preserve_formatting_characters=!1;static decimal_mark=ba;static group_separator=xr;static Parse(e){if(this.pattern=e,this.characters=e.split("").map(t=>t.charCodeAt(0)),this.char_index=0,this.current_section=new At,this.sections=[this.current_section],this.ParseDatePattern())return this.sections;for(this.char_index=0,this.current_section=new At,this.sections=[this.current_section];this.char_index<this.characters.length;)this.ConsumeChar();return this.sections}static ConsumeString(){let e="";for(this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Vt:this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index+1<this.characters.length&&(e+=this.pattern[++this.char_index]);break;case Cr:return this.preserve_formatting_characters&&(e+=this.pattern[this.char_index]),this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated string")}static ConsumeFormatting(){let e="";for(++this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case Vt:throw new Error("invalid escape character in formatting block");case co:return this.char_index++,e;default:e+=this.pattern[this.char_index];break}throw new Error("unterminated format")}static ScanFractionFormat(){let e=/^([#?]+ +){0,1}([#?]+)\/([#?0-9]+)(?:$|[^#?0-9])/,t=this.pattern.substr(this.char_index).match(e);if(!t)return!1;let r=(t[1]||"").length+t[2].length+t[3].length+1;this.current_section.fraction_format=!0,this.current_section.fraction_integer=!!t[1];let a=Number(t[3]);return isNaN(a)||(this.current_section.fraction_denominator=a),this.current_section.decimal_max_digits=this.current_section.fraction_denominator_digits=t[3].length,this.char_index+=r,this.current_section.has_number_format=!0,!0}static ConsumeNumberFormat(){let e=0;for(this.char_index;this.char_index<this.characters.length;this.char_index++)switch(this.characters[this.char_index]){case this.group_separator:{let t=!1;for(let r=this.char_index+1;!t&&r<this.characters.length;r++){let a=this.characters[r];if(a===this.decimal_mark||a===wt||a===It)t=!0;else if(a!==xr)break}if(t){if(e===1)throw new Error("invalid grouping in decimal part");this.current_section.grouping=!0}else this.current_section.scaling=(this.current_section.scaling||1)*1e3}break;case this.decimal_mark:if(e===1)throw new Error("too many decimal marks");e=1;break;case wt:e===1?this.current_section.decimal_max_digits++:this.current_section.integer_min_digits&&this.current_section.integer_min_digits++;break;case It:e===1?(this.current_section.decimal_max_digits++,this.current_section.decimal_min_digits=this.current_section.decimal_max_digits):this.current_section.integer_min_digits++;break;default:return}}static AppendCharAsText(e=!0){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=this.pattern[this.char_index]:this.current_section.prefix[this.current_section.prefix.length-1].text+=this.pattern[this.char_index],e&&this.char_index++}static AppendString(e){this.current_section.has_number_format?this.current_section.suffix[this.current_section.suffix.length-1].text+=e:this.current_section.prefix[this.current_section.prefix.length-1].text+=e}static AppendTextPart(e){this.current_section.has_number_format?(this.current_section.suffix.push(e),this.current_section.suffix.push({text:""})):(this.current_section.prefix.push(e),this.current_section.prefix.push({text:""}))}static ConsumeChar(){let e=this.characters[this.char_index];if(!((e===wr||e===wt)&&!this.current_section.has_number_format&&!this.current_section.string_format&&this.ScanFractionFormat()))switch(e){case _a:this.char_index++,this.current_section=new At,this.sections.length===3&&(this.current_section.string_format=!0),this.sections.push(this.current_section);break;case va:this.char_index++,this.AppendTextPart({text:"@",flag:5}),this.current_section.string_format=!0;break;case It:case wt:case ba:case xr:!this.current_section.has_number_format&&!this.current_section.string_format?(this.ConsumeNumberFormat(),this.current_section.has_number_format=!0):this.AppendCharAsText();break;case ho:this.AppendTextPart({text:this.ConsumeFormatting(),flag:6});break;case Cr:this.AppendString(this.ConsumeString());break;case wr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case pa:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case fa:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case wa:case ya:this.current_section.percent||this.current_section.exponential||this.current_section.string_format?this.AppendCharAsText():(this.current_section.exponential=!0,this.char_index++);break;case ga:!this.current_section.exponential&&!this.current_section.string_format&&(this.current_section.percent=!0),this.AppendCharAsText();break;case Vt:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}static ParseDatePattern(){for(this.date_pattern=!0;this.date_pattern&&this.char_index<this.pattern.length;)this.DatePatternConsumeChar();if(this.date_pattern){this.date_pattern=!1;for(let e of this.sections)for(let t of e.prefix)t.flag&&t.flag&7&&(this.date_pattern=!0)}return this.date_pattern&&(this.sections[0].date_format=!0,this.sections[0].prefix.forEach((e,t)=>{if(e.flag===3&&(e.text==="mm"||e.text==="m")){if(t)for(let r=t-1;r;r--){let a=this.sections[0].prefix[r];if(a.flag===3){/h/i.test(a.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}if(t<this.sections[0].prefix.length-1)for(let r=t+1;r<this.sections[0].prefix.length;r++){let a=this.sections[0].prefix[r];if(a.flag===3){/s/i.test(a.text)&&(e.flag=4,e.text=e.text.toLowerCase());break}}}})),this.date_pattern}static ConsumeDatePart(){let e=this.pattern[this.char_index++],t=e.toLowerCase(),r={text:e,flag:3};for(;this.pattern[this.char_index]&&this.pattern[this.char_index].toLowerCase()===t;)r.text+=this.pattern[this.char_index++];if(t==="s"&&this.pattern[this.char_index]===".")for(r.text+=this.pattern[this.char_index++];this.pattern[this.char_index]==="0";)r.text+=this.pattern[this.char_index++];return r}static ConsumeAMPM(){let e=this.pattern.substr(this.char_index,5);if(e==="am/pm"||e==="AM/PM")return this.char_index+=5,this.sections[0].twelve_hour=!0,{text:e,flag:3};if(e=this.pattern.substr(this.char_index,3),e==="a/p"||e==="A/P")return this.char_index+=3,this.sections[0].twelve_hour=!0,{text:e,flag:3}}static DatePatternConsumeChar(){switch(this.characters[this.char_index]){case _a:this.char_index=this.characters.length;break;case It:case wt:case wa:case ya:case ga:case va:this.date_pattern=!1;break;case uo:case mo:case fo:case po:case bo:case go:case _o:case vo:case yo:case wo:this.AppendTextPart(this.ConsumeDatePart());break;case xo:case Co:{let e=this.ConsumeAMPM();e?this.AppendTextPart(e):this.AppendCharAsText()}break;case Cr:this.AppendString(this.ConsumeString());break;case wr:this.preserve_formatting_characters?this.AppendCharAsText():(this.AppendTextPart({text:"0",flag:1}),this.char_index++);break;case pa:if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:1})}break;case fa:if(this.current_section.has_asterisk)throw new Error("we don't support multiple asterisks");if(this.preserve_formatting_characters)this.AppendCharAsText();else{if(++this.char_index>=this.characters.length)throw new Error("invalid pad character at end");this.AppendTextPart({text:this.pattern[this.char_index++],flag:2}),this.current_section.has_asterisk=!0}break;case Vt:if(this.preserve_formatting_characters&&this.AppendCharAsText(!1),++this.char_index>=this.characters.length)throw new Error("invalid escape character at end");this.AppendCharAsText();break;default:this.AppendCharAsText()}}},et=e=>(e>=60&&e--,new Date(-22090752e5+864e5*e)),Qe=(e,t=!0)=>{if(t){let r=new Date(e);e=new Date(r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds(),r.getMilliseconds()).getTime()}return e=(e+22090752e5)/864e5,e>=60&&e++,e},Ie=class $e{static grouping_regexp=/\d{1,3}(?=(\d{3})+(?!\d))/g;static fraction_limits=[9,99,999,9999];static imaginary_character="𝑖";static minus_character="-";magic_decimal=!1;transform_value;_pattern="";sections;decimal_zero_regexp=[];cloned=[];get pattern(){return this._pattern}get date_format(){return this.sections[0]&&this.sections[0].date_format}constructor(t){if(this._pattern=t,this.sections=ko.Parse(t),this.sections.length||(this.sections=[]),this.sections[0]||(this.sections[0]=new At),this.sections[1]||(this.sections[1]={...this.sections[0]},this.sections[1].prefix=JSON.parse(JSON.stringify(this.sections[1].prefix)),this.sections[1].suffix=JSON.parse(JSON.stringify(this.sections[1].suffix)),this.sections[1].prefix.push({text:"-"}),this.cloned[1]=!0),this.sections[2]||(this.sections[2]={...this.sections[0]},this.cloned[2]=!0),!this.sections[3]){for(let r of this.sections[0].prefix)if(r.flag===5){this.sections[3]={...this.sections[0]},this.sections[3].string_format=!0,this.cloned[3]=!0;break}}this.decimal_zero_regexp=this.sections.map(r=>{if(r.decimal_max_digits>r.decimal_min_digits)return new RegExp(`0{1,${r.decimal_max_digits-r.decimal_min_digits}}(?:$|e)`)})}static FormatPartsAsText(t,r=0){let a=-1,i=t.map((s,o)=>{switch(s.flag){case 2:return a=o,s.text;case 1:return s.text.replace(/./g," ");case 6:return"";default:return s.text}});if(a>=0&&r){let s=i.reduce((n,l,h)=>h===a?n:n+l.length,0),o="";for(let n=0;n<r-s;n++)o+=i[a];i[a]=o}return i.join("")}SetDecimal(t){for(let r of this.sections)r.fraction_format||(r.decimal_min_digits=t,r.decimal_max_digits=t)}IncreaseDecimal(){this.sections.forEach(t=>{t.fraction_format?t.fraction_denominator||(t.fraction_denominator_digits=Math.min(t.fraction_denominator_digits+1,4)):(t.decimal_min_digits++,t.decimal_max_digits=t.decimal_min_digits)})}DecreaseDecimal(){this.sections.forEach(t=>{t.fraction_format?t.fraction_denominator||(t.fraction_denominator_digits=Math.max(t.fraction_denominator_digits-1,1)):(t.decimal_min_digits=Math.max(0,t.decimal_min_digits-1),t.decimal_max_digits=t.decimal_min_digits)})}AddGrouping(){this.sections.forEach(t=>{t.grouping=!0})}RemoveGrouping(){this.sections.forEach(t=>{t.grouping=!1})}ToggleGrouping(){let t=!this.sections[0].grouping;this.sections.forEach(r=>{r.grouping=t})}toString(){return this.sections[0].date_format?this._pattern:this.sections.filter((t,r)=>!this.cloned[r]).map(t=>{let r="",a=0;if(t.fraction_format){t.fraction_integer&&(r+="? ");let i="";for(let s=0;s<t.fraction_denominator_digits;s++)i+="#";r+=i,r+="/",t.fraction_denominator?r+=t.fraction_denominator:r+=i}else if(t.has_number_format){for(a=0;a<t.integer_min_digits;a++)r+="0";if(t.grouping&&(r.length<4&&(r=("####"+r).slice(-4)),r=r.replace(/[\d#]{1,3}(?=([\d#]{3})+(?![\d#]))/g,"$&,")),t.decimal_max_digits||t.decimal_min_digits){for(r+=".",a=0;a<t.decimal_min_digits;a++)r+="0";for(;a<t.decimal_max_digits;a++)r+="#"}if(t.scaling){let i=Math.log10(t.scaling)/3;for(a=0;a<i;a++)r+=","}t.exponential&&(r+="e")}return t.prefix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.flag===6?"["+i.text+"]":i.text).join("")+r+t.suffix.map(i=>i.flag===1?i.text==="0"?"?":"_"+i.text:i.flag===2?"*"+i.text:i.text).join("")}).join(";")}FormatDimensionedQuantity(t){if(this.transform_value){let a=this.transform_value(t);if(Ei(a))t=a;else return typeof a=="string"?a:this.FormatParts(a)}let r=this.FormatParts(t.value||0);return t.unit&&r.push({text:" "},{text:t.unit}),r}FormatComplex(t){if(t.imaginary===1/0||t.imaginary===-1/0||t.real===1/0||t.real===-1/0)return[{text:"Infinity"}];let r=[],a=[],i=!1,s=!!t.imaginary;s&&(r=this.FormatParts(t.imaginary),s=r.some(l=>/[1-9]/.test(l.text)),r.length===1&&this.sections[0].integer_min_digits<=1&&r[0].text==="1"?(r[0].text="",i=!0):r.length===1&&this.sections[1].integer_min_digits<=1&&r[0].text==="-1"&&(r[0].text="-",i=!0));let o=!!t.real;o&&(a=this.FormatParts(t.real),o=a.some(l=>/[1-9]/.test(l.text)));let n=[];if(o||!o&&!s){if(n.push(...a),s){n.push({text:t.imaginary<0?` ${$e.minus_character} `:" + "});let l=i?[]:this.FormatParts(Math.abs(t.imaginary));n.push(...l,{text:$e.imaginary_character})}}else s&&n.push(...r,{text:$e.imaginary_character});return n}FormatParts(t){if(typeof t!="number"&&!this.sections[3])return[{text:(t??"").toString()}];let{parts:r,section:a}=this.BaseFormat(t),i=[];if(a.date_format||a.string_format)for(let s of r)typeof s=="string"?i.push({text:s}):i.push(s);else this.magic_decimal&&r[1]===""&&r.splice(1,1),i=[...a.prefix.map(s=>({...s})),{text:a.has_number_format?r.join(G.decimal_separator):""},...a.suffix.map(s=>({...s}))];for(let s=1;s<i.length;s++)i[s].flag===i[s-1].flag&&(i[s].text=i[s-1].text+i[s].text,i[s-1].text="");return i.filter(s=>s.text)}Format(t,r=0){return $e.FormatPartsAsText(this.FormatParts(t),r)}ZeroPad(t,r){for(;t.length<r;)t="0"+t;return t}DateFormat(t){let r=et(t),a=this.sections[0],i=r.getUTCHours();return a.twelve_hour&&(i>12&&(i-=12),i===0&&(i=12)),{parts:a.prefix.map(s=>{if(s.flag===4)return s.text==="mm"?{text:this.ZeroPad(r.getUTCMinutes().toString(),2)}:{text:this.ZeroPad(r.getUTCMinutes().toString(),1)};if(s.flag===3){switch(s.text.toLowerCase()){case"am/pm":case"a/p":{let n=s.text.split("/");return{text:r.getUTCHours()>12?n[1]:n[0]}}case"mmmmm":return{text:G.date_components.long_months[r.getUTCMonth()][0]};case"mmmm":return s.text==="MMMM"?{text:G.date_components.long_months[r.getUTCMonth()].toUpperCase()}:{text:G.date_components.long_months[r.getUTCMonth()]};case"mmm":return s.text==="MMM"?{text:G.date_components.short_months[r.getUTCMonth()].toUpperCase()}:{text:G.date_components.short_months[r.getUTCMonth()]};case"mm":return{text:this.ZeroPad((r.getUTCMonth()+1).toString(),2)};case"m":return{text:this.ZeroPad((r.getUTCMonth()+1).toString(),1)};case"ddddd":case"dddd":return s.text==="DDDDD"||s.text==="DDDD"?{text:G.date_components.long_days[r.getUTCDay()].toUpperCase()}:{text:G.date_components.long_days[r.getUTCDay()]};case"ddd":return s.text==="DDD"?{text:G.date_components.short_days[r.getUTCDay()].toUpperCase()}:{text:G.date_components.short_days[r.getUTCDay()]};case"dd":return{text:this.ZeroPad(r.getUTCDate().toString(),2)};case"d":return{text:this.ZeroPad(r.getUTCDate().toString(),1)};case"yyyy":case"yyy":return{text:r.getUTCFullYear().toString()};case"yy":case"y":return{text:this.ZeroPad((r.getUTCFullYear()%100).toString(),2)};case"hh":return{text:this.ZeroPad(i.toString(),2)};case"h":return{text:this.ZeroPad(i.toString(),1)};case"ss":return{text:this.ZeroPad(r.getUTCSeconds().toString(),2)};case"s":return{text:this.ZeroPad(r.getUTCSeconds().toString(),1)}}let o=s.text.match(/^(s+)\.(0+)$/);if(o)return{text:this.ZeroPad(r.getUTCSeconds().toString(),o[1].length)+G.decimal_separator+(r.getUTCMilliseconds()/1e3).toFixed(o[2].length).substr(2)}}return{...s}}),section:a}}StringFormat(t,r){let a=[];for(let i of r.prefix)i.flag===5?a.push({text:t}):a.push({...i});return{parts:a,section:r}}Round2(t,r){let a=Math.pow(10,r);return Math.round(a*t)/a}FormatFraction(t,r){r.percent&&(t*=100);let a={denominator:1,numerator:Math.round(t),error:Math.abs(Math.round(t)-t)};if(r.fraction_denominator)a.denominator=r.fraction_denominator,a.numerator=Math.round(t*a.denominator);else if(a.error){let s=$e.fraction_limits[r.fraction_denominator_digits-1]||$e.fraction_limits[0];for(let o=2;o<=s;o++){let n=Math.round(t*o),l=Math.abs(n/o-t);if(l<a.error&&(a={numerator:n,denominator:o,error:l},!l))break}}let i=[];if(r.fraction_integer){let s=Math.floor(a.numerator/a.denominator);a.numerator%=a.denominator,(s||!a.numerator)&&(i.push(s.toString()),a.numerator&&i.push(" "))}else a.numerator||i.push("0");return a.numerator&&(i.push(a.numerator.toString()),i.push("/"),i.push(a.denominator.toString())),i.join("")}BaseFormat(t){if(this.sections[0].date_format)return this.DateFormat(Number(t));if(typeof t!="number")return this.StringFormat((t??"").toString(),this.sections[3]);let r=this.sections[0],a=this.decimal_zero_regexp[0];t<0&&(r=this.sections[1]);let i=r.percent?r.decimal_max_digits+2:r.decimal_max_digits,s=Math.pow(10,-i)/2,o=Math.abs(t);if(o<s&&(r=this.sections[2],a=this.decimal_zero_regexp[2]),r.scaling&&(o/=r.scaling,o<s&&(r=this.sections[2],a=this.decimal_zero_regexp[2])),r.string_format)return this.StringFormat(t.toString(),r);let n="";if(r.fraction_format)return{parts:[this.FormatFraction(o,r)],section:r};r.exponential?n=o.toExponential(r.decimal_max_digits):(r.percent&&(o*=100),n=this.Round2(o,r.decimal_max_digits).toFixed(r.decimal_max_digits)),a&&(n=n.replace(a,""));let l=n.split(".");for(;l[0].length<r.integer_min_digits;)l[0]=("0000000000000000"+l[0]).slice(-r.integer_min_digits);return r.integer_min_digits===0&&l[0]==="0"&&(l[0]=""),r.grouping&&(l[0]=l[0].replace($e.grouping_regexp,"$&"+G.grouping_separator)),{parts:l,section:r}}},V=class{static cache={};static complex_general;static symbolc_name_map={};static base_formats={Accounting:"_(#,##0.00_);(#,##0.00);-???",Number:"0.00",Integer:"0",Percent:"0.00%",General:"0.######",Fraction:"# ?/?",Dollar:"$* _(#,##0.00_);$* (#,##0.00);$* -???",Exponential:"0.000e","Short Date":"mm/dd/yy","Long Date":"dddd, mmm d yyyy",Timestamp:"mm-dd-yy hh:mm:ss"};static aliases={Scientific:"Exponential",Percentage:"Percent",Currency:"Dollar"};static Get(e,t=!1){if(t&&e==="General")return this.complex_general;let r=this.symbolc_name_map[e.toLowerCase()],a=this.cache[r||e];return a||(a=new Ie(e),this.cache[e]=a),a}static Equals(e,t){if(e===t)return!0;let r=this.Get(e),a=this.Get(t);return r.pattern===a.pattern}static Translate(e){let t=this.symbolc_name_map[e.toLowerCase()];return t?this.cache[t].toString():e}static SymbolicName(e){for(let t of Object.keys(this.base_formats))if(e===this.base_formats[t])return t;return null}static InitCache(){for(let e of Object.keys(this.base_formats))this.cache[e]=new Ie(this.base_formats[e]),this.symbolc_name_map[e.toLowerCase()]=e;this.cache.General.magic_decimal=!0,this.complex_general=new Ie("0.###"),this.complex_general.magic_decimal=!0;for(let e of Object.keys(this.aliases))this.cache[e]=this.cache[this.aliases[e]],this.symbolc_name_map[e.toLowerCase()]=e}};V.InitCache();var xa=new Date().getUTCFullYear(),So=class{compare_day;compare_month;TestDate(e){let t=Date.parse(e);if(isNaN(t))return!1;let r=new Date(t),a=e.replace(/[\d\-\\/,.\s]+/g," ").toLocaleLowerCase().split(/\s+/).map(o=>o.trim()).filter(o=>!!o);if(!a.length)return t;if(!this.compare_month){this.compare_month={};for(let o=0;o<12;o++)this.compare_month[G.date_components.long_months[o].toLocaleLowerCase().replace(/\./,"")]=o,this.compare_month[G.date_components.short_months[o].toLocaleLowerCase().replace(/\./,"")]=o}if(!this.compare_day){this.compare_day={};for(let o=0;o<7;o++)this.compare_day[G.date_components.long_days[o].toLocaleLowerCase().replace(/\./,"")]=o,this.compare_day[G.date_components.short_days[o].toLocaleLowerCase().replace(/\./,"")]=o}let i=!1,s=!1;for(let o of a){let n=!1;for(let[l,h]of Object.entries(this.compare_month))if(o===l){if(i||r.getUTCMonth()!==h)return!1;n=!0,i=!0}if(!n){for(let[l,h]of Object.entries(this.compare_day))if(o===l){if(s||r.getUTCDay()!==h)return!1;n=!0,s=!0}}if(!n)return!1}return s&&!i?!1:t}TryParse(e=""){let t={};if(e[0]==="'")return{value:e,type:2};if(e==="")return{value:e,type:2};if(e==="NaN")return{value:NaN,type:3,hints:{Nan:!0}};let r=e.trim(),a=r.match(/^[$](.*?)$/);a&&(r=a[1],t.Currency=!0);let i=r.match(/^\((.*?)\)$/);i&&(r=i[1],t.Parens=!0);let s=r.match(/^(.*?)%\s*$/);s&&(r=s[1],t.Percent=!0),G.decimal_separator==="."?/,/.test(r)&&(r=r.replace(/,/g,""),t.Grouping=!0):(r=r.replace(/(\d)\s+/g,"$1"),r=r.replace(/\./g,""),r=r.replace(/,/,"."));let o=Number(r);if(o===null||isNaN(o)){let n=e.toLowerCase();if(n==="false")return{value:!1,type:4};if(n==="true")return{value:!0,type:4};let l=this.TestDate(e);if(l!==!1&&!isNaN(l)){let h=new Date(l),d=h.getUTCFullYear();if(d>=xa-200&&d<=xa+200)return t={Date:!0},(h.getHours()||h.getMinutes()||h.getSeconds())&&(t.Time=!0),{value:Qe(l,!0),type:3,hints:t}}return{value:e,type:2}}if(i&&(o=-o),s){let n=o<0?-1:1,l=(n*o).toString().split(".");l[0]=("00"+l[0]).replace(/(\d\d)$/,".$1"),o=Number(l.join(""))*n}return/e/.test(e)&&(t.Exponential=!0),{value:o,type:3,hints:t}}},rt=new So,Mo=class{constructor(e,t,r={x:0,y:0},a){this.theme=t,this.offset=r;let i=le.GetInstance(a.ownerDocument);this.g=i.SVG("g"),this.g.setAttribute("transform",`translate(${r.x}, ${r.y})`),this.outline=i.SVG("rect","treb-selection-outline"),e?(this.g.setAttribute("class","selection primary-selection"),this.fill=i.SVG("path","treb-selection-fill"),this.nub=i.SVG("rect","treb-selection-nub"),this.g.appendChild(this.fill),this.g.appendChild(this.outline),this.g.appendChild(this.nub)):(this.g.setAttribute("class","selection alternate-selection"),this.fill=i.SVG("rect","treb-selection-fill"),this.g.appendChild(this.fill),this.g.appendChild(this.outline))}g;outline;fill;nub;Offset(e){this.g.setAttribute("transform",`translate(${e.x}, ${e.y})`)}Show(e=!0){this.g.style.display=e?"block":"none"}SetOutline(e,t=!1){this.outline.setAttribute("x",(e.left-1).toString()),this.outline.setAttribute("y",(e.top-1).toString()),this.outline.setAttribute("width",(e.width+1).toString()),this.outline.setAttribute("height",(e.height+1).toString()),t&&this.fill&&(this.fill.setAttribute("x",e.left.toString()),this.fill.setAttribute("y",e.top.toString()),this.fill.setAttribute("width",e.width.toString()),this.fill.setAttribute("height",e.height.toString()))}SetFill(e,t){if(!this.fill)return;let r=[];r.push("M"+e.left+" "+e.top),r.push("L"+e.left+" "+e.bottom),r.push("L"+e.right+" "+e.bottom),r.push("L"+e.right+" "+e.top),r.push("Z"),r.push("M"+t.left+" "+t.top),r.push("L"+t.right+" "+t.top),r.push("L"+t.right+" "+t.bottom),r.push("L"+t.left+" "+t.bottom),r.push("Z"),this.fill.setAttribute("d",r.join(" "))}SetNub(e){this.nub&&(this.nub.setAttribute("x",(e.left+e.width-4).toString()),this.nub.setAttribute("y",(e.top+e.height-4).toString()),this.nub.setAttribute("width","7"),this.nub.setAttribute("height","7"))}},Ot=class{constructor(e,t,r){this.theme=e,this.container=t,this.orientation=r;let a=le.GetInstance(t.ownerDocument);this.g=a.SVG("g","treb-header-overlay"),this.overlay=a.SVG("rect","treb-overlay"),this.highlight=a.SVG("rect","treb-highlight"),this.g.style.display="none",this.g.appendChild(this.highlight),this.g.appendChild(this.overlay),t.appendChild(this.g)}g;overlay;highlight;Remove(){this.container.removeChild(this.g)}Hide(){this.g.style.display="none"}Show(e,t,r,a){this.overlay.setAttribute("x",e.toString()),this.overlay.setAttribute("y",t.toString()),this.overlay.setAttribute("width",r.toString()),this.overlay.setAttribute("height",a.toString()),this.orientation===0?(this.highlight.setAttribute("x",e.toString()),this.highlight.setAttribute("y",(t+a-2).toString()),this.highlight.setAttribute("width",r.toString()),this.highlight.setAttribute("height","2")):(this.highlight.setAttribute("x",(e+r-2).toString()),this.highlight.setAttribute("y",t.toString()),this.highlight.setAttribute("width","2"),this.highlight.setAttribute("height",a.toString())),this.g.style.display="block"}},Ao=class{constructor(e,t,r,a,i,s){this.theme=e,this.layout=t,this.model=r,this.view=a,this.primary_selection=i,this.additional_selections=s}nub_rectangle=new ie(-1,-1,0,0);cached_additional_selections="";grid_selections=[];row_header_selections=[];column_header_selections=[];corner_selections=[];row_overlay;column_overlay;corner_row_overlay;corner_column_overlay;Initialize(){this.row_overlay=new Ot(this.theme,this.layout.row_header_selection,0),this.column_overlay=new Ot(this.theme,this.layout.column_header_selection,1),this.corner_row_overlay=new Ot(this.theme,this.layout.corner_selection,0),this.corner_column_overlay=new Ot(this.theme,this.layout.corner_selection,1)}RenderSelections(e=!0,t=!0){let r=this.primary_selection.empty;e||(this.primary_selection.empty=!0);let a=[this.primary_selection].concat(this.additional_selections);this.RenderSelectionGroup(a,this.layout.grid_selection,void 0,void 0,this.grid_selections,void 0,t);let i=new ie(-1,-1,0,0);if(!this.primary_selection.empty){let n=this.view.active_sheet.RealArea(this.primary_selection.area);i=this.layout.CellAddressToRectangle(n.start).Combine(this.layout.CellAddressToRectangle(n.end))}if(!this.primary_selection.empty&&this.layout.header_offset.y>2?(this.row_overlay.Show(i.left,0,i.width,this.layout.header_offset.y),this.corner_row_overlay.Show(i.left+this.layout.header_offset.x,0,i.width,this.layout.header_offset.y)):(this.row_overlay.Hide(),this.corner_row_overlay.Hide()),!this.primary_selection.empty&&this.layout.header_offset.x>2?(this.column_overlay.Show(0,i.top,this.layout.header_offset.x,i.height),this.corner_column_overlay.Show(0,i.top+this.layout.header_offset.y,this.layout.header_offset.x,i.height)):(this.column_overlay.Hide(),this.corner_column_overlay.Hide()),!this.view.active_sheet.freeze.columns&&!this.view.active_sheet.freeze.rows){this.primary_selection.empty=r;return}let s=[],o=[];if(this.primary_selection.empty)s.push(!1),o.push(!1);else{let n=this.primary_selection.area.start;s.push(n.row<=this.view.active_sheet.freeze.rows||n.row===1/0),o.push(n.column<=this.view.active_sheet.freeze.columns||n.column===1/0)}for(let{area:n}of this.additional_selections)s.push(n.start.row<=this.view.active_sheet.freeze.rows||n.start.row===1/0),o.push(n.start.column<=this.view.active_sheet.freeze.columns||n.start.column===1/0);this.view.active_sheet.freeze.rows&&this.RenderSelectionGroup(a,this.layout.row_header_selection,s,void 0,this.row_header_selections,{x:0,y:this.layout.header_offset.y}),this.view.active_sheet.freeze.columns&&this.RenderSelectionGroup(a,this.layout.column_header_selection,o,void 0,this.column_header_selections,{x:this.layout.header_offset.x,y:0}),this.view.active_sheet.freeze.rows&&this.view.active_sheet.freeze.columns&&this.RenderSelectionGroup(a,this.layout.corner_selection,o,s,this.corner_selections,{...this.layout.header_offset}),this.primary_selection.empty=r}RenderSelectionGroup(e,t,r,a,i,s,o=!0){for(let n=0;n<e.length;n++)if((!e[n].area.start.sheet_id||e[n].area.start.sheet_id===this.view.active_sheet.id)&&!e[n].empty&&(!r||r[n])&&(!a||a[n])){if(o||!e[n].rendered){let l=this.EnsureGridSelectionBlock(t,i,n,s);this.RenderSVGSelection(e[n],l,n)}}else i[n]&&i[n].Show(!1);for(let n=e.length;n<i.length;n++)i[n]&&i[n].Show(!1)}EnsureGridSelectionBlock(e,t,r,a){let i=t[r];if(!i)if(i=new Mo(!r,this.theme,void 0,e),t[r]=i,r){let s=e.querySelector(".alternate-selections");s||(s=this.layout.DOM.SVG("g","alternate-selections"),e.appendChild(s)),s?.appendChild(i.g)}else e.appendChild(i.g);return a&&i.Offset(a),i}ClampEnd(e){return{row:Math.min(e.row,this.view.active_sheet.rows-1),column:Math.min(e.column,this.view.active_sheet.columns-1)}}RenderSVGSelection(e,t,r=0){let a=this.view.active_sheet.RealArea(e.area,!0),i=this.layout.CellAddressToRectangle(a.start);if(a.count>1)i=i.Combine(this.layout.CellAddressToRectangle(a.end));else if(r){let s=this.view.active_sheet.CellData(e.target);s.merge_area&&(i=this.layout.CellAddressToRectangle(s.merge_area.start),i=i.Combine(this.layout.CellAddressToRectangle(s.merge_area.end)))}if(r||(this.nub_rectangle=new ie(i.left+i.width-6,i.top+i.height-6,11,11)),i.top===0&&this.layout.header_offset.y<=1&&(i.top=1,i.height-=1),i.left===0&&this.layout.header_offset.x<=1&&(i.left=1,i.width-=1),i.height<=0||i.height<=0){t.Show(!1);return}if(t.SetOutline(i,!!r),r)e.rendered=!0;else{let s=this.layout.CellAddressToRectangle(e.target),o=this.view.active_sheet.CellData(e.target);o.merge_area&&(s=this.layout.CellAddressToRectangle(o.merge_area.start),s=s.Combine(this.layout.CellAddressToRectangle(o.merge_area.end))),t.SetFill(s,i),t.SetNub(i)}t.Show()}};function Be(e,t=[],r,a){typeof t=="string"&&(t=[t]);let i,s=n=>{n.stopPropagation(),n.preventDefault(),i(),a&&a(n)},o=n=>{if(n.stopPropagation(),n.preventDefault(),!n.buttons){i(),a&&a(n);return}r&&r(n)};i=()=>{e.style.display="none",e.removeEventListener("mousemove",o),e.removeEventListener("mouseup",s);for(let n of t)e.classList.remove(n)};for(let n of t)e.classList.add(n);e.style.display="block",r&&e.addEventListener("mousemove",o),a&&e.addEventListener("mouseup",s)}var Ro=class extends ut{constructor(e){super(),this.container=e,this.format=V.Get("0.0");let t=le.GetInstance(e.ownerDocument);this.input=t.Create("input","treb-scale-input",e,{events:{keypress:a=>{switch(a.key){case"ArrowUp":case"ArrowDown":a.stopPropagation(),a.preventDefault(),console.info("mark?");break}},keydown:a=>{switch(a.key){case"Enter":this.input.blur();break;case"ArrowUp":this.Tick(-1);break;case"ArrowDown":this.Tick(1);break;case"Escape":this.input.value=this.format.Format(this.scale)+"%",this.input.blur();break;default:return}a.stopPropagation(),a.preventDefault()},focusin:()=>this.input.select(),change:()=>{let a=this.input.value;a=a.replace(/%/g,"");let i=rt.TryParse(a);i.type===3?this.UpdateScale(Number(i.value),!0):this.input.value=this.format.Format(this.scale)+"%"}}});let r=t.Div("treb-slider-container",e);this.slider=t.Create("input",void 0,r,{attrs:{type:"range",min:"50",max:"200",value:"100",step:"2.5"},events:{input:()=>this.UpdateScale(Number(this.slider.value),!0)}}),e.addEventListener("wheel",a=>{a.stopPropagation(),a.preventDefault(),this.Tick(a.deltaY)})}input;slider;scale=0;format;timeout=0;Tick(e){let t=Math.round(this.scale/2.5)*2.5;e>0?this.UpdateScale(t-2.5,!0,!0):e<0&&this.UpdateScale(t+2.5,!0,!0)}UpdateScale(e,t=!1,r=!1){e=Math.max(50,Math.min(200,e)),e!==this.scale&&(this.scale=e,this.input.value=this.format.Format(e)+"%",this.slider.value=e.toFixed(1),t&&(this.timeout||(this.timeout=requestAnimationFrame(()=>{this.timeout=0,this.Publish({type:"scale",value:this.scale/100,keep_focus:r})}))))}},zo=class extends ut{constructor(e,t,r,a,i,s){if(super(),this.layout=e,this.model=t,this.view=r,this.options=a,this.theme=i,this.DOM=le.GetInstance(s.ownerDocument),this.container=s.querySelector(".treb-spreadsheet-footer"),!this.container)throw new Error("missing container for tab bar");if(a.tab_bar!=="auto"&&this.container.removeAttribute("hidden"),this.tab_container=this.container.querySelector(".treb-spreadsheet-tabs"),this.container.addEventListener("click",o=>{let n=o.target?.dataset.command;if(n)switch(o.stopPropagation(),o.preventDefault(),n){case"add-tab":this.Publish({type:"add-sheet"});break;case"delete-tab":this.Publish({type:"delete-sheet"});break;default:console.info("unhandled command",n)}}),this.options.stats&&(this.stats_panel=this.container.querySelector(".treb-stats-panel")),this.options.scale_control){let o=this.container.querySelector(".treb-scale-control");this.scale_control=new Ro(o),this.scale_control.Subscribe(n=>{this.Publish(n)}),this.UpdateScale(this.options.initial_scale||1)}}tab_container;scale_control;stats_panel;dragging=!1;double_click_data={};tab_color_cache=new Map;_visible=!1;get visible(){return this._visible}set stats_data(e){if(this.stats_panel){this.stats_panel.innerText="";for(let t of e)this.DOM.Create("span","treb-stats-label",this.stats_panel,{text:t.label}),this.DOM.Create("span","treb-stats-value",this.stats_panel,{text:t.value})}}container;DOM;IsDoubleClick(e,t=300){return this.double_click_data.index===e?(clearTimeout(this.double_click_data.timeout),this.double_click_data.index=void 0,this.double_click_data.timeout=void 0,!0):(this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.index=e,this.double_click_data.timeout=window.setTimeout(()=>{this.double_click_data.index=void 0,this.double_click_data.timeout=void 0},t),!1)}Hide(){this.Show(!1)}Show(e=!0){this.container&&(this._visible=e,e?this.container.removeAttribute("hidden"):this.container.setAttribute("hidden",""))}SetActive(e,t){t?(e.setAttribute("selected",""),e.dataset.background_color&&(e.style.backgroundColor=`color-mix(in srgb, ${e.dataset.background_color} 20%, var(--treb-tab-bar-active-tab-background, #fff))`,e.style.color=""),requestAnimationFrame(()=>{e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})})):(e.removeAttribute("selected"),e.dataset.background_color&&(e.style.backgroundColor=e.dataset.background_color),e.dataset.foreground_color&&(e.style.color=e.dataset.foreground_color))}UpdateScale(e){this.scale_control?.UpdateScale(e*100)}DoubleClickTab(e,t,r){if(t.contentEditable="true",this.DOM.doc){let a=this.DOM.GetSelection();if(a){a.removeAllRanges();let i=this.DOM.doc.createRange();i.selectNodeContents(t),a.addRange(i)}}t.addEventListener("keydown",a=>{switch(a.key){case"Enter":this.Publish({type:"rename-sheet",name:t.innerText.trim(),sheet:r});break;case"Escape":t.innerText=r.name,this.Publish({type:"cancel"}),this.Update();break;default:return}a.stopPropagation(),a.preventDefault()}),t.addEventListener("focusout",()=>{let a=t.innerText.trim();a!==r.name?this.Publish({type:"rename-sheet",name:a,sheet:r}):this.Update()}),t.focus()}MouseDownTab(e,t,r,a,i){if(e.stopPropagation(),e.preventDefault(),this.IsDoubleClick(a))return;this.Publish({type:"activate-sheet",sheet:r});let s=i.map(m=>m.getBoundingClientRect()),o=a*2-1,n=s[0].left,l=s[s.length-1].right,h=s[0].top,d=s[0].bottom,c=-1,u=(s.length-1)*2+1;for(let m of i)this.SetActive(m,m===t);this.dragging=!0,Be(this.layout.mask,[],m=>{let[f,p]=[m.clientX,m.clientY];if(p>h&&p<d){let b=o;if(f<n)b=c;else if(f>l)b=u;else for(let w=0;w<s.length;w++){let y=s[w];if(f>=y.left&&f<=y.right){w!==a&&(f>=y.left+y.width/2?b=w*2+1:b=w*2-1);break}}b!==o&&(o=b,t.style.order=o.toString(),s=i.map(w=>w.getBoundingClientRect()))}},()=>{let m=a,f=(o+1)/2;this.dragging=!1;for(let p=0;p<this.model.sheets.length;p++)this.model.sheets.list[p].visible||(m>=p&&m++,f>=p&&f++);m===f||m===0&&f<=0||m===i.length-1&&f>=i.length-1||this.Publish({type:"reorder-sheet",index:m,move_before:f})})}UpdateTheme(){this.tab_color_cache.clear(),this.Update()}Update(){if(this.tab_color_cache.clear(),this.dragging)return;if(this.options.tab_bar==="auto"){if(this.model.sheets.list.reduce((t,r)=>r.visible?t+1:t,0)<=1){this.Show(!1);return}this.Show(!0)}if(!this.tab_container)return;this.tab_container.innerText="";let e=[];for(let t of this.model.sheets.list){if(!t.visible)continue;let r=e.length,a=this.DOM.Create("li");if(a.setAttribute("tabindex","0"),t.tab_color){let o=t.id;if(!this.tab_color_cache.has(o)){let l=N(this.theme,t.tab_color),h=N(this.theme,{offset:t.tab_color});l&&h&&this.tab_color_cache.set(o,{background:l,foreground:h})}let n=this.tab_color_cache.get(o);n&&(a.style.backgroundColor=n.background,a.style.color=n.foreground,a.dataset.background_color=n.background,a.dataset.foreground_color=n.foreground)}a.style.order=(r*2).toString(),a.role="tab",this.SetActive(a,t===this.view.active_sheet);let i=o=>this.MouseDownTab(o,a,t,r,e),s=o=>{a.removeEventListener("mousedown",i),a.removeEventListener("dblclick",s),this.DoubleClickTab(o,a,t)};a.textContent=t.name,a.addEventListener("dblclick",s),a.addEventListener("mousedown",i),this.tab_container.appendChild(a),e.push(a)}}},Gi=class{constructor(e,t,r=!1,a=le.GetInstance()){if(this.model=e,this.view=t,this.DOM=a,r)return;if(!a)throw new Error("missing DOM context");this.dpr=Math.max(1,self.devicePixelRatio||1),this.mask=a.Div("treb-mouse-mask"),this.tooltip=a.Div("treb-tooltip"),this.spill_border=a.SVG("svg","treb-spill-border"),this.spill_border.tabIndex=-1,this.dropdown_caret=a.SVG("svg","treb-dropdown-caret"),this.dropdown_caret.setAttribute("viewBox","0 0 24 24"),this.dropdown_caret.tabIndex=-1;let i=a.SVG("path");i.setAttribute("d","M5,7 L12,17 L19,7"),this.dropdown_caret.appendChild(i),this.dropdown_caret.addEventListener("click",s=>{s.stopPropagation(),s.preventDefault(),this.grid_cover.classList.remove("nub-select");let o=this.dropdown_caret.getAttribute("class")||"";/active/i.test(o)?this.dropdown_caret.setAttribute("class","treb-dropdown-caret"):(this.dropdown_caret.setAttribute("class","treb-dropdown-caret active"),this.dropdown_list.focus())}),this.dropdown_list=a.Div("treb-dropdown-list",void 0,{attrs:{tabindex:"-1"}}),this.dropdown_list.addEventListener("keydown",s=>{let o=0;switch(s.key){case"ArrowDown":o=1;break;case"ArrowUp":o=-1;break;case"Escape":break;case"Enter":break;default:console.info(s.key);return}if(s.stopPropagation(),s.preventDefault(),s.key==="Escape"||s.key==="Enter"){if(this.container?.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),s.key==="Enter"&&this.dropdown_callback&&this.dropdown_selected){let n=this.dropdown_selected.dataset.dropdown_value;this.dropdown_callback.call(0,n?JSON.parse(n):void 0)}}else if(o&&this.dropdown_selected)if(o>0&&this.dropdown_selected.nextSibling){this.dropdown_selected.nextSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.nextSibling;let n=this.dropdown_selected.offsetTop+this.dropdown_selected.offsetHeight;n>this.dropdown_list.offsetHeight+this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=n-this.dropdown_list.offsetHeight)}else o<0&&this.dropdown_selected.previousSibling&&(this.dropdown_selected.previousSibling.classList.add("selected"),this.dropdown_selected.classList.remove("selected"),this.dropdown_selected=this.dropdown_selected.previousSibling,this.dropdown_selected.offsetTop<this.dropdown_list.scrollTop&&(this.dropdown_list.scrollTop=this.dropdown_selected.offsetTop))}),this.dropdown_list.addEventListener("mousedown",s=>{let o=s.target;if(s.target!==this.dropdown_list&&(s.stopPropagation(),s.preventDefault(),this.container?.focus(),this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_callback)){let n=o.dataset.dropdown_value;this.dropdown_callback.call(0,n?JSON.parse(n):void 0)}}),this.dropdown_list.addEventListener("mousemove",s=>{let o=s.target;o!==this.dropdown_selected&&(this.grid_cover.classList.remove("nub-select"),this.dropdown_selected&&this.dropdown_selected.classList.remove("selected"),o.classList.add("selected"),this.dropdown_selected=o)}),this.mock_selection=a.Div("mock-selection-node",void 0,{html:"&nbsp;"}),this.note_node=a.Div("treb-note"),this.title_node=a.Div("treb-hover-title"),this.sort_button=a.Create("button","treb-sort-button",void 0,{attrs:{title:"Sort table",tabindex:"-1"}}),this.HideNote()}column_header;row_header;contents;buffer_canvas;corner;corner_canvas;grid_selection;grid_cover;column_header_cover;row_header_cover;annotation_container;mask;mock_selection;container;grid_tiles=[];column_header_tiles=[];row_header_tiles=[];corner_selection;row_header_selection;column_header_selection;corner_annotations;row_header_annotations;column_header_annotations;frozen_row_tiles=[];frozen_column_tiles=[];header_size={width:0,height:0};applied_theme_colors=[];last_column=0;total_height=0;total_width=0;default_row_height=0;default_column_width=0;header_offset={x:0,y:0};dpr=1;scale=1;scroll_reference_node;get scroll_offset(){return this.scroll_reference_node?{x:this.scroll_reference_node.scrollLeft,y:this.scroll_reference_node.scrollTop}:{x:0,y:0}}set scroll_offset(e){this.scroll_reference_node&&(this.scroll_reference_node.scrollLeft=e.x,this.scroll_reference_node.scrollTop=e.y)}dropdown_caret;spill_border;trident=typeof navigator<"u"&&navigator.userAgent&&/trident/i.test(navigator.userAgent);default_tile_size={width:1200,height:800};tooltip_state;tooltip;dropdown_list;dropdown_caret_visible=!1;dropdown_callback;dropdown_selected;note_node;sort_button;title_node;row_cache=[];column_cache=[];initialized=!1;FocusInLayout(e){return!1}UpdateDPR(){let e=Math.max(1,self.devicePixelRatio||1);return e===this.dpr?!1:(this.dpr=e,!0)}ColumnWidth(e){return Math.round(this.view.active_sheet.GetColumnWidth(e)*this.scale)}RowHeight(e){return Math.round(this.view.active_sheet.GetRowHeight(e)*this.scale)}SetRowHeight(e,t){this.view.active_sheet.SetRowHeight(e,Math.round(t/this.scale))}SetColumnWidth(e,t){this.view.active_sheet.SetColumnWidth(e,Math.round(t/this.scale))}ShowSelections(e=!0){this.grid_selection.style.display=e?"block":"none"}HideTitle(){this.title_node.style.opacity="0"}ShowTitle(e,t){if(this.title_node.textContent=e,!this.title_node.parentElement)return;let r=this.title_node.parentElement.getBoundingClientRect(),a=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.title_node.style.left=r.left+a.left-this.scroll_reference_node.scrollLeft+0+"px",this.title_node.style.top=r.top+a.bottom-this.scroll_reference_node.scrollTop+8+"px",this.title_node.style.opacity="1"}HideNote(){this.note_node.style.opacity="0",this.note_node.style.pointerEvents="none"}HideTableSortButton(){this.sort_button.style.opacity="0",this.sort_button.style.pointerEvents="none",this.sort_button.setAttribute("tabindex","-1")}ShowTableSortButton(e,t,r){if(!this.sort_button.parentElement)return;let a=!0,i=!1;e.sort&&e.sort.column===t&&(a=!e.sort.asc,i=!0),this.sort_button.setAttribute("tabindex","0  "),this.sort_button.style.opacity="1",this.sort_button.style.pointerEvents="initial",this.sort_button.classList.remove("asc","desc"),i&&this.sort_button.classList.add(a?"asc":"desc"),this.sort_button.dataset.asc=a.toString(),this.sort_button.dataset.table=e.name,this.sort_button.dataset.column=t.toString();let s=this.OffsetCellAddressToRectangle(r).Shift(this.header_size.width,this.header_size.height),o=this.sort_button.getBoundingClientRect();this.sort_button.style.left=s.right-o.width-o.width/2+"px",this.sort_button.style.top=s.top+(s.height-o.height)/2+"px"}ShowNote(e,t,r,a){if(a?this.note_node.innerHTML=a:this.note_node.textContent=e,!this.note_node.parentElement)return;let i=this.note_node.getBoundingClientRect(),s=this.note_node.parentElement.getBoundingClientRect(),o={x:8,y:2},n=this.OffsetCellAddressToRectangle(t).Shift(this.header_size.width,this.header_size.height);this.note_node.style.left=s.left+n.right-this.scroll_reference_node.scrollLeft+o.x+"px",this.note_node.style.top=s.top+n.top-this.scroll_reference_node.scrollTop-i.height/5-o.y+"px",this.note_node.style.opacity="1",this.note_node.style.pointerEvents="auto"}AnnotationLayoutOrder(e,t){let r=-1;for(let i=0;i<this.view.active_sheet.annotations.length;i++)if(this.view.active_sheet.annotations[i]===e){r=i;break}if(r<0)return!1;let a=Math.min(Math.max(0,r+t),this.view.active_sheet.annotations.length-1);if(a===r)return!1;this.view.active_sheet.annotations.splice(r,1),this.view.active_sheet.annotations.splice(a,0,e);for(let i=0;i<this.view.active_sheet.annotations.length;i++){let s=this.view.active_sheet.annotations[i].key,o=this.container?.querySelectorAll(`.annotation[data-key="${s}"]`);if(o)for(let n=0;n<o?.length;n++)o[n].style.zIndex=(i+1).toString()}return!0}PointToAnnotationCorner(e){let t=this.PointToAddress_Grid(e,!1),r=this.CellAddressToRectangle(t);return{address:t,offset:{x:(e.x-r.left)/r.width,y:(e.y-r.top)/r.height}}}RectToAnnotationLayout(e){return{tl:this.PointToAnnotationCorner({x:(e.left||0)+1,y:(e.top||0)+1}),br:this.PointToAnnotationCorner({x:e.right||e.left||100,y:e.bottom||e.top||100})}}AddressToAnnotationLayout(e,t){let r={tl:this.CellAddressToRectangle(e),br:this.CellAddressToRectangle(t)};return{tl:this.PointToAnnotationCorner({x:r.tl.left||0,y:r.tl.top||0}),br:this.PointToAnnotationCorner({x:r.br.right||r.tl.left||100,y:r.br.bottom||r.tl.left||100})}}AnnotationLayoutToRect(e){let t=this.CellAddressToRectangle(e.tl.address),r=this.CellAddressToRectangle(e.br.address),a=t.left+t.width*e.tl.offset.x-1,i=t.top+t.height*e.tl.offset.y-1;return new ie(a,i,r.left+r.width*e.br.offset.x-a,r.top+r.height*e.br.offset.y-i)}UpdateAnnotation(e,t){Array.isArray(e)||(e=[e]);for(let r of e){let a=r.view[this.view.view_index]||{};if(a.node){let i=10*this.scale;if(r.data.style?.font_size?.unit==="em"&&(i*=r.data.style.font_size.value),a.node.dataset.scale=this.scale.toString(),r.data.style?.font_face&&r.data.style.font_face.startsWith("stack:")){let s=r.data.style.font_face.substring(6),o=t.font_stacks[s];o?(a.node.classList.add("treb-inherit-font"),a.node.style.fontFamily=o.font||"",o.variants&&(a.node.style.fontVariant=o.variants)):(a.node.classList.remove("treb-inherit-font"),a.node.style.fontFamily="",a.node.style.fontVariant="")}else a.node.classList.remove("treb-inherit-font"),a.node.style.fontFamily="",a.node.style.fontVariant="";if(r.data.style?.bold?a.node.style.fontWeight="600":a.node.style.fontWeight="400",r.data.style?.italic?a.node.style.fontStyle="italic":a.node.style.fontStyle="",r.data.style?.underline?a.node.style.textDecoration="underline":a.node.style.textDecoration="",a.node.style.fontSize=`${i}pt`,r.rect&&!r.data.layout&&(r.scaled_rect=r.rect.Scale(this.scale),r.data.layout=this.RectToAnnotationLayout(r.scaled_rect)),r.data.layout){let s=this.AnnotationLayoutToRect(r.data.layout);s.ApplyStyle(a.node),r.scaled_rect=s}a.node.dataset.key=r.key.toString(),(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.CloneFrozenAnnotation(r)}}}GetFrozenAnnotations(e){return[this.row_header_annotations,this.column_header_annotations,this.corner_annotations].map(t=>t.querySelector(`.annotation[data-key="${e.key}"]`)).filter(t=>t!==null)}CloneFrozenAnnotations(){for(let e of this.view.active_sheet.annotations)e.view[this.view.view_index]?.node&&e.key&&this.CloneFrozenAnnotation(e)}ClearFrozenAnnotations(){for(let e of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let t=e.querySelectorAll(".annotation");for(let r=0;r<t.length;r++)t[r].parentElement?.removeChild(t[r])}}RemoveFrozenAnnotation(e){for(let t of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=t.querySelector(`.annotation[data-key="${e.key}"]`);r&&r.parentElement?.removeChild(r)}}CloneFrozenAnnotation(e){for(let t of[this.row_header_annotations,this.column_header_annotations,this.corner_annotations]){let r=t.querySelector(`.annotation[data-key="${e.key}"]`);r&&r.parentElement?.removeChild(r);let a=e.view[this.view.view_index];if(r=a?.node?.cloneNode(!0),r){let i=r.querySelector(".annotation-move-target"),s=r.querySelector(".annotation-resize-target");r.addEventListener("mousedown",o=>{let n=a.node;requestAnimationFrame(()=>{n?.focus()}),this.AnnotationMouseDown(e,a.node,o,i,s)}),t.appendChild(r)}}}RemoveAnnotation(e){let t=e.view[this.view.view_index]||{};t.node&&t.node.parentElement?.removeChild(t.node),this.RemoveFrozenAnnotation(e)}RemoveAnnotationNodes(){let e=Array.prototype.map.call(this.annotation_container.children,t=>t);for(let t of e)this.annotation_container.removeChild(t);(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.ClearFrozenAnnotations()}AddAnnotation(e,t){let r=e.view[this.view.view_index]||{};if(!r.node)throw new Error("annotation view/node missing");this.annotation_container.appendChild(r.node),this.UpdateAnnotation(e,t)}AnnotationMouseDown(e,t,r,a,i){let s=e.scaled_rect;return s?new Promise(o=>{let n={left:s.left,top:s.top,width:s.width,height:s.height},l=this.scroll_reference_node,h=l.getBoundingClientRect(),d=t.getBoundingClientRect();if(r.target===a||r.target!==i&&r.altKey){r.stopPropagation(),r.preventDefault(),t.focus();let c={x:d.left+r.offsetX-s.left,y:d.top+r.offsetY-s.top},u=[t,...this.GetFrozenAnnotations(e)],m=25,f=this.CellAddressToRectangle({row:0,column:0}).Combine(this.CellAddressToRectangle({row:this.view.active_sheet.rows-1,column:this.view.active_sheet.columns-1})).Expand(-1,-1);Be(this.mask,"move",p=>{if(p.offsetY-h.top<this.header_offset.y){let b=Math.min(m,l.scrollTop);l.scrollTop-=b,c.y+=b}else if(p.offsetY-h.top>=h.height&&l.scrollTop+h.height<f.height){let b=m;l.scrollTop+=b,c.y-=b}if(p.offsetX-h.left<this.header_offset.x){let b=Math.min(m,l.scrollLeft);l.scrollLeft-=b,c.x+=b}else if(p.offsetX-h.left>=h.width&&l.scrollLeft+h.width<f.width){let b=m;l.scrollLeft+=b,c.x-=b}if(s.top=p.offsetY-c.y,s.left=p.offsetX-c.x,p.shiftKey){let b=Math.abs(s.left-n.left),w=Math.abs(s.top-n.top);b<=w?s.left=n.left:s.top=n.top}if(p.ctrlKey){let b=this.ClampToGrid({x:s.left,y:s.top});s.left=b.x,s.top=b.y}for(let b of u)b.style.top=s.top+"px",b.style.left=s.left+"px"},()=>{e.data.extent=void 0,e.data.layout=this.RectToAnnotationLayout(s),o({type:"annotation",annotation:e,event:"move"})});return}else if(r.target===i){r.stopPropagation(),r.preventDefault(),t.focus();let c=0;e.data.type==="image"&&e.data.data&&e.data.data.original_size&&e.data.data.original_size.width&&e.data.data.original_size.height&&(c=e.data.data.original_size.width/e.data.data.original_size.height);let u=t.getBoundingClientRect(),m={x:u.left+r.offsetX-s.width+i.offsetLeft,y:u.top+r.offsetY-s.height+i.offsetTop};Be(this.mask,"nw-resize",f=>{let p=[t,...this.GetFrozenAnnotations(e)];if(s.height=f.offsetY-m.y,s.width=f.offsetX-m.x,f.shiftKey&&f.ctrlKey){if(c){let b=Math.abs(s.width-n.width),w=Math.abs(s.height-n.height);b<w?s.width=c*s.height:s.height=s.width/c}}else if(f.shiftKey){let b=Math.abs(s.height-n.height),w=Math.abs(s.width-n.width);b>w?s.width=n.width:s.height=n.height}else if(f.ctrlKey){let b=this.ClampToGrid({x:s.right,y:s.bottom});s.width=b.x-s.left+1,s.height=b.y-s.top+1}for(let b of p)b.style.height=s.height+"px",b.style.width=s.width+"px"},()=>{e.data.extent=void 0,e.data.layout=this.RectToAnnotationLayout(s),o({type:"annotation",annotation:e,event:"resize"})});return}else o()}):(console.info("missing scaled rect!"),Promise.reject())}Initialize(e,t,r=!0){this.mask.parentElement||e.parentElement?.parentElement?.appendChild(this.mask),this.tooltip.parentElement||e.appendChild(this.tooltip),this.spill_border.parentElement||e.appendChild(this.spill_border),this.dropdown_caret.parentElement||e.appendChild(this.dropdown_caret),this.dropdown_list.parentElement||e.appendChild(this.dropdown_list),this.note_node.parentElement||e.appendChild(this.note_node),this.sort_button.parentElement||(e.appendChild(this.sort_button),this.sort_button.addEventListener("click",()=>{t.sort(this.sort_button.dataset.table||"",Number(this.sort_button.dataset.column||"0")||0,/true/i.test(this.sort_button.dataset.asc||"")),this.sort_button.classList.remove("asc","desc"),this.sort_button.dataset.asc==="true"?(this.sort_button.dataset.asc="false",this.sort_button.classList.add("desc")):(this.sort_button.dataset.asc="true",this.sort_button.classList.add("asc")),t.focus()})),this.title_node.parentElement||e.appendChild(this.title_node),this.InitializeInternal(e,t.scroll),!r&&this.scroll_reference_node&&(this.scroll_reference_node.style.overflow="hidden"),this.dropdown_callback=t.dropdown,this.initialized=!0}MockSelection(){if(this.container&&!this.trident&&this.DOM.doc){let e=this.DOM.GetSelection();if(e){let t=this.DOM.doc.createRange();t.selectNodeContents(this.mock_selection),e.removeAllRanges(),e.addRange(t)}}}CreateTile(e,t,r,a,i,s,o,n=!0){let l=this.DOM.Create("canvas");return l.setAttribute("class",e),l.logical_size=t,l.width=t.width*this.dpr,l.height=t.height*this.dpr,l.style.width=`${t.width}px`,l.style.height=`${t.height}px`,l.tile_position=r,l.first_cell=a,this.UpdateTileGridPosition(l),l.last_cell={row:a.row+i.rows-1,column:a.column+i.columns-1},l.pixel_start=s,l.pixel_end={x:s.x+t.width,y:s.y+t.height},l.dirty=!!n,l.needs_full_repaint=!0,o.appendChild(l),l}ApplyThemeColors(){if(this.container)for(let[e,t]of this.applied_theme_colors.entries())this.container.style.setProperty(`--treb-applied-theme-color-${e+1}`,t)}ApplyTheme(e){this.row_header.style.backgroundColor=this.column_header.style.backgroundColor=this.corner.style.backgroundColor=e.headers?.fill?N(e,e.headers.fill,0):"",this.corner.style.borderColor=e.grid_color||"";for(let t of this.grid_tiles)for(let r of t)r.style.backgroundColor=N(e,e.grid_cell?.fill,0)||"#fff";this.dropdown_list.style.font=H.CompositeFont(e.grid_cell_font_size,{font_face:"stack:default"},this.scale,e).font,this.applied_theme_colors=e.theme_colors?.slice(4,10)||[],this.container&&this.ApplyThemeColors()}UpdateTotalSize(){this.total_height=0;let e=this.view.active_sheet.rows;for(let r=0;r<e;r++)this.total_height+=this.RowHeight(r);this.total_width=0;let t=this.view.active_sheet.columns;for(let r=0;r<t;r++)this.total_width+=this.ColumnWidth(r)}UpdateContentsSize(){let e=this.row_header_tiles.reduce((r,a)=>r+a.logical_size.height,0),t=this.column_header_tiles.reduce((r,a)=>r+a.logical_size.width,0);this.column_header.style.width=this.contents.style.width=`${t}px`,this.row_header.style.height=this.contents.style.height=`${e}px`}HideTooltip(){this.tooltip.style.display="none",this.tooltip_state=void 0,this.tooltip.classList.remove("arrow-up"),this.tooltip.classList.remove("arrow-left")}ShowTooltip(e={}){e.up?(this.tooltip.classList.add("arrow-up"),this.tooltip_state="up"):e.left&&(this.tooltip.classList.add("arrow-left"),this.tooltip_state="left"),this.tooltip.style.display="block",this.UpdateTooltip(e)}ShowDropdownCaret(e,t,r){let a=this.OffsetCellAddressToRectangle(e.start);e.count>1&&(a=a.Combine(this.OffsetCellAddressToRectangle(e.end))),a=a.Shift(this.header_size.width,this.header_size.height);let i=Math.round(this.scale*Math.max(8,Math.min(20,a.height)));this.dropdown_caret.style.height=`${i}px`,this.dropdown_caret.style.width=`${i}px`,this.dropdown_caret.style.left=`${a.right+1}px`,this.dropdown_caret.style.top=`${a.bottom-i}px`,this.dropdown_list.style.top=`${a.bottom+2}px`,this.dropdown_list.style.left=`${a.left+2}px`,this.dropdown_list.style.minWidth=`${a.width}px`,this.dropdown_list.style.fontSize=this.scale.toFixed(2)+"em",this.dropdown_list.textContent="";for(let s of t){let o=this.DOM.Div(void 0,this.dropdown_list);r===s&&(this.dropdown_selected=o,o.classList.add("selected")),o.dataset.dropdown_value=JSON.stringify(s),o.textContent=s?.toString()||""}this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret.style.display="block",this.dropdown_caret_visible=!0}ShowSpillBorder(e){if(this.spill_border.textContent="",e){let t=new k(e.start,e.end),r=this.OffsetCellAddressToRectangle(t.start);t.count>1&&(r=r.Combine(this.OffsetCellAddressToRectangle(t.end))),r=r.Shift(this.header_size.width,this.header_size.height),this.spill_border.style.display="block",this.spill_border.style.top=(r.top-5).toString()+"px",this.spill_border.style.left=(r.left-5).toString()+"px",this.spill_border.style.width=(r.width+10).toString()+"px",this.spill_border.style.height=(r.height+10).toString()+"px";let a=this.DOM.SVG("rect",void 0,this.spill_border);a.setAttribute("x","4.5"),a.setAttribute("y","4.5"),a.setAttribute("width",(r.width+1).toString()),a.setAttribute("height",(r.height+1).toString())}else this.spill_border.style.display="none"}HideDropdownCaret(){this.dropdown_caret_visible&&(this.dropdown_caret.setAttribute("class","treb-dropdown-caret"),this.dropdown_caret_visible=!1,this.dropdown_caret.style.display="none")}GetScrollOffset(){return{x:this.scroll_reference_node.scrollLeft+this.header_offset.x,y:this.scroll_reference_node.scrollTop+this.header_offset.y}}ScrollTo(e,t=!0,r=!0,a=!1){let i=this.CellAddressToRectangle(e);if(a&&this.scroll_reference_node.scrollTo){let s={left:this.scroll_reference_node.scrollLeft,top:this.scroll_reference_node.scrollTop},o={left:t?i.left:s.left,top:r?i.top:s.top,behavior:"smooth"};this.scroll_reference_node.scrollTo(o)}else r&&(this.scroll_reference_node.scrollTop=i.top),t&&(this.scroll_reference_node.scrollLeft=i.left)}ScrollIntoView(e,t=!1){let r=this.CellAddressToRectangle(e),a=this.scroll_reference_node.clientWidth-this.row_header.offsetWidth,i=this.scroll_reference_node.clientHeight-this.column_header.offsetHeight,s={x:0,y:0},o={x:!1,y:!1},n=new ie(this.scroll_reference_node.scrollLeft,this.scroll_reference_node.scrollTop,a,i);(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&(this.view.active_sheet.freeze.rows&&e.row>=this.view.active_sheet.freeze.rows?s.y=this.frozen_row_tiles[0].logical_size.height:this.view.active_sheet.freeze.rows&&(o.y=!0),this.view.active_sheet.freeze.columns&&e.column>=this.view.active_sheet.freeze.columns?s.x=this.frozen_column_tiles[0].logical_size.width:this.view.active_sheet.freeze.columns&&(o.x=!0));let l={behavior:t?"smooth":"auto"};e.row!==1/0&&(r.top<n.top+s.y&&!o.y?l.top=r.top-s.y:r.bottom>n.bottom&&(l.top=r.bottom-i)),e.column!==1/0&&(r.left<n.left+s.x&&!o.x?l.left=r.left-s.x:r.right>n.right&&(l.left=r.right-a)),this.scroll_reference_node.scrollTo(l)}UpdateTooltip(e={}){if(typeof e.text<"u"&&(this.tooltip.textContent=e.text),typeof e.x<"u"){let t=e.x||0;this.tooltip_state==="up"&&(t-=this.tooltip.offsetWidth/2),this.tooltip.style.left=Math.round(t)+"px"}if(typeof e.y<"u"){let t=e.y||0;this.tooltip_state==="left"&&(t-=this.tooltip.offsetHeight/2),this.tooltip.style.top=Math.round(t)+"px"}}CoordinateToRowHeader(e){let t={column:1/0,row:0};if(this.view.active_sheet.freeze.rows&&this.frozen_row_tiles[0].pixel_end.y>=e-this.scroll_reference_node.scrollTop){let r=0;e-=this.scroll_reference_node.scrollTop;for(let a=0;a<this.view.active_sheet.freeze.rows;a++)if(r+=this.RowHeight(a),r>=e)return t.row=a,t}for(let r of this.row_header_tiles)if(r.pixel_end.y>=e){let a=e-r.pixel_start.y,i=0;for(t.row=r.first_cell.row;t.row<=r.last_cell.row;t.row++,a-=i)if(i=this.RowHeight(t.row),i>a)return t;return t}return t}CoordinateToColumnHeader(e){let t={row:1/0,column:0};if(this.view.active_sheet.freeze.columns&&this.frozen_column_tiles[0].pixel_end.x>=e-this.scroll_reference_node.scrollLeft){let r=0;e-=this.scroll_reference_node.scrollLeft;for(let a=0;a<this.view.active_sheet.freeze.columns;a++)if(r+=this.ColumnWidth(a),r>=e)return t.column=a,t}for(let r of this.column_header_tiles)if(r.pixel_end.x>=e){let a=e-r.pixel_start.x,i=0;for(t.column=r.first_cell.column;t.column<=r.last_cell.column;t.column++,a-=i)if(i=this.ColumnWidth(t.column),i>a)return t;return t}return t}PointToAddress_Grid(e,t=!0){if(t){if(this.view.active_sheet.freeze.rows){let s=this.frozen_row_tiles[0].logical_size.height;e.y-this.scroll_reference_node.scrollTop<s&&(e.y-=this.scroll_reference_node.scrollTop)}if(this.view.active_sheet.freeze.columns){let s=this.frozen_column_tiles[0].logical_size.width;e.x-this.scroll_reference_node.scrollLeft<s&&(e.x-=this.scroll_reference_node.scrollLeft)}}let r={row:0,column:0},a=this.grid_tiles[this.grid_tiles.length-1],i=a[a.length-1];if(e.y>i.pixel_end.y){let s=e.y-i.pixel_end.y;for(r.row=i.last_cell.row;s>0;)r.row++,s-=this.default_row_height}else for(let s of a)if(s.pixel_start.y<=e.y&&s.pixel_end.y>=e.y){let o=e.y-s.pixel_start.y,n=0;for(r.row=s.first_cell.row;r.row<=s.last_cell.row&&(n=this.RowHeight(r.row),!(n>o));r.row++,o-=n);break}if(e.x>i.pixel_end.x){let s=e.x-i.pixel_end.x;for(r.column=i.last_cell.column;s>0;)r.column++,s-=this.default_column_width}else for(let s of this.grid_tiles)if(s[0].pixel_start.x<=e.x&&s[0].pixel_end.x>=e.x){let o=s[0],n=e.x-o.pixel_start.x,l=0;for(r.column=o.first_cell.column;r.column<=o.last_cell.column&&(l=this.ColumnWidth(r.column),!(l>n));r.column++,n-=l);break}return r}AdjacentTile(e,t=0,r=0){if(!t&&!r)return e;let a=e.tile_position,i=e.tile_position.row+t,s=e.tile_position.column+r;if(!(i<0||s<0)){if(this.grid_tiles[a.column]&&this.grid_tiles[a.column][a.row]===e&&this.grid_tiles[s])return this.grid_tiles[s][i];if(!a.column&&this.frozen_column_tiles[a.row]===e)return this.frozen_column_tiles[i];if(!a.row&&this.frozen_row_tiles[a.column]===e)return this.frozen_row_tiles[s]}}UpdateTiles(){if(!this.container)throw new Error("invalid container");this.grid_tiles.forEach(g=>{g.forEach(v=>{v.parentElement&&v.parentElement.removeChild(v)})});for(let g of[this.column_header_tiles,this.row_header_tiles,this.frozen_row_tiles,this.frozen_column_tiles])for(let v of g)v.parentElement&&v.parentElement.removeChild(v);this.frozen_row_tiles=[],this.frozen_column_tiles=[],this.row_header_tiles=[],this.column_header_tiles=[],this.grid_tiles=[];let e=this.view.active_sheet;this.default_row_height=Math.round(e.default_row_height*this.scale),this.default_column_width=Math.round(e.default_column_width*this.scale),this.header_offset={x:Math.round(e.header_offset.x*this.scale),y:Math.round(e.header_offset.y*this.scale)},this.UpdateContainingGrid();let t=this.view.active_sheet.rows,r=this.view.active_sheet.columns;t||(t=100),r||(r=40);let a=0,i=0;for(let g=0;g<t;g++)a+=this.RowHeight(g);for(let g=0;g<r;g++)i+=this.ColumnWidth(g);if(!i||!a)throw"unexpected missing total size";if(a||(a=this.default_row_height*t),i||(i=this.default_column_width*r),this.container.clientWidth>i+this.header_size.width){let g=Math.ceil((this.container.offsetWidth-i)/this.default_column_width);i+=g*this.default_column_width,r+=g}if(this.last_column=r,this.container.clientHeight>a+this.header_size.height){let g=Math.ceil((this.container.offsetHeight-a)/this.default_row_height);a+=g*this.default_row_height,t+=g}this.column_header.style.width=this.contents.style.width=`${i}px`,this.row_header.style.height=this.contents.style.height=`${a}px`;let s=[],o=[],n=0,l=0;for(let g=0;g<r;g++){let v=this.ColumnWidth(g);n&&n+v>this.default_tile_size.width&&(s.push(n),o.push(l),l=g,n=0),n+=v}s.push(n),o.push(l);let h=[],d=[],c=0,u=0;for(let g=0;g<t;g++){let v=this.RowHeight(g);c&&c+v>this.default_tile_size.height&&(h.push(c),d.push(u),c=0,u=g),c+=v}h.push(c),d.push(u);let m=s.length,f=h.length,p=0,b=0,w=0,y=0;for(let g=0;g<this.view.active_sheet.freeze.rows;g++)w+=this.RowHeight(g);for(let g=0;g<this.view.active_sheet.freeze.columns;g++)y+=this.ColumnWidth(g);for(let g=0;g<m;g++){let v=[];p=0;let x=g===m-1?r-o[g]:o[g+1]-o[g];this.column_header_tiles.push(this.CreateTile("column-header-tile",{height:this.header_offset.y,width:s[g]},{row:0,column:g},{row:0,column:o[g]},{rows:0,columns:x},{x:b,y:0},this.column_header)),this.view.active_sheet.freeze.rows&&this.frozen_row_tiles.push(this.CreateTile("frozen-row-tile",{height:w,width:s[g]},{row:1,column:g},{row:0,column:o[g]},{rows:0,columns:x},{x:b,y:0},this.column_header));for(let _=0;_<f;_++){let C=_===f-1?t-d[_]:d[_+1]-d[_];g||(this.row_header_tiles.push(this.CreateTile("row-header-tile",{height:h[_],width:this.header_offset.x},{row:_,column:0},{row:d[_],column:0},{rows:C,columns:1},{x:0,y:p},this.row_header)),this.view.active_sheet.freeze.columns&&this.frozen_column_tiles.push(this.CreateTile("frozen-column-tile",{height:h[_],width:y},{row:_,column:1},{row:d[_],column:0},{rows:C,columns:1},{x:0,y:p},this.row_header))),v.push(this.CreateTile("grid-tile",{height:h[_],width:s[g]},{row:_,column:g},{row:d[_],column:o[g]},{rows:C,columns:x},{x:b,y:p},this.contents)),p+=h[_]}this.grid_tiles.push(v),b+=s[g]}this.total_height=a,this.total_width=i,this.ClearLayoutCaches(),this.UpdateGridTemplates(!0,!0)}ClearLayoutCaches(){this.row_cache=[],this.column_cache=[]}TileIndexForColumn(e){for(let t of this.column_header_tiles)if(t.first_cell.column<=e&&t.last_cell.column>=e)return t.tile_position.column;return-1}TileIndexForRow(e){for(let t of this.row_header_tiles)if(t.first_cell.row<=e&&t.last_cell.row>=e)return t.tile_position.row;return-1}DirtyHeaders(e){if(e){for(let t of this.column_header_tiles){if(t.dirty)continue;let r=new k({row:e.start.row,column:t.first_cell.column},{row:e.start.row,column:t.last_cell.column});(e.entire_row||r.Intersects(e))&&(t.dirty=!0)}for(let t of this.row_header_tiles){if(t.dirty)continue;let r=new k({column:e.start.column,row:t.first_cell.row},{column:e.start.column,row:t.last_cell.row});(e.entire_column||r.Intersects(e))&&(t.dirty=!0)}}}DirtyAll(){for(let e of this.grid_tiles)for(let t of e)t.dirty=!0}DirtyArea(e){if(this.initialized){Array.isArray(e)||(e=[e]);for(let t of e){let r={row:0,column:0},a={row:this.grid_tiles[0].length-1,column:this.grid_tiles.length-1};t.start.column!==1/0&&(r.column=a.column=this.TileIndexForColumn(t.start.column),t.end.column!==t.start.column&&(a.column=this.TileIndexForColumn(t.end.column))),t.start.row!==1/0&&(r.row=a.row=this.TileIndexForRow(t.start.row),t.end.row!==t.start.row&&(a.row=this.TileIndexForRow(t.end.row)));for(let i=r.column;i<=a.column;i++)for(let s=r.row;s<=a.row;s++)this.grid_tiles[i][s].dirty=!0}}}VisibleTiles(){let e=[{row:0,column:0},{row:0,column:0}];if(!this.container||!this.grid_tiles.length||!this.grid_tiles[0].length)return new k(e[0],e[1]);let t=this.scroll_reference_node.scrollLeft,r=t+this.scroll_reference_node.offsetWidth,a=this.scroll_reference_node.scrollTop,i=a+this.scroll_reference_node.offsetHeight;for(let s of this.grid_tiles){let o=s[0];if(o.pixel_start.x<=t&&o.pixel_end.x>=t){for(o of s)if(o.pixel_start.y<=a&&o.pixel_end.y>=a){e[0]=o.tile_position;break}}if(s===this.grid_tiles[this.grid_tiles.length-1]||o.pixel_start.x<=r&&o.pixel_end.x>=r){for(o of s)if(o===s[s.length-1]||o.pixel_start.y<=i&&o.pixel_end.y>=i)return e[1]=o.tile_position,new k(e[0],e[1])}}return new k(e[0],e[1])}UpdateTileHeights(e=!0,t=-1){let r=0;for(let a=0;a<this.row_header_tiles.length;a++){let i=this.row_header_tiles[a];if(t>i.last_cell.row){r+=i.logical_size.height;continue}let s=0;for(let n=i.first_cell.row;n<=i.last_cell.row;n++)s+=this.RowHeight(n);let o=i.logical_size.height===s;if(i.pixel_start.y=r,r+=s,i.pixel_end.y=r,!o){if(i.logical_size.height=s,i.style.height=`${s}px`,i.height=this.dpr*s,this.view.active_sheet.freeze.columns){let n=this.frozen_column_tiles[a];n.logical_size.height=s,n.style.height=`${s}px`,n.height=this.dpr*s}e&&(i.dirty=!0,i.needs_full_repaint=!0)}for(let n of this.grid_tiles){let l=n[a];l.pixel_start.y=i.pixel_start.y,l.pixel_end.y=i.pixel_end.y,o||(l.logical_size.height=s,l.style.height=`${s}px`,l.height=this.dpr*s,e&&(l.dirty=!0,l.needs_full_repaint=!0))}}if(this.view.active_sheet.freeze.rows){let a=0;for(let i=0;i<this.view.active_sheet.freeze.rows;i++)a+=this.RowHeight(i);for(let i of this.frozen_row_tiles)i.style.height=`${a}px`,i.height=a*this.dpr;a+=this.header_offset.y,this.corner_canvas.style.height=`${a}px`,this.corner_canvas.height=a*this.dpr;for(let i of this.grid_tiles)i[0].dirty=!0}this.UpdateGridTemplates(!1,!0),this.row_header.style.height=this.contents.style.height=`${r}px`,this.ClearLayoutCaches()}UpdateTileWidths(e=!0,t=-1){let r=0;for(let a=0;a<this.column_header_tiles.length;a++){let i=this.column_header_tiles[a],s=this.grid_tiles[a];if(t>i.last_cell.column){r+=i.logical_size.width;continue}let o=0;for(let l=i.first_cell.column;l<=i.last_cell.column;l++)o+=this.ColumnWidth(l);let n=i.logical_size.width===o;if(i.pixel_start.x=r,r+=o,i.pixel_end.x=r,!n){if(i.logical_size.width=o,i.style.width=`${o}px`,i.width=this.dpr*o,this.view.active_sheet.freeze.rows){let l=this.frozen_row_tiles[a];l.logical_size.width=o,l.style.width=`${o}px`,l.width=this.dpr*o}e&&(i.dirty=!0,i.needs_full_repaint=!0)}for(let l of s)l.pixel_start.x=i.pixel_start.x,l.pixel_end.x=i.pixel_end.x,n||(l.logical_size.width=o,l.style.width=`${o}px`,l.width=this.dpr*o,e&&(l.dirty=!0,l.needs_full_repaint=!0))}if(this.view.active_sheet.freeze.columns){let a=0;for(let i=0;i<this.view.active_sheet.freeze.columns;i++)a+=this.ColumnWidth(i);for(let i of this.frozen_column_tiles)i.style.width=`${a}px`,i.width=a*this.dpr;a+=this.header_offset.x,this.corner_canvas.style.width=`${a}px`,this.corner_canvas.width=a*this.dpr;for(let i of this.grid_tiles[0])i.dirty=!0}this.UpdateGridTemplates(!0,!1),this.column_header.style.width=this.contents.style.width=`${r}px`,this.ClearLayoutCaches()}ClampToGrid(e){let t=this.PointToAddress_Grid(e),r=this.OffsetCellAddressToRectangle(t);return e.x>r.left+r.width/2?e.x=r.left+r.width-1:e.x=r.left-1,e.y>r.top+r.height/2?e.y=r.top+r.height-1:e.y=r.top-1,e}OffsetCellAddressToRectangle(e){let t=this.CellAddressToRectangle(e);return e.column>=0&&e.column<this.view.active_sheet.freeze.columns&&(t=t.Shift(this.scroll_reference_node.scrollLeft,0)),e.row>=0&&e.row<this.view.active_sheet.freeze.rows&&(t=t.Shift(0,this.scroll_reference_node.scrollTop)),t}CellAddressToRectangle(e){let t=e.row===1/0||e.row<0?0:e.row,r=e.column===1/0||e.column<0?0:e.column;if(this.column_cache.length<=r+1){this.column_cache.length||(this.column_cache[0]=0);for(let s=this.column_cache.length-1;s<=r;s++)this.column_cache[s+1]=this.column_cache[s]+this.ColumnWidth(s)}if(this.row_cache.length<=t+1){this.row_cache.length||(this.row_cache[0]=0);for(let s=this.row_cache.length-1;s<=t;s++)this.row_cache[s+1]=this.row_cache[s]+this.RowHeight(s)}let a=this.column_cache[r],i=this.row_cache[t];return new ie(a,i,this.column_cache[r+1]-a,this.row_cache[t+1]-i)}ResizeTileWidth(e,t,r=!0){let a=this.column_header_tiles[e],i=t-a.logical_size.width;a.logical_size.width=t,a.style.width=`${t}px`,a.width=this.dpr*t,a.pixel_end.x+=i,r&&(a.dirty=!0,a.needs_full_repaint=!0);for(let o=e+1;o<this.column_header_tiles.length;o++){this.column_header_tiles[o].pixel_start.x+=i,this.column_header_tiles[o].pixel_end.x+=i;for(let n of this.grid_tiles[o])n.pixel_start.x+=i,n.pixel_end.x+=i}let s=this.grid_tiles[e];for(a of s)a.logical_size.width=t,a.style.width=`${t}px`,a.width=this.dpr*t,a.pixel_end.x+=i,r&&(a.dirty=!0,a.needs_full_repaint=!0);this.UpdateTotalSize(),this.UpdateGridTemplates(!0,!1),this.UpdateContentsSize()}ResizeTileHeight(e,t,r=!0){let a=this.row_header_tiles[e],i=t-a.logical_size.height;a.logical_size.height=t,a.style.height=`${t}px`,a.height=this.dpr*t,a.pixel_end.y+=i,r&&(a.dirty=!0,a.needs_full_repaint=!0);for(let s=e+1;s<this.row_header_tiles.length;s++)a=this.row_header_tiles[s],a.pixel_start.y+=i,a.pixel_end.y+=i;for(let s of this.grid_tiles){a=s[e],a.logical_size.height=t,a.style.height=`${t}px`,a.height=this.dpr*t,a.pixel_end.y+=i,r&&(a.dirty=!0,a.needs_full_repaint=!0);for(let o=e+1;o<s.length;o++)s[o].pixel_start.y+=i,s[o].pixel_end.y+=i}this.UpdateTotalSize(),this.UpdateGridTemplates(!1,!0),this.UpdateContentsSize()}},To=class extends Gi{constructor(e,t){super(e,t,!0)}InitializeInternal(){}UpdateGridTemplates(){}UpdateTileGridPosition(){}UpdateContainingGrid(){}ResizeCursor(){}},Do=class extends Gi{constructor(e,t,r){super(e,t,!1,r),this.column_header=r.Div("treb-top-header"),this.row_header=r.Div("treb-left-header"),this.corner=r.Div("treb-corner"),this.corner_canvas=r.Create("canvas"),this.corner.appendChild(this.corner_canvas),this.contents=r.Div("treb-contents"),this.buffer_canvas=r.Create("canvas","treb-buffer-canvas",this.contents),this.grid_selection=r.SVG("svg","treb-grid-selection",this.contents),this.row_header_selection=r.SVG("svg",["frozen-selection","frozen-selection-rows"],this.column_header),this.row_header_annotations=r.Div("frozen-annotation-container frozen-annotation-container-rows",this.column_header),this.column_header_selection=r.SVG("svg",["frozen-selection","frozen-selection-columns"],this.row_header),this.column_header_annotations=r.Div("frozen-annotation-container frozen-annotation-container-columns",this.row_header),this.corner_selection=r.SVG("svg","frozen-selection",this.corner),this.corner_annotations=r.Div("frozen-annotation-container frozen-annotation-container-corner",this.corner),this.annotation_container=r.Div("treb-annotation-container"),this.grid_cover=r.Div("tile-cover grid-cover"),this.column_header_cover=r.Div("tile-cover column-header-cover"),this.row_header_cover=r.Div("tile-cover row-header-cover")}InitializeInternal(e,t){this.container=e,this.scroll_reference_node=this.container,e.appendChild(this.column_header),e.appendChild(this.row_header),e.appendChild(this.corner),e.appendChild(this.contents),e.appendChild(this.annotation_container),e.appendChild(this.grid_cover),e.appendChild(this.column_header_cover),e.appendChild(this.row_header_cover),e.appendChild(this.mock_selection),this.container.addEventListener("scroll",()=>t()),this.ApplyThemeColors()}FocusInLayout(e){return!!(e&&e instanceof Element&&this.container?.contains(e))}ResizeCursor(e){switch(e){case"row":this.row_header_cover.classList.add("resize");break;case"column":this.column_header_cover.classList.add("resize");break;default:this.row_header_cover.classList.remove("resize"),this.column_header_cover.classList.remove("resize");break}}UpdateTileGridPosition(e){e.style.gridColumn=`${e.tile_position.column+1} / ${e.tile_position.column+2}`,e.style.gridRow=`${e.tile_position.row+1} / ${e.tile_position.row+2}`}UpdateContainingGrid(){if(!this.container)throw new Error("missing container");this.header_size.width=this.header_offset.x,this.header_size.height=this.header_offset.y;let e=this.header_offset.x,t=this.header_offset.y;if(this.view.active_sheet.freeze.columns)for(let r=0;r<this.view.active_sheet.freeze.columns;r++)e+=this.ColumnWidth(r);if(this.view.active_sheet.freeze.rows)for(let r=0;r<this.view.active_sheet.freeze.rows;r++)t+=this.RowHeight(r);this.container.style.gridTemplateColumns=`${this.header_offset.x}px auto`,this.container.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.corner_canvas.setAttribute("width",`${this.dpr*e}`),this.corner_canvas.setAttribute("height",`${this.dpr*t}`),this.column_header.style.height=`${t}px`,this.corner_canvas.style.width=`${e}px`,this.corner_canvas.style.height=`${t}px`}UpdateGridTemplates(){let e=0,t=0;this.column_header.style.gridTemplateColumns=this.contents.style.gridTemplateColumns=this.column_header_tiles.map(o=>(e+=o.logical_size.width,`${o.logical_size.width}px`)).join(" "),this.column_header.style.gridTemplateRows=`${this.header_offset.y}px auto`,this.row_header.style.gridTemplateRows=this.contents.style.gridTemplateRows=this.row_header_tiles.map(o=>(t+=o.logical_size.height,`${o.logical_size.height}px`)).join(" ");let r=this.header_offset.y;if(this.view.active_sheet.freeze.rows)for(let o=0;o<this.view.active_sheet.freeze.rows;o++)r+=this.RowHeight(o);this.column_header.style.height=`${r}px`,this.row_header_selection.style.display="block",this.row_header_selection.style.width=`${e}px`,this.corner_selection.style.height=this.row_header_selection.style.height=`${r}px`,this.corner_selection.style.top=this.row_header_selection.style.top="0px",this.row_header_selection.style.left="0px";let a=this.header_offset.x;if(this.view.active_sheet.freeze.columns)for(let o=0;o<this.view.active_sheet.freeze.columns;o++)a+=this.ColumnWidth(o);this.column_header_selection.style.display="block",this.corner_selection.style.width=this.column_header_selection.style.width=`${a}px`,this.column_header_selection.style.height=`${t}px`,this.column_header_selection.style.top="0px",this.corner_selection.style.left=this.column_header_selection.style.left="0px";let i={x:this.view.active_sheet.header_offset.x*this.scale,y:this.view.active_sheet.header_offset.y*this.scale},s=this.view.active_sheet.freeze;s.rows&&s.columns?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="block"):s.rows?(this.row_header_annotations.style.display="block",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"):s.columns?(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="block",this.corner_annotations.style.display="none"):(this.row_header_annotations.style.display="none",this.column_header_annotations.style.display="none",this.corner_annotations.style.display="none"),this.row_header_annotations.style.width=`${e}px`,this.corner_annotations.style.height=this.row_header_annotations.style.height=`${r-i.y}px`,this.corner_annotations.style.top=this.row_header_annotations.style.top=`${i.y}px`,this.column_header_annotations.style.width=this.corner_annotations.style.width=`${a-i.x}px`,this.column_header_annotations.style.height=`${t}px`,this.corner_annotations.style.left=this.column_header_annotations.style.left=`${i.x}px`,this.corner_selection.style.display="block",this.grid_selection.style.width=`${e}px`,this.grid_selection.style.height=`${t}px`,this.grid_selection.style.top=`${this.header_offset.y}px`,this.grid_selection.style.left=`${this.header_offset.x}px`,this.annotation_container.style.width=`${e}px`,this.annotation_container.style.height=`${t}px`,this.annotation_container.style.top=`${this.header_offset.y}px`,this.annotation_container.style.left=`${this.header_offset.x}px`}},aa=class ir extends ut{constructor(t,r,a){super(),this.model=t,this.view=r,this.autocomplete=a,this.parser=t.parser}static FormulaChars=("$^&*(-+={[<>/~%@"+G.argument_separator).split("");active_cell;autocomplete_matcher;container_node;active_editor;nodes=[];target_address;assume_formula=!1;text_formula=!1;get selecting(){if(this.assume_formula)return!0;if(!this.text_formula)return!1;if(this.active_editor&&this.active_editor.node===this.active_editor.node.ownerDocument.activeElement){let t=this.active_editor.node.ownerDocument.defaultView,r=t.getSelection();if(r?.rangeCount){let i=r?.getRangeAt(0);if((i?.endContainer instanceof t.HTMLElement?i.endContainer:i.endContainer?.parentElement)?.dataset.reference!==void 0)return!0;if(i?.startContainer instanceof t.Text){let s=(i.startContainer.textContent?.substring(0,i.startOffset)||"").trim();if(s.length&&ir.FormulaChars.includes(s[s.length-1]))return!0}else console.info("mark 21",i)}let a=this.SubstringToCaret2(this.active_editor.node)[1].trim();if(a.length){let i=a[a.length-1];return ir.FormulaChars.includes(i)}}return!1}composite_dependencies=[];get dependencies(){return this.composite_dependencies}parser;FocusEditor(){this.active_editor&&this.active_editor.node.focus()}RegisterListener(t,r,a){t.node.addEventListener(r,a),t.listeners||(t.listeners=new Map),t.listeners.set(r,a)}SelectAll(t){let r=t.ownerDocument.defaultView.getSelection(),a=t.ownerDocument.createRange();a.selectNode(t),r?.removeAllRanges(),r?.addRange(a)}SetCaret(t,r){let a=t.node.ownerDocument,i=a?.defaultView,s=i.getSelection(),o=a?.createRange(),n=h=>{let d=h;for(;d&&!(d instanceof i.Text)&&d.firstChild;)d=d.firstChild;return d},l=n(t.node);if(r){let h=n(r.node);s&&o&&(o.setStart(l,t.offset),o.setEnd(h,r.offset),s.removeAllRanges(),s.addRange(o))}else s&&o&&(o.setStart(l,t.offset),o.setEnd(l,t.offset),o.collapse(!0),s.removeAllRanges(),s.addRange(o))}InsertReference(t){if(!this.active_editor)return;let r=this.active_editor.node.ownerDocument.defaultView,a=r.getSelection();if(!a)throw new Error("error getting selection");if(a.rangeCount===0)return"";let i=a.getRangeAt(0),s=this.active_editor.node.textContent||"";if(i.startContainer instanceof r.Text)if(!i.collapsed&&i.startOffset<i.endOffset){let o=this.SubstringToCaret2(this.active_editor.node);this.active_editor.node.textContent=o[0]+t+s.substring(o[1].length),this.SetCaret({node:this.active_editor.node,offset:o[0].length},{node:this.active_editor.node,offset:o[0].length+t.length})}else{let o=i.startContainer.parentElement;if(o instanceof r.HTMLElement&&o.dataset.reference)o.textContent=t,this.SetCaret({node:o,offset:t.length});else{let n=this.SubstringToCaret2(this.active_editor.node)[1],l="",h=n.trim();if(h.length){let d=h[h.length-1];ir.FormulaChars.includes(d)||(n.length===h.length?l=" +":l="+")}this.active_editor.node.textContent=n+l+t+s.substring(n.length),this.SetCaret({node:this.active_editor.node,offset:n.length+t.length+l.length})}}else i.startContainer instanceof r.HTMLElement?(i.startContainer.textContent=t,this.SetCaret({node:i.startContainer,offset:t.length})):console.warn("unexpected range start container",i.startContainer);this.UpdateText(this.active_editor),this.UpdateColors(),this.active_editor.node.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}))}UpdateColors(t=!1,r=!1){let a=new Map,i=new Map;for(let o of this.nodes)for(let n of o.references||[]){let l=this.model.AddressToLabel(n);a.has(l)||(a.set(l,n),i.set(l,i.size))}for(let o of this.nodes){for(let n of Array.from(o.node.childNodes)){let l=n.ownerDocument?.defaultView;if(l&&n instanceof l.HTMLElement&&n.dataset.reference){let h=i.get(n.dataset.reference);n.dataset.highlightIndex=typeof h=="number"?(h%5+1).toString():"?"}}o.check=o.node.innerHTML.length}let s=Array.from(a.values());!t&&JSON.stringify(this.composite_dependencies)===JSON.stringify(s)||(this.composite_dependencies=s,r||this.Publish({type:"update",dependencies:this.composite_dependencies}))}UpdateDependencies(t,r){let a=[];for(let n of r.full_reference_list||[])switch(n.type){case"address":case"range":{let l=n.type==="range"?n.start:n;l.sheet_id||(l.sheet?l.sheet_id=this.model.sheets.Find(l.sheet)?.id||0:l.sheet_id=this.view.active_sheet.id),a.push(n);break}case"structured-reference":if(this.target_address){let l=this.model.ResolveStructuredReference(n,this.target_address);l&&a.push(l)}else console.info("target address not set");break;case"identifier":{let l=this.model.GetName(n.name,this.view.active_sheet.id);l?.type==="range"&&(l.area.count===1?a.push({type:"address",...l.area.start,label:n.name,position:n.position,id:n.id}):a.push({type:"range",start:{type:"address",position:n.position,id:n.id,label:n.name,...l.area.start},end:{type:"address",position:n.position,label:n.name,id:n.id,...l.area.end},label:n.name,position:n.position,id:n.id}));break}}a.sort((n,l)=>n.position-l.position);let i=[],s=new Set,o=new Map;for(let n of a){let l=this.model.AddressToLabel(n),h=$(n)?new k(n):new k(n.start,n.end);s.has(l)||(i.push(h),s.add(l)),o.set(n.label,l)}return this.UpdateReferences(t,i),o}UpdateReferences(t,r=[]){t.node.dataset.references=JSON.stringify(r.map(a=>this.model.AddressToLabel(a))),t.references=r}UpdateText(t,r={}){let a=t.node,i=a.textContent||"",s=le.GetInstance(a.ownerDocument);if(this.text_formula=i[0]==="=",this.active_editor&&!this.assume_formula&&(this.active_editor.node.spellcheck=!this.text_formula,!this.text_formula)||i===t.formatted_text)return;let[o,n]=this.SubstringToCaret2(a),l=o.length,h=n.length;if(l===0&&h===0&&(h=i.length),!i)this.UpdateReferences(t);else{let c=this.parser.Parse(i);if(c.expression){let u=this.UpdateDependencies(t,c),m=i[0]==="="?1:0,f=0,p,b,w=0,y,g=s.Fragment(),v=(x,_="text",C="",S=!1)=>{let R=s.Text(x);if((S||(l>w||l===0&&w===0)&&l<=w+x.length)&&(p={offset:l-w,node:R}),h>w&&h<=w+x.length&&(b={offset:h-w,node:R}),_!=="text"){let M=s.Create("span",_);C&&(M.dataset.reference=C),M.appendChild(R),g.appendChild(M)}else g.appendChild(R);y=R,w+=x.length};this.parser.Walk(c.expression,x=>{if(x.type==="missing"||x.type==="group"||x.type==="dimensioned")return!0;let _=x.position+m,C=i.substring(f,_),S="",R=x.type,M="";switch(x.type){case"identifier":S=i.substring(_,_+x.name.length),M=u.get(x.name)||"";break;case"call":S=i.substring(_,_+x.name.length);break;case"literal":if(typeof x.value=="string")S=i.substring(_,_+x.value.length+2),R="string";else return!1;break;case"address":case"range":case"structured-reference":M=u.get(x.label)||"???",S=r.rewrite_addresses?x.label:i.substring(_,_+x.label.length);break;default:return!0}return v(C),v(S,R,M),f=_+S.length,x.type!=="range"}),f<i.length&&v(i.substring(f)),p||(y?p={node:y,offset:(y.data||"").length}:v("",void 0,"",!0)),a.textContent="",a.appendChild(g),p&&!r.format_only&&a===this.active_editor?.node&&this.SetCaret(p,b)}}t.formatted_text=i;let d=this.autocomplete_matcher;d&&Promise.resolve().then(()=>{let c=d.Exec({text:i,cursor:n.length}),u=this.NodeAtIndex(c.completions?.length?c.position||0:c.function_position||0);this.Autocomplete(c,u)})}NodeAtIndex(t){let r=this.active_editor?.node.childNodes||[];for(let a=0;a<r.length;a++){let i=r[a].textContent?.length||0;if(i>t)return r[a];t-=i}}AcceptAutocomplete(t){if(!this.active_editor)return;let r;if(t.data&&t.data.completions){for(let h of t.data.completions)if(h.name.toLowerCase()===t.value?.toLowerCase()){r=h.type;break}}let a=t.data?.position||0,i=a+(t.data?.token?.length||0),s=r==="token"?t.value:t.value+"(",o=this.active_editor.node.textContent||"",n=o.substring(0,a)+s,l=n.length;n+=o.substring(i),this.active_editor.node.textContent=n,this.SetCaret({node:this.active_editor.node,offset:l}),this.autocomplete?.Hide(),this.UpdateText(this.active_editor),this.UpdateColors()}Autocomplete(t,r){if(!this.container_node||!this.autocomplete)return;let a;r?.nodeType===Node.ELEMENT_NODE?a=r.getBoundingClientRect():a=this.container_node.getBoundingClientRect();let i=new ie(Math.round(a.left),Math.round(a.top),a.width,a.height);this.autocomplete.Show(this.AcceptAutocomplete.bind(this),t,i)}SubstringToCaret2(t,r=!1){let a=["",""];if(!r&&t!==t.ownerDocument.activeElement||t!==this.active_editor?.node)return a;let i=t.ownerDocument.defaultView,s=[!1,!1],o=(l,h)=>{if(l===h.startContainer&&l===h.endContainer&&!(l instanceof i.Text)){s[0]=s[1]=!0,a[0]+=l.textContent,a[1]+=l.textContent;return}if(l===h.startContainer&&(a[0]+=(l.textContent||"").substring(0,h.startOffset),s[0]=!0),l===h.endContainer&&(a[1]+=(l.textContent||"").substring(0,h.endOffset),s[1]=!0),!(s[0]&&s[1])){if(l instanceof i.Text){let d=l.textContent||"";s[0]||(a[0]+=d),s[1]||(a[1]+=d)}else if(l.hasChildNodes()){for(let d of Array.from(l.childNodes))if(o(d,h),s[0]&&s[1])return}}},n=i.getSelection();if(n?.rangeCount??!1){let l=n?.getRangeAt(0);l&&o(t,l)}return a}},Lo=typeof navigator>"u"?"":navigator.appVersion,Te=typeof navigator>"u"?"":navigator.userAgent,Eo=class{is_edge=/Edge/.test(Lo);is_ipad=/iPad|iPhone/.test(Te);is_android=/android|samsung/i.test(Te);is_mobile=this.is_ipad||this.is_android;is_firefox=/firefox/i.test(Te);is_safari=/safari/i.test(Te)&&!/edg/i.test(Te);is_mac=/macintosh/i.test(Te);is_chrome=/Chrome/i.test(Te);is_windows=/win64|win32|windows\s+nt/i.test(Te);is_modern=!this.is_edge&&!(this.is_firefox&&this.is_android)&&/webkit|firefox/i.test(Te)},Fo={is_edge:!1,is_ipad:!1,is_android:!1,is_firefox:!1,is_safari:!1,is_mac:!1,is_chrome:!1,trident:!1,is_windows:!1,is_modern:!0,is_node:!0,is_mobile:!1},ae=typeof navigator>"u"?Fo:new Eo,No=class extends aa{constructor(e,t,r,a,i){super(r,a,i),this.container=e,this.theme=t,this.container_node=e.querySelector(".treb-overlay-container"),this.edit_node=this.container_node.querySelector(".treb-overlay-editor"),ae.is_firefox&&this.edit_node.classList.add("firefox"),this.edit_node.inputMode="none";let s={node:this.edit_node};this.nodes=[s],this.active_editor=s,this.RegisterListener(s,"input",o=>{if(o instanceof InputEvent&&o.isComposing)return;if(!o.isTrusted){this.reset_selection=!0;return}this.reset_selection&&this.Publish({type:"reset-selection"});let n=this.edit_node.firstChild;n&&n.tagName==="BR"&&this.edit_node.removeChild(n),this.editing&&(this.UpdateText(s),this.UpdateColors())}),this.RegisterListener(s,"keyup",o=>{o.isComposing||!this.editing||this.autocomplete&&this.autocomplete.HandleKey("keyup",o).handled}),this.edit_inset=this.container_node.querySelector(".treb-overlay-inset"),this.ClearContents()}internal_selection={target:{row:0,column:0},area:new k({row:0,column:0})};get selection(){return this.internal_selection}set selection(e){if(e){let t=e.target||e.area.start;this.internal_selection={target:{row:t.row,column:t.column},area:new k(e.area.start,e.area.end)}}else{let t={row:0,column:0};this.internal_selection={target:t,area:new k(t)}}}edit_style;reset_selection=!1;edit_node;container_node;edit_inset;scale=1;internal_editing=!1;get editing(){return this.internal_editing}set editing(e){this.internal_editing!==e&&(this.internal_editing=e,e?(this.container_node.style.opacity="1",this.container_node.style.pointerEvents="initial"):(this.container_node.style.opacity="0",this.container_node.style.pointerEvents="none"))}UpdateCaption(e=""){this.edit_node.setAttribute("aria-label",e)}Focus(e=""){this.edit_node!==this.edit_node.ownerDocument.activeElement&&(this.container_node.style.top=`${this.container.scrollTop+this.view.active_sheet.header_offset.y}px`,this.container_node.style.left=`${this.container.scrollLeft+this.view.active_sheet.header_offset.x}px`),this.edit_node.focus(),this.UpdateCaption(e)}CloseEditor(){this.editing=!1,this.reset_selection=!1,this.ClearContents(),this.edit_node.spellcheck=!0,this.autocomplete?.Hide(),this.active_cell=void 0}ClearContents(){ae.is_firefox?this.edit_node.innerHTML="<span></span>":this.edit_node.textContent=""}Edit(e,t,r,a,i,s){this.Publish({type:"start-editing",editor:"ice"}),this.active_cell=r,this.target_address={...e.target},this.reset_selection=!1;let o=JSON.parse(JSON.stringify(r.style||{}));this.edit_style=s,s?.font_face&&(o.font_face=s.font_face);let n=H.CompositeFont(this.theme.grid_cell_font_size,o,this.scale,this.theme);switch(this.edit_node.style.font=n.font,n.variants?this.edit_node.style.fontVariant=n.variants:this.edit_node.style.fontVariant="",this.edit_node.style.color=N(this.theme,o.text,1),this.edit_inset.style.backgroundColor=N(this.theme,o.fill,0),o.horizontal_align){case"right":this.container_node.classList.remove("align-center","align-left"),this.container_node.classList.add("align-right");break;case"center":this.container_node.classList.remove("align-right","align-left"),this.container_node.classList.add("align-center");break;default:this.container_node.classList.remove("align-right","align-center"),this.container_node.classList.add("align-left");break}this.edit_node.style.paddingBottom=`${Math.max(0,(self.devicePixelRatio||1)-1)}px`;let l=a?.toString()||"";l&&l[0]==="="&&(this.edit_node.spellcheck=!1),t.ApplyStyle(this.container_node);let h=ae.is_mac?0:.5;if(this.edit_node.style.bottom=h.toFixed(2)+"px",this.autocomplete?.ResetBlock(),this.selection=e,typeof a<"u"){let d=l[0]!=="="&&l[l.length-1]==="%",c=l.length;this.edit_node.textContent=l,this.SetCaret({node:this.edit_node,offset:c-(d?1:0)})}this.editing=!0,Promise.resolve().then(()=>{this.active_editor&&(this.active_editor.formatted_text=void 0,this.UpdateText(this.active_editor),this.UpdateColors()),!i&&a!==void 0&&this.Publish({type:"update",text:a.toString(),dependencies:this.composite_dependencies})})}GetEditState(){let e=this.active_editor?.node?.textContent||"",t="";return this.active_editor?.node&&(t=this.SubstringToCaret2(this.active_editor.node,!0)[0]),{text:e,substring:t}}HandleKeyDown(e){if(this.editing){if(this.autocomplete){let t=this.autocomplete.HandleKey("keydown",e);if(t.accept&&this.AcceptAutocomplete(t),t.handled)return"handled"}switch(e.key){case"Enter":case"Tab":return"commit";case"Escape":case"Esc":return"discard";case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Up":case"Down":case"Left":case"Right":return this.selecting?void 0:"commit"}return"handled"}}UpdateScale(e){this.scale=e}},Ca=new Map,ot,Rt=(e,t)=>{let r=e,a=Ca.get(r);return a||(a=Po(e,t),Ca.set(r,a),a)},Po=(e,t)=>{ot||typeof document<"u"&&(ot=document.createElement("canvas")),ot&&(t?ot.style.fontVariant=t:ot.style.fontVariant="");let r=ot?.getContext("2d",{alpha:!1});if(!r)throw new Error("invalid context");r.textBaseline="alphabetic",r.textAlign="center",r.font=e;let a=r.measureText("("),i=a.actualBoundingBoxRight+a.actualBoundingBoxLeft;a=r.measureText("#");let s=a.actualBoundingBoxRight+a.actualBoundingBoxLeft;return a=r.measureText("Mljy!"),{paren:i,hash:s,ascent:a.fontBoundingBoxAscent,descent:a.fontBoundingBoxDescent,height:a.fontBoundingBoxAscent+a.fontBoundingBoxDescent}},Uo="  ",Io=class{constructor(e,t,r,a,i){this.theme=e,this.layout=t,this.model=r,this.view=a,this.options=i,this.buffer_canvas=t.buffer_canvas,this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;let s=this.buffer_canvas.getContext("2d",{alpha:!1});if(s){let o=this.layout.dpr;this.buffer_context=s,this.buffer_context.setTransform(o,0,0,o,0,0),this.buffer_context.textAlign="left",this.buffer_context.textBaseline="alphabetic"}}cell_edge_buffer=4;overflow_areas=[];buffer_canvas;buffer_context;buffer_canvas_size={width:256,height:256};FlushOverflows(){let e=this.view.active_sheet.cells;for(let t of e.Iterate())t.renderer_data?.overflowed&&(t.renderer_data=void 0,t.render_clean[this.view.view_index]=!1);for(let t of this.overflow_areas)t.tile.dirty=!0;this.overflow_areas=[]}MeasureText(e,t,r){let a=this.layout.grid_tiles[0][0],i=r??this.layout.scale,s=e.style||{},o=H.CompositeFont(this.theme.grid_cell_font_size,s,i,this.theme),n=Rt(o.font,o.variants),l={base:o.font,strong:H.CompositeFont(this.theme.grid_cell_font_size,{...s,bold:!0},i,this.theme).font,emphasis:H.CompositeFont(this.theme.grid_cell_font_size,{...s,italic:!0},i,this.theme).font,strong_emphasis:H.CompositeFont(this.theme.grid_cell_font_size,{...s,bold:!0,italic:!0},i,this.theme).font};o.variants?a.style.fontVariant=o.variants:a.style.fontVariant="";let h=a.getContext("2d",{alpha:!1});if(!h)throw new Error("context failed");let d=this.PrepText(h,l,e,t),c=d.width,u=n.height*d.strings.length;return{width:c,height:u}}EnsureBuffer(e=0,t=0,r=0){let a=this.layout.dpr;if(e=e*a,t=t*a,r=r*a,e>this.buffer_canvas_size.width||t>this.buffer_canvas_size.height){this.buffer_canvas_size.width=Math.max(Math.ceil(e/256)*256,this.buffer_canvas_size.width),this.buffer_canvas_size.height=Math.max(Math.ceil(t/256)*256,this.buffer_canvas_size.height),this.buffer_canvas.width=this.buffer_canvas_size.width,this.buffer_canvas.height=this.buffer_canvas_size.height;let i=this.buffer_canvas.getContext("2d",{alpha:!1});i&&(this.buffer_context=i,this.buffer_context.textAlign="left",this.buffer_context.textBaseline="alphabetic")}this.buffer_context.setTransform(a,0,0,a,r,0)}OverflowDirty(e=!1){let t=[];for(let r of this.overflow_areas){let a=r.area.start.row,i=e;if(!i)for(let s=r.area.start.column;!i&&s<=r.area.end.column;s++){let o=this.view.active_sheet.cells.GetCell({row:a,column:s},!1);i=!!(o&&!o.render_clean[this.view.view_index])}if(i){for(let s=r.area.start.column;s<=r.area.end.column;s++){let o=this.view.active_sheet.cells.GetCell({row:a,column:s},!1);o&&(o.render_clean[this.view.view_index]=!1,o.renderer_data&&o.renderer_data.overflowed&&(o.renderer_data=void 0))}r.tile.dirty=!0}else t.push(r)}this.overflow_areas=t}RenderCorner(){let e=this.layout.corner_canvas.getContext("2d",{alpha:!1});if(!e)throw new Error("invalid context");let t=H.CompositeFont(this.theme.grid_cell_font_size,this.theme.headers||{},this.layout.scale,this.theme),r=Rt(t.font,t.variants),a=this.layout.dpr,i=this.layout.header_offset,s=i.x;for(let n=0;n<this.view.active_sheet.freeze.columns;n++)s+=this.layout.ColumnWidth(n);let o=i.y;for(let n=0;n<this.view.active_sheet.freeze.rows;n++)o+=this.layout.RowHeight(n);e.setTransform(a,0,0,a,0,0),e.fillStyle=this.theme.headers?.fill?N(this.theme,this.theme.headers.fill):"",e.fillRect(0,0,s,i.y),e.fillRect(0,0,i.x,o),e.strokeStyle=this.theme.headers_grid_color||"",e.beginPath(),e.moveTo(i.x-.5,0),e.lineTo(i.x-.5,i.y),e.moveTo(0,i.y-.5),e.lineTo(i.x,i.y-.5),e.stroke(),!(!this.view.active_sheet.freeze.columns&&!this.view.active_sheet.freeze.rows)&&(e.strokeStyle=this.theme.grid_color||"",e.beginPath(),o!==i.y&&(e.moveTo(i.x-.5,i.y),e.lineTo(i.x-.5,o)),s!==i.x&&(e.moveTo(i.x,i.y-.5),e.lineTo(s,i.y-.5)),e.stroke(),e.strokeStyle=this.theme.headers_grid_color||"",e.textAlign="center",e.textBaseline="middle",e.font=t.font,e.fillStyle=N(this.theme,this.theme.headers?.text),this.view.active_sheet.freeze.rows&&this.layout.header_offset.x>1&&(e.setTransform(a,0,0,a,0,0),e.translate(0,i.y),e.beginPath(),e.moveTo(0,0-.5),e.lineTo(i.x,0-.5),e.stroke(),this.RenderRowLabels(e,0,this.view.active_sheet.freeze.rows-1,r.height)),this.view.active_sheet.freeze.columns&&this.layout.header_offset.y>1&&(e.setTransform(a,0,0,a,0,0),e.translate(i.x,0),e.beginPath(),e.moveTo(0-.5,0),e.lineTo(0-.5,i.y),e.stroke(),this.RenderColumnLabels(e,0,this.view.active_sheet.freeze.columns-1)))}RenderColumnLabels(e,t,r){let a=this.layout.header_offset.y;if(!(a<=1)){for(e.fillStyle=N(this.theme,this.theme.headers?.text,0),e.beginPath();t<=r;t++){let i=this.layout.ColumnWidth(t),s=k.ColumnToLabel(t),o=e.measureText(s);i>o.width&&e.fillText(s,i/2,a/2+1),e.moveTo(i-.5,0),e.lineTo(i-.5,a),e.translate(i,0)}e.stroke()}}RenderRowLabels(e,t,r,a){let i=this.layout.header_offset.x;if(!(i<=1)){for(e.fillStyle=N(this.theme,this.theme.headers?.text,0),e.beginPath();t<=r;t++){let s=this.layout.RowHeight(t);s>=a*1.2&&e.fillText(`${t+1}`,i/2,s/2+1),e.moveTo(0,s-.5),e.lineTo(i,s-.5),e.translate(0,s)}e.stroke()}}RenderHeaders(e,t=!1){let r=this.layout.dpr,a=this.layout.header_offset,i=H.CompositeFont(this.theme.grid_cell_font_size,this.theme.headers||{},this.layout.scale,this.theme),s=Rt(i.font,i.variants);for(let o=e.start.column;o<=e.end.column;o++){let n=this.layout.column_header_tiles[o];if(n.dirty||t){let l=n.getContext("2d",{alpha:!1});if(!l)continue;l.setTransform(r,0,0,r,0,0),l.textAlign="center",l.textBaseline="middle",l.font=i.font,i.variants?n.style.fontVariant=i.variants:n.style.fontVariant="",l.fillStyle=this.theme.headers?.fill?N(this.theme,this.theme.headers.fill):"",l.fillRect(0,0,n.logical_size.width,this.layout.header_offset.y),l.strokeStyle=this.theme.headers_grid_color||"",l.beginPath(),l.moveTo(0,a.y-.5),l.lineTo(n.logical_size.width,a.y-.5),l.stroke(),l.strokeStyle=this.theme.headers_grid_color||"",this.RenderColumnLabels(l,n.first_cell.column,n.last_cell.column),n.dirty=!1}}for(let o=e.start.row;o<=e.end.row;o++){let n=this.layout.row_header_tiles[o];if(n.dirty||t){let l=n.getContext("2d",{alpha:!1});if(!l)continue;l.fillStyle=this.theme.headers?.fill?N(this.theme,this.theme.headers.fill):"",l.setTransform(r,0,0,r,0,0),l.textAlign="center",l.textBaseline="middle",l.font=i.font,i.variants?n.style.fontVariant=i.variants:n.style.fontVariant="",l.fillRect(0,0,this.layout.header_offset.x,n.logical_size.height),l.strokeStyle=this.theme.headers_grid_color||"",l.beginPath(),l.moveTo(a.x-.5,0),l.lineTo(a.x-.5,n.logical_size.height),l.stroke(),l.strokeStyle=this.theme.headers_grid_color||"",this.RenderRowLabels(l,n.first_cell.row,n.last_cell.row,s.height),n.dirty=!1}}(this.view.active_sheet.freeze.rows||this.view.active_sheet.freeze.columns)&&this.RenderCorner()}CopyToAdjacent(e,t,r,a,i,s,o){let n=this.layout.AdjacentTile(e,a,r);if(!n)return;let l=i,h=s;r>0?l=i-(e.pixel_end.x-e.pixel_start.x)*t:r<0&&(l=i+(n.pixel_end.x-n.pixel_start.x)*t),a>0&&(h=s-(e.pixel_end.y-e.pixel_start.y)*t);let d=n.getContext("2d",{alpha:!1});d&&(d.setTransform(t,0,0,t,l,h),d.drawImage(this.buffer_canvas,0,0,(o.width||0)*t,(o.height||0)*t,o.left||0,0,o.width||0,o.height||0))}Render(e){let t=e.getContext("2d",{alpha:!1});if(!t)return;t.textBaseline="alphabetic";let r=this.layout.dpr;t.setTransform(r,0,0,r,0,0);let a=0,i=0;for(let n=e.first_cell.column;n<=e.last_cell.column;n++){let l=this.layout.ColumnWidth(n);if(l){i=0;for(let h=e.first_cell.row;h<=e.last_cell.row;h++){let d=this.layout.RowHeight(h);if(d){t.setTransform(r,0,0,r,a,i);let c=this.view.active_sheet.CellData({row:h,column:n});if(e.needs_full_repaint||!c.render_clean[this.view.view_index]){let u=this.RenderCell(e,c,t,{row:h,column:n},l,d,e.pixel_start.x+a,e.pixel_start.y+i);u.tile_overflow_right&&this.CopyToAdjacent(e,r,1,0,a,i,u),u.tile_overflow_left&&this.CopyToAdjacent(e,r,-1,0,a,i,u),u.tile_overflow_bottom&&this.CopyToAdjacent(e,r,0,1,a,i,u)}}i+=d*r}a+=l*r}}if(!this.view.active_sheet.freeze.rows&&!this.view.active_sheet.freeze.columns)return;let s=0,o=0;if(e.first_cell.row<=this.view.active_sheet.freeze.rows-1)for(let n=e.first_cell.row;n<this.view.active_sheet.freeze.rows&&n<=e.last_cell.row;n++)s+=this.layout.RowHeight(n);if(e.first_cell.column<=this.view.active_sheet.freeze.columns-1)for(let n=e.first_cell.column;n<this.view.active_sheet.freeze.columns&&n<=e.last_cell.column;n++)o+=this.layout.ColumnWidth(n);if(s){let n=this.layout.frozen_row_tiles[e.tile_position.column];if(!n)throw new Error("can't find matching header tile");let l=n.getContext("2d",{alpha:!0});if(!l)throw new Error("header context failed");l.setTransform(r,0,0,r,0,0),l.drawImage(e,0,0,e.logical_size.width*r,s*r,0,0,e.logical_size.width,s)}if(o){let n=this.layout.frozen_column_tiles[e.tile_position.row];if(!n)throw new Error("can't find matching header tile");let l=n.getContext("2d",{alpha:!0});if(!l)throw new Error("header context failed");l.setTransform(r,0,0,r,0,0),l.drawImage(e,0,0,o*r,e.logical_size.height*r,0,0,o,e.logical_size.height)}if(o&&s){let n=this.layout.corner_canvas.getContext("2d",{alpha:"false"});if(!n)throw new Error("corner context failed");n.setTransform(r,0,0,r,this.layout.header_offset.x*r,this.layout.header_offset.y*r),n.drawImage(e,0,0,o*r,s*r,0,0,o,s)}}PrepText(e,t,r,a){let i=[],s=r.style||{},o,n=0;if(r.rendered_type===4){let u=r.calculated_type?r.calculated:r.value;r.formatted=u?this.model.language_model?.boolean_true||"TRUE":this.model.language_model?.boolean_false||"FALSE"}let l,h=r.editing?"":r.formatted;Array.isArray(h)&&(h=h.filter(u=>u.flag!==8));let d="",c;if(s.indent){for(let u=0;u<s.indent;u++)d+=Uo;c=s.horizontal_align,c||(c=r.type===3||r.calculated_type===3||r.type===7||r.calculated_type===7?"right":"left")}if(Array.isArray(h)){d&&(c==="right"?h.push({text:d,flag:8}):(c==="left"||typeof c>"u")&&h.unshift({text:d,flag:8}));for(let u of h){if(u.flag===6){l=u.text;continue}let m=e.measureText(u.text).width,f={width:m,text:u.text,hidden:u.flag===1};i.push(f),u.flag===2?o=f:n+=m}if(o){let u=o.text,m=o.width,f=a-n-2*this.cell_edge_buffer;if(o.width=Math.max(0,f),f>0){let p=Math.floor(f/m);for(let b=1;b<p;b++)o.text+=u;n=a-2*this.cell_edge_buffer}else o.text=""}return{strings:[i],format:l,width:n}}else if(h){r.type===2&&h[0]==="'"&&(h=h.slice(1));let u;this.options.markdown?u=or.instance.Parse(h):(u=or.instance.Dummy(h),e.font=t.base);let m=0,f=a-2*this.cell_edge_buffer,p=[];if(s.wrap){let b=d&&s.horizontal_align!=="center"?e.measureText(d).width:0;f-=b;for(let w of u){for(let g=1;g<w.length;g++){let v=w[g].text.match(/^(\s+)/);v&&(w[g-1].text+=v[1],w[g].text=w[g].text.replace(/^\s+/,""))}let y=[];for(let g of w){this.options.markdown&&(g.strong&&g.emphasis?e.font=t.strong_emphasis:g.strong?e.font=t.strong:g.emphasis?e.font=t.emphasis:e.font=t.base);let v=g.text.match(/\S+\s*/g);if(v&&v.length)for(let x of v){let _=e.measureText(x.trim()).width,C=e.measureText(x).width;y.push({part:g,text:x,trimmed:_,width:C})}}for(;y.length;){let g=y.shift(),v=[g],x=g.trimmed;for(;x<f&&y.length;){let C=y[0],S=x-g.trimmed+g.width+C.trimmed;if(S>=f)break;g=C,v.push(C),x=S,y.shift(),m=Math.max(m,x)}g.text=g.text.trim(),g.width=g.trimmed,m=Math.max(m,g.width);let _=v.map(C=>({...C.part,hidden:!1,width:C.width,text:C.text}));s.indent&&(c==="right"?_.push({text:d,hidden:!1,width:b}):c==="left"&&_.unshift({text:d,hidden:!1,width:b})),p.push(_)}}}else for(let b of u){let w=[];s.indent&&(c==="right"?b.push({text:d}):c==="left"&&b.unshift({text:d}));let y=0;for(let g of b){this.options.markdown&&(g.strong&&g.emphasis?e.font=t.strong_emphasis:g.strong?e.font=t.strong:g.emphasis?e.font=t.emphasis:e.font=t.base);let v=e.measureText(g.text).width;y+=v,w.push({...g,hidden:!1,width:v})}m=Math.max(m,y),p.push(w)}return{strings:p,width:m}}return{strings:[[{text:"",hidden:!1,width:0}]],width:0}}ResolveColors(e){let t={...e};return t.text={text:N(this.theme,e.text,1)},t}RenderCellBorders(e,t,r,a=0,i=0,s=0,o=0){let n=this.view.active_sheet.SurroundingStyle(e,this.theme.table),l=N(this.theme,n[8].fill);l&&(t.fillStyle=l,t.fillRect(a+0,i-1,s,1)),l=N(this.theme,n[4].fill),l&&(t.fillStyle=l,t.fillRect(a-1,i,1,o)),l=N(this.theme,r.fill),l&&(t.fillStyle=l,t.fillRect(a-1,i-1,s+1,o+1)),l=N(this.theme,n[6].fill),l&&(t.fillStyle=l,t.fillRect(a+s-1,i-1,1,o+1)),l=N(this.theme,n[2].fill),l&&(t.fillStyle=l,t.fillRect(a-1,i+o-1,s+1,1)),n[6].border_top&&!n[6].border_left&&(t.fillStyle=N(this.theme,n[6].border_top_fill,1),t.fillRect(a+s-1,i-2+n[6].border_top,1,1)),n[9].border_left&&(t.fillStyle=N(this.theme,n[9].border_left_fill,1),t.fillRect(a+s-1,i-1,1,1)),n[9].border_bottom&&(t.fillStyle=N(this.theme,n[9].border_bottom_fill,1),t.fillRect(a+s-1,i-2+n[9].border_bottom,1,1)),n[4].border_top&&!n[4].border_right&&(t.fillStyle=N(this.theme,n[4].border_right_fill,1),t.fillRect(a-1,i-2+n[4].border_top,1,1)),n[7].border_right&&(t.fillStyle=N(this.theme,n[7].border_right_fill,1),t.fillRect(a-1,i-1,1,1)),n[7].border_bottom&&(t.fillStyle=N(this.theme,n[7].border_bottom_fill,1),t.fillRect(a-1,i-2+n[7].border_bottom,1,1)),n[6].border_bottom&&!n[6].border_left&&(t.fillStyle=N(this.theme,n[6].border_bottom_fill,1),t.fillRect(a+s-1,i+o-n[6].border_bottom,1,1)),n[3].border_left&&(t.fillStyle=N(this.theme,n[3].border_left_fill,1),t.fillRect(a+s-1,i+o-1,1,1)),n[3].border_top&&(t.fillStyle=N(this.theme,n[3].border_top_fill,1),t.fillRect(a+s-1,i+o-n[3].border_top,1,1)),n[4].border_bottom&&!n[4].border_right&&(t.fillStyle=N(this.theme,n[4].border_bottom_fill,1),t.fillRect(a-1,i+o-n[4].border_bottom,1,1)),n[1].border_right&&(t.fillStyle=N(this.theme,n[1].border_right_fill,1),t.fillRect(a-1,i+o-1,1,1)),n[1].border_top&&(t.fillStyle=N(this.theme,n[1].border_top_fill,1),t.fillRect(a-1,i+o-n[1].border_top,1,1)),n[8].border_bottom&&(t.fillStyle=N(this.theme,n[8].border_bottom_fill,1),n[8].border_bottom===2&&(t.fillRect(a-1,i-2,s+1,1),t.fillRect(a-1,i-0,s+1,1),t.fillStyle=N(this.theme,n[8].fill)||N(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(a-1,i-1,s+1,1)),n[4].border_right&&(t.fillStyle=N(this.theme,n[4].border_right_fill,1),t.fillRect(a-1,i-1,1,o+1)),n[6].border_left&&(t.fillStyle=N(this.theme,n[6].border_left_fill,1),t.fillRect(a+s-1,i-1,1,o+1)),n[2].border_top&&(t.fillStyle=N(this.theme,n[2].border_top_fill,1),n[2].border_top===2&&(t.fillRect(a-1,i+o-2,s+1,1),t.fillRect(a-1,i+o-0,s+1,1),t.fillStyle=N(this.theme,n[2].fill)||N(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(a-1,i+o-1,s+1,1)),r.border_top&&(t.fillStyle=N(this.theme,r.border_top_fill,1),r.border_top===2&&(t.fillRect(a-1,i-2,s+1,1),t.fillRect(a-1,i+0,s+1,1),t.fillStyle=N(this.theme,r.fill)||N(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(a-1,i-1,s+1,1)),r.border_left&&(t.fillStyle=N(this.theme,r.border_left_fill,1),t.fillRect(a-1,i-1,1,o+1)),r.border_right&&(t.fillStyle=N(this.theme,r.border_right_fill,1),t.fillRect(a+s-1,i-1,1,o+1)),r.border_bottom&&(t.fillStyle=N(this.theme,r.border_bottom_fill,1),r.border_bottom===2&&(t.fillRect(a-1,i+o-2,s+1,1),t.fillRect(a-1,i+o+0,s+1,1),t.fillStyle=N(this.theme,r.fill)||N(this.theme,this.theme.grid_cell?.fill,0)||"#fff"),t.fillRect(a-1,i+o-1,s+1,1))}PaintBackgroundImage(e,t,r,a,i,s,o=0,n=0,l=0){if(!t.width||!t.height)return;let h=(this.layout.scale||1)*this.layout.dpr,d=r/h%t.width,c=a/h%t.height,u=i/h,m=s/h,f=d+u>t.width,p=c+m>t.height;f&&e.drawImage(t,d-t.width,c,u,m,o,n,i-l,s-l),p&&e.drawImage(t,d,c-t.height,u,m,o,n,i-l,s-l),f&&p&&e.drawImage(t,d-t.width,c-t.height,u,m,o,n,i-l,s-l),e.drawImage(t,d,c,u,m,o,n,i-l,s-l)}RenderCellBackground(e,t,r,a,i,s,o=0,n=0){if(r.fillStyle=this.theme.grid_color,r.fillRect(0,0,i,s),this.view.active_sheet.image)this.PaintBackgroundImage(r,this.view.active_sheet.image,o,n,i,s,0,0,1);else{let l=N(this.theme,a.fill);l?(r.fillStyle=l,r.fillRect(0,0,i-1,s-1)):(r.fillStyle=N(this.theme,this.theme.grid_cell?.fill,0)||"#fff",r.fillRect(0,0,i-1,s-1))}this.RenderCellBorders(t,r,a,0,0,i,s),e&&(r.fillStyle=this.theme.note_marker_color,r.beginPath(),r.moveTo(i-2,1),r.lineTo(i-2-8,1),r.lineTo(i-2,9),r.lineTo(i-2,1),r.fill())}RenderCell(e,t,r,a,i,s,o=0,n=0){let l={},h=!t.render_clean[this.view.view_index];if(t.render_clean[this.view.view_index]=!0,e.needs_full_repaint&&t.renderer_data?.overflowed)return{};let d=t.style?{...t.style}:{};if(t.table&&(d=this.view.active_sheet.CellStyleData(a,t.table.theme||this.theme.table)||{}),t.merge_area)if(a.row===t.merge_area.start.row&&a.column===t.merge_area.start.column){for(let z=t.merge_area.start.column+1;z<=t.merge_area.end.column;z++)i+=this.layout.ColumnWidth(z);for(let z=t.merge_area.start.row+1;z<=t.merge_area.end.row;z++)s+=this.layout.RowHeight(z);if(t.merge_area.count>1){let z=this.view.active_sheet.CellStyleData(t.merge_area.end);z&&(d.border_bottom=z.border_bottom,d.border_right=z.border_right,d.border_bottom_fill=z.border_bottom_fill,d.border_right_fill=z.border_right_fill)}t.merge_area.end.column>e.last_cell.column&&(l.tile_overflow_right=!0),t.merge_area.end.row>e.last_cell.row&&(l.tile_overflow_bottom=!0),(l.tile_overflow_bottom||l.tile_overflow_right)&&this.overflow_areas.push({tile:e,head:{...a},area:new k(t.merge_area.start,t.merge_area.end)})}else return{};let c=!!t.hyperlink;if(t.render_function){this.RenderCellBackground(!!t.note,a,r,d,i,s),r.strokeStyle=r.fillStyle=N(this.theme,d.text,1);let z=this.ResolveColors(d);if(t.render_function.call(void 0,{width:i,height:s,context:r,cell:t,style:z,scale:this.layout.scale||1}).handled)return l}let u=H.CompositeFont(this.theme.grid_cell_font_size,d,this.layout.scale,this.theme),m={base:u.font,strong:H.CompositeFont(this.theme.grid_cell_font_size,{...d,bold:!0},this.layout.scale,this.theme).font,emphasis:H.CompositeFont(this.theme.grid_cell_font_size,{...d,italic:!0},this.layout.scale,this.theme).font,strong_emphasis:H.CompositeFont(this.theme.grid_cell_font_size,{...d,bold:!0,italic:!0},this.layout.scale,this.theme).font};if(u.variants?e.style.fontVariant=u.variants:e.style.fontVariant="",r.font=m.base,h||!t.renderer_data||t.renderer_data.width!==i||t.renderer_data.height!==s){let z=this.PrepText(r,m,t,i);t.renderer_data={text_data:z,width:i,height:s}}let f=t.renderer_data.text_data,p=f.width>i-2*this.cell_edge_buffer,b=i,w=0,y=!1,g=t.type===3||t.calculated_type===3||t.type===7||t.calculated_type===7||t.type===9||t.calculated_type===9,v=d.horizontal_align;v||(v=g?"right":"left");let x=[];if(p)if(t.type!==3&&t.calculated_type!==3&&!d.wrap&&!t.merge_area){let z=f.width-i+this.cell_edge_buffer,q=0,D=0;v==="center"?q=D=z/2:v==="right"?q=z:D=z;let O=a.column,X=a.column;for(;D>0&&O<this.layout.last_column;){O++;let J={row:a.row,column:O},I=this.view.active_sheet.CellData(J),W=this.layout.ColumnWidth(O);if(D-=W,I&&!I.type&&!I.calculated_type)x.push({address:J,cell:I,grid:new ie(b,0,W,s),background:new ie(b-1,0,W,s-1),border:new ie(b,0,W,s)}),b+=W,I.render_clean[this.view.view_index]=!0,I.renderer_data={overflowed:!0};else{y=!0;break}}for(O>e.last_cell.column&&(l.tile_overflow_right=!0);q>0&&X>=1;){X--;let J={row:a.row,column:X},I=this.view.active_sheet.CellData(J),W=this.layout.ColumnWidth(X);if(q-=W,I&&!I.type&&!I.calculated_type)w-=W,x.push({address:J,cell:I,grid:new ie(w,0,W,s),background:new ie(w,0,W,s-1),border:new ie(w,0,W,s)});else{y=!0;break}}X<e.first_cell.column&&(l.tile_overflow_left=!0),this.overflow_areas.push({head:{...a},tile:e,area:new k({row:a.row,column:X},{row:a.row,column:O})})}else y=!g;let _=!1,C=r;(l.tile_overflow_bottom||l.tile_overflow_left||l.tile_overflow_right)&&(_=!0,l.width=b-w,l.height=s,l.left=w,this.EnsureBuffer(l.width+1,s+1,-w),r=this.buffer_context,r.font=m.base),this.RenderCellBackground(!!t.note,a,r,d,i,s,o,n);for(let z of x)z.cell.style?.fill&&ao(z.cell.style.fill)&&!this.options.grid_over_background?(r.fillStyle=N(this.theme,z.cell.style.fill,0),r.fillRect(z.grid.left,z.grid.top,z.grid.width,z.grid.height)):(r.fillStyle=this.theme.grid_color||"",r.fillRect(z.grid.left,z.grid.top,z.grid.width,z.grid.height),this.view.active_sheet.image?this.PaintBackgroundImage(r,this.view.active_sheet.image,o+z.background.left,n+z.background.top,z.background.width,z.background.height,z.background.left,z.background.top,0):(r.fillStyle=this.theme.grid_cell?.fill?N(this.theme,this.theme.grid_cell.fill,0):"",r.fillRect(z.background.left,z.background.top,z.background.width,z.background.height))),z.cell.style&&this.RenderCellBorders(z.address,r,z.cell.style,z.border.left,z.border.top,z.border.width,z.border.height);let S=Rt(m.base,u.variants);r.lineWidth=1,r.strokeStyle=r.fillStyle=f.format?f.format:N(this.theme,d.text,1),r.beginPath();let R=this.cell_edge_buffer,M=1,A=f.strings.length,P=A*S.height*M;y=(y||P>=s)&&!_,y&&(r.save(),r.beginPath(),r.moveTo(w+1.5,0),r.lineTo(w+1.5,s),r.lineTo(b-1.5,s),r.lineTo(b-1.5,0),r.clip()),r.beginPath();let B=Math.round(s-S.descent-2+-M*S.height*(A-1));switch(d.vertical_align){case"top":B=Math.round(2+S.ascent);break;case"middle":B=Math.round((s-P)/2+S.ascent)-1.5;break}if((t.type===3||t.calculated_type===3||t.type===7||t.calculated_type===7)&&p){let z=Math.floor((i-2*this.cell_edge_buffer)/S.hash),q="";for(let O=0;O<z;O++)q+="#";let D=r.measureText(q).width;v==="center"?R=Math.round((i-D)/2):v==="right"&&(R=i-this.cell_edge_buffer-D),r.fillText(q,R,B)}else{let z=B;for(let q of f.strings){let D=0;for(let I of q)D+=I.width;v==="center"?R=Math.round((i-D)/2):v==="right"&&(R=i-this.cell_edge_buffer-D);let O=z+2.5,X=Math.floor(z-S.ascent*1/3)+.5,J=R;for(let I of q)I.strong&&I.emphasis?r.font=m.strong_emphasis:I.strong?r.font=m.strong:I.emphasis?r.font=m.emphasis:r.font=m.base,I.hidden||(I.text&&r.fillText(I.text,J,z),d.underline&&(r.moveTo(J,O),r.lineTo(J+I.width,O)),(d.strike||I.strike)&&(r.moveTo(J,X),r.lineTo(J+I.width,X)),c&&(I.left=J,I.top=z-S.ascent,I.height=S.height)),J+=I.width;z+=M*S.height}}if(r.stroke(),y)r.restore();else if(_){let z=this.layout.dpr;C.drawImage(this.buffer_canvas,0,0,(l.width||0)*z,s*z,w,0,l.width||0,s)}return l}},Vo=class extends aa{constructor(e,t,r,a,i){super(t,r,i),this.options=a;let s=le.GetInstance(e.ownerDocument),o=e.querySelector(".treb-formula-bar");o.removeAttribute("hidden"),this.address_label_container=o.querySelector(".treb-address-label"),this.address_label=this.address_label_container.firstElementChild,this.InitAddressLabel(),this.container_node=e.querySelector(".treb-editor-container");let n=this.container_node.firstElementChild,l={node:n};if(this.active_editor=l,this.nodes=[l],n&&this.RegisterListener(l,"input",h=>{h.isTrusted&&(this.UpdateText(l),this.UpdateColors())}),this.active_editor.node.spellcheck=!1,this.RegisterListener(l,"focusin",()=>{let h=this.tolled!==void 0;if(this.tolled=void 0,!this.active_editor)return;let d=this.active_editor.node.textContent||"";if(this.shadow&&(this.shadow=!1,d="",this.active_editor.node.textContent=d,this.active_editor.formatted_text=void 0),d[0]==="{"&&d[d.length-1]==="}"&&(d=d.substring(1,d.length-1),this.active_editor.node.textContent=d,this.active_editor.formatted_text=void 0),this.autocomplete?.ResetBlock(),this.UpdateText(this.active_editor),this.UpdateColors(void 0,!0),h){let c=this.NodeAtIndex(d.length-1);c&&this.SetCaret({node:c,offset:(c.textContent||"").length})}this.committed=!1,this.Publish([{type:"start-editing",editor:"formula-bar"},{type:"update",text:d,cell:this.active_cell,dependencies:this.composite_dependencies}]),this.focused_=!0}),this.RegisterListener(l,"focusout",h=>{let d=h.relatedTarget instanceof HTMLElement&&h.relatedTarget.dataset.tollEditor;this.selecting&&console.info("focusout, but selecting..."),this.autocomplete?.Hide();let c=(this.active_editor?this.GetTextContent(this.active_editor.node).join(""):"").trim();if(d){let u=c;this.active_editor?.node&&(u=this.SubstringToCaret2(this.active_editor.node,!0)[0]),this.committed=!0,this.tolled={text:c,substring:u},this.Publish({type:"toll",value:c})}else this.committed?this.Publish([{type:"stop-editing"}]):(this.committed=!0,this.Publish({type:"commit",value:c}));this.Publish([{type:"stop-editing"}]),this.focused_=!1,this.active_editor&&(this.active_editor.node.spellcheck=!1)}),this.RegisterListener(l,"keydown",this.FormulaKeyDown.bind(this)),this.RegisterListener(l,"keyup",this.FormulaKeyUp.bind(this)),this.options.expand_formula_button){let h;this.expand_button=s.Create("button","expand-button",o,{events:{focus:d=>{h=d.relatedTarget instanceof HTMLElement?d.relatedTarget:void 0},click:d=>{d.stopPropagation(),d.preventDefault(),this.active_editor&&(this.active_editor.node.scrollTop=0),o.hasAttribute("expanded")?o.removeAttribute("expanded"):o.setAttribute("expanded",""),h&&h.focus()}}})}}committed=!1;tolled;shadow_=!1;get shadow(){return this.shadow_}set shadow(e){this.shadow_=e,this.active_editor?.node&&(e?this.active_editor.node.classList.add("treb-editor-shadow"):this.active_editor.node.classList.remove("treb-editor-shadow"))}focused_=!1;get focused(){return this.focused_}address_label_container;address_label;button;expand_button;label_update_timer=0;get formula(){return this.active_editor&&this.active_editor.node.textContent||""}set formula(e){this.active_editor&&(this.active_editor.node.textContent=e,this.active_editor.formatted_text=void 0)}get label(){return this.address_label?.textContent||""}set label(e){e.trim().length?(this.address_label.textContent=e,this.label_update_timer||(this.label_update_timer=requestAnimationFrame(()=>{this.label_update_timer=0,this.address_label.scrollWidth>this.address_label.offsetWidth?this.address_label.setAttribute("title",e):this.address_label.removeAttribute("title")}))):(this.address_label.innerHTML="&nbsp;",this.address_label.removeAttribute("title"))}set editable(e){!this.active_editor||!this.container_node||(e?(this.active_editor.node.setAttribute("contenteditable","true"),this.container_node.removeAttribute("locked")):(this.active_editor.node.removeAttribute("contenteditable"),this.container_node.setAttribute("locked","")))}Restore(){let e=this.container_node?.firstElementChild;e&&e.focus()}Release(){this.tolled=void 0}IsElement(e){return e===this.active_editor?.node}IsExpandButton(e){return this.expand_button&&e===this.expand_button}InitAddressLabel(){this.address_label.contentEditable="true",this.address_label.spellcheck=!1,this.address_label.addEventListener("focusin",()=>{let e=this.address_label.ownerDocument;requestAnimationFrame(()=>{let t=e.defaultView.getSelection(),r=e.createRange();r.selectNodeContents(this.address_label),t?.removeAllRanges(),t?.addRange(r)})}),this.address_label.addEventListener("keydown",e=>{if(!e.isComposing)switch(e.key){case"Enter":e.stopPropagation(),e.preventDefault(),this.Publish({type:"address-label-event",text:this.address_label.textContent||void 0});break;case"Esc":case"Escape":e.stopPropagation(),e.preventDefault(),this.Publish({type:"address-label-event"});break}})}GetTextContent(e){let t=e.childNodes,r=[];for(let a=0;a<t.length;a++){let i=t[a];switch(i.nodeType){case Node.ELEMENT_NODE:r.push(...this.GetTextContent(i)),i instanceof Element&&i.tagName==="DIV"&&r.push(`
`);break;case Node.TEXT_NODE:i.nodeValue&&r.push(i.nodeValue);break}}return r}FormulaKeyUp(e){e.isComposing||this.autocomplete&&this.autocomplete.HandleKey("keyup",e).handled}FormulaKeyDown(e){if(!e.isComposing){if(this.autocomplete){let t=this.autocomplete.HandleKey("keydown",e);if(t.accept&&this.AcceptAutocomplete(t),t.handled)return}switch(e.key){case"Enter":case"Tab":{let t=e.key==="Enter"&&e.ctrlKey&&e.shiftKey,r=(this.active_editor?this.GetTextContent(this.active_editor.node).join(""):"").trim();this.committed=!0,this.Publish({type:"commit",value:r,event:e,array:t})}break;case"Escape":case"Esc":this.committed=!0,this.Publish({type:"discard"});break;default:return}e.stopPropagation(),e.preventDefault()}}},ka=class{constructor(e={}){if(this.options=e,this.DOM=le.GetInstance(e.container?.ownerDocument),!this.DOM.doc)throw new Error("invalid context");this.completion_list=this.DOM.Div("treb-cell-editor-ac-list treb-autocomplete",e.container||this.DOM.doc.body,{events:{mousedown:t=>this.ListMouseDown(t),mousemove:t=>this.ListMouseMove(t)}}),this.tooltip=this.DOM.Div("treb-cell-editor-ac-tooltip treb-autocomplete-tooltip",e.container||this.DOM.doc.body)}completion_list_visible=!1;tooltip_visible=!1;last_completion;completion_list;tooltip;selected_index=0;block=!1;autocomplete_data={};callback;active_element;DOM;Hide(){this.tooltip.style.top="-1000px",this.completion_list.style.top="-1000px",this.completion_list_visible=!1,this.tooltip_visible=!1,this.active_element=void 0}SetBlock(){this.block=!0}ResetBlock(){this.block=!1}ListMouseMove(e){let t=e.target;t.tagName==="A"&&t!==this.active_element&&this.active_element&&(this.active_element.classList.remove("selected"),this.active_element=t,this.active_element.classList.add("selected"),this.selected_index=Number(t.dataset.index||"0"),this.last_completion=t.textContent||"")}ListMouseDown(e){e.stopPropagation(),e.preventDefault();let t=e.target;for(;t;){if(t===this.completion_list)return;if(t.tagName==="A")break;t=t.parentElement}t&&(console.info(t),this.callback&&this.callback({handled:!0,accept:!0,value:t.textContent?t.textContent:void 0,data:this.autocomplete_data,click:!0}))}HandleKey(e,t){if(!this.completion_list_visible)return{handled:!1};let r=0,a=!1,i=!1;switch(t.key){case"Up":case"ArrowUp":r=-1;break;case"Down":case"ArrowDown":r=1;break;case"Tab":i=!0;break;case"Escape":case"Esc":a=!0;break;default:return{handled:!1}}if(t.stopPropagation(),t.preventDefault(),e==="keyup")return{handled:!0};if(r){let s=this.completion_list.getBoundingClientRect();this.selected_index+=r,this.selected_index=Math.max(0,this.selected_index);let o=this.completion_list.querySelectorAll("a");this.selected_index=Math.min(this.selected_index,o.length-1);for(let n=0;n<o.length;n++){let l=o[n];if(n===this.selected_index){l.classList.add("selected"),this.active_element=l;let h=l.getBoundingClientRect();h.top<s.top?this.completion_list.scrollBy(0,-h.height):h.bottom>s.bottom&&this.completion_list.scrollBy(0,h.height),this.last_completion=l.textContent||void 0}else l.classList.remove("selected")}return{handled:!0}}else{if(a)return this.block=!0,this.Hide(),{handled:!0};if(i)return{handled:!0,accept:!0,value:this.last_completion,data:this.autocomplete_data}}return{handled:!1}}Show(e,t={},r){if(this.completion_list_visible=!1,this.tooltip_visible=!1,this.autocomplete_data=t,this.callback=e,!this.block)if(t.tooltip?(this.tooltip.innerHTML=t.tooltip+t.arguments+(t.description?`
`+t.description:""),this.tooltip.style.left=r.left+"px",this.options.tooltip_prefer_top?this.tooltip.style.top=r.top-this.tooltip.offsetHeight-5+"px":this.tooltip.style.top=r.bottom+5+"px",this.tooltip_visible=!0):this.tooltip.style.top="-1000px",t.completions&&t.completions.length){this.tooltip.style.top="-1000px",this.selected_index=0,this.completion_list.innerHTML='<ul class="notranslate">'+t.completions.map((o,n)=>(o.name===this.last_completion&&(this.selected_index=n),`<li><a data-index="${n}">${o.name}</a></li>`)).join(`
`)+"<ul>";let a=this.completion_list.offsetHeight,i=!1;this.options.autocomplete_prefer_top?i=r.top>=200:this.DOM.doc?.documentElement&&Math.max(this.DOM.doc.documentElement.clientHeight,this.DOM.view?.innerHeight||0)-r.bottom<200&&(i=!0),i?this.completion_list.style.top=r.top-a-5+"px":this.completion_list.style.top=r.bottom+5+"px",this.completion_list.style.left=r.left+"px";let s=this.completion_list.querySelectorAll("a");this.active_element=s[this.selected_index],s[this.selected_index].classList.add("selected"),this.last_completion=s[this.selected_index].textContent||void 0,this.completion_list.scrollTop=this.active_element.offsetTop,this.completion_list_visible=!0}else this.completion_list.style.top="-1000px"}},$i=(e=>(e[e.Null=0]="Null",e[e.InsertRows=1]="InsertRows",e[e.InsertColumns=2]="InsertColumns",e[e.ResizeRows=3]="ResizeRows",e[e.ResizeColumns=4]="ResizeColumns",e[e.Select=5]="Select",e[e.SetRange=6]="SetRange",e[e.UpdateStyle=7]="UpdateStyle",e[e.UpdateBorders=8]="UpdateBorders",e[e.Indent=9]="Indent",e[e.MergeCells=10]="MergeCells",e[e.UnmergeCells=11]="UnmergeCells",e[e.Clear=12]="Clear",e[e.UpdateTheme=13]="UpdateTheme",e[e.SetNote=14]="SetNote",e[e.SetLink=15]="SetLink",e[e.Freeze=16]="Freeze",e[e.SetName=17]="SetName",e[e.ShowHeaders=18]="ShowHeaders",e[e.AddSheet=19]="AddSheet",e[e.DuplicateSheet=20]="DuplicateSheet",e[e.DeleteSheet=21]="DeleteSheet",e[e.ActivateSheet=22]="ActivateSheet",e[e.RenameSheet=23]="RenameSheet",e[e.ReorderSheet=24]="ReorderSheet",e[e.ShowSheet=25]="ShowSheet",e[e.DataValidation=26]="DataValidation",e[e.Reset=27]="Reset",e[e.SortTable=28]="SortTable",e[e.InsertTable=29]="InsertTable",e[e.RemoveTable=30]="RemoveTable",e[e.AddConditionalFormat=31]="AddConditionalFormat",e[e.RemoveConditionalFormat=32]="RemoveConditionalFormat",e[e.TabColor=33]="TabColor",e[e.CreateAnnotation=34]="CreateAnnotation",e[e.RemoveAnnotation=35]="RemoveAnnotation",e))($i||{}),Oo=class{function_names=[];argument_separator=G.argument_separator.charCodeAt(0);function_map=new Map;RemoveFunctions(e){Array.isArray(e)||(e=[e]);for(let t of e)this.function_map.delete(t.name.toLowerCase());this.UpdateNameList()}AddFunctions(e){Array.isArray(e)||(e=[e]);for(let t of e)this.function_map.set(t.name.toLowerCase(),t);this.UpdateNameList()}SetFunctions(e){this.function_map.clear();for(let t of e)this.function_map.set(t.name.toLowerCase(),t);this.UpdateNameList()}NormalizeIdentifier(e){return this.function_map.get(e.toLowerCase())?.name}Get(e){return this.function_map.get(e.toLowerCase())}Exec(e){if(e.text[0]!=="=")return{};let t,r={};if(e.cursor===e.text.length&&(t=e.text.match(/(?:^|[^a-zA-Z\u00C0-\u024F_\d])([a-zA-Z\u00C0-\u024F_][\w\d\u00C0-\u024F_.]*)\s*$/),t)){let i=t[1],s=new RegExp("^"+i.replace(".","\\."),"i");r={completions:this.function_names.filter(o=>s.test(o)).map(o=>this.function_map.get(o.toLowerCase())).filter(o=>!!o),token:i,position:e.cursor-i.length}}let a=this.ParseTooltip(e.text.substr(0,e.cursor));if(a.function){let i=this.function_map.get(a.function.toLowerCase());i&&(r.tooltip='<span class="notranslate">'+i.name+"</span>",r.arguments="("+(i.arguments||[]).map((s,o)=>{let n=s.name||"argument";return o===a.argument?`<span class="active-argument">${n}</span>`:n}).join(G.argument_separator+" ")+")",r.description=i.description?`<span class="function-description">${i.description}</span>`:"",r.function_position=a.position||0)}return r}ParseTooltip(e){let t=[],r=0,a="",i=!1,s=0;for(let n of e){let l=n.charCodeAt(0);if(i)l===34&&(i=!1);else switch(l){case 40:t.push({buffer:a.trim(),argument:r,position:s-a.length}),a="",r=0;break;case this.argument_separator:r++;break;case 41:r=t.pop()?.argument||0;break;case 34:a="",i=!0;break;default:l>=97&&l<=122||l>=65&&l<=90||l>=48&&l<=57||l>=192&&l<=591||l===95||l===46?a+=n:a=""}s++}let o=t.pop();return{function:o?.buffer||void 0,position:o?.position||0,argument:r}}UpdateNameList(){this.function_names=[...this.function_map.keys()].sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))}},Ho={scrollbars:!0,in_cell_editor:!0,formula_bar:!0,add_tab:!1,tab_bar:"auto",expand_formula_button:!1,expand:!0,comment_markdown:!0,repaint_on_cell_change:!0,grid_over_background:!1},Go=e=>{console.error("invalid case")},$o=class{grid_events=new ut;command_log=new ut;model;view;get active_sheet(){return this.view.active_sheet}set active_sheet(e){this.view.active_sheet=e}get view_index(){return this.view.view_index}batch=0;batch_paint=!1;batch_events=[];autocomplete_matcher=new Oo;flags={};options;parser;constructor(e={},t){this.model=t,this.view={active_sheet:this.model.sheets.list[0],view_index:this.model.view_count++},this.parser=t.parser,this.options={...Ho,...e}}RemoveConditionalFormat(e){this.ExecCommand({key:32,...e})}AddConditionalFormat(e){this.ExecCommand({key:31,format:e})}RemoveTable(e){this.ExecCommand({key:30,table:e})}InsertTable(e,t=!0,r=void 0,a){e.start.sheet_id||(e.start.sheet_id=this.active_sheet.id);let i=this.FindSheet(e);for(let s=e.start.row;s<=e.end.row;s++)for(let o=e.start.column;o<=e.end.column;o++){let n=i.cells.GetCell({row:s,column:o},!1);if(n&&(n.area||n.merge_area||n.table)){this.Error(4);return}}this.ExecCommand({key:29,area:JSON.parse(JSON.stringify(e)),totals:t,sortable:r,theme:a})}ActivateSheet(e){let t=typeof e=="number"?e:void 0,r=typeof e=="string"?e:void 0;this.ExecCommand({key:22,index:t,name:r})}ActivateSheetID(e){this.ExecCommand({key:22,id:e})}DuplicateSheet(e,t,r){let a={key:20,new_name:t,insert_before:r};typeof e>"u"?a.id=this.active_sheet.id:a.index=e,this.ExecCommand(a)}AddSheet(e){this.ExecCommand({key:19,name:e,show:!0})}DeleteSheet(e){if(typeof e>"u"&&!this.model.sheets.list.some((t,r)=>t===this.active_sheet?(e=r,!0):!1))throw new Error("invalid index");this.ExecCommand({key:21,index:e})}InsertSheet(e,t){if(typeof e>"u"&&!this.model.sheets.list.some((r,a)=>r===this.active_sheet?(e=a+1,!0):!1))throw new Error("invalid index");this.ExecCommand({key:19,insert_index:e,name:t,show:!0})}DeleteSheetID(e){this.ExecCommand({key:21,id:e})}Reset(){this.ExecCommand({key:27})}SetLink(e,t){this.ExecCommand({key:15,area:e,reference:t})}ShowAll(){let e=[];for(let t=0;t<this.model.sheets.length;t++)e.push({key:25,index:t,show:!0});this.ExecCommand(e)}ShowSheet(e=0,t=!0){let r={key:25,show:t};typeof e=="string"?r.name=e:r.index=e,this.ExecCommand(r)}SortTable(e,t={}){this.ExecCommand({key:28,table:JSON.parse(JSON.stringify(e)),...Xo,...t})}GetFreeze(){return{...this.active_sheet.freeze}}InsertRows(e=0,t=1){this.ExecCommand({key:1,before_row:e,count:t})}GetTableReference(e){return this.model.sheets.Find(e.sheet_id||this.active_sheet.id)?.CellData(e).table||void 0}FromCSV(e){this.parser.Save(),this.parser.SetLocaleSettings(".");let t=Xs(e).map(a=>a.map(i=>{if(i){let s=this.parser.Parse(i);if(s.expression?.type==="complex")return s.expression}return rt.TryParse(i).value}));this.parser.Restore();let r={row:Math.max(0,t.length-1),column:t.reduce((a,i)=>Math.max(a,Math.max(0,i.length-1)),0)};this.ExecCommand([{key:27},{key:6,area:{start:{row:0,column:0},end:r},value:t}])}InsertColumns(e=0,t=1){this.ExecCommand({key:2,before_column:e,count:t})}ReorderSheet(e,t){this.ExecCommand({key:24,index:e,move_before:t})}RenameSheet(e,t){this.ExecCommand({key:23,new_name:t,id:e.id})}Freeze(e=0,t=0,r=!0){this.ExecCommand({key:16,rows:e,columns:t,highlight_transition:r})}SetRowHeight(e,t,r=!0){this.ExecCommand({key:3,row:e,height:t,shrink:r})}SetColumnWidth(e,t){this.ExecCommand({key:4,column:e,width:t})}FilterTable(e,t,r){let a=[];if(!e.area.start.sheet_id)throw new Error("invalid table area");let i=this.model.sheets.Find(e.area.start.sheet_id);if(!i)throw new Error("invalid table sheet");let s=[],o=[],n=e.totals_row?e.area.end.row-1:e.area.end.row;t+=e.area.start.column;for(let l=e.area.start.row+1;l<=n;l++){let h=i.CellData({row:l,column:t}),d=r(h),c=i.GetRowHeight(l);d&&!c?s.push(l):!d&&c&&o.push(l)}s&&a.push({key:3,sheet_id:i.id,row:s,height:i.default_row_height}),o&&a.push({key:3,sheet_id:i.id,row:o,height:0}),a.length&&this.ExecCommand(a)}UpdateSheets(e,t=!1,r){ge.Reset();let a=e.map(i=>ge.FromJSON(i,this.model.theme_style_properties));if(a.length===0&&a.push(ge.Blank(this.model.theme_style_properties)),this.model.sheets.Assign(a),this.ResetMetadata(),this.active_sheet=a[0],r){let i=this.model.sheets.Find(r);i&&(this.active_sheet=i)}}SetAutocompleteFunctions(e){let t=[];for(let a of this.model.named.list)t.push({name:a.name,named:!0,type:"token"});let r=e.slice(0).concat(t);this.autocomplete_matcher.SetFunctions(r)}ResetMetadata(){this.model.document_name=void 0,this.model.user_data=void 0}ResizeColumnsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.column;if(typeof r>"u"){r=[];for(let a=0;a<t.columns;a++)r.push(a)}if(typeof r=="number"&&(r=[r]),e.width)for(let a of r)t.SetColumnWidth(a,e.width);else console.error("auto size not supported")}RemoveAnnotationInternal(e){for(let t=0;t<e.sheet.annotations.length;t++)if(e.annotation===e.sheet.annotations[t]){e.sheet.annotations.splice(t,1),this.grid_events.Publish({type:"annotation",annotation:e.annotation,event:"delete"});return}}CreateAnnotationInternal(e){}ResizeRowsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.row;if(typeof r>"u"){r=[];for(let a=0;a<t.rows;a++)r.push(a)}if(typeof r=="number"&&(r=[r]),e.height)for(let a of r)t.SetRowHeight(a,e.height);else console.error("auto size not supported")}ResetInternal(){ge.Reset(),this.UpdateSheets([],!0),this.model.named.Reset(),this.model.macro_functions.clear(),this.model.tables.clear()}ValidatePasteAreas(e){for(let t of e){let r=this.active_sheet;if(t.start.sheet_id&&t.start.sheet_id!==r.id&&(r=this.model.sheets.Find(t.start.sheet_id)),!r)return!1;for(let a of r.cells.Iterate(t)){if(a.style?.locked)return console.info("invalid: locked cells"),!1;if(a.merge_area&&(!t.Contains(a.merge_area.start)||!t.Contains(a.merge_area.end)))return console.info("invalid: merge area"),!1;if(a.area&&(!t.Contains(a.area.start)||!t.Contains(a.area.end)))return console.info("invalid: array"),!1}}return!0}SetValidationInternal(e){let t=this.FindSheet(e.area);if(!t)throw new Error("invalid sheet in set validation");let r={start:e.area.start,end:e.area.end};e.range?t.AddValidation({type:"range",error:!!e.error,area:e.range,target:[r]}):e.list?t.AddValidation({type:"list",error:!!e.error,list:JSON.parse(JSON.stringify(e.list)),target:[r]}):t.RemoveValidations(r)}GetValidationRange(e){let t,r=this.FindSheet(e);if(r){t=[],e=r.RealArea(new k(e.start,e.end),!0);for(let a=e.start.row;a<=e.end.row;a++)for(let i=e.start.column;i<=e.end.column;i++){let s=r.CellData({row:a,column:i});s&&s.formatted&&(typeof s.formatted=="string"?t.push(s.formatted):t.push(Ie.FormatPartsAsText(s.formatted)))}}return t}DeleteSheetInternal(e){let t=!1,r=-1,a="",i=!1,s=e.name?e.name.toLowerCase():"",o=this.model.sheets.list.filter((n,l)=>l===e.index||n.id===e.id||n.name.toLowerCase()===s?(t=n===this.active_sheet,this.model.named.RemoveRangesForSheet(n.id),a=n.name,r=l,!1):!0);if(a&&this.RenameSheetReferences(o,a,"#REF")>0&&(i=!0),!o.length)o.push(ge.Blank(this.model.theme_style_properties)),r=0;else if(o.every(n=>!n.visible))o.unshift(ge.Blank(this.model.theme_style_properties)),r=0;else for(r>=o.length&&(r=0);!o[r].visible;)r++;return this.model.sheets.Assign(o),t&&this.ActivateSheetInternal({key:22,index:r}),i}RenameSheetInternal(e,t){if(!t||Ns.test(t))throw new Error("invalid sheet name");let r=t.toLowerCase();for(let i of this.model.sheets.list)if(i!==e&&i.name.toLowerCase()===r)throw new Error("sheet name already exists");let a=e.name;e.name=t,this.model.sheets.Assign(this.model.sheets.list),this.RenameSheetReferences(this.model.sheets.list,a,t)}SortTableInternal(e){if(!e.table.area.start.sheet_id)throw new Error("table has invalid area");let t=this.model.sheets.Find(e.table.area.start.sheet_id);if(!t)throw new Error("invalid sheet in table area");let r=[],a=[],i=e.table.area.end.row;e.table.totals_row&&i--;let s=0,o=0;for(let c=e.table.area.start.row+1;c<=i;c++){if(t.GetRowHeight(c))a.push(c);else continue;let u={row:c,number:0,text:"",type:0,data:[]};for(let m=e.table.area.start.column;m<=e.table.area.end.column;m++){let f=t.CellData({row:c,column:m});if(m===e.column+e.table.area.start.column){let p=f.calculated_type||f.type;p===2?s++:p===3&&o++;let b=f.calculated_type?f.calculated:f.value;u.text=b?.toString()||"",u.number=Number(b)||0,u.type=f.calculated_type||f.type}u.data.push({address:{row:c,column:m},data:f.value,type:f.type,style:f.style})}r.push(u)}let n=e.type;n==="auto"&&(o>s?n="numeric":n="text");let l=e.asc?1:-1;switch(n){case"numeric":r.sort((c,u)=>c.type===0?u.type===0?0:1:u.type===0?-1:(c.number-u.number)*l);break;case"text":default:r.sort((c,u)=>c.type===0?u.type===0?0:1:u.type===0?-1:c.text.localeCompare(u.text)*l);break}let h={row:e.table.area.start.row+1,column:e.table.area.start.column};for(let c=0;c<a.length;c++){h.row=a[c];let u=r[c];h.column=e.table.area.start.column;for(let m of u.data){if(m.type===1){let f=m.data,p={columns:0,rows:h.row-u.row},b=this.parser.Parse(f);b.expression&&(f="="+this.parser.Render(b.expression,{offset:p,missing:""})),t.SetCellValue(h,f)}else t.SetCellValue(h,m.data);t.UpdateCellStyle(h,m.style||{},!1),h.column++}}let d=this.model.tables.get(e.table.name.toLowerCase());d&&(d.sort={type:e.type,asc:!!e.asc,column:e.column});{let c=e.table.area.start.row;for(let u=e.table.area.start.column;u<=e.table.area.end.column;u++)t.cells.data[c][u]?.FlushStyle();if(e.table.totals_row){c=e.table.area.end.row;for(let u=e.table.area.start.column;u<=e.table.area.end.column;u++)t.cells.data[c][u]?.FlushStyle()}}return new k(e.table.area.start,e.table.area.end)}UpdateTableColumns(e){if(!e.area.start.sheet_id)throw new Error("invalid area in table");let t=this.model.sheets.Find(e.area.start.sheet_id);if(!t)throw new Error("invalid sheet in table");let r=e.columns?.slice(0)||void 0,a=[],i=e.area.start.row,s=e.area.end.column-e.area.start.column+1,o=e.area.start.column;for(let n=0;n<s;n++,o++){let l=t.CellData({row:i,column:o}),h="";l.type!==2?(typeof l.formatted<"u"?h=l.formatted.toString():typeof l.calculated<"u"?h=l.calculated.toString():typeof l.value<"u"&&(h=l.value.toString()),l.Set(h,2)):h=l.value||"",h||(h=`Column${n+1}`);let d=h,c=!1,u=1;for(;!c;){c=!0;e:for(let m of a)if(m.toLowerCase()===d.toLowerCase()){c=!1,d=`${h}${++u}`;break e}}l.Set(d,2),a.push(d.toLowerCase())}if(r&&r.length===a.length){let n=new Map;for(let l=0;l<r.length;l++){let h=r[l].toLowerCase();h!==a[l]&&n.set(h,a[l])}if(n.size){let l=e.name.toLowerCase();for(let h of this.model.sheets.list)for(let d of h.cells.Iterate())if(d.ValueIsFormula()){let c=!1,u=this.parser.Parse(d.value);u.expression&&(this.parser.Walk(u.expression,m=>{if(m.type==="structured-reference"&&(m.table.toLowerCase()===l||!m.table&&d.table===e))for(let[f,p]of n.entries())m.column.toLowerCase()===f&&(m.column=p,c=!0);return!0}),c&&(console.info("updating value"),d.value="="+this.parser.Render(u.expression,{missing:""})))}}}return e.columns=a,{start:{...e.area.start},end:{row:e.area.start.row,column:e.area.end.column}}}SetRangeInternal(e,t={}){let r=$(e.area)?new k(e.area):new k(e.area.start,e.area.end),a=this.FindSheet(r);if(r.start.sheet_id||(r.start.sheet_id=a.id),!r.entire_row&&!r.entire_column&&(r.end.row>=a.rows||r.end.column>=a.columns)&&(a.cells.EnsureCell(r.end),a===this.active_sheet&&(t.layout=!0)),$(e.area)){let i=a.CellData(e.area);if(i.area&&(i.area.rows>1||i.area.columns>1)){this.Error(2);return}let s=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;return e.r1c1&&(s=this.TranslateR1C1(e.area,s)),e.array?a.SetArrayValue(r,s):a.SetCellValue(e.area,s),r}else{if(e.array){let i=Array.isArray(e.value)?Array.isArray(e.value[0])?e.value[0][0]:e.value[0]:e.value;e.r1c1&&(i=this.TranslateR1C1(r.start,i)),a.SetArrayValue(r,i)}else{if(e.r1c1){if(Array.isArray(e.value))for(let i=0;i<e.value.length&&i<r.rows;i++){e.value[i]||(e.value[i]=[]);let s=e.value[i];for(let o=0;o<s.length&&o<r.columns;o++){let n={...r.start,row:r.start.row+i,column:r.start.column+o};s[o]=this.TranslateR1C1(n,s[o])}}else if(typeof e.value=="string"&&e.value[0]==="="){let i=[];for(let s=0;s<r.rows;s++){let o=[];for(let n=0;n<r.columns;n++){let l={...r.start,row:r.start.row+s,column:r.start.column+n};o.push(this.TranslateR1C1(l,e.value))}i.push(o)}e.value=i}}a.SetAreaValues2(r,e.value)}return r}}ActivateSheetInternal(e){let t=this.ResolveSheet(e)||this.model.sheets.list[0];if(this.active_sheet===t&&!e.force)return;if(!t.visible)throw new Error("cannot activate hidden sheet");let r=this.active_sheet;this.active_sheet=t,this.grid_events.Publish({type:"sheet-change",deactivate:r,activate:this.active_sheet})}ShowSheetInternal(e){let t=this.ResolveSheet(e);if(t&&t.visible!==e.show){if(!e.show){let r=0;for(let a of this.model.sheets.list)(!t.visible||a===t)&&r++;if(r>=this.model.sheets.length)throw new Error("can't hide all sheets")}if(t.visible=e.show,t===this.active_sheet){let r=this.model.sheets.list;for(let a=0;a<r.length;a++)if(r[a]===this.active_sheet){for(let i=a+1;i<r.length;i++)if(r[i].visible){this.ActivateSheetInternal({key:22,index:i});return}for(let i=0;i<r.length;i++)if(r[i].visible){this.ActivateSheetInternal({key:22,index:i});return}throw new Error("no visible sheet")}}}}NormalizeCommands(e){Array.isArray(e)||(e=[e]);let t=this.active_sheet.id;for(let r of e)switch(r.key){case 0:case 33:case 18:case 25:case 19:case 20:case 21:case 22:case 23:case 24:case 27:case 34:case 35:break;case 28:case 30:r.table.area.start.sheet_id||(r.table.area.start.sheet_id=t);break;case 31:r.format.area.start.sheet_id||(r.format.area.start.sheet_id=t);break;case 3:case 4:case 2:case 1:case 16:r.sheet_id||(r.sheet_id=t);break;case 12:case 14:case 15:case 9:case 8:case 10:case 11:case 26:case 6:case 7:case 17:case 5:case 29:case 32:r.area&&($(r.area)?r.area.sheet_id||(r.area.sheet_id=t):r.area.start.sheet_id||(r.area.start.sheet_id=t));break;default:Go()}return e}TabColor(e,t){this.ExecCommand({key:33,sheet:e,color:t})}AddSheetInternal(e=ge.default_sheet_name,t=-1){if(!this.options.add_tab){console.warn("add tab option not set or false");return}for(;this.model.sheets.list.some(a=>a.name===e);){let a=e.match(/^(.*?)(\d+)$/);a?e=a[1]+(Number(a[2])+1):e=e+"2"}let r=ge.Blank(this.model.theme_style_properties,e);return t>=0?this.model.sheets.Splice(t,0,r):this.model.sheets.Add(r),r.id}ResolveSheet(e){if(typeof e.index<"u")return this.model.sheets.list[e.index];if(typeof e.name<"u")return this.model.sheets.Find(e.name);if(e.id)return this.model.sheets.Find(e.id)}FindSheet(e){if(e===void 0)return this.active_sheet;let t=typeof e=="number"?e:$(e)?e.sheet_id:e.start.sheet_id;return!t||t===this.active_sheet.id?this.active_sheet:this.model.sheets.Find(t)||this.active_sheet}PatchFormulasInternal(e,t,r,a,i,s,o){let n=this.parser.Parse(e||""),l=!1;if(n.expression&&(this.parser.Walk(n.expression,h=>{if(h.type==="range"||h.type==="address"){let d=[];h.type==="range"?(h.start.sheet&&h.start.sheet.toLowerCase()===s||!h.start.sheet&&o)&&d.push(h.start,h.end):h.type==="address"&&(h.sheet&&h.sheet.toLowerCase()===s||!h.sheet&&o)&&d.push(h);for(let c of d)r&&c.row>=t&&(r<0&&c.row+r<t?c.column=c.row=-1:c.row+=r,l=!0),i&&c.column>=a&&(i<0&&c.column+i<a?c.column=c.row=-1:c.column+=i,l=!0);return!1}return!0}),l))return"="+this.parser.Render(n.expression,{missing:""})}PatchExpressionSheetName(e,t,r){let a=!1,i=this.parser.Parse(e||"");if(i.expression&&(this.parser.Walk(i.expression,s=>(s.type==="address"&&s.sheet&&s.sheet.toLowerCase()===t&&(s.sheet=r,a=!0),!0)),a))return"="+this.parser.Render(i.expression,{missing:""})}RenameSheetReferences(e,t,r){let a=0;t=t.toLowerCase();for(let i of e){for(let s of i.cells.Iterate())if(s.ValueIsFormula()){let o=this.PatchExpressionSheetName(s.value||"",t,r);o&&(s.value=o,a++)}if(i.conditional_formats?.length)for(let s of i.conditional_formats)switch(s.type){case"cell-match":case"expression":{let o=this.PatchExpressionSheetName(s.expression,t,r);o&&(s.expression=o,a++)}break}for(let s of i.annotations)if(s.data.formula){let o=this.PatchExpressionSheetName(s.data.formula,t,r);o&&(s.data.formula=o,a++)}}for(let i of this.model.connected_elements.values())if(i.formula){let s=this.PatchExpressionSheetName(i.formula,t,r);s&&(i.formula=s,a++)}return a}ApplyBordersInternal(e){let t=e.borders,r=e.borders==="none"?0:e.width,a=new k(e.area.start,e.area.end),i=this.FindSheet(a);a.start.sheet_id=i.id;let s={border_top:r},o={border_bottom:r},n={border_left:r},l={border_right:r},h={border_top:0,border_top_fill:{}},d={border_bottom:0,border_bottom_fill:{}},c={border_left:0,border_left_fill:{}},u={border_right:0,border_right_fill:{}};return e.color?(s.border_top_fill={...e.color},o.border_bottom_fill={...e.color},n.border_left_fill={...e.color},l.border_right_fill={...e.color}):(s.border_top_fill={},o.border_bottom_fill={},n.border_left_fill={},l.border_right_fill={}),(t==="none"||t==="all")&&i.UpdateAreaStyle(a,{...s,...o,...n,...l},!0),(t==="top"||t==="outside")&&(a.entire_column||i.UpdateAreaStyle(a.top,{...s},!0)),(t==="none"||t==="all"||t==="outside"||t==="top")&&(a.entire_column||a.start.row&&i.UpdateAreaStyle(new k({row:a.start.row-1,column:a.start.column},{row:a.start.row-1,column:a.end.column}),{...d},!0)),(t==="bottom"||t==="outside")&&(a.entire_column||i.UpdateAreaStyle(a.bottom,{...o},!0)),(t==="none"||t==="all"||t==="outside"||t==="bottom")&&(a.entire_column||i.UpdateAreaStyle(new k({row:a.end.row+1,column:a.start.column},{row:a.end.row+1,column:a.end.column}),{...h},!0)),(t==="left"||t==="outside")&&(a.entire_row||i.UpdateAreaStyle(a.left,{...n},!0)),(t==="none"||t==="all"||t==="outside"||t==="left")&&(a.entire_row||a.start.column&&i.UpdateAreaStyle(new k({row:a.start.row,column:a.start.column-1},{row:a.end.row,column:a.start.column-1}),{...u},!0)),(t==="right"||t==="outside")&&(a.entire_row||i.UpdateAreaStyle(a.right,{...l},!0)),(t==="none"||t==="all"||t==="outside"||t==="right")&&(a.entire_row||i.UpdateAreaStyle(new k({row:a.start.row,column:a.end.column+1},{row:a.end.row,column:a.end.column+1}),{...c},!0)),k.Bleed(a)}TranslateR1C1(e,t){let r=!1,a=this.parser.flags.r1c1;if(this.parser.flags.r1c1=!0,typeof t=="string"&&t[0]==="="){let i=this.parser.Parse(t);i.expression&&(this.parser.Walk(i.expression,s=>(s.type==="address"&&s.r1c1&&(r=!0,s.offset_column?(s.absolute_column=!1,s.column=s.column+e.column):s.absolute_column=!0,s.offset_row?(s.absolute_row=!1,s.row=s.row+e.row):s.absolute_row=!0),!0)),r&&(t="="+this.parser.Render(i.expression,{missing:""})))}return this.parser.flags.r1c1=a,t}ClearAreaInternal(e){let t;if(e.start.sheet_id?t=this.model.sheets.Find(e.start.sheet_id):t=this.active_sheet,!t){console.warn("can't resolve sheet in ClearAreaInternal");return}e=t.RealArea(e);for(let a of t.cells.Iterate(e))if(a.area&&!e.ContainsArea(a.area)){this.Error(2);return}let r=this.model.tables.keys();for(let a of r){let i=this.model.tables.get(a);if(i&&i.area.start.sheet_id===t.id){let s=new k(i.area.start,i.area.end);if(e.ContainsArea(s)){for(let o=s.start.row;o<=s.end.row;o++)for(let n=s.start.column;n<=i.area.end.column;n++){let l=t.cells.GetCell({row:o,column:n},!1);l&&(l.table=void 0)}this.model.tables.delete(a)}}}t.ClearArea(e)}Error(e){this.grid_events.Publish({type:"error",code:e})}DuplicateSheetInternal(e){if(!this.options.add_tab){console.warn("add tab option not set or false");return}let t=this.ResolveSheet(e),r=this.model.sheets.list.reduce((n,l)=>Math.max(n,l.id),0)+1,a=-1;for(let n=0;n<this.model.sheets.length;n++)this.model.sheets.list[n]===t&&(a=n+1);if(!t||a<0)throw new Error("source sheet not found");if(typeof e.insert_before=="number")a=e.insert_before;else if(typeof e.insert_before=="string"){let n=e.insert_before.toLowerCase();for(let l=0;l<this.model.sheets.length;l++)if(this.model.sheets.list[l].name.toLowerCase()===n){a=l;break}}let i={rendered_values:!0},s=ge.FromJSON(t.toJSON(i),this.model.theme_style_properties),o=e.new_name||t.name;for(;this.model.sheets.list.some(n=>n.name===o);){let n=o.match(/^(.*?)(\d+)$/);n?o=n[1]+(Number(n[2])+1):o=o+"2"}return s.name=o,s.id=r,this.model.sheets.Splice(a,0,s),s.id}SelectInternal(e){}FreezeInternal(e){let t=this.FindSheet(e.sheet_id||this.active_sheet.id);t.freeze.rows=e.rows,t.freeze.columns=e.columns}PatchExpression(e,t){let r=0,a=this.parser.Parse(e);if(a.expression&&(this.parser.Walk(a.expression,i=>{if(i.type==="range"){if(!i.start.sheet||i.start.sheet.toLowerCase()===t.sheet.name.toLowerCase()){let s=k.PatchArea(i,t);s?(i.start.row=s.start.row,i.start.column=s.start.column,i.end.row=s.end.row,i.end.column=s.end.column):i.start.row=i.end.row=i.start.column=i.end.column=-1}return r++,!1}else if(i.type==="address"){let s=k.PatchArea({start:i,end:i},t);return s?(i.row=s.start.row,i.column=s.start.column):i.row=i.column=-1,r++,!1}return!0}),r))return this.parser.Render(a.expression,{missing:""})}PatchConditionalsAndValidations(e){if(e.sheet.data_validation.length){let t=new Set;for(let r of e.sheet.data_validation){let a=[];for(let i of r.target){let s=k.PatchArea(i,e);s&&a.push(s)}if(a.length>0){if(r.target=a,r.type==="range"&&r.area.start.sheet_id===e.sheet.id){let i=k.PatchArea(r.area,e);i?r.area=i:t.add(r)}}else t.add(r)}t.size&&(e.sheet.data_validation=e.sheet.data_validation.filter(r=>!t.has(r)))}if(e.sheet.conditional_formats?.length){let t=new Set;for(let r of e.sheet.conditional_formats){let a=k.PatchArea(r.area,e);if(a)r.area=JSON.parse(JSON.stringify(a));else{t.add(r);continue}switch(r.type){case"expression":case"cell-match":{let i=this.PatchExpression(r.expression,e);i&&(r.expression=i)}break}}t.size&&(e.sheet.conditional_formats=e.sheet.conditional_formats.filter(r=>!t.has(r)))}}InsertRowsInternal(e){let t=this.FindSheet(e.sheet_id);if(e.count===1/0?e.count=1:e.count===-1/0&&(e.count=-t.rows),!t.InsertRows(e.before_row,e.count))return this.Error(2),{error:!0};this.PatchConditionalsAndValidations({sheet:t,before_column:0,column_count:0,before_row:e.before_row,row_count:e.count});for(let n of this.model.connected_elements.values())if(n.formula){let l=this.PatchFormulasInternal(n.formula,e.before_row,e.count,0,0,t.name.toLowerCase(),!1);l&&(n.formula=l)}let r=Array.from(this.model.tables.values());for(let n of r)if(n.area.start.sheet_id===e.sheet_id)if(e.count>0){if(e.before_row<=n.area.start.row)n.area.start.row+=e.count,n.area.end.row+=e.count;else if(e.before_row<=n.area.end.row){n.area.end.row+=e.count;for(let l=n.area.start.row;l<=n.area.end.row;l++)for(let h=n.area.start.column;h<=n.area.end.column;h++){let d=t.CellData({row:l,column:h});d.table=n}}}else if(e.before_row<=n.area.start.row)if(e.before_row-e.count<=n.area.start.row)n.area.start.row+=e.count,n.area.end.row+=e.count;else if(e.before_row-e.count>=n.area.end.row)this.model.tables.delete(n.name.toLowerCase());else{this.model.tables.delete(n.name.toLowerCase());for(let l=e.before_row;l<=n.area.end.row;l++)for(let h=n.area.start.column;h<=n.area.end.column;h++){let d=t.CellData({row:l,column:h});d.table===n&&(d.table=void 0)}}else e.before_row<=n.area.end.row&&(e.before_row-e.count>n.area.end.row&&(n.totals_row=!1),n.area.end.row=Math.max(0,n.area.end.row+e.count,e.before_row-1));this.model.named.PatchNamedRanges(t.id,0,0,e.before_row,e.count);let a=t.name.toLowerCase();for(let n of this.model.sheets.list){let l=n===t;for(let h of n.cells.Iterate())if(h.ValueIsFormula()){let d=this.PatchFormulasInternal(h.value||"",e.before_row,e.count,0,0,a,l);d&&(h.value=d)}for(let h of n.annotations)if(h.data.formula){let d=this.PatchFormulasInternal(h.data.formula||"",e.before_row,e.count,0,0,a,l);d&&(h.data.formula=d)}}let i=[],s=[],o=[];if(e.count>0){let n=e.before_row;for(let l of t.annotations)if(l.data.layout){let[h,d,c]=[l.data.layout.tl.address.row,l.data.layout.br.address.row,l.data.layout.br.offset.y];if(n<=h)l.data.layout.tl.address.row+=e.count,l.data.layout.br.address.row+=e.count;else if(n<d||n===d&&c>0)l.data.layout.br.address.row+=e.count,s.push(l);else continue;i.push(l)}}else if(e.count<0){let n=e.before_row,l=e.before_row-e.count-1;for(let h of t.annotations)if(h.data.layout){let[d,c,u]=[h.data.layout.tl.address.row,h.data.layout.br.address.row,h.data.layout.br.offset.y];if(n<=d)if(l<d)h.data.layout.tl.address.row+=e.count,h.data.layout.br.address.row+=e.count;else if(l<c-1||l===c-1&&u>0)h.data.layout.tl.address.row=n,h.data.layout.tl.offset.y=0,h.data.layout.br.address.row+=e.count,s.push(h);else{o.push(h);continue}else if(n<c||n===c&&u>0)l<c-1||l===c-1&&u>0?(h.data.layout.br.address.row+=e.count,s.push(h)):(h.data.layout.br.address.row=n,h.data.layout.br.offset.y=0,s.push(h));else continue;i.push(h)}}for(let n of o)t.annotations=t.annotations.filter(l=>l!==n);return{update_annotations_list:i,resize_annotations_list:s,delete_annotations_list:o}}InsertColumnsInternal(e){let t=this.FindSheet(e.sheet_id);if(e.count===1/0?e.count=1:e.count===-1/0&&(e.count=-t.columns),!t.InsertColumns(e.before_column,e.count))return this.Error(2),{error:!0};this.PatchConditionalsAndValidations({sheet:t,before_column:e.before_column,column_count:e.count,before_row:0,row_count:0});for(let n of this.model.connected_elements.values())if(n.formula){let l=this.PatchFormulasInternal(n.formula,0,0,e.before_column,e.count,t.name.toLowerCase(),!1);l&&(n.formula=l)}let r=Array.from(this.model.tables.values());for(let n of r)if(n.area.start.sheet_id===e.sheet_id)if(e.count>0){if(e.before_column<=n.area.start.column)n.area.start.column+=e.count,n.area.end.column+=e.count;else if(e.before_column<=n.area.end.column){n.area.end.column+=e.count;for(let l=n.area.start.row;l<=n.area.end.row;l++)for(let h=n.area.start.column;h<=n.area.end.column;h++){let d=t.CellData({row:l,column:h});d.table=n}this.UpdateTableColumns(n)}}else e.before_column<=n.area.start.column?e.before_column-e.count<=n.area.start.column?(n.area.start.column+=e.count,n.area.end.column+=e.count):e.before_column-e.count>=n.area.end.column?this.model.tables.delete(n.name.toLowerCase()):(n.area.start.column=e.before_column,n.area.end.column+=e.count,this.UpdateTableColumns(n)):e.before_column<=n.area.end.column&&(n.area.end.column=Math.max(0,n.area.end.column+e.count,e.before_column-1),this.UpdateTableColumns(n));this.model.named.PatchNamedRanges(t.id,e.before_column,e.count,0,0);let a=t.name.toLowerCase();for(let n of this.model.sheets.list){let l=n===t;for(let h of n.cells.Iterate())if(h.ValueIsFormula()){let d=this.PatchFormulasInternal(h.value||"",0,0,e.before_column,e.count,a,l);d&&(h.value=d)}for(let h of n.annotations)if(h.data.formula){let d=this.PatchFormulasInternal(h.data.formula,0,0,e.before_column,e.count,a,l);d&&(h.data.formula=d)}}let i=[],s=[],o=[];if(e.count>0){let n=e.before_column;for(let l of t.annotations)if(l.data.layout){let[h,d,c]=[l.data.layout.tl.address.column,l.data.layout.br.address.column,l.data.layout.br.offset.x];if(n<=h)l.data.layout.tl.address.column+=e.count,l.data.layout.br.address.column+=e.count;else if(n<d||n===d&&c>0)l.data.layout.br.address.column+=e.count,s.push(l);else continue;i.push(l)}}else if(e.count<0){let n=e.before_column,l=e.before_column-e.count-1;for(let h of t.annotations)if(h.data.layout){let[d,c,u]=[h.data.layout.tl.address.column,h.data.layout.br.address.column,h.data.layout.br.offset.x];if(n<=d)if(l<d)h.data.layout.tl.address.column+=e.count,h.data.layout.br.address.column+=e.count;else if(l<c-1||l===c-1&&u>0)h.data.layout.tl.address.column=n,h.data.layout.tl.offset.x=0,h.data.layout.br.address.column+=e.count,s.push(h);else{o.push(h);continue}else if(n<c||n===c&&u>0)l<c-1||l===c-1&&u>0?(h.data.layout.br.address.column+=e.count,s.push(h)):(h.data.layout.br.address.column=n,h.data.layout.br.offset.x=0,s.push(h));else continue;i.push(h)}}for(let n of o)t.annotations=t.annotations.filter(l=>l!==n);return{update_annotations_list:i,resize_annotations_list:s,delete_annotations_list:o}}ExecCommand(e,t=!0){let r={pending:[]},a=[];e=this.NormalizeCommands(e),t&&this.command_log.Publish({command:e,timestamp:new Date().getTime()});for(let o of e)switch(o.key){case 27:this.ResetInternal();break;case 12:if(o.area){let n=new k(o.area.start,o.area.end);this.ClearAreaInternal(n),r.data_area=k.Join(n,r.data_area),r.formula=!0}break;case 5:this.SelectInternal(o);break;case 16:this.FreezeInternal(o),r.structure_event=!0;break;case 31:{let n=this.FindSheet(o.format.area);n.conditional_formats.push(o.format),n.Invalidate(new k(o.format.area.start,o.format.area.end)),n===this.active_sheet&&(r.render_area=k.Join(o.format.area,r.render_area)),r.structure_event=!0,r.conditional_formatting_event=!0}break;case 32:{let n,l=0;if(o.format){let h=JSON.stringify(o.format);n=this.FindSheet(o.format.area),n.conditional_formats=n.conditional_formats.filter(d=>JSON.stringify(d)===h?(l++,r.render_area=k.Join(d.area,r.render_area),!1):!0)}else if(o.area){let h=new k(o.area.start,o.area.end);n=this.FindSheet(o.area),n.conditional_formats=n.conditional_formats.filter(d=>{let c=new k(d.area.start,d.area.end);return c.Intersects(h)?(l++,r.render_area=k.Join(c,r.render_area),!1):!0})}n&&l&&(n.FlushConditionalFormats(),r.structure_event=!0,r.conditional_formatting_event=!0)}break;case 29:{let n=this.FindSheet(o.area),l=new k(o.area.start,o.area.end),h=!0;e:for(let d=l.start.row;d<=l.end.row;d++)for(let c=l.start.column;c<=l.end.column;c++){let u=n.cells.GetCell({row:d,column:c},!1);if(u&&(u.area||u.merge_area||u.table)){h=!1;break e}}if(h){let d=this.model.tables.size+1,c="";for(;c=`Table${d++}`,!!this.model.tables.has(c.toLowerCase()););let u={area:o.area,name:c,sortable:o.sortable,theme:o.theme};o.totals&&(u.totals_row=!0),this.model.tables.set(c.toLowerCase(),u);for(let m=l.start.row;m<=l.end.row;m++)for(let f=l.start.column;f<=l.end.column;f++){let p=n.cells.GetCell({row:m,column:f},!0);p.table=u}this.UpdateTableColumns(u),n.Invalidate(new k(u.area.start,u.area.end)),n===this.active_sheet?(r.style_area=k.Join(l,r.style_area),r.render_area=k.Join(l,r.render_area)):r.style_event=!0}}break;case 30:{let n=this.FindSheet(o.table.area),l=new k(o.table.area.start,o.table.area.end);for(let d=l.start.row;d<=l.end.row;d++)for(let c=l.start.column;c<=l.end.column;c++){let u=n.cells.GetCell({row:d,column:c},!1);u&&(u.table=void 0)}this.model.tables.delete(o.table.name.toLowerCase());let h=n.RealArea(l.Clone().Shift(-1,-1).Resize(l.rows+2,l.columns+2));n.Invalidate(h),n===this.active_sheet?(r.style_area=k.Join(l,r.style_area),r.render_area=k.Join(l,r.render_area)):r.style_event=!0}break;case 10:{let n=this.FindSheet(o.area);n.MergeCells(new k(o.area.start,o.area.end)),r.structure_event=!0,r.structure_rebuild_required=!0,n===this.active_sheet?(r.data_area=k.Join(o.area,r.data_area),r.render_area=k.Join(o.area,r.render_area)):(r.data_event=!0,r.pending||(r.pending=[]),r.pending.push(n.id))}break;case 11:{let n=this.FindSheet(o.area),l={},h=new k(o.area.start,o.area.end);for(let c of n.cells.Iterate(h,!1))if(c.merge_area){let u=k.CellAddressToLabel(c.merge_area.start)+":"+k.CellAddressToLabel(c.merge_area.end);l[u]=c.merge_area}let d=Object.keys(l);for(let c=0;c<d.length;c++)n.UnmergeCells(l[d[c]]);n===this.active_sheet?(r.render_area=k.Join(o.area,r.render_area),r.data_area=k.Join(o.area,r.data_area)):(r.data_event=!0,r.pending||(r.pending=[]),r.pending.push(n.id)),r.structure_event=!0,r.structure_rebuild_required=!0}break;case 9:{let n,l=this.FindSheet(o.area);if($(o.area)){n=new k(o.area);let h=l.GetCellStyle(o.area,!0);l.UpdateCellStyle(o.area,{indent:Math.max(0,(h.indent||0)+o.delta)},!0)}else{n=new k(o.area.start,o.area.end);for(let h of n){let d=l.GetCellStyle(h,!0);l.UpdateCellStyle(h,{indent:Math.max(0,(d.indent||0)+o.delta)},!0)}}l===this.active_sheet?(r.style_area=k.Join(n,r.style_area),r.render_area=k.Join(n,r.render_area)):r.style_event=!0}break;case 7:{let n,l=this.FindSheet(o.area);$(o.area)?(n=new k(o.area),l.UpdateCellStyle(o.area,o.style,!!o.delta)):(n=new k(o.area.start,o.area.end),l.UpdateAreaStyle(n,o.style,!!o.delta)),l===this.active_sheet?(r.style_area=k.Join(n,r.style_area),(!o.delta||o.style.fill||o.style.border_top||o.style.border_left||o.style.border_right||o.style.border_bottom)&&(n=k.Bleed(n),this.active_sheet.Invalidate(n)),r.render_area=k.Join(n,r.render_area)):r.style_event=!0}break;case 26:this.SetValidationInternal(o),(!o.area.start.sheet_id||o.area.start.sheet_id===this.active_sheet.id)&&(r.render_area=k.Join(new k(o.area.start,o.area.end),r.render_area));break;case 17:{let n={type:"token",named:!0,name:o.name,scope:o.scope};o.area||o.expression?(o.area?this.model.named.SetNamedRange(o.name,new k(o.area.start,o.area.end),o.scope):o.expression&&this.model.named.SetNamedExpression(o.name,o.expression,o.scope),this.autocomplete_matcher.AddFunctions(n)):(this.model.named.ClearName(o.name,o.scope),this.autocomplete_matcher.RemoveFunctions(n)),r.structure_event=!0,r.structure_rebuild_required=!0}break;case 8:{let n=this.ApplyBordersInternal(o);n.start.sheet_id===this.active_sheet.id?(r.render_area=k.Join(n,r.render_area),r.style_area=k.Join(n,r.style_area)):r.style_event=!0}break;case 25:this.ShowSheetInternal(o),r.sheets=!0,r.structure_event=!0;break;case 33:o.sheet.tab_color=o.color,r.sheets=!0,r.structure_event=!0;break;case 24:{let n=[],l=this.model.sheets.list[o.index];for(let h=0;h<this.model.sheets.length;h++)h!==o.index&&(h===o.move_before&&n.push(l),n.push(this.model.sheets.list[h]));o.move_before>=this.model.sheets.length&&n.push(l),this.model.sheets.Assign(n),r.sheets=!0,r.structure_event=!0}break;case 23:{let n=this.ResolveSheet(o);n&&(this.RenameSheetInternal(n,o.new_name),r.sheets=!0,r.structure_event=!0)}break;case 35:this.RemoveAnnotationInternal(o),r.structure_event=!0,r.structure_rebuild_required=!0,r.annotation_event=!0;break;case 34:this.CreateAnnotationInternal(o),r.structure_event=!0,r.structure_rebuild_required=!0,r.annotation_event=!0;break;case 3:{let n=this.ResizeRowsInternal(o);if(n)if(n.start.sheet_id===this.active_sheet.id){let l=this.active_sheet.RealArea(new k(n.start,n.end));r.render_area=k.Join(l,r.render_area),r.data_area=k.Join(l,r.data_area),r.data_event=!0}else r.data_event=!0,r.pending||(r.pending=[]),n.start.sheet_id&&r.pending.push(n.start.sheet_id);r.structure_event=!0}break;case 4:this.ResizeColumnsInternal(o),r.structure_event=!0;break;case 18:this.active_sheet.SetHeaderSize(o.show?void 0:1,o.show?void 0:1),this.flags.layout=!0,this.flags.repaint=!0;break;case 1:this.InsertRowsInternal(o),r.structure_event=!0,r.structure_rebuild_required=!0;break;case 2:this.InsertColumnsInternal(o),r.structure_event=!0,r.structure_rebuild_required=!0;break;case 15:case 14:{let n=this.FindSheet(o.area),l=n.cells.GetCell(o.area,!0);if(l){let h;l.merge_area?(h=new k(l.merge_area.start),l=n.cells.GetCell(l.merge_area.start,!0)):h=new k(o.area),o.key===14?l.SetNote(o.note):(l.hyperlink=o.reference||void 0,l.render_clean=[]),n===this.active_sheet?(r.style_area=k.Join(h,r.style_area),r.render_area=k.Join(h,r.render_area)):r.style_event=!0}}break;case 28:{let n=this.SortTableInternal(o);n&&n.start.sheet_id===this.active_sheet.id?(r.data_area=k.Join(n,r.data_area),this.options.repaint_on_cell_change&&(r.render_area=k.Join(n,r.render_area))):r.data_event=!0}break;case 6:{let n=this.SetRangeInternal(o,r);if(n){let l=this.model.sheets.Find(n.start.sheet_id||this.active_sheet.id)?.TablesFromArea(n,!0)||[];for(let h of l)this.UpdateTableColumns(h)}n&&n.start.sheet_id===this.active_sheet.id?(r.data_area=k.Join(n,r.data_area),this.options.repaint_on_cell_change&&(r.render_area=k.Join(n,r.render_area))):r.data_event=!0}break;case 21:this.DeleteSheetInternal(o),r.sheets=!0,r.structure_event=!0,r.structure_rebuild_required=!0;break;case 20:this.DuplicateSheetInternal(o),r.sheets=!0,r.structure_event=!0,r.structure_rebuild_required=!0;break;case 19:{let n=this.AddSheetInternal(o.name,o.insert_index);typeof n=="number"&&o.show&&this.ActivateSheetInternal({key:22,id:n}),r.structure_event=!0,r.sheets=!0,r.structure=!0}break;case 22:this.ActivateSheetInternal(o);break;default:console.warn(`unhandled command: ${$i[o.key]} (${o.key})`)}let i,s;return r.data_area?(r.data_area.start.sheet_id||r.data_area.SetSheetID(this.active_sheet.id),i={type:"data",area:r.data_area}):r.data_event&&(i={type:"data"}),r.style_area?(r.style_area.start.sheet_id||r.style_area.SetSheetID(this.active_sheet.id),s={type:"style",area:r.style_area}):r.style_event&&(s={type:"style"}),i&&s?a.push({type:"composite",data_area:i.area,style_area:s.area}):(i&&a.push(i),s&&a.push(s)),r.structure_event&&a.push({type:"structure",rebuild_required:r.structure_rebuild_required,conditional_format:r.conditional_formatting_event,update_annotations:r.annotation_event}),this.batch>0?this.batch_events.push(...a):this.grid_events.Publish(a),r}},Bo=class extends aa{get active(){return this.nodes.length>0}Reset(){this.AttachNodes()}AttachNodes(e=[],t=!0){this.assume_formula=t;let r=[];r=e.map(a=>{for(let i of this.nodes)if(i.node===a)return i;return{node:a}});for(let a of this.nodes)if(a.listeners){for(let[i,s]of a.listeners.entries())a.node.removeEventListener(i,s);a.listeners.clear()}this.nodes=r;for(let a of this.nodes){if(a.formatted_text===a.node.textContent){let i=a.node.innerHTML.length;a.check!==i&&(a.formatted_text=void 0)}a.node.ownerDocument.activeElement===a.node&&(this.active_editor=a),this.UpdateText(a,{toll_events:!0}),this.RegisterListener(a,"focusin",()=>{this.active_editor=a}),this.RegisterListener(a,"focusout",()=>{this.active_editor=void 0}),this.RegisterListener(a,"input",i=>{i.isTrusted&&(this.UpdateText(a),this.UpdateColors())})}this.UpdateColors(!0)}},qo=class extends $o{hide_selection=!1;headless=!1;edit_state={};get scale(){return this.layout.scale}set scale(e){this.layout.scale=e,this.UpdateLayout(),this.UpdateAnnotationLayout(),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.layout.ApplyTheme(this.theme),this.overlay_editor?.UpdateScale(e),this.tab_bar?.UpdateScale(e),this.grid_events.Publish({type:"scale",scale:e});for(let t of this.model.sheets.list)for(let r of t.annotations)r.dirty=!0}theme;selected_annotation;hover_data={};editing_state=0;editing_cell={row:-1,column:-1,sheet_id:0};editing_selection;editing_annotation;pending_reset_selection=!1;view_node;container;layout;tile_update_pending=!1;scroll_offset_pending;pending_layout_update=new Set;decimal_separator_code=46;overlay_editor;autocomplete;formula_bar;RESIZE_PIXEL_BUFFER=5;external_editor_config;external_editor;cell_resize={row:-1,column:-1};render_tiles=new k({row:0,column:0});primary_selection={target:{row:0,column:0},area:new k({row:0,column:0}),empty:!0};spill_selection={target:{row:0,column:0},area:new k({row:0,column:0}),empty:!0};active_selection={target:{row:0,column:0},area:new k({row:0,column:0}),empty:!0};nub_select_flag=!1;additional_selections=[];double_click_data={};layout_token=0;render_token=0;tile_renderer;selection_renderer;tab_bar;DOM=le.GetInstance();constructor(e={},t,r=Ur,a=!0,i){if(super(e,t),this.decimal_separator_code=G.decimal_separator.charCodeAt(0),this.theme=JSON.parse(JSON.stringify(r)),!a){this.headless=!0,this.layout=new To(this.model,this.view);return}this.DOM=i,this.layout=new Do(this.model,this.view,i),e.initial_scale&&(typeof e.initial_scale=="string"&&(e.initial_scale=Number(e.initial_scale)),this.layout.scale=e.initial_scale),this.tile_renderer=new Io(this.theme,this.layout,this.model,this.view,this.options),this.selection_renderer=new Ao(this.theme,this.layout,this.model,this.view,this.primary_selection,this.additional_selections)}CopyArea(e,t="copy"){let r=(e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id):this.active_sheet)||this.active_sheet,a=r.GetCellStyle(e,!1),i=t!=="cut",s=[];for(let{cell:o,row:n,column:l}of r.cells.IterateRC(e)){let h=o.value;i&&h&&o.type===1&&(h=this.FormatR1C1(h,{row:n,column:l})[0][0]);let d=n-e.start.row,c=l-e.start.column;s[d]||(s[d]=[]);let u;o.area&&(u={start:{row:o.area.start.row-e.start.row,column:o.area.start.column-e.start.column},end:{row:o.area.end.row-e.start.row,column:o.area.end.column-e.start.column}}),s[d][c]={value:h,calculated:o.calculated,style:a[d][c],area:u}}return t==="cut"&&this.SetRange(e,void 0,{recycle:!0}),s}PasteArea(e,t,r={}){if(!t)throw new Error("no clipboad data");let a=t.length,i=t[0]?.length||0;e.Resize(Math.max(1,Math.floor(e.rows/a))*a,Math.max(1,Math.floor(e.columns/i))*i);let s=(e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id):this.active_sheet)||this.active_sheet,o=[];if(r.values)for(let[h,d]of t.entries()){o[h]=[];for(let c of d)o[h].push(typeof c.calculated>"u"?c.value:c.calculated)}let n=t,l=this.Batch(()=>{if(r.values)this.SetRange(e,o,{r1c1:!0,recycle:!0});else{this.SetRange(e,void 0,{recycle:!0});for(let h of e){let d=(h.row-e.start.row)%a,c=(h.column-e.start.column)%i,u=n[d][c];if(u.area){if(u.area.start.row===d&&u.area.start.column===c){let m=new k(u.area.start,u.area.end);m.Shift(e.start.row,e.start.column),this.SetRange(m,u.value,{r1c1:!0,array:!0})}}else u.value&&this.SetRange(new k(h),u.value,{r1c1:!0})}}if(r.formatting==="number-formats")for(let h of e){let d=(h.row-e.start.row)%a,c=(h.column-e.start.column)%i,u=(n[d][c].style||{}).number_format;s.UpdateCellStyle(h,{number_format:u},!0)}else if(r.formatting!=="target")for(let h of e){let d=(h.row-e.start.row)%a,c=(h.column-e.start.column)%i;s.UpdateCellStyle(h,n[d][c].style||{},!1)}},!0);this.grid_events.Publish(l)}Reselect(){this.primary_selection.empty||this.Select(this.primary_selection,this.primary_selection.area,this.primary_selection.target)}SetNote(e,t){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.target}this.ExecCommand({key:14,area:e,note:t})}FindAnnotation(e){for(let t of this.active_sheet.annotations)if((t.view[this.view_index]||{}).node===e)return t}CreateAnnotation(e={},t=this.active_sheet,r=!0,a=!1,i,s){this.ExecCommand({key:34,properties:e,add_to_sheet:r,offset:a,target:i,focus:s,sheet:t})}CreateAnnotationInternal(e){let t=new Vr(e.properties);if(e.offset)if(!t.data.layout&&t.scaled_rect&&(t.data.layout=this.layout.RectToAnnotationLayout(t.scaled_rect)),!t.data.layout)console.warn("can't offset annotation without layout");else{let r=this.layout.AnnotationLayoutToRect(t.data.layout).Shift(20,20),a=!0;for(;a;){a=!1;for(let i of e.sheet.annotations)if(i!==t&&i.scaled_rect&&i.scaled_rect.top===r.top&&i.scaled_rect.left===r.left){r=r.Shift(20,20),a=!0;break}}t.data.layout=this.layout.RectToAnnotationLayout(r)}if(e.target&&(ie.IsRectangle(e.target)?(t.data.layout=void 0,t.rect=ie.Create(e.target)):e.target.start&&(t.rect=void 0,t.data.layout=this.layout.AddressToAnnotationLayout(e.target.start,e.target.end||e.target.start))),e.add_to_sheet&&(e.sheet.annotations.some(r=>r===t)||e.sheet.annotations.push(t),this.AddAnnotation(t)),e.focus){let r=t.view[this.view_index];if(r&&r.node){let a=r.node;setTimeout(()=>{a.focus()},1)}}}UpdateAnnotationLayout(){}AddAnnotation(e,t=!1,r=!0){let a=e.view[this.view_index];if(a||(a={},e.view[this.view_index]=a),!a.node){let i=this.DOM.Div("annotation",void 0,{data:{scale:this.layout.scale.toString()},style:{fontSize:`${10*this.layout.scale}pt`},attrs:{tabindex:"-1"},events:{mousedown:n=>{n.button===0&&this.layout.AnnotationMouseDown(e,i,n,s,o).then(l=>{l?this.grid_events.Publish(l):this.selected_annotation!==e&&this.grid_events.Publish({type:"annotation",annotation:e,event:"select"}),e.data.layout&&this.EnsureAddress(e.data.layout.br.address,1)})},focusin:()=>{for(let n of this.layout.GetFrozenAnnotations(e))n.classList.add("clone-focus");this.selected_annotation=e,this.primary_selection.empty=!0,this.primary_selection.target={row:-1,column:-1,sheet_id:this.active_sheet.id},this.HideGridSelection()},focusout:n=>{for(let l of this.layout.GetFrozenAnnotations(e))l.classList.remove("clone-focus");this.formula_bar&&this.formula_bar.IsElement(n.relatedTarget)?(this.primary_selection.empty=!0,this.RenderSelections(),this.editing_annotation=e,this.layout.ShowSelections(!0)):this.formula_bar?.IsExpandButton(n.relatedTarget)||this.layout.FocusInLayout(n.relatedTarget||void 0)&&(this.selected_annotation===e&&(this.selected_annotation=void 0),this.ShowGridSelection())}}});a.node=i,a.content_node=this.DOM.Div("annotation-content",i);let s=this.DOM.Div("annotation-move-target",i),o=this.DOM.Div("annotation-resize-target",i);i.addEventListener("keydown",n=>{let l=e.scaled_rect;if(!l){console.info("missing scaled rect!");return}let h=[i,...this.layout.GetFrozenAnnotations(e)];if(n.ctrlKey||ae.is_mac&&n.metaKey){let c=e.data.style?{...e.data.style}:{},u=!0;switch(n.key){case"b":this.ApplyAnnotationStyle({bold:!c.bold});break;case"i":this.ApplyAnnotationStyle({italic:!c.italic});break;case"u":this.ApplyAnnotationStyle({underline:!c.underline});break;default:u=!1}if(u){n.stopPropagation(),n.preventDefault();return}}let d={x:l.left,y:l.top};switch(n.key){case"ArrowUp":case"Up":n.ctrlKey?(this.layout.AnnotationLayoutOrder(e,1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),i.focus()):d.y--;break;case"ArrowLeft":case"Left":if(n.ctrlKey)return;d.x--;break;case"ArrowRight":case"Right":if(n.ctrlKey)return;d.x++;break;case"ArrowDown":case"Down":n.ctrlKey?(this.layout.AnnotationLayoutOrder(e,-1)&&this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),i.focus()):d.y++;break;case"Escape":case"Esc":this.Focus();break;case"Backspace":n.metaKey&&ae.is_mac&&(this.Focus(),this.RemoveAnnotation(e));break;case"Delete":case"Del":this.Focus(),this.RemoveAnnotation(e);break;default:return}if(n.stopPropagation(),n.preventDefault(),d.x=Math.max(d.x,0),d.y=Math.max(d.y,0),l.left!==d.x||l.top!==d.y){l.left=Math.round(d.x),l.top=Math.round(d.y);for(let c of h)c.style.top=l.top+"px",c.style.left=l.left+"px";e.data.extent=void 0,this.grid_events.Publish({type:"annotation",event:"move",annotation:e}),e.data.layout=this.layout.RectToAnnotationLayout(l)}})}r&&(this.layout.AddAnnotation(e,this.theme),e.data.layout&&this.EnsureAddress(e.data.layout.br.address,1,t)),t||this.grid_events.Publish({type:"annotation",annotation:e,event:"create"})}AnnotationUpdated(e){this.layout.CloneFrozenAnnotation(e)}RemoveAnnotation(e,t=this.active_sheet){this.ExecCommand({key:35,annotation:e,sheet:t})}RemoveAnnotationInternal(e){super.RemoveAnnotationInternal(e),this.layout.RemoveAnnotation(e.annotation)}RemoveAnnotationNodes(){this.headless||this.layout.RemoveAnnotationNodes()}ShowHeaders(e=!0){this.ExecCommand({key:18,show:e})}FromImportData(e,t=!1){this.RemoveAnnotationNodes();let r=e.sheets,a=r.map(()=>ge.Blank(this.model.theme_style_properties).toJSON()),i;if(typeof e.active_tab=="number")i=a[e.active_tab]?.id;else for(let o=0;o<e.sheets.length;o++)if(!e.sheets[o].hidden){i=a[o].id;break}this.UpdateSheets(a,!0,i);let s={};this.model.macro_functions.clear(),this.ClearSelection(this.primary_selection),this.model.tables.clear();for(let o=0;o<r.length;o++){let n=this.model.sheets.list[o];n.ImportData(r[o]),s[n.name]=n.id;for(let l of r[o].cells)l.table&&(l.table.area.start.sheet_id=n.id,this.model.tables.set(l.table.name.toLowerCase(),l.table));for(let l of this.model.tables.values())this.UpdateTableColumns(l)}this.model.sheets.UpdateIndexes(),this.model.named.Reset(),e.named&&this.model.UnserializeNames(e.named,this.active_sheet,!0);for(let o of this.active_sheet.annotations)this.AddAnnotation(o,!0);this.ActivateSheetTasks(),this.QueueLayoutUpdate(),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}NextSheet(e=1){if(this.model.sheets.length===1)return;let t=this.model.sheets.list.map((r,a)=>({sheet:r,index:a})).filter(r=>r.sheet.visible);if(t.length!==1){for(let r=0;r<t.length;r++)if(t[r].sheet===this.active_sheet){let a=(r+e)%t.length;for(;a<0;)a+=t.length;this.ActivateSheet(t[a].index);return}}}UpdateSheets(e,t=!1,r){if(super.UpdateSheets(e,t,r),this.RemoveAnnotationNodes(),this.ClearSelection(this.primary_selection),e[0]&&e[0].primary_selection){let a=e[0].primary_selection;a.empty||this.Select(this.primary_selection,new k(a.area.start,a.area.end),a.target)}else if(!this.active_sheet.selection.empty){let a=this.active_sheet.selection;this.Select(this.primary_selection,new k(a.area.start,a.area.end),a.target)}this.layout.ClearLayoutCaches();for(let a of this.model.sheets.list)for(let i of a.annotations)this.AddAnnotation(i,!0,a===this.active_sheet);this.ActivateSheetTasks(),this.QueueLayoutUpdate(JSON.parse(JSON.stringify(this.active_sheet.scroll_offset))),this.StyleDefaultFromTheme(),t&&this.Repaint(!1,!1),this.tab_bar&&this.tab_bar.Update()}UpdateLayout(){this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!0)}UpdateTabBar(){this.tab_bar&&this.tab_bar.Update()}UpdateTheme(e=!1,t){if(!e)for(let a of Object.keys(this.theme))delete this.theme[a];let r=JSON.parse(JSON.stringify(Ur));this.view_node&&(r={...Ko(this.view_node,this.options.support_font_stacks)}),r={...this.theme,...r,...t},Object.assign(this.theme,r),this.StyleDefaultFromTheme(),this.active_sheet.UpdateDefaultRowHeight(this.theme),this.active_sheet.FlushCellStyles(),this.layout.ApplyTheme(this.theme),this.tab_bar&&this.tab_bar.UpdateTheme(),e||(this.UpdateLayout(),this.overlay_editor?.UpdateScale(this.layout.scale),this.Repaint(!0,!0,!0))}SetScale(e){e=Math.round(e*1e3)/1e3,e=Math.min(2,Math.max(e,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:e})),this.scale=e}Initialize(e,t=!1){if(!this.tile_renderer||!this.selection_renderer)return;this.view_node=e,this.UpdateTheme(!0);let r=e.querySelector(".treb-spreadsheet-body").querySelector("div");this.options.formula_bar&&(this.autocomplete||(this.autocomplete=new ka({theme:this.theme,container:r})),this.InitFormulaBar(e,this.autocomplete)),this.options.tab_bar&&(this.tab_bar=new zo(this.layout,this.model,this.view,this.options,this.theme,e),this.tab_bar.Subscribe(a=>{switch(a.type){case"cancel":break;case"scale":{let i=this.layout.scale;if(i=Math.round(a.value*1e3)/1e3,i=Math.min(2,Math.max(i,.5)),this.options.persist_scale_key&&localStorage.setItem(this.options.persist_scale_key,JSON.stringify({scale:i})),this.scale=i,a.keep_focus)return}break;case"reorder-sheet":this.ReorderSheet(a.index,a.move_before);break;case"delete-sheet":this.DeleteSheet();break;case"add-sheet":this.AddSheet();break;case"rename-sheet":this.RenameSheet(a.sheet,a.name);break;case"activate-sheet":this.ActivateSheetID(a.sheet.id);break}this.SelectingArgument()||this.Focus()})),this.container=r,this.container.classList.add("treb-grid"),ae.is_mac&&ae.is_safari&&this.container.classList.add("safari"),this.container.setAttribute("tabindex","-1"),this.layout.Initialize(r,{scroll:()=>this.OnScroll(),dropdown:a=>this.OnDropdownSelect(a),sort:(a,i,s)=>{let o=this.model.tables.get(a.toLowerCase());o&&this.SortTable(o,{column:i,asc:s})},focus:()=>this.Focus()},this.options.scrollbars),this.selection_renderer.Initialize(),this.layout.UpdateTiles(),this.autocomplete||(this.autocomplete=new ka({theme:this.theme,container:r})),this.InitOverlayEditor(this.autocomplete),this.AttachListeners(),this.render_tiles=this.layout.VisibleTiles(),t||(this.tab_bar?.Update(),this.Repaint(!0))}MergeCells(e){!e&&this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:10,area:e||this.primary_selection.area}))}UnmergeCells(e){!e&&this.primary_selection.empty||(this.layout.HideDropdownCaret(),this.ExecCommand({key:11,area:e||this.primary_selection.area}))}GetAnnotationStyle(){if(this.selected_annotation)return this.selected_annotation.data?.style?JSON.parse(JSON.stringify(this.selected_annotation.data.style)):{}}ApplyAnnotationStyle(e={},t=!0){if(this.selected_annotation){let r=this.selected_annotation;r.data.style=JSON.parse(JSON.stringify(t?H.Composite([r.data.style||{},e]):e));let a=r.view[this.view_index]?.node;this.layout.UpdateAnnotation(r,this.theme),a&&a.focus(),this.grid_events.Publish({type:"annotation",event:"update",annotation:r}),this.DelayedRender()}}AnnotationSelected(){return!!this.selected_annotation}Focus(e="",t=!1){if(this.selected_annotation)if(t)this.editing_annotation===this.selected_annotation?this.pending_reset_selection=!0:(this.selected_annotation=void 0,this.ShowGridSelection());else{this.selected_annotation.view[this.view_index].node?.focus();return}ae.is_mobile?this.container?.focus():this.overlay_editor?.Focus(e)}SetValidation(e,t,r){if(!e){if(this.primary_selection.empty)throw new Error("invalid target in set validation");e=this.primary_selection.area}let a=new k(e.start,e.end),i={key:26,area:{start:a.start,end:a.end},error:r};t&&(Array.isArray(t)?i.list=t:typeof t=="object"&&t.start&&t.end&&$(t.start)&&$(t.end)&&(i.range=t)),this.ExecCommand(i),!this.primary_selection.empty&&(!e.start.sheet_id||e.start.sheet_id===this.active_sheet.id)&&a.Contains(this.primary_selection.target)&&requestAnimationFrame(()=>this.Select(this.primary_selection,this.primary_selection.area,this.primary_selection.target))}SetName(e,t,r,a,i=!1){let s=this.model.named.ValidateNamed(e);if(!s)throw new Error("invalid name");if(e=s,this.autocomplete_matcher){let n=this.autocomplete_matcher.Get(e);if(n&&(!n.named||!i)&&(t||r))throw new Error("name already defined")}let o={key:17,name:e,scope:a};if(t)$(t)&&(t=new k(t)),t.start.sheet_id||(t=new k({...t.start,sheet_id:this.active_sheet.id},t.end)),o.area=new k(t.start,t.end);else if(r){let n=this.parser.Parse(r);if(n.valid&&n.expression)this.parser.Walk(n.expression,l=>{if(l.type==="address"||l.type==="range"){if(l.type==="range"&&(l=l.start),!l.sheet_id&&l.sheet){let h=this.model.sheets.Find(l.sheet);h&&(l.sheet_id=h.id)}return l.sheet_id||(l.sheet_id=this.active_sheet.id),!1}return!0}),o.expression=n.expression;else throw console.info({expression:r,parse_result:n}),new Error("invalid expression")}this.ExecCommand(o)}SelectAll(){this.Select(this.primary_selection,new k({row:1/0,column:1/0}),void 0,!0),this.RenderSelections()}ExternalEditor(e){if(this.external_editor_config=e,e){let t=(e.dependencies||[]).filter(r=>!!r).map(r=>$(r)?new k(r):new k(r.start,r.end));if(e.nodes?.length){if(!this.external_editor){let r=new Bo(this.model,this.view);this.external_editor=r,r.Subscribe(()=>this.HighlightDependencies(r.dependencies))}this.external_editor.AttachNodes(e.nodes,e.assume_formula??!0)}else this.external_editor&&this.external_editor.Reset();e.dependencies&&this.HighlightDependencies(t)}else this.external_editor&&this.external_editor.Reset(),this.ClearAdditionalSelections(),this.RenderSelections(!0)}SelectRange(e){this.Select(this.primary_selection,e),this.RenderSelections()}GetRangeStyle(e,t=!1){let r=0;if($(e)?r=e.sheet_id||this.active_sheet.id:r=e.start.sheet_id||this.active_sheet.id,r)return this.model.sheets.Find(r)?.GetCellStyle(e,t)||void 0}FormatR1C1(e,t){Pr(t)&&(t=t.start),Array.isArray(e)||(e=[[e]]);let r={type:"address",label:"",row:t.row,column:t.column,sheet:t.sheet_id?this.model.sheets.Name(t.sheet_id):this.active_sheet.name,position:0,id:0};for(let a=0;a<e.length;a++){let i=e[a];for(let s=0;s<i.length;s++){let o=i[s];if(typeof o=="string"&&o[0]==="="){let n=this.parser.Parse(o);n.expression&&(i[s]="="+this.parser.Render(n.expression,{missing:"",r1c1:!0,r1c1_base:{...r,row:t.row+a,column:t.column+s}}))}}}return e}GetRange(e,t){if($(e)){let a=this.model.sheets.Find(e.sheet_id||this.active_sheet.id);if(a){if(t==="A1"||t==="R1C1"){let i=a.cells.RawValue(e);return t==="R1C1"?this.FormatR1C1(i,e):i}return t==="formatted"?a.GetFormattedRange(e):a.cells.GetRange(e)}return}let r=this.model.sheets.Find(e.start.sheet_id||this.active_sheet.id);if(r){if(t==="A1"||t==="R1C1"){let a=r.cells.RawValue(e.start,e.end);return t==="R1C1"?this.FormatR1C1(a,e):a}return t==="formatted"?r.GetFormattedRange(e.start,e.end):r.cells.GetRange(e.start,e.end)}}SetRange(e,t,r={}){let{recycle:a,transpose:i,array:s,r1c1:o}=r;if(r.argument_separator){let n={argument_separator:this.parser.argument_separator,decimal_mark:this.parser.decimal_mark};this.parser.Save();let l=!1;if(r.argument_separator===","&&this.parser.argument_separator!==","&&(this.parser.SetLocaleSettings("."),l=!0),r.argument_separator===";"&&this.parser.argument_separator!==";"&&(this.parser.SetLocaleSettings(","),l=!0),l){this.parser.flags.r1c1=o;let h=d=>{if(typeof d=="string"&&d[0]==="="){let c=this.parser.Parse(d);c.expression&&(d="="+this.parser.Render(c.expression,{missing:"",convert_decimal:n.decimal_mark,convert_argument_separator:n.argument_separator,pass_through_addresses:!0}))}return d};Array.isArray(t)?t=t.map(d=>Array.isArray(d)?d.map(c=>h(c)):h(d)):t=h(t)}this.parser.Restore()}if(t=this.model.UntranslateData(t,{r1c1:o}),!Array.isArray(t))a||s?this.ExecCommand({key:6,area:e,value:t,array:s,r1c1:o}):this.ExecCommand({key:6,area:e.start,value:t,array:s,r1c1:o});else{if(Ui(t)){if(a){if(e.rows>t.length){let l=Math.floor(e.rows/t.length);if(l>1){let h=[...t];for(let d=0;d<l;d++){let c=JSON.parse(JSON.stringify(h));t.push(...c)}}}let n=0;for(let l of t)n=Math.max(n,l.length);if(e.columns>n){let l=Math.floor(e.columns/n);if(l>1)for(let h of t){for(;h.length<n;)h.push(void 0);let d=[...h];for(let c=0;c<l;c++){let u=JSON.parse(JSON.stringify(d));h.push(...u)}}}}}else if(a){let n=e.entire_column?this.active_sheet.rows:e.rows,l=e.entire_row?this.active_sheet.columns:e.columns,h=n*l;if(h>t.length){let c=t.slice(0),u=Math.ceil(h/c.length);for(let m=1;m<u;m++)c=c.concat(t.slice(0));t=c}let d=[];for(let c=0,u=0;c<l;c++,u+=n)d[c]=t.slice(u,u+n);t=d}else t=[t];i&&(t=this.Transpose(t)),this.ExecCommand({key:6,area:e,value:t,array:s,r1c1:o})}!this.primary_selection.empty&&e.Contains(this.primary_selection.target)&&this.UpdateFormulaBarFormula()}ApplyStyle(e,t={},r=!0){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}ge.UpdateStyle(t),this.ExecCommand({key:7,area:e,style:t,delta:r}),this.UpdateFormulaBarFormula()}GetSelection(){return this.primary_selection}Update(e=!1,t){this.DelayedRender(e,t)}UpdateAnnotations(){this.active_sheet.annotations.length&&this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)}Indent(e,t=0){if(!e){if(this.primary_selection.empty)return;e=this.active_sheet.RealArea(this.primary_selection.area)}this.ExecCommand({key:9,area:e,delta:t})}ApplyBorders2(e,t="none",r,a=1){if(!e){if(this.primary_selection.empty)return;e=this.primary_selection.area}t==="none"&&(a=0),this.ExecCommand({key:8,color:r,area:e,borders:t,width:a})}Batch(e,t=!0){if(this.batch===0?this.batch_paint=t:this.batch_paint=this.batch_paint||t,this.batch++,e(),this.batch--,this.batch===0){let r=this.batch_events.slice(0);return this.batch_events=[],this.batch_paint&&this.DelayedRender(!1),r}return[]}ScrollTo(e,t=!0,r=!0,a=!1){this.layout.ScrollTo(e,t,r,a)}ScrollIntoView(e,t=!1){this.options.scrollbars&&this.layout.ScrollIntoView(e,t)}GetScrollOffset(){return this.layout.GetScrollOffset()}ScrollOffset(e){if(e)this.layout.scroll_offset=e;else return this.layout.scroll_offset}RenameSheetInternal(e,t){super.RenameSheetInternal(e,t),this.tab_bar?.Update()}StyleDefaultFromTheme(){this.model.theme_style_properties.font_face=this.theme.grid_cell?.font_face||"",this.model.theme_style_properties.font_size=this.theme.grid_cell?.font_size||{unit:"pt",value:10}}AutoSizeRow(e,t,r=!0){if(!this.tile_renderer)return;let a=e.GetRowHeight(t),i=0,s=6;for(let o=0;o<e.cells.columns;o++){let n=e.CellData({row:t,column:o}),{height:l}=this.tile_renderer.MeasureText(n,e.GetColumnWidth(o),1);i=Math.max(i,l+s)}r||(i=Math.max(a,i)),i>s+2&&e.SetRowHeight(t,i)}AutoSizeColumn(e,t,r=!0){if(!this.tile_renderer)return;let a=e.GetColumnWidth(t),i=0,s=14;for(let o=0;o<e.cells.rows;o++){let n=e.CellData({row:o,column:t}),{width:l}=this.tile_renderer.MeasureText(n,a,1);i=Math.max(i,l+s)}r||(i=Math.max(a,i)),i>s+2&&e.SetColumnWidth(t,i)}EnsureActiveSheet(e=!1){for(let t of this.model.sheets.list)if(t===this.active_sheet){e&&this.ActivateSheetInternal({key:22,id:t.id,force:!0});return}this.ActivateSheetInternal({key:22,index:0})}RefreshAnnotations(){this.RemoveAnnotationNodes();for(let e of this.active_sheet.annotations)this.AddAnnotation(e,!0,!0)}ActivateSheetInternal(e){let t=this.SelectingArgument(),r=this.ResolveSheet(e)||this.model.sheets.list[0];if(this.active_sheet===r&&!e.force)return;if(!r.visible)throw new Error("cannot activate hidden sheet");this.HideHoverInfo(),this.active_sheet.selection=JSON.parse(JSON.stringify(this.primary_selection)),this.active_sheet.scroll_offset=this.layout.scroll_offset;let a=this.active_sheet;this.RemoveAnnotationNodes(),this.active_sheet=r,t?this.RenderSelections():(this.ClearSelection(this.primary_selection),r.selection&&!r.selection.empty&&this.Select(this.primary_selection,new k(r.selection.area.start,r.selection.area.end),r.selection.target));let i=this.active_sheet.annotations;for(let s of i)this.AddAnnotation(s,!0);this.ActivateSheetTasks(),this.QueueLayoutUpdate(),this.pending_layout_update.has(this.active_sheet.id)?(this.Repaint(!0,!0),this.pending_layout_update.delete(this.active_sheet.id)):this.Repaint(!1,!1),this.grid_events.Publish({type:"sheet-change",deactivate:a,activate:this.active_sheet}),this.tab_bar&&this.tab_bar.Update(),this.layout.scroll_offset=this.active_sheet.scroll_offset,this.formula_bar?.selecting&&requestAnimationFrame(()=>this.formula_bar?.FocusEditor())}ActivateSheetTasks(){if(this.active_sheet.Activate(this.DOM),this.active_sheet.image&&!this.active_sheet.image.complete){let e=this.active_sheet.image,t=0,r=()=>{e.complete?this.UpdateLayout():t++<5&&setTimeout(()=>r(),10)};r()}}HighlightFreezeArea(){for(let e of[this.layout.corner_selection,this.layout.row_header_selection,this.layout.column_header_selection])e.classList.add("highlight-area"),setTimeout(()=>{e.classList.remove("highlight-area")},400)}QueueLayoutUpdate(e){this.tile_update_pending=!0,e&&(this.scroll_offset_pending=e)}HandleAddressLabelEvent(e){if(e){let t=(s="")=>{let o=s.toLowerCase();for(let n of this.model.sheets.list)if(n.name.toLowerCase()===o)return n.id;return this.active_sheet.id},r=s=>{for(let o of this.model.sheets.list)if(o.id===s)return o;return this.active_sheet},a,i=this.parser.Parse(e);if(i.expression)switch(i.expression.type){case"address":i.expression.sheet_id=t(i.expression.sheet),a=new k(i.expression);break;case"range":i.expression.start.sheet_id=t(i.expression.start.sheet),a=new k(i.expression.start,i.expression.end);break;case"identifier":{let s=this.model.GetName(i.expression.name,this.active_sheet.id);s?.type==="range"&&(a=s.area),a||this.primary_selection.empty||this.SetName(i.expression.name.toUpperCase(),this.primary_selection.area)}break}if(a){let s=r(a.start.sheet_id);if(s.columns>=a.end.column&&s.rows>=a.end.row){this.ExecCommand({key:5,area:a});return}else console.warn("address out of range")}}this.UpdateAddressLabel(),this.Focus()}InitFormulaBar(e,t){this.formula_bar=new Vo(e,this.model,this.view,this.options,t),this.formula_bar.autocomplete_matcher=this.autocomplete_matcher,this.formula_bar.Subscribe(r=>{switch(r.type){case"address-label-event":this.HandleAddressLabelEvent(r.text);break;case"stop-editing":this.pending_reset_selection&&this.ShowGridSelection(),this.pending_reset_selection=!1,this.editing_state=0;break;case"start-editing":this.editing_state=2,this.editing_cell={...this.primary_selection.target},this.editing_selection={...this.primary_selection};break;case"toll":this.editing_state=0,this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.DelayedRender();break;case"discard":if(this.editing_state=0,this.editing_annotation){this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection);let a=this.editing_annotation.view[this.view_index]?.node;a&&a.focus(),this.editing_annotation=void 0,this.UpdateFormulaBarFormula(),this.DelayedRender();return}this.container&&this.Focus(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.UpdateFormulaBarFormula(),this.DelayedRender();break;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=0,this.editing_annotation){let a=this.editing_annotation;if(this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),a.data.formula=r.value?this.FixFormula(r.value):"",!this.pending_reset_selection){let i=this.editing_annotation.view[this.view_index]?.node;i&&i.focus()}this.grid_events.Publish({type:"annotation",event:"update",annotation:a}),this.editing_annotation=void 0,this.DelayedRender();return}this.container&&this.Focus(),r.event?this.SetInferredType(this.primary_selection,r.value,r.array):this.editing_selection&&this.SetInferredType(this.editing_selection,r.value,r.array),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.primary_selection.area),r.event&&this.OverlayKeyDown(r.event);break;case"update":r.dependencies&&this.HighlightDependencies(r.dependencies);break}})}InitOverlayEditor(e){this.container&&(this.overlay_editor=new No(this.container,this.theme,this.model,this.view,e),this.overlay_editor.UpdateScale(this.layout.scale),this.overlay_editor.autocomplete_matcher=this.autocomplete_matcher,this.overlay_editor.Subscribe(t=>{switch(t.type){case"stop-editing":this.editing_state=0;break;case"start-editing":this.editing_state=1,this.editing_cell={...this.primary_selection.target};break;case"update":t.dependencies&&this.HighlightDependencies(t.dependencies);break;case"end-selection":case"reset-selection":this.ClearSelection(this.active_selection),this.overlay_editor?.target_address?.sheet_id&&this.active_sheet.id!==this.overlay_editor.target_address.sheet_id&&this.ActivateSheetID(this.overlay_editor.target_address.sheet_id),this.DelayedRender();break}}))}DelayedRender(e=!1,t,r=!1){!this.tile_update_pending&&t?this.layout.DirtyArea(t):!this.tile_update_pending&&e&&this.layout.DirtyAll(),this.render_token||(this.render_token=1,Promise.resolve().then(()=>{this.render_token=0,this.Repaint(e,r)}))}Repaint(e=!1,t=!1,r=!1){if(this.headless||!this.tile_renderer)return;if(this.tile_update_pending&&(this.tile_update_pending=!1,this.layout.UpdateTiles(),this.scroll_offset_pending&&(this.layout.scroll_offset=this.scroll_offset_pending,this.scroll_offset_pending=void 0),this.render_tiles=this.layout.VisibleTiles(),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)),this.layout_token=0,this.tile_renderer.OverflowDirty(t),e)for(let n of this.layout.grid_tiles)for(let l of n)l.dirty=!0;let a=this.render_tiles.start,i=this.render_tiles.end,s=[];for(let n=a.row;n<=i.row;n++)s.push(n);let o=[];for(let n=a.column;n<=i.column;n++)o.push(n);a.row>0&&this.active_sheet.freeze.rows&&s.push(0),a.column>0&&this.active_sheet.freeze.columns&&o.push(0);for(let n of o)for(let l of s){let h=this.layout.grid_tiles[n][l];(e||h.dirty||h.needs_full_repaint)&&(this.tile_renderer.Render(h),h.dirty=h.needs_full_repaint=!1)}this.tile_renderer.RenderHeaders(this.render_tiles,r),this.tile_renderer.RenderCorner(),this.RenderSelections()}MouseMove_RowHeader(e){let t=this.layout.CoordinateToRowHeader(e.offsetY),r=this.layout.OffsetCellAddressToRectangle({row:t.row,column:0});this.hover_data.address&&(this.hover_data.address.row!==-1||this.hover_data.address.column!==-1)&&this.HoverCell({row:-1,column:-1});let a=-1;e.offsetY-r.top<=this.RESIZE_PIXEL_BUFFER&&t.row>0?a=t.row-1:r.bottom-e.offsetY<=this.RESIZE_PIXEL_BUFFER&&(a=t.row),a>=0?this.layout.ResizeCursor("row"):this.cell_resize.row&&(this.cell_resize.row=-1,this.layout.ResizeCursor()),this.cell_resize.row=a}MouseMove_ColumnHeader(e){let t=this.layout.CoordinateToColumnHeader(e.offsetX),r=this.layout.OffsetCellAddressToRectangle({row:0,column:t.column});this.hover_data.address&&(this.hover_data.address.row!==-1||this.hover_data.address.column!==-1)&&this.HoverCell({row:-1,column:-1});let a=-1;e.offsetX-r.left<=this.RESIZE_PIXEL_BUFFER&&t.column>0?a=t.column-1:r.right-e.offsetX<=this.RESIZE_PIXEL_BUFFER&&(a=t.column),a>=0?this.layout.ResizeCursor("column"):this.cell_resize.column&&(this.cell_resize.column=-1,this.layout.ResizeCursor()),this.cell_resize.column=a}MouseDown_RowHeader(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToRowHeader(e.offsetY),r=this.layout.row_header_cover.getBoundingClientRect(),a={x:r.left,y:r.top};if(this.cell_resize.row>=0){let i=this.cell_resize.row,s=a.y+e.offsetY;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:i,column:-1})){let u=[i];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(i)){let m=this.active_sheet.RealArea(this.primary_selection.area);u=[];for(let f=m.start.row;f<=m.end.row;f++)u.push(f)}this.ExecCommand({key:3,row:u});return}let o=this.layout.RowHeight(i),n=o,l=this.layout.OffsetCellAddressToRectangle({row:i,column:0}),h=a.y+l.bottom;this.layout.ShowTooltip({left:!0,text:`${n}px`,x:Math.round(r.right+10),y:h});let d=[],c=[];for(let u of this.active_sheet.annotations){let m=l.bottom-1;if(!u.scaled_rect||u.scaled_rect.bottom<m)continue;let f=[...this.layout.GetFrozenAnnotations(u)],p=u.view[this.view_index]?.node;p&&f.push(p),m<=u.scaled_rect.top&&u.data.move_with_cells?d.push({annotation:u,y:u.scaled_rect.top,nodes:f}):m>u.scaled_rect.top&&u.data.resize_with_cells&&c.push({annotation:u,height:u.scaled_rect.height,nodes:f})}Be(this.layout.mask,"row-resize",u=>{let m=Math.max(-o,Math.round(u.offsetY-s));if(m+o!==n){n=m+o,this.layout.SetRowHeight(i,n),this.layout.UpdateTooltip({text:`${n}px`,y:h+m});for(let{annotation:f,y:p}of d)f.scaled_rect&&(f.scaled_rect.top=p+m);for(let{annotation:f,height:p}of c)f.scaled_rect&&(f.scaled_rect.height=p+m);requestAnimationFrame(()=>{for(let{annotation:f,nodes:p}of c)if(f.scaled_rect)for(let b of p)f.scaled_rect.ApplyStyle(b);for(let{annotation:f,nodes:p}of d)if(f.scaled_rect)for(let b of p)f.scaled_rect.ApplyStyle(b);this.layout.UpdateTileHeights(!0,i),this.Repaint(!1,!0),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme)})}},()=>{this.layout.HideTooltip(),requestAnimationFrame(()=>{let u=[i];if(!this.primary_selection.empty&&this.primary_selection.area.rows>1&&this.primary_selection.area.start.column===1/0&&this.primary_selection.area.ContainsRow(i)){let m=this.active_sheet.RealArea(this.primary_selection.area);u=[];for(let f=m.start.row;f<=m.end.row;f++)u.push(f)}this.layout.SetRowHeight(i,o),this.ExecCommand({key:3,row:u,height:n/this.scale});for(let{annotation:m}of d)m.scaled_rect&&(m.data.layout=this.layout.RectToAnnotationLayout(m.scaled_rect));for(let{annotation:m}of c){m.scaled_rect&&(m.data.layout=this.layout.RectToAnnotationLayout(m.scaled_rect));let f=m.view[this.view_index];f&&f.resize_callback&&f.resize_callback.call(void 0)}})})}else{let i=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(void 0,!0),e.shiftKey&&!i.empty){let s=i.target;this.Select(i,new k(i.target,t,!0),void 0,!0),t=s}else this.Select(i,new k(t),{column:0,row:t.row});this.RenderSelections(),Be(this.layout.mask,[],s=>{let o=this.layout.CoordinateToRowHeader(s.offsetY-a.y),n=new k(o,t,!0);(i.empty||!n.Equals(i.area))&&(this.Select(i,n,void 0,!0),this.RenderSelections())},()=>{})}}MouseDown_ColumnHeader(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.layout.CoordinateToColumnHeader(e.offsetX),r=this.layout.column_header_cover.getBoundingClientRect(),a={x:r.left,y:r.top};if(this.cell_resize.column>=0){let i=this.cell_resize.column,s=a.x+e.offsetX;if(this.layout.HideDropdownCaret(),this.IsDoubleClick({row:-1,column:i})){let u=[i];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(i)){let m=this.active_sheet.RealArea(this.primary_selection.area);u=[];for(let f=m.start.column;f<=m.end.column;f++)u.push(f)}this.ExecCommand({key:4,column:u});return}let o=this.layout.ColumnWidth(i),n=o,l=this.layout.OffsetCellAddressToRectangle({row:0,column:i}),h=a.x+l.right;this.layout.ShowTooltip({up:!0,text:`${n}px`,x:h,y:Math.round(r.bottom+10)});let d=[],c=[];for(let u of this.active_sheet.annotations){let m=l.right-1;if(!u.scaled_rect||u.scaled_rect.right<m)continue;let f=[...this.layout.GetFrozenAnnotations(u)],p=u.view[this.view_index]?.node;p&&f.push(p),m<=u.scaled_rect.left&&u.data.move_with_cells?d.push({annotation:u,x:u.scaled_rect.left,nodes:f}):m>u.scaled_rect.left&&u.data.resize_with_cells&&c.push({annotation:u,width:u.scaled_rect.width,nodes:f})}Be(this.layout.mask,"column-resize",u=>{let m=Math.max(-o,Math.round(u.offsetX-s));if(m+o!==n){n=m+o,this.layout.UpdateTooltip({text:`${n}px`,x:h+m}),this.layout.SetColumnWidth(i,n);for(let{annotation:f,x:p}of d)f.scaled_rect&&(f.scaled_rect.left=p+m);for(let{annotation:f,width:p}of c)f.scaled_rect&&(f.scaled_rect.width=p+m);requestAnimationFrame(()=>{for(let{annotation:f,nodes:p}of c)if(f.scaled_rect)for(let b of p)f.scaled_rect.ApplyStyle(b);for(let{annotation:f,nodes:p}of d)if(f.scaled_rect)for(let b of p)f.scaled_rect.ApplyStyle(b);this.layout.UpdateTileWidths(!0,i),this.Repaint(!1,!0)})}},()=>{this.layout.HideTooltip(),requestAnimationFrame(()=>{let u=[i];if(!this.primary_selection.empty&&this.primary_selection.area.columns>1&&this.primary_selection.area.start.row===1/0&&this.primary_selection.area.ContainsColumn(i)){let m=this.active_sheet.RealArea(this.primary_selection.area);for(let f=m.start.column;f<=m.end.column;f++)u.push(f)}this.ExecCommand({key:4,column:u,width:n});for(let{annotation:m}of d)m.scaled_rect&&(m.data.layout=this.layout.RectToAnnotationLayout(m.scaled_rect));for(let{annotation:m}of c){m.scaled_rect&&(m.data.layout=this.layout.RectToAnnotationLayout(m.scaled_rect));let f=m.view[this.view_index];f&&f.resize_callback&&f.resize_callback.call(void 0)}})})}else{let i=this.SelectingArgument()?this.active_selection:this.primary_selection;if(this.SelectingArgument()||this.Focus(void 0,!0),e.shiftKey&&!i.empty){let s=i.target;this.Select(i,new k(i.target,t,!0),void 0,!0),t=s}else this.Select(i,new k(t),{row:0,column:t.column});this.RenderSelections(),Be(this.layout.mask,[],s=>{let o=this.layout.CoordinateToColumnHeader(s.offsetX-a.x),n=new k(o,t,!0);(i.empty||!n.Equals(i.area))&&(this.Select(i,n,void 0,!0),this.RenderSelections())})}}HoverCell(e,t){let r=this.active_sheet.cells.GetCell(e,!1);if(r?.table&&r.table.area.start.row===e.row&&r.table.sortable!==!1?(this.hover_data.table_header=!0,this.layout.ShowTableSortButton(r.table,e.column-r.table.area.start.column,e)):(this.hover_data.table_header&&this.layout.HideTableSortButton(),this.hover_data.table_header=!1),r?.merge_area){let a=r.merge_area;e=a.start,r=this.active_sheet.cells.GetCell(e,!1),e={row:a.start.row,column:a.end.column}}if(r?.note){let a=or.instance.Parse(r.note),i=this.options.comment_markdown?or.instance.HTML(a,{br:!1}):void 0;this.layout.ShowNote(r.note,e,t,i),this.hover_data.note=!0}else this.hover_data.note&&(this.layout.HideNote(),this.hover_data.note=!1);r?.hyperlink?(this.layout.ShowTitle("Link: "+r.hyperlink,e),this.hover_data.link=!0,this.hover_data.cell=r):this.hover_data.link&&(this.layout.HideTitle(),this.hover_data.cell=void 0),this.hover_data.address={...e}}HideHoverInfo(){this.layout.HideTitle(),this.layout.HideTooltip(),this.hover_data.note=this.hover_data.link=!1,this.hover_data.cell=void 0,this.hover_data.pointer&&this.layout.grid_cover.classList.remove("link-pointer"),this.hover_data.pointer=!1}MouseMove_Grid(e){if(e.stopPropagation(),e.preventDefault(),!this.selection_renderer)return;(this.cell_resize.row>=0||this.cell_resize.column>=0)&&this.layout.ResizeCursor();let t={x:e.offsetX,y:e.offsetY},r;if(this.overlay_editor?.editing||(r=this.layout.PointToAddress_Grid(t),(!this.hover_data.address||this.hover_data.address.row!==r.row||this.hover_data.address.column!==r.column)&&this.HoverCell(r,e)),this.hover_data.link&&r&&(this.hover_data.point=t,this.hover_data.handler||(this.hover_data.handler=requestAnimationFrame(()=>{let i=this.hover_data.address&&this.hover_data.point&&this.hover_data.cell&&this.PointInTextPart(this.hover_data.address,this.hover_data.point,this.hover_data.cell);i!==!!this.hover_data.pointer&&(this.hover_data.pointer=i,i?this.layout.grid_cover.classList.add("link-pointer"):this.layout.grid_cover.classList.remove("link-pointer")),this.hover_data.handler=void 0}))),this.primary_selection.empty||!this.selection_renderer.nub_rectangle){this.nub_select_flag&&(this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=!1);return}let a=this.selection_renderer.nub_rectangle.Contains(e.offsetX,e.offsetY);a!==this.nub_select_flag&&(a?this.layout.grid_cover.classList.add("nub-select"):this.layout.grid_cover.classList.remove("nub-select"),this.nub_select_flag=a)}ClearDoubleClick(){this.double_click_data.address=void 0}IsDoubleClick(e,t=300){if(this.double_click_data.address&&this.double_click_data.address.row===e.row&&this.double_click_data.address.column===e.column)return clearTimeout(this.double_click_data.timeout),this.double_click_data.address=void 0,this.double_click_data.timeout=void 0,!0;this.double_click_data.timeout&&clearTimeout(this.double_click_data.timeout),this.double_click_data.address={...e},this.double_click_data.timeout=window.setTimeout(()=>{this.double_click_data.address=void 0,this.double_click_data.timeout=void 0},t)}PointInTextPart(e,t,r){let a=this.layout.CellAddressToRectangle(e);r.merge_area&&(a=a.Combine(this.layout.CellAddressToRectangle(r.merge_area.end)));let i=t.x-a.left,s=t.y-a.top,o=r.renderer_data?.text_data?.strings||[];for(let n of o)for(let l of n)if(typeof l.left=="number"&&typeof l.top=="number"&&typeof l.width=="number"&&typeof l.height=="number"&&i>=l.left&&s>=l.top&&i<=l.left+l.width&&s<=l.top+l.height)return!0;return!1}MouseDown_Grid(e){if(e.button!==0)return;e.stopPropagation(),e.preventDefault();let t=this.SelectingArgument();if(!t&&this.additional_selections.length&&this.ClearAdditionalSelections(),(!t||!this.formula_bar?.selecting&&!this.external_editor?.selecting)&&this.Focus(void 0,!0),this.overlay_editor?.editing&&!this.overlay_editor?.selecting){if(this.overlay_editor?.selection){let d=this.overlay_editor?.edit_node.textContent||void 0;this.SetInferredType(this.overlay_editor.selection,d,!1)}this.DismissEditor()}let r={x:e.offsetX,y:e.offsetY},a=this.layout.PointToAddress_Grid(r),i=t?this.active_selection:this.primary_selection;if(!t&&this.IsDoubleClick(a)){ae.is_mobile&&this.overlay_editor?.edit_node?.focus(),this.OverlayEditCell({target:a,area:new k(a)},!1);return}let s=this.layout.grid_cover.getBoundingClientRect(),o={x:s.left,y:s.top},n=[],l;if(e.shiftKey&&!i.empty){let d=i.target;this.Select(i,new k(a,i.target,!0),void 0,!0),a=d}else if(this.nub_select_flag)a=i.area.TopLeft(),n.push("nub-select"),l=this.active_sheet.RealArea(i.area);else{let d=a,c=this.active_sheet.CellData(d);if(c.merge_area&&(d=c.merge_area.start,c=this.active_sheet.CellData(c.merge_area.start)),c.hyperlink&&this.PointInTextPart(d,r,c)){let u=c.hyperlink;Promise.resolve().then(()=>{this.grid_events.Publish({type:"cell-event",data:{type:"hyperlink",reference:u}})}),this.ClearDoubleClick();return}if(c.click_function){let u=this.layout.CellAddressToRectangle(d);c.merge_area&&(u=u.Combine(this.layout.CellAddressToRectangle(c.merge_area.end)));let m=c.click_function.call(this,{cell:c,x:r.x-u.left,y:r.y-u.top,width:u.width,height:u.height,scale:this.layout.scale});if(m.value&&this.ExecCommand({key:6,value:m.value,area:d}),m.block_selection){this.ClearDoubleClick(),!this.primary_selection.empty&&this.primary_selection.target.row===d.row&&this.primary_selection.target.column===d.column&&this.UpdateFormulaBarFormula();return}}this.Select(i,new k(a),a)}this.RenderSelections(),t&&this.UpdateSelectedArgument(i);let h=this.layout.CellAddressToRectangle({row:0,column:0}).Combine(this.layout.CellAddressToRectangle({row:this.active_sheet.rows-1,column:this.active_sheet.columns-1})).Expand(-1,-1);Be(this.layout.mask,n,d=>{let c={x:d.offsetX-o.x,y:d.offsetY-o.y},u=h.Clamp(c.x,c.y),m=this.layout.PointToAddress_Grid(u),f=this.layout.scroll_reference_node,p=!1;this.container&&this.options.scrollbars&&(c.x<f.scrollLeft?(f.scrollLeft-=25,p=!0):c.x>f.scrollLeft+this.container.clientWidth&&(f.scrollLeft+=25,p=!0),c.y<f.scrollTop?(f.scrollTop-=25,p=!0):c.y>f.scrollTop+this.container.clientHeight&&(f.scrollTop+=25,p=!0),p&&(s=this.layout.grid_cover.getBoundingClientRect(),o.x=s.left+document.body.scrollLeft,o.y=s.top+document.body.scrollTop));let b=new k(m,a,!0);if(l&&(b=l.Clone(),b.ConsumeAddress(m),b.rows!==l.rows&&b.columns!==l.columns)){let w={rows:m.row>l.end.row?m.row-l.end.row:l.start.row-m.row,columns:m.column>l.end.column?m.column-l.end.column:l.start.column-m.column};w.rows>=w.columns?b=new k({row:b.start.row,column:l.start.column},{row:b.end.row,column:l.end.column}):b=new k({row:l.start.row,column:b.start.column},{row:l.end.row,column:b.end.column})}(i.empty||!b.Equals(i.area))&&(this.Select(i,b,void 0,!0),this.RenderSelections(),t?this.UpdateSelectedArgument(i):!i.empty&&!i.area.entire_sheet&&(i.area.entire_column?this.UpdateAddressLabel(void 0,i.area.columns+"C"):i.area.entire_row?this.UpdateAddressLabel(void 0,i.area.rows+"R"):i.area.count>1?this.UpdateAddressLabel(void 0,i.area.rows+"R x "+i.area.columns+"C"):this.UpdateAddressLabel(i)))},()=>{this.UpdateAddressLabel(),t?this.overlay_editor?.editing||(this.external_editor_config?(this.external_editor?.active&&this.external_editor.FocusEditor(),this.external_editor_config.update):this.formula_bar&&this.formula_bar.FocusEditor()):l&&this.RecycleNubArea(i.area,l)})}Transpose(e){let t=[],r=e.length,a=e[0].length;for(let i=0;i<a;i++){t[i]=[];for(let s=0;s<r;s++)t[i][s]=e[s][i]}return t}RecycleNubArea(e,t){if(e.Equals(t))return;let r=[];for(let d=0;d<t.rows;d++){r[d]=[];for(let c=0;c<t.columns;c++){let u={row:t.start.row+d,column:t.start.column+c};r[d][c]=this.active_sheet.CellData(u)}}if(r[0][0].area&&r[0][0].area.Equals(t)){this.ExecCommand({key:6,value:r[0][0].value,array:!0,area:e});return}if(r[0][0].table&&t.Equals(new k(r[0][0].table.area.start,r[0][0].table.area.end))){let d=r[0][0].table,c=d.sortable,u=d.totals_row,m=d.theme;this.ExecCommand([{key:30,table:d},{key:29,area:e,sortable:c,totals:u,theme:m}]);return}let a=[],i=[],s=t.columns,o=e.rows,n=!1,l=!1;e.columns===t.columns?n=e.start.row<t.start.row:(s=t.rows,o=e.columns,n=e.start.column<t.start.column,r=this.Transpose(r),l=!0);for(let d=0;d<o;d++)a[d]=[],i[d]=[];for(let d=0;d<s;d++){let c=0;if(r.length>1){c=1;let u=[];for(let m=0;m<r.length;m++){let f=r[m][d];f.ValueIsNumber()&&u.push(f.value)}if(u.length>1){let m=u.slice(1).map((f,p)=>f-u[p]);m.every(f=>f===m[0])&&(c=m[0])}u.length&&(c+=u[u.length-1]-u[0])}for(let u=0;u<r.length;u++){let m,f=r[u][d];if(f.ValueIsFormula()){let v=this.parser.Parse(f.value);v.expression&&v.full_reference_list?.length&&(m=v.expression)}let p=0,b=u,w=r.length,y=0,g=c;n&&(b=o-r.length+u,w=-r.length,g=-c);for(let v=b;v>=0&&v<o;v+=w,p+=w,y+=g){let x={offset:l?{rows:0,columns:p}:{rows:p,columns:0}};if(m)a[v][d]="="+this.parser.Render(m,x);else{let _=r[u][d];_.ValueIsNumber()?a[v][d]=_.value+y:a[v][d]=_.value}i[v][d]=r[u][d].style||{}}}}let h=[{key:6,value:l?this.Transpose(a):a,array:!1,area:e}];l&&(i=this.Transpose(i));for(let d=0;d<i.length;d++)for(let c=0;c<i[d].length;c++)h.push({key:7,area:{row:d+e.start.row,column:c+e.start.column},style:i[d][c],delta:!1});this.ExecCommand(h)}UpdateSelectedArgument(e){let t=this.active_sheet.CellData(e.area.start),r=new k(t.merge_area?t.merge_area.start:e.target),a=this.model.named.MatchSelection(e.area,r);if(!a&&(a=e.area.spreadsheet_label,t.merge_area&&t.merge_area.Equals(e.area)&&(a=k.CellAddressToLabel(t.merge_area.start)),this.external_editor_config||this.active_sheet.id!==this.editing_cell.sheet_id)){let i=this.active_sheet.name;tt.test(i)?a=`'${i}'!${a}`:a=`${i}!${a}`}if(this.overlay_editor?.editing&&this.overlay_editor.selecting)this.overlay_editor.InsertReference(a);else if(this.formula_bar&&this.formula_bar.selecting)this.formula_bar.InsertReference(a);else if(this.external_editor_config&&(this.external_editor?.active&&(this.external_editor.FocusEditor(),this.external_editor.InsertReference(a)),this.external_editor_config.update)){let i=this.external_editor_config.update.call(0,a);i&&Array.isArray(i)&&this.HighlightDependencies(i.filter(s=>!!s).map(s=>$(s)?new k(s):new k(s.start,s.end)))}}SelectingArgument(){return this.overlay_editor?.editing&&this.overlay_editor?.selecting||this.formula_bar&&this.formula_bar.selecting||!!this.external_editor_config}ReleaseOverlayEditor(){this.editing_state=0,this.DismissEditor(),this.DelayedRender()}RestoreOverlayEditor(){this.overlay_editor?.FocusEditor()}OverlayKeyDown(e){let t=!1;if(this.overlay_editor&&this.overlay_editor.editing)switch(t=!0,this.overlay_editor.HandleKeyDown(e)){case"handled":return;case"discard":this.editing_state=0,this.DismissEditor(),this.DelayedRender();return;case"commit":if(this.active_sheet.id!==this.editing_cell.sheet_id&&this.editing_cell.sheet_id&&this.ActivateSheetID(this.editing_cell.sheet_id),this.editing_state=0,this.overlay_editor?.selection){let n=this.overlay_editor?.edit_node.textContent||void 0,l=e.key==="Enter"&&(e.ctrlKey||ae.is_mac&&e.metaKey)&&e.shiftKey;this.SetInferredType(this.overlay_editor.selection,n,l,void 0,this.overlay_editor.edit_style)}this.DismissEditor(),this.options.repaint_on_cell_change&&this.DelayedRender(!1,this.overlay_editor?.selection.area||void 0);break}let r=this.SelectingArgument();if(this.formula_bar&&this.formula_bar.focused&&!r||this.selected_annotation&&!r)return;let a=r?this.active_selection:this.primary_selection,i={rows:0,columns:0},s=!1,o=!1;if(e.ctrlKey||ae.is_mac&&e.metaKey){switch(e.key){case"ArrowDown":case"Down":i.rows++;break;case"ArrowUp":case"Up":i.rows--;break;case"ArrowLeft":case"Left":i.columns--;break;case"ArrowRight":case"Right":i.columns++;break;case"Backspace":e.metaKey&&ae.is_mac&&(a.empty||this.DeleteSelection(a));break;case"Delete":case"Del":{e.stopPropagation(),e.preventDefault();for(let n=0;n<this.model.sheets.length;n++)if(this.model.sheets.list[n]===this.active_sheet){this.DeleteSheet(n);break}return}case"/":e.stopPropagation(),e.preventDefault(),this.SelectArrayOrTable();break;default:if(e.shiftKey)return}if(i.columns||i.rows)if(e.stopPropagation(),e.preventDefault(),!a.empty&&(i.columns||i.rows)){if(this.BlockSelection(a,!!e.shiftKey,i.columns,i.rows))return}else return;else{let n={},l=this.primary_selection.empty?{}:this.active_sheet.CellData(this.primary_selection.target).style||{};switch(e.key.toLowerCase()){case"b":n.bold=!l.bold;break;case"i":n.italic=!l.italic;break;case"u":n.underline=!l.underline;break;case"a":this.SelectAll();break;case"0":if(!e.altKey)return;this.ClearSelection(this.primary_selection),this.RenderSelections();break;default:e.key;return}Object.keys(n).length&&this.ApplyStyle(void 0,n)}}else{if(/^F\d+$/.test(e.key))return;switch(e.key){case"Tab":e.shiftKey?i.columns--:i.columns++,s=!0;break;case"Enter":e.shiftKey?i.rows--:i.rows++,s=!0;break;case"ArrowDown":case"Down":i.rows++,o=e.shiftKey;break;case"ArrowUp":case"Up":i.rows--,o=e.shiftKey;break;case"ArrowLeft":case"Left":i.columns--,o=e.shiftKey;break;case"ArrowRight":case"Right":i.columns++,o=e.shiftKey;break;case"Delete":case"Del":a.empty||this.DeleteSelection(a);break;case"PageUp":case"PageDown":if(e.shiftKey){this.NextSheet(e.key==="PageUp"?-1:1);break}return;case"Control":case"Shift":case"Alt":return;default:a.empty||e.key!=="Escape"&&this.OverlayEditCell(a,!0,e);return}}e.stopPropagation(),e.preventDefault(),(i.rows||i.columns)&&this.AdvanceSelection(i,a,s,o,!t)}SelectArrayOrTable(){if(this.primary_selection.empty)return;let e=this.active_sheet.CellData(this.primary_selection.target);if(!(!e||!e.area&&!e.table&&!e.spill)){if(e.area&&this.Select(this.primary_selection,e.area,e.area.start),e.spill&&this.Select(this.primary_selection,e.spill,e.spill.start),e.table){let t=new k(e.table.area.start,e.table.area.end);this.Select(this.primary_selection,t,t.start)}this.RenderSelections()}}RenderSelections(e=!0){let t=this.hide_selection?!1:!this.editing_state||this.editing_cell.sheet_id===this.active_sheet.id,r=this.primary_selection.empty?void 0:this.active_sheet.CellData(this.primary_selection.target);this.layout.ShowSpillBorder(r?.spill),this.selection_renderer?.RenderSelections(t,e)}BlockSelection(e,t,r,a,i=!0){if(e.empty)return!1;let s={...e.target};a>0?s.row=Math.max(s.row,e.area.end.row):a<0&&(s.row=Math.min(s.row,e.area.start.row)),r>0?s.column=Math.max(s.column,e.area.end.column):r<0&&(s.column=Math.min(s.column,e.area.start.column));let o=this.active_sheet.cells,n=o.GetCell(e.target,!1);if(!n||n.type===0&&!n.area&&!n.spill)return!1;let l={...s};for(;;){let h={row:l.row+a,column:l.column+r};if(h.column<0||h.row<0||h.column>=this.active_sheet.columns||h.row>=this.active_sheet.rows)break;let d=!1;if(a)for(let c=e.area.start.column;!d&&c<=e.area.end.column;c++)n=o.GetCell({row:h.row,column:c},!1),d=d||!!n&&(n.type!==0||!!n.area||!!n.spill),!d&&n&&n.merge_area&&(n=o.GetCell(n.merge_area.start,!1),d=d||!!n&&(n.type!==0||!!n.area||!!n.spill));else for(let c=e.area.start.row;!d&&c<=e.area.end.row;c++)n=o.GetCell({row:c,column:h.column},!1),d=d||!!n&&(n.type!==0||!!n.area||!!n.spill),!d&&n&&n.merge_area&&(n=o.GetCell(n.merge_area.start,!1),d=d||!!n&&(n.type!==0||!!n.area||!!n.spill));if(!d)break;l=h}if(t){a?(s.row=e.target.row,s.column=e.area.start.column,l.column=e.area.end.column):(s.column=e.target.column,s.row=e.area.start.row,l.row=e.area.end.row);let h=new k(s,l,!0);this.Select(e,h,e.target,!0)}else this.Select(e,new k(l));return this.ScrollIntoView(l),this.SelectingArgument()&&this.UpdateSelectedArgument(e),i&&this.DelayedRender(),!0}DeleteSelection(e){if(e.empty)return;let t=this.active_sheet.RealArea(e.area);this.ExecCommand({key:12,area:t})}SetInferredType(e,t,r=!1,a=!0,i){let s=e.target||e.area.start,o=this.active_sheet.CellData(s);if(o.area){if(!r&&o.area.count>1||!e.area||!e.area.Equals(o.area)){this.Error(2);return}}else if(r){for(let u of this.active_sheet.cells.Iterate(e.area,!1))if(u.area){this.Error(2);return}}let n=this.active_sheet.GetValidation(s)[0];if(n&&n.error){let u;if(n.type==="list"?u=n.list:n.type==="range"&&(u=this.GetValidationRange(n.area)),u&&u.length){let m=!1;if(t){let f=t.toUpperCase();for(let p of u)if(p&&p.toString().toUpperCase()===f){t=p.toString(),m=!0;break}}if(!m){this.Error(3);return}}}o.merge_area&&(s=o.merge_area.start);let l=[];i&&l.push({key:7,style:i,delta:!0,area:r?e.area:e.target});let h=typeof t=="string"&&t.trim()[0]==="=";if(h&&(t=this.FixFormula(t||""),!this.active_sheet.HasCellStyle(s))){let u=this.parser.Parse(t);if(u){if(u.expression?.type==="call"&&(!o.style||!o.style.number_format||V.Equals(o.style.number_format,"General"))){let m=u.expression.name.toLowerCase(),f;switch(m){case"today":f="Short Date";break;case"now":f="Timestamp";break}f&&l.push({key:7,area:r?e.area:s,style:{number_format:f},delta:!0})}if(u.dependencies){let m,f=u.dependencies;for(let p of Object.keys(f.addresses)){let b=f.addresses[p];if(this.active_sheet.HasCellStyle({...b})){let w=this.active_sheet.CellData({...b});if(w.style&&w.style.number_format&&(!m||/%/.test(m))&&(m=V.Translate(w.style.number_format),!/%/.test(m)))break}}if(m){let p={number_format:V.SymbolicName(m)||m};l.push({key:7,area:r?e.area:s,style:p,delta:!0})}}}}let d=this.parser.Parse(t||"").expression;d?.type==="group"&&d.elements.length===1&&d.elements[0].type==="complex"&&(d=d.elements[0]);let c;if(d?.type==="complex"?c={type:7,value:{real:d.real,imaginary:d.imaginary}}:d?.type==="literal"&&typeof d.value=="boolean"?c={type:4,value:d.value}:c=rt.TryParse(t),!h&&c.type===3){let u="",m=c.hints||{};(!o.style||!o.style.number_format||V.Equals(o.style.number_format,"General"))&&(m.Date?u="Short Date":m.Exponential?u="Exponential":m.Percent?u="Percent":m.Currency?u="Currency":(m.Grouping||m.Parens)&&(u="Accounting")),u&&l.push({key:7,area:r?e.area:s,style:{number_format:u},delta:!0})}if(l.push({key:6,area:r?e.area:s,array:r,value:h?this.model.UntranslateFunction(t||""):c.value}),a)this.ExecCommand(l);else return l}FixFormula(e){if(e.trim()[0]!=="=")return e;e=e.replace(/^\s+/,"");let t=!1,r=!1,a=0,i=!1,s=e.length;for(let o=0;o<s;o++){let n=e[o];if(!i)switch(n){case'"':t?e[o+1]==='"'?o++:t=!1:r||(t=!0);break;case"'":r?r=!1:t||(r=!0);break;case"\\":i=!0;break;case"(":!t&&!r&&a++;break;case")":!t&&!r&&a--;break}}for(t?e+='"':r&&(e+="'");a>0;)e+=")",a--;return e=this.NormalizeFormula(e),e}NormalizeFormula(e){let t=this.parser.Parse(e);return t.error&&console.warn(t.error),t&&t.expression&&(this.parser.Walk(t.expression,r=>{switch(r.type){case"call":r.name=this.autocomplete_matcher.NormalizeIdentifier(r.name)||r.name;break;case"identifier":this.model.GetName(r.name,this.active_sheet.id)?.type==="range"&&(r.name=r.name.toUpperCase());break}return!0}),e="="+this.parser.Render(t.expression,{missing:""})),e}DismissEditor(){this.overlay_editor?.active_cell&&(this.overlay_editor.active_cell.editing=!1,this.overlay_editor.active_cell.render_clean=[],this.DelayedRender(void 0,this.overlay_editor.selection.area)),this.editing_state=0,this.Focus(),this.overlay_editor?.CloseEditor(),this.ClearAdditionalSelections(),this.ClearSelection(this.active_selection)}NormalizeCellValue(e){let t=e.value;if(e.ValueIsNumber()&&e.style&&e.style.number_format)if(V.Get(e.style.number_format).date_format){let r=et(e.value),a=r.getUTCHours()||r.getUTCMinutes()||r.getUTCSeconds()?"Timestamp":"Short Date";t=V.Get(a).Format(t)}else if(/(?:%|percent)/i.test(e.style.number_format)){let r=0,a=e.value.toString().match(/\.(.*?)$/);a&&a[1]&&(r=Math.max(0,a[1].length-2)),t=(e.value*100).toFixed(r)+"%",G.decimal_separator===","&&(t=t.replace(/\./,","))}else t&&G.decimal_separator===","&&(t=e.value.toString().replace(/\./,","));else{if(e.ValueIsBoolean())return e.value?this.model.language_model?.boolean_true||"TRUE":this.model.language_model?.boolean_false||"FALSE";e.ValueIsNumber()?t&&G.decimal_separator===","&&(t=e.value.toString().replace(/\./,",")):e.ValueIsComplex()?(e.value.imaginary?e.value.real?t=`${e.value.real.toString()}${e.value.imaginary<0?" - ":" + "}${e.value.imaginary===1||e.value.imaginary===-1?"":Math.abs(e.value.imaginary).toString()}i`:e.value.imaginary===1?t="i":e.value.imaginary===-1?t="-i":t=e.value.imaginary.toString()+"i":t=e.value.real.toString(),G.decimal_separator===","&&(t=t.replace(/\./,","))):e.ValueIsFormula()&&(t=this.model.TranslateFunction(e.value))}return t}IsNumeric(e){return e>=48&&e<=57||e===this.decimal_separator_code||e===45||e===43}OverlayEditCell(e,t=!0,r){if(!this.options.in_cell_editor)return;let a=e.target||e.area.start,i=this.active_sheet.CellData(a),s;if(this.HideHoverInfo(),i.merge_area?(s=this.layout.OffsetCellAddressToRectangle(i.merge_area.start).Combine(this.layout.OffsetCellAddressToRectangle(i.merge_area.end)),a=i.merge_area.start,i=this.active_sheet.CellData(a)):s=this.layout.OffsetCellAddressToRectangle(a),i.style?.locked){console.info("cell is locked for editing");return}s=s.Shift(this.layout.header_size.width,this.layout.header_size.height);let o=i.value,n;typeof o>"u"&&!i.style?.font_face&&(n=this.edit_state),t?(i.type===3||i.rendered_type===3)&&i.style&&i.style.number_format&&/(?:%|percent)/i.test(i.style.number_format)&&(!r||this.IsNumeric(r.key.charCodeAt(0)))?o="%":o=void 0:o=this.NormalizeCellValue(i),this.overlay_editor?.Edit(e,s.Expand(-1,-1),i,o,r,n),i.editing=!0,i.render_clean=[],this.DelayedRender(!1,e.area)}BoundAddressArea(e,t){e.column>t.end.column?(e.row=this.StepVisibleRows(e.row,1),e.row>t.end.row&&(e.row=t.start.row),e.column=t.start.column):e.column<t.start.column?(e.row=this.StepVisibleRows(e.row,-1),e.row<t.start.row&&(e.row=t.end.row),e.column=t.end.column):e.row>t.end.row?(e.column=this.StepVisibleColumns(e.column,1),e.column>t.end.column&&(e.column=t.start.column),e.row=t.start.row):e.row<t.start.row&&(e.column=this.StepVisibleColumns(e.column,-1),e.column<t.start.column&&(e.column=t.end.column),e.row=t.end.row)}StepVisibleRows(e,t){if(t>0)for(let r=0;r<t;r++)this.layout.RowHeight(++e)||r--;else if(t<0)for(let r=0;r>t;r--)--e>=0&&!this.layout.RowHeight(e)&&r++;return e}StepVisibleColumns(e,t){if(t>0)for(let r=0;r<t;r++)this.layout.ColumnWidth(++e)||r--;else if(t<0)for(let r=0;r>t;r--)--e>=0&&!this.layout.ColumnWidth(e)&&r++;return e}EnsureAddress(e,t=8,r=!1){let a=!1;if(this.options.expand){if(e.row!==1/0&&e.row>=this.active_sheet.rows){let i=this.active_sheet.rows;for(;e.row>=i;)i+=t;this.active_sheet.cells.EnsureRow(i),a=!0}if(e.column!==1/0&&e.column>=this.active_sheet.columns){let i=this.active_sheet.columns;for(;e.column>=i;)i+=t;this.active_sheet.cells.EnsureColumn(i),a=!0}a&&!r&&(this.layout.UpdateTiles(),this.layout.UpdateContentsSize(),this.Repaint(!0,!0))}return a}AdvanceSelection(e,t,r=!1,a=!1,i=!0){let s=this.SelectingArgument();if(t.empty)if(s){let o={row:Math.max(0,this.StepVisibleRows(this.primary_selection.target.row,e.rows)),column:Math.max(0,this.StepVisibleColumns(this.primary_selection.target.column,e.columns))};this.Select(t,new k(o))}else this.Select(t,new k({row:0,column:0}));else{let o=this.active_sheet.CellData(t.target);if(o.merge_area&&r&&(r=!o.merge_area.Equals(t.area)),r&&t.area.count>1){let n=this.active_sheet.RealArea(t.area),l=t.target;for(;;){l.row=this.StepVisibleRows(l.row,e.rows),l.column=this.StepVisibleColumns(l.column,e.columns),this.BoundAddressArea(l,n);let h=this.active_sheet.CellData(l);if(!h.merge_area||h.merge_area.start.row===l.row&&h.merge_area.start.column===l.column)break}this.Select(t,n,l)}else if(a&&t&&t.target){let n=t.area,l=t.target,h=n.start,d=n.end,c={row:1/0,column:1/0};if(e.columns&&(n.columns===1?e.columns>0?(d.column=this.StepVisibleColumns(d.column,1),c.column=d.column):(h.column=this.StepVisibleColumns(h.column,-1),c.column=h.column):n.end.column>l.column?(d.column=this.StepVisibleColumns(d.column,e.columns),c.column=d.column):n.start.column<l.column&&(h.column=this.StepVisibleColumns(h.column,e.columns),c.column=h.column),d.column=Math.max(0,d.column),h.column=Math.max(0,h.column)),e.rows&&(n.rows===1?e.rows>0?(d.row=this.StepVisibleRows(d.row,1),c.row=d.row):(h.row=this.StepVisibleRows(h.row,-1),c.row=h.row):n.end.row>l.row?(d.row=this.StepVisibleRows(d.row,e.rows),c.row=d.row):n.start.row<l.row&&(h.row=this.StepVisibleRows(h.row,e.rows),c.row=h.row),d.row=Math.max(0,d.row),h.row=Math.max(0,h.row)),this.options.expand){for(let u of[h,d,c])u.row!==1/0&&(u.row=Math.max(0,u.row)),u.column!==1/0&&(u.column=Math.max(0,u.column));this.EnsureAddress(d)&&(i=!0),this.ScrollIntoView(c),this.Select(t,new k(h,d),void 0,!0)}else{for(let u of[h,d,c])u.row!==1/0&&(u.row=Math.max(0,Math.min(u.row,this.active_sheet.rows-1))),u.column!==1/0&&(u.column=Math.max(0,Math.min(u.column,this.active_sheet.columns-1)));this.ScrollIntoView(c),this.Select(t,new k(h,d),void 0,!0)}}else{let n=t.target;o.merge_area?(e.columns<0?n.column=this.StepVisibleColumns(o.merge_area.start.column,-1):e.columns>0&&(n.column=this.StepVisibleColumns(o.merge_area.end.column,1)),e.rows<0?n.row=this.StepVisibleRows(o.merge_area.start.row,-1):e.rows>0&&(n.row=this.StepVisibleRows(o.merge_area.end.row,1))):(n.row=this.StepVisibleRows(n.row,e.rows),n.column=this.StepVisibleColumns(n.column,e.columns)),this.EnsureAddress(n)&&(i=!0),this.Select(t,new k({row:Math.min(Math.max(0,n.row),this.active_sheet.rows-1),column:Math.min(Math.max(0,n.column),this.active_sheet.columns-1)})),this.RenderSelections(),this.ScrollIntoView(t.target)}}this.SelectingArgument()&&this.UpdateSelectedArgument(t),i&&this.DelayedRender()}HighlightDependencies(e,t=!0){let r=0;e:for(let a of e)if((a.start.row===1/0||a.start.row<this.active_sheet.rows)&&(a.start.column===1/0||a.start.column<this.active_sheet.columns)){if(a.start.spill&&a.end.row===a.start.row&&a.end.column===a.start.column){let s=this.model.sheets.Find(a.start.sheet_id||-1)?.CellData(a.start);s?.spill&&s.spill.start.row===a.start.row&&s.spill.start.column===a.start.column&&a.ConsumeArea(s.spill)}a=this.active_sheet.RealArea(a);let i=a.spreadsheet_label;if(this.additional_selections[r]&&this.additional_selections[r].area.spreadsheet_label===i)r++;else{for(let s=0;s<r;s++)if(this.additional_selections[s].area.spreadsheet_label===i&&this.additional_selections[s].area.start.sheet_id===a.start.sheet_id)continue e;this.additional_selections[r++]={target:a.start,area:a}}}this.additional_selections.splice(r),t&&this.RenderSelections(!1)}ClearAdditionalSelections(){this.additional_selections.splice(0,this.additional_selections.length)}ClearSelection(e){this.Select(e)}HideGridSelection(){this.UpdateAddressLabel(void 0,"");let e=this.selected_annotation&&this.selected_annotation.data.formula?this.selected_annotation.data.formula:"";this.UpdateFormulaBarFormula(e),this.layout.ShowSelections(!1)}ShowGridSelection(){this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.layout.ShowSelections(!0)}Select(e,t,r,a=!1){if(e.empty||a&&(r=e.target),t){let i=this.active_sheet.RealArea(t);r||(r=i.start);e:for(;;){for(let n of this.active_sheet.cells.Iterate(i,!1))if(n.merge_area&&!i.ContainsArea(n.merge_area)){t.ConsumeArea(n.merge_area),i=this.active_sheet.RealArea(t);continue e}break}e.area=new k({...t.start,sheet_id:this.active_sheet.id},t.end),r&&(e.target={...r,sheet_id:this.active_sheet.id}),e.empty=!1;let s=this.active_sheet.CellData(e.target),o="";s.formatted&&(typeof s.formatted=="string"?o=s.formatted:o=s.formatted.map(n=>n.flag===1||n.flag===6?"":n.text).join("")),this.overlay_editor?.UpdateCaption(o)}else e.empty=!0;e===this.primary_selection&&(ae.is_edge&&this.Focus(),this.grid_events.Publish({type:"selection",selection:this.primary_selection}),this.UpdateAddressLabel(),this.UpdateFormulaBarFormula(),this.formula_bar&&(this.formula_bar.target_address={...this.primary_selection.target}),this.options.stats&&this.UpdateStats())}UpdateFormulaBarFormula(e){if(this.layout.HideDropdownCaret(),e){this.formula_bar&&(this.formula_bar.shadow=!1,this.formula_bar.formula=e);return}if(this.primary_selection.empty)this.formula_bar&&(this.formula_bar.shadow=!1,this.formula_bar.formula="");else{let t=this.active_sheet.CellData(this.primary_selection.target),r=t.merge_area||t.area||t.spill,a=!1;r&&(r.start.column!==this.primary_selection.target.column||r.start.row!==this.primary_selection.target.row)&&(t=this.active_sheet.CellData(r.start),t.spill&&(a=!0)),this.formula_bar&&(this.formula_bar.editable=!t.style?.locked);let i=this.NormalizeCellValue(t),s=this.active_sheet.GetValidation(this.primary_selection.target)[0];if(s&&!t.style?.locked){let o;s.type==="list"?o=s.list:s.type==="range"&&(o=this.GetValidationRange(s.area)),o&&o.length&&this.layout.ShowDropdownCaret(t.merge_area||new k(this.primary_selection.target),o,t.value)}this.formula_bar&&(this.formula_bar.shadow=a,t.area?this.formula_bar.formula="{"+(i||"")+"}":this.formula_bar.formula=(i??"").toString())}}RenderStats(e){if(!Array.isArray(e))return[];let t=0,r=0,a={real:0,imaginary:0};for(let s of e)for(let o of s)typeof o=="number"?(a.real+=o,r++):Ne(o)&&(a.real+=o.real,a.imaginary+=o.imaginary,r++),typeof o<"u"&&t++;let i=s=>{let o=Math.floor(Math.log10(s));return o<-6||o>10?V.Get("Exponential"):o<=-1?V.Get("General"):V.Get("Number")};if(t>1)if(r>0){let s=V.Get("General");if(a.imaginary){let o={real:a.real/r,imaginary:a.imaginary/r};return[{label:"Count",value:t.toString()},{label:"Sum",value:Ie.FormatPartsAsText(s.FormatComplex(a))},{label:"Average",value:Ie.FormatPartsAsText(s.FormatComplex(o))}]}else return[{label:"Count",value:t.toString()},{label:"Sum",value:i(a.real).Format(a.real)},{label:"Average",value:i(a.real/r).Format(a.real/r)}]}else return[{label:"Count",value:t.toString()}];return[]}UpdateStats(){if(this.tab_bar){let e=[];typeof this.options.stats=="function"?this.primary_selection.empty||(e=this.options.stats.call(void 0,this.GetRange(this.primary_selection.area))):!this.primary_selection.empty&&this.primary_selection.area.count>1&&(e=this.RenderStats(this.GetRange(this.primary_selection.area))),this.tab_bar.stats_data=e}}UpdateAddressLabel(e=this.primary_selection,t){if(this.formula_bar)if(typeof t<"u")this.formula_bar.label=t;else if(e.empty)this.formula_bar.label="";else{let r=this.active_sheet.CellData(this.primary_selection.target),a=new k(r.merge_area?r.merge_area.start:e.target);this.formula_bar.label=this.model.named.MatchSelection(e.area,a)||k.CellAddressToLabel(a.start)}}OnDropdownSelect(e){if(typeof e<"u"){let a=rt.TryParse(e.toString());a.type===3&&(e=a.value)}let t=this.active_sheet.CellData(this.primary_selection.target),r=t.merge_area?t.merge_area.start:this.primary_selection.target;this.ExecCommand({key:6,area:r,value:e}),this.UpdateFormulaBarFormula()}OnScroll(){let e=this.layout.VisibleTiles();e.Equals(this.render_tiles)||(this.render_tiles=e,this.layout_token||(this.layout_token=requestAnimationFrame(()=>this.Repaint())))}AttachListeners(){if(!this.container)throw new Error("invalid container");this.container.addEventListener("copy",this.HandleCopy.bind(this)),this.container.addEventListener("cut",this.HandleCut.bind(this)),this.container.addEventListener("paste",this.HandlePaste.bind(this)),this.layout.grid_cover.addEventListener("mousedown",e=>this.MouseDown_Grid(e)),this.layout.column_header_cover.addEventListener("mousedown",e=>this.MouseDown_ColumnHeader(e)),this.layout.row_header_cover.addEventListener("mousedown",e=>this.MouseDown_RowHeader(e)),this.layout.column_header_cover.addEventListener("mousemove",e=>this.MouseMove_ColumnHeader(e)),this.layout.row_header_cover.addEventListener("mousemove",e=>this.MouseMove_RowHeader(e)),this.layout.grid_cover.addEventListener("mousemove",e=>this.MouseMove_Grid(e)),this.overlay_editor?.edit_node.addEventListener("keydown",e=>this.OverlayKeyDown(e)),this.layout.corner.addEventListener("dblclick",()=>{this.SelectAll()}),window.addEventListener("resize",()=>{this.layout.UpdateDPR()&&(this.QueueLayoutUpdate(),this.Repaint(!0,!0,!0))})}HandleCopy(e){if(e.stopPropagation(),e.preventDefault(),this.primary_selection.empty){if(e.clipboardData&&e.clipboardData.clearData(),this.selected_annotation&&e.clipboardData){let t=JSON.stringify({data:this.selected_annotation,source:this.active_sheet.id});e.clipboardData.setData("text/x-treb-annotation",t);let r=this.selected_annotation.view[this.view_index];if(r&&r.node){let a=r.node.firstChild?.firstChild;if(a){let i=no(a).outerHTML;e.clipboardData.setData("text/uri-list","data:image/svg+xml;base64,"+btoa(i)),e.clipboardData.setData("text/html",i),e.clipboardData.setData("text/plain",i)}}}}else{let t=this.active_sheet.RealArea(this.primary_selection.area),r=[],a=[];if(this.primary_selection.area.entire_column)for(let h=t.start.column;h<=t.end.column;h++){let d=this.active_sheet.GetColumnWidth(h);d!==this.active_sheet.default_column_width&&(r[h-t.start.column]=d)}if(this.primary_selection.area.entire_row)for(let h=t.start.row;h<=t.end.row;h++){let d=this.active_sheet.GetRowHeight(h);d!==this.active_sheet.default_row_height&&(a[h-t.start.row]=d)}let i=t.columns,s=t.rows,o=[],n=[];for(let h=0;h<s;h++){let d=[];for(let c=0;c<i;c++){let u={row:t.start.row+h,column:t.start.column+c},m=this.active_sheet.CellData(u),f="";m.calculated!==void 0?m.calculated_type===7?f=nr(m.calculated):f=m.calculated.toString():m.type===7?f=nr(m.value):f=m.value?.toString()||"",d.push(f);let p={address:u,data:m.value,type:m.type,style:this.active_sheet.GetCopyStyle(u)};m.area&&m.area.start.row===u.row&&m.area.start.column===u.column&&(p.array={rows:m.area.rows,columns:m.area.columns}),n.push(JSON.parse(JSON.stringify(p)))}o.push(d)}let l=o.map(h=>h.join("	")).join(`
`);e.clipboardData&&(e.clipboardData.clearData(),e.clipboardData.setData("text/plain",l),e.clipboardData.setData("text/x-treb",JSON.stringify({source:t,data:n,column_width:r,row_height:a})))}}HandleCut(e){if(e.stopPropagation(),e.preventDefault(),this.HandleCopy(e),this.primary_selection.empty)this.selected_annotation&&this.RemoveAnnotation(this.selected_annotation);else{let t=this.active_sheet.RealArea(this.primary_selection.area);this.ExecCommand({key:12,area:t})}}RecyclePasteAreas(e,t){let r=[];if(e.count===1)for(let a=t.start.row;a<=t.end.row;a++)for(let i=t.start.column;i<=t.end.column;i++)r.push(new k({row:a,column:i}));else if(e.columns===t.columns&&t.rows>=e.rows&&t.rows%e.rows===0)for(let a=t.start.row;a<=t.end.row;a+=e.rows)r.push(new k({row:a,column:t.start.column},{row:a+e.rows-1,column:t.end.column}));else if(e.rows===t.rows&&t.columns>=e.columns&&t.columns%e.columns===0)for(let a=t.start.column;a<=t.end.column;a+=e.columns)r.push(new k({column:a,row:t.start.row},{column:a+e.columns-1,row:t.end.row}));else r.push(t.Clone().Resize(e.rows,e.columns));return r}HandlePaste(e){if(this.overlay_editor?.editing||(e.stopPropagation(),e.preventDefault(),!e.clipboardData))return;let t=e.clipboardData.getData("text/x-treb-annotation");if(t){try{let s=JSON.parse(t);if(s.source&&s.source!==this.active_sheet.id&&s.data&&s.data.formula){let o="",n=this.model.sheets.Find(s.source);if(n&&(o=n.name),o){let l=this.parser.Parse(s.data.formula);l.expression&&(this.parser.Walk(l.expression,h=>h.type==="range"?(!h.start.sheet_id&&!h.start.sheet&&(h.start.sheet=o),!1):(h.type==="address"&&!h.sheet_id&&!h.sheet&&(h.sheet=o),!0)),s.data.formula="="+this.parser.Render(l.expression,{missing:""}))}}this.CreateAnnotation(s.data,void 0,!0,!0,void 0,!0)}catch(s){console.error(s)}return}if(this.primary_selection.empty)return;let r=this.active_sheet.RealArea(this.primary_selection.area),a=[],i=e.clipboardData.getData("text/x-treb");if(i)try{let s=JSON.parse(i),o=new k(s.source.start,s.source.end),n=this.RecyclePasteAreas(o,r);if(n.length===1&&r.Resize(n[0].rows,n[0].columns),!this.ValidatePasteAreas(n)){this.Error(5);return}let l=[];for(let h of n){this.active_sheet.cells.EnsureCell(h.end),a.push({key:12,area:h});let d={rows:h.start.row-o.start.row,columns:h.start.column-o.start.column};if(s.data.forEach(c=>{let u=c.data,m={row:c.address.row-o.start.row+h.start.row,column:c.address.column-o.start.column+h.start.column};if(c.type===1){let f=this.parser.Parse(u);f.expression&&(u="="+this.parser.Render(f.expression,{offset:d,missing:""}))}if(c.array){let f={start:{...m},end:{row:m.row+c.array.rows-1,column:m.column+c.array.columns-1}},p={key:6,value:u,array:!0,area:f};l.push(new k(f.start,f.end)),a.push(p)}else{let f=!1;for(let p of l)if(p.Contains(m)){f=!0;break}f||a.push({key:6,value:u,area:m})}a.push({key:7,style:c.style||{},area:m})}),s.column_width?.length){for(let[c,u]of s.column_width.entries())if(typeof u=="number"){let m=c+h.start.column;a.push({key:4,column:m,width:u})}}if(s.row_height?.length){for(let[c,u]of s.row_height.entries())if(typeof u=="number"){let m=c+h.start.row;a.push({key:3,row:m,height:u})}}}}catch(s){console.error("invalid treb data on clipboard"),console.info(s);return}else{let s=e.clipboardData.getData("text/plain");if(!s)return!0;let o=s.trim().split(`
`).map(l=>l.split("	").map(h=>h.trim())),n=this.RecyclePasteAreas(new k({row:0,column:0},{row:o.length-1,column:o[0].length-1}),r);if(n.length===1&&(r.Resize(o.length,o[0].length),r.Resize(n[0].rows,n[0].columns)),!this.ValidatePasteAreas(n)){this.Error(5);return}for(let l of n)for(let h=0;h<o.length;h++)for(let d=0;d<o[0].length;d++){let c=new k({row:h+l.start.row,column:d+l.start.column});if(this.active_sheet.cells.EnsureCell(c.end),o[h][d]){let u=this.SetInferredType({area:c,target:c.start,empty:!1},o[h][d],!1,!1);if(u)for(let m of u)a.push(m)}else{let u=this.active_sheet.cells.GetCell(c.start,!1);u&&u.type!==0&&a.push({key:12,area:c.Clone()})}}}this.ExecCommand(a),this.Select(this.primary_selection,r)}AllSelections(e=!1){let t=[this.primary_selection,this.active_selection].concat(this.additional_selections);return e?t:t.filter(r=>!r.empty)}InsertRowsInternal(e){let t=super.InsertRowsInternal(e);if(t.error)return t;let r=this.FindSheet(e.sheet_id);if(r===this.active_sheet){if(e.count<0)for(let a of this.AllSelections())a.empty=!0;else for(let a of this.AllSelections())a.target.row>=e.before_row&&(a.target.row+=e.count),a.area.entire_column||(a.area.start.row>=e.before_row?a.area.Shift(e.count,0):a.area.end.row>=e.before_row&&a.area.ConsumeAddress({row:a.area.end.row+e.count,column:a.area.end.column}));for(let a of t.delete_annotations_list||[])this.layout.RemoveAnnotation(a);if(this.QueueLayoutUpdate(),this.Repaint(),t.update_annotations_list?.length){this.layout.UpdateAnnotation(t.update_annotations_list,this.theme);for(let a of t.resize_annotations_list||[]){let i=a.view[this.view_index];i?.resize_callback&&i.resize_callback.call(void 0)}}}else this.pending_layout_update.add(r.id);return t}InsertColumnsInternal(e){let t=super.InsertColumnsInternal(e);if(t.error)return t;let r=this.FindSheet(e.sheet_id);if(r===this.active_sheet){if(e.count<0)for(let a of this.AllSelections())a.empty=!0;else for(let a of this.AllSelections())a.target.column>=e.before_column&&(a.target.column+=e.count),a.area.entire_row||(a.area.start.column>=e.before_column?a.area.Shift(0,e.count):a.area.end.column>=e.before_column&&a.area.ConsumeAddress({row:a.area.end.row,column:a.area.end.column+e.count}));for(let a of t.delete_annotations_list||[])this.layout.RemoveAnnotation(a);if(this.tile_renderer?.FlushOverflows(),this.QueueLayoutUpdate(),this.DelayedRender(!0,void 0,!0),t.update_annotations_list?.length){this.layout.UpdateAnnotation(t.update_annotations_list,this.theme);for(let a of t.resize_annotations_list||[]){let i=a.view[this.view_index];i?.resize_callback&&i.resize_callback.call(void 0)}}}else this.pending_layout_update.add(r.id);return t}ResetInternal(){super.ResetInternal(),this.RemoveAnnotationNodes(),this.ClearSelection(this.primary_selection),this.ScrollIntoView({row:0,column:0}),this.QueueLayoutUpdate(),this.layout.HideNote()}ResizeColumnsInternal(e){let t=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,r=e.column;if(typeof r>"u"){r=[];for(let s=0;s<t.columns;s++)r.push(s)}typeof r=="number"&&(r=[r]);let a=typeof e.width!="number",i=Math.round((e.width||0)/this.scale);if(a)for(let s of r)this.AutoSizeColumn(t,s,!0);else for(let s of r)t.SetColumnWidth(s,i);t===this.active_sheet?(this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetWidth&&this.layout.container.offsetWidth>this.layout.total_width?this.UpdateLayout():(this.layout.UpdateTileWidths(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.RenderSelections()):this.pending_layout_update.add(t.id)}ResizeRowsInternal(e){let t,r=e.sheet_id?this.FindSheet(e.sheet_id):this.active_sheet,a=e.row;if(typeof a>"u"){a=[];for(let n=0;n<r.rows;n++)a.push(n)}typeof a=="number"&&(a=[a]);let i=typeof e.shrink=="boolean"?e.shrink:!0,s=typeof e.height!="number",o=Math.round(e.height||0/this.scale);if(s)for(let n of a)r.GetRowHeight(n)||(t?t.ConsumeAddress({row:n,column:1}):t=new k({row:n,column:1/0,sheet_id:r.id})),this.AutoSizeRow(r,n,i);else for(let n of a){let l=r.GetRowHeight(n);(!l&&o||l&&!o)&&(t?t.ConsumeAddress({row:n,column:1}):t=new k({row:n,column:1/0,sheet_id:r.id})),r.SetRowHeight(n,o)}return r===this.active_sheet?(this.layout.UpdateTotalSize(),this.layout.container&&this.layout.container.offsetHeight&&this.layout.container.offsetHeight>this.layout.total_height?this.UpdateLayout():(this.layout.UpdateTileHeights(!0),this.render_tiles=this.layout.VisibleTiles(),this.Repaint(!1,!0)),this.layout.UpdateAnnotation(this.active_sheet.annotations,this.theme),this.RenderSelections()):this.pending_layout_update.add(r.id),t?{start:t.start,end:t.end}:void 0}SelectInternal(e){e.area?(e.area.start.sheet_id&&e.area.start.sheet_id!==this.active_sheet.id&&this.ActivateSheetInternal({key:22,id:e.area.start.sheet_id}),this.Select(this.primary_selection,new k(e.area.start,e.area.end)),this.RenderSelections()):this.ClearSelection(this.primary_selection)}FreezeInternal(e){let t=this.FindSheet(e.sheet_id||this.active_sheet.id),r=(typeof e.highlight_transition=="boolean"?e.highlight_transition:!0)&&t===this.active_sheet;if(e.rows===t.freeze.rows&&e.columns===t.freeze.columns){r&&this.HighlightFreezeArea();return}t.freeze.rows=e.rows,t.freeze.columns=e.columns,t===this.active_sheet?(this.QueueLayoutUpdate(),this.Repaint(),r&&this.HighlightFreezeArea(),e.rows||e.columns?this.layout.CloneFrozenAnnotations():this.layout.ClearFrozenAnnotations()):this.pending_layout_update.add(t.id)}ExecCommand(e,t=!0){let r=super.ExecCommand(e,t);this.batch||r.render_area&&this.DelayedRender(!1,r.render_area),r.repaint&&this.Repaint();for(let a of r.pending||[])this.pending_layout_update.add(a);return r.layout&&this.QueueLayoutUpdate(),r.sheets&&this.tab_bar&&this.tab_bar.Update(),r.formula&&this.UpdateFormulaBarFormula(),r}},jo=["default","old-style","transitional","handwritten","monospace","industrial","ui"],kr={default:"Sans-serif","old-style":"Old style",transitional:"Serif",handwritten:"Handwritten",monospace:"Monospace",industrial:"Industrial sans",ui:"System UI"},Sa=new Map,Ma=(e,t)=>{let r=t.fontFamily,a="",i=r.split(/,/);for(let d of i){d=d.replace(/'"/g,"").trim();let c=d.toLowerCase();if(ae.is_firefox&&/sitka text/i.test(c))continue;let u=Sa.get(c);if(typeof u>"u"&&(u=Ue.FontLoaded(d),Sa.set(c,u)),u){a=d;break}}a||console.warn("no font found for font stack",e);let s=a.toLowerCase().replace(/['"]/g,"").replace(/\W+/g,"-"),o=t.getPropertyValue("--treb-font-stack-default-size"),n=t.getPropertyValue(`--treb-font-stack-${s}-size`),l=t.getPropertyValue(`--treb-font-stack-${s}-variant`),h=H.ParseFontSize(n||o||"10pt").font_size||{unit:"pt",value:10};return{family:r,font:a,variants:l,size:h}},Ur={grid_color:"#ccc",note_marker_color:"#d2c500",mode:"light",offset_cache:{},offset_light:"#fff",offset_dark:"#000",font_stacks:{},grid_cell_font_size:{value:10,unit:"pt"}},Jo=(e,t)=>{let r=Pi(t),a=t.tint||0;e.mode==="dark"&&(a=-a),e.tint_cache||(e.tint_cache=[]),e.tint_cache[r]||(e.tint_cache[r]={});let i=e.tint_cache[r][a];if(!i){let s=(e.theme_colors_rgb?e.theme_colors_rgb[r]:[0,0,0])||[0,0,0],o;a>0?o=ee.Lighten(s[0],s[1],s[2],a*100,!0):o=ee.Darken(s[0],s[1],s[2],-a*100,!0),i=`rgb(${o.r},${o.g},${o.b})`,e.tint_cache[r][a]=i}return i},N=(e,t,r)=>{if(t&&t.offset){if(t.offset.offset)return console.warn("invalid offset color"),"";let a="";if(oe(t.offset)){let s=Ue.MeasureColor(t.offset.text);a=`rgb(${s[0]}, ${s[1]}, ${s[2]})`}else a=N(e,t.offset,void 0);if(e.offset_cache&&e.offset_cache[a])return e.offset_cache[a];let i=e.offset_light;if(a){let s=a.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(s){let o=[Number(s[1]),Number(s[2]),Number(s[3])],n=Array.from(Ue.MeasureColor(e.offset_dark)),l=Array.from(Ue.MeasureColor(e.offset_light)),h=ee.GetTextColor(o,n,l);i=`rgb(${h[0]}, ${h[1]}, ${h[2]})`}else console.warn("can't offset against color",a,"(1)");e.offset_cache||(e.offset_cache={}),e.offset_cache[a]=i}else console.warn("can't resolve offset color",t.offset,"(2)");return i}return oe(t)?t.text==="none"?"":t.text:ra(t)?t.tint?Jo(e,t):e.theme_colors?e.theme_colors[Pi(t)]:"":(r||r===0)&&e.theme_colors?e.theme_colors[r]:""},Wo=e=>{let t=10,r="pt",a=e.match(/^([\d.]+)(\D.*)$/);return a&&(t=Number(a[1]),r=a[2]),{value:t,unit:r}},Aa=(e,t=!1)=>{let r={fill:{text:e.backgroundColor},text:{text:e.color},font_size:{unit:"em",value:1}};return t&&(r.font_face=e.fontFamily),/italic/i.test(e.font)&&(r.italic=!0),e.fontWeight==="700"&&(r.bold=!0),r},Zo=(e,t)=>{let r=e.grid_cell?.text,a=e.grid_cell?.fill;t.fillStyle=oe(r)?r.text:"",t.fillRect(0,0,3,3);let i=ee.RGBToHSL(...Array.from(t.getImageData(1,1,1,1).data));t.fillStyle=oe(a)?a.text:"",t.fillRect(0,0,3,3);let s=ee.RGBToHSL(...Array.from(t.getImageData(1,1,1,1).data));return i.l>s.l?"dark":"light"},Ir=(e,t=.7)=>{let r={border_top:1,border_top_fill:{theme:e},border_bottom:1,border_bottom_fill:{theme:e}};return{header:{text:{offset:{theme:e}},fill:{theme:e},bold:!0,...r},odd:{fill:{theme:e,tint:t},...r},even:{...r},total:{...r,border_top:2}}},Ko=(e,t=!1)=>{let r=JSON.parse(JSON.stringify(Ur)),a=le.GetInstance(e.ownerDocument),i=(u,m)=>a.Div(m,u),s=(u,m)=>a.view?.getComputedStyle(i(u,m)),o=i(e,""),n=s.bind(0,o),l=n("grid-cells");if(r.grid_cell=Aa(l,!1),r.grid_color=l.stroke||"",r.grid_cell_font_size=Wo(l.fontSize||""),t)for(let u of jo)l=n(`treb-font-stack-${u}`),r.font_stacks[u]=Ma(u,l);else l=n("treb-font-stack-default"),r.font_stacks.default=Ma("default",l);l=n("grid-headers"),r.headers=Aa(l,!0),r.headers_grid_color=l.stroke,(!r.headers_grid_color||r.headers_grid_color==="none")&&(r.headers_grid_color=r.grid_color),l=n("treb-offset-dark"),l.color&&(r.offset_dark=l.color),l=n("treb-offset-light"),l.color&&(r.offset_light=l.color),l=n("note-marker"),r.note_marker_color=l.backgroundColor,o.style.color="rgba(1,2,3,.4)",l=n("");let h=l.color;r.theme_colors=[oe(r.grid_cell.fill)?r.grid_cell.fill.text:"rgb(255, 255, 255)",oe(r.grid_cell.text)?r.grid_cell.text.text:"rgb(51, 51, 51)"];for(let u=1;u<32&&(l=n(`theme-color-${u}`),!(!l.color||l.color===h));u++)r.theme_colors.push(l.color);let d=a.Create("canvas");d.width=3,d.height=3;let c=d.getContext("2d",{willReadFrequently:!0});return c&&(r.mode=Zo(r,c)),c&&(r.theme_colors_rgb=r.theme_colors.map(u=>{c.fillStyle=u,c.fillRect(0,0,3,3);let m=c.getImageData(1,1,1,1);return Array.from(m.data)})),r.table=Ir(4),o.parentElement?.removeChild(o),r},Xo={column:0,type:"auto",asc:!0},Qo=class{constructor(e,t,r="RGB"){this.color_space=r,this.mapped=e.map(a=>{if(a.value<0||a.value>1)throw new Error("invalid stop value");let i=Ue.MeasureColor(N(t,a.color)),s=[];if(r==="HSL"){let o=ee.RGBToHSL(i[0],i[1],i[2]);s=[o.h,o.s,o.l]}else s=[...i];return{...a,resolved:s}}),this.mapped.sort((a,i)=>a.value-i.value),this.mapped[0].value>0&&this.mapped.unshift({...this.mapped[0],value:0}),this.mapped[this.mapped.length-1].value<1&&this.mapped.push({...this.mapped[this.mapped.length-1],value:1})}mapped;RenderColor(e){return this.color_space==="RGB"?{text:`rgb(${e})`}:{text:`hsl(${e[0]},${e[1]*100}%,${e[2]*100}%)`}}Interpolate(e){e=Math.min(1,Math.max(0,e));for(let[t,r]of this.mapped.entries()){if(e===r.value)return this.RenderColor(r.resolved);if(e<r.value){let a=this.mapped[t-1],i=r,s=i.value-a.value,o=e-a.value,n=[0,1,2].map(l=>a.resolved[l]+(i.resolved[l]-a.resolved[l])/s*o);return this.RenderColor(n)}}return{text:""}}},Bi={};zs(Bi,{Iterate:()=>Yo});function*Yo(e){if(e.start.row===1/0||e.end.row===1/0)throw new Error("don't iterate infinite area");let t=e.start.sheet_id;for(let r=e.start.row;r<=e.end.row;r++)for(let a=e.start.column;a<=e.end.column;a++)yield{row:r,column:a,sheet_id:t}}var en=class{constructor(e){this.parser=e}named=new Map;get list(){return this.named.values()}SetNamedExpression(e,t,r){return this.SetName({type:"expression",name:e,expression:t,scope:r})}SetNamedRange(e,t,r){return this.SetName({type:"range",name:e,area:new k(t.start,t.end),scope:r})}SetName(e){let t=e.name;return this.ValidateNamed(t)?(this.named.set(this.ScopedName(t,e.scope),e),!0):(console.warn("invalid name",{name:t}),!1)}ScopedName(e,t){return typeof t=="number"?t+":"+e.toLowerCase():e.toLowerCase()}ClearName(e,t){typeof t=="number"?this.named.delete(this.ScopedName(e,t)):this.named.delete(e.toLowerCase())}RemoveRangesForSheet(e){let t=[];for(let[r,a]of this.named)(a.type==="range"&&a.area.start.sheet_id===e||a.scope===e)&&t.push(r);for(let r of t)this.named.delete(r)}Reset(){this.named.clear()}Get_(e,t,r=!1){return r?this.named.get(this.ScopedName(e,t)):this.named.get(this.ScopedName(e,t))||this.named.get(e.toLowerCase())}ValidateNamed(e){return e=e.trim().toUpperCase(),!e.length||/[^A-Z\d_.?]/.test(e)||/^[^A-Z_]/.test(e)||e==="R"||e==="C"||/^[A-Z]{1,3}[1-9]\d*$/.test(e)||/^R[[\]\d]+C/.test(e)?!1:e}MatchSelection(e,t){if(!e.start.sheet_id)throw new Error("match selection without sheet id");let r;for(let a of this.named.values())if(a.type==="range"&&a.area.start.sheet_id===e.start.sheet_id&&(e.Equals(a.area)&&(r=a.name),t?.Equals(a.area)))return a.name;return r}PatchNamedRanges(e,t,r,a,i){let s=[...this.list];for(let o of s){if(o.type==="expression")continue;let n=o.name,l=o.area;if(l.start.sheet_id!==e){console.info("skipping name",n);continue}if(r&&t<=l.end.column){if(r>0)t<=l.start.column?l.Shift(0,r):t>l.start.column&&t<=l.end.column?l.ConsumeAddress({row:l.end.row,column:l.end.column+r}):console.warn("PNR X case 1",t,r,JSON.stringify(l));else if(r<0)if(t-r<=l.start.column)l.Shift(0,r);else if(t<=l.start.column&&t-r>l.end.column)this.ClearName(n);else if(t<=l.start.column){let h=t-r-1;this.SetName({type:"range",area:new k({row:l.start.row,column:h+1+r,sheet_id:e},{row:l.end.row,column:l.end.column+r}),name:n})}else t<=l.end.column?t-r-1>=l.end.column?this.SetName({type:"range",area:new k({row:l.start.row,column:l.start.column,sheet_id:e},{row:l.end.row,column:t-1}),name:n}):this.SetName({type:"range",name:n,area:new k({row:l.start.row,column:l.start.column,sheet_id:e},{row:l.end.row,column:l.start.column+l.columns+r-1})}):console.warn("PNR X case 2",t,r,JSON.stringify(l))}if(i&&a<=l.end.row){if(i>0)a<=l.start.row?l.Shift(i,0):a>l.start.row&&a<=l.end.row?l.ConsumeAddress({row:l.end.row+i,column:l.end.column}):console.warn("PNR X case 3",a,i,JSON.stringify(l));else if(i<0)if(a-i<=l.start.row)l.Shift(i,0);else if(a<=l.start.row&&a-i>l.end.row)this.ClearName(n);else if(a<=l.start.row){let h=a-i-1;this.SetNamedRange(n,new k({column:l.start.column,row:h+1+i,sheet_id:e},{column:l.end.column,row:l.end.row+i}))}else a<=l.end.row?a-i-1>=l.end.row?this.SetNamedRange(n,new k({column:l.start.column,row:l.start.row,sheet_id:e},{column:l.end.column,row:a-1})):this.SetNamedRange(n,new k({column:l.start.column,row:l.start.row,sheet_id:e},{column:l.end.column,row:l.start.row+l.rows+i-1})):console.warn("PNR X case 4",a,i,JSON.stringify(l))}}}},tn=class{parser=new Di;language_model;document_name;user_data;sheets=new Es;named=new en(this.parser);macro_functions=new Map;view_count=0;theme_style_properties=JSON.parse(JSON.stringify(H.DefaultProperties));tables=new Map;GetName(e,t){let r=e.split(/!/);if(r.length===1)return this.named.Get_(e,t);let a=r[0];/^'.*?'$/.test(a)&&(a=a.substring(1,a.length-1));let i=this.sheets.ID(a);return this.named.Get_(r[1],i||0,!0)}UnserializeNames(e,t,r=!1){this.parser.Save(),r&&this.parser.SetLocaleSettings(".",",");for(let a of e){if(!a.expression)continue;let i=this.parser.Parse(a.expression);if(i.expression){let s=typeof a.scope=="string"?this.sheets.ID(a.scope):void 0;if(i.expression.type==="address"||i.expression.type==="range"){let[o,n]=i.expression.type==="range"?[i.expression.start,i.expression.end]:[i.expression,i.expression];if(o.sheet)if(/^\[\d+\]/.test(o.sheet))console.warn("named range refers to an external file");else{let l=new k({...o,sheet_id:this.sheets.ID(o.sheet)},n);l.start.sheet_id?this.named.SetNamedRange(a.name,l,s):console.warn("missing sheet ID?",o)}else console.warn("missing sheet name?",o)}else this.parser.Walk(i.expression,o=>o.type==="address"||o.type==="range"?(o.type==="range"&&(o=o.start),o.sheet_id||o.sheet&&(o.sheet_id=this.sheets.ID(o.sheet)),o.sheet_id||(o.sheet_id=t?.id),!1):!0),this.named.SetNamedExpression(a.name,i.expression,s)}}this.parser.Restore()}SerializeNames(e){let t=[];for(let r of this.named.list){let a={name:r.name,expression:"",type:r.type};if(r.scope&&(a.scope=this.sheets.Name(r.scope)),r.type==="expression")this.parser.Walk(r.expression,i=>{if(i.type==="address"||i.type==="range"){let s=i.type==="range"?i.start:i;return s.absolute_column=s.absolute_row=!0,s.sheet||(s.sheet_id&&(s.sheet=this.sheets.Name(s.sheet_id)),s.sheet||(s.sheet=e?.name)),i.type==="range"&&(i.end.absolute_column=i.end.absolute_row=!0),!1}return!0}),a.expression=this.parser.Render(r.expression,{missing:""});else{let i={start:{...r.area.start,absolute_column:!0,absolute_row:!0},end:{...r.area.end,absolute_column:!0,absolute_row:!0}};a.expression=this.AddressToLabel(i)}t.push(a)}return t}ResolveStructuredReference(e,t){let r;if(e.table?r=this.tables.get(e.table.toLowerCase()):t.sheet_id&&(r=this.sheets.Find(t.sheet_id)?.CellData(t)?.table),!r)return;let a=e.column.toLowerCase(),i=-1;if(r.columns){for(let s=0;s<r.columns.length;s++)if(a===r.columns[s]){i=r.area.start.column+s;break}}if(!(i<0))if(e.scope==="row"){let s=t.row;return s<r.area.start.row||s>r.area.end.row?void 0:{label:e.label,type:"address",row:s,column:i,sheet_id:r.area.start.sheet_id,id:e.id,position:e.position}}else{let s=r.area.start.row,o=r.area.end.row;return e.scope==="column"&&(s++,r.totals_row&&o--),{label:e.label,type:"range",position:e.position,id:e.id,start:{type:"address",row:s,column:i,sheet_id:r.area.start.sheet_id,label:e.label,position:e.position,id:0},end:{type:"address",row:o,column:i,label:e.label,position:e.position,id:0}}}}AddressToLabel(e){let t=$(e)?e:e.start,r=$(e)?[k.CellAddressToLabel(e)]:[k.CellAddressToLabel(e.start),k.CellAddressToLabel(e.end)],a=this.sheets.Find(t.sheet_id||0),i=a?.name?tt.test(a.name)?`'${a.name}'`:a.name:"";return i+(i?"!":"")+(r[0]===r[1]?r[0]:r.join(":"))}ResolveSheetID(e,t,r){let a=e.type==="address"?e:e.start;if(a.sheet_id)return!0;if(a.sheet){let i=this.sheets.Find(a.sheet);if(i)return a.sheet_id=i.id,!0}else{if(t?.sheet_id)return a.sheet_id=t.sheet_id,!0;if(r?.id)return a.sheet_id=r.id,!0}return!1}ResolveArea(e,t,r){let a=this.ResolveAddress(e,t,r);return $(a)?new k(a):new k(a.start,a.end)}ResolveAddress(e,t,r){if(typeof e=="string"){r?.r1c1&&(this.parser.Save(),this.parser.flags.r1c1=!0);let a=this.parser.Parse(e);if(r?.r1c1&&this.parser.Restore(),a.expression&&a.expression.type==="address")return this.ResolveSheetID(a.expression,void 0,t),{row:a.expression.row,column:a.expression.column,sheet_id:a.expression.sheet_id};if(a.expression&&a.expression.type==="range")return this.ResolveSheetID(a.expression,void 0,t),{start:{row:a.expression.start.row,column:a.expression.start.column,sheet_id:a.expression.start.sheet_id},end:{row:a.expression.end.row,column:a.expression.end.column}};if(a.expression&&a.expression.type==="identifier"){let i=this.GetName(a.expression.name,t.id);if(i?.type==="range")return i.area}return{row:0,column:0}}return e}AddConnectedElement(e){let t=this.connected_element_id++;return this.connected_elements.set(t,e),t}RemoveConnectedElement(e){let t=this.connected_elements.get(e);return this.connected_elements.delete(e),t}connected_element_id=100;connected_elements=new Map;language_map;reverse_language_map;SetLanguageMap(e){if(!e)this.language_map=this.reverse_language_map=void 0;else{let t=Object.keys(e);this.language_map={};for(let r of t)this.language_map[r.toUpperCase()]=e[r];this.reverse_language_map={};for(let r of t){let a=e[r];this.reverse_language_map[a.toUpperCase()]=r}}}TranslateFunction(e,t){return this.language_map?this.TranslateInternal(e,this.language_map,this.language_model?.boolean_true,this.language_model?.boolean_false,t):e}UntranslateFunction(e,t){return this.reverse_language_map?this.TranslateInternal(e,this.reverse_language_map,"TRUE","FALSE",t):e}UntranslateData(e,t){return Array.isArray(e)?Ui(e)?e.map(r=>r.map(a=>a&&typeof a=="string"&&a[0]==="="?this.UntranslateFunction(a,t):a)):e.map(r=>r&&typeof r=="string"&&r[0]==="="?this.UntranslateFunction(r,t):r):(e&&typeof e=="string"&&e[0]==="="&&(e=this.UntranslateFunction(e,t)),e)}TranslateInternal(e,t,r,a,i){this.parser.Save(),this.parser.flags.r1c1=i?.r1c1;let s=this.parser.Parse(e);if(s.expression){let o=!1;if(this.parser.Walk(s.expression,n=>{if(n.type==="call"){let l=t[n.name.toUpperCase()];l&&(o=!0,n.name=l)}else n.type==="literal"&&typeof n.value=="boolean"&&(o=!0);return!0}),o)return"="+this.parser.Render(s.expression,{missing:"",boolean_true:r,boolean_false:a,r1c1:i?.r1c1})}return this.parser.Restore(),e}SetLanguage(e){if(this.language_model=e,!e)this.SetLanguageMap(),this.parser.flags.boolean_true="TRUE",this.parser.flags.boolean_false="FALSE";else{let t={};if(e.functions)for(let r of e.functions||[])t[r.base.toUpperCase()]=r.name;this.SetLanguageMap(t),e.boolean_false||(e.boolean_false=t.FALSE),e.boolean_true||(e.boolean_true=t.TRUE),this.parser.flags.boolean_true=e.boolean_true||"TRUE",this.parser.flags.boolean_false=e.boolean_false||"FALSE"}for(let t of this.sheets.list)t.FlushCellStyles()}},rn=()=>({target:{row:0,column:0},area:new k({row:0,column:0}),empty:!0}),an=100,Ra={move_with_cells:!0,resize_with_cells:!0,movable:!0,resizable:!0,removable:!0,selectable:!0},Vr=class{data={...Ra};get key(){return this.key_}rect;scaled_rect;temp={};view=[];dirty;key_=an++;constructor(e={}){this.data={...Ra,...JSON.parse(JSON.stringify(e))},e.rect&&(this.rect=ie.Create(e.rect))}toJSON(){return{...this.data,rect:this.rect}}},sn=100,za=60,ge=class Ze{static base_id=100;static default_sheet_name="Sheet1";default_style_properties;annotations=[];freeze={rows:0,columns:0};visible=!0;default_column_width=100;default_row_height=25;cells=new eo;selection=rn();scroll_offset={x:0,y:0};name=Ze.default_sheet_name;tab_color;background_image;_image=void 0;flush_conditional_formats=!1;get image(){return this._image}conditional_formats=[];data_validation=[];outline;id_;row_height_map=new Map;column_width_=[];row_headers=[];column_headers=[];row_header_width=100;column_header_height=25;style_map=[];style_json_map=[];sheet_style={};row_styles={};column_styles={};row_pattern=[];cell_style=[];conditional_format_cache=[];conditional_format_checklist=[];get header_offset(){return{x:this.row_header_width,y:this.column_header_height}}get rows(){return this.cells.rows}get columns(){return this.cells.columns}get id(){return this.id_}set id(t){this.id_=t,this.id>=Ze.base_id&&(Ze.base_id=this.id+1)}constructor(t){this.default_style_properties=t,this.default_column_width=sn,this.row_header_width=za,this.id_=Ze.base_id++}static Reset(){this.base_id=100}static Blank(t,r,a=30,i=20,s){let o=new Ze(t);return s&&o.UpdateDefaultRowHeight(s),r&&(o.name=r),a=Math.max(a,1),i=Math.max(i,1),o.cells.EnsureCell({row:a-1,column:i-1}),o}static UpdateStyle(t){if(typeof t.horizontal_align=="number"){let r=["","left","center","right"];t.horizontal_align=r[t.horizontal_align]||void 0}if(typeof t.vertical_align=="number"){let r=["","top","bottom","middle"];t.vertical_align=r[t.vertical_align]||void 0}}static FromJSON(t,r,a){let i=typeof t=="string"?JSON.parse(t):t,s=(h,d)=>{Object.keys(d).forEach(c=>{let u=Number(c)||0;h[u]=d[c]})};a||(a=new Ze(r)),i.default_column_width&&(a.default_column_width=i.default_column_width),i.default_row_height&&(a.default_row_height=i.default_row_height),i.conditional_formats&&(a.conditional_formats=i.conditional_formats),a.data_validation=(i.data_validations||[]).map(h=>({...h,target:(h.target||[]).map(d=>new k(d.start,d.end))})),i.id&&(a.id=i.id),i.name&&(a.name=i.name),i.tab_color&&(a.tab_color=i.tab_color),i.background_image&&(a.background_image=i.background_image);let o=h=>{let d=h;this.UpdateStyle(d),(d.font_size_value||d.font_size_unit)&&(d.font_size={unit:d.font_size_unit||"pt",value:d.font_size_value||10},d.font_size_unit=void 0,d.font_size_value=void 0),d.font_bold&&(d.bold=!0,d.font_bold=void 0),d.font_italic&&(d.italic=!0,d.font_italic=void 0),d.font_underline&&(d.underline=!0,d.font_underline=void 0),d.font_strike&&(d.strike=!0,d.font_strike=void 0),d.text_color&&(d.text_color!=="none"&&(d.text={text:d.text_color}),d.text_color=void 0),d.background&&(d.background!=="none"&&(d.fill={text:d.background}),d.background=void 0),d.border_top_color&&(d.border_top_color!=="none"&&(d.border_top_fill={text:d.border_top_color}),d.border_top_color=void 0),d.border_left_color&&(d.border_left_color!=="none"&&(d.border_left_fill={text:d.border_left_color}),d.border_left_color=void 0),d.border_bottom_color&&(d.border_bottom_color!=="none"&&(d.border_bottom_fill={text:d.border_bottom_color}),d.border_bottom_color=void 0),d.border_right_color&&(d.border_right_color!=="none"&&(d.border_right_fill={text:d.border_right_color}),d.border_right_color=void 0)},n=i.styles||i.cell_style_refs||[];for(let h of n)o(h);if(a.cell_style=[],n&&(i.cell_styles||[]).forEach(h=>{typeof h.ref=="number"&&(h.style=JSON.parse(JSON.stringify(n[h.ref])))}),a.cells.FromJSON(i.data),i.rows&&a.cells.EnsureRow(i.rows-1),i.columns&&a.cells.EnsureColumn(i.columns-1),i.data)if(dr(i.data))for(let h of i.data)h.style_ref&&(a.cell_style[h.column]||(a.cell_style[h.column]=[]),a.cell_style[h.column][h.row]=JSON.parse(JSON.stringify(n[h.style_ref])));else if(ta(i.data))for(let h of i.data){let d=h.row;for(let c of h.cells){let u=c.column;c.style_ref&&(a.cell_style[u]||(a.cell_style[u]=[]),a.cell_style[u][d]=JSON.parse(JSON.stringify(n[c.style_ref])))}}else for(let h of i.data){let d=h.column;for(let c of h.cells){let u=c.row;c.style_ref&&(a.cell_style[d]||(a.cell_style[d]=[]),a.cell_style[d][u]=JSON.parse(JSON.stringify(n[c.style_ref])))}}a.freeze.rows=0,a.freeze.columns=0,i.freeze&&(a.freeze.rows=i.freeze.rows||0,a.freeze.columns=i.freeze.columns||0),a.scroll_offset=i.scroll?{...i.scroll}:{x:0,y:0};for(let h of i.cell_styles||[])if(h.style&&(a.cell_style[h.column]||(a.cell_style[h.column]=[]),a.cell_style[h.column][h.row]=h.style,h.rows))for(let d=1;d<h.rows;d++)a.cell_style[h.column][h.row+d]=JSON.parse(JSON.stringify(h.style));a.sheet_style=i.sheet_style||{},a.column_styles={},a.row_styles={};let l=(h,d)=>{for(let c of Object.keys(h)){let u=Number(c),m=h[u];if(typeof m=="number"){let f=n[m];f&&(d[u]=JSON.parse(JSON.stringify(f)),o(d[u]))}else m&&(d[u]=m,o(d[u]))}};l(i.row_style,a.row_styles),l(i.column_style,a.column_styles),a.row_pattern=i.row_pattern||[],o(a.sheet_style||{});for(let h of a.row_pattern)o(h);if(a.row_height_map=new Map,i.row_height)for(let[h,d]of Object.entries(i.row_height))a.row_height_map.set(Number(h),d);if(a.row_height_map.size>0){let h=Math.max(...a.row_height_map.keys());a.cells.EnsureRow(h)}return a.column_width_=[],s(a.column_width_,i.column_width||{}),a.column_width_.length&&a.cells.EnsureColumn(a.column_width_.length-1),a.annotations=(i.annotations||[]).map(h=>new Vr(h)),i.selection&&(a.selection=JSON.parse(JSON.stringify(i.selection))),a.visible=!0,typeof i.visible<"u"&&(a.visible=!!i.visible),a}AddValidation(t){this.data_validation.push({...t,target:(t.target||[]).map(r=>new k(r.start,r.end))})}RemoveValidations(t){let r=new k(t.start,t.end);this.data_validation=this.data_validation.filter(a=>(a.target=a.target.filter(i=>!r.Equals2(i)),a.target.length>0))}GetValidation(t){let r=[];for(let a of this.data_validation)for(let i of a.target)if(i.Contains(t)){r.push(a);break}return r}Activate(t){if(this.background_image){let r=Hi(this.background_image);r&&(this._image=t.Create("img"),this._image.src=r)}}MergeCells(t){t=t.Clone();let r=[...this.cells.Iterate(t,!0)];for(let[a,i]of r.entries())i.merge_area=t,i.render_clean=[],a&&i.Reset()}UnmergeCells(t){for(let r of this.cells.Iterate(t,!1))if(!r.merge_area||!t.Equals(r.merge_area)){console.warn("area mismatch");return}for(let r of this.cells.Iterate(t,!1))r.merge_area=void 0,r.render_clean=[]}UpdateDefaultRowHeight(t,r=1){if(typeof window<"u"){let a=H.Composite([this.default_style_properties,this.sheet_style]),i=H.CompositeFont(t.grid_cell_font_size,a,r,t),s=Rt(i.font,i.variants).height*1.25;this.default_row_height<s&&(this.default_row_height=s)}}SetRowHeaders(t){this.row_headers=t.map(r=>r===void 0?"":r.toString()),this.row_headers&&this.cells.EnsureRow(this.row_headers.length-1)}SetColumnHeaders(t){this.column_headers=t.map(r=>r===void 0?"":r.toString()),t&&this.cells.EnsureColumn(t.length-1)}RowHeader(t){return this.row_headers?this.row_headers.length>t?this.row_headers[t]:"":t+1}ColumnHeader(t){let r="";if(this.column_headers)return this.column_headers.length>t?this.column_headers[t]:"";for(;;){let a=t%26;if(r=String.fromCharCode(65+a)+r,t=Math.floor(t/26),t)t--;else break}return r}GetRowHeight(t){let r=this.row_height_map.get(t);return typeof r>"u"?this.default_row_height:r}SetRowHeight(t,r){return this.row_height_map.set(t,r),this.cells.EnsureRow(t),r}GetColumnWidth(t){let r=this.column_width_[t];return typeof r>"u"?this.default_column_width:r}SetColumnWidth(t,r){return this.column_width_[t]=r,this.cells.EnsureColumn(t),r}Delta(t,r){let a={},i=[...Object.keys(t),...Object.keys(r)];for(let s of i){let o=t[s],n=r[s];typeof o=="object"&&typeof n=="object"?JSON.stringify(o)!==JSON.stringify(n)&&(a[s]=n):o!==n&&(a[s]=n)}return a}UpdateCellStyle(t,r,a=!0){let{row:i,column:s}=t;this.cell_style[s]||(this.cell_style[s]=[]);let o=this.CompositeStyleForCell(t,!1,!1,void 0,!1),n=H.Composite([this.default_style_properties,o,H.Merge(this.cell_style[s][i]||{},r,a)]),l=this.Delta(o,n);this.cell_style[s][i]=l,this.BleedFlush({start:t,end:t})}Invalidate(t){for(let r of this.cells.Iterate(this.RealArea(t),!1))r.render_clean=[]}UpdateAreaStyle(t,r={},a=!0){if(t)if(t.entire_sheet)this.UpdateSheetStyle(r,a);else if(t.entire_column)for(let i=t.start.column;i<=t.end.column;i++)this.UpdateColumnStyle(i,r,a);else if(t.entire_row)for(let i=t.start.row;i<=t.end.row;i++)this.UpdateRowStyle(i,r,a);else for(let i of t)this.UpdateCellStyle(i,r,a)}HasCellStyle(t){return!!(this.cell_style[t.column]&&this.cell_style[t.column][t.row]||this.row_styles[t.row]||this.column_styles[t.column]||this.row_pattern.length)}NextVisibleColumn(t){for(++t;this.column_width_[t]===0;t++);return t}PreviousVisibleColumn(t){for(--t;t>=0&&this.column_width_[t]===0;t--);return t}NextVisibleRow(t){for(++t;this.GetRowHeight(t)===0;t++);return t}PreviousVisibleRow(t){for(--t;t>=0&&this.GetRowHeight(t)===0;t--);return t}TableRow(t,r){let a={alternate:!1,header:r===t.area.start.row,last:!1,totals:t.totals_row&&r===t.area.end.row};if(a.header||a.totals)return a;if(!(t.totals_row&&this.GetRowHeight(t.area.end.row)>0)){let o=t.area.end.row;for(;o>=t.area.start.row;o--)if(this.GetRowHeight(o)){a.last=o===r;break}}let i=t.area.start.row+1,s=r-i;for(let[o,n]of this.row_height_map.entries())if(!(o<i)){if(o>t.area.end.row)break;n||s--}return a.alternate=s%2===1,a}SurroundingStyle(t,r){let a=[{},{},{},{},{},{},{},{},{},{}],i=t.column+1,s=t.column-1,o=t.row+1,n=t.row-1;for(;this.column_width_[i]===0;i++);for(;this.GetRowHeight(o)===0;o++);for(;s>=0&&this.column_width_[s]===0;s--);for(;n>=0&&this.GetRowHeight(n)===0;n--);return s>=0&&n>=0&&(a[7]=this.CellStyleData({row:n,column:s},r)||{}),s>=0&&(a[4]=this.CellStyleData({row:t.row,column:s},r)||{},a[1]=this.CellStyleData({row:o,column:s},r)||{}),n>=0&&(a[8]=this.CellStyleData({row:n,column:t.column},r)||{},a[9]=this.CellStyleData({row:n,column:i},r)||{}),a[6]=this.CellStyleData({row:t.row,column:i},r)||{},a[2]=this.CellStyleData({row:o,column:t.column},r)||{},a[3]=this.CellStyleData({row:o,column:i},r)||{},a}CellStyleData(t,r){let a=this.cells.GetCell(t);if(a){if(!a.style){let i=this.GetStyleIndex(this.CompositeStyleForCell(t));a.style=this.style_map[i]}if(a.table){let i=a.table.theme||r;if(i){let s=JSON.parse(JSON.stringify(a.style)),o=this.TableRow(a.table,t.row);return o.header?i.header&&(s=H.Composite([s,i.header])):o.totals?i.total&&(s=H.Composite([s,i.total])):o.alternate?i.odd&&(s=H.Composite([s,i.odd])):i.even&&(s=H.Composite([s,i.even])),s}}return a.style}}GetCopyStyle(t){return this.CompositeStyleForCell(t,!0,!1,void 0,!1)}CellData(t){let r=this.cells.EnsureCell(t);if(r.rendered_type)return r;let a,i;if(r.calculated_type?(i=r.calculated,a=r.calculated_type):(i=r.value,a=r.type),!r.style){let s=this.GetStyleIndex(this.CompositeStyleForCell(t));r.style=this.style_map[s]}if(!a||i===null||typeof i>"u")r.formatted="",r.rendered_type=2;else if(a===3)isNaN(i)?r.formatted=typeof r.style.nan>"u"?"NaN":r.style.nan:r.formatted=this.FormatNumber(i,r.style.number_format),r.rendered_type=3;else if(a===6)r.formatted="#"+(i||"ERR?"),r.rendered_type=6;else if(a===4)r.formatted=i.toString().toUpperCase(),r.rendered_type=4;else if(a===1&&r.calculated===void 0)r.formatted="",r.rendered_type=2;else if(a===7){let s=i;if(isNaN(s.real)||isNaN(s.imaginary))r.formatted=typeof r.style.nan>"u"?"NaN":r.style.nan;else{let o=V.Get(r.style.number_format||"",!0);r.formatted=o.FormatComplex(s)}r.rendered_type=7}else if(a===9){if(isNaN(i.value))r.formatted=typeof r.style.nan>"u"?"NaN":r.style.nan,r.formatted+=" "+i.unit;else{let s=V.Get(r.style.number_format||"",!0);r.formatted=s.FormatDimensionedQuantity(i)}r.rendered_type=9}else a===10?(r.formatted="𝑓()",r.rendered_type=2):(r.formatted=this.FormatNumber(i,r.style.number_format),r.rendered_type=2);return r}FormatNumber(t,r=""){let a=V.Get(r).FormatParts(t);return a.length?a.length===1&&!a[0].flag?a[0].text||"":a:""}SetHeaderSize(t=za,r=this.default_row_height){this.row_header_width=t,this.column_header_height=r}GetStyle(t){return this.style_map[t]}InsertRows(t=0,r=1){if(t)for(let h=0;h<this.cells.columns;h++){let d=this.cells.GetCell({row:t-1,column:h},!1);if(d&&d.area){let c=this.cells.GetCell({row:t,column:h},!1);if(c&&c.area&&c.area.Equals(d.area))return!1}}r<0?this.cells.DeleteRows(t,-r):this.cells.InsertRows(t,r);let a={},i={};for(let h=t;h<this.cells.rows;h++)for(let d=0;d<this.cells.columns;d++){let c=this.cells.GetCell({row:h,column:d},!1);c&&(c.area&&!i[c.area.spreadsheet_label]&&(i[c.area.spreadsheet_label]=c.area),c.merge_area&&!a[c.merge_area.spreadsheet_label]&&(a[c.merge_area.spreadsheet_label]=c.merge_area))}for(let h of Object.keys(i)){let d=i[h],c=new k({row:d.start.row+r,column:d.start.column},{row:d.end.row+r,column:d.end.column});for(let u of c){let m=this.cells.GetCell(u,!0);m.area=c}}for(let h of Object.keys(a)){let d=a[h],c={row:d.start.row,column:d.start.column};d.start.row>=t&&(c.row+=r);let u=new k(c,{row:d.end.row+r,column:d.end.column});for(let m of u){let f=this.cells.GetCell(m,!0);f.merge_area=u}}let s=Object.keys(this.row_styles),o={};s.forEach(h=>{let d=Number(h);d<t?o[d]=this.row_styles[d]:r<0&&d<t-r||(o[d+r]=this.row_styles[d])}),this.row_styles=o;let n=[];if(r<0)n=[t,-r];else{n=[t,0];for(let h=0;h<r;h++)n.push(void 0)}this.cell_style.forEach(h=>{h&&h.length>=t&&h.splice.apply(h,n)});let l=new Map;if(r>0)for(let[h,d]of this.row_height_map)h>=t?l.set(h+r,d):l.set(h,d);else if(r<0)for(let[h,d]of this.row_height_map)h>=t?h>=t-r&&l.set(h+r,d):l.set(h,d);return this.row_height_map=l,this.FlushCellStyles(),!0}InsertColumns(t=0,r=1){if(t)for(let l=0;l<this.cells.rows;l++){let h=this.cells.GetCell({row:l,column:t-1},!1);if(h&&h.area){let d=this.cells.GetCell({row:l,column:t},!1);if(d&&d.area&&d.area.Equals(h.area))return!1}}r<0?this.cells.DeleteColumns(t,-r):this.cells.InsertColumns(t,r);let a={},i={};for(let l=t;l<this.cells.columns;l++)for(let h=0;h<this.cells.rows;h++){let d=this.cells.GetCell({row:h,column:l},!1);d&&(d.area&&!i[d.area.spreadsheet_label]&&(i[d.area.spreadsheet_label]=d.area),d.merge_area&&!a[d.merge_area.spreadsheet_label]&&(a[d.merge_area.spreadsheet_label]=d.merge_area))}for(let l of Object.keys(i)){let h=i[l],d=new k({row:h.start.row,column:h.start.column+r},{row:h.end.row,column:h.end.column+r});for(let c of d){let u=this.cells.GetCell(c,!0);u.area=d}}for(let l of Object.keys(a)){let h=a[l],d={row:h.start.row,column:h.start.column};h.start.column>=t&&(d.column+=r);let c=new k(d,{row:h.end.row,column:h.end.column+r});for(let u of c){let m=this.cells.GetCell(u,!0);m.merge_area=c}}let s=Object.keys(this.column_styles),o={};s.forEach(l=>{let h=Number(l);h<t?o[h]=this.column_styles[h]:r<0&&h<t-r||(o[h+r]=this.column_styles[h])}),this.column_styles=o;let n=[];if(r<0)n=[t,-r];else{n=[t,0];for(let l=0;l<r;l++)n.push(void 0)}return this.cell_style.splice.apply(this.cell_style,n),this.column_width_.splice.apply(this.column_width_,n),this.FlushCellStyles(),!0}ClearArea(t){for(let r of this.cells.Iterate(this.RealArea(t),!1))r.Reset()}SetAreaValues2(t,r){t=this.RealArea(t),this.cells.SetArea(t,r)}SetArrayValue(t,r){t=this.RealArea(t);for(let a of this.cells.Iterate(t,!0))a.SetArray(t);this.cells.GetCell(t.start,!0).SetArrayHead(t,r)}SetCellValue(t,r){this.cells.GetCell(t,!0).Set(r)}TablesFromArea(t,r=!1){if($(t)){let i=this.cells.GetCell(t,!1);return i?.table&&(!r||t.row===i.table.area.start.row)?[i.table]:[]}let a=new Set;for(let i=t.start.row;i<=t.end.row;i++)for(let s=t.start.column;s<=t.end.column;s++){let o=this.cells.GetCell({row:i,column:s},!1);o?.table&&!a.has(o.table)&&(!r||i===o.table.area.start.row)&&a.add(o.table)}return Array.from(a.values())}RealArea(t,r=!1){let a=t.start,i=t.end;return t.entire_row&&(a.column=0,a.absolute_column=!1,i.column=this.cells.columns-1,i.absolute_column=!1),t.entire_column&&(a.row=0,a.absolute_row=!1,i.row=this.cells.rows-1,i.absolute_row=!1),r&&(i.row>=this.rows&&(i.row=this.rows-1,i.absolute_row=!1),i.column>=this.columns&&(i.column=this.columns-1,i.absolute_column=!1)),new k(a,i)}GetCellStyle(t,r=!1){if($(t))return this.CompositeStyleForCell(t,!0,!1,r);if(t.start.row===t.end.row&&t.start.column===t.end.column)return[[this.CompositeStyleForCell(t.start,!0,!1,r)]];let a=[];for(let i=t.start.row;i<=t.end.row;i++){let s=[];for(let o=t.start.column;o<=t.end.column;o++)s.push(this.CompositeStyleForCell({row:i,column:o},!0,!1,r));a.push(s)}return a}FormattedCellValue(t){let r=this.CellData(t);if(r)return typeof r.formatted=="string"?r.formatted:r.formatted?r.formatted.map(a=>{switch(a.flag){case 1:return" ";case 2:return" ";default:return a.text}}).join(""):r.value}GetFormattedRange(t,r=t){if(t.row===r.row&&t.column===r.column)return this.FormattedCellValue(t);let a=[];for(let i=t.row;i<=r.row;i++){let s=[];for(let o=t.column;o<=r.column;o++)s.push(this.FormattedCellValue({row:i,column:o}));a.push(s)}return a}NumberFormatsAndColors(t,r){let a=i=>{i.number_format&&(r[i.number_format]=1),oe(i.text)&&(t[i.text.text]=1),oe(i.fill)&&(t[i.fill.text]=1),oe(i.border_top_fill)&&(t[i.border_top_fill.text]=1),oe(i.border_left_fill)&&(t[i.border_left_fill.text]=1),oe(i.border_right_fill)&&(t[i.border_right_fill.text]=1),oe(i.border_bottom_fill)&&(t[i.border_bottom_fill.text]=1)};a(this.sheet_style);for(let i in this.row_styles)a(this.row_styles[i]);for(let i in this.column_styles)a(this.column_styles[i]);for(let i of this.row_pattern)a(i);for(let i of this.cell_style)if(i)for(let s of i)s&&a(s)}CompressCellStyles(t){let r=[];for(let a=0;a<t.length;a++){let i=t[a];if(i)for(let s=0;s<i.length;s++){let o=i[s];if(o){let n=s+1;for(;n<i.length&&i[n]===o;n++);n>s+1?r.push({row:s,column:a,ref:o,rows:n-s}):r.push({row:s,column:a,ref:o}),s=n-1}}}return r}toJSON(t={}){let r=(C,S)=>{let R={};for(let M=0;M<C.length;M++)typeof C[M]<"u"&&C[M]!==S&&(R[M]=C[M]);if(Object.keys(R).length)return R},a=[{}],i={},s=[],o=JSON.stringify({});for(let C=0;C<this.cell_style.length;C++){let S=this.cell_style[C];if(S){s[C]=[];for(let R=0;R<S.length;R++)if(S[R]){let M=JSON.stringify(S[R]);if(M!==o){let A=i[M];typeof A!="number"&&(i[M]=A=a.length,a.push(S[R])),s[C][R]=A}}}}let n=C=>{let S=JSON.stringify(C);if(S===o)return 0;let R=i[S];return typeof R!="number"&&(i[S]=R=a.length,a.push(C)),R};a=JSON.parse(JSON.stringify(a));let l=JSON.parse(JSON.stringify(this.sheet_style)),h=JSON.parse(JSON.stringify(this.row_pattern)),d={},c={};for(let C of Object.keys(this.column_styles)){let S=Number(C),R=this.column_styles[S];if(R){let M=n(R);M&&(d[S]=M)}}if(this.row_pattern&&this.row_pattern.length&&t.apply_row_pattern){let C=this.rows+1;for(let S of Object.keys(this.row_styles)){let R=Number(S);!isNaN(R)&&R>=C&&(C=R+1)}for(let S=0;S<C;S++){let R=this.row_pattern[S%this.row_pattern.length],M=this.row_styles[S]||{},A=H.Composite([R,M]),P=n(A);P&&(c[S]=P)}}else for(let C of Object.keys(this.row_styles)){let S=Number(C),R=this.row_styles[S];if(R){let M=n(R);M&&(c[S]=M)}}let u=(C={},S={})=>{let R={...S,...C};if(oe(R))return R.text=Ue.MeasureColorARGB(R.text),R;if(ra(R))return R};if(t.export_colors){let C=[];for(let S of[a,[l],h])if(Array.isArray(S))for(let R of S)C.push(R);else for(let R of Object.keys(S))C.push(S[R]);for(let S of C){let R=u(S.border_top_fill,H.DefaultProperties.border_top_fill);R!==void 0&&(S.border_top_fill=R),R=u(S.border_left_fill,H.DefaultProperties.border_left_fill),R!==void 0&&(S.border_left_fill=R),R=u(S.border_right_fill,H.DefaultProperties.border_right_fill),R!==void 0&&(S.border_right_fill=R),R=u(S.border_bottom_fill,H.DefaultProperties.border_bottom_fill),R!==void 0&&(S.border_bottom_fill=R),oe(S.fill)&&(S.fill.text=Ue.MeasureColorARGB(S.fill.text)),oe(S.text)&&(S.text.text=Ue.MeasureColorARGB(S.text.text))}}let m={calculated_value:!!t.rendered_values,preserve_type:!!t.preserve_type,expand_arrays:!!t.expand_arrays,decorated_cells:!!t.decorated_cells,nested:!0,cell_style_refs:s,tables:!!t.tables},f=this.cells.toJSON(m),p=f.data,{rows:b,columns:w}=f;t.shrink?(b+=2,w+=1):(b=this.rows,w=this.columns);for(let C of this.annotations)C.data.extent||this.CalculateAnnotationExtent(C),C.data.extent&&(b=Math.max(b,C.data.extent.row+1),w=Math.max(w,C.data.extent.column+1));let y=this.CompressCellStyles(s),g=this.conditional_formats.length?JSON.parse(JSON.stringify(this.conditional_formats.map(C=>({...C,internal:void 0})))):void 0,v=this.data_validation.length?JSON.parse(JSON.stringify(this.data_validation)):void 0,x={};for(let[C,S]of this.row_height_map.entries())x[C]=S;let _={id:this.id,name:this.name,tab_color:this.tab_color,data:p,sheet_style:l,rows:b,columns:w,cell_styles:y,styles:a,row_style:c,column_style:d,conditional_formats:g,data_validations:v,row_pattern:h.length?h:void 0,default_row_height:this.default_row_height,default_column_width:this.default_column_width,row_height:x,column_width:r(this.column_width_,this.default_column_width),selection:JSON.parse(JSON.stringify(this.selection)),annotations:JSON.parse(JSON.stringify(this.annotations))};return this.visible||(_.visible=this.visible),(this.scroll_offset.x||this.scroll_offset.y)&&(_.scroll=this.scroll_offset),this.background_image&&(_.background_image=this.background_image),(this.freeze.rows||this.freeze.columns)&&(_.freeze=this.freeze),_}FlushCellStyles(){this.style_map=[],this.style_json_map=[],this.cells.FlushCellStyles()}ImportData(t){let r=t.styles;t.outline&&(this.outline=t.outline);let a=t.sheet_style;a&&this.UpdateAreaStyle(new k({row:1/0,column:1/0},{row:1/0,column:1/0}),r[a]);let i=t.column_styles;if(i)for(let o=0;o<i.length;o++)i[o]&&this.UpdateAreaStyle(new k({row:1/0,column:o},{row:1/0,column:o}),r[i[o]]);if(t.row_styles)for(let[o,n]of t.row_styles.entries())n&&this.UpdateAreaStyle(new k({row:o,column:1/0}),r[n]);this.cells.FromJSON(t.cells),t.name&&(this.name=t.name||""),t.tab_color&&(this.tab_color=t.tab_color);let s=this.cell_style;for(let o of t.cells)o.style_ref&&(s[o.column]||(s[o.column]=[]),s[o.column][o.row]=r[o.style_ref]);for(let o=0;o<t.column_widths.length;o++)typeof t.column_widths[o]<"u"&&this.SetColumnWidth(o,t.column_widths[o]);for(let o=0;o<t.row_heights.length;o++)typeof t.row_heights[o]<"u"&&this.SetRowHeight(o,t.row_heights[o]);for(let o of t.annotations||[])this.annotations.push(new Vr(o));for(let o of t.conditional_formats||[])this.conditional_formats.push(o);for(let o of t.data_validations||[])this.AddValidation(o);t.hidden&&(this.visible=!1)}CalculateAnnotationExtent(t){if(t.data.layout){t.data.extent={...t.data.layout.br.address};return}let r=1e3;t.data.extent={row:0,column:0};let a=t.rect?.right;if(a&&this.default_column_width){for(let s=0;a>=0&&s<r;s++)if(a-=this.GetColumnWidth(s),a<0){t.data.extent.column=s;break}}let i=t.rect?.bottom;if(i&&this.default_row_height){for(let s=0;i>=0&&s<r;s++)if(i-=this.GetRowHeight(s),i<0){t.data.extent.row=s;break}}}UpdateSheetStyle(t,r=!0){this.sheet_style=H.Merge(this.sheet_style,t,r);let a=Object.keys(t);for(let i of this.cell_style)if(i)for(let s of i)s&&a.forEach(o=>delete s[o]);for(let i of Object.keys(this.row_styles))a.forEach(s=>delete this.row_styles[i][s]);for(let i of Object.keys(this.column_styles))a.forEach(s=>delete this.column_styles[i][s]);this.FlushCellStyles()}UpdateRowStyle(t,r,a=!0){this.row_styles[t]=H.Merge(this.row_styles[t]||{},r,a);let i=Object.keys(r);for(let s of this.cell_style)s&&s[t]&&i.forEach(o=>delete s[t][o]);for(let s=0;s<this.cells.columns;s++)if(this.column_styles[s]){let o=this.column_styles[s],n=this.cell_style[s]?this.cell_style[s][t]||{}:{};for(let l of i)typeof o[l]<"u"&&(n[l]=r[l]);Object.keys(n).length&&(this.cell_style[s]||(this.cell_style[s]=[]),this.cell_style[s][t]=JSON.parse(JSON.stringify(n)))}for(let s of this.cells.Iterate(this.RealArea(k.FromRow(t))))s.FlushStyle()}UpdateColumnStyle(t,r,a=!0){this.column_styles[t]=H.Merge(this.column_styles[t]||{},r,a);let i=Object.keys(r);if(this.cell_style[t])for(let s of this.cell_style[t])s&&i.forEach(o=>delete s[o]);for(let s of this.cells.Iterate(this.RealArea(k.FromColumn(t))))s.FlushStyle()}BleedFlush(t){let r=[Math.max(0,t.start.row-1),t.end.row+1],a=[Math.max(0,t.start.column-1),t.end.column+1];for(let i=r[0];i<=r[1];i++)for(let s=a[0];s<=a[1];s++)this.cells.GetCell({row:i,column:s},!1)?.FlushStyle()}FlushConditionalFormats(){this.flush_conditional_formats=!0}ApplyConditionalFormats(){let t=this.flush_conditional_formats;for(let i of this.conditional_formats)if(i.internal?.vertex?.updated){t=!0;break}if(!t)return;this.flush_conditional_formats=!1;let r=[],a=[...this.conditional_format_checklist];this.conditional_format_checklist=[];for(let i of this.conditional_formats){i.internal?.vertex?.updated&&(i.internal.vertex.updated=!1);let s=JSON.parse(JSON.stringify(i.area));(s.start.row===null||s.end.row===null)&&(s.start.row=0,s.end.row=this.cells.rows-1),(s.start.column===null||s.end.column===null)&&(s.start.column=0,s.end.column=this.cells.columns-1);let o=i.internal?.vertex?.result;if(i.type==="gradient"){if(o&&i.internal?.gradient){let n=i.property??"fill";if(o.type===8)for(let l=s.start.row;l<=s.end.row;l++)for(let h=s.start.column;h<=s.end.column;h++){let d=o.value[h-s.start.column][l-s.start.row];if(d.type===3){r[l]||(r[l]=[]),r[l][h]||(r[l][h]=[]);let c=i.internal.gradient.Interpolate(d.value);r[l][h].push({[n]:c})}}else if(o.type===3){let l=i.internal.gradient.Interpolate(o.value);for(let h=s.start.row;h<=s.end.row;h++){r[h]||(r[h]=[]);for(let d=s.start.column;d<=s.end.column;d++)r[h][d]||(r[h][d]=[]),r[h][d].push({[n]:l})}}a.push(s),this.conditional_format_checklist.push(s)}}else if(o){if(o.type===8)for(let n=s.start.row;n<=s.end.row;n++)for(let l=s.start.column;l<=s.end.column;l++){let h=o.value[l-s.start.column][n-s.start.row];h&&(h.type===4||h.type===3)&&h.value&&(r[n]||(r[n]=[]),r[n][l]||(r[n][l]=[]),r[n][l].push(i.style))}else if((o.type===4||o.type===3)&&o.value)for(let n=s.start.row;n<=s.end.row;n++){r[n]||(r[n]=[]);for(let l=s.start.column;l<=s.end.column;l++)r[n][l]||(r[n][l]=[]),r[n][l].push(i.style)}a.push(s),this.conditional_format_checklist.push(s)}}for(let i of a)this.BleedFlush(i);this.conditional_format_cache=r}ConditionalFormatForCell(t){return this.conditional_format_cache[t.row]?this.conditional_format_cache[t.row][t.column]||[]:[]}CompositeStyleForCell(t,r=!0,a=!0,i=!0,s=!0){let{row:o,column:n}=t,l=[];return i&&l.push(this.default_style_properties),l.push(this.sheet_style),a&&this.row_pattern.length&&l.push(this.row_pattern[o%this.row_pattern.length]),this.row_styles[o]&&l.push(this.row_styles[o]),this.column_styles[n]&&l.push(this.column_styles[n]),r&&this.cell_style[n]&&this.cell_style[n][o]&&l.push(this.cell_style[n][o]),s&&l.push(...this.ConditionalFormatForCell(t)),H.Composite(l)}GetStyleIndex(t){let r=JSON.stringify(t);for(let i=0;i<this.style_json_map.length;i++)if(r===this.style_json_map[i])return i;let a=this.style_map.length;return this.style_map.push(JSON.parse(r)),this.style_json_map.push(r),a}},on={"red-green":{color_space:"RGB",stops:[{value:0,color:{theme:5,tint:.5}},{value:1,color:{theme:9,tint:.5}}]},"red-yellow-green":{color_space:"RGB",stops:[{value:0,color:{theme:5,tint:.5}},{value:.5,color:{theme:7,tint:.5}},{value:1,color:{theme:9,tint:.5}}]},"green-red":{color_space:"RGB",stops:[{value:0,color:{theme:9,tint:.5}},{value:1,color:{theme:5,tint:.5}}]},"green-yellow-red":{color_space:"RGB",stops:[{value:0,color:{theme:9,tint:.5}},{value:.5,color:{theme:7,tint:.5}},{value:1,color:{theme:5,tint:.5}}]}},nn=class qi{static type="vertex";type=qi.type;color=0;edges_in=new Set;edges_out=new Set;get has_inbound_edges(){return this.edges_in.size>0}get has_outbound_edges(){return this.edges_out.size>0}Reset(){for(let t of this.edges_out)t.RemoveDependency(this);for(let t of this.edges_in)t.RemoveDependent(this);this.edges_out.clear(),this.edges_in.clear()}ClearDependencies(){for(let t of this.edges_in)t.RemoveDependent(this);this.edges_in.clear()}AddDependent(t){t!==this&&(this.edges_out.has(t)||this.edges_out.add(t))}RemoveDependent(t){this.edges_out.delete(t)}AddDependency(t){t!==this&&(this.edges_in.has(t)||this.edges_in.add(t))}RemoveDependency(t){this.edges_in.delete(t)}LinkTo(t){this.AddDependent(t),t.AddDependency(this)}DependsOn(t){this.AddDependency(t),t.AddDependent(this)}LoopCheck(){let t=[this];for(;t.length;){let r=t[t.length-1],a=!0;if(r.color!==2){r.color=1;for(let i of r.edges_out){if(i.color===1)return this.color=0,!0;i.color===0&&i.edges_out.size&&(t.push(i),a=!1)}}a&&(r.color=2,t.pop())}return this.color=2,!1}},ji=class extends nn{dirty=!1},ln={error:"NOTIMPL"},Pe=()=>({type:6,value:"N/A"}),_e=()=>({type:6,value:"EXPR"}),U=()=>({type:6,value:"DATA"}),Me=()=>({type:6,value:"DIV/0"}),L=()=>({type:6,value:"ARG"}),F=()=>({type:6,value:"VALUE"}),Z=()=>({type:6,value:"REF"}),Or=()=>({type:6,value:"NAME"}),hn=()=>({type:6,value:"SPILL"}),Ji=()=>({type:6,value:"UNK"}),lr=class Wi extends ji{static type="spreadsheet-vertex";reference;error=0;address;result={type:0};expression={type:"missing",id:-1};expression_error=!1;short_circuit=!1;type=Wi.type;get array_head(){return this.address?!!this.reference&&!!this.reference.area&&this.reference.area.start.column===this.address.column&&this.reference.area.start.row===this.address.row:!1}TakeReferenceValue(){this.reference&&(this.result=Y(this.reference.GetValue()))}Calculate(t){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){this.reference&&(this.array_head||this.reference.type===1)&&this.reference.SetCalculationError("LOOP");for(let r of this.edges_out)r.Calculate(t);return}for(let r of this.edges_in)if(r.dirty)return;if(this.reference){if(this.reference.type===1){this.short_circuit=!1;let r=t.CalculationCallback.call(t,this);if(this.result=r.value,this.short_circuit)return;r.volatile&&t.volatile_list.push(this)}else this.result=this.reference.GetValue4();if(this.array_head)t.SpreadCallback.call(t,this,this.result);else if(this.reference.type===1)if(this.result.type===8){let r=t.SpillCallback.call(t,this,this.result);if(r)for(let a of r)for(let i of a.edges_out)i.dirty=!0,i.Calculate(t)}else this.reference.SetCalculatedValue(this.result.value,this.result.type)}else console.info("skip dirty constant? [or dangling...]");this.dirty=!1;for(let r of this.edges_out)r.dirty&&t.calculation_list.push(r)}}},Ht=class dt extends ji{static type="array-vertex";static list=[];type=dt.type;area;static GetVertex(t){for(let r of this.list)if(r.area.start.sheet_id===t.start.sheet_id&&r.area.Equals(t))return[r,!1];return[new dt(t),!0]}static Clear(){this.list=[]}static GetContainingArrays(t){let r=[];for(let a of this.list)a.area.start.sheet_id===t.sheet_id&&a.area.Contains(t)&&r.push(a);return r}static CreateImplicitEdges(t,r){for(let a of this.list)a.area.start.sheet_id===r.sheet_id&&a.area.Contains(r)&&a.DependsOn(t)}constructor(t){super(),this.area=t.Clone(),dt.list.push(this)}RemoveDependent(t){super.RemoveDependent(t),this.edges_out.size||(this.Reset(),dt.list=dt.list.filter(r=>r!==this))}Calculate(t){if(this.dirty){if(this.color===0&&this.LoopCheck()&&(this.dirty=!1,this.edges_in.size)){for(let r of this.edges_out)r.Calculate(t);return}for(let r of this.edges_in)if(r.dirty)return;this.dirty=!1;for(let r of this.edges_out)r.Calculate(t)}}},Zi=class Ki extends lr{static type="calculation-leaf-vertex";type=Ki.type;address={row:-1,column:-1};use;updated=!1;color=2;Calculate(t){if(!this.dirty)return;for(let a of this.edges_in)if(a.dirty)return;let r=t.CalculationCallback.call(t,this);this.result=r.value,this.dirty=!1,this.updated=!0}AddDependent(){throw new Error("leaf vertex cannot have dependents")}},dn=class{vertices=[[]];volatile_list=[];calculation_list=[];spill_data=[];loop_hint;leaf_vertices=new Set;dirty_list=[];loop_check_required=!1;IsSpreadsheetVertex(e){return e.type===lr.type}FlushTree(){this.dirty_list=[],this.volatile_list=[],this.vertices=[[]],this.leaf_vertices.clear(),Ht.Clear()}ResolveArrayHead(e){if(!e.sheet_id)throw new Error("resolve array head with no sheet id");let t=this.model.sheets.Find(e.sheet_id)?.cells;if(!t)throw new Error("no cells? sheet id "+e.sheet_id);let r=t.data[e.row];if(r){let a=r[e.column];if(a&&a.area){let i={row:a.area.start.row,column:a.area.start.column,sheet_id:e.sheet_id};return console.info("array head",e,i),i}}return e}*IterateVertices(e,t=!1){for(let r of Bi.Iterate(e)){let a=this.GetVertex(r,t);a&&(yield a)}}GetVertex(e,t){if(!e.sheet_id)throw console.info(JSON.stringify({address:e,create:t})),console.trace(),new Error("getvertex with no sheet id");let r=this.model.sheets.Find(e.sheet_id)?.cells;if(!r)throw new Error("no cells? sheet id "+e.sheet_id);if(!this.vertices[e.sheet_id]){if(!t)return;this.vertices[e.sheet_id]=[]}if(this.vertices[e.sheet_id][e.column]){let i=this.vertices[e.sheet_id][e.column][e.row];if(i)return i;if(!t)return}else{if(!t)return;this.vertices[e.sheet_id][e.column]=[]}let a=new lr;return a.address={row:e.row,column:e.column,absolute_row:e.absolute_row,absolute_column:e.absolute_column,sheet_id:e.sheet_id},a.reference=r.EnsureCell(e),this.vertices[e.sheet_id][e.column][e.row]=a,Ht.CreateImplicitEdges(a,e),a}RemoveVertex(e){if(!e.sheet_id)throw new Error("removevertex with no sheet id");let t=this.GetVertex(e,!1);t&&(t.Reset(),this.vertices[e.sheet_id][e.column][e.row]=void 0)}ResetVertex(e){let t=this.GetVertex(e,!1);t&&t.Reset()}RIBcount=0;ResetInbound(e,t=!1,r=!0,a=!1){this.RIBcount++;let i=this.GetVertex(e,r);if(!i){if(t){let o=Ht.GetContainingArrays(e);for(let n of o)this.SetVertexDirty(n)}return}let s=[];if(a&&(s=Array.from(i.edges_in)),i.ClearDependencies(),t&&this.SetVertexDirty(i),a){i.has_outbound_edges||this.RemoveVertex(e);for(let o of s)if(!o.has_inbound_edges&&!o.has_outbound_edges){let n=o;n.address&&this.RemoveVertex(n.address)}}}ResetLoopState(){for(let e of this.vertices)if(e){for(let t of e)if(t)for(let r of t)r&&(r.color=r.edges_out.size?0:2)}for(let e of this.leaf_vertices)e.color=2}LoopCheck(e=!1){if(!this.loop_check_required&&!e)return!1;let t=[];for(let a of this.vertices)if(a){for(let i of a)if(i)for(let s of i)s&&(s.color=s.edges_out.size?0:2,t.push(s))}let r=[];for(let a of t)if(a.color===0){for(a.color=1,r.push(a);r.length;){let i=r[r.length-1],s=!0;if(i.color!==2)for(let o of i.edges_out){if(o.color===1)return this.loop_hint=this.RenderAddress(a.address),console.info("loop detected @",this.loop_hint),!0;o.color===0&&(r.push(o),s=!1)}s&&(r.pop(),i.color=2)}a.color=2}return this.loop_check_required=!1,this.loop_hint=void 0,!1}RenderAddress(e){if(!e)return"undefined";let t="";if(e.sheet_id){let a=this.model.sheets.Find(e.sheet_id);a&&(t=a.name+"!")}let r=new k(e);return t+r.spreadsheet_label}CompositeAddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let[r,a]=Ht.GetVertex(e);if(t.DependsOn(r),this.loop_check_required=!0,!a)return;let i=this.vertices[e.start.sheet_id];if(i){if(e.entire_row){for(let s=0;s<i.length;s++)if(i[s])for(let o=e.start.row;o<=e.end.row;o++){let n=i[s][o];n&&r.DependsOn(n)}}else if(e.entire_column){for(let s=e.start.column;s<=e.end.column;s++)if(i[s])for(let o of i[s])o?.address&&r.DependsOn(o)}else for(let s=e.start.row;s<=e.end.row;s++)for(let o=e.start.column;o<=e.end.column;o++)if(i[o]){let n=i[o][s];n&&r.DependsOn(n)}}}AddLeafVertexArrayEdge(e,t){this.CompositeAddArrayEdge(e,t)}AddArrayEdge(e,t){if(!e.start.sheet_id)throw new Error("AddArrayEdge called without sheet ID");let r=this.GetVertex(t,!0);this.CompositeAddArrayEdge(e,r)}AddEdge(e,t){let r=this.GetVertex(e,!0);this.GetVertex(t,!0).DependsOn(r),r.reference&&r.reference.area&&!r.array_head&&this.AddEdge({...e,row:r.reference.area.start.row,column:r.reference.area.start.column},t),this.loop_check_required=!0}RemoveEdge(e,t){let r=this.GetVertex(e,!1),a=this.GetVertex(t,!1);!r||!a||(r.RemoveDependent(a),a.RemoveDependency(r))}SetAreaDirty(e){if(e.start.column===1/0||e.end.column===1/0||e.start.row===1/0||e.end.row===1/0)throw new Error("don't iterate over infinite area");let t=e.start.sheet_id;if(!t)throw new Error("invalid area, missing sheet id");for(let r=e.start.column;r<=e.end.column;r++)for(let a=e.start.row;a<=e.end.row;a++){let i={row:a,column:r,sheet_id:t};this.GetVertex(i,!1)&&this.SetDirty(i)}}SetVertexDirty(e){if(!e.dirty){this.dirty_list.push(e),e.dirty=!0;for(let t of e.edges_out)this.SetVertexDirty(t)}}SetDirty(e){let t=this.GetVertex(e,!0);this.SetVertexDirty(t)}AddLeafVertex(e){this.leaf_vertices.add(e)}RemoveLeafVertex(e){this.leaf_vertices.delete(e)}AddLeafVertexEdge(e,t){let r=this.GetVertex(e,!0);return t.DependsOn(r),0}RemoveLeafVertexEdge(e,t){let r=this.GetVertex(e,!1);r&&(r.RemoveDependent(t),t.RemoveDependency(r))}InitializeGraph(){for(let e of this.dirty_list)this.IsSpreadsheetVertex(e)&&(e.TakeReferenceValue(),this.CheckVolatile(e)&&this.volatile_list.push(e)),e.dirty=!1;this.dirty_list=[]}Recalculate(){for(let e of this.volatile_list)this.SetVertexDirty(e);this.spill_data=this.spill_data.filter(({area:e,vertex:t})=>{if(t.dirty){t.Reset();let r=e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id)?.cells:void 0;if(r)for(let{cell:a,row:i,column:s}of r.IterateRC(new k(e.start,e.end)))a.spill&&(a.spill=void 0,typeof a.value>"u"&&a.Reset()),this.SetDirty({row:i,column:s,sheet_id:e.start.sheet_id});return!1}return!0}),this.calculation_list=this.dirty_list.slice(0),this.volatile_list=[],this.dirty_list=[],this.loop_check_required&&(this.ResetLoopState(),this.loop_check_required=!1);for(let e=0;e<this.calculation_list.length;e++)this.calculation_list[e].Calculate(this);this.calculation_list=[]}},cn=e=>{let t={m:e,n:e,array:[]};for(let r=0;r<e;r++){let a=[];for(let i=0;i<e;i++)a.push({real:0,imaginary:0});t.array.push(a)}return t},un=e=>{let{r:t,theta:r}=e,a=t*Math.cos(r),i=t*Math.sin(r);return{real:a,imaginary:i}},ia=e=>{let t=Math.sqrt(e.real*e.real+e.imaginary*e.imaginary),r=Math.atan2(e.imaginary,e.real);return{r:t,theta:r}},mn=e=>{let t={real:Math.sinh(e.real)*Math.cos(e.imaginary),imaginary:Math.cosh(e.real)*Math.sin(e.imaginary)},r={real:Math.cosh(e.real)*Math.cos(e.imaginary),imaginary:Math.sinh(e.real)*Math.sin(e.imaginary)};return mt(t,r)},fn=e=>mt({real:Math.tan(e.real),imaginary:Math.tanh(e.imaginary)},{real:1,imaginary:-(Math.tan(e.real)*Math.tanh(e.imaginary))}),pn=e=>({real:Math.cosh(e.real)*Math.cos(e.imaginary),imaginary:Math.sinh(e.real)*Math.sin(e.imaginary)}),bn=e=>({real:Math.cos(e.real)*Math.cosh(e.imaginary),imaginary:Math.sin(e.real)*Math.sinh(e.imaginary)}),gn=e=>({real:Math.sinh(e.real)*Math.cos(e.imaginary),imaginary:Math.cosh(e.real)*Math.sin(e.imaginary)}),Xi=e=>({real:Math.sin(e.real)*Math.cosh(e.imaginary),imaginary:Math.cos(e.real)*Math.sinh(e.imaginary)}),Qi=e=>{if(e.imaginary===0)return{real:Math.asin(e.real),imaginary:0};let t=Math.hypot(e.real+1,e.imaginary)/2,r=Math.hypot(e.real-1,e.imaginary)/2,a=t+r,i=t-r,s={real:Math.asin(i),imaginary:Math.log(a+Math.sqrt(a*a-1))};return(e.imaginary<0||e.imaginary===0&&e.real>1)&&(s.imaginary=-s.imaginary),s},_n=e=>{if(e.imaginary===0)return{real:Math.acos(e.real),imaginary:0};let t=Qi(e);return{real:Math.PI/2-t.real,imaginary:t.imaginary}},vn=e=>{let{real:t,imaginary:r}=e;if(t===0){if(r>1)return{real:Math.PI/2,imaginary:.5*Math.log((r-1)/(r+1))};if(r<-1)return{real:-Math.PI/2,imaginary:.5*Math.log((1-r)/(-1-r))}}let a=t*t,i=r*r,s=.5*Math.atan2(2*t,1-a-i),o=.25*Math.log((a+(r+1)*(r+1))/(a+(r-1)*(r-1)));return{real:s,imaginary:o}},yn=(e,t)=>{if(t.real===0&&t.imaginary===0&&e.real===0&&e.imaginary===0)return!1;let r=t.real*t.real+t.imaginary*t.imaginary,a={real:(e.real*t.real+e.imaginary*t.imaginary)/r,imaginary:(e.imaginary*t.real-e.real*t.imaginary)/r},i=a.real*a.real,s=a.imaginary*a.imaginary,o={real:.5*Math.atan2(2*a.real,1-i-s),imaginary:.25*Math.log((i+(a.imaginary+1)*(a.imaginary+1))/(i+(a.imaginary-1)*(a.imaginary-1)))};return t.real<0&&(o.real+=e.real>=0||e.imaginary>=0?Math.PI:-Math.PI),o},wn=(...e)=>{let t=e.shift();if(!t)return{real:0,imaginary:0};for(let r of e)t=ue(t,r);return t},ue=(e,t)=>({real:e.real*t.real-e.imaginary*t.imaginary,imaginary:e.real*t.imaginary+e.imaginary*t.real}),xn=(e,t)=>{let r=[];for(let a=0;a<e.m;a++){let i=[];for(let s=0;s<e.n;s++)i.push(e.array[a][s]+t.array[a][s]);r.push(i)}return{m:e.m,n:e.n,array:r}},Sr=(e,t)=>{let r=[];for(let a=0;a<e.m;a++){let i=[];for(let s=0;s<t.n;s++){let o=0;for(let n=0;n<e.n;n++)o+=e.array[a][n]*t.array[n][s];i.push(o)}r.push(i)}return{array:r,m:e.m,n:t.n}},Cn=(e,t)=>{let r=[];for(let a=0;a<e.m;a++){let i=[];for(let s=0;s<t.n;s++){let o={real:0,imaginary:0};for(let n=0;n<e.n;n++)o.real+=e.array[a][n].real*t.array[n][s].real-e.array[a][n].imaginary*t.array[n][s].imaginary,o.imaginary+=e.array[a][n].real*t.array[n][s].imaginary+e.array[a][n].imaginary*t.array[n][s].real;i.push(o)}r.push(i)}return r},Hr=e=>{let t={real:0,imaginary:0},r=e.n;if(r==2){let i=ue(e.array[0][0],e.array[1][1]),s=ue(e.array[1][0],e.array[0][1]);return{real:i.real-s.real,imaginary:i.imaginary-s.imaginary}}let a=cn(e.n);for(let i=0;i<r;i++){let s=0;for(let l=1;l<r;l++){let h=0;for(let d=0;d<r;d++)d!=i&&(a.array[s][h]={...e.array[l][d]},h++);s++}a.m=a.n=r-1;let o=Math.pow(-1,i),n=ue({real:e.array[0][i].real*o,imaginary:e.array[0][i].imaginary*o},Hr(a));t.real+=n.real,t.imaginary+=n.imaginary}return t},kn=e=>{let t={real_values:!1,imaginary_values:!1,square:e.m===e.n,unit_diagonal:!0},r={m:e.m,n:e.n,array:[]},a={m:e.m,n:e.n,array:[]};for(let i=0;i<e.m;i++){let s=e.array[i],o=[],n=[];for(let l=0;l<e.n;l++)s[l].real&&(t.real_values=!0),s[l].imaginary&&(t.imaginary_values=!0),l===i&&t.unit_diagonal&&(s[l].real!==1||s[l].imaginary!==0)&&(t.unit_diagonal=!1),o.push(s[l].real),n.push(s[l].imaginary);r.array.push(o),a.array.push(n)}return{real:r,imaginary:a,flags:t}},Sn=e=>{let t=e.array.map(r=>r.slice(0));return{m:e.m,n:e.n,array:t}},Ta=e=>{if(e.m!==e.n)return;let t=Sn(e),r=t.array,a=0,i=0,s=0,o=0,n=e.m;for(i=1;i<n;i++)r[0][i]/=r[0][0];for(i=1;i<n;i++){for(s=i;s<n;s++){for(a=0,o=0;o<i;o++)a+=r[s][o]*r[o][i];r[s][i]-=a}if(i!=n-1)for(s=i+1;s<n;s++){for(a=0,o=0;o<i;o++)a+=r[i][o]*r[o][s];r[i][s]=(r[i][s]-a)/r[i][i]}}for(i=0;i<n;i++)for(s=i;s<n;s++){let l=1;if(i!=s)for(l=0,o=i;o<s;o++)l-=r[s][o]*r[o][i];r[s][i]=l/r[s][s]}for(i=0;i<n;i++)for(s=i;s<n;s++)if(i!=s){for(a=0,o=i;o<s;o++)a+=r[o][s]*(i==o?1:r[i][o]);r[i][s]=-a}for(i=0;i<n;i++)for(s=0;s<n;s++){for(a=0,o=i>s?i:s;o<n;o++)a+=(s==o?1:r[s][o])*r[o][i];r[s][i]=a}return t},Mn=e=>{let t=[];if(e.m!==e.n)return;let{real:r,imaginary:a,flags:i}=kn(e),s=Ta(r);if(!s)return;if(!i.imaginary_values){for(let c=0;c<e.m;c++){let u=[];for(let m=0;m<e.n;m++)u.push({real:s.array[c][m],imaginary:0});t.push(u)}return t}let o=Sr(s,a),n=Sr(a,o),l=xn(r,n),h=Ta(l);if(!h)return;let d=Sr(o,h);for(let c=0;c<e.m;c++){let u=[];for(let m=0;m<e.n;m++)u.push({real:h.array[c][m],imaginary:-d.array[c][m]});t.push(u)}return t},mt=(e,t)=>{let r={real:t.real,imaginary:-t.imaginary},a=ue(e,r),i=ue(t,r);return{real:a.real/i.real,imaginary:a.imaginary/i.real}},sa=e=>{let t=e.real||0,r=e.imaginary||0;return ue({real:Math.exp(t),imaginary:0},{real:Math.cos(r),imaginary:Math.sin(r)})},Yi=e=>{let t=ia(e);return{real:Math.log(t.r),imaginary:t.theta}},Ae=(e,t)=>{if(t.imaginary)return sa(ue(t,Yi(e)));{let r=ia(e);return un({r:Math.pow(r.r,t.real),theta:r.theta*t.real})}},Da=(e,t=0)=>e&&e.type===7?e:{type:7,value:{real:t,imaginary:0}},at=e=>e.imaginary?{type:7,value:e}:{type:3,value:e.real},it=(e,t)=>{if(e.type===6)return[0,0,e];if(t.type===6)return[0,0,t];let r=[0,0];switch(e.type){case 3:r[0]=e.value;break;case 4:r[0]=e.value?1:0;break;case 0:break;case 7:r[3]=e;break;default:return[0,0,F()]}switch(t.type){case 3:r[1]=t.value;break;case 4:r[1]=t.value?1:0;break;case 0:break;case 7:r[4]=t;break;default:return[0,0,F()]}return(r[3]||r[4])&&(r[3]=Da(r[3],r[0]),r[4]=Da(r[4],r[1])),r},An=(e,t)=>{let[r,a,i,s,o]=it(e,t);return i||(s&&o?at({real:s.value.real+o.value.real,imaginary:s.value.imaginary+o.value.imaginary}):{value:r+a,type:3})},es=(e,t)=>{let[r,a,i,s,o]=it(e,t);return i||(s&&o?at({real:s.value.real-o.value.real,imaginary:s.value.imaginary-o.value.imaginary}):{value:r-a,type:3})},Rn=(e,t)=>{let[r,a,i,s,o]=it(e,t);if(i)return i;if(s&&o)return at(Ae(s.value,o.value));let n=Math.pow(r,a);return isNaN(n)?F():{type:3,value:n}},zn=(e,t)=>{let[r,a,i,s,o]=it(e,t);if(i)return i;if(s&&o)return at(Ae(s.value,o.value));if(r<0&&a!==0&&Math.abs(a)<1)return at(Ae({real:r,imaginary:0},{real:a,imaginary:0}));let n=Math.pow(r,a);return isNaN(n)?F():{type:3,value:n}},Gr=Rn,Tn=(e,t)=>{let[r,a,i,s,o]=it(e,t);return i||(s&&o?at(ue(s.value,o.value)):{value:r*a,type:3})},Dn=(e,t)=>{let[r,a,i,s,o]=it(e,t);return i||(s&&o?o.value.real===0&&o.value.imaginary===0?Me():at(mt(s.value,o.value)):a===0?Me():{value:r/a,type:3})},Ln=(e,t)=>{let[r,a,i]=it(e,t);return i||(a===0?Me():{value:r%a,type:3})},$r=(e,t)=>e.type===6?e:t.type===6?t:e.type===0&&(t.value===""||t.value===0||t.type===7&&t.value.real===0&&t.value.imaginary===0)||t.type===0&&(e.value===""||e.value===0||e.type===7&&e.value.real===0&&e.value.imaginary===0)?{type:4,value:!0}:e.type===7?t.type===7?{type:4,value:e.value.imaginary===t.value.imaginary&&e.value.real===t.value.real}:{type:4,value:!e.value.imaginary&&e.value.real===t.value}:t.type===7?{type:4,value:!t.value.imaginary&&e.value===t.value.real}:e.type===2&&t.type===2?{type:4,value:e.value.toLowerCase()===t.value.toLowerCase()}:{type:4,value:e.value==t.value},La=(e,t)=>{let r=$r(e,t);return r.type===6?r:{type:4,value:!r.value}},En=(e,t)=>e.type===6?e:t.type===6?t:e.type===7||t.type===7?F():{type:4,value:(e.value||0)>(t.value||0)},oa=(e,t)=>!(e.type===7||e.type===8||e.type===9||e.type===5||t.type===7||t.type===8||t.type===9||t.type===5),Fn=(e,t)=>e.type===6?e:t.type===6?t:oa(e,t)?{type:4,value:(e.value||0)>=(t.value||0)}:F(),Nn=(e,t)=>e.type===6?e:t.type===6?t:oa(e,t)?{type:4,value:(e.value||0)<(t.value||0)}:F(),Pn=(e,t)=>e.type===6?e:t.type===6?t:oa(e,t)?{type:4,value:(e.value||0)<=(t.value||0)}:F(),Un=()=>{Gr=zn},In=e=>{switch(e){case"+":return An;case"-":return es;case"*":return Tn;case"/":return Dn;case"^":return Gr;case"**":return Gr;case"%":return Ln;case"=":return $r;case"==":return $r;case"!=":return La;case"<>":return La;case">":return En;case">=":return Fn;case"<":return Nn;case"<=":return Pn}},ct=e=>!Array.isArray(e)&&e.type===5&&!!e.value.type,ce=e=>e.type===5&&e.key==="metadata",ts=class{constructor(e,t,r){this.data_model=e,this.library=t,this.parser=r}context={address:{row:-1,column:-1},volatile:!1,bindings:[]};Calculate(e,t,r,a=!1){return a||(this.context.address=t,this.context.volatile=!1,this.context.area=r),{value:this.CalculateExpression(e),volatile:this.context.volatile}}CellFunction2(e){if(!e.sheet_id)if(e.sheet)e.sheet_id=this.data_model.sheets.ID(e.sheet)||0;else return()=>Z();let t=this.data_model.sheets.Find(e.sheet_id)?.cells;if(!t)return console.warn("missing cells reference @ "+e.sheet_id),()=>Z();let r=t.GetCell(e);return r?e.spill&&r.spill&&r.spill.start.row===e.row&&r.spill.start.column===e.column?()=>r.spill?t.GetRange4(r.spill.start,r.spill.end,!0)||Z():hn():()=>r.GetValue4():()=>({type:3,value:0})}CellFunction4(e,t){return e.sheet_id&&this.data_model.sheets.Find(e.sheet_id)?.cells?.GetRange4(e,t,!0)||Z()}GetMetadata(e,t){let r,a;switch(e.type){case"address":if(e.spill){let i;if(e.sheet_id&&(i=this.data_model.sheets.Find(e.sheet_id)),!i)return console.error("missing sheet [da6]"),Z();let s=i.CellData(e);s.spill&&(a=s.spill)}else r=e;break;case"range":a=e;break;case"structured-reference":{let i=this.data_model.ResolveStructuredReference(e,this.context.address);i&&(i.type==="address"?r=i:i.type==="range"&&(a=i))}break;case"identifier":{let i=this.data_model.GetName(e.name,this.context.address.sheet_id||0);i?.type==="range"&&(i.area.count===1?r=i.area.start:a=i.area)}break;case"call":{let i=this.CalculateExpression(e,!0);if(ct(i))if(i.value.type==="address")r=i.value;else if(i.value.type==="range")a=i.value;else return i;else return i}break;default:return this.CalculateExpression(e)}if(r){let i;if(r.sheet_id&&(i=this.data_model.sheets.Find(r.sheet_id)),!i)return console.error("missing sheet [ac8]"),Z();let s=i.CellData(r),o=s.calculated_type?s.calculated:s.value;return{type:5,value:{type:"metadata",address:{...r,position:0,id:0,type:"address",label:new k(r).spreadsheet_label},value:o,format:s.style?s.style.number_format:void 0,...t(s,r)},key:"metadata"}}else if(a){if(a.start.row===1/0||a.start.column===1/0)return Z();let i;if(a.start.sheet_id&&(i=this.data_model.sheets.Find(a.start.sheet_id)),!i)throw new Error("missing sheet [ac9]");let s=[];for(let o=a.start.column;o<=a.end.column;o++){let n=[];for(let l=a.start.row;l<=a.end.row;l++){let h=i.CellData({row:l,column:o});r={...a.start,row:l,column:o};let d=h.calculated_type?h.calculated:h.value,c={type:"metadata",address:r,value:d,format:h.style?h.style.number_format:void 0,...t(h,r)};n.push({type:5,value:c,key:"metadata"})}s.push(n)}return{type:8,value:s}}return this.CalculateExpression(e)}RewriteMacro(e,t){let r;switch(e.type){case"identifier":if(r=t[e.name.toUpperCase()],r)return JSON.parse(JSON.stringify(r));break;case"binary":e.left=this.RewriteMacro(e.left,t),e.right=this.RewriteMacro(e.right,t);break;case"unary":e.operand=this.RewriteMacro(e.operand,t);break;case"group":e.elements=e.elements.map(a=>this.RewriteMacro(a,t));break;case"call":e.args=e.args.map(a=>this.RewriteMacro(a,t));break}return e}CallMacro(e,t){if(!t.expression)return()=>_e();let r=JSON.stringify(t.expression),a={},i=t.argument_names?.map(s=>s.toUpperCase())||[];return s=>{let o=JSON.parse(r);for(let n=0;n<i.length;n++)a[i[n]]=s.args[n]||{type:"missing",id:0};return this.CalculateExpression(this.RewriteMacro(o,a))}}ImplicitCall(){return e=>{e.type==="call"&&(e={type:"implicit-call",args:e.args,call:{type:"identifier",name:e.name,position:e.position,id:0},position:e.position,id:0});let t=this.CalculateExpression(e.call);if(t.type===10){let r=t.value;if(!r.func||!r.bindings)return _e();let a={};for(let s=0;s<r.bindings.length;s++){let o=r.bindings[s];if(o?.type==="identifier")a[o.name.toUpperCase()]=e.args[s]||{type:"missing"};else return _e()}let i=JSON.parse(JSON.stringify(r.func));return this.parser.Walk2(i,s=>{if(s.type==="identifier"){let o=s.name.toUpperCase(),n=a[o];if(n)return JSON.parse(JSON.stringify(n))}return!0}),this.CalculateExpression(i)}return _e()}}NormalizeBindings(e){let t={};for(let[r,a]of Object.entries(e))t[r.toUpperCase()]=a;return t}CallExpression(e,t=!1){let r=this.library.Get(e.name);if(!r){let a=e.name.toUpperCase();return this.LookupBinding(a)?this.ImplicitCall():this.data_model.GetName(a,this.context.address.sheet_id||0)?this.ImplicitCall():()=>Or()}return a=>{this.context.volatile=this.context.volatile||!!r.volatile;let i=e.name.toLowerCase()==="if",s=-1,o,n=a.args,l=r.arguments||[],h;r.create_binding_context&&(h=r.create_binding_context.call(0,{args:a.args,descriptors:l}),h?(n=h.args,h.argument_descriptors&&(l=h.argument_descriptors),this.context.bindings.unshift(this.NormalizeBindings(h.context))):o=L());let d=n.map((u,m)=>{if(o)return;let f=l[Math.min(m,l.length-1)]||{};if(f.passthrough)return u;if(m===s)return f.boxed?{type:0}:void 0;if(typeof u>"u")return i&&m===0&&(s=1),f.boxed?{type:0}:void 0;if(f.address)return f.boxed?{type:2,value:this.parser.Render(u).replace(/\$/g,"")}:this.parser.Render(u).replace(/\$/g,"");if(f.metadata)return this.GetMetadata(u,()=>({}));{let p=this.CalculateExpression(u);if(p.type===6){if(f.allow_error)return p;o=p;return}if(i&&m===0&&p.type!==8){let b=!1;if(p.type===2){let w=p.value.toLowerCase().trim();b=w!=="false"&&w!=="f"}else b=!!p.value;s=b?2:1}return f.boxed?p:p.type===8?p.value.map(b=>b.map(w=>w.value)):p.value}});if(h&&this.context.bindings.shift(),o)return o;let c={address:{...this.context.address},area:this.context.area?{start:{...this.context.area.start},end:{...this.context.area.end}}:void 0};if(r.return_type==="reference"){let u=r.fn.apply(c,d);if(t)return u;if(ct(u)){if(u.value.type==="address")return this.CellFunction2(u.value)();if(u.value.type==="range")return this.CellFunction4(u.value.start,u.value.end)}return u}return r.fn.apply(c,d)}}ResolveStructuredReference(e){let t=this.data_model.ResolveStructuredReference(e,this.context.address);if(t){if(t.type==="address")return this.CellFunction2(t);if(t.type==="range")return()=>this.CellFunction4(t.start,t.end)}return()=>Z()}ResolveDimensionedQuantity(){return e=>({type:9,value:{value:this.CalculateExpression(e.expression).value,unit:e.unit.name}})}UnaryExpression(e,t=!1){switch(e.operator){case"+":return r=>this.CalculateExpression(r.operand);case"-":{let r=es,a={type:3,value:0};return i=>{let s=this.CalculateExpression(i.operand);return s.type===8?{type:8,value:s.value.map(o=>o.map(n=>r(a,n)))}:r(a,s)}}case"@":return r=>{let a;switch(r.operand.type){case"address":if(r.operand.spill){let s=this.CellFunction2(r.operand)();if(s.type===8){let o=this.context.address.row??-1,n=this.context.address.column??-1;if(o>=r.operand.row&&o<r.operand.row+s.value[0]?.length&&s.value.length===1){if(!t)return s.value[0][o-r.operand.row];a={...r.operand,row:o,spill:!1}}else if(n>=r.operand.column&&n<r.operand.column+s.value.length&&s.value[0]?.length===1){if(!t)return s.value[n-r.operand.column][0];a={...r.operand,column:n,spill:!1}}else return F()}}break;case"range":{let s=this.context.address.row??-1,o=this.context.address.column??-1;if(s>=r.operand.start.row&&s<=r.operand.end.row&&r.operand.start.column===r.operand.end.column)a={...r.operand.start,row:s,spill:!1};else if(o>=r.operand.start.column&&o<=r.operand.end.column&&r.operand.start.row===r.operand.end.row)a={...r.operand.start,column:o,spill:!1};else return F()}}if(a)return t?{type:5,value:a}:this.CellFunction2(a)();let i=this.CalculateExpression(r.operand);return i.type===8?i.value[0][0]:i};default:return()=>(console.warn("unexpected unary operator:",e.operator),_e())}}RecycleArray(e,t,r){if(e[0].length<r){let a=e[0].length;for(let i of e)for(let s=a;s<r;s++)i[s]=i[s%a]}if(e.length<t){let a=e.length;for(let i=a;i<t;i++)e[i]=e[i%a].slice(0)}return e}ElementwiseBinaryExpression(e,t,r){let a=Math.max(t.value.length,r.value.length),i=Math.max(t.value[0].length,r.value[0].length),s=this.RecycleArray(t.value,a,i),o=this.RecycleArray(r.value,a,i),n=[];for(let l=0;l<a;l++){let h=[];for(let d=0;d<i;d++)h[d]=e(s[l][d]||{type:0},o[l][d]||{type:0});n.push(h)}return{type:8,value:n}}AsReference(e){switch(e.type){case"address":return e;case"range":if(e.start.row===e.end.row&&e.start.column===e.end.column)return e.start;break;default:{let t=this.CalculateExpression(e,!0);if(ct(t)){if(t.value.type==="address")return t.value;if(t.value.type==="range"&&t.value.start.row===t.value.end.row&&t.value.start.column===t.value.end.column)return t.value.start}}break}}BinaryExpression(e){let t=e.operator==="&"?(r,a)=>{if(r.type===6)return r;if(a.type===6)return a;let i=[r,a].map(s=>s.type===0?"":s.type===4?s.value?this.data_model.language_model?.boolean_true||"TRUE":this.data_model.language_model?.boolean_false||"FALSE":s.value);return{type:2,value:`${i[0]}${i[1]}`}}:In(e.operator);return t?r=>{let a=this.CalculateExpression(r.left),i=this.CalculateExpression(r.right);return a.type===8?i.type===8?this.ElementwiseBinaryExpression(t,a,i):this.ElementwiseBinaryExpression(t,a,{type:8,value:[[i]]}):i.type===8?this.ElementwiseBinaryExpression(t,{type:8,value:[[a]]},i):t(a,i)}:e.operator===":"?r=>{let a=this.AsReference(r.left),i=this.AsReference(r.right);return a&&i?this.CellFunction4(a,i):_e()}:()=>(console.info(`(unexpected binary operator: ${e.operator})`),_e())}Identifier(e){let t=e.name;if(t[0]==="#")return()=>Z();let r=t.toUpperCase();switch(r){case"FALSE":case"F":return()=>({value:!1,type:4});case"TRUE":case"T":return()=>({value:!0,type:4});case"UNDEFINED":return()=>({value:void 0,type:0})}return()=>{let a=this.LookupBinding(r);if(a)return this.CalculateExpression(a);let i=this.data_model.GetName(r,this.context.address.sheet_id||0);switch(i?.type){case"range":return i.area.count===1?this.CellFunction4(i.area.start,i.area.start):this.CellFunction4(i.area.start,i.area.end);case"expression":return this.CalculateExpression(i.expression)}return Or()}}LookupBinding(e){e=e.toUpperCase();for(let t of this.context.bindings){let r=t[e];if(r)return r}}GroupExpression(e){return!e.elements||e.elements.length!==1?(console.warn("Can't handle group !== 1"),()=>_e()):t=>this.CalculateExpression(t.elements[0])}CalculateExpression(e,t=!1){if(e.fn)return e.fn(e);switch(e.type){case"implicit-call":return(e.fn=this.ImplicitCall())(e);case"call":{let r=this.data_model.macro_functions.get(e.name.toUpperCase());return r?(e.fn=this.CallMacro(e,r))(e):(e.fn=this.CallExpression(e,t))(e)}case"address":return(e.fn=this.CellFunction2(e))();case"range":return(e.fn=r=>this.CellFunction4(r.start,r.end))(e);case"binary":return(e.fn=this.BinaryExpression(e))(e);case"unary":return(e.fn=this.UnaryExpression(e,t))(e);case"identifier":return(e.fn=this.Identifier(e))();case"missing":return(e.fn=()=>({value:void 0,type:0}))();case"dimensioned":return(e.fn=this.ResolveDimensionedQuantity())(e);case"literal":{let r={value:e.value,type:qe(e.value)};return(e.fn=()=>r)()}case"group":return(e.fn=this.GroupExpression(e))(e);case"complex":{let r={value:{real:e.real,imaginary:e.imaginary},type:7};return(e.fn=()=>r)()}case"structured-reference":return(e.fn=this.ResolveStructuredReference(e))();case"array":return(e.fn=()=>({type:8,value:e.values.map(r=>(Array.isArray(r)?r:[r]).map(a=>({type:qe(a),value:a})))}))();default:return console.warn("Unhandled parse expr:",e),Ji()}}},Dt=e=>{let t=[],r=e.length,a=e[0].length;for(let i=0;i<a;i++){t[i]=[];for(let s=0;s<r;s++)t[i][s]=e[s][i]}return t},na=e=>{if(!e)return[];if(typeof e[0]>"u")return[];let t=[],r=e.length,a=e[0].length;for(let i=0;i<a;i++){t[i]=[];for(let s=0;s<r;s++)t[i][s]=e[s][i]}return t},he=e=>{let t=[];for(let r of e)if(r?.type===8)for(let a of r.value)t=t.concat(he(a));else t.push(r);return t},j=(e,t=!1)=>Array.isArray(e)?e.reduce((r,a)=>typeof a>"u"&&!t?r:Array.isArray(a)?r.concat(j(a,t)):a instanceof Float32Array||a instanceof Float64Array?r.concat(Array.from(a)):r.concat([a]),[]):[e],re=e=>j(e).filter(t=>typeof t=="number"),Ea=(e,t=!1)=>t?e.map(r=>{switch(typeof r){case"number":case"undefined":case"string":case"boolean":return r}}):e.filter(r=>{switch(typeof r){case"number":case"undefined":case"string":case"boolean":return!0}return!1}),Vn=e=>!!e&&typeof e=="object"&&e.type===8,On=(e,t)=>(...r)=>{let a=[],i=[];for(let[s,o]of r.entries())if(o&&e[s]){let n=Array.isArray(o)?o:Vn(o)?o.value:void 0;n&&(a[s]=n,i.length||(i=n))}return a.length?{type:8,value:i.map((s,o)=>s.map((n,l)=>{let h=r.map((d,c)=>a[c]?a[c][o][l]??{type:0}:d);return t(...h)}))}:t(...r)},Br=e=>{let t=[],r=e.length,a="[\\^$.|?*+()";for(let i=0;i<r;i++){let s=e[i];switch(s){case"*":t.push(".","*");break;case"?":t.push(".");break;case"~":s=e[++i]||"";default:for(let o=0;o<a.length;o++)if(s===a[o]){t.push("\\");break}t.push(s);break}}return t.join("")},Hn=e=>({type:2,value:e}),Gn=class{functions={};Register(...e){for(let t of e)for(let r of Object.keys(t)){if(/[^a-zA-Z0-9._]/.test(r))throw new Error("invalid function name (invalid character)");if(r.length>255)throw new Error("invalid function name (too long, > 255)");if(/^[^a-zA-Z]/.test(r))throw new Error("invalid function name (start with an ascii letter)");let a=r.toLowerCase();if(this.functions[a])throw new Error(`function name (${a}) is already in use`);let i=t[r];if(i.canonical_name=r,!i.unrolled){let s=i.arguments?.map(o=>!!o.unroll);s?.some(o=>!!o)&&(i.fn=On(s,i.fn),i.unrolled=!0)}this.functions[a]=i}}Get(e){let t=e.toLowerCase();return this.functions[t]}List(e=!0){let t={};for(let r of Object.keys(this.functions))e&&this.functions[r].visibility==="internal"||(t[r]=this.functions[r]);return t}Alias(e,t){let r=this.Get(t);if(!r)throw new Error(`referenced function ${t} does not exist`);this.Register({[e]:{...r}})}},Fa=class{static default_color="#888";static UnpackValues(e){if(Array.isArray(e)){let t=e[0];return Array.isArray(t)||t instanceof Float64Array||t instanceof Float32Array?e.reduce((r,a)=>r.concat(this.UnpackValues(a)),[]):e.map(r=>isNaN(r)?void 0:r)}else{if(e instanceof Float32Array||e instanceof Float64Array)return Array.prototype.slice.call(e);if(e&&typeof e=="object"){let t=Object.keys(e).length;if(typeof e[0]<"u"&&typeof e[(t-1).toString()]<"u"){let r=[];for(let a=0;a<t;a++)r[a]=e[a.toString()];return r}}}return[]}static SparklineCommon(e,t){let r=[],a=oe(t.text)?t.text.text:this.default_color,i=[a,a];return Array.isArray(e.calculated)&&(r=this.UnpackValues(e.calculated[0]),typeof e.calculated[1]=="string"&&(i[0]=e.calculated[1]),typeof e.calculated[2]=="string"&&(i[1]=e.calculated[2])),{values:r,colors:i}}static RenderLine(e,t,r,a,i){let{values:s,colors:o}=this.SparklineCommon(a,i),n=.05,l=.1,h=1;Array.isArray(a.calculated)&&typeof a.calculated[2]=="number"&&(h=a.calculated[2]);let d=0,c=0,u=-1;for(let m=0;m<s.length;m++){let f=s[m];typeof f=="number"&&(u>=0?(d=Math.min(d,f),c=Math.max(c,f)):(u=m,d=c=f))}if(d===c&&(d&&(d-=1),c+=1),d!==c){let m=e*(1-2*n)/(s.length-1),f=c-d,p=t*(1-2*l),b=t*l;r.strokeStyle=o[0],r.lineWidth=h,r.lineCap="round",r.lineJoin="round",r.beginPath();let w=0;for(let y=u;y<s.length;y++){let g=s[y];if(typeof g=="number"){let v=e*n+m*y,x=t-(g-d)*p/f-b;w===0?(r.moveTo(v,x),w=1):r.lineTo(v,x)}else w=0}r.stroke()}}static RenderColumn(e,t,r,a,i){let{values:s,colors:o}=this.SparklineCommon(a,i),n=3,l=2.5,h=0,d=0,c=!1;for(let u of s)typeof u=="number"&&(c?(h=Math.min(h,u),d=Math.max(d,u)):(c=!0,h=d=u));if(h===d&&(h&&(h-=1),d+=1),s.length){let u=(e-2*n-2)/(s.length-0),m=t-2*l,f=l;if(h!==d)if(h<0&&d>0){let p=d-h,b=f+d/p*m;for(let w=0;w<s.length;w++){let y=s[w];if(typeof y=="number"){let g=n+w*u,v=Math.abs(y)/p*m;if(y>=0){r.fillStyle=o[0];let x=b-v;r.fillRect(g+2,x,u-2,v)}else{r.fillStyle=o[1];let x=b;r.fillRect(g+2,x,u-2,v)}}}}else if(d>0){r.fillStyle=o[0];let p=d-h;for(let b=0;b<s.length;b++){let w=s[b];if(typeof w=="number"){let y=n+b*u,g=Math.max(1,(w-h)/p*m),v=t-f-g;r.fillRect(y+2,v,u-2,g)}}}else{r.fillStyle=o[1];let p=d-h;for(let b=0;b<s.length;b++){let w=s[b];if(typeof w=="number"){let y=n+b*u,g=Math.max(1,Math.abs(d-w)/p*m),v=f;r.fillRect(y+2,v,u-2,g)}}}}}},$n=e=>{let{x:t,y:r,width:a,height:i,cell:s}=e,o={},n=3,l=Math.round(16*(e.scale||1));if(s&&a&&i&&t&&r){let h={x:n,y:i-n-l};if(s.style){switch(s.style.vertical_align){case"top":h.y=n;break;case"middle":h.y=Math.round((i-l)/2);break}switch(s.style.horizontal_align){case"right":h.x=Math.round(a-n-l);break;case"center":h.x=Math.round((a-l)/2);break}}t>=h.x&&t<=h.x+l&&r>=h.y&&r<=h.y+l&&(o.value=`=Checkbox(${s.calculated?"FALSE":"TRUE"})`,o.block_selection=!0)}return o},Bn=e=>{let{context:t,width:r,height:a,cell:i}=e,s=e.scale||1;t.lineJoin="round",t.lineCap="round";let o=3*s,n=16*s,l=o,h=a-o-n;if(i.style){switch(i.style.vertical_align){case"top":h=o;break;case"middle":h=(a-n)/2;break}switch(i.style.horizontal_align){case"right":l=r-o-n;break;case"center":l=(r-n)/2;break}}l=Math.floor(l)+.5,h=Math.floor(h)+.5;let d=Math.floor(l+n)+.5,c=Math.floor(h+n)+.5;if(i&&i.calculated){t.lineWidth=.5,t.fillStyle=t.strokeStyle,t.beginPath(),t.moveTo(l,h),t.lineTo(l+16*s,h),t.lineTo(l+16*s,h+16*s),t.lineTo(l,h+16*s),t.closePath(),t.moveTo(l+15*s,h+4*s);for(let u of[[13.59,2.58],[6,10.17],[2.41,6.59],[1,8],[6,13]])t.lineTo(l+u[0]*s,h+u[1]*s);t.closePath(),t.fill()}else t.lineWidth=1,t.lineJoin="round",t.beginPath(),t.moveTo(l,h),t.lineTo(d,h),t.lineTo(d,c),t.lineTo(l,c),t.closePath(),t.stroke();return{handled:!0}},ft=e=>{switch(e.type){case 7:return e.value;case 3:return{real:e.value,imaginary:0};case 4:return{real:e.value?1:0,imaginary:0};case 0:return{real:0,imaginary:0}}return!1},qn=(e,t,r)=>{let a=new Date;return a.setMilliseconds(0),a.setSeconds(0),a.setMinutes(0),a.setHours(0),e<0||e>1e4||(e<1899&&(e+=1900),a.setFullYear(e),t<1||t>12)||(a.setMonth(t-1),r<1||r>31)?!1:(a.setDate(r),Qe(a.getTime()))},Na=(e,t)=>{let r=new Date(et(e)),a=r.getUTCMonth()+t,i=r.getUTCFullYear();for(r.setUTCHours(12),r.setUTCMinutes(0),r.setUTCSeconds(0),r.setUTCMilliseconds(0);a<0;)a+=12,i--;for(;a>11;)a-=12,i++;if(r.setUTCMonth(a),r.setUTCFullYear(i),r.getUTCMonth()!==a){let s=r.getUTCDate();r=new Date(r.getTime()-s*86400*1e3)}return r},Pa=[{name:"Lookup value"},{name:"Table"},{name:"Result index"},{name:"Inexact",default:!0}],Ua=(e,t,r,a=!0,i=!1)=>{if(i&&(t=na(t)),r=Math.max(0,r-1),a){let s=t[r][0];if(typeof e=="number"){let o=Number(t[0][0]);if(isNaN(o)||o>e)return Pe();for(let n=1;n<t[0].length&&(o=Number(t[0][n]),!(isNaN(o)||o>e));n++)s=t[r][n]}else{e=(e||"").toString().toLowerCase();let o=(t[0][0]||"").toString().toLowerCase();if(o.localeCompare(e)>0)return Pe();for(let n=1;n<t[0].length&&(o=(t[0][n]||"").toString().toLowerCase(),!(o.localeCompare(e)>0));n++)s=t[r][n]}return Y(s)}else{for(let s=0;s<t[0].length;s++)if(t[0][s]==e)return Y(t[r][s]);return Pe()}},Gt=(e,t=!1)=>{if(!e)return t;switch(e.type){case 3:return e.value;case 0:return t}return!1},De=(e,t,r)=>({description:r,arguments:[{name:"number",boxed:!0,unroll:!0}],fn:a=>a.type===3?{type:3,value:e(a.value)}:a.type===7?{type:7,value:t(a.value)}:L()}),Ia={Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:e=>{if(e.type===7){let t=Ae(e.value,{real:.5,imaginary:0});return ve(t)}else{if(e.type===0||!e.value)return{type:3,value:0};if(e.type===3&&e.value<0)return{type:7,value:Ae({real:e.value,imaginary:0},{real:.5,imaginary:0})};if(e.type===3){let t=Math.sqrt(e.value);return isNaN(t)?F():{type:3,value:t}}else return F()}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(e,t)=>{if(e.type===3&&t.type===3&&(e.value>=0||t.value===0||Math.abs(t.value)>=1)){let i=Math.pow(e.value,t.value);return isNaN(i)?F():{type:3,value:i}}let r=ft(e),a=ft(t);if(r&&a){let i=Ae(r,a);return ve(i)}return F()}}},Lt={True:{fn:()=>({type:4,value:!0})},False:{fn:()=>({type:4,value:!1})},Int:{fn:e=>({type:3,value:Math.floor(e)})},Rand:{volatile:!0,fn:()=>({type:3,value:Math.random()})},RandArray:{volatile:!0,arguments:[{name:"rows"},{name:"columns"},{name:"min"},{name:"max"},{name:"integer"}],description:"Returns an array of uniformly-distributed random numbers",fn:(e=1,t=1,r=0,a=1,i=!1)=>{let s=[];if(i){let o=a-r+1;for(let n=0;n<e;n++){let l=[];for(let h=0;h<t;h++)l.push({type:3,value:Math.floor(Math.random()*o+r)});s.push(l)}}else{let o=a-r;for(let n=0;n<e;n++){let l=[];for(let h=0;h<t;h++)l.push({type:3,value:Math.random()*o+r});s.push(l)}}return{type:8,value:s}}},RandBetween:{arguments:[{name:"min"},{name:"max"}],volatile:!0,fn:(e=0,t=1)=>{if(e>t){let r=e;e=t,t=r}return{type:3,value:Math.floor(Math.random()*(t+1-e)+e)}}},Sum:{description:"Adds arguments and ranges",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...e)=>{let t={real:0,imaginary:0},r=he(e);for(let a of r)switch(a.type){case 3:t.real+=a.value;break;case 4:break;case 7:t.real+=a.value.real,t.imaginary+=a.value.imaginary;break;case 6:return a}return ve(t)}},SumSQ:{description:"Returns the sum of the squares of all arguments",arguments:[{boxed:!0,name:"values or ranges",repeat:!0}],fn:(...e)=>{let t={real:0,imaginary:0},r=he(e);for(let a of r)switch(a.type){case 3:t.real+=a.value*a.value;break;case 4:break;case 7:{let i=ue(a.value,a.value);t.real+=i.real,t.imaginary+=i.imaginary}break;case 6:return a}return ve(t)}},EDate:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(e,t=0)=>{if(typeof e!="number"||typeof t!="number")return L();let r=Na(e,t);return{type:3,value:Qe(r.getTime(),!1)}}},EOMonth:{arguments:[{name:"Start date",unroll:!0},{name:"Months",unroll:!0}],fn:(e,t=0)=>{if(typeof e!="number"||typeof t!="number")return L();let r=Na(e,t);switch(r.getUTCMonth()){case 1:{let a=r.getUTCFullYear();a%4===0&&(a===1900||a%400===0||a%100!==0)?r.setUTCDate(29):r.setUTCDate(28)}break;case 0:case 2:case 4:case 6:case 7:case 9:case 11:r.setUTCDate(31);break;default:r.setUTCDate(30);break}return{type:3,value:Qe(r.getTime(),!1)}}},Now:{description:"Returns current time",volatile:!0,fn:()=>({type:3,value:Qe(new Date().getTime())})},YearFrac:{description:"Returns the fraction of a year between two dates",arguments:[{name:"Start"},{name:"End"},{name:"Basis",default:0}],fn:(e,t,r)=>{if(t<e){let s=e;e=t,t=s}let a=Math.max(0,t-e),i=360;if(r&&r<0||r>4)return L();switch(r){case 1:break;case 2:break;case 3:i=365;break}return{type:3,value:a/i}}},Date:{description:"Constructs a date from year/month/day",arguments:[{name:"year",unroll:!0},{name:"month",unroll:!0},{name:"day",unroll:!0}],fn:(e,t,r)=>{let a=qn(e,t,r);return a===!1?L():{type:3,value:a}}},Today:{description:"Returns current day",volatile:!0,fn:()=>{let e=new Date;return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(12),{type:3,value:Qe(e.getTime())}}},IfError:{description:"Returns the original value, or the alternate value if the original value contains an error",arguments:[{name:"original value",allow_error:!0,boxed:!0},{name:"alternate value"}],fn:(e,t=0)=>e&&e.type===6?{value:t,type:qe(t)}:e},IsNA:{description:"Checks if another cell contains a #NA error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...e)=>{let t=he(e);for(let r of t)if(r.type===6&&r.value==="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsErr:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...e)=>{let t=he(e);for(let r of t)if(r.type===6&&r.value!=="N/A")return{type:4,value:!0};return{type:4,value:!1}}},IsError:{description:"Checks if another cell contains an error",arguments:[{name:"reference",allow_error:!0,boxed:!0}],fn:(...e)=>{let t=he(e);for(let r of t)if(r.type===6)return{type:4,value:!0};return{type:4,value:!1}}},Year:{description:"Returns year from date",arguments:[{name:"date",unroll:!0}],fn:e=>Y(new Date(et(e)).getUTCFullYear())},Month:{description:"Returns month from date",arguments:[{name:"date",unroll:!0}],fn:e=>Y(new Date(et(e)).getUTCMonth()+1)},Day:{description:"Returns day of month from date",arguments:[{name:"date",unroll:!0}],fn:e=>Y(new Date(et(e)).getUTCDate())},Radians:{description:"Converts degrees to radians",arguments:[{name:"Degrees",description:"Angle in degrees",unroll:!0}],fn:e=>Y(e*Math.PI/180)},Degrees:{description:"Converts radians to degrees",arguments:[{name:"Radians",description:"Angle in radians",unroll:!0}],fn:e=>Y(e/Math.PI*180)},CountA:{description:"Counts cells that are not empty",fn:(...e)=>Y(j(e).reduce((t,r)=>typeof r>"u"?t:t+1,0))},Count:{description:"Counts cells that contain numbers",fn:(...e)=>Y(j(e).reduce((t,r)=>typeof r=="number"||Ne(r)?t+1:t,0))},Or:{fn:(...e)=>{let t=!1;e=j(e);for(let r of e)t=t||!!r;return Y(t)}},And:{fn:(...e)=>{let t=!0;e=j(e);for(let r of e)t=t&&!!r;return Y(t)}},Not:{arguments:[{unroll:!0,boxed:!0}],fn:e=>{let t=!1;if(e)switch(e.type){case 0:t=!1;break;case 2:case 4:case 3:t=!!e.value;break;case 6:return e}return Y(!t)}},If:{arguments:[{name:"test value",boxed:!0},{name:"value if true",boxed:!0,allow_error:!0},{name:"value if false",boxed:!0,allow_error:!0}],fn:(e,t={type:4,value:!0},r={type:4,value:!1})=>{let a=t.type===8,i=r.type===8;return e.type===8?{type:8,value:e.value.map((s,o)=>s.map((n,l)=>(n.type===2?n.value.toLowerCase()!=="false"&&n.value.toLowerCase()!=="f":n.value)?a?t.value[o][l]:t:i?r.value[o][l]:r))}:(e.type===2?e.value.toLowerCase()!=="false"&&e.value.toLowerCase()!=="f":e.value)?t:r}},Fact:{description:"Returns the factorial of a number",arguments:[{name:"number",unroll:!0}],fn:e=>{e=Math.round(e);let t=1;for(;e>1;)t*=e,e--;return{type:3,value:t}}},Power:{description:"Returns base raised to the given power",arguments:[{name:"base",boxed:!0,unroll:!0},{name:"exponent",boxed:!0,unroll:!0}],fn:(e,t)=>{let r=ft(e),a=ft(t);if(!r||!a)return F();if(e.type===7||t.type===7)return ve(Ae(r,a));{let i=Math.pow(r.real,a.real);return isNaN(i)?F():{type:3,value:i}}}},Mod:{arguments:[{unroll:!0},{unroll:!0}],fn:(e,t)=>t?Y(e%t):Me()},Large:{description:"Returns the nth numeric value from the data, in descending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(e,t)=>{if(t<=0)return L();let r=re(e);return r.sort((a,i)=>i-a),t<=r.length?{type:3,value:r[t-1]}:L()}},Small:{description:"Returns the nth numeric value from the data, in ascending order",arguments:[{name:"values"},{name:"index",unroll:!0}],fn:(e,t)=>{if(t<=0)return L();let r=re(e);return r.sort((a,i)=>a-i),t<=r.length?{type:3,value:r[t-1]}:L()}},Filter:{description:"Filter an array using a second array.",arguments:[{name:"source",description:"Source array"},{name:"filter",description:"Filter array"}],fn:(e,t)=>{if(typeof e>"u"||typeof t>"u")return L();Array.isArray(e)||(e=[[e]]),Array.isArray(t)||(t=[[t]]);let r=e.length,a=e[0].length,i=t.length,s=t[0].length;if(a===s){let o=[];for(let n=0;n<r;n++)o.push([]);for(let[n,l]of t[0].entries())if(l)for(let h=0;h<r;h++)o[h].push(Y(e[h][n]));return{type:8,value:o}}else if(r===i){let o=[];for(let[n,[l]]of t.entries())l&&o.push(e[n].map(h=>Y(h)));return{type:8,value:o}}return L()}},Sort:{arguments:[{name:"values"}],fn:(...e)=>(e=j(e),e.every(t=>typeof t=="number")?e.sort((t,r)=>t-r):e.sort(),{type:8,value:[e.map(t=>Y(t))]})},Transpose:{description:"Returns transpose of input matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>e.type===8?{type:8,value:Dt(e.value)}:e},Max:{fn:(...e)=>({type:3,value:Math.max.apply(0,re(e))})},Min:{fn:(...e)=>({type:3,value:Math.min.apply(0,re(e))})},SumProduct:{description:"Returns the sum of pairwise products of two or more ranges",fn:(...e)=>{let t=e.map(i=>j(i)),r=Math.max.apply(0,t.map(i=>i.length)),a=0;for(let i=0;i<r;i++)a+=t.reduce((s,o)=>{let n=o[i];return n===!0&&(n=1),typeof n=="number"?s*n:0},1);return{type:3,value:a}}},Row:{arguments:[{name:"reference",metadata:!0}],fn:function(e){if(!e)if(this?.area){let t=[];for(let r=this.area.start.column;r<=this.area.end.column;r++){let a=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)a.push({type:3,value:i+1});t.push(a)}return{type:8,value:t}}else return{type:3,value:this?this.address.row+1:-1};if(e.type===8){let t=e.value,r=t[0][0];if(ce(r))return{type:8,value:[t[0].map((a,i)=>({type:3,value:i+r.value.address.row+1}))]}}else if(ce(e))return{type:3,value:e.value.address.row+1};return L()}},Column:{arguments:[{name:"reference",metadata:!0}],fn:function(e){if(!e)if(this?.area){let t=[];for(let r=this.area.start.column;r<=this.area.end.column;r++){let a=[];for(let i=this.area.start.row;i<=this.area.end.row;i++)a.push({type:3,value:r+1});t.push(a)}return{type:8,value:t}}else return{type:3,value:this?this.address.column+1:-1};if(e.type===8){let t=e.value,r=t[0][0];if(ce(r))return{type:8,value:t.map((a,i)=>[{type:3,value:i+r.value.address.column+1}])}}else if(ce(e))return{type:3,value:e.value.address.row+1};return L()}},Choose:{arguments:[{name:"Selected index"},{name:"Choice 1...",metadata:!0}],return_type:"reference",description:"Returns one of a list of choices",fn:(e,...t)=>{if(e<1||e>t.length)return F();let r=t[e-1];if(ce(r))return{type:5,value:r.value.address};if(r.type===8){let a=r.value,i=a.length,s=a[0].length,o=a[0][0],n=a[i-1][s-1];if(i===1&&s===1){if(ce(o))return{type:5,value:o.value.address}}else if(ce(o)&&ce(n))return{type:5,value:{type:"range",position:0,id:0,label:"",start:o.value.address,end:n.value.address}}}return{...r}}},XLOOKUP:{arguments:[{name:"Lookup value"},{name:"Lookup array"},{name:"Return array",metadata:!0},{name:"Not found",boxed:!0},{name:"Match mode",default:0},{name:"Search mode",default:1}],return_type:"reference",xlfn:!0,fn:(e,t,r,a,i=0,s=1)=>{if(!r)return L();let o;if(r.type===8){let d=r.value,c=d.length,u=d[0].length,m=d[0][0],f=d[c-1][u-1];ce(m)&&ce(f)&&(o=new k(m.value.address,f.value.address))}if(!o)return console.info("invalid range"),Z();if(!Array.isArray(t))return console.info("lookup is not an array"),F();let n=t[0];if(!Array.isArray(n))return console.info("lookup is not a 2d array"),F();if(t.length!==1&&n.length!==1)return console.info("lookup array has invalid dimensions"),F();let l=t.length===1;l&&(t=na(t)),s<0&&t.reverse();let h=(d,c)=>{let u,m;return l?(s<0&&(c=d.rows-1-c),c>=0&&c<d.rows&&(u={type:"address",position:0,id:1,label:"",row:d.start.row+c,column:d.start.column,sheet_id:d.start.sheet_id},m={type:"address",position:0,id:2,label:"",row:d.start.row+c,column:d.end.column,sheet_id:d.start.sheet_id})):(s<0&&(c=d.columns-1-c),c>=0&&c<d.columns&&(u={type:"address",position:0,id:1,label:"",row:d.start.row,column:d.start.column+c,sheet_id:d.start.sheet_id},m={type:"address",position:0,id:2,label:"",row:d.end.row,column:d.start.column+c,sheet_id:d.start.sheet_id})),u&&m?{type:5,value:{type:"range",position:0,id:0,label:"",start:u,end:m}}:{type:0}};if(i===2&&typeof e!="string"&&(i=0),(i===1||i===-1)&&typeof e=="number"){let d=0,c=-1;for(let u=0;u<t.length;u++){let m=t[u][0];if(typeof m=="number"){if(m===e)return h(o,u);let f=Math.abs(m-e);(i===1&&m>e||i===-1&&m<e)&&(c<0||f<d)&&(d=f,c=u)}}if(c>=0)return h(o,c)}switch(i){case 2:{let d=Br(e?.toString()||""),c=new RegExp("^"+d+"$","i");for(let u=0;u<t.length;u++){let m=t[u][0];if(typeof m=="string"&&c.exec(m))return h(o,u)}}break;case 0:typeof e=="string"&&(e=e.toLowerCase());for(let d=0;d<t.length;d++){let c=t[d][0];if(typeof c=="string"&&(c=c.toLowerCase()),c===e)return h(o,d)}break}return a&&a.type!==0?a:Pe()}},HLookup:{arguments:[...Pa],fn:(e,t,r,a=!0)=>Ua(e,t,r,a,!0)},VLookup:{arguments:[...Pa],fn:(e,t,r,a=!0)=>Ua(e,t,r,a,!1)},Product:{arguments:[{boxed:!0}],fn:(...e)=>{let t={real:1,imaginary:0};e=he(e);for(let r of e)r.type===7?t=ue(t,r.value):r.type===3&&(t.real*=r.value,t.imaginary*=r.value);return ve(t)}},Log:{arguments:[{name:"number",unroll:!0},{name:"base",unroll:!0}],fn:(e,t=10)=>({type:3,value:Math.log(e)/Math.log(t)})},Log10:{arguments:[{name:"number",unroll:!0}],fn:e=>({type:3,value:Math.log(e)/Math.log(10)})},Ln:{arguments:[{name:"number",unroll:!0}],fn:e=>({type:3,value:Math.log(e)})},"Ceiling.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(e,t=1,r)=>{let a=0;return r&&e<0?a=-Math.ceil(-e/t)*t:a=Math.ceil(e/t)*t,{type:3,value:a}}},"Floor.Math":{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0},{name:"away from zero",unroll:!0}],fn:(e,t=1,r)=>{let a=0;return r&&e<0?a=-Math.floor(-e/t)*t:a=Math.floor(e/t)*t,{type:3,value:a}}},Floor:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(e,t=1)=>({type:3,value:Math.floor(e/t)*t})},Ceiling:{arguments:[{name:"number",unroll:!0},{name:"significance",unroll:!0}],fn:(e,t=1)=>({type:3,value:Math.ceil(e/t)*t})},Round:{arguments:[{unroll:!0},{unroll:!0}],fn:(e,t=0)=>{let r=Math.pow(10,t);return{type:3,value:Math.round(r*e)/r}}},RoundDown:{arguments:[{unroll:!0},{unroll:!0}],fn:(e,t=0)=>{let r=Math.pow(10,t);return{type:3,value:e>=0?Math.floor(r*e)/r:Math.ceil(r*e)/r}}},RoundUp:{arguments:[{unroll:!0},{unroll:!0}],fn:(e,t=0)=>{let r=Math.pow(10,t);return{type:3,value:e>=0?Math.ceil(r*e)/r:Math.floor(r*e)/r}}},Reverse:{arguments:[{boxed:!0}],fn:e=>e.type===8?(e.value.length===1?e.value[0].reverse():e.value.reverse(),e):{type:2,value:(e.value??"").toString().split("").reverse().join("")}},Exp:{arguments:[{boxed:!0,unroll:!0}],fn:e=>{if(e.type===7){let t=sa(e.value);return ve(t)}return e.type!==3?F():{type:3,value:Math.exp(e.value)}}},Abs:{arguments:[{boxed:!0,unroll:!0}],fn:e=>e.type===7?{type:3,value:Math.sqrt(e.value.real*e.value.real+e.value.imaginary*e.value.imaginary)}:e.type!==3?F():{type:3,value:Math.abs(e.value||0)}},Simplify:{arguments:[{name:"value",unroll:!0},{name:"significant digits",unroll:!0}],fn:(e,t=2)=>{if(t=t||2,e===0)return{type:3,value:e};let r=e<0?-1:1;e*=r;let a=Math.pow(10,Math.floor(Math.log10(e))+1-t);return{type:3,value:Math.round(e/a)*a*r}}},Sqrt:{description:"Returns the square root of the argument",arguments:[{boxed:!0,unroll:!0}],fn:e=>{if(e.type===7){let t=Ae(e.value,{real:.5,imaginary:0});return ve(t)}else{if(e.type===0||!e.value)return{type:3,value:0};if(e.type===3)return{type:3,value:Math.sqrt(e.value)}}return F()}},HexToDec:{arguments:[{description:"hexadecimal string",unroll:!0}],fn:e=>({type:3,value:parseInt(e,16)})},DecToHex:{arguments:[{description:"number",unroll:!0}],fn:e=>({type:2,value:e.toString(16)})},Checkbox:{arguments:[{name:"checked"}],click:$n,render:Bn,fn:e=>({value:!!e,type:4})},"Sparkline.Column":{arguments:[{name:"data"},{name:"color"},{name:"negative color"}],render:e=>(Fa.RenderColumn(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:5,value:e,key:"sparkline-data"})},"Sparkline.Line":{arguments:[{name:"data"},{name:"color"},{name:"line width"}],render:e=>(Fa.RenderLine(e.width,e.height,e.context,e.cell,e.style),{handled:!0}),fn:(...e)=>({type:5,value:e,key:"sparkline-data"})},UniqueValues:{arguments:[{name:"range",boxed:!0}],visibility:"internal",fn:e=>{if(e.type===8){let t=s=>{if(s)switch(s.type){case 2:case 3:case 4:return s.value;case 0:return"";default:return console.info("check",s,s.value),s.value?.toString()||""}else return""},r=new Set,a=new Set;for(let s of e.value)for(let o of s){let n=t(o);r.has(n)?a.add(n):r.add(n)}let i=[];for(let s of e.value){let o=[];for(let n of s){let l=t(n);o.push({type:4,value:!a.has(l)})}i.push(o)}return{type:8,value:i}}return{type:4,value:!0}}},Between:{arguments:[{name:"target",boxed:!0,unroll:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(e,t=0,r=1)=>({type:4,value:e.type===3&&e.value>=t&&e.value<=r})},Gradient:{arguments:[{name:"range",boxed:!0},{name:"min"},{name:"max"}],visibility:"internal",fn:(e,t,r)=>{let a=he([e]),i=0,s=0,o=0;for(let d of a){if(d.type===6)return d;d.type===3&&(i===0?(s=d.value,o=d.value):(s=Math.min(s,d.value),o=Math.max(o,d.value)),i++)}typeof r=="number"&&(o=r),typeof t=="number"&&(s=t);let n=o-s,l=1,h=1;if(e.type===8){l=e.value.length,h=e.value[0]?.length||0;let d=[];for(let c=0;c<l;c++){let u=[];for(let m=0;m<h;m++){let f=e.value[c][m];if(f.type===3){let p=0;o===s?f.value>o?p=1:f.value<o?p=0:p=.5:n>0&&(p=(f.value-s)/n),u.push({type:3,value:p})}else u.push({type:0})}d.push(u)}return{type:8,value:d}}else return L()}},ATan2:{arguments:[{name:"y",boxed:!0,unroll:!0},{name:"x",boxed:!0,unroll:!0}],fn:(e,t)=>{if(e.type===3&&t.type===3)return{type:3,value:Math.atan2(e.value,t.value)};if(e.type===3&&(e={type:7,value:{real:e.value,imaginary:0}}),t.type===3&&(t={type:7,value:{real:t.value,imaginary:0}}),e.type===7&&t.type===7){let r=yn(e.value,t.value);return r===!1?L():{type:7,value:r}}return L()}},Sin:De(Math.sin,Xi),SinH:De(Math.sinh,gn),ASin:De(Math.asin,Qi),Cos:De(Math.cos,bn),CosH:De(Math.cosh,pn),ACos:De(Math.acos,_n),Tan:De(Math.tan,fn),TanH:De(Math.tanh,mn),ATan:De(Math.atan,vn),E:{fn:()=>({type:3,value:Math.E})},PI:{fn:()=>({type:3,value:Math.PI})},SQRT2:{fn:()=>({type:3,value:Math.SQRT2})},SQRT1_2:{fn:()=>({type:3,value:Math.SQRT1_2})},Sequence:{arguments:[{name:"rows",boxed:!0},{name:"columns",default:1,boxed:!0},{name:"start",default:1,boxed:!0},{name:"step",default:1,boxed:!0}],fn:(e,t,r,a)=>{let i=Gt(e,1),s=Gt(t,1),o=Gt(a,1),n=Gt(r,1);if(i===!1||s===!1||o===!1||n===!1)return L();let l=[];for(let h=0;h<s;h++){let d=[];for(let c=0;c<i;c++)d.push({type:3,value:n+c*o*s+h*o});l.push(d)}return{type:8,value:l}}}},rs={};for(let e of Object.keys(Lt))rs[e.toLowerCase()]=e;var jn=["ceil","pow","ln10","ln2","log10","log10e","log1p","log2","log2e","random","imul","clz32","fround"],as={};for(let e of jn)as[e.toLowerCase()]=e;for(let e of Object.getOwnPropertyNames(Math)){let t=e.toLowerCase();if(rs[t]||as[t])continue;let r=Object.getOwnPropertyDescriptor(Math,e);if(!r)continue;let a=r.value,i=typeof a;switch(i){case"number":Lt[e]={fn:()=>({type:3,value:a}),category:["Math Functions"]};break;case"function":Lt[e]={fn:(...s)=>Y(a(...s)),category:["Math Functions"]};break;default:console.info("unexpected type:",i,e);break}}Math.log10||(Math.log10=e=>Math.log(e)/Math.log(10));var Tt=(e,t,r=0,a=0,i=0)=>i?-(r*(e/(1-Math.pow(1+e,-t))))/(1+e)-a*(1/((1+e)*((Math.pow(1+e,t)-1)/e))):-(r*e*Math.pow(1+e,t)+a*e)/(Math.pow(1+e,t)-1),is=(e,t,r,a=0,i=0)=>i?(1+e)*-r/e*(Math.pow(1+e,t)-1)-a*Math.pow(1+e,t):-r/e*(Math.pow(1+e,t)-1)-a*Math.pow(1+e,t),qr=(e,t,r,a=0,i=0,s=0)=>{if(t<1)return NaN;if(t===1&&s)return 0;let o=Tt(e,r,a,i,s),n=is(e,t-1,o,a,s)*e;return s?n/(1+e):n},Va=(e,t,r,a=0,i=0,s=0)=>Tt(e,r,a,i,s)-qr(e,t,r,a,i,s),Jn={NPV:{description:"Returns the present value of a series of future cashflows",arguments:[{name:"Rate"},{name:"Cashflow"}],fn:(e=0,...t)=>{let r=0,a=j(t);for(let i=0;i<a.length;i++){let s=a[i];typeof s=="number"&&(r+=Math.pow(1+e,-(i+1))*s)}return{type:3,value:r}}},XNPV:{description:"returns the NPV of a nonperiodic stream of payments at a given rate",arguments:[{name:"Discount rate"},{name:"Values"},{name:"Dates"}],fn:(e,t,r)=>{if(typeof e!="number"||(t=j(t),r=j(r),t.length!==r.length))return L();let a=[];for(let o of t){if(typeof o!="number")return L();a.push(o)}let i=[];for(let o of r){if(typeof o!="number")return L();i.push(Math.floor(o))}let s=0;for(let o=0;o<a.length;o++)s+=(a[o]||0)/Math.pow(1+e,(i[o]-i[0])/365);return{type:3,value:s}}},XIRR:{description:"returns the internal rate of return of a nonperiodic stream of payments",arguments:[{name:"Values"},{name:"Dates"},{name:"Guess",default:.1}],fn:(e,t,r=.1)=>{if(e=j(e),t=j(t),e.length!==t.length)return L();let a=0,i=0,s=[];for(let c of e){if(typeof c!="number")return L();c>0&&a++,c<0&&i++,s.push(c)}if(a<=0||i<=0)return L();let o=[];for(let c of t){if(typeof c!="number")return L();o.push(Math.floor(c))}let n=o[0];for(let c of o)if(c<n)return L();let l=.1,h=[{found:!1,value:0},{found:!1,value:0}],d=s.length;for(let c=0;c<100;c++){let u=0;for(let m=0;m<d;m++)u+=(s[m]||0)/Math.pow(1+r,(o[m]-o[0])/365);if(Math.abs(u)<=1e-6)return{type:3,value:r};if(u>0){if(h[0].value=h[0].found?Math.max(h[0].value,r):r,h[0].found=!0,!h[1].found){r+=l;continue}}else if(h[1].value=h[1].found?Math.min(h[1].value,r):r,h[1].found=!0,!h[0].found){r-=l;continue}r=h[0].value+(h[1].value-h[0].value)/2}return F()}},IRR:{description:"Calculates the internal rate of return of a series of cashflows",arguments:[{name:"Cashflows"},{name:"Guess",default:.1}],fn:(e,t=.1)=>{let r=j(e).map(s=>typeof s=="number"?s:0),a=.1,i=[{found:!1,value:0},{found:!1,value:0}];for(let s=0;s<50;s++){let o=0;for(let n=0;n<r.length;n++)o+=Math.pow(1+t,-(n+1))*r[n];if(Math.abs(o)<=.00125)return{type:3,value:t};if(o>0){if(i[0].value=i[0].found?Math.max(i[0].value,t):t,i[0].found=!0,!i[1].found){t+=a;continue}}else if(i[1].value=i[1].found?Math.min(i[1].value,t):t,i[1].found=!0,!i[0].found){t-=a;continue}t=i[0].value+(i[1].value-i[0].value)/2}return{type:6,value:"NUM"}}},CUMPRINC:{description:"Returns cumulative principal paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,r,a,i,s=0)=>{let o=0;for(let n=a;n<=i;n++)o+=Va(e,n,t,r,0,s);return{type:3,value:o}}},CUMIPMT:{description:"Returns cumulative interest paid on a loan between two periods",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Start Period"},{name:"End Period"},{name:"Type",default:0}],fn:(e,t,r,a,i,s=0)=>{let o=0;for(let n=a;n<=i;n++)o+=qr(e,n,t,r,0,s);return{type:3,value:o}}},IPMT:{description:"Returns the interest portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,a=0,i=0,s=0)=>({type:3,value:qr(e,t,r,a,i,s)})},PPMT:{description:"Returns the principal portion of a payment",arguments:[{name:"Rate"},{name:"Period"},{name:"Periods"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,a=0,i=0,s=0)=>({type:3,value:Va(e,t,r,a,i,s)})},Rate:{description:"Returns the interest rate of a loan",arguments:[{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r=0,a=0,i=0)=>{let s=.25,o=[-1,1],n=32,l=1e-6;for(let h=0;h<n;h++){let d=Tt(s,e,r,a,i);if(Math.abs(d-t)<=l)return{type:3,value:s};let c=Tt(o[1],e,r,a,i);t>=d&&t<=c||t>=c&&t<=d?o[0]=s:o[1]=s,s=o[0]+(o[1]-o[0])/2}return{type:3,value:s}}},FV:{description:"Returns the future value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Present Value",default:0},{name:"Type",default:0}],fn:(e,t,r,a=0,i=0)=>({type:3,value:is(e,t,r,a,i)})},PV:{description:"Returns the present value of an investment",arguments:[{name:"Rate"},{name:"Periods"},{name:"Payment"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,a=0,i=0)=>i?(r+=a*(1/((1+e)*((Math.pow(1+e,t)-1)/e))),{type:3,value:-(r+r/e*(1-Math.pow(1+e,-(t-1))))}):{type:3,value:-(a+r/e*(Math.pow(1+e,t)-1))/Math.pow(1+e,t)}},NPER:{description:"Returns the number of periods of an investment",arguments:[{name:"Rate"},{name:"Payment"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r=0,a=0,i=0)=>i?{type:3,value:1+(-Math.log(1+e*(1-r/-t))+Math.log(1+a*e/(-t*(1+e))))/Math.log(1+e)}:{type:3,value:(Math.log(Math.pow(1-r*e/-t,-1))+Math.log(1+a*e/-t))/Math.log(1+e)}},PMT:{description:"Returns the periodic payment of a loan",arguments:[{name:"Rate"},{name:"Periods"},{name:"Present Value"},{name:"Future Value",default:0},{name:"Type",default:0}],fn:(e,t,r,a=0,i=0)=>({type:3,value:Tt(e,t,r,a,i)})}},Wn={Char:{arguments:[{name:"number"}],fn:e=>({type:2,value:String.fromCodePoint(e||32)}),category:["text"]},Code:{arguments:[{name:"string"}],fn:e=>({type:3,value:e.codePointAt(0)||0}),category:["text"]},Value:{arguments:[{name:"text"}],fn:e=>{let t=rt.TryParse(e);return t.type===3?{type:3,value:t.value}:L()},category:["text"]},Text:{arguments:[{name:"value"},{name:"number format"}],fn:(e,t="0.00####")=>({type:2,value:V.Get(t).Format(e||0)}),category:["text"]},WildcardMatch:{visibility:"internal",arguments:[{name:"text",unroll:!0},{name:"text",unroll:!0},{name:"invert"}],fn:(e,t,r=!1)=>{if(typeof e=="string"&&typeof t=="string"){let a=Br(t),i=new RegExp("^"+a+"$","i").exec(e);return{type:4,value:r?!i:!!i}}return{type:4,value:e===t||e?.toString()===t?.toString()}}},Exact:{arguments:[{name:"text",boxed:!0,unroll:!0},{name:"text",boxed:!0,unroll:!0}],category:["text"],fn:(e,t)=>({type:4,value:e?.value?.toString()===t?.value?.toString()})},Len:{arguments:[{name:"string",unroll:!0}],fn:e=>({type:3,value:e.toString().length})},Substitute:{arguments:[{name:"text"},{name:"search"},{name:"replacement"},{name:"index"}],fn:(e,t,r,a)=>{if(typeof a=="number"){if(a<1)return F();let i=1;return{type:2,value:e.replaceAll(t,(...s)=>(console.info(s),i++===a?r:t))}}else return{type:2,value:e.replaceAll(t,r)}}},Left:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:2,value:e.substr(0,t)}),category:["text"]},Right:{arguments:[{name:"string"},{name:"count"}],fn:(e,t=1)=>({type:2,value:e.slice(-t)}),category:["text"]},Mid:{arguments:[{name:"string"},{name:"left"},{name:"count"}],fn:(e,t=0,r=1)=>({type:2,value:e.substr(Math.max(0,t-1),r)}),category:["text"]},Search:{description:"Find a string (needle) in another string (haystack). Case-insensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,r=1)=>{if(r>=1){if(!e)return{type:3,value:r};let a=Br(e),i=new RegExp(a,"i").exec(t.substr(r-1));if(i)return{type:3,value:i.index+r}}return F()}},Find:{description:"Find a string (needle) in another string (haystack). Case-sensitive.",arguments:[{name:"Needle"},{name:"Haystack"},{name:"Start",default:1}],fn:(e,t,r=1)=>{if(r>=1){if(!e)return{type:3,value:r};e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");let a=new RegExp(e).exec(t.substr(r-1));if(a)return{type:3,value:a.index+r}}return F()}},Upper:{description:"Converts text to upper case",arguments:[{name:"text",unroll:!0}],fn:e=>e==null?{type:0}:{type:2,value:e.toString().toUpperCase()}},Lower:{description:"Converts text to lower case",arguments:[{name:"text",unroll:!0}],fn:e=>e==null?{type:0}:{type:2,value:e.toString().toLowerCase()}},Concat:{description:"Pastes strings together",fn:(...e)=>({type:2,value:j(e).map(r=>{let a=r?.toString()||"";return typeof r=="number"&&G.decimal_separator===","?a.replace(/\./,","):a}).join("")})}},Oa={Concatenate:"Concat"},$t=(e,t)=>({type:4,value:typeof t.value?.value===e}),Bt=[{name:"Reference",metadata:!0,unroll:!0}],Zn={IsBlank:{description:"Returns true if the reference is blank",arguments:Bt,fn:$t.bind(0,"undefined")},IsNumber:{description:"Returns true if the reference is a number",arguments:Bt,fn:$t.bind(0,"number")},IsLogical:{description:"Returns true if the reference is a logical TRUE or FALSE",arguments:Bt,fn:$t.bind(0,"boolean")},IsText:{description:"Returns true if the reference is text",arguments:Bt,fn:$t.bind(0,"string")}},ss=2220446049250313e-31,Kn=e=>{let t=1+e;return Math.log(t)-(t-1-e)/t},Ha=(e,t,r,a)=>{let i=2*Number.MIN_VALUE,s=0,o=1,n=1-(e+t)*r/(e+1);Math.abs(n)<i&&(n=Number.NaN),n=1/n,s=n;for(let l=1;l<=512;l++){let h=l*(t-l)*r/((e-1+2*l)*(e+2*l)),d=0;if(n=1+h*n,o=1+h/o,Math.abs(n)<i&&(n=Number.NaN),Math.abs(o)<i&&(o=Number.NaN),n=1/n,d=n*o,s*=d,h=-(e+l)*(e+t+l)*r/((e+2*l)*(e+2*l+1)),n=1+h*n,o=1+h/o,Math.abs(n)<i&&(n=Number.NaN),Math.abs(o)<i&&(o=Number.NaN),n=1/n,d=n*o,s*=d,Math.abs(d-1)<2*ss||s*Math.abs(d-1)<a)return s}return Number.NaN},os=(e,t,r)=>{if(t<0||r<0)return Number.NaN;if(e<=0)return 0;if(e>=1)return 1;if(e>.5)return 1-os(1-e,r,t);let a=t/(t+r),i=0;if(e<.1){let s=(Math.log(t)+Re(t)+Re(r)-Re(t+r)+Math.log(e))/t;s<=0?(i=Math.exp(s),i*=Math.pow(1-i,-(r-1)/t)):i=a,i>a&&(i=a)}else i=a;for(let s=0;s<64;s++){let o=e-ls(i,t,r),n=ns(i,t,r);if(o===0)return i;let l=o/Math.max(2*Math.abs(o/i),n),h=l,d=-((t-1)/i-(r-1)/(1-i))*l*l/2,c=h;if(Math.abs(d)<Math.abs(h)?c+=d:c*=2*Math.abs(h/d),i+c>0&&i+c<1?i+=c:i=Math.sqrt(i)*Math.sqrt(a),Math.abs(h)<=1e-10*i)return i}return i},Re=e=>{let t=e-1,r=t+5.5;r-=(t+.5)*Math.log(r);let a=1,i=[76.18009173,-86.50532033,24.01409822,-1.231739516,.00120858003,-536382e-11];for(let s of i)a+=s/++t;return-r+Math.log(2.50662827465*a)},ns=(e,t,r)=>e<0||e>1?0:Math.exp(Re(t+r)-Re(t)-Re(r))*Math.pow(e,t-1)*Math.pow(1-e,r-1),ls=(e,t,r)=>{if(e<=0)return 0;if(e>=1)return 1;let a=-(Re(t)+Re(r)-Re(t+r))+t*Math.log(e)+r*Kn(-e),i=Math.exp(a);if(e<(t+1)/(t+r+2)){let s=Ha(t,r,e,0);return i*s/t}else{let s=Math.abs(r/i)*ss,o=Ha(r,t,1-e,s);return 1-i*o/r}},hs=e=>{let t=.254829592,r=-.284496736,a=1.421413741,i=-1.453152027,s=1.061405429,o=.3275911;e=Math.abs(e);let n=1/(1+o*e);return 1-((((s*n+i)*n+a)*n+r)*n+t)*n*Math.exp(-1*e*e)},Xn=Math.sqrt(2*Math.PI),Mr=(e,t,r,a)=>{let i=0;return a?i=.5*(1+(e<t?-1:1)*hs(Math.abs(e-t)/(r*Math.sqrt(2)))):i=Math.exp(-1/2*Math.pow((e-t)/r,2))/(r*Xn),i},Ga=e=>{if(e===.5)return 0;let t=e<1&&e>.5?1-e:e,r=Math.sqrt(Math.log(1/Math.pow(t,2))),a=r-(2.515517+.802853*r+.010328*Math.pow(r,2))/(1+1.432788*r+.189269*Math.pow(r,2)+.001308*Math.pow(r,3));return e>.5?a:-a},Ar=e=>{let t=e.length;return t%2?e[Math.floor(t/2)]:(e[t/2]+e[t/2-1])/2},$a=(e,t=!0)=>{e.sort((i,s)=>i-s);let r=e.length,a=(i,s,o)=>{let n=s*i+o,l=n%1;if(l){let h=e[Math.floor(n)],d=e[Math.ceil(n)];return h+(d-h)*l}else return e[n]};return t?[e[0],a(.25,r-1,0),Ar(e),a(.75,r-1,0),e[r-1]]:r%1?[e[0],a(.25,r-2,0),Ar(e),a(.75,r-2,1),e[r-1]]:[e[0],a(.25,r-3,0),Ar(e),a(.75,r-3,2),e[r-1]]},jr=e=>{let t=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23],r=Math.PI,a=Xi,i=mt,s=ue,o=f=>({real:f,imaginary:0}),n=(f,p)=>({real:f.real+p.real,imaginary:f.imaginary+p.imaginary}),l=Ae,h=sa,d=f=>({real:-f.real,imaginary:-f.imaginary}),c=wn;if(e.real<.5)return i(o(r),s(a(s(o(r),e)),jr({real:1-e.real,imaginary:-e.imaginary})));e.real-=1;let u=o(t[0]);for(let f=1;f<t.length;f++)u=n(u,i(o(t[f]),n(e,o(f))));let m=n(e,o(7.5));return c(o(Math.sqrt(2*r)),l(m,n(e,o(.5))),h(d(m)),u)},Fe=(e,t=!1)=>{let r=e.length,a=0,i=0;for(let s=0;s<r;s++)a+=e[s];a/=r;for(let s=0;s<r;s++){let o=e[s]-a;i+=o*o}return t?i/(r-1):i/r},Qn={Slope:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(e,t)=>{let r=re(t),a=re(e);if(r.length!==a.length)return L();let i=0,s=0,o=0,n=0;for(let h=0;h<r.length;h++){let d=r[h],c=a[h];o+=d*c,i+=d,s+=c,n+=d*d}return{type:3,value:(r.length*o-i*s)/(r.length*n-i*i)}}},Intercept:{arguments:[{name:"known_y"},{name:"known_x"}],fn:(e,t)=>{let r=re(t),a=re(e);if(r.length!==a.length)return L();let i=r.length,s=0,o=0,n=0,l=0;for(let d=0;d<i;d++){let c=r[d],u=a[d];n+=c*u,s+=c,o+=u,l+=c*c}let h=i*n-s*o;return h/=i*l-s*s,{type:3,value:(o-h*s)/i}}},Phi:{arguments:[{name:"x",boxed:!0,unroll:!0}],fn:e=>e.type===3?{type:3,value:1/Math.sqrt(Math.PI*2)*Math.exp(-e.value*e.value/2)}:L()},"Z.Test":{arguments:[{name:"Array",boxed:!0},{name:"x",boxed:!0,unroll:!0},{name:"Sigma",boxed:!0,unroll:!0}],fn:(e,t,r)=>{let a=[];if(e.type===8)for(let i of e.value)for(let s of i)s.type===3&&a.push(s.value);else e.type===3&&a.push(e.value);if(a.length&&t.type===3){let i=0,s=a.length;for(let n of a)i+=n;i/=s;let o=r?.type===3?r.value:Math.sqrt(Fe(a,!0));return{type:3,value:1-Mr((i-t.value)/(o/Math.sqrt(s)),0,1,!0)}}return L()}},"Beta.Dist":{description:"beta distribution",arguments:[{name:"x",unroll:!0},{name:"a"},{name:"b"},{name:"cumulative"}],fn:(e,t,r,a)=>t<0||r<0?L():a?{type:3,value:ls(e,t,r)}:{type:3,value:ns(e,t,r)}},"Beta.Inv":{description:"Inverse of the beta distribution",arguments:[{name:"probability",unroll:!0},{name:"a"},{name:"b"}],fn:(e,t,r)=>t<0||r<0?L():{type:3,value:os(e,t,r)}},Erf:{fn:e=>({type:3,value:hs(e)})},"Norm.Inv":{description:"Inverse of the normal cumulative distribution",arguments:[{name:"probability"},{name:"mean",default:0},{name:"standard deviation",default:1}],xlfn:!0,fn:(e,t=0,r=1)=>({type:3,value:Ga(e)*r+t})},"Norm.S.Inv":{description:"Inverse of the standard normal cumulative distribution",arguments:[{name:"probability"}],xlfn:!0,fn:e=>({type:3,value:Ga(e)})},"Norm.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"mean",default:0},{name:"standard deviation",default:1},{name:"cumulative",default:!0}],xlfn:!0,fn:(e,t=0,r=1,a=!0)=>({type:3,value:Mr(e,t,r,a)})},"Norm.S.Dist":{description:"Cumulative normal distribution",arguments:[{name:"value"},{name:"cumulative",default:!0}],xlfn:!0,fn:(e,t=!0)=>({type:3,value:Mr(e,0,1,t)})},"StDev.P":{description:"Returns the standard deviation of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:3,value:Math.sqrt(Fe(re(e),!1))})},"StDev.S":{description:"Returns the standard deviation of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:3,value:Math.sqrt(Fe(re(e),!0))})},"Var.P":{description:"Returns the variance of a set of values, corresponding to a population",arguments:[{name:"data"}],fn:(...e)=>({type:3,value:Fe(re(e),!1)})},"Var.S":{description:"Returns the variance of a set of values, corresponding to a sample of a population",arguments:[{name:"data"}],fn:(...e)=>({type:3,value:Fe(re(e),!0)})},Covar:{description:"Returns the covariance between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t)||!Array.isArray(e[0])||!Array.isArray(t[0]))return F();if(e.length!==t.length)return L();let r=0,a=0,i={x:0,y:0},s={x:[],y:[]};for(let o=0;o<e.length;o++){if(!e[o]||!t[o])continue;if(e[o].length!==t[o].length)return L();let n=e[o].length;a+=n;for(let l=0;l<n;l++)i.x+=e[o][l]||0,i.y+=t[o][l]||0,s.x.push(e[o][l]||0),s.y.push(t[o][l]||0)}if(a===0)return Pe();i.x/=a,i.y/=a;for(let o=0;o<a;o++)r+=(s.x[o]-i.x)*(s.y[o]-i.y);return{type:3,value:r/a}}},Correl:{description:"Returns the correlation between two ranges of values",arguments:[{name:"A"},{name:"B"}],fn:(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t)||!Array.isArray(e[0])||!Array.isArray(t[0]))return F();let r=0,a=0,i=0,s=0,o=0,n=0,l=0;for(let h=0;h<e.length;h++){if(!e[h]||!t[h])continue;let d=e[h].length;for(let c=0;c<d;c++){let u=Number(e[h][c]),m=Number(t[h][c]);isNaN(u)||isNaN(m)||(a+=u*m,i+=u,s+=m,o+=u*u,n+=m*m,l++)}}return r=l*a-i*s,r&&(r/=Math.sqrt((l*o-i*i)*(l*n-s*s))),{type:3,value:r}}},GeoMean:{description:"Returns the geometric mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=he(e);let t=0,r={real:1,imaginary:0},a=!1,i=!1;for(let s of e)s.type===7?(a=!0,r=ue(r,s.value),t++):s.type===3&&(s.value<0&&(i=!0),t++,r.real*=s.value,r.imaginary*=s.value);if(a){let s=Ae(r,{real:1/t,imaginary:0});return s.imaginary?{type:7,value:s}:{type:3,value:s.real}}else return i?F():{type:3,value:Math.pow(r.real,1/t)}}},LCM:{description:"Retuns the least common mulitple of the arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=he(e);let t=[];for(let i of e){if(i.type===6)return i;if(i.type===3)t.push(i.value);else if(i.type!==0)return console.info("RT",i.type),L()}let r=(i,s)=>i%s==0?s:r(s,i%s);if(t.length===0)return{type:3,value:0};let a=t[0];for(let i=1;i<t.length;i++)a=a*t[i]/r(a,t[i]);return{type:3,value:a}}},GammaLn:{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:e=>e.type===3?{type:3,value:Re(e.value)}:L()},"GammaLn.Precise":{description:"Returns the natural log of the gamma function",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:e=>{let t;if(e.type===3?t={real:e.value,imaginary:0}:e.type===7&&(t=e.value),t){let r=jr(t);return ve(Yi(r))}return L()}},Gamma:{description:"Returns the gamma function for the given value",arguments:[{name:"value",boxed:!0,unroll:!0}],fn:e=>{let t={real:0,imaginary:0};if(e.type===7)t={...e.value};else if(e.type===3)t.real=e.value;else return L();if(t.imaginary===0&&t.real%1===0&&t.real<=0)return F();let r=jr(t);return Math.abs(r.imaginary)<=1e-7?{type:3,value:r.real}:{type:7,value:r}}},Delta:{arguments:[{name:"number"},{name:"number",default:0}],fn:(e,t=0)=>typeof e!="number"||typeof t!="number"?F():{type:3,value:e===t?1:0}},GCD:{description:"Finds the greatest common divisor of the arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=he(e);let t=[];for(let i of e){if(i.type===6)return i;if(i.type===3)t.push(i.value);else if(i.type!==0)return console.info("RT",i.type),L()}let r=(i,s)=>i%s==0?s:r(s,i%s);if(t.length===0)return F();if(t.length===1)return{type:3,value:t[0]};let a=t[0];for(let i=1;i<t.length;i++)a=r(a,t[i]);return{type:3,value:a}}},HarMean:{description:"Returns the harmonic mean of the arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=he(e);let t={real:0,imaginary:0},r=0;for(let a of e){if(a.type===6)return a;if(a.type===3&&(t.real+=1/a.value,r++),a.type===7){let i=mt({real:1,imaginary:0},a.value);t.real+=i.real,t.imaginary+=i.imaginary,r++}}return t.imaginary?{type:7,value:mt({real:r,imaginary:0},t)}:{type:3,value:r/t.real}}},Average:{description:"Returns the arithmetic mean of all numeric arguments",arguments:[{boxed:!0}],fn:(...e)=>{e=he(e);let t={real:0,imaginary:0},r=0;for(let a of e){if(a.type===6)return a;a.type===3&&(t.real+=a.value,r++),a.type===7&&(t.real+=a.value.real,t.imaginary+=a.value.imaginary,r++)}return t.real/=r,t.imaginary/=r,t.imaginary?{type:7,value:t}:{type:3,value:t.real}}},Percentile:{description:"Returns the kth percentile value from the range of data",arguments:[{name:"range"},{name:"percentile"}],fn:(e,t)=>{let r=re(e);r.sort((l,h)=>l-h);let a=r.length,i=Math.pow(10,8),s=Math.round((1+(a-1)*t)*i)/i,o=Math.floor(s),n=Math.ceil(s);return{type:3,value:(r[o-1]+r[n-1])/2}}},"Quartile.Inc":{description:"Returns the interpolated quartile of the data set (including median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(e,t)=>{if(typeof t!="number"||t<0||t>4||t%1)return L();let r=re(e);return{type:3,value:$a(r,!0)[t]}}},"Quartile.Exc":{description:"Returns the interpolated quartile of the data set (excluding median)",arguments:[{name:"range"},{name:"quartile"}],xlfn:!0,fn:(e,t)=>{if(typeof t!="number"||t<1||t>3||t%1)return L();let r=re(e);return{type:3,value:$a(r,!1)[t]}}},Median:{description:"Returns the median value of the range of data",arguments:[{name:"range"}],fn:(...e)=>{let t=re(e);t.sort((s,o)=>s-o);let r=1+(t.length-1)*.5,a=Math.floor(r),i=Math.ceil(r);return{type:3,value:(t[a-1]+t[i-1])/2}}},Rank:{arguments:[{name:"Value"},{name:"Source"},{name:"Order"}],fn:(e,t,r=0)=>{if(typeof e!="number")return L();let a=re(t);a.sort(r?(i,s)=>i-s:(i,s)=>s-i);for(let i=0;i<a.length;i++)if(a[i]===e)return{type:3,value:i+1};return F()}}},Ba={Mean:"Average",StDev:"StDev.S",StDevA:"StDev.S",StDevPA:"StDev.P",Var:"Var.S",Quartile:"Quartile.Inc",NormSInv:"Norm.S.Inv",NormSDist:"Norm.S.Dist",NormDist:"Norm.Dist"},Yn={IsComplex:{description:"Returns true if the reference is a complex number",arguments:[{name:"Reference",metadata:!0,unroll:!0}],fn:e=>({type:4,value:!!e?.value&&Ne(e.value.value)})},Real:{description:"Returns the real part of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:e=>e.type===3?{...e}:e.type===7?{type:3,value:e.value.real||0}:e.type===0||e.type===2&&e.value===""?{type:3,value:0}:F()},Imaginary:{description:"Returns the imaginary part of a complex number (as real)",arguments:[{boxed:!0,unroll:!0}],fn:e=>e.type===7?{type:3,value:e.value.imaginary||0}:e.type===3||e.type===0||e.type===2&&e.value===""?{type:3,value:0}:F()},Conjugate:{description:"Returns the conjugate of a complex number",arguments:[{boxed:!0,unroll:!0}],fn:e=>{let t=ft(e);return t?t.imaginary?{type:7,value:{real:t.real,imaginary:-t.imaginary}}:{type:3,value:t.real}:F()}},Arg:{description:"Returns the principal argument of a complex number (in radians)",arguments:[{boxed:!0,unroll:!0}],fn:e=>e.type===7?{type:3,value:Math.atan2(e.value.imaginary,e.value.real)}:e.type===3||e.type===0||e.type===2&&e.value===""?{type:3,value:Math.atan2(0,e.value||0)}:F()},Rectangular:{description:"Converts a complex number in polar form to rectangular form",arguments:[{name:"r"},{name:"θ in radians"}],fn:(e=0,t=0)=>({type:7,value:{real:e*Math.cos(t),imaginary:e*Math.sin(t)}})},Complex:{description:"Ensures that the given value will be treated as a complex number",arguments:[{boxed:!0,unroll:!0}],fn:e=>{let t=ft(e);return t?{type:7,value:t}:F()}},ComplexLog:{description:"Returns the principal value Log(z) of a complex number z",arguments:[{boxed:!0,unroll:!0}],fn:e=>{if(e.type===3){if(!e.value)return F();e={type:7,value:{real:e.value,imaginary:0}}}else if(e.type===0||e.type===2&&e.value==="")return F();if(e.type===7){let t=ia(e.value),r={real:Math.log(t.r),imaginary:t.theta};return r.imaginary?{type:7,value:r}:{type:3,value:r.real}}return F()}}},qt=e=>{let t=[];e.type===8?t=e.value:t=[[e]];let r=t.length,a=r?t[0].length:0,i=[];if(!r||!a)return{m:r,n:a,array:i};for(let s=0;s<r;s++){let o=[];for(let n=0;n<a;n++){let l=t[s][n];if(l.type===7)o.push({...l.value});else if(l.type===3)o.push({real:l.value,imaginary:0});else if(l.type===0||l.value==="")o.push({real:0,imaginary:0});else return{m:r,n:a,error:!0,array:[]}}i.push(o)}return{m:r,n:a,array:i}},el={MDeterm:{description:"Returns the determinant of a matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{let t=qt(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return F();let r=Hr(t);return r?ve(r):F()}},MInverse:{description:"Returns the inverse matrix",arguments:[{name:"matrix",boxed:!0}],fn:e=>{let t=qt(e);if(!t.array||!t.m||!t.n||t.m!==t.n||t.error)return F();let r=Hr(t);if(r&&r.real===0&&r?.imaginary===0)return F();let a=Mn(t);return a?{type:8,value:a.map(i=>i.map(s=>ve(s)))}:F()}},MMult:{description:"Returns the dot product A ⋅ B",arguments:[{name:"A",boxed:!0},{name:"B",boxed:!0}],fn:(e,t)=>{let r=qt(e),a=qt(t);return!r.array||r.error||!a.array||a.error||r.m!==a.n?F():{type:8,value:Cn(a,r).map(s=>s.map(o=>ve(o)))}}}},tl={RegexExtract:{description:"Extract text using a regular expression",arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"return mode",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],fn:(e,t,r=0,a=!1)=>{let i=[];a&&i.push("i"),r===1&&i.push("g");let s=new RegExp(t,i.length?i.join(""):void 0);switch(r){case 0:{let o=e.match(s);return{type:2,value:o===null?"":o[0]??""}}case 1:{let o=Array.from(e.matchAll(s));return console.info({result:o}),{type:8,value:[o.map(n=>({type:2,value:n[0]||""}))]}}case 2:{let o=e.match(s);return o===null?{type:2,value:""}:{type:8,value:[Array.from(o).slice(1).map(l=>({type:2,value:l}))]}}default:return L()}}},RegexReplace:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"replacement",unroll:!0},{name:"occurrence",unroll:!0,default:0},{name:"case insensitive",unroll:!0,default:!1}],description:"Replace text in a string using a regex",fn:(e,t,r,a=0,i=!1)=>{let s=["g"];i&&s.push("i");let o=new RegExp(t,s.length?s.join(""):void 0);if(a===0)return{type:2,value:e.replaceAll(o,r)};if(a<0){let l=Array.from(e.matchAll(o)).length;a+=l+1}return{type:2,value:e.replace(o,l=>--a===0?r:l)}}},RegexTest:{arguments:[{name:"text",unroll:!0},{name:"pattern",unroll:!0},{name:"case insensitive",unroll:!0,default:!1}],description:"Match text against a regular expression",fn:(e,t,r=!1)=>({type:4,value:new RegExp(t,r?"i":void 0).test(e)})}},rl={Lambda:{description:"Creates a function",arguments:[{name:"Argument",repeat:!0,boxed:!0,passthrough:!0},{name:"Function",boxed:!0,passthrough:!0}],fn:(...e)=>({type:10,value:{bindings:e.slice(0,e.length-1),func:e[e.length-1],alt:"LAMBDA",type:"function"}})},Let:{description:"Binds values to names for a calculation",arguments:[{name:"Name",repeat:!0},{name:"Value",repeat:!0},{name:"Calculation",boxed:!0}],create_binding_context:({args:e,descriptors:t})=>{if(e.length%2!==1)return;let r={};for(let a=0;a<e.length-1;a+=2){let i=e[a],s=e[a+1];if(i.type==="identifier")r[i.name]=s;else return}return{context:r,args:e.slice(-1),argument_descriptors:t.slice(-1)}},fn:e=>e||{type:0}}},Rr=class ds extends lr{static type="state-leaf-vertex";state_id=0;type=ds.type;color=2;Calculate(){if(this.dirty){for(let t of this.edges_in)if(t.dirty)return;this.state_id++,this.dirty=!1}}AddDependent(){throw new Error("leaf vertex cannot have dependents")}},al=e=>{if(typeof e=="string")switch(e=e.toUpperCase(),e){case"AVERAGE":case"MEAN":e=101;break;case"COUNT":e=102;break;case"COUNTA":e=103;break;case"MAX":e=104;break;case"MIN":e=105;break;case"PRODUCT":e=106;break;case"STDEV":e=107;break;case"STDEVP":e=108;break;case"SUM":e=109;break;case"VAR":e=110;break;case"VARP":e=111;break;default:e=0;break}return e},il={complex_numbers:"off",spill:!1},cs=class extends dn{constructor(e,t={}){if(super(),this.model=e,this.expression_calculator=new ts(this.model,this.library,this.parser),this.options={...il,...t},this.options.complex_numbers==="on"){for(let i of Object.keys(Ia))Lt[i]=Ia[i];Un()}this.UpdateLocale(),this.library.Register(Lt,Wn,Qn,Jn,Zn,Yn,el,tl,rl);for(let i of Object.keys(Ba))this.library.Alias(i,Ba[i]);for(let i of Object.keys(Oa))this.library.Alias(i,Oa[i]);let r=(i,s,...o)=>{let n=[];for(let c=0;c<o.length;c+=2)if(Array.isArray(o[c])){let u=a(o[c],o[c+1]);if(u.type!==8)return u;for(let[m,f]of u.value[0].entries())n[m]=!!f.value&&n[m]!==!1}let l=j(s,!0),h=0,d=0;for(let[c,u]of n.entries())if(u){h++;let m=l[c];typeof m=="number"&&(d+=m)}switch(i){case"count":return{type:3,value:h};case"sum":return{type:3,value:d};case"average":return h===0?Me():{type:3,value:d/h}}},a=(i,s)=>{let o=j(i,!0),n,l,h="=";if(typeof s=="string"){s=s.trim();let d=s.match(/^([=<>]+)/);d&&(h=d[1],s=s.substring(h.length));let c=rt.TryParse(s);if(c?.type===2?s=`"${c.value}"`:s=c?.value?.toString()||"",/[?*]/.test(s)){let u=this.parser.argument_separator;if(h==="="||h==="<>"){if(n=this.parser.Parse(`=WildcardMatch({}${u} ${s}${u} ${h==="<>"})`),l=n.expression,n.error||!l)return _e();l?.type==="call"&&l.args[0]?.type==="array"&&(l.args[0].values=[Ea(o,!0)])}}}else s=(s||0).toString();if(!n){if(n=this.parser.Parse("{}"+h+s),l=n.expression,n.error||!l)return _e();if(l.type!=="binary"||l.left.type!=="array")return console.warn("invalid expression [1]",l),_e();l.right.type==="identifier"&&(console.warn("will never happen"),l.right={...l.right,type:"literal",value:l.right.name}),l.left.values=[Ea(o,!0)]}return l?this.CalculateExpression(l):F()};this.library.Register({Subtotal:{arguments:[{name:"type"},{name:"range",metadata:!0}],fn:(i,...s)=>{if(i=al(i),i>100&&(i-=100),i<1||i>11)return L();let o=he(s),n=[],l=0,h=0,d;for(let u of o){let m=u.value?.address;if(!m)return Z();if(!d||d.id!==m.sheet_id){if(!m.sheet_id)return console.warn("invalid reference in metadata"),Z();if(d=this.model.sheets.Find(m.sheet_id),!d)return console.warn("invalid sheet in metadata"),Z()}if(!d.GetRowHeight(m.row))continue;let f=u.value?.value;typeof f>"u"||(l++,typeof f=="number"&&(h+=f,n.push(f)))}let c=0;switch(i){case 1:if(n.length===0)return Me();c=h/n.length;break;case 2:c=n.length;break;case 3:c=l;break;case 4:if(n.length===0)return F();c=Math.max.apply(0,n);break;case 5:if(n.length===0)return F();c=Math.min.apply(0,n);break;case 6:if(n.length===0)return F();c=1;for(let u of n)c*=u;break;case 7:if(n.length<2)return Me();c=Math.sqrt(Fe(n,!0));break;case 8:if(n.length===0)return Me();c=Math.sqrt(Fe(n,!1));break;case 9:c=h;break;case 10:if(n.length<2)return Me();c=Fe(n,!0);break;case 11:if(n.length===0)return Me();c=Fe(n,!1);break}return{type:3,value:c}}},Cell:{description:"Returns data about a cell",arguments:[{name:"type",description:"Type of data to return",unroll:!0},{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:(i,s)=>{if(!ce(s))return Z();if(i)switch(i.toString().toLowerCase()){case"format":return s.value.format?{type:2,value:s.value.format}:Z();case"address":{let o="";return s.value.address.sheet_id&&(o=this.model.sheets.Find(s.value.address.sheet_id)?.name||""),o&&(tt.test(o)&&(o=`'${o}'`),o+="!"),{type:2,value:"[]"+o+s.value.address.label.replace(/\$/g,"")}}}return{type:6,value:ln.error}}},Address:{arguments:[{name:"row"},{name:"column"},{name:"absolute"},{name:"a1"},{name:"sheet name"}],fn:(i=1,s=1,o=1,n=!0,l)=>{let h={type:"address",id:0,position:0,label:"",row:i-1,column:s-1};switch(o){case 2:h.absolute_row=!0;break;case 3:h.absolute_column=!0;break;case 4:break;default:h.absolute_column=!0,h.absolute_row=!0}return l&&(h.sheet=l),Hn(this.parser.Render(h,{r1c1:!n}))}},CountIfs:{arguments:[{name:"range"},{name:"criteria"},{name:"range"},{name:"criteria"}],fn:(...i)=>r("count",i[0],...i)},AverageIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(i,s,o)=>r("average",o||i,i,s)},AverageIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(i,...s)=>r("average",i,...s)},SumIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(i,s,o)=>r("sum",o||i,i,s)},SumIfs:{arguments:[{name:"value range"},{name:"criteria range"},{name:"criteria"},{name:"criteria range"},{name:"criteria"}],fn:(i,...s)=>r("sum",i,...s)},CountIf:{arguments:[{name:"range"},{name:"criteria"}],fn:(i,s)=>r("count",i,i,s)},Offset:{arguments:[{name:"reference",description:"Base reference",metadata:!0},{name:"rows",description:"number of rows to offset"},{name:"columns",description:"number of columns to offset"},{name:"height"},{name:"width"}],return_type:"reference",volatile:!0,fn:((i,s=0,o=0,n,l)=>{if(!i)return L();if(i.type===8){let d=typeof n=="number"?s+n:void 0,c=typeof l=="number"?o+l:void 0;return{type:8,value:i.value.slice(s,d).map(u=>u.slice(o,c))}}if(!ce(i))return console.info("e2",{reference:i}),Z();let h=this.DynamicDependencies(i.value.address,this.expression_calculator.context.address,!0,s,o,l,n);if(!h)return console.info("e1",{check_result:h}),Z();if(h.dirty){let d=this.GetVertex(this.expression_calculator.context.address,!0);return d.short_circuit=!0,{type:0,value:void 0}}if(h.area){let d={type:"address",...h.area.start,label:"",position:0,id:0},c={type:"address",...h.area.end,label:"",position:0,id:0};return{type:5,value:h.area.count===1?d:{type:"range",start:d,end:c,label:"",position:0,id:0}}}return F()}).bind(this)},Indirect:{arguments:[{name:"reference",description:"Cell reference (string)"}],return_type:"reference",volatile:!0,fn:(i=>{if(!i||typeof i!="string")return L();let s=this.parser.Parse(i);if(s.error||!s.expression||s.expression.type!=="address"&&s.expression.type!=="range")return Z();let o=this.DynamicDependencies(s.expression,this.expression_calculator.context.address);if(!o)return Z();if(o.dirty){let n=this.GetVertex(this.expression_calculator.context.address,!0);return n.short_circuit=!0,{type:0,value:void 0}}return{type:5,value:s.expression}}).bind(this)},Match:{arguments:[{name:"value",boxed:!0},{name:"range",boxed:!0},{name:"type"}],fn:(i,s,o=0)=>{if(o)return console.warn("inexact match not supported",{value:i,range:s,type:o}),Pe();if(s.type===8){if(s.value.length===1){let n=s.value[0];for(let l=0;l<n.length;l++)if(i.type==n[l].type&&i.value===n[l].value)return{type:3,value:l+1}}else for(let n=0;n<s.value.length;n++){let l=s.value[n];if(l.length!==1)return Pe();if(i.type==l[0].type&&i.value===l[0].value)return{type:3,value:n+1}}return Pe()}else return i.type===s.type&&i.value===s.value?{type:3,value:1}:Pe()}},Index:{arguments:[{name:"range",boxed:!0},{name:"row"},{name:"column"}],volatile:!1,fn:(i,s,o)=>{if(i&&i.type!==8&&(i={type:8,value:[[i]]}),s&&o){let n=i.value[o-1];if(n){let l=n[s-1];if(l)return l}}else if(s){let n=[];for(let l of i.value){if(!l[s-1])return L();n.push([l[s-1]])}return{type:8,value:n}}else if(o){let n=i.value[o-1];if(n)return{type:8,value:[n]}}return L()}},Rows:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:i=>{if(!i)return L();if(Array.isArray(i)){let s=i[0];return Array.isArray(s)?{type:3,value:s.length}:F()}return{type:3,value:1}}},Columns:{arguments:[{name:"reference",description:"Array or reference"}],volatile:!1,fn:i=>i?Array.isArray(i)?{type:3,value:i.length}:{type:3,value:1}:L()},FormulaText:{description:"Returns a formula as a string",arguments:[{name:"reference",description:"Cell reference",metadata:!0,unroll:!0}],fn:i=>{if(!ce(i))return Z();let s=this.model.sheets.Find(i.value?.address?.sheet_id||0);return s?{type:2,value:s.cells.GetCell(i.value.address,!1)?.value?.toString()||""}:Z()}},IsFormula:{description:"Returns true if the reference is a formula",arguments:[{name:"Reference",unroll:!0,metadata:!0}],fn:i=>{let s=i?.value?.address,o=this.model.sheets.Find(s?.sheet_id||0);return s&&o?{type:4,value:o.cells.GetCell(s,!1)?.type===1}:{type:4,value:!1}}}})}get parser(){return this.model.parser}library=new Gn;registered_libraries={};expression_calculator;full_rebuild_required=!1;options;grid_expanded=!1;ExportCalculatedValues(){let e={};for(let t of this.model.sheets.list){let r=t.cells.toJSON({calculated_value:!0}).data;e[t.id]=r.filter(a=>a.calculated!==void 0)}return e}ApplyCalculatedValues(e){for(let t of this.model.sheets.list){let r=e[t.id];if(!r)console.info("mismatch",t.id);else for(let a of r)t.cells.data[a.row][a.column].SetCalculatedValue(a.calculated)}}AttachSpillData(e,t){if(t||(t=(e.start.sheet_id?this.model.sheets.Find(e.start.sheet_id):void 0)?.cells),!t)throw new Error("invalid sheet ID in attach spill data");let r=new Rr,a=0,i=!1;for(let{cell:s,row:o,column:n}of t.IterateRC(e,!0))a++&&(s.type!==0||s.area||s.merge_area||s.table)&&(i=!0),this.AddLeafVertexEdge({row:o,column:n,sheet_id:e.start.sheet_id},r);return this.spill_data.push({area:e,vertex:r}),{vertex:r,area:e,error:i}}SpillCallback(e,t){let{reference:r,address:a}=e,{value:i}=t,s=[];if(!r)return console.error("invalid reference in spill callback"),s;if(!a||!a.sheet_id)return console.error("invalid address in spill callback"),s;if(i.length===1&&i[0].length===1||!this.options.spill)return r.SetCalculatedValue(i[0][0].value),s;let o=this.model.sheets.Find(a.sheet_id),n=o?.cells;if(n){let l=t.value.length,h=t.value[0].length,d=new k(a).Reshape(h,l),{error:c}=this.AttachSpillData(d,n);if(c)return r.SetCalculationError("SPILL"),s;o.rows<d.end.row+1&&(o.cells.EnsureRow(d.end.row+1),this.grid_expanded=!0),o.columns<d.end.column+1&&(o.cells.EnsureColumn(d.end.column+1),this.grid_expanded=!0);let u=a.sheet_id;for(let{row:m,column:f}of n.IterateRC(d)){if(m===a.row&&f===a.column)continue;let p=this.GetVertex({sheet_id:u,row:m,column:f},!1);p&&(p.dirty||s.push(p))}for(let{cell:m,row:f,column:p}of n.IterateRC(d)){m.spill=d,f-=a.row,p-=a.column;let b=t.value[p][f];switch(b.type){case 5:case 8:case 10:break;default:m.SetCalculatedValue(b.value,b.type);break}}return s}return console.error("invalid cell reference in spill callback"),r.SetCalculationError("SPILL"),[]}SpreadCallback(e,t){if(!e.address||!e.address.sheet_id)throw new Error("spread callback called without sheet id");let r=this.model.sheets.Find(e.address.sheet_id)?.cells;if(!r)throw new Error("spread callback called without cells");if(!e||!e.reference)return;let a=e.reference.area;if(a){let i=a.rows,s=a.columns;if(t.type===8){let o=Dt(t.value);for(let n=0;n<i;n++)if(o[n]){let l=0;for(;l<s&&l<o[n].length;l++){let h=o[n][l];switch(h.type===8&&(h=h.value[0][0]),h.type){case 8:case 5:case 10:r.data[n+a.start.row][l+a.start.column].SetCalculatedValue(void 0);break;default:r.data[n+a.start.row][l+a.start.column].SetCalculatedValue(h.value,h.type)}}for(;l<s;l++)r.data[n+a.start.row][l+a.start.column].SetCalculatedValue(void 0,0)}else for(let l=0;l<s;l++)r.data[n+a.start.row][l+a.start.column].SetCalculatedValue(void 0,0)}else{let o={...t};(o.type===5||o.type===10)&&(o={type:0,value:void 0});for(let n=0;n<i;n++)for(let l=0;l<s;l++)r.data[n+a.start.row][l+a.start.column].SetCalculatedValue(o.value,o.type)}}}CalculationCallback(e){if(!e.address)throw new Error("vertex missing address");return e.expression_error?{value:Ji()}:this.expression_calculator.Calculate(e.expression,e.address,e.reference?.area)}DynamicDependencies(e,t,r=!1,a=0,i=0,s=1,o=1){let n=this.ResolveExpressionAddress(e,t);if(!n)return;let l=!1,h;if(e.type==="address"||e.type==="range"){let c=e.type==="range"?e.start:e;c.sheet_id?h=this.model.sheets.Find(c.sheet_id):c.sheet&&(h=this.model.sheets.Find(c.sheet))}if(!h&&t?.sheet_id&&(h=this.model.sheets.Find(t.sheet_id)),!h)throw new Error("missing sheet in dynamic dependencies [b21]");n=h.RealArea(n);let d=n.start.sheet_id;r&&(n=new k({column:n.start.column+i,row:n.start.row+a,sheet_id:n.start.sheet_id},{column:n.start.column+i+s-1,row:n.start.row+a+o-1,sheet_id:n.end.sheet_id}));for(let c=n.start.row;c<=n.end.row;c++)for(let u=n.start.column;u<=n.end.column;u++){let m=this.GetVertex({row:c,column:u,sheet_id:d},!1);m&&m.dirty&&(this.AddEdge({row:c,column:u,sheet_id:d},this.expression_calculator.context.address),l=!0)}return{dirty:l,area:n}}UpdateLocale(){G.decimal_separator===","?this.parser.SetLocaleSettings(","):this.parser.SetLocaleSettings(".")}SupportedFunctions(){let e=this.library.List(),t=Object.keys(e).map(r=>{let a=e[r].canonical_name;return a||(a=r.replace(/_/g,".")),{name:a,description:e[r].description,arguments:(e[r].arguments||[]).map(i=>({name:i.name||""})),type:"function"}});for(let r of this.model.macro_functions.values())t.push({name:r.name,description:r.description,arguments:(r.argument_names||[]).map(a=>({name:a})),type:"function"});return t}RegisterLibrary(e,t){return this.registered_libraries[e]?!1:(this.RegisterFunction(t),this.registered_libraries[e]=!0,!0)}RegisterFunction(e){for(let t of Object.keys(e)){let r=e[t];this.library.Register({[t]:r})}}Calculate(e){if(e&&!e.start.sheet_id)throw new Error("CalculateInternal called with subset w/out sheet ID");this.full_rebuild_required&&(e=void 0,this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.full_rebuild_required=!1),this.RebuildGraph(e),this.grid_expanded=!1;try{this.Recalculate()}catch(t){console.error(t),console.info("calculation error trapped")}}Reset(){this.FlushTree(),this.full_rebuild_required=!0}DecoratedFunctionList(){let e={},t=this.library.List();for(let r of Object.keys(t)){let a=t[r];a.xlfn?e[r]="_xlfn":a.extension&&(e[r]="_xll")}return e}Evaluate(e,t,r={},a=!1){let i=r?.preparsed;if(!i){this.parser.Save(),r.argument_separator&&(r.argument_separator===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(",")),r.r1c1&&(this.parser.flags.r1c1=r.r1c1);let s=this.parser.Parse(e);if(this.parser.Restore(),i=s.expression,s.error)throw new Error(s.error)}if(i){this.parser.Walk(i,o=>{if(o.type==="address"||o.type==="range"){if(o.type==="address"){if(o.offset_column||o.offset_row)throw new Error("Evaluate does not support offset references")}else if(o.start.offset_column||o.start.offset_row||o.end.offset_column||o.end.offset_row)throw new Error("Evaluate does not support offset references");this.model.ResolveSheetID(o,void 0,t)}return!0});let s=this.CalculateExpression(i,r.address);return a?s:s.type===8?s.value.map(o=>o.map(n=>n.value)):s.value}throw new Error("invalid expression")}CalculateExpression(e,t={row:-1,column:-1},r=!1){return this.expression_calculator.Calculate(e,t,void 0,r).value}RebuildClean(e=!1){this.full_rebuild_required=!1,this.RebuildGraph(),this.UpdateAnnotations(),this.UpdateConditionals(),this.UpdateConnectedElements(),this.InitializeGraph(),e&&this.volatile_list.length&&this.Recalculate()}FlattenCellList(e){let t={},r=[];for(let a of e){let i={column:a.column,row:a.row,sheet_id:a.sheet_id},s=k.CellAddressToLabel(i,!0);t[s]||(t[s]=s,r.push(i))}return r}Unresolve(e,t,r=!0,a=!0){let i="",s=$(e)?new k(e):new k(e.start,e.end);if(a){let l=this.model.named.MatchSelection(s);if(l)return l}if(i=s.spreadsheet_label,!r)return i;let o=s.start.sheet_id||t?.id,n=this.ResolveSheetName(o,!0);return n?n+"!"+i:i}ResolveSheetName(e,t=!1){let r=this.model.sheets.Find(e);if(r)return t&&tt.test(r.name)?`'${r.name}'`:r.name}RemoveConditional(e){if(e.type==="expression"){let t=e.internal?.vertex;t&&(t.Reset(),this.RemoveLeafVertex(t))}}RemoveConnectedELement(e){let t=e.internal;return t?.vertex?(this.RemoveLeafVertex(t.vertex),!0):!1}UpdateConnectedElements(e,t){if(e||(e=this.model.sheets.list[0]),t){let a=t.internal;a?.vertex&&this.RemoveLeafVertex(a.vertex)}let r=t?[t]:this.model.connected_elements.values();for(let a of r){let i=a.internal;i||(i={vertex:new Rr},a.internal=i);let s=i.vertex;this.AddLeafVertex(s),this.UpdateLeafVertex(s,a.formula,e)}}UpdateConditionals(e,t){if(!e){for(let r of this.model.sheets.list)r.conditional_formats?.length&&this.UpdateConditionals(r.conditional_formats,r);return}if(!t)throw new Error("invalid call to update conditionals without context");e&&!Array.isArray(e)&&(e=[e]);for(let r of e){let a="";switch(r.type){case"cell-match":r.between?a=`BETWEEN(${[this.Unresolve(r.area,t,!0,!1),...r.between].join(", ")})`:a=this.Unresolve(r.area,t,!0,!1)+" "+r.expression;break;case"expression":a=r.expression;break;case"duplicate-values":a=`UniqueValues(${this.Unresolve(r.area,t,!0,!1)})`,r.unique||(a=`NOT(${a})`);break;case"gradient":a=`=Gradient(${[this.Unresolve(r.area,t,!0,!1),r.min??"",r.max??""].join(",")})`;break;default:continue}if(!a)continue;if(r.internal||(r.internal={}),!r.internal.vertex){let s=new Zi;s.use="conditional",r.internal.vertex=s;let o={argument_separator:","};r.type!=="gradient"&&r.type!=="duplicate-values"&&(o={...r.options,...o});let n=this.Evaluate(a,t,o,!0);r.internal.vertex.result=n,r.internal.vertex.updated=!0}let i=r.internal.vertex;this.AddLeafVertex(i),this.UpdateLeafVertex(i,a,t,".")}}RemoveAnnotation(e){let t=e.temp;t.vertex&&(t.vertex.Reset(),this.RemoveLeafVertex(t.vertex))}UpdateAnnotations(e,t){if(!e){for(let r of this.model.sheets.list)this.UpdateAnnotations(r.annotations,r);return}if(!t)throw new Error("invalid call to UpdateAnnotations with list but no sheet");typeof e<"u"&&!Array.isArray(e)&&(e=[e]);for(let r of e)if(r.data.formula){let a=r.temp;a.vertex||(a.vertex=new Rr),this.AddLeafVertex(a.vertex),this.UpdateLeafVertex(a.vertex,r.data.formula,t)}}ResolveExpressionAddress(e,t){switch(e.type){case"address":if(this.model.ResolveSheetID(e,t))return new k(e);break;case"range":if(this.model.ResolveSheetID(e,t))return new k(e.start,e.end);break;case"identifier":{let r=this.model.GetName(e.name,t?.sheet_id||0);if(r&&r.type==="range")return new k(r.area.start,r.area.end)}break}}NamedRangeToAddressUnit(e,t){let r=e.name.toUpperCase(),a=this.model.GetName(r,t.sheet_id||0);if(a&&a.type==="range")return a.area.count===1?this.ConstructAddressUnit(a.area.start,r,e.id,e.position):{type:"range",start:this.ConstructAddressUnit(a.area.start,r,e.id,e.position),end:this.ConstructAddressUnit(a.area.end,r,e.id,e.position),label:r,id:e.id,position:e.position}}ConstructAddressUnit(e,t,r,a){return{type:"address",row:e.row,column:e.column,sheet_id:e.sheet_id,label:t,id:r,position:a}}RebuildDependencies(e,t,r,a={addresses:{},ranges:{}},i){if(!r){let s=this.model.sheets.Find(t);s&&(r=s.name)}switch(e.type){case"literal":case"missing":case"operator":break;case"identifier":{let s=this.model.GetName(e.name,i.sheet_id||0);if(s?.type==="expression")this.RebuildDependencies(s.expression,t,r,a,i);else{let o=this.NamedRangeToAddressUnit(e,i);o&&(o.type==="address"?a.addresses[o.label]=o:a.ranges[o.label]=o)}}break;case"structured-reference":{let s=this.model.ResolveStructuredReference(e,i);s&&(s.type==="address"?a.addresses[s.sheet_id+"!"+s.label]=s:a.ranges[s.label]=s);let o=this.model.tables.get(e.table.toLowerCase());if(o){let n=i.row;if(n<o.area.start.row||n>o.area.end.row)break;let l=e.column.toLowerCase(),h=-1;if(o.columns){for(let d=0;d<o.columns.length;d++)if(l===o.columns[d]){h=o.area.start.column+d;break}}if(h>=0){let d={label:e.label,type:"address",row:n,column:h,sheet_id:o.area.start.sheet_id,id:e.id,position:e.position};a.addresses[d.sheet_id+"!"+d.label]=d}}}break;case"address":if(!e.sheet_id)if(e.sheet){let s=this.model.sheets.Find(e.sheet);s&&(e.sheet_id=s.id)}else e.sheet_id=t,e.sheet=r;e.sheet_id?a.addresses[e.sheet_id+"!"+e.label]=e:console.warn("invalid address in range [9d]");break;case"range":if(!e.start.sheet_id)if(e.start.sheet){let s=this.model.sheets.Find(e.start.sheet);s&&(e.start.sheet_id=s.id)}else e.start.sheet_id=t,e.start.sheet=r;e.start.sheet_id?a.ranges[e.start.sheet_id+"!"+e.start.label+":"+e.end.label]=e:console.warn("invalid sheet in range",e);break;case"unary":this.RebuildDependencies(e.operand,t,r,a,i);break;case"binary":this.RebuildDependencies(e.left,t,r,a,i),this.RebuildDependencies(e.right,t,r,a,i);break;case"group":e.elements.forEach(s=>this.RebuildDependencies(s,t,r,a,i));break;case"implicit-call":{for(let s of e.args)this.RebuildDependencies(s,t,r,a,i);this.RebuildDependencies(e.call,t,r,a,i)}break;case"call":{let s=e.args.slice(0),o=this.library.Get(e.name);o&&o.arguments&&o.arguments.forEach((n,l)=>{n&&n.address&&(this.RebuildDependencies(s[l],t,r,void 0,i),s[l]={type:"missing",id:-1})}),s.forEach(n=>this.RebuildDependencies(n,t,r,a,i))}break}return a}UpdateLeafVertex(e,t,r,a){e.Reset(),a&&(this.parser.Save(),this.parser.SetLocaleSettings(a));let i=this.parser.Parse(t);if(i.expression){let s=this.RebuildDependencies(i.expression,r.id,r.name,void 0,{row:0,column:0});for(let o of Object.keys(s.ranges)){let n=s.ranges[o],l=new k(n.start,n.end);l.entire_column||l.entire_row||l.count>1?this.AddLeafVertexArrayEdge(l,e):this.AddLeafVertexEdge(l.start,e)}for(let o of Object.keys(s.addresses)){let n=s.addresses[o];this.AddLeafVertexEdge(n,e)}}e.expression=i.expression||{type:"missing",id:-1},e.expression_error=!i.valid,a&&this.parser.Restore()}RebuildGraphCell(e,t){if(e.spill&&this.options.spill&&(e.spill.start.row===t.row&&e.spill.start.column===t.column?this.AttachSpillData(new k(e.spill.start,e.spill.end)):this.AddEdge(e.spill.start,t)),e.area&&e.area.start.column===t.column&&e.area.start.row===t.row){let{start:r,end:a}=e.area,i=r.sheet_id||t.sheet_id;r.sheet_id||(r.sheet_id=i);for(let s=r.column;s<=a.column;s++)for(let o=r.row;o<=a.row;o++)this.ResetInbound({column:s,row:o,sheet_id:i},!0,!1);this.SetDirty(t);for(let s=r.column;s<=a.column;s++)for(let o=r.row;o<=a.row;o++)o===r.row&&s===r.column||this.AddEdge(r,{...r,row:o,column:s})}if(e.type===1){this.ResetInbound(t,!0);let r=this.parser.Parse(e.value);if(r.expression){if(r.expression.type==="call"){let s=this.library.Get(r.expression.name);s&&(s.render||s.click)&&(e.render_function=s.render,e.click_function=s.click)}let i=this.RebuildDependencies(r.expression,t.sheet_id,"",void 0,t);for(let s of Object.keys(i.ranges)){let o=i.ranges[s],n=new k(o.start,o.end);if(n.entire_row||n.entire_column)this.AddArrayEdge(n,t);else for(let l of n)this.AddEdge(l,t)}for(let s of Object.keys(i.addresses)){let o=i.addresses[s];this.AddEdge(o,t)}}let a=this.GetVertex(t,!0);a&&(a.expression=r.expression||{type:"missing",id:-1},a.expression_error=!r.valid)}else e.value!==e.calculated?this.ResetInbound(t,!0,!1):e.type===0&&this.ResetInbound(t,!0,!1,!0)}RebuildGraph(e){if(e){if(!e.start.sheet_id)throw new Error("subset missing sheet id");let t=this.model.sheets.Find(e.start.sheet_id)?.cells;if(t)for(let r=e.start.row;r<=e.end.row;r++){let a=t.data[r];if(a)for(let i=e.start.column;i<=e.end.column;i++){let s=a[i];s&&this.RebuildGraphCell(s,{row:r,column:i,sheet_id:e.start.sheet_id})}}}else for(let t of this.model.sheets.list||[]){let r=t.cells.data.length;for(let a=0;a<r;a++){let i=t.cells.data[a];if(i){let s=i.length;for(let o=0;o<s;o++){let n=i[o];n&&this.RebuildGraphCell(n,{row:a,column:o,sheet_id:t.id})}}}}}CheckVolatile(e){if(!e.expression||e.expression_error)return!1;let t=!1;return this.parser.Walk(e.expression,r=>{if(r.type==="call"){let a=this.library.Get(r.name);a&&a.volatile&&(t=!0)}return!t}),t}},sl=class{model={};layout_element;visible_=!1;timeout=0;pending_dialog_resoltion=[];options_={type:"initial"};set options(e){if(e.type==="about"&&(e.close_box=!0,e.icon=!0),this.options_.icon!==e.icon&&(this.model.left.style.display=e.icon?"block":"none"),this.options_.close_box!==e.close_box&&(this.model.close.style.display=e.close_box?"block":"none"),this.options_.message!==e.message&&(this.model.message.textContent=e.message||"",this.model.message.style.display=e.message?"block":"none"),this.options_.title!==e.title&&(this.model.title.textContent=e.title||"",this.model.title.style.display=e.title?"block":"none"),this.options_.type!==e.type){let t=this.model.dialog.className.replace(/dialog-type-\S+/g,"").trim();e.type&&(t+=` dialog-type-${e.type}`),this.model.dialog.className=t,e.type==="about"?this.model.about.style.display="block":this.model.about.style.display="none"}this.options_=e}event_handler=e=>{(e.key==="Escape"||e.key==="Esc")&&(e.stopPropagation(),e.preventDefault(),this.visible=!1)};get visible(){return this.visible_}set visible(e){if(e!==this.visible_)if(this.visible_=e,e)this.layout_element?.setAttribute("dialog",""),window.addEventListener("keydown",this.event_handler);else{this.layout_element?.removeAttribute("dialog"),window.removeEventListener("keydown",this.event_handler);let t=this.pending_dialog_resoltion.slice(0);this.pending_dialog_resoltion=[],Promise.resolve().then(()=>{for(let r of t)r()})}}constructor(e){this.layout_element=e.parentElement;let t=this.layout_element?.querySelector(".treb-dialog-mask");if(t){let r=t.querySelectorAll("[data-bind]");for(let a of Array.from(r)){let i=a.dataset.bind;i&&(this.model[i]=a)}}if(this.model.about){let r=["<div>TREB version 32.1.1"];r.push("<small><a target=_blank href='https://treb.app'>http://treb.app</a></small>"),this.model.about.innerHTML=r.join(`
`)}this.model.close?.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),this.HideDialog()})}Node(e){return this.model[e]}Update(e,t=!0){t&&(e={...this.options_,...e}),this.options=e}HideDialog(){this.visible=!1}ShowDialog(e){return new Promise(t=>{this.pending_dialog_resoltion.push(t),this.options=e,this.visible=!0,this.timeout&&(window.clearTimeout(this.timeout),this.timeout=0),e.timeout&&(this.timeout=window.setTimeout(()=>this.HideDialog(),e.timeout))})}},ol=class{constructor(e){this.container=e;let t=le.GetInstance(e.ownerDocument);this.node=t.Div("treb-spinner",e,{html:"<div><div></div><div></div><div></div><div></div></div>"})}node;visible=!1;Show(){this.node.classList.add("visible")}Hide(){this.node.classList.remove("visible")}},nl={formula_bar:!0,in_cell_editor:!0,undo:!0,scrollbars:!0,headers:!0,export:!0,tab_bar:"auto",resizable:!0,hyperlinks:"_blank",max_file_size:94208,tint_theme_colors:!0,dnd:!1,add_tab:!1,expand_formula_button:!1,expand:!0,markdown:!1,spinner:!1,complex:"off",spill:!0},ye=e=>!!e&&typeof e=="object"&&e.key==="metadata"&&!!e.value&&e.value.type==="metadata",qa=e=>!!e&&typeof e=="object"&&e.key==="series"&&typeof e.value=="object",ll=e=>!!e&&typeof e=="object"&&e.type===8&&Array.isArray(e.value),K=class{static Scale(e,t,r=6.5,a,i){return ar(e,t,r,a,i)}static Range(e){let t,r;for(let i of e)typeof i>"u"||((typeof t>"u"||t>i)&&(t=i),(typeof r>"u"||r<i)&&(r=i));let a=typeof t>"u"||typeof r>"u"?0:r-t;return{min:t,max:r,range:a}}static ApplyScale(e,t,r){return t*(e-r.min)/(r.max-r.min)}static Flatten(e){let t=[];if(Array.isArray(e))for(let r of e)Array.isArray(r)?t=t.concat(this.Flatten(r)):t.push(r);else typeof e<"u"&&t.push(e);return t}},hl=e=>{Jr(e,0,e.length)},dl=(e,t,r)=>{let a=e[r-1],i=t;for(let s=t;s<r-1;s+=1)e[s]<=a&&(ja(e,s,i),i+=1);return ja(e,i,r-1),i},ja=(e,t,r)=>{let a=e[t];e[t]=e[r],e[r]=a},Jr=(e,t,r)=>{if(t<r){let a=dl(e,t,r);Jr(e,t,a),Jr(e,a+1,r)}},Wr="#,##0.00",Et=e=>{let t=e[0],r=e[0];for(let a of e)a<t&&(t=a),a>r&&(r=a);return{min:t,max:r}},Ja=e=>{let{label:t,x:r,y:a,z:i,index:s,subtype:o,data_labels:n,axis:l}=e,h={x:{data:[]},y:{data:[]}};if(typeof l=="number"&&(h.axis=l),typeof s=="number"&&(h.index=s),o&&(h.subtype=o.toString()),n){let u=K.Flatten(Array.isArray(n)?n:[n]);h.labels=u.map(m=>typeof m>"u"?"":m.toString())}t&&(h.label=t.toString());let d=(u,m=!1)=>{let f;if(ye(u)&&(u={type:8,value:[[u]]}),ll(u)){f={data:[]};let p=K.Flatten(u.value);if(f.data=p.map(b=>{if(ye(b)){if(typeof b.value.value=="number")return b.value.value}else if(b.type===3)return b.value}),ye(p[0])&&p[0].value?.format&&(f.format=p[0].value.format,m)){let b=V.Get(f.format);f.labels=f.data.map(w=>w===void 0?void 0:b.Format(w))}}return f};h.y=d(a,!0)||{data:[]},h.x=d(r)||{data:[]},h.z=d(i);let c=[h.x,h.y];for(let u of c)if(u.data.length){let m=u.data.filter(f=>f||f===0);u.range=Et(m)}return h},Wa=e=>{let t={x:{data:[]},y:{data:[]}},r=K.Flatten(e.value),a=[];for(let[s,o]of r.entries()){let n=0;if(typeof o.value=="number")n=o.value,a.push(o.value);else if(ye(o))if(Ne(o.value.value))t.x.data[s]=o.value.value.real,n=o.value.value.imaginary;else if(typeof o.value.value=="number")n=o.value.value;else continue;else continue;t.y.data[s]=n,a.push(n)}let i="";if(ye(r[0])&&(i=r[0].value.format||""),i){t.y.format=i;let s=V.Get(t.y.format||"");t.y.labels=t.y.data.map(o=>o===void 0?void 0:s.Format(o))}if(t.y.range=Et(a),t.x.data.length){let s=t.x.data.filter(o=>typeof o=="number");if(t.x.range=Et(s),i){t.x.format=i;let o=V.Get(t.x.format||"");t.x.labels=t.x.data.map(n=>n===void 0?void 0:o.Format(n))}}return t},Ft=(e,t)=>{if(!e)return[];let r=[];if(e.type===5){if(e.key==="group"){if(Array.isArray(e.value)){for(let[s,o]of e.value.entries())if(o&&typeof o=="object")if(qa(o)){let n=Ja(o.value);typeof n.index>"u"&&(n.index=s+1),r.push(n)}else o.type===8&&r.push(Wa(o))}}else if(qa(e)){let s=Ja(e.value);r.push(s)}}else e.type===8&&r.push(Wa(e));let a,i=0;if(t?.type===8){let s=K.Flatten(t.value),o="0.00###";ye(s[0])&&s[0].value.format&&(o=s[0].value.format);let n=s.map(h=>{if(h.type===3)return h.value;if(ye(h)&&typeof h.value.value=="number")return h.value.value}),l=n.filter(h=>typeof h=="number");a={data:n,format:o,range:Et(l)}}for(let s of r)i=Math.max(i,s.y.data.length),s.x.data.length&&(a||(a=s.x));if(!a){a={data:[],range:{min:0,max:Math.max(0,i-1)}};for(let s=0;s<i;s++)a.data.push(s)}for(let s of r)s.x.data.length||(s.x=a);return r},Za=e=>{let t=Math.abs(e.step)%1;if(t){if(Math.log10(Math.abs(t))<-4)return"Scientific";let r=0;for(let i=0;i<e.count;i++){let s=((e.min+e.step*i)%1).toFixed(6).replace(/0+$/,"");r=Math.max(r,s.length-2)}let a="#,##0.";for(let i=0;i<r;i++)a+="0";return a}else return Math.log10(Math.abs(e.step))>=5?"Scientific":"#,##0"},pt=(e,t,r,a,i,s)=>{let o="",n="",l="";for(let M of e)M.axis?M.y.format&&!l&&(l=M.y.format):M.y.format&&!n&&(n=M.y.format),M.x.format&&!o&&(o=M.x.format);let h;e.some(M=>M.label&&M.label.length>0)&&(h=e.map((M,A)=>({label:M.label||`Series ${A+1}`,index:typeof M.index=="number"?M.index:A+1})));let d=e.filter(M=>M.x.range),c=Math.min.apply(0,d.map(M=>M.x.range?.min||0)),u=Math.max.apply(0,d.map(M=>M.x.range?.max||0)),m=d.filter(M=>!M.axis),f=d.filter(M=>M.axis),p=Math.min.apply(0,m.map(M=>M.y.range?.min||0)),b=Math.max.apply(0,m.map(M=>M.y.range?.max||0)),w=-1,y=-1;f.length&&(w=Math.min.apply(0,f.map(M=>M.y.range?.min||0)),y=Math.max.apply(0,f.map(M=>M.y.range?.max||0)));for(let M of e)if(M.z){for(let[A,P]of M.z.data.entries())if(typeof P<"u"){let B=M.x.data[A],z=Math.max(0,P/2);typeof B<"u"&&(c=Math.min(c,B-z),u=Math.max(u,B+z));let q=M.y.data[A];typeof q<"u"&&(p=Math.min(p,q-z),b=Math.max(b,q+z))}}typeof a<"u"&&(c=Math.min(c,a)),typeof t<"u"&&(p=Math.min(p,t)),typeof r<"u"&&(b=Math.max(b,r));let g=K.Scale(c,u,7),v=K.Scale(p,b,7),x=K.Scale(w,y,7);if(w!==y&&v&&x&&v.count!==x.count){let M=Math.max(v.count,x.count),A=v.count<M?v:x;for(let P=A.count;P<M;P+=2)A.max+=A.step,A.count++,A.count<M&&(A.min-=A.step,A.count++)}let _,C,S;if(o){_=[];let M=V.Get(o);for(let A=0;A<=g.count;A++)_.push(M.Format(g.min+A*g.step))}if(!n&&s&&(n=Za(v)),!l&&s&&(l=Za(x)),n){C=[];let M=V.Get(n);for(let A=0;A<=v.count;A++)C.push(M.Format(v.min+A*v.step))}if(l){S=[];let M=V.Get(l);for(let A=0;A<=x.count;A++)S.push(M.Format(x.min+A*x.step))}let R={x:{format:o,scale:g,labels:_},y:{format:n,scale:v,labels:C},legend:h};return w!==y&&(R.y2={format:l,scale:x,labels:S}),R},hr=(e,t,r)=>{for(let a of e){let i={x:V.Get(a.x.format||""),y:V.Get(a.y.format||"")};a.y.labels=[];for(let s=0;s<a.y.data.length;s++){let o=r?r[s]:typeof a.x.data[s]=="number"?i.x.Format(a.x.data[s]):"",n=typeof a.y.data[s]=="number"?i.y.Format(a.y.data[s]):"";a.y.labels[s]=t.replace(/\bx\b/g,o).replace(/\by\b/g,n)}}},cl=e=>{let t=(n,l=0,h=n.length)=>h%2?n[Math.floor(h/2)+l]:(n[h/2+l]+n[h/2-1+l])/2,r=e.length,a=[0,t(e),0];if(r%2){let n=Math.floor(r/2);a[0]=t(e,0,Math.ceil(r/2)),a[2]=t(e,n,e.length-n)}else a[0]=t(e,0,r/2),a[2]=t(e,r/2,e.length-r/2);let i=a[2]-a[0],s=[0,0],o=0;for(let n=0;n<r;n++)o+=e[n];for(let n=0;n<r;n++){let l=e[n];if(l>=a[0]-i*1.5){s[0]=l;break}}for(let n=r-1;n>=0;n--){let l=e[n];if(l<=a[2]+i*1.5){s[1]=l;break}}return{data:e,quartiles:a,whiskers:s,iqr:i,n:r,mean:r?o/r:0,min:e[0],max:e[r-1]}},us=e=>{let t=Ft(e[0]),r=pt(t,void 0,void 0,void 0,void 0,!0),a=0,i=!!e[2],s=t.map(d=>{let c=[];for(let m of d.y.data)m!==void 0&&c.push(m);hl(c);let u=cl(c);return a=Math.max(a,u.n),i&&(u.whiskers[0]=u.min,u.whiskers[1]=u.max),u}),o=e[1]?.toString()||void 0,n=[],l=[],h=V.Get("#,##0");for(let[d,c]of s.entries()){n.push(h.Format(c.n));let u=t[d];l.push(u.label||`Series ${d+1}`)}return{type:"box",series:t,title:o,max_n:a,data:s,x_labels:n,series_names:t.some(d=>!!d.label)?l:void 0,scale:r.y.scale,y_labels:r.y.labels}},ul=e=>{let t=Ft(e[0]),r,a;for(let o of t)typeof o.x.range?.min=="number"&&o.x.range.min>0&&o.x.range.min<50&&(a=0),typeof o.y.range?.min=="number"&&o.y.range.min>0&&o.y.range.min<50&&(r=0);let i=pt(t,r,void 0,a),s=e[1]?.toString()||void 0;return{legend:i.legend,legend_style:2,type:"bubble",series:t,title:s,x_scale:i.x.scale,x_labels:i.x.labels,y_scale:i.y.scale,y_labels:i.y.labels}},Ka=(e,t="plot")=>{let r=Ft(e[0]),a=pt(r),i=e[1]?.toString()||void 0,s=e[2]?.toString()||void 0,o={legend:a.legend,style:t,type:"scatter2",series:r,title:i,x_scale:a.x.scale,x_labels:a.x.labels,y_scale:a.y.scale,y_labels:a.y.labels,y2_scale:a.y2?.scale,y2_labels:a.y2?.labels,lines:t==="line",points:t==="plot"};if(s){o.markers=/marker/i.test(s),o.smooth=/smooth/i.test(s),o.data_labels=/labels/i.test(s);let n=s.match(/labels="(.*?)"/);n&&o.series?hr(o.series,n[1]):(n=s.match(/labels=([^\s\r\n,]+)(?:\W|$)/),n&&o.series&&hr(o.series,n[1])),n=s.match(/class=([\w_-]+)(?:\W|$)/),n&&(o.class_name=n[1])}return o},Xa=(e,t)=>{let[r,a,i,s]=e,o=Ft(r),n=pt(o),l;if(a){l=(a.type===8?K.Flatten(a.value):K.Flatten(a)).map(m=>!m||!m.value?"":ye(m)?typeof m.value.value=="number"?V.Get(m.value.format||Wr).Format(m.value.value):m.value.value?.toString()||"":typeof m.value=="number"?V.Get(Wr).Format(m.value):m.value.toString());let u=o.reduce((m,f)=>Math.max(m,f.y.data.length),0);for(u<l.length&&(l=l.slice(0,u));u>l.length;)l.push("")}let h=i?.toString()||void 0,d=s?.toString()||void 0,c={type:t,legend:n.legend,legend_style:1,series2:o,scale:n.y.scale,title:h,y_labels:t==="bar"?l:n.y.labels,x_labels:t==="bar"?n.y.labels:l};if(d){c.round=/round/i.test(d),c.data_labels=/labels/i.test(d);let u=d.match(/labels="(.*?)"/);u&&o?hr(o,u[1],l):(u=d.match(/labels=([^\s\r\n,]+)(?:\W|$)/),u&&o&&hr(o,u[1],l)),u=d.match(/class=([\w_-]+)(?:\W|$)/),u&&(c.class_name=u[1])}return c},Qa=(e,t)=>{let r=Ft(e[0],e[1]),a=pt(r,0,0),i=e[2]?.toString()||void 0,s=e[3]?.toString()||void 0,o={legend:a.legend,type:"scatter2",series:r,title:i,x_scale:a.x.scale,x_labels:a.x.labels,y_scale:a.y.scale,y_labels:a.y.labels,lines:!0,filled:t==="area"};if(s){o.smooth=/smooth/i.test(s);let n=s.match(/class=([\w_-]+)(?:\W|$)/);n&&(o.class_name=n[1])}return o},ml=(e,t=!1)=>{let[r,a,i,s,o]=e,n=e[0]?.type===8?e[0].value:e[0],l=n?K.Flatten(n):[],h=l.map(x=>{if(ye(x)&&typeof x.value.value=="number")return x.value.value}),d=e[1]?.type===8?e[1].value:e[1],c=K.Flatten(d||[]).map(x=>ye(x)?typeof x.value.value=="number"&&x.value.format?V.Get(x.value.format).Format(x.value.value):x.value.value?.toString()||"":x.value?.toString()||""),u=!1;h=h.map(x=>x&&x<0?(u||(console.warn("pie/donut chart does not support negative values (omitted)"),u=!0),0):x);let m=0,f=h.map((x,_)=>(typeof x<"u"&&(m+=x),{value:x||0,label:c[_]||"",index:_+1,percent:0}));if(m)for(let x of f)x.percent=(x.value||0)/m;let p="";for(let x of l)if(ye(x)){p=x.value.format||"";break}let b=V.Get(p||Wr),w=V.Get("percent");typeof e[4]>"u"&&e[1]&&(e[4]="label");let y=e[4]||"";if(y)for(let x of f){let _=b.Format(x.value||0),C=w.Format(x.percent);x.title=y.replace(/value%/ig,w.Format(x.value||0)).replace(/value/ig,_).replace(/percent/ig,C).replace(/label/ig,x.label||"").trim()}let g=(s||"").toUpperCase();if(g==="ASC"||g==="ASCENDING"||g==="INC")f.sort((x,_)=>(x.value||0)-(_.value||0));else if(g==="DESC"||g==="DESCENDING"||g==="DEC")f.sort((x,_)=>(_.value||0)-(x.value||0));else{let x=(s||"").match(/sort=([\w]+)(?:\W|$)/i);x&&(g=x[1],/^(asc|inc)/i.test(g)?f.sort((_,C)=>(_.value||0)-(C.value||0)):/^(desc|dec)/i.test(g)&&f.sort((_,C)=>(C.value||0)-(_.value||0)))}let v={type:t?"pie":"donut",slices:f,title:i||""};if(s){let x=s.match(/class=([_-\w]+)(?:\W|$)/);x&&(v.class_name=x[1])}return v},zt=class{constructor(e=0,t=0,r=100,a=100){this.left=e,this.top=t,this.right=r,this.bottom=a}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return{x:this.left+this.width/2,y:this.top+this.height/2}}},fl="http://www.w3.org/2000/svg",E=(e,t={},r)=>{let a=document.createElementNS(fl,e);for(let i of Object.keys(t))if(t[i]!==void 0){let s=t[i]??"";a.setAttribute(i,Array.isArray(s)?s.join(" "):s.toString())}return r&&(a.textContent=r),a},pl=class{parent;svg_node;text_measurement_node;container_group;group;axis_group;label_group;size={width:0,height:0};bounds=new zt;constructor(){this.container_group=E("g"),this.group=E("g"),this.axis_group=E("g",{class:"axis-group"}),this.label_group=E("g",{class:"label-group"}),this.container_group.appendChild(this.axis_group),this.container_group.appendChild(this.group),this.container_group.appendChild(this.label_group)}Initialize(e){this.parent=e,this.svg_node=E("svg",{class:"treb-chart"}),this.svg_node.style.overflow="hidden",this.svg_node.style.position="relative",this.svg_node.style.width="100%",this.svg_node.style.height="100%",this.svg_node.appendChild(this.container_group),this.parent.appendChild(this.svg_node),this.Resize()}Legend(e){let t=E("g");this.group.appendChild(t);let r=E("text");t.appendChild(r),t.setAttribute("class","legend");let a=[[]],i=10,s=e.area.width,o=0,n=0,l=e.area.width,h=e.style===1?14:26,d=e.labels.map((p,b)=>{r.textContent=p.label;let w=r.getBoundingClientRect(),y={width:w.width,height:w.height},g=y.width+h+i;return n=Math.max(n,y.height),e.layout===1?a[b]=[b]:g>s?a[o].length===0?(a[o].push(b),o++,a[o]=[],s=l):(o++,a[o]=[b],s=l-g):(a[o].push(b),s-=g),y});t.removeChild(r);let c=n,u=e.layout||0;u===0&&a.every(p=>p.length<=1)&&(u=0);for(let p=0;p<a.length;p++){let b=a[p].reduce((g,v)=>g+d[v].width+h,(a[p].length-1)*i),w=0,y=Math.round(u===0?(l-b)/2:i/2);for(let g=0;g<a[p].length;g++){let v=a[p][g],x=d[v],_=e.labels[v],C=c-1,S=!1;typeof navigator<"u"&&(S=/trident/i.test(navigator?.userAgent||""));let R=typeof _.index=="number"?_.index:v+1;switch(t.appendChild(E("text",{"dominant-baseline":"middle",x:y+h,y:c,dy:S?".3em":void 0},_.label)),e.style){case 1:t.appendChild(E("rect",{class:`series-${R}`,x:y,y:C-4,width:8,height:8}));break;case 2:t.appendChild(E("circle",{class:`series-${R}`,cx:y+h-11,cy:C-4+3}));break;default:t.appendChild(E("rect",{class:`series-${R}`,x:y,y:C-1,width:h-3,height:2}));break}w=Math.max(w,x.height),y+=x.width+h+i}c=Math.round(c+w*1.1)}let m=t.getBoundingClientRect(),f={width:m.width,height:m.height+n};switch(e.position){case 1:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.bottom-f.height})`);break;case 2:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`);break;case 3:t.setAttribute("transform",`translate(${e.area.right-f.width}, ${e.area.top})`);break;case 0:default:t.setAttribute("transform",`translate(${e.area.left}, ${e.area.top})`)}e.position===0?e.area.top+=f.height||0:e.position===3?e.area.right-=(f.width||0)+8:e.position===2?e.area.left+=(f.width||0)+8:e.area.bottom-=f.height||0}Clear(e){this.group.textContent="",this.axis_group.textContent="",this.label_group.textContent="",e="treb-chart"+(e?" "+e:""),this.svg_node.setAttribute("class",e)}Resize(){let e=this.svg_node.getBoundingClientRect();this.svg_node.setAttribute("width",e.width.toString()),this.svg_node.setAttribute("height",e.height.toString()),this.size={width:e.width,height:e.height}}Prerender(){let e=this.svg_node.getBoundingClientRect();this.bounds.top=e.top,this.bounds.left=e.left,this.bounds.right=e.right,this.bounds.bottom=e.bottom}RenderTitle(e,t,r,a){let i=E("text",{class:"chart-title",x:Math.round(t.width/2)},e);i.style.textAnchor="middle",this.group.appendChild(i);let s=i.getBoundingClientRect();switch(a){case"bottom":i.setAttribute("y",Math.round(t.bottom-s.height).toString()),t.bottom-=s.height+r;break;default:i.setAttribute("y",Math.round(t.top+r+s.height).toString()),t.top+=s.height+r;break}}MeasureText(e,t,r=!1){this.text_measurement_node||(this.text_measurement_node=E("text",{x:"-100px",y:"-100px"}),this.svg_node.appendChild(this.text_measurement_node)),typeof t<"u"?(typeof t=="string"&&(t=[t]),this.text_measurement_node.setAttribute("class",t.join(" "))):this.text_measurement_node.setAttribute("class",""),this.text_measurement_node.textContent=e;let a=this.text_measurement_node.getBoundingClientRect(),i={width:a.width,height:a.height,y_offset:a.height-(this.bounds.top-a.top-100)};return r&&(i.width=Math.ceil(i.width),i.height=Math.ceil(i.height),i.y_offset=Math.ceil(i.y_offset)),i}RenderTicks(e,t,r,a,i){let s=[],o=e.width/a;for(let n=0;n<a;n++){let l=Math.round(e.left+o/2+o*n)-.5;s.push(`M${l} ${t} L${l} ${r}`)}this.group.appendChild(E("path",{d:s,class:i}))}RenderXAxisBar(e,t,r,a,i){let s=r.length;if(!s)return;let o=4,n=t?e.width/s:e.width/(s-1),l=t?n/2:0,h=1,d=!0;for(;d;){d=!1;let c=0;for(let u=0;u<s;u+=h){let m=Math.round(e.left+l+n*u),f=m-a[u].width/2;if(c&&f<=c){h++,d=!0;break}c=m+a[u].width/2+o}}for(let c=0;c<s;c+=h){let u=Math.round(e.left+l+n*c);this.RenderText(this.axis_group,r[c],"center",{x:u,y:e.bottom},i)}}RenderXAxisTicks(e,t,r){let a=t?e.width/r:e.width/(r-1),i=t?a/2:0,s=[];for(let o=0;o<r;o++){let n=Math.round(e.left+i+a*o)+.5;s.push(`M${n},${e.bottom+.5} v6`)}this.axis_group.appendChild(E("path",{d:s.join(" "),class:"x-axis-tick axis-tick"}))}RenderXAxis(e,t,r,a,i){let s=r.length;if(!s)return;let o=4,n=t?e.width/s:e.width/(s-1),l=t?n/2:0,h=1,d=!0,c=(r.length-1)%2===0,u=(r.length-1)%3===0;for(;d;){d=!1;let m=0;for(let f=0;f<s;f+=h){let p=Math.round(e.left+l+n*f),b=p-a[f].width/2;if(m&&b<=m){h++,d=!0;break}m=p+a[f].width/2+o}}h===3&&!u&&c&&h++;for(let m=0;m<s;m+=h){let f=Math.round(e.left+l+n*m);this.RenderText(this.axis_group,r[m],"center",{x:f,y:e.bottom},i)}}RenderYAxisBar(e,t,r,a){r=r.slice(0),r.reverse();let i=r.length;if(!i)return;let s=e.height/i,o=1,n=!0;for(;n;){n=!1;let l=0;for(let h=0;h<i;h+=o){let d=r[h],c=Math.round(e.bottom-s*(h+.5)+d.metrics.height/4);if(l&&c>=l){o++,n=!0;break}l=c-d.metrics.height}}for(let l=0;l<i;l+=o){let h=r[l],d=Math.round(e.bottom-s*(l+.5)+h.metrics.height/4);this.RenderText(this.axis_group,h.label,"right",{x:t,y:d},a)}}RenderYAxis(e,t,r,a,i="right"){let s=r.length;if(!s)return;let o=e.height/(s-1),n=1,l=!0;for(;l;){l=!1;let h=0;for(let d=0;d<s;d+=n){let c=r[d],u=Math.round(e.bottom-o*d+c.metrics.height/4);if(h&&u>=h){n++,l=!0;break}h=u-c.metrics.height}}for(let h=0;h<s;h+=n){let d=r[h],c=Math.round(e.bottom-o*h+d.metrics.height/4);this.RenderText(this.axis_group,d.label,i,{x:t,y:c},a)}}LineProperties(e,t){let r=t.x-e.x,a=t.y-e.y;return{length:Math.sqrt(r*r+a*a),angle:Math.atan2(a,r)}}RenderSmoothLine(e,t,r=!1,a,i){let s=E("g"),o=[],n=[],l=t.length,h=l-1,d=e.width/l/2,c=[],u=t.map((p,b)=>{if(!(typeof p>"u"))return{x:Math.round(e.left+e.width/h*b),y:e.bottom-p}}),m=[],f=()=>{if(m.length<2)return;let p="",b=m[0],w=m[m.length-1];m.length===2?p=`${m[0].x},${m[0].y} L${m[1].x},${m[1].y}`:m.length>2&&(p=""+this.CatmullRomChain(m).map(y=>`${y.x},${y.y}`).join(" L")),p&&(o.push("M"+p),r&&(n.push(`M ${b.x},${e.bottom} L ${b.x},${b.y}`),n.push("L"+p),n.push(`L ${w.x},${e.bottom}`)))};for(let p of u)p?m.push(p):(f(),m=[]);if(m.length&&f(),r&&s.appendChild(E("path",{class:"fill",d:n})),s.appendChild(E("path",{class:"line",d:o})),typeof i<"u"&&(typeof i=="string"&&(i=[i]),s.setAttribute("class",i.join(" "))),this.group.appendChild(s),a&&c.length){let p=E("g");for(let b of c){let w=E("circle",{cx:b.x,cy:b.y,r:d});w.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",a[b.i]||"")}),w.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")}),p.appendChild(w)}p.setAttribute("class","mouse-layer"),this.group.appendChild(p)}}RenderLine(e,t,r=!1,a,i){let s=E("g"),o=[],n=[],l=t.length,h=l-1,d=e.width/l/2,c=[],u=0,m=!0,f;for(;u<l;u++){let p=t[u];if(typeof p>"u"){m=!0,r&&typeof f<"u"&&n.push(`L${f} ${e.bottom}Z`),f=void 0;continue}let b=Math.round(+e.left+e.width/h*u);m?(r&&n.push(`M${b} ${e.bottom} L${b} ${e.bottom-p}`),o.push(`M${b} ${e.bottom-p}`)):(o.push(`L${b} ${e.bottom-p}`),n.push(`L${b} ${e.bottom-p}`)),c.push({x:b,y:e.bottom-p,i:u}),f=b,m=!1}if(r&&typeof f<"u"&&n.push(`L${f} ${e.bottom}Z`),r&&s.appendChild(E("path",{class:"fill",d:n})),s.appendChild(E("path",{class:"line",d:o})),typeof i<"u"&&(typeof i=="string"&&(i=[i]),s.setAttribute("class",i.join(" "))),this.group.appendChild(s),a&&c.length){let p=E("g");for(let b of c){let w=E("circle",{cx:b.x,cy:b.y,r:d});w.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",a[b.i]||"")}),w.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")}),p.appendChild(w)}p.setAttribute("class","mouse-layer"),this.group.appendChild(p)}}RenderBarGrid(e,t,r){let a=[],i=e.width/t;for(let s=0;s<=t;s++){let o=Math.round(e.left+i*s)-.5;a.push(`M${o} ${e.top} L${o} ${e.bottom}`)}this.group.appendChild(E("path",{d:a,class:r}))}RenderGrid(e,t,r=0,a,i){let s=[],o=[],n=e.height/t;for(let l=0;l<=t;l++){let h=Math.round(e.top+n*l)-.5;i&&i[1]===l?o.push(`M${e.left} ${h} L${e.right} ${h}`):s.push(`M${e.left} ${h} L${e.right} ${h}`)}n=e.width/(r-1);for(let l=0;l<r;l++){let h=Math.round(e.left+n*l)-.5;i&&i[0]===l?o.push(`M${h} ${e.top} L${h} ${e.bottom}`):s.push(`M${h} ${e.top} L${h} ${e.bottom}`)}this.group.appendChild(E("path",{d:s,class:a})),o.length&&(a?Array.isArray(a)?a.push("zero"):a=a+" zero":a="zero",this.group.appendChild(E("path",{d:o,class:a})))}MultiplyPoint(e,t){return{x:e.x*t,y:e.y*t}}AddPoints(e,t){return{x:e.x+t.x,y:e.y+t.y}}CatmullRomSpline(e,t){let r=.5;r=r/2;let a=(d,c,u)=>{let{x:m,y:f}=c,{x:p,y:b}=u;return((p-m)**2+(b-f)**2)**r+d},i=0,s=a(i,e[0],e[1]),o=a(s,e[1],e[2]),n=a(o,e[2],e[3]),l=(o-s)/t,h=[];for(let d=0;d<t;d++){let c=s+l*d,u=this.AddPoints(this.MultiplyPoint(e[0],(s-c)/(s-i)),this.MultiplyPoint(e[1],(c-i)/(s-i))),m=this.AddPoints(this.MultiplyPoint(e[1],(o-c)/(o-s)),this.MultiplyPoint(e[2],(c-s)/(o-s))),f=this.AddPoints(this.MultiplyPoint(e[2],(n-c)/(n-o)),this.MultiplyPoint(e[3],(c-o)/(n-o))),p=this.AddPoints(this.MultiplyPoint(u,(o-c)/(o-i)),this.MultiplyPoint(m,(c-i)/(o-i))),b=this.AddPoints(this.MultiplyPoint(m,(n-c)/(n-s)),this.MultiplyPoint(f,(c-s)/(n-s))),w=this.AddPoints(this.MultiplyPoint(p,(o-c)/(o-s)),this.MultiplyPoint(b,(c-s)/(o-s)));h.push(w)}return h}CatmullRomChain(e,t=30){let r=e.slice(0),a=[],i=r.length;if(i){let s=r[i-1].x-r[i-2].x,o=r[i-1].y-r[i-2].y;r.push({x:r[i-1].x+s,y:r[i-1].y+o}),r.push({x:r[i-1].x+s,y:r[i-1].y+o}),s=r[1].x-r[0].x,o=r[1].y-r[0].y,r.unshift({x:r[0].x-s,y:r[0].y-o});for(let n=0;n<r.length-4;n++){let l=r.slice(n,n+4),h=this.CatmullRomSpline(l,t);a.push(...h)}}return a}RenderDataLabels(e,t,r,a,i,s,o){let n=Math.max(t.length,r.length),l=a.max-a.min||1,h=i.max-i.min||1;for(let d=0;d<n;d++){let c=t[d],u=r[d];if(c!==void 0&&u!==void 0){let m={x:e.left+(c-a.min)/l*e.width,y:e.bottom-(u-i.min)/h*e.height},f=s[d];if(f){this.label_group.appendChild(E("circle",{class:"label-target",cx:m.x,cy:m.y,r:10}));let p=E("g",{class:"data-label",transform:`translate(${m.x+10},${m.y})`});this.label_group.appendChild(p);let b=E("circle",{cx:-10,y:0,r:5,class:`marker-highlight series-${o}`});p.appendChild(b);let w=E("text",{x:4,y:0},f);p.appendChild(w);let y=w.getBoundingClientRect(),g=y.height,v=y.width+8;v+15+m.x>=e.right&&(p.setAttribute("transform",`translate(${m.x-v-15},${m.y})`),b.setAttribute("cx",(v+15).toString()));let x=E("path",{d:`M0,5 h${v} v-${g} h-${v} Z`});p.insertBefore(x,w)}}}}RenderBoxAndWhisker(e,t,r,a,i,s,o){let n=E("g",{class:o});this.group.appendChild(n);let l=e.width/s,h=l*.2,d=Math.min(l-2*h,90);a>0&&(d=d*Math.sqrt(t.n)/Math.sqrt(a));let c=p=>e.top+e.height-(p-i.min)/(i.max-i.min)*e.height,u=e.left+r*l+l/2,m=c(t.quartiles[0]),f=c(t.quartiles[2]);n.appendChild(E("rect",{class:"iqr",x:e.left+r*l+(l-d)/2,y:f,width:d,height:m-f})),n.appendChild(E("line",{class:"median",x1:u-d*.5,x2:u+d*.5,y1:c(t.quartiles[1]),y2:c(t.quartiles[1])})),n.appendChild(E("line",{class:"whisker",x1:u-d*.25,x2:u+d*.25,y1:c(t.whiskers[0]),y2:c(t.whiskers[0])})),n.appendChild(E("line",{class:"whisker-extent",x1:u,x2:u,y1:c(t.whiskers[0])-2,y2:c(t.quartiles[0])+2})),n.appendChild(E("line",{class:"whisker",x1:u-d*.25,x2:u+d*.25,y1:c(t.whiskers[1]),y2:c(t.whiskers[1])})),n.appendChild(E("line",{class:"whisker-extent",x1:u,x2:u,y1:c(t.whiskers[1])+2,y2:c(t.quartiles[2])-2}));for(let p of t.data)(p<t.whiskers[0]||p>t.whiskers[1])&&n.appendChild(E("circle",{class:"outlier",cx:u,cy:c(p),r:3}))}RenderBubbleSeries(e,t,r,a,i){let s=r.max-r.min||1,o=a.max-a.min||1,n=[],l=[],h=E("g",{class:i});if(this.group.appendChild(h),t.z)for(let[d,c]of t.z.data.entries()){let u=t.x.data[d],m=t.y.data[d];if(typeof u<"u"&&typeof m<"u"&&typeof c<"u"&&c>0){let f=c/s*e.width,p=c/o*e.height,b=Math.max(f,p),w={x:e.left+(u-r.min)/s*e.width,y:e.bottom-(m-a.min)/o*e.height,z:b};if(n.push(w),t.labels?.[d]){let y=w.z/2;l.push({x:w.x,y:w.y,text:t.labels?.[d]||"",offset:Math.cos(Math.PI/4)*y})}}}for(let d of n)d&&h.appendChild(E("circle",{cx:d.x,cy:d.y,r:d.z/2,class:"point"}));if(l.length){let d=this.label_group.getBoundingClientRect();for(let c of l)if(c.text){let u=this.label_group.appendChild(E("g",{class:"bubble-label"})),m=u.appendChild(E("rect",{x:c.x,y:c.y,class:"label-background"})),f=u.appendChild(E("text",{x:c.x,y:c.y,offset:c.offset,class:"label-text","text-anchor":"middle","alignment-baseline":"middle",style:`--translate-offset: ${Math.round(c.offset)}px`},c.text)).getBoundingClientRect();m.setAttribute("x",(f.left-d.left-2).toString()),m.setAttribute("y",(f.top-d.top-1).toString()),m.style.height=f.height+2+"px",m.style.width=f.width+4+"px"}}}RenderScatterSeries(e,t,r,a,i,s=!0,o=!1,n=!1,l=!1,h=!1,d){let c=Math.max(t.length,r.length),u=a.max-a.min||1,m=i.max-i.min||1,f=[],p=[],b=[],w=E("g",{class:d});this.group.appendChild(w);for(let y=0;y<c;y++){let g=t[y],v=r[y];typeof g>"u"||typeof v>"u"?f.push(void 0):f.push({x:e.left+(g-a.min)/u*e.width,y:e.bottom-(v-i.min)/m*e.height})}if(s){let y=[],g=h?()=>y.length===2?`${y[0].x},${y[0].y} L${y[1].x},${y[1].y}`:y.length>2?this.CatmullRomChain(y).map(v=>`${v.x},${v.y}`).join(" L"):"":()=>y.map(v=>`${v.x},${v.y}`).join(" L");for(let v of f)if(v)y.push(v);else{if(y.length>=2){let x=g();p.push("M"+x),b.push(`M${y[0].x},${e.bottom}L`+x+`L${y[y.length-1].x},${e.bottom}Z`)}y=[]}if(y.length>=2){let v=g();p.push("M"+v),b.push(`M${y[0].x},${e.bottom}L`+v+`L${y[y.length-1].x},${e.bottom}Z`)}}if(n&&w.appendChild(E("path",{d:b,class:"fill"})),s&&w.appendChild(E("path",{d:p,class:"line"})),o)for(let y of f)y&&w.appendChild(E("circle",{cx:y.x,cy:y.y,r:1,class:"point"}));if(l)for(let y of f)y&&w.appendChild(E("circle",{cx:y.x,cy:y.y,r:3,class:"marker"}))}RenderPoints(e,t,r,a){let i=[];for(let s=0;s<t.length;s++){let o=t[s]*e.width+e.left,n=e.bottom-r[s]*e.height;i.push(`M${o-1},${n-1} L${o+1},${n+1}`),i.push(`M${o-1},${n+1} L${o+1},${n-1}`)}this.group.appendChild(E("path",{d:i,class:a}))}RenderPoint(e,t,r){this.group.appendChild(E("circle",{cx:e,cy:t,r:1,class:r}))}RenderCalloutLines(e){let t=E("g",{class:"callouts"});this.label_group.appendChild(t);for(let r of e)t.appendChild(E("path",{d:`M${r.x1},${r.y1} L${r.x2},${r.y2}`,class:"callout "+(r.classes||"").trim()}))}RenderRectangle(e,t,r,a,i,s){let o="";if(t)if(t[0]&&t[0]===t[1]&&t[0]>=e.height){let l=t[0],h=t[0]-e.height,d=Math.sqrt(l*l-h*h);o=`M${e.left+e.width/2-d},${e.bottom} a${l},${l} 0 0 1 ${d*2},0 z`}else if(t[1]&&t[1]===t[2]&&t[1]>=e.width){let l=t[1],h=t[1]-e.width,d=Math.sqrt(l*l-h*h);o=`M${e.left},${e.top+e.height/2-d} a${l},${l} 0 0 1 0,${d*2} z`}else o=`M${e.left},${e.top+t[0]} a${t[0]},${t[0]} 0 0 1 ${t[0]},${-t[0]} h${e.width-t[0]-t[1]} a${t[1]},${t[1]} 0 0 1 ${t[1]},${t[1]} v${e.height-t[1]-t[2]} a${t[2]},${t[2]} 0 0 1 ${-t[2]},${t[2]} h${-e.width+t[2]+t[3]} a${t[3]},${t[3]} 0 0 1 ${-t[3]},${-t[3]} v${-e.height+t[3]+t[0]} `;else o=`M${e.left},${e.top} h${e.width} v${e.height} h${-e.width} v${-e.height} `;let n=E("path",{d:o,class:r});if(a&&(n.addEventListener("mouseenter",()=>{this.parent.setAttribute("title",a)}),n.addEventListener("mouseleave",()=>{this.parent.setAttribute("title","")})),this.group.appendChild(n),i){this.label_group.appendChild(E("path",{class:"label-target",d:o}));let l=s||{x:Math.round(e.left+e.width/2),y:Math.round(e.top-10)},h=E("g",{class:"data-label",transform:`translate(${l.x},${l.y})`});this.label_group.appendChild(h);let d=E("text",{x:0,y:0},i);h.appendChild(d);let c=d.getBoundingClientRect(),u=c.height,m=c.width+8;l.y-c.height<4&&(l.y-=l.y-c.height-4,h.setAttribute("transform",`translate(${l.x},${l.y})`)),d.setAttribute("x",Math.floor(-c.width/2).toString());let f=Math.ceil(u*.125),p=E("rect",{rx:3,x:-m/2,y:Math.round(-u+f*2/3),width:m,height:u+f});h.insertBefore(p,d)}}RenderText(e,t,r,a,i){let s=E("text",{x:a.x,y:a.y,class:i},t);switch(r){case"right":s.style.textAnchor="end";break;case"center":s.style.textAnchor="middle";break;default:s.style.textAnchor="start";break}(e||this.group).appendChild(s)}RenderDonut(e,t,r,a,i,s,o){let n=-Math.PI/2,l=0;s&&(r*=.8,a*=.7);let h=(d,c,u)=>[Math.cos(u)*c+d.x,Math.sin(u)*c+d.y];for(let d of e){let c=d.title||"",u=d.percent,m=d.index,f=[],p=0,b=h.bind(0,t,r),w=h.bind(0,t,a);if(u>.5){p=n+u/2*Math.PI*2,l=n+u*Math.PI*2;let v=p-n,x=l-p;f.push(`M${b(n)}`,`A${r},${r},${v},0,1,${b(p)}`,`A${r},${r},${x},0,1,${b(l)}`,`L${w(l)}`,`A${a},${a},${x},0,0,${w(p)}`,`A${a},${a},${v},0,0,${w(n)}`,"Z")}else{l=n+u*Math.PI*2,p=(l-n)/2+n;let v=l-n;f.push(`M${b(n)}`,`A${r},${r},${v},0,1,${b(l)}`,`L${w(l)}`,`A${a},${a},${v},0,0,${w(n)}`,"Z")}let y=E("path",{d:f,class:typeof m>"u"?void 0:`series-${m}`});typeof m<"u"&&y.setAttribute("data-index",m.toString());let g=E("g",{class:o});if(g.appendChild(y),this.group.appendChild(g),u>=.05&&c){let v=r-a;f=[];let x=h(t,a+(r-a)/2+v,p);f.push(`M${h(t,a+(r-a)/2,p)}`),f.push(`L${x}`),g.appendChild(E("path",{d:f,class:"callout"}));let _=[],C=E("text",{class:"callout-label"});g.appendChild(C);let S=p+Math.PI/2,R=c;C.textContent=R;let M=C.getBoundingClientRect(),A={width:M.width,height:M.height},[P,B]=x;P+=A.height/2*Math.cos(p),B+=A.height/4+A.height/2*Math.sin(p);let z=!1;S>Math.PI?P-A.width<=i.left&&(z=!0):P+A.width>i.right&&(z=!0);let q=/[\s-]/;if(z&&q.test(R)){let O=-1,X=1;for(let J=0;J<R.length;J++)if(q.test(R[J])){let I=Math.abs(.5-J/R.length);I<X&&(X=I,O=J)}O>0&&(_.push(R.substr(0,O+1).trim()),_.push(R.substr(O+1).trim()))}if(_.length){let O=0,X=0,J=_.map(I=>{C.textContent=I,M=C.getBoundingClientRect();let W={width:M.width,height:M.height};return X=Math.max(X,W.width),{text:I,metrics:W}});C.textContent="";for(let I of J){let W=E("tspan");W.textContent=I.text;let we=S>Math.PI?P-(X-I.metrics.width)/2:P+(X-I.metrics.width)/2;W.setAttribute("x",we.toString()),W.setAttribute("dy",O.toString()),C.appendChild(W),O=I.metrics.height}}let D=S>Math.PI?"end":"start";C.setAttribute("text-anchor",D),C.setAttribute("x",P.toString()),C.setAttribute("y",B.toString()),typeof m<"u"&&C.setAttribute("data-index",m.toString())}n=l}}},bl=class{renderer=new pl;margin={top:.025,left:.05,bottom:.025,right:.075};Resize(e,t){this.renderer.Resize()}Initialize(e){this.renderer.Initialize(e)}Update(e,t){this.renderer.Resize(),this.renderer.Prerender(),this.renderer.Clear(t.class_name);let r=new zt(0,0,this.renderer.size.width,this.renderer.size.height),a={top:Math.round(r.height)*this.margin.top,bottom:Math.round(r.height)*this.margin.bottom,left:Math.round(r.width)*this.margin.left,right:Math.round(r.width)*this.margin.right},i=t.title;if(i&&this.renderer.RenderTitle(i,r,a.top,t.title_layout||"top"),r.top+=a.top,r.left+=a.left,r.bottom-=a.bottom,r.right-=a.right,t.legend&&t.legend.length){let o=0;t.title&&(!t.title_layout||t.title_layout==="top")&&(o=1);let n=t.legend_position||o;this.renderer.Legend({labels:t.legend,position:n,style:t.legend_style,layout:n===0||n===1?0:1,area:r})}if(t.type==="histogram"||t.type==="line"||t.type==="area"||t.type==="column"||t.type==="histogram2"||t.type==="bar"||t.type==="scatter2"||t.type==="bubble"||t.type==="box"){let o=[],n=0;t.x_labels&&t.x_labels.length&&(o=t.x_labels.map(c=>{let u=this.renderer.MeasureText(c,["axis-label","x-axis-label"],!0);return n=Math.max(n,u.height),u}));let l=[],h=0;t.type==="box"&&t.series_names?.length&&(l=t.series_names.map(c=>{let u=this.renderer.MeasureText(c,["axis-label","x-axis-label","series-name"],!0);return h=Math.max(h,u.height),u}));let d=n&&h?4:0;if(t.y_labels&&t.y_labels.length){let c=[],u=0,m=0,f=t.type==="scatter2"||t.type==="bubble"?t.y_scale:t.scale,p=t.type==="bar"?t.y_labels.length:f.count+1;for(let b=0;b<p;b++){let w=this.renderer.MeasureText(t.y_labels[b],["axis-label","y-axis-label"]);c.push({label:t.y_labels[b],metrics:w}),u=Math.max(u,w.width),m=Math.max(m,w.height)}r.bottom=Math.round(r.bottom-m/2),r.top=Math.round(r.top+m/2),o.length&&(r.bottom-=n+a.bottom),l.length&&(r.bottom-=h+a.bottom),d&&(r.bottom-=d),t.type==="bar"?this.renderer.RenderYAxisBar(r,r.left+u,c,["axis-label","y-axis-label"]):this.renderer.RenderYAxis(r,r.left+u,c,["axis-label","y-axis-label"]),r.left+=u+a.left}if(t.type==="scatter2"&&t.y2_labels&&t.y2_labels.length&&t.y2_scale){let c=[],u=0,m=0,f=t.y2_scale.count+1;for(let p=0;p<f;p++){let b=this.renderer.MeasureText(t.y2_labels[p],["axis-label","y-axis-label"]);c.push({label:t.y2_labels[p],metrics:b}),u=Math.max(u,b.width),m=Math.max(m,b.height)}this.renderer.RenderYAxis(r,r.right-u,c,["axis-label","y-axis-label"],"left"),r.right-=u+a.left}if(o.length&&t.x_labels?.length){let c=t.type==="histogram2",u=t.type!=="line"&&t.type!=="area"&&t.type!=="bar"&&t.type!=="scatter2"&&t.type!=="bubble"&&t.type!=="histogram2";c&&this.renderer.RenderXAxisTicks(r,u,t.x_labels.length),t.y_labels&&(r.bottom+=n+a.bottom),this.renderer.RenderXAxis(r,u,t.x_labels,o,["axis-label","x-axis-label"]),r.bottom-=n+a.bottom}d&&(r.bottom+=d),t.type==="box"&&l.length&&t.series_names?.length&&(t.y_labels&&(r.bottom+=n+h+d+a.bottom),this.renderer.RenderXAxis(r,!0,t.series_names,l,["axis-label","x-axis-label","series-name"]),r.bottom-=n+h+a.bottom+a.bottom)}let s=[];switch(t.type){case"scatter":this.renderer.RenderPoints(r,t.x,t.y,"mc mc-correlation series-1");break;case"box":this.renderer.RenderGrid(r,t.scale.count,void 0,"chart-grid",s);for(let[o,n]of t.data.entries())n.iqr>0&&this.renderer.RenderBoxAndWhisker(r,n,o,t.max_n,t.scale,t.data.length,`box-plot series-${o}`);break;case"bubble":t.x_scale.min<=0&&t.x_scale.max>=0&&(s[0]=Math.round(Math.abs(t.x_scale.min/t.x_scale.step))),t.y_scale.min<=0&&t.y_scale.max>=0&&(s[1]=Math.round(Math.abs(t.y_scale.max/t.y_scale.step))),this.renderer.RenderGrid(r,t.y_scale.count,t.x_scale.count+1,"chart-grid",s);for(let[o,n]of t.series.entries()){let l=typeof n.index=="number"?n.index:o+1;this.renderer.RenderBubbleSeries(r,n,t.x_scale,t.y_scale,`bubble-chart series-${l}`)}break;case"scatter2":if(this.renderer.RenderGrid(r,t.y_scale.count,t.x_scale.count+1,"chart-grid"),t.series){for(let o=0;o<t.series.length;o++){let n=t.series[o],l=!!t.lines,h=!!t.points;n.subtype==="plot"?(h=!0,l=!1):n.subtype==="line"&&(h=!1,l=!0);let d=typeof n.index=="number"?n.index:o+1;this.renderer.RenderScatterSeries(r,n.x.data,n.y.data,t.x_scale,n.axis&&t.y2_scale?t.y2_scale:t.y_scale,l,h,!!t.filled,!!t.markers,!!t.smooth,`scatter-plot series-${d}`)}if(t.data_labels)for(let o=0;o<t.series.length;o++){let n=t.series[o];n.y.labels&&this.renderer.RenderDataLabels(r,n.x.data,n.y.data,t.x_scale,t.y_scale,n.y.labels,o+1)}}break;case"pie":case"donut":{let o=Math.min(r.height,r.width)/2*.9,n=t.type==="pie"?0:o*.8;this.renderer.RenderDonut(t.slices,r.center,o,n,r,!0,"donut")}break;case"line":case"area":{let o=t.scale;if(t.series){let n=t.x_scale?t.x_scale.max:Math.max.apply(0,t.series.map(d=>d.length)),l=t.smooth?this.renderer.RenderSmoothLine:this.renderer.RenderLine;this.renderer.RenderGrid(r,t.scale.count,t.x_scale?t.x_scale.count+1:n,"chart-grid");let h=0;for(let d of t.series){let c=d.map(m=>{if(!(typeof m>"u"))return K.ApplyScale(m,r.height,o)});if(c.length<n)for(let m=c.length;m<n;m++)c.push(void 0);let u=[t.type==="area"?"chart-area":"chart-line",`series-${h+1}`];l.call(this.renderer,r,c,t.type==="area",t.titles,u),h++}}}break;case"bar":{let o;if(this.renderer.RenderBarGrid(r,t.scale.count,"chart-grid"),t.series2){let n=0,l=t.series2.length;for(let f of t.series2)n=Math.max(n,f.y.data.length);let h=r.height/n,d=.7;typeof t.space=="number"&&(d=Math.max(0,Math.min(1,1-t.space)));let c=h*(1-d)/2,u=(h-c*2)/l,m=0;if(t.scale.min<0&&(m=K.ApplyScale(0,r.width,t.scale)),t.round){let f=Math.floor(u/2);o=[0,f,f,0]}for(let f=0;f<l;f++){let p=t.series2[f],b=typeof p.index=="number"?p.index:f+1;for(let w=0;w<p.y.data.length;w++){let y=p.y.data[w];if(typeof y=="number"){let g=Math.round(r.top+w*h+c)+f*u,v=0,x=0;m?y>0?(x=K.ApplyScale(y+t.scale.min,r.width,t.scale),v=r.left+m):(x=K.ApplyScale(t.scale.min-y,r.width,t.scale),v=r.left+m-x):(x=K.ApplyScale(y,r.width,t.scale),v=r.left),x&&this.renderer.RenderRectangle(new zt(v,g,v+x,g+u),o,["chart-column",`series-${b}`],void 0)}}}}}break;case"column":case"histogram2":if(this.renderer.RenderGrid(r,t.scale.count,0,"chart-grid"),t.series2){let o=0,n=t.series2.length;for(let f of t.series2)o=Math.max(o,f.y.data.length);let l=r.width/o,h=.7;typeof t.space=="number"&&(h=Math.max(0,Math.min(1,1-t.space)));let d=l*(1-h)/2,c=(l-d*2)/n,u=0;if(t.scale.min<0&&(u=K.ApplyScale(0,r.height,t.scale)),t.callouts&&t.x_scale){let f=t.x_scale,p=t.callouts.map((b,w)=>{let y=Math.round(r.left+K.ApplyScale(b.value,r.width,f))+.5;return{x1:y,y1:r.bottom-r.height,x2:y,y2:r.bottom,classes:`callout-${w+1}`}});this.renderer.RenderCalloutLines(p)}let m;if(t.round){let f=Math.floor(c/2);m=[f,f,0,0]}for(let f=0;f<n;f++){let p=t.series2[f],b=typeof p.index=="number"?p.index:f+1;for(let w=0;w<p.y.data.length;w++){let y=p.y.data[w];if(typeof y=="number"){let g=r.left+w*l+d+f*c,v=0,x=0;if(u?y>0?(v=K.ApplyScale(y+t.scale.min,r.height,t.scale),x=r.bottom-v-u):(v=K.ApplyScale(t.scale.min-y,r.height,t.scale),x=r.bottom-u):(v=K.ApplyScale(y,r.height,t.scale),x=r.bottom-v),v){let _=t.data_labels&&p.y.labels?p.y.labels[w]:"",C={x:Math.round(g+c/2),y:Math.round(x-10)};this.renderer.RenderRectangle(new zt(g,x,g+c,x+v),m,["chart-column",`series-${b}`],void 0,_,C)}}}}}break;case"histogram":{this.renderer.RenderGrid(r,t.scale.count,0,"chart-grid");let o=r.width/t.count,n=t.column_width,l=o*(1-n)/2;for(let h=0;h<t.count;h++){let d=Math.round(r.left+h*o+l),c=o-l*2,u=K.ApplyScale(t.bins[h],r.height,t.scale),m=r.bottom-u,f=t.titles?t.titles[h]:void 0;this.renderer.RenderRectangle(new zt(d,m,d+c,m+u),void 0,"chart-column series-1",f||void 0)}}break}}},sr=class{constructor(e=new bl){this.renderer=e}static functions_registered=!1;chart_data={type:"null"};node;Initialize(e){this.node=e,this.renderer.Initialize(e)}Exec(e,t){let r=t?.value||[];switch(e.toLowerCase()){case"column.chart":this.chart_data=Xa(r,"column");break;case"bar.chart":this.chart_data=Xa(r,"bar");break;case"line.chart":this.chart_data=Qa(r,"line");break;case"area.chart":this.chart_data=Qa(r,"area");break;case"donut.chart":case"pie.chart":this.chart_data=ml(r,e.toLowerCase()==="pie.chart");break;case"scatter.plot":this.chart_data=Ka(r,"plot");break;case"scatter.line":this.chart_data=Ka(r,"line");break;case"bubble.chart":this.chart_data=ul(r);break;case"box.plot":this.chart_data=us(r);break;default:this.Clear();break}}Clear(){this.chart_data={type:"null"}}Resize(){this.node&&this.renderer.Resize(this.node,this.chart_data)}Update(){this.node&&this.renderer.Update(this.node,this.chart_data)}},xe=(...e)=>({type:5,value:e,key:"arguments"}),ms={Group:{arguments:[{name:"Array...",metadata:!0}],fn:(...e)=>({type:5,value:e,key:"group"}),category:["grouping"]},Series:{arguments:[{name:"Label"},{name:"X",metadata:!0},{name:"Y",metadata:!0},{name:"Z",metadata:!0},{name:"Index"},{name:"Subtype"},{name:"Labels",description:"Labels for bubble charts only (atm)"},{name:"Axis",description:"Series axis (scatter plot only)"}],fn:(...e)=>({type:5,value:{label:e[0],x:e[1],y:e[2],z:e[3],index:e[4],subtype:e[5],data_labels:e[6],axis:e[7]},key:"series"}),category:["chart functions"]},"Bar.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"ChartTitle"}],fn:xe,category:["chart functions"]},"Line.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:xe,category:["chart functions"]},"Area.Chart":{arguments:[{name:"y",metadata:!0},{name:"x",metadata:!0},{name:"ChartTitle"}],fn:xe,category:["chart functions"]},"Pie.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels"},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:xe,category:["chart functions"]},"Donut.Chart":{arguments:[{name:"Values",metadata:!0},{name:"Labels",metadata:!0},{name:"Title"},{name:"Sort"},{name:"Label"}],fn:xe,category:["chart functions"]},"Scatter.Line":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:xe,category:["chart functions"]},"Scatter.Plot":{arguments:[{name:"Data",metadata:!0},{name:"ChartTitle"}],fn:xe,category:["chart functions"]},"Column.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Categories",metadata:!0},{name:"Chart Title"}],fn:xe,category:["chart functions"]},"Bubble.Chart":{arguments:[{name:"Data",metadata:!0},{name:"Chart Title"}],fn:xe,category:["chart functions"]},"Box.Plot":{arguments:[{name:"Data",metadata:!0},{name:"Chart Title"},{name:"Min/Max Style"}],fn:xe,category:["chart functions"]}},fs=class Ke{static treb_base_path="";static failed_dynamic_modules=[];static one_time_warnings={};static clipboard;DOM=le.GetInstance();loaded=!1;document_styles={number_formats:[],colors:[],theme_colors:[]};selection_state={};options;get Localization(){return G}events=new ut;calculation=0;file_version=0;last_save_version=0;initial_load_source=void 0;calculator;grid;model;dialog;spinner;file_chooser;file_chooser_operation=0;get parser(){return this.model.parser}view_node;key_listener;views=[];focus_target=this;parent_view;export_worker;undo_pointer=0;undo_stack=[];last_selection;get active_sheet(){let t=this.grid.active_sheet.name;return tt.test(t)?`'${t}'`:t}get modified(){return this.undo_stack.length!==1}get document_name(){return this.grid.model.document_name}set document_name(t){this.grid.model.document_name=t,this.DocumentChange()}get user_data(){return this.grid.model.user_data}set user_data(t){this.grid.model.user_data=t,this.DocumentChange()}get scale(){return this.grid.scale}set scale(t){this.grid.scale=t}get headless(){return this.grid.headless}set headless(t){this.grid.headless!==t&&(this.grid.headless=t,t||(this.grid.Update(!0),this.RebuildAllAnnotations()))}get state(){return this.file_version}get can_revert(){return!this.options.inline_document&&!this.options.document?!1:this.initial_load_source==="local-storage"?!0:this.dirty}get dirty(){return this.file_version!==this.last_save_version}set dirty(t){t?this.file_version++:this.last_save_version=this.file_version}get sheet_names(){return this.model.sheets.list.map(t=>t.name)}constructor(t){t.storage_key&&!t.local_storage&&(t.local_storage=t.storage_key),this.options={...nl,...t,local_storage:this.ResolveStorageKey(t.local_storage,"document")},typeof this.options.imaginary_value=="string"&&(Ie.imaginary_character=this.options.imaginary_value),this.options.network_document&&(console.warn("the option `network_document` is deprecated. please use `document` instead."),this.options.document||(this.options.document=this.options.network_document)),this.options.document&&this.options.inline_document&&console.warn("both document and inline-document are provided");let r=this.options.document,a,i;this.options.local_storage&&!this.options.toll_initial_load&&!t.model&&(a=localStorage.getItem(this.options.local_storage)||void 0,a&&(i="local-storage")),!a&&!this.options.toll_initial_load&&!t.model&&t.inline_document&&(a=t.inline_document,i="inline-document"),this.options.local_storage&&!t.model&&window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.options.local_storage&&this.dirty&&this.SaveLocalStorage(this.options.local_storage)});let s;typeof this.options.container=="string"?s=document.querySelector(this.options.container):this.options.container&&(s=this.options.container);let o={in_cell_editor:!0,repaint_on_cell_change:!1,scrollbars:this.options.scrollbars,markdown:!!this.options.markdown,formula_bar:this.options.formula_bar,expand_formula_button:this.options.expand_formula_button,tab_bar:this.options.tab_bar,add_tab:this.options.add_tab,expand:this.options.expand,support_font_stacks:!!this.options.font_stack};if(this.options.scale&&(o.initial_scale=this.options.scale),this.options.stats&&(o.stats=this.options.stats,o.tab_bar=!0),this.options.scale_control&&(o.scale_control=!0,o.tab_bar=!0,this.options.persist_scale&&(o.persist_scale_key=this.ResolveStorageKey(this.options.persist_scale,"scale"),o.persist_scale_key))){let n=localStorage.getItem(o.persist_scale_key);if(n)try{let l=JSON.parse(n);o.initial_scale=l.scale||1}catch{console.warn("parsing persisted scale failed")}}if(t.model?(this.model=t.model.model,this.calculator=t.model.calculator,this.DOM=t.model.DOM):(this.model=new tn,this.model.sheets.Add(ge.Blank(this.model.theme_style_properties)),this.calculator=this.CreateCalculator(this.model,this.options)),s&&(this.DOM=le.GetInstance(s.ownerDocument)),this.grid=new qo(o,this.model,void 0,!!s,this.DOM),this.options.headless&&(this.grid.headless=!0),this.LoadLanguage(t.language),s){this.DOM=le.GetInstance(s.ownerDocument),this.parent_view||(ae.is_windows?s.parentElement?.classList.add("treb-ua-windows"):ae.is_mac&&s.parentElement?.classList.add("treb-ua-osx"));let n=s.querySelector(".treb-view-template");this.view_node=n.content.firstElementChild?.cloneNode(!0),s.prepend(this.view_node),this.view_node.addEventListener("focusin",()=>{this.focus_target!==this&&(this.Publish({type:"focus-view"}),this.focus_target=this)}),this.key_listener=h=>this.HandleKeyDown(h),s.addEventListener("keydown",this.key_listener);let l=!!(a||this.options.document);this.grid.Initialize(this.view_node,l),this.options.dnd&&(this.view_node.addEventListener("dragenter",h=>this.HandleDrag(h)),this.view_node.addEventListener("dragover",h=>this.HandleDrag(h)),this.view_node.addEventListener("drop",h=>this.HandleDrop(h))),this.grid.grid_events.Subscribe(h=>{switch(h.type){case"error":this.dialog?.ShowDialog({type:"error",...this.TranslateGridError(h.code),timeout:3e3,close_box:!0});break;case"selection":this.UpdateSelection(h.selection),this.UpdateSelectionStyle(h.selection);break;case"sheet-change":this.OnSheetChange(h),this.UpdateSelectionStyle();break;case"scale":this.RebuildAllAnnotations(),this.Publish({type:"view-change"});break;case"cell-event":this.HandleCellEvent(h);break;case"composite":{let d=this.last_selection;this.calculation===0&&this.Recalculate(h),this.DocumentChange(d),this.UpdateDocumentStyles(),this.UpdateSelectionStyle()}break;case"data":{let d=this.last_selection;this.calculation===0&&this.Recalculate(h),this.DocumentChange(d)}break;case"style":this.DocumentChange(),this.UpdateDocumentStyles(),this.UpdateSelectionStyle();break;case"annotation":if(h.annotation){let d=h.annotation.view[this.grid.view_index]||{},c=!1;if(h.event==="select")c=!0;else switch(this.DocumentChange(),h.event){case"create":this.InflateAnnotation(h.annotation),this.calculator.UpdateAnnotations(h.annotation,this.grid.active_sheet),this.grid.AnnotationUpdated(h.annotation),c=h.annotation===this.grid.selected_annotation;break;case"delete":this.calculator.RemoveAnnotation(h.annotation);break;case"update":d.update_callback?(d.update_callback(),this.grid.AnnotationUpdated(h.annotation)):console.info("annotation update event without update callback"),this.calculator.UpdateAnnotations(h.annotation,this.grid.active_sheet),c=h.annotation===this.grid.selected_annotation;break;case"resize":d.resize_callback&&(d.resize_callback(),this.grid.AnnotationUpdated(h.annotation));break}if(c){this.UpdateSelectionStyleAnnotation(h.annotation),this.Publish({type:"annotation-selection"});break}}else console.info("annotation event without annotation");break;case"structure":{let d=this.last_selection;h.conditional_format&&(this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1)),h.rebuild_required?(this.calculator.Reset(),this.calculation===0&&this.Recalculate(h),this.DocumentChange(d)):this.DocumentChange(d)}this.UpdateSelectionStyle();break}}),this.options.prompt_save&&window.addEventListener("beforeunload",h=>{this.last_save_version!==this.file_version&&(h.preventDefault(),h.returnValue="")})}else Ke.one_time_warnings.headless||(Ke.one_time_warnings.headless=!0,console.info("not initializing layout; don't call UI functions"));if(t.preload&&t.preload.call(0,this),a?(typeof a=="string"&&(a=JSON.parse(a)),a?this.LoadDocument(a,{recalculate:!!this.options.recalculate,source:i}):this.UpdateDocumentStyles()):r||(this.calculator.RebuildClean(!0),this.UpdateDocumentStyles()),this.FlushUndo(),this.grid.ShowHeaders(this.options.headers),this.options.scroll&&!this.options.document){let n=this.options.scroll;requestAnimationFrame(()=>{this.ScrollTo(n)})}this.UpdateAC(),this.options.global_name&&(self[this.options.global_name]=this),s&&this.options.spinner&&(this.spinner=new ol(s)),r&&!t.model&&!a&&this.LoadNetworkDocument(r,this.options),s&&(this.dialog=new sl(s))}UpdateAC(){let t=this.calculator.SupportedFunctions();if(this.model.language_model?.functions){let r={};for(let a of this.model.language_model.functions||[])r[a.base.toUpperCase()]=a;t=t.map(a=>{let i=r[a.name.toUpperCase()];if(i){let s=JSON.parse(JSON.stringify({...a,name:i.name}));if(i.description&&(s.description=i.description),i.arguments&&s.arguments)for(let[o,n]of i.arguments.entries())s.arguments[o]&&(s.arguments[o].name=n);return s}return a})}this.grid.SetAutocompleteFunctions(t)}CreateCalculator(t,r){return new cs(t,{complex_numbers:r.complex,spill:r.spill})}TranslateGridError(t){switch(t){case 0:return{message:"No error"};case 2:return{message:"You can't change part of an array"};case 5:return{message:"Invalid area for paste"};case 4:return{message:"Invalid area for table"};case 3:return{message:"Invalid value (data validation)"};default:return{message:`Unknown error (${t})`}}}CreateView(){let t=new Ke({...this.options,global_name:void 0,model:this});return t.parent_view=this,t}Unsplit(){let t=this.views.pop();if(t){let r=t.view;r.grid.grid_events.CancelAll(),r.events.CancelAll(),r.view_node?.parentElement&&(r.key_listener&&r.view_node.parentElement.removeEventListener("keydown",r.key_listener),r.view_node.parentElement.removeChild(r.view_node)),this.view_node?.focus(),this.Resize()}}ExternalEditor(t){this.grid.ExternalEditor(t)}Split(){let t=this.CreateView();t.grid.EnsureActiveSheet(!0),t.view_node?.addEventListener("focusin",()=>{this.focus_target!==t&&(this.Publish({type:"focus-view"}),this.focus_target=t)}),t.grid.grid_events.Subscribe(a=>{a.type==="structure"&&(this.grid.EnsureActiveSheet(),this.grid.UpdateLayout(),this.grid.UpdateTabBar(),a.update_annotations&&(this.grid.RefreshAnnotations(),this.InflateAnnotations()))}),t.Subscribe(a=>{switch(a.type){case"selection":break;default:t.UpdateAnnotations(),this.grid.Update(!0),this.grid.UpdateAnnotations()}}),this.grid.grid_events.Subscribe(a=>{a.type==="structure"&&(t.grid.EnsureActiveSheet(),t.grid.UpdateLayout(),t.grid.UpdateTabBar(),a.update_annotations&&(t.grid.RefreshAnnotations(),t.InflateAnnotations()))});let r=this.Subscribe(a=>{switch(a.type){case"selection":break;case"load":case"reset":t.grid.EnsureActiveSheet(!0),t.UpdateAnnotations(),t.grid.UpdateAnnotations(),t.grid.Update(!0);break;default:t.UpdateAnnotations(),t.grid.Update(!0),t.grid.UpdateAnnotations()}});this.views.push({view:t,subscription:r})}ListConditionalFormats(t){return(typeof t>"u"?this.grid.active_sheet:this.model.sheets.Find(t))?.conditional_formats||[]}ConditionalFormatDuplicateValues(t,r){return this.AddConditionalFormat({type:"duplicate-values",area:this.RangeOrSelection(t,"invalid range (no selection)"),...r})}ConditionalFormatGradient(t,r){let a=this.RangeOrSelection(t,"invalid range (no selection)"),i=typeof r=="object"?{type:"gradient",area:a,...r}:{type:"gradient",area:a,...on[r]};return this.AddConditionalFormat(i),i}ConditionalFormatCellMatch(t,r){let a={type:"cell-match",area:this.RangeOrSelection(t,"invalid range (no selection)"),...r};return this.AddConditionalFormat(a),a}ConditionalFormatExpression(t,r){let a={type:"expression",area:this.RangeOrSelection(t,"invalid range (no selection)"),...r};return this.AddConditionalFormat(a),a}AddConditionalFormat(t){return this.grid.AddConditionalFormat(t),t}RemoveConditionalFormat(t){this.grid.RemoveConditionalFormat({format:t})}RemoveConditionalFormats(t){let r=this.RangeOrSelection(t);r&&this.grid.RemoveConditionalFormat({area:r})}HandleToolbarMessage(t){if(this.focus_target!==this){this.focus_target.HandleToolbarMessage(t);return}let r={};if(this.grid.AnnotationSelected()){switch(t.command){case"adjust-font-scale":{let i=Number(t.delta||0),s=this.grid.GetAnnotationStyle()?.font_size;(!s||s.unit!=="em")&&(s={unit:"em",value:1}),s&&(s.value+=i,r.font_size=s,this.grid.ApplyAnnotationStyle(r))}break;case"font-scale":{let i=Number(t.scale||1);i&&!isNaN(i)&&(r.font_size={unit:"em",value:i},this.grid.ApplyAnnotationStyle(r))}break;case"font-stack":t.font_stack&&(r.font_face="stack:"+t.font_stack),this.grid.ApplyAnnotationStyle(r);break}this.Focus();return}let a=i=>{let s=this.grid.GetSelection();if(s&&!s.empty){let o=s.area.spreadsheet_label;i==="Scatter.Plot"||i==="Scatter.Line"||i==="Box.Plot"?this.InsertAnnotation(`=${i}(Series(,,${o}),"${o}")`,void 0,void 0,","):this.InsertAnnotation(`=${i}(${o},,"${o}")`,void 0,void 0,",")}};if(/^border-/.test(t.command))if(t.command==="border-color")try{r.border_top_fill=r.border_bottom_fill=r.border_left_fill=r.border_right_fill=t.color||{}}catch(i){console.error(i)}else{let i=1,s=t.command.substring(7);t.command==="border-double-bottom"&&(s="bottom",i=2),this.grid.ApplyBorders2(void 0,s,t.color||{},i)}else switch(t.command){case"about":this.About();break;case"number-format":r.number_format=t.format||"General";break;case"font-stack":t.font_stack&&(r.font_face="stack:"+t.font_stack);break;case"adjust-font-scale":{let i=this.selection_state.style?.font_size,s=this.grid.GetSelection(),o=this.grid.active_sheet.RealArea(s.area),n=Number(t.delta||0);if((!i||i.unit!=="em")&&(i={unit:"em",value:1}),i&&n&&!isNaN(n)){i.value+=n,this.grid.ApplyStyle(void 0,{font_size:i},!0);let l=[];for(let h=o.start.row;h<=o.end.row;h++)l.push(h);this.selection_state?.merge||this.grid.SetRowHeight(l,void 0,!1)}}break;case"font-scale":{let i=this.grid.GetSelection(),s=this.grid.active_sheet.RealArea(i.area),o=Number(t.scale||1);if(o&&!isNaN(o)){this.grid.ApplyStyle(void 0,{font_size:{unit:"em",value:o}},!0);let n=[];for(let l=s.start.row;l<=s.end.row;l++)n.push(l);this.selection_state?.merge||this.grid.SetRowHeight(n,void 0,!1)}}break;case"update-comment":this.SetNote(void 0,t.comment||"");break;case"clear-comment":this.SetNote(void 0,"");break;case"text-color":case"fill-color":try{let i=t.color||{};t.command==="text-color"?r.text=i:t.command==="fill-color"&&(r.fill=i)}catch(i){console.error(i)}break;case"insert-table":this.InsertTable();break;case"remove-table":this.RemoveTable();break;case"insert-row":this.InsertRows();break;case"insert-column":this.InsertColumns();break;case"delete-row":this.DeleteRows();break;case"delete-column":this.DeleteColumns();break;case"insert-sheet":this.grid.InsertSheet();break;case"delete-sheet":this.grid.DeleteSheet();break;case"freeze-panes":{let i=this.grid.GetFreeze();i.rows||i.columns?this.Freeze(0,0):this.FreezeSelection()}break;case"insert-image":this.InsertImage();break;case"insert-donut-chart":a("Donut.Chart");break;case"insert-column-chart":a("Column.Chart");break;case"insert-bar-chart":a("Bar.Chart");break;case"insert-line-chart":a("Line.Chart");break;case"insert-scatter-plot":a("Scatter.Plot");break;case"insert-box-plot":a("Box.Plot");break;case"increase-precision":case"decrease-precision":if(this.selection_state?.style){let i=V.Get(this.selection_state.style.number_format||"General");if(i.date_format)break;let s=new Ie(i.pattern);if(i.magic_decimal){let o=0,n=this.GetRange();Array.isArray(n)||(n=[[n]]);e:for(let l=0;l<n.length;l++)for(let h=0;h<n[l].length;h++){let d=n[l][h];if(typeof d<"u"&&Ne(d)){let c=V.Get(this.selection_state.style.number_format||"General",!0),u=c.BaseFormat(d.real),m=c.BaseFormat(d.imaginary);u.parts&&typeof u.parts[1]=="string"&&(o=u.parts[1].length),m.parts&&typeof m.parts[1]=="string"&&(o=Math.max(o,m.parts[1].length));break e}else if(typeof d=="number"){let c=i.BaseFormat(d);c.parts&&typeof c.parts[1]=="string"&&(o=c.parts[1].length);break e}}t.command==="increase-precision"?s.SetDecimal(o+1):s.SetDecimal(Math.max(0,o-1))}else t.command==="increase-precision"?s.IncreaseDecimal():s.DecreaseDecimal();r.number_format=s.toString()}break;case"merge-cells":this.grid.MergeCells();break;case"unmerge-cells":this.grid.UnmergeCells();break;case"lock-cells":r={locked:this.selection_state?.style?!this.selection_state.style.locked:!0};break;case"wrap-text":r={wrap:this.selection_state?.style?!this.selection_state?.style.wrap:!0};break;case"justify-left":r={horizontal_align:"left"};break;case"justify-center":r={horizontal_align:"center"};break;case"justify-right":r={horizontal_align:"right"};break;case"align-top":r={vertical_align:"top"};break;case"align-middle":r={vertical_align:"middle"};break;case"align-bottom":r={vertical_align:"bottom"};break;case"reset":this.Reset();break;case"import-file":this.LoadLocalFile();break;case"save-json":this.SaveToDesktop();break;case"save-csv":this.SaveToDesktop("csv");break;case"export-xlsx":this.Export();break;case"revert":this.Revert();break;case"recalculate":this.Recalculate();break;case"toggle-toolbar":case"show-toolbar":case"hide-toolbar":this.ShowToolbar(t.command==="toggle-toolbar"?void 0:t.command==="show-toolbar");break;case"toggle-sidebar":case"show-sidebar":case"hide-sidebar":this.ShowSidebar(t.command==="toggle-sidebar"?void 0:t.command==="show-sidebar");break;case"revert-indicator":this.dialog?.ShowDialog({title:`This is a modified version of the document.
You can revert to the original or save your
changes in the sidebar.`,close_box:!0,timeout:5e3,type:"info"});break;case"indent":case"outdent":this.grid.Indent(void 0,t.command==="indent"?1:-1);break;default:console.info("unhandled",t.command);break}Object.keys(r).length&&this.grid.ApplyStyle(void 0,r,!0),this.Focus()}ShowToolbar(t){if(this.options.toolbar&&this.options.container instanceof HTMLElement){let r=this.options.container.parentElement;r&&(t===void 0&&(t=!r.hasAttribute("toolbar")),t?r.setAttribute("toolbar",""):r.removeAttribute("toolbar"))}}ShowSidebar(t){if(this.options.toolbar&&this.options.container instanceof HTMLElement){let r=this.options.container.parentElement;r&&(t===void 0&&(t=r.hasAttribute("collapsed")),t?r.removeAttribute("collapsed"):r.setAttribute("collapsed",""))}}CreateChart(){return this.calculator.RegisterLibrary("treb-charts",ms)&&this.UpdateAC(),this.options.chart_renderer?typeof this.options.chart_renderer=="function"?new sr(this.options.chart_renderer()):new sr(this.options.chart_renderer):new sr}async LoadLanguage(t=""){(!t||t==="locale")&&(t=(G.locale||"").split(/-/).map(a=>a.toLowerCase())[0]),t=t.toLowerCase();let r;if(t&&["es","fr","pt","nl","de","pl","sv","no","da","it"].includes(t))try{r=await Fr(Object.assign({}),`./languages/treb-i18n-${t}.mjs`,3)}catch(a){console.error(a)}r?this.model.SetLanguage(r.LanguageMap):this.model.SetLanguage(),this.grid.Reselect(),this.grid.Update(!0),this.UpdateAC()}Batch(t,r=!1){let a=this.last_selection,i=this.grid.Batch(t,r),s=!1,o=!1;for(let n of i)switch(n.type){case"data":s=!0;break;case"structure":n.rebuild_required&&(o=!0);break}o&&this.calculator.Reset(),(s||o)&&(this.Recalculate(),this.DocumentChange(a))}Freeze(t=0,r=0){this.grid.Freeze(t,r,!0)}FreezeSelection(){let t=this.grid.GetSelection();if(t.empty)this.grid.Freeze(0,0);else{let r=t.area;r.entire_sheet||(r.entire_row?this.grid.Freeze(r.end.row+1,0):r.entire_column?this.grid.Freeze(0,r.end.column+1):this.grid.Freeze(r.end.row+1,r.end.column+1))}}GetFreeze(){return this.grid.GetFreeze()}UpdateTheme(){this.grid.UpdateTheme(void 0),this.UpdateDocumentStyles();for(let t of this.model.sheets.list){for(let r of t.conditional_formats)r.internal=void 0;for(let r of t.annotations)if(r.view&&r.data.type==="textbox"){let a=r.view[this.grid.view_index]||{};a.update_callback&&a.update_callback()}}this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update(!0),this.Publish({type:"theme-change"})}GetSheetID(t){if(typeof t=="number"){let r=this.grid.model.sheets.list[t];if(r)return r.id}else{let r=this.model.sheets.Find(t);if(r)return r.id}}InsertTable(t,r={}){let a=t?this.model.ResolveArea(t,this.grid.active_sheet):this.GetSelectionReference().area,i=r.theme;typeof i=="number"&&(i=Ir(i)),this.grid.InsertTable(a,r.totals_row,r.sortable,i)}RemoveTable(t){let r=this.ResolveTable(t||this.GetSelectionReference().target);r&&this.grid.RemoveTable(r)}UpdateTableStyle(t,r=4){let a=this.ResolveTable(t||this.GetSelectionReference().target);a&&(typeof r=="number"&&(r=Ir(r)),a.theme=r,this.grid.active_sheet.FlushCellStyles(),this.grid.Update(!0),this.PushUndo())}SetTabColor(t,r){let a=typeof t>"u"?this.grid.active_sheet:this.model.sheets.Find(t);a&&this.grid.TabColor(a,r)}AddSheet(t){this.grid.AddSheet(t);let r=this.model.sheets.list[this.model.sheets.list.length-1];return this.calculator.Reset(),r.id}RemoveConnectedChart(t){let r=this.model.RemoveConnectedElement(t);r&&this.calculator.RemoveConnectedELement(r)}UpdateConnectedChart(t,r){let a=this.model.connected_elements.get(t);if(a){a.formula=r;let i=a.internal;i?.state&&(i.state=void 0),this.calculator.UpdateConnectedElements(this.grid.active_sheet,a),a.update&&a.update.call(0,a)}}CreateConnectedFormula(t,r,a={}){let i=a?.r1c1||!1,s=a?.argument_separator||this.parser.argument_separator;this.parser.Save(),this.parser.flags.r1c1=i,s===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(",");let o=this.parser.Parse(t);if(this.parser.Restore(),o.expression)t="="+this.parser.Render(o.expression,{missing:""});else throw console.warn("invalid formula",o.error),new Error("invalid formula");let n=this.model.AddConnectedElement({formula:t,update:r?l=>{r.call(0,l)}:void 0});return this.calculator.UpdateConnectedElements(this.grid.active_sheet),this.UpdateConnectedElements(),n}CreateConnectedChart(t,r,a){let i=this.CreateChart();i.Initialize(r);let s=o=>{let n=this.parser.Parse(o.formula);if(n&&n.expression&&n.expression.type==="call"){this.parser.Walk(n.expression,d=>((d.type==="address"||d.type==="range")&&this.model.ResolveSheetID(d,void 0,this.grid.active_sheet),!0));let l=n.expression.name.toLowerCase(),h=this.calculator.CalculateExpression(n.expression);i.Exec(l,h)}i.Update()};return this.CreateConnectedFormula(t,s,a)}InsertAnnotation(t,r="treb-chart",a,i){let s,o,n=!1;if(typeof i=="object"?(o=i.argument_separator,n=!!i.r1c1):(i===","||i===";")&&(o=i),a&&(s=ie.IsRectangle(a)?a:this.model.ResolveArea(a,this.grid.active_sheet)),o&&o!==this.parser.argument_separator||n){this.parser.Save(),o===","?this.parser.SetLocaleSettings("."):this.parser.SetLocaleSettings(","),this.parser.flags.r1c1=!!n;let u=this.parser.Parse(t);this.parser.Restore(),u.expression&&(t="="+this.parser.Render(u.expression,{missing:""}))}let{x:l,y:h}=this.grid.GetScrollOffset(),d=this.grid.scale||1,c={width:301,height:301};this.grid.CreateAnnotation({type:r,formula:t},void 0,void 0,void 0,s||{top:h/d+30,left:l/d+30,...c})}InsertImage(){this.SelectFile2(".png, .jpg, .jpeg, .gif, .svg",2)}RenameSheet(t,r){let a;typeof t=="number"?a=this.grid.model.sheets.list[t]:typeof t=="string"?a=this.model.sheets.Find(t):a=this.grid.active_sheet,a&&this.grid.RenameSheet(a,r)}DeleteSheet(t){if(typeof t=="string"){let r=this.model.sheets.Find(t);r&&this.grid.DeleteSheetID(r.id)}else this.grid.DeleteSheet(t);this.calculator.Reset()}HideSheet(t=0,r=!0){this.grid.ShowSheet(t,!r)}ListSheets(){return this.model.sheets.list.map(t=>{let r={name:t.name};return t.visible||(r.hidden=!0),r})}ShowSheet(t=0,r=!0){this.grid.ShowSheet(t,r)}ActivateSheet(t){this.grid.ActivateSheet(t)}SetColumnWidth(t,r){this.grid.SetColumnWidth(t,r)}SetRowHeight(t,r){this.grid.SetRowHeight(t,r)}InsertRows(t,r=1){if(typeof t>"u"){let a=this.grid.GetSelection();if(a.empty)return;let i=a.area;t=i.entire_column?0:i.start.row}this.grid.InsertRows(t,r)}InsertColumns(t,r=1){if(typeof t>"u"){let a=this.grid.GetSelection();if(a.empty)return;let i=a.area;t=i.entire_row?0:i.start.column}this.grid.InsertColumns(t,r)}DeleteRows(t,r=1){if(typeof t>"u"){let a=this.grid.GetSelection();if(a.empty)return;let i=a.area;t=i.entire_column?0:i.start.row,r=i.rows}this.grid.InsertRows(t,-r)}DeleteColumns(t,r=1){if(typeof t>"u"){let a=this.grid.GetSelection();if(a.empty)return;let i=a.area;t=i.entire_row?0:i.start.column,r=i.columns}this.grid.InsertColumns(t,-r)}FilterTable(t,r=0,a){let i=this.ResolveTable(t);if(!i)throw new Error("invalid table reference");a?this.grid.FilterTable(i,r,s=>a.call(0,s.value,s.calculated||void 0,JSON.parse(JSON.stringify(s.style||{})))):this.grid.FilterTable(i,0,()=>!0)}SortTable(t,r={}){let a=this.ResolveTable(t);if(!a)throw new Error("invalid table reference");this.grid.SortTable(a,r)}MergeCells(t){this.grid.MergeCells(t?this.model.ResolveArea(t,this.grid.active_sheet):void 0)}UnmergeCells(t){this.grid.UnmergeCells(t?this.model.ResolveArea(t,this.grid.active_sheet):void 0)}async ExportBlob(t){return this.export_worker||(this.export_worker=await this.LoadWorker()),new Promise((r,a)=>{this.export_worker?(this.export_worker.onmessage=i=>{r(i.data?i.data.blob:void 0)},this.export_worker.onerror=i=>{console.error("export worker error"),console.info(i),a(i)},t||(t=this.Serialize({rendered_values:!0,expand_arrays:!0,export_colors:!0,decorated_cells:!0,tables:!0,share_resources:!1,export_functions:!0,apply_row_pattern:!0})),t.decimal_mark=G.decimal_separator,this.export_worker.postMessage({command:"export",sheet:t,decorated:this.calculator.DecoratedFunctionList()})):a("worker failed")})}Revert(){if(this.options.inline_document){this.LoadDocument(this.options.inline_document),this.initial_load_source="inline-document",this.options.local_storage&&(this.SaveLocalStorage("reverted_backup"),localStorage.removeItem(this.options.local_storage));return}let t=this.options.document;if(t){this.LoadNetworkDocument(t),this.initial_load_source="network-file",this.options.local_storage&&(this.SaveLocalStorage("reverted_backup"),localStorage.removeItem(this.options.local_storage));return}console.warn("to revert, there must be a document set in options"),this.dialog?.ShowDialog({title:"Can't revert -- no document is set in options",close_box:!0,timeout:3e3,type:"error"})}Export(){this.ExportBlob().then(t=>{let r="export";this.grid.model.document_name&&(r=this.grid.model.document_name.toLowerCase().replace(/\s+/g,"-")),t&&(this.SaveAs(t,r+".xlsx"),this.last_save_version=this.file_version)}).catch(t=>{throw/invalid uri/i.test(t.message)&&this.dialog?.ShowDialog({title:"Error exporting file",close_box:!0,message:"The worker cannot run from the filesystem, please use a web server.",timeout:3e3,type:"error"}),t})}GetSelectionReference(){return this.grid.GetSelection()}Focus(){this.grid.Focus()}Resize(){this.grid.UpdateLayout();for(let t of this.views)t.view.grid.UpdateLayout();this.Publish({type:"resize"})}Reset(){if(this.parent_view)return this.parent_view.Reset();this.grid.Reset(),this.ResetInternal(),this.UpdateAC(),this.Publish({type:"reset"})}LoadFromLocalStorage(t){this.options.local_storage=t;let r=localStorage.getItem(t);if(r)try{let a=JSON.parse(r);return this.LoadDocument(a,{source:"local-storage"}),!0}catch(a){console.error(a)}return!1}async LoadNetworkDocument(t,r){let a=r?r.scroll:void 0,i=r?!!r.recalculate:!1,s=r?r.sheet:void 0,o=/csv(?:$|\?|&)/i.test(t),n=/tsv(?:$|\?|&)/i.test(t);try{this.spinner?.Show();let l=await fetch(t);if(this.spinner?.Hide(),!l.ok)throw new Error("network error");let h=await l.text();if(typeof h=="string")if(o)this.LoadCSV(h,"network-file");else{if(n)throw new Error("tsv not supported (TODO)");{h.substr(0,11)==="&&&START&&&"?h=h.substr(11):h.substr(0,8)==="for(;;);"&&(h=h.substr(8));let d=JSON.parse(h);this.LoadDocument(d,{scroll:a,recalculate:i,override_sheet:s,source:"network-file"})}}}catch(l){console.info("error loading network document",t),console.error(l),this.dialog?.ShowDialog({title:"Error loading file",close_box:!0,message:"The network document returned an error",type:"error",timeout:3e3}),this.Reset()}}async LoadLocalFile(){this.SelectFile2(".treb, .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json",1)}ExportDelimited(t={}){if(t={delimiter:",",...t},!t.delimiter||t.delimiter!==","&&t.delimiter!=="	")throw new Error("invalid delimiter");let r=this.grid.active_sheet;switch(typeof t.sheet){case"undefined":break;case"string":r=this.model.sheets.Find(t.sheet);break;case"number":r=this.grid.model.sheets.list[t.sheet];break;default:r=void 0;break}if(!r)throw new Error("invalid sheet identifier");let a=r.cells.toJSON({nested:!1,expand_arrays:!0,calculated_value:!0}),i=[];for(let n=0;n<a.columns;n++)i.push("");let s=[];for(let n=0;n<a.rows;n++)s.push(i.slice(0));let o=new RegExp(`[	
\r"${t.delimiter}]`);if(dr(a.data))for(let n of a.data){let l="";!t.formulas&&typeof n.calculated<"u"?l=Ne(n.calculated)?nr(n.calculated):n.calculated.toString():typeof n.value=="string"&&n.value[0]==="'"?l=n.value.substr(1):typeof n.value<"u"&&(l=Ne(n.value)?nr(n.value):n.value.toString()),o.test(l)&&(l=l.replace(/"/g,'""'),l='"'+l+'"'),s[n.row][n.column]=l}return s.map(n=>n.join(t.delimiter)).join(`\r
`)}SaveLocalFile(t="treb.json",r={}){this.SaveToDesktop(t,r)}SaveToDesktop(t="treb.json",r={}){let a=this.grid.model.document_name||"document",i,s,o=t.split(/\./).filter(l=>l.trim().length),n=o.length?o[o.length-1].toLowerCase():"treb";if(o.length<=1||t==="treb.json")if(t==="treb.json"&&(n=t),(n==="csv"||n==="tsv")&&this.grid.model.sheets.length>1){let l=this.grid.active_sheet.name;t=(a+"-"+l).toLowerCase().replace(/\W+/g,"-")+"."+n}else t=a.toLowerCase().replace(/\W+/g,"-")+"."+n;switch(n){case"csv":s=this.ExportDelimited({delimiter:","});break;case"tsv":s=this.ExportDelimited({delimiter:"	"});break;case"treb":case"json":case"treb.json":i=this.SerializeDocument({...r}),s=JSON.stringify(i,void 0,r.pretty?2:void 0),this.last_save_version=this.file_version;break;default:throw new Error("invalid file type")}if(s&&t){let l=new Blob([s],{type:"text/plain;charset=utf-8"});this.SaveAs(l,t)}}LoadCSV(t,r){if(this.parent_view)return this.parent_view.LoadCSV(t,r);this.grid.FromCSV(t),this.ResetInternal(),this.grid.Update(!0),this.Publish({type:"load",source:r}),this.UpdateDocumentStyles()}ScrollOffset(t){return this.grid.ScrollOffset(t)}LoadDocument(t,r={}){if(this.parent_view)return this.parent_view.LoadDocument(t,r);if(this.initial_load_source||(this.initial_load_source=r.source),r={flush:!0,recalculate:!1,...r},r.override_selection&&t.sheet_data){let a=Array.isArray(t.sheet_data)?t.sheet_data:[t.sheet_data];for(let i of a)if(i.id===r.override_selection.target.sheet_id){i.selection=r.override_selection;break}}if(this.ImportDocumentData(t,r.override_sheet),this.calculator.Reset(),t.rendered_values&&!r.recalculate?(this.calculator.RebuildClean(!0),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update()):this.Recalculate(),this.InflateAnnotations(),r.flush&&this.FlushUndo(),this.Publish({type:"load",source:r.source}),this.UpdateDocumentStyles(),this.loaded=!0,r.scroll){let a=r.scroll;Promise.resolve().then(()=>this.ScrollTo(a))}}SetNote(t,r){if(typeof t=="string"){let a=this.model.ResolveAddress(t,this.grid.active_sheet);t=$(a)?a:a.start}this.grid.SetNote(t,r)}SetValidation(t,r,a){if(typeof t=="string"){let i=this.model.ResolveAddress(t,this.grid.active_sheet);t=Pr(i)?new k(i.start,i.end):new k(i)}if($(t)&&(t=new k(t)),typeof r>"u"||Array.isArray(r))this.grid.SetValidation(t,r,a);else{let i=this.model.ResolveArea(r,this.grid.active_sheet);this.grid.SetValidation(t,i,a)}}RemoveFunction(t){let r=t.toUpperCase();this.model.macro_functions.delete(r),this.UpdateAC()}DefineFunction(t,r="",a="0"){if(!t.length||/^[^A-Za-z]/.test(t)||/[^\w_.]/.test(t))throw new Error("invalid function name");typeof r=="string"&&(r=r?r.split(this.parser.argument_separator).map(i=>i.trim()):[]);for(let i of r)if(!i.length||/^[^A-Za-z]/.test(i)||/[^\w_.]/.test(i))throw new Error("invalid argument name");this.RemoveFunction(t),this.grid.model.macro_functions.set(t.toUpperCase(),{name:t,function_def:a,argument_names:r,expression:this.parser.Parse(a).expression}),this.UpdateAC()}SerializeDocument(t={}){t={share_resources:!0,shrink:!0,...t};let r=this.Serialize(t),a={app:"riskamp-web",version:"32.1.1",revision:this.file_version,name:this.grid.model.document_name,user_data:this.grid.model.user_data,decimal_mark:G.decimal_separator,...r};if(t.share_resources){let i=1,s=new Map,o=Array.isArray(a.sheet_data)?a.sheet_data:[a.sheet_data],n=h=>{let d=s.get(h);return d||(d=(i++).toString(),s.set(h,d)),`resource:${d}`};for(let h of o)if(h){h.background_image&&(h.background_image=n(h.background_image));for(let d of h.annotations||[])d.type==="image"&&d.data?.src&&(d.data.src=n(d.data.src))}let l={};for(let[h,d]of s.entries())l[d]=h;a.shared_resources=l}return t.rendered_values&&(a.rendered_values=!0),a}Recalculate(t){let r;t&&t.type==="data"&&t.area&&(r=t.area),this.calculator.Calculate(r),this.calculator.grid_expanded&&this.grid.UpdateLayout(),this.ApplyConditionalFormats(this.grid.active_sheet,!1),this.grid.Update(!0),this.UpdateAnnotations(),this.Publish({type:"data"}),this.grid.UpdateStats()}SaveLocalStorage(t=this.options.local_storage){if(!t){console.warn("not saving, no key");return}let r=JSON.stringify(this.SerializeDocument({rendered_values:!0,expand_arrays:!0}));localStorage.setItem(t,r)}Undo(){if(this.parent_view)return this.parent_view.Undo();if(this.undo_pointer<=1){console.warn("nothing to undo");return}let t=this.undo_stack[--this.undo_pointer-1],r=t.selection?JSON.parse(t.selection):void 0;this.LoadDocument(JSON.parse(t.data),{flush:!1,override_selection:r,source:"undo"})}About(){this.dialog?.ShowDialog({type:"about"})}ScrollIntoView(t,r=!1){if(typeof t=="string"){let a=this.model.ResolveAddress(t,this.grid.active_sheet);t=$(a)?a:a.start}this.grid.ScrollIntoView(t,r)}ScrollTo(t,r={}){if(typeof t=="string"){let a=this.model.ResolveAddress(t,this.grid.active_sheet);t=$(a)?a:a.start}r={x:!0,y:!0,smooth:!1,...r},this.grid.ScrollTo(t,r.x,r.y,r.smooth)}Resolve(t,r){let a=this.model.ResolveAddress(t,this.grid.active_sheet,r);return $(a)?a.sheet_id?a:void 0:a.start.sheet_id?a:void 0}Unresolve(t,r=!0,a=!0){if(typeof t=="string"){let i=this.Resolve(t);if(!i)throw new Error("invalid reference");t=i}return this.calculator.Unresolve(t,this.grid.active_sheet,r,a)}Evaluate(t,r={}){return this.calculator.Evaluate(t,this.grid.active_sheet,r)}GetSelection(t=!0){let r=this.grid.GetSelection();if(r.empty)return"";let a="";if(r.area.count>1?a=k.CellAddressToLabel(r.area.start)+":"+k.CellAddressToLabel(r.area.end):a=k.CellAddressToLabel(r.area.start),!t)return a;let i=r.area.start.sheet_id||this.grid.active_sheet.id,s=this.calculator.ResolveSheetName(i,!0);return s?s+"!"+a:a}ParseNumber(t){return rt.TryParse(t).value}FormatNumber(t,r="General"){return Ne(t)?Ie.FormatPartsAsText(V.Get(r).FormatComplex(t)):V.Get(r).Format(t)}SpreadsheetDate(t){return t instanceof Date&&(t=t.getTime()),Qe(t,!0)}JavascriptDate(t){return et(t).getTime()}ApplyBorders(t,r,a=1){this.grid.ApplyBorders2(t?this.model.ResolveArea(t,this.grid.active_sheet):void 0,r,{},a)}ApplyStyle(t,r={},a=!0){this.grid.ApplyStyle(t?this.model.ResolveArea(t,this.grid.active_sheet):void 0,r,a)}ClearName(t){this.grid.SetName(t)}ListNames(){return this.model.SerializeNames()}DefineName(t,r,a,i=!1){if(typeof r>"u"||r===null)throw new Error("invalid value (null or undefined)");if(typeof a=="string"){let s=this.model.sheets.ID(a);if(typeof s=="number")a=s;else throw new Error("invalid scope; use a sheet name or sheet id")}if(typeof r=="object"&&($(r)||Pr(r))){this.grid.SetName(t,this.model.ResolveArea(r,this.grid.active_sheet),void 0,a,i);return}if(typeof r=="string"){let s=this.parser.Parse(r);if(!s.expression)throw new Error("invalid expression");switch(s.expression.type){case"address":case"range":this.grid.SetName(t,this.model.ResolveArea(s.expression,this.grid.active_sheet),void 0,a,i);return}this.grid.SetName(t,void 0,r,a,i)}else this.grid.SetName(t,void 0,r.toString(),a,i)}SetLink(t,r=""){if(typeof t=="string"){let a=this.model.ResolveAddress(t,this.grid.active_sheet);t=$(a)?a:a.start}if(!t){let a=this.GetSelectionReference();if(a.empty)return;t=a.target}this.grid.SetLink(t,r)}Select(t){let r;t&&(r=this.model.ResolveArea(t,this.grid.active_sheet),r.start.sheet_id&&r.start.sheet_id!==this.grid.active_sheet.id&&this.grid.ActivateSheetID(r.start.sheet_id)),this.grid.SelectRange(r)}Paste(t,...r){let a=Ke.clipboard,i={};switch(r.length){case 1:Array.isArray(r[0])?a=r[0]:typeof r[0]=="object"&&(i=r[0]);break;case 2:r[0]&&Array.isArray(r[0])&&(a=r[0]),r[1]&&typeof r[1]=="object"&&(i=r[1]);break}if(!a)throw new Error("no clipboad data");this.grid.PasteArea(this.RangeOrSelection(t,"no range and no selection"),a,i)}Copy(t){let r=this.RangeOrSelection(t),a=r?this.grid.CopyArea(r,"copy"):[];return Ke.clipboard=structuredClone(a),a}Cut(t){let r=this.RangeOrSelection(t),a=r?this.grid.CopyArea(r,"cut"):[];return Ke.clipboard=structuredClone(a),a}GetRange(t,r={}){let a=this.RangeOrSelection(t);if(!a)return;let i=r.type;return i||(r.formatted&&(i="formatted"),r.formula&&(i="A1")),i==="formula"&&(i="A1"),this.grid.GetRange(a,i)}GetStyle(t,r=!1){let a=this.RangeOrSelection(t);if(a)return this.grid.GetRangeStyle(a,r)}SetRange(t,r=void 0,a={}){let i=this.RangeOrSelection(t);if(i){if(a.spill&&Array.isArray(r)){let s=r.length,o=Math.max(0,...r.map(l=>l.length)),n={row:i.start.row+s+1,column:i.start.column+o+1};i.ConsumeAddress(n)}return this.grid.SetRange(i,r,a)}}Subscribe(t){return this.events.Subscribe(t)}Cancel(t){this.events.Cancel(t)}RangeOrSelection(t,r){if(!t){let a=this.GetSelectionReference();if(a.empty){if(r)throw r;return}else return a.area.Clone()}return this.model.ResolveArea(t,this.grid.active_sheet)}Serialize(t={}){let r=this.grid.active_sheet;r.selection=JSON.parse(JSON.stringify(this.grid.GetSelection()));let a=this.grid.ScrollOffset();a&&(r.scroll_offset=a);let i=this.model.sheets.list.map(l=>l.toJSON(t)),s;this.model.tables.size>0&&(s=Array.from(this.model.tables.values()));let o;if(this.model.macro_functions.size){o=[];for(let l of this.model.macro_functions.values())o.push({...l,expression:void 0})}let n=this.model.SerializeNames(r);return{sheet_data:i,active_sheet:r.id,named:n.length?n:void 0,macro_functions:o,tables:s}}ApplyConditionalFormats(t,r){let a=[];if(t.conditional_formats.length||t.flush_conditional_formats){for(let i of t.conditional_formats)a.push(i.area),i.type==="gradient"&&(i.internal||(i.internal={}),i.internal.gradient||(i.internal.gradient=new Qo(i.stops,this.grid.theme,i.color_space)));t.ApplyConditionalFormats()}r&&this.grid.Update(!0,a)}ResolveTable(t){let r;if(typeof t=="string"){let a=t.toLowerCase();this.model.tables.has(a)&&(r=this.model.tables.get(a))}if(!r){let a=this.model.ResolveAddress(t,this.grid.active_sheet);$(a)||(a=a.start),r=this.grid.GetTableReference(a)}return r}SaveAs(t,r){let a=this.DOM.Create("a");a.href=URL.createObjectURL(t),a.download=r,a.click(),URL.revokeObjectURL(a.href)}Publish(t){this.events.Publish(t)}async ImportXLSX(t,r){return this.parent_view?this.parent_view.ImportXLSX(t,r):(this.export_worker||(this.export_worker=await this.LoadWorker()),new Promise((a,i)=>{this.export_worker?(this.dialog?.ShowDialog({message:"Importing XLSX..."}),this.export_worker.onmessage=s=>{if(s.data){if(s.data.status==="error")return i(s.data.error||"unknown error");if(this.parser.decimal_mark!=="."){let o=this.parser.decimal_mark,n=this.parser.argument_separator;this.parser.Save(),this.parser.SetLocaleSettings(".");let l=h=>{let d=this.parser.Parse(h);if(d.expression)return"="+this.parser.Render(d.expression,{missing:"",convert_decimal:o,convert_argument_separator:n})};for(let h of s.data.results)h.expression=l(h.expression);for(let h of s.data.results.sheets||[]){for(let d of h.cells||[])d.type==="formula"&&d.value&&(d.value=l(d.value));if(h.annotations)for(let d of h.annotations)d.formula&&(d.formula=l(d.formula))}this.parser.Restore()}this.grid.FromImportData(s.data.results),this.ResetInternal(),this.grid.Update(),this.UpdateAC(),this.Publish({type:"load",source:r}),this.UpdateDocumentStyles(),this.InflateAnnotations(),this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(this.grid.active_sheet,!1)}else return i("unknown error (missing data)");this.dialog?.HideDialog(),a()},this.export_worker.onerror=s=>{console.error("import worker error"),console.info(s),i(s)},this.export_worker.postMessage({command:"import",data:t})):i("worker failed")}))}ResetInternal(){this.calculator.Reset(),this.FlushUndo(),this.file_version=this.last_save_version=0}HandleCellEvent(t){if(t.data?.type==="hyperlink"){let r="hyperlink invalid target",a=t.data.reference||"";if(typeof a=="string"){if(/^https{0,1}:\/\//i.test(a)){if(!this.options.hyperlinks){console.warn("hyperlinks are disabled");return}let i=this.DOM.Create("a");i.setAttribute("target",this.options.hyperlinks),i.setAttribute("href",a),i.setAttribute("noreferrer","true"),i.setAttribute("nofollow","true"),i.click();return}else{let i=this.parser.Parse(a);if(i.expression){if(i.expression.type==="address"){(i.expression.sheet||i.expression.sheet_id)&&this.ActivateSheet(i.expression.sheet||i.expression.sheet_id),this.Select(a);return}else if(i.expression.type==="range"){(i.expression.start.sheet||i.expression.start.sheet_id)&&this.ActivateSheet(i.expression.start.sheet||i.expression.start.sheet_id),this.Select(a);return}}}console.warn(r,2);return}}}OnSheetChange(t){for(let r of t.activate.annotations)this.InflateAnnotation(r),this.calculator.UpdateAnnotations(r,t.activate);this.UpdateAnnotations(),this.calculator.UpdateConditionals(),this.ApplyConditionalFormats(t.activate,!0)}HandleDrag(t){if(t.dataTransfer&&t.dataTransfer.types){if(t.dataTransfer.types.some&&t.dataTransfer.types.some(r=>r==="Files"))t.preventDefault();else for(let r=0;r<t.dataTransfer.types.length;r++)if(t.dataTransfer.types[r]==="files"){t.preventDefault();return}}}HandleDrop(t){if(t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length){t.preventDefault();let r=t.dataTransfer.files[0];/^image/.test(r.type)?this.InsertImageInternal(r):this.LoadFileInternal(r,"drag-and-drop").catch(()=>{})}}SelectFile2(t,r){if(!this.file_chooser){let a=this.DOM.Create("input",void 0,void 0,{attrs:{type:"file"},events:{change:()=>{if(a.files&&a.files[0]){let i=a.files[0];switch(a.value="",this.file_chooser_operation){case 2:this.InsertImageInternal(i);break;case 1:this.LoadFileInternal(i,"local-file",!0);break;default:console.warn("file chooser: no operation");break}}}}});this.file_chooser=a}if(!this.file_chooser)throw new Error("could not create file chooser");this.file_chooser_operation=r,this.file_chooser.accept=t||"",this.file_chooser.click()}async InsertImageInternal(t){if(this.options.max_file_size&&t.size>this.options.max_file_size){this.dialog?.ShowDialog({type:"error",message:"This file exceeds the allowed image size. Please try a smaller image.",title:"Error adding image",timeout:3e3,close_box:!0});return}let r=t;await new Promise((a,i)=>{let s=new FileReader;s.onload=async()=>{try{if(s.result){let o;if(typeof s.result=="string")o=s.result;else{o="";let l=new Uint8Array(s.result);for(let h=0;h<l.byteLength;h++)o+=String.fromCharCode(l[h])}let n=this.DOM.Create("img");n.src=o,await Promise.resolve(),this.grid.CreateAnnotation({type:"image",formula:"",data:{scale:"",src:o,original_size:{width:n.width||300,height:n.height||300}}},void 0,void 0,void 0,{top:30,left:30,width:n.width||300,height:n.height||300})}a()}catch(o){i(o)}},s.onabort=()=>{i("Aborted")},s.onerror=()=>{i("File error")},setTimeout(()=>{s.readAsDataURL(r)},100)})}LoadFileInternal(t,r,a=!0){if(!t)return Promise.resolve();let i=new FileReader;return new Promise((s,o)=>{let n=l=>{i.onload=null,i.onabort=null,i.onerror=null,l?(a&&(this.dialog?.ShowDialog({title:"Error reading file",close_box:!0,message:"Please make sure your file is a valid XLSX, CSV or TREB file.",type:"error",timeout:3e3}),console.error(l)),o(l)):s()};i.onload=()=>{try{if(i.result)if(/\.csv$/i.test(t.name))this.LoadCSV(i.result,r);else if(/\.xls[xm]$/i.test(t.name)){typeof i.result=="string"?n("Unsupported file"):this.ImportXLSX(i.result,r).then(()=>n()).catch(l=>n(l));return}else{let l=JSON.parse(i.result);this.LoadDocument(l,{source:r})}n()}catch(l){n(l?.toString())}},i.onabort=()=>{n("Aborted")},i.onerror=()=>{n("File error")},setTimeout(()=>{/\.xls[xm]$/i.test(t.name)?i.readAsArrayBuffer(t):i.readAsText(t)},100)})}UpdateAnnotations(){for(let t of this.grid.active_sheet.annotations){let r=t.temp;if(r.vertex&&r.vertex.state_id!==r.state){r.state=r.vertex.state_id;for(let i of t.view)i&&(i.dirty=!0)}let a=t.view[this.grid.view_index]||{};a.dirty&&(a.dirty=!1,a.update_callback&&a.update_callback(),this.grid.AnnotationUpdated(t))}this.UpdateConnectedElements()}UpdateConnectedElements(){for(let t of this.model.connected_elements.values()){let r=t.internal;if(r?.vertex&&r.vertex.state_id!==r.state){r.state=r.vertex.state_id;let a=t.update;a&&Promise.resolve().then(()=>a.call(0,t))}}}RebuildAllAnnotations(){for(let t of this.grid.active_sheet.annotations){this.InflateAnnotation(t);let r=t.view[this.grid.view_index]||{};r.resize_callback&&r.resize_callback(),r.update_callback&&r.update_callback()}}InflateAnnotations(){for(let t of this.grid.active_sheet.annotations)this.InflateAnnotation(t)}InflateAnnotation(t){if(this.grid.headless)return;let r=t.view[this.grid.view_index]||{};if(r.inflated){t.dirty&&(r.resize_callback&&r.resize_callback(),t.dirty=!1);return}if(r.inflated=!0,t.dirty&&(t.dirty=!1),r.content_node){if(t.data.type==="treb-chart"){let a=this.CreateChart();a.Initialize(r.content_node);let i=()=>{if(t.data.formula){let s=this.parser.Parse(t.data.formula);if(s&&s.expression&&s.expression.type==="call"){this.parser.Walk(s.expression,l=>((l.type==="address"||l.type==="range")&&this.model.ResolveSheetID(l,void 0,this.grid.active_sheet),!0));let o=s.expression.name.toLowerCase(),n=this.calculator.CalculateExpression(s.expression);a.Exec(o,n)}}a.Update()};r.resize_callback=()=>{this.grid.headless||(a.Resize(),a.Update())},r.update_callback=()=>{this.grid.headless||i()},r.node?.parentElement&&(this.grid.headless||i())}else if(t.data.type==="image"){if(typeof t.data.data?.src=="string"){let a=Hi(t.data.data.src);if(a){let i=this.DOM.Create("img");i.src=a,t.data.data.scale==="fixed"?(i.style.position="relative",i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)"):(i.style.width="100%",i.style.height="100%"),r.content_node.appendChild(i)}}}else if(t.data.type==="textbox"&&t.data.data){let a,i=document.createElement("div");i.classList.add("treb-annotation-textbox");for(let s of t.data.data.paragraphs){let o=document.createElement("p");s.style&&(s.style.horizontal_align==="right"||s.style.horizontal_align==="center")&&(o.style.textAlign=s.style.horizontal_align);for(let n of s.content){let l=document.createElement("span");if(a||(a=l),t.data.formula||(l.textContent=n.text||""),n.style?.bold&&(l.style.fontWeight="600"),n.style?.italic&&(l.style.fontStyle="italic"),o.appendChild(l),t.data.formula)break}if(i.append(o),t.data.formula)break}if(r.content_node.append(i),t.data.data.style){let s=t.data.data.style,o=()=>{if(s.fill){let n=N(this.grid.theme,s.fill);i.style.background=n}};r.update_callback=()=>{if(this.grid.headless||o(),a&&t.data.formula){let n=this.parser.Parse(t.data.formula);if(n&&n.expression){this.parser.Walk(n.expression,c=>((c.type==="address"||c.type==="range")&&this.model.ResolveSheetID(c,void 0,this.grid.active_sheet),!0));let l=this.calculator.CalculateExpression(n.expression),h=V.Get("General"),d;switch(n.expression.type){case"address":d=n.expression;break;case"range":d=n.expression.start;break}if(d){let c=(d.sheet_id?this.model.sheets.Find(d.sheet_id):this.grid.active_sheet)?.CellStyleData(d);c?.number_format&&(h=V.Get(c.number_format))}switch(l.type){case 3:case 2:case 7:a.textContent=h.Format(l.value);break;default:a.textContent=l.value?.toString()||""}}}},r.update_callback()}}}}DocumentChange(t){Promise.resolve().then(()=>{this.file_version++,this.file_version>=65536&&(this.file_version=1);let r=JSON.stringify(this.SerializeDocument({optimize:"size",rendered_values:!0,expand_arrays:!0}));this.options.undo&&this.PushUndo(r,t,!1),this.Publish({type:"document-change"})})}ResolveStorageKey(t,r=""){if(t){if(t===!0){let a=0,i=document.location.href;for(let o=0,n=i.length;o<n;o++)a=(a<<5)-a+i.charCodeAt(o),a|=0;let s=Math.abs(a).toString(16);return r?r+"-"+s:s}return t}}PushUndo(t,r,a=!0){let i=r||this.last_selection;this.undo_stack[this.undo_pointer-1]&&(this.undo_stack[this.undo_pointer-1].selection=i),a&&(this.file_version++,this.file_version>=65536&&(this.file_version=1)),t||(t=JSON.stringify(this.SerializeDocument({optimize:"size",rendered_values:!0,expand_arrays:!0}))),this.undo_stack[this.undo_pointer++]={data:t,selection:void 0};let s=this.undo_stack.length;if(s>16){let o=s-16;this.undo_stack=this.undo_stack.slice(o),this.undo_pointer-=o}}FlushUndo(t=!0){this.undo_stack=[],this.undo_pointer=0,this.last_save_version=this.file_version,t&&this.PushUndo(void 0,void 0,!1)}UpdateSelection(t){this.last_selection=JSON.stringify(t),this.Publish({type:"selection"})}UpdateSelectionStyleAnnotation(t){let r={style:JSON.parse(JSON.stringify(t.data.style||{}))};r.style&&(r.style.font_face||(r.style.font_face="stack:ui"),r.style.font_size||(r.style.font_size={unit:"em",value:1})),r.relative_font_size=H.RelativeFontSize(r.style||{},this.grid.theme.grid_cell||{}),this.selection_state=r}UpdateSelectionStyle(t){let r=this.grid.GetFreeze(),a={frozen:!!r.rows||!!r.columns};if(t||(t=this.grid.GetSelection()),t&&!t.empty){a.selection=t;let i=this.grid.active_sheet.CellData(t.target);a.table=!!i.table,a.merge=!!i.merge_area,a.merge&&i.merge_area&&(i.merge_area.start.row!==t.target.row||i.merge_area.start.column!==t.target.column)&&(i=this.grid.active_sheet.CellData(i.merge_area.start)),a.comment=i.note,a.style=i.style?{...i.style}:void 0,a.relative_font_size=H.RelativeFontSize(a.style||{},this.grid.theme.grid_cell||{}),a.empty=typeof i.value>"u"&&!i.style?.font_face}this.grid?.edit_state&&(this.grid.edit_state.font_face=a.style?.font_face||void 0),this.selection_state=a}UpdateDocumentStyles(){let t={},r={};for(let i of this.grid.model.sheets.list)i.NumberFormatsAndColors(r,t);this.document_styles.colors=Object.keys(r),this.document_styles.number_formats=Object.keys(t),this.document_styles.theme_colors=[];let a=[.5,.25,0,-.25,-.5];for(let i=0;i<10;i++)this.document_styles.theme_colors.push(a.map(s=>{let o={theme:i,tint:s},n=N(this.grid.theme,o);return{color:o,resolved:n}}))}ConvertLocale(t){let r=new Di;r.flags={...this.parser.flags};let a,i;t.decimal_mark==="."?(r.SetLocaleSettings("."),a=",",i=";"):(r.SetLocaleSettings(","),a=".",i=",");let s=o=>{let n=r.Parse(o);if(n.expression)return"="+r.Render(n.expression,{missing:"",convert_decimal:a,convert_argument_separator:i})};if(t.macro_functions)for(let o of t.macro_functions){let n=s(o.function_def);n&&(o.function_def=n)}if(t.named)for(let o of t.named){let n=s(o.expression);n&&(o.expression=n)}if(t.sheet_data){let o=Array.isArray(t.sheet_data)?t.sheet_data:[t.sheet_data];for(let n of o){if(n.annotations){for(let l of n.annotations)if(l.formula){let h=s(l.formula);h&&(l.formula=h)}}if(n.data?.length)for(let l of n.data){let h=Ni(l)?[l]:l.cells;for(let d of h)if(d.value&&typeof d.value=="string"&&d.value[0]==="="){let c=s(d.value.slice(1));c&&(d.value=c)}}}}}CompareVersions(t="",r=""){let a=t.split(".").map(n=>Number(n)||0).concat([0,0,0]),i=r.split(".").map(n=>Number(n)||0).concat([0,0,0]),s=[0,1,2],o={match:0};for(let n=0;n<3;n++)if(a[n]!==i[n]){o.match=a[n]>i[n]?1:-1,o.level=s[n];break}return o}ImportDocumentData(t,r){this.file_version=t.revision||0;let a=[],i=this.CompareVersions(t.version,"32.1.1");if(i.match>0&&(i.level===0||i.level===1)&&console.warn(`The file you are opening was created with a newer version of TREB (${t.version} vs 32.1.1).
You may encounter compatibility errors.`),t.sheet_data&&(Array.isArray(t.sheet_data)?a=t.sheet_data:a.push(t.sheet_data)),t.shared_resources){let o=t.shared_resources,n=l=>/^resource:/.test(l)?o[l.substring(9)]||"":l;for(let l of a){l.background_image&&(l.background_image=n(l.background_image));for(let h of l.annotations||[])h.type==="image"&&h.data?.src&&(h.data.src=n(h.data.src))}}t.decimal_mark&&t.decimal_mark!==G.decimal_separator&&this.ConvertLocale(t);let s=this.grid.model;if(s.tables.clear(),t.tables)for(let o of t.tables)s.tables.set(o.name.toLowerCase(),o);this.grid.UpdateSheets(a,void 0,r||t.active_sheet);for(let o of this.model.tables.values())if(o.area.start.sheet_id){let n=s.sheets.Find(o.area.start.sheet_id);if(n)for(let l=o.area.start.row;l<=o.area.end.row;l++)for(let h=o.area.start.column;h<=o.area.end.column;h++){let d=n.cells.GetCell({row:l,column:h},!0);d.table=o}}if(s.document_name=t.name,s.user_data=t.user_data,s.named.Reset(),t.named)this.model.UnserializeNames(t.named,this.grid.active_sheet);else{let o=t.named_ranges;if(!o&&a[0]&&a[0].named_ranges&&(o=a[0].named_ranges),o)for(let[n,l]of Object.entries(o))s.named.SetNamedRange(n,new k(l.start,l.end));if(t.named_expressions)for(let n of t.named_expressions)this.model.UnserializeNames([{name:n.name,expression:n.expression}],this.grid.active_sheet)}if(s.macro_functions.clear(),t.macro_functions)for(let o of t.macro_functions)s.macro_functions.set(o.name.toUpperCase(),{...o,expression:this.parser.Parse(o.function_def||"").expression});this.UpdateAC()}async LoadWorker(){try{return await(await pe(async()=>{const{CreateWorker:t}=await import("./treb-export-worker.Baqh0Tfd.js");return{CreateWorker:t}},[])).CreateWorker()}catch(t){throw console.error(t),t}}HandleKeyDown(t){t.key==="z"?(ae.is_mac&&t.metaKey||t.ctrlKey)&&(t.stopPropagation(),t.preventDefault(),this.Undo()):t.key==="F9"&&this.options.recalculate_on_f9&&(t.stopPropagation(),t.preventDefault(),this.Recalculate())}},gl=`@charset "UTF-8";.treb-main.treb-main .treb-mouse-mask{background:transparent;bottom:0;display:none;left:0;position:fixed;right:0;top:0;z-index:9999}.treb-main.treb-main .treb-mouse-mask.column-resize{cursor:col-resize}.treb-main.treb-main .treb-mouse-mask.row-resize{cursor:row-resize}.treb-main.treb-main .treb-mouse-mask.nub-select{cursor:crosshair}.treb-main.treb-main .treb-mouse-mask.move{cursor:move}.treb-main.treb-main .treb-mouse-mask.nw-resize{cursor:nw-resize}.treb-main.treb-main .treb-note{max-width:15em;min-width:15em}.treb-main.treb-main .treb-hover-title,.treb-main.treb-main .treb-note{background:var(--treb-note-background,#fff);border:1px solid var(--treb-note-border-color,var(--treb-ui-border-color,#ddd));border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);color:var(--treb-note-color,#333);font-family:BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif";font-size:10.5pt;left:100px;line-height:normal;opacity:0;padding:7px 10px;position:fixed;top:100px;transition:opacity .2s;white-space:pre-line;z-index:39}.treb-main.treb-main .treb-hover-title{min-width:10em;pointer-events:none}.treb-main.treb-main .treb-sort-button{background:#fff;border:1px solid #ccc;border-radius:2px;height:1em;left:100px;opacity:0;pointer-events:none;position:absolute;top:100px;transition:opacity .1s ease;width:1em;z-index:39}.treb-main.treb-main .treb-sort-button:after{box-sizing:border-box}.treb-main.treb-main .treb-sort-button.asc:after{border:.4em solid transparent;border-top-color:currentcolor;content:"";height:.8em;left:50%;opacity:.5;position:absolute;top:50%;transform:translate(-50%,-25%);width:.8em}.treb-main.treb-main .treb-sort-button.desc:after{border:.4em solid transparent;border-bottom-color:currentcolor;content:"";height:.8em;left:50%;opacity:.5;position:absolute;top:50%;transform:translate(-50%,-80%);width:.8em}.treb-main.treb-main .treb-tooltip{border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);display:none;line-height:normal;padding:2px 10px;pointer-events:none;position:fixed;z-index:39}.treb-main.treb-main .treb-tooltip.arrow-up:after{border:4px solid transparent;border-bottom-color:inherit;box-sizing:border-box;content:" ";height:8px;left:calc(50% - 4px);overflow:hidden;position:absolute;top:-8px;width:8px}.treb-main.treb-main .treb-tooltip.arrow-left:after{border:4px solid transparent;border-right-color:inherit;box-sizing:border-box;content:" ";height:8px;left:-8px;overflow:hidden;position:absolute;top:calc(50% - 4px);width:8px}.treb-main.treb-main .treb-dropdown-caret{background:var(--treb-dropdown-caret-background,#fff);border:1px solid var(--treb-dropdown-caret-border-color,#ccc);border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);display:none;height:20px;position:absolute;width:20px;z-index:39}.treb-main.treb-main .treb-dropdown-caret path{fill:none;stroke:var(--treb-dropdown-caret-color,#444);stroke-linecap:round;stroke-linejoin:round;stroke-width:2}.treb-main.treb-main .treb-dropdown-list{background:var(--treb-dropdown-background,#fff);border:1px solid var(--treb-dropdown-border-color,unset);box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);color:var(--treb-dropdown-color,inherit);display:none;font-size:10pt;max-height:10em;outline:none;overflow-y:auto;position:absolute;text-align:left;z-index:39}.treb-main.treb-main .treb-dropdown-list div{cursor:default;padding:2px}.treb-main.treb-main .treb-dropdown-list div.selected{background:var(--treb-dropdown-selected-background,#555);color:var(--treb-dropdown-selected-color,#fff)}.treb-main.treb-main .treb-dropdown-caret.active{background:var(--treb-dropdown-caret-active-background,#eee)}.treb-main.treb-main .treb-dropdown-caret.active+.treb-dropdown-list{display:block}.treb-main.treb-main .treb-error-highlight{background:rgba(255,0,0,.25);opacity:0;pointer-events:none;position:absolute;transition:opacity .15s ease-in-out;z-index:40}.treb-main.treb-main .treb-autocomplete{box-sizing:border-box;font-size:inherit;font-weight:400;line-height:normal;max-height:10em;overflow-y:auto;position:fixed;text-align:left;top:-1000px;z-index:39}.treb-main.treb-main .treb-autocomplete *{box-sizing:border-box}.treb-main.treb-main .treb-autocomplete ul{list-style-type:none}.treb-main.treb-main .treb-autocomplete ul,.treb-main.treb-main .treb-autocomplete ul li{font-size:inherit;font-weight:inherit;margin:0;padding:0}.treb-main.treb-main .treb-autocomplete ul li a{color:inherit;cursor:default;display:inline-block;font-size:inherit;font-weight:inherit;padding:3px 6px;text-decoration:none;width:100%}.treb-main.treb-main .treb-autocomplete-tooltip{position:fixed;top:-1000px;white-space:pre;z-index:39}.treb-main.treb-main .treb-formula-bar{display:flex;flex-direction:row;gap:.5em;grid-area:1/1/2/2;max-width:100%;overflow-x:hidden;padding:0 2px 12px;text-align:left}.treb-main.treb-main .treb-formula-bar[hidden]{display:none}.treb-main.treb-main .treb-formula-bar .treb-address-label{border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;display:flex;flex-direction:column;height:1.75em;justify-content:center;min-height:1.5em;min-width:95px;padding-left:3px;width:95px}.treb-main.treb-main .treb-formula-bar .treb-address-label>div{outline:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.treb-main.treb-main .treb-formula-bar .treb-insert-function-button{background:transparent;border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;height:1.75em;min-height:1.5em}.treb-main.treb-main .treb-formula-bar .treb-insert-function-button[hidden]{display:none}.treb-main.treb-main .treb-formula-bar .expand-button{background:transparent;border:0;border-radius:2px;height:1.75em;margin-left:2px;outline:none;padding:1px}.treb-main.treb-main .treb-formula-bar .expand-button:after{border:5px solid transparent;border-top-color:#999;content:" ";display:inline-block;margin:0;padding:0;position:relative;top:-6px;transition:transform .15s ease}.treb-main.treb-main .treb-formula-bar[expanded] .expand-button:after{transform:rotate(180deg) translateY(6px)}.treb-main.treb-main .treb-formula-bar .treb-editor-container{border:1px solid var(--treb-formula-bar-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;display:flex;flex-direction:column;flex-grow:1;height:1.75em;justify-content:center;min-width:0}.treb-main.treb-main .treb-formula-bar .treb-editor-container>.treb-editor-shadow{opacity:.4}.treb-main.treb-main .treb-formula-bar[expanded] .treb-editor-container{height:4.5em;transition:height .1s ease-in-out}.treb-main.treb-main .treb-formula-bar[expanded] .treb-editor-container>div{overflow-y:auto}.treb-main.treb-main .treb-formula-bar .treb-editor-container>div{flex-grow:1;line-height:1.35;margin:2px;min-height:1em;outline:none;overflow-x:hidden;overflow-y:hidden;white-space:pre-wrap;width:100%}.treb-main.treb-main .treb-mouse-mask .ghost-tab{position:fixed}.treb-main.treb-main .treb-spreadsheet-footer{align-items:center;grid-area:3/1/4/2}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tab-container{align-self:flex-start;height:2.2em;overflow:hidden}.treb-main.treb-main .treb-spreadsheet-footer,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs{color:var(--treb-ui-color,inherit);display:flex;flex-direction:row;height:2.2em;list-style-type:none;max-width:100%;padding-inline-start:0;z-index:2}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs{height:auto;margin-block-start:0;margin:0;overflow-x:scroll;overflow-y:hidden}.treb-main.treb-main .treb-spreadsheet-footer[hidden]{display:none}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{display:inline-block;position:relative}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{align-items:center;border-bottom-left-radius:5px;border-bottom-right-radius:5px;border-top-width:1px;border:1px solid var(--treb-tab-bar-tab-border-color,var(--treb-ui-border-color,#ccc));border-top:0 solid var(--treb-tab-bar-tab-border-color,var(--treb-ui-border-color,#ccc));color:var(--treb-tab-bar-tab-color,var(--treb-ui-color,#fff));cursor:default;display:inline-flex;font-size:inherit;height:100%;justify-content:center;margin-right:-2px;overflow:hidden;padding:0 .75em;z-index:1}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:focus{z-index:3}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{height:2.2em;overflow:visible;overflow-x:visible}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li:last-of-type{margin-right:0}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab{margin-left:-1px}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{white-space:nowrap}.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li[selected]{z-index:2}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control{align-items:center;display:flex;flex-direction:row;font-size:inherit;height:2.2em;justify-content:center;position:relative;width:5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input{background:transparent;border:1px solid transparent;border-radius:2px;color:inherit;font-family:inherit;font-size:inherit;padding:initial;text-align:center;transition:border-color .25s ease,background-color .25s ease;width:4em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container{accent-color:var(--treb-scale-slider-accent-color,undefined);align-items:center;background:var(--treb-scale-slider-background,#fff);border:1px solid var(--treb-scale-slider-border-color,var(--treb-ui-border-color,#ccc));display:flex;flex-direction:row;height:4em;justify-content:center;left:.5em;opacity:0;pointer-events:none;position:absolute;top:0;transform:rotate(-90deg);transform-origin:left top;transition:opacity .25s ease;width:10em;z-index:40}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input:focus,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control:hover .treb-scale-input{border-color:var(--treb-ui-border-color,#ccc)}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container>input[type=range]{width:8.5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-scale-input:focus+.treb-slider-container,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control .treb-slider-container:focus-within,.treb-main.treb-main .treb-spreadsheet-footer .treb-scale-control:hover .treb-slider-container{opacity:.85;pointer-events:auto}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab{align-items:center;background:transparent;border:none;border-bottom-left-radius:5px;border-bottom-right-radius:5px;border-top:0;color:currentColor;cursor:default;display:inline-flex;flex-direction:row;font-size:inherit;margin-right:-2px;min-width:2.5em;padding:.25em .75em;z-index:1}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab svg{height:1em;opacity:.75;pointer-events:none;transition:opacity .125s ease-in-out;width:1em}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:hover svg{opacity:.75}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab path{stroke:currentColor;stroke-width:1.5px;stroke-linecap:round}.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:active,.treb-main.treb-main .treb-spreadsheet-footer .treb-delete-tab:focus{z-index:3}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel{flex:1 1;overflow:hidden;text-align:end;text-overflow:ellipsis;white-space:nowrap}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel>*{margin-left:.5em}.treb-main.treb-main .treb-spreadsheet-footer .treb-stats-panel .treb-stats-value{background:var(--treb-stats-value-background,#f8f8ff);border:1px solid var(--treb-stats-value-border-color,var(--treb-ui-border-color,#ddd));border-radius:3px;padding:0 .3em}.treb-main.treb-main .treb-grid .treb-overlay-container{margin:0;opacity:0;outline:none;padding:0;position:absolute;z-index:24}.treb-main.treb-main .treb-grid .treb-overlay-container.align-right .treb-overlay-inset{padding-right:3px;right:0;text-align:right}.treb-main.treb-main .treb-grid .treb-overlay-container.align-center .treb-overlay-inset{left:50%;text-align:center;transform:translateX(-50%)}.treb-main.treb-main .treb-grid .treb-overlay-inset{display:flex;flex-direction:column;height:100%;justify-content:flex-end;margin:0;min-width:100%;padding:0 4px;position:absolute}.treb-main.treb-main .treb-grid .treb-overlay-editor{outline:none;position:relative;white-space:nowrap;white-space:pre}.treb-main.treb-main .treb-grid .treb-overlay-editor.firefox:before{content:"​"}.treb-main.treb-main .treb-spill-border{pointer-events:none;position:absolute}.treb-main.treb-main .treb-spill-border rect{stroke:var(--treb-spill-border-color,#5c5ce0);stroke-dasharray:var(--treb-spill-border-dasharray,0);fill:none;stroke-width:var(--treb-spill-border-width,1px);filter:var(--treb-spill-border-filter,drop-shadow(3px 3px 2px rgba(0,0,0,.5)));z-index:35}.treb-main.treb-main .treb-buffer-canvas{display:none;position:absolute}.treb-main.treb-main .treb-spreadsheet-body{grid-area:2/1/3/2;-webkit-overflow-scrolling:touch;-webkit-tap-highlight-color:transparent;display:flex;overflow:hidden;position:relative;z-index:1}.treb-main.treb-main .treb-grid{flex-grow:1;order:2;overflow:scroll;position:relative;-webkit-overflow-scrolling:touch;-webkit-tap-highlight-color:transparent;display:grid;grid-template-columns:100px auto;grid-template-rows:20px auto;outline:none;overscroll-behavior:none}.treb-main.treb-main .treb-grid .tile-cover.grid-cover{grid-area:2/2/3/3}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover{grid-area:1/2/2/3;position:-webkit-sticky;position:sticky;top:0}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover{grid-area:2/1/3/2;left:0;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-grid-selection{grid-area:1/1/2/2}.treb-main.treb-main .treb-grid .treb-corner{grid-area:1/1/2/2;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-left-header{display:grid;grid-area:2/1/3/2;grid-template-columns:auto;grid-template-rows:auto;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-top-header{display:grid;grid-area:1/2/2/3;grid-template-columns:auto;grid-template-rows:auto;position:-webkit-sticky;position:sticky}.treb-main.treb-main .treb-grid .treb-contents{display:grid;grid-area:2/2/3/3;grid-template-columns:auto;grid-template-rows:auto}.treb-main.treb-main .treb-grid.safari::-webkit-scrollbar{-webkit-appearance:none;height:7px;width:7px}.treb-main.treb-main .treb-grid.safari::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.25);border-radius:4px;-webkit-box-shadow:0 0 1px hsla(0,0%,100%,.5)}.treb-main.treb-main .treb-grid canvas{background:transparent;border:0;margin:0;padding:0}.treb-main.treb-main .treb-grid .nub-select{cursor:crosshair}.treb-main.treb-main .treb-grid .link-pointer{cursor:pointer}.treb-main.treb-main .treb-grid .mock-selection-node{background:red;left:-100px;position:fixed;top:-100px}.treb-main.treb-main .treb-grid .tile-cover{background:transparent;position:relative;z-index:14}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover{z-index:22}.treb-main.treb-main .treb-grid .tile-cover.column-header-cover.resize{cursor:col-resize}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover{z-index:22}.treb-main.treb-main .treb-grid .tile-cover.row-header-cover.resize{cursor:row-resize}.treb-main.treb-main .treb-grid .frozen-annotation-container,.treb-main.treb-main .treb-grid .treb-annotation-container{left:0;pointer-events:none;position:absolute;top:0;z-index:16}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation{background:hsla(0,0%,100%,.5);border:1px solid #999;overflow:hidden;pointer-events:auto;position:absolute;z-index:1}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-content,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-content{font-family:inherit;font-size:inherit;height:100%;left:0;position:absolute;top:0;width:100%;z-index:1}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-move-target,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-move-target{cursor:move;height:10%;left:0;min-height:14px;position:absolute;top:0;width:100%;z-index:2}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation .annotation-resize-target,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation .annotation-resize-target{bottom:0;cursor:nwse-resize;height:10%;min-height:14px;min-width:14px;position:absolute;right:0;width:10%;z-index:3}.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation.clone-focus,.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation.retain-focus,.treb-main.treb-main .treb-grid .frozen-annotation-container .annotation:focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation.clone-focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation.retain-focus,.treb-main.treb-main .treb-grid .treb-annotation-container .annotation:focus{box-shadow:0 0 0 3px rgba(14,165,233,.33)}.treb-main.treb-main .treb-grid .frozen-annotation-container .move-buffer,.treb-main.treb-main .treb-grid .treb-annotation-container .move-buffer{border:1px solid red;cursor:move;height:10%;left:0;position:absolute;top:0;width:100%}.treb-main.treb-main .treb-grid .treb-grid-selection{background:transparent;position:absolute;-moz-transform:scale(1);z-index:10}.treb-main.treb-main .treb-grid .frozen-selection{overflow:hidden;pointer-events:none;position:absolute;-moz-transform:scale(1);transition:background .33s;z-index:12}.treb-main.treb-main .treb-grid .frozen-selection.frozen-selection-rows{border-bottom:1px solid transparent}.treb-main.treb-main .treb-grid .frozen-selection.frozen-selection-columns{border-right:1px solid transparent}.treb-main.treb-main .treb-grid .frozen-annotation-container{height:100%;left:0;overflow:hidden;position:absolute;top:0;width:100%}.treb-main.treb-main .treb-grid .treb-corner{left:0;top:0;z-index:20}.treb-main.treb-main .treb-grid .treb-corner canvas{left:0;pointer-events:none;position:absolute;top:0}.treb-main.treb-main .treb-grid .treb-left-header{left:0;pointer-events:none;z-index:18}.treb-main.treb-main .treb-grid .treb-top-header{pointer-events:none;top:0;z-index:18}.treb-main.treb-main .treb-grid .treb-contents{height:2000px;width:2000px}.treb-main.treb-main{--alternate-selection-color-1:#fbb13c;--alternate-selection-color-2:#40c040;--alternate-selection-color-3:#b66d0d;--alternate-selection-color-4:#2176ae;--alternate-selection-color-5:#fe6847;--text-reference-color-1:#e08a00;--text-reference-color-2:#3aad3a;--text-reference-color-3:#b66d0d;--text-reference-color-4:#2176ae;--text-reference-color-5:#fe2f01}.treb-main.treb-main:focus-within .treb-grid-selection .primary-selection,.treb-main.treb-main:focus-within .treb-header-overlay{color:var(--treb-selection-color,#4caaf1)}.treb-main.treb-main .theme-color-1{color:var(--treb-theme-color-1,#e7e6e6)}.treb-main.treb-main .theme-color-2{color:var(--treb-theme-color-2,#44546a)}.treb-main.treb-main .theme-color-3{color:var(--treb-theme-color-3,#4472c4)}.treb-main.treb-main .theme-color-4{color:var(--treb-theme-color-4,#ed7d31)}.treb-main.treb-main .theme-color-5{color:var(--treb-theme-color-5,#a5a5a5)}.treb-main.treb-main .theme-color-6{color:var(--treb-theme-color-6,#ffc000)}.treb-main.treb-main .theme-color-7{color:var(--treb-theme-color-7,#5b9bd5)}.treb-main.treb-main .theme-color-8{color:var(--treb-theme-color-8,#70ad47)}.treb-main.treb-main .theme-color-9{color:var(--treb-theme-color-9,#0563c1)}.treb-main.treb-main .theme-color-10{color:var(--treb-theme-color-10,#954f72)}.treb-main.treb-main .treb-offset-dark{color:#000}.treb-main.treb-main .treb-offset-light{color:#fff}.treb-main.treb-main .note-marker{background:var(--treb-note-marker-color,#6fab20)}.treb-main.treb-main .grid-headers{background:var(--treb-grid-header-background,#eeeef2);color:var(--treb-grid-header-color,var(--treb-grid-default-color,#666));font-family:var(--treb-grid-header-font-family,inherit);font-size:var(--treb-grid-header-font-size,10pt);font-style:var(--treb-grid-header-font-style,normal);font-weight:var(--treb-grid-header-font-weight,normal);stroke:var(--treb-grid-header-grid-color,var(--treb-grid-grid-color,#ccccd4))}.treb-main.treb-main .grid-cells{color:var(--treb-grid-default-color,inherit);font-family:var(--treb-grid-font-family,inherit);font-size:var(--treb-grid-font-size,14px);stroke:var(--treb-grid-grid-color,#ccccd4);background:var(--treb-grid-background,#fff)}.treb-main.treb-main .frozen-selection.highlight-area{background:rgba(87,184,255,.25);border-bottom-color:#2176ae;border-left-color:#2176ae}.treb-main.treb-main .treb-autocomplete-tooltip{background:var(--treb-autocomplete-tooltip-background,#fffbb5);border:1px solid var(--treb-autocomplete-tooltip-border-color,unset);border-radius:2px;color:var(--treb-autocomplete-tooltip-color,inherit);font-size:14px;line-height:normal;margin:4px 0;padding:3px 8px}.treb-main.treb-main .treb-autocomplete-tooltip .active-argument{font-weight:700}.treb-main.treb-main .treb-autocomplete-tooltip .function-description{font-style:italic}.treb-main.treb-main .treb-autocomplete{background:var(--treb-autocomplete-background,#fff);border:1px solid var(--treb-autocomplete-border-color,var(--treb-ui-border-color,#ccc));border-radius:2px;box-shadow:0 1px 4px 2px hsla(0,0%,43%,.2);font-size:14px}.treb-main.treb-main .treb-autocomplete li{color:var(--treb-autocomplete-entry-color,#333)}.treb-main.treb-main .treb-autocomplete li a.selected{background:var(--treb-autocomplete-selected-entry-background,#2e8dd6);color:var(--treb-autocomplete-selected-entry-color,#fff)}.treb-main.treb-main .treb-header-overlay{stroke:none;color:var(--treb-selection-color-unfocused,var(--treb-selection-color,#4caaf1))}.treb-main.treb-main .treb-header-overlay .treb-overlay{fill:#000;stroke:none;opacity:.05}.treb-main.treb-main .treb-header-overlay .treb-highlight{fill:currentColor}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="1"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="1"]{color:var(--text-reference-color-1)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="2"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="2"]{color:var(--text-reference-color-2)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="3"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="3"]{color:var(--text-reference-color-3)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="4"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="4"]{color:var(--text-reference-color-4)}.treb-main.treb-main .treb-editor-container>div [data-highlight-index="5"],.treb-main.treb-main .treb-overlay-editor [data-highlight-index="5"]{color:var(--text-reference-color-5)}.treb-main.treb-main .treb-editor-container>div span.highlight-1,.treb-main.treb-main .treb-overlay-editor span.highlight-1{color:var(--text-reference-color-1)}.treb-main.treb-main .treb-editor-container>div span.highlight-2,.treb-main.treb-main .treb-overlay-editor span.highlight-2{color:var(--text-reference-color-2)}.treb-main.treb-main .treb-editor-container>div span.highlight-3,.treb-main.treb-main .treb-overlay-editor span.highlight-3{color:var(--text-reference-color-3)}.treb-main.treb-main .treb-editor-container>div span.highlight-4,.treb-main.treb-main .treb-overlay-editor span.highlight-4{color:var(--text-reference-color-4)}.treb-main.treb-main .treb-editor-container>div span.highlight-5,.treb-main.treb-main .treb-overlay-editor span.highlight-5{color:var(--text-reference-color-5)}.treb-main.treb-main .frozen-selection .selection,.treb-main.treb-main .treb-grid-selection .selection{stroke-width:var(--treb-selection-stroke-width,2px)}.treb-main.treb-main .frozen-selection .selection .treb-selection-outline,.treb-main.treb-main .treb-grid-selection .selection .treb-selection-outline{stroke:currentColor;fill:none}.treb-main.treb-main .frozen-selection .selection .treb-selection-fill,.treb-main.treb-main .treb-grid-selection .selection .treb-selection-fill{stroke:none;fill:currentColor;opacity:var(--treb-selection-fill-opacity,.1)}.treb-main.treb-main .frozen-selection .alternate-selection,.treb-main.treb-main .treb-grid-selection .alternate-selection{stroke-dasharray:var(--treb-alternate-selection-dasharray,3 2)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(1n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(1n){color:var(--alternate-selection-color-1)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(2n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(2n){color:var(--alternate-selection-color-2)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(3n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(3n){color:var(--alternate-selection-color-3)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(4n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(4n){color:var(--alternate-selection-color-4)}.treb-main.treb-main .frozen-selection .alternate-selection:nth-of-type(5n),.treb-main.treb-main .treb-grid-selection .alternate-selection:nth-of-type(5n){color:var(--alternate-selection-color-5)}.treb-main.treb-main .frozen-selection .primary-selection,.treb-main.treb-main .treb-grid-selection .primary-selection{color:var(--treb-selection-color-unfocused,var(--treb-selection-color,#4caaf1))}.treb-main.treb-main .frozen-selection .primary-selection .treb-selection-nub,.treb-main.treb-main .treb-grid-selection .primary-selection .treb-selection-nub{stroke:#fff;fill:currentColor;stroke-width:1px}.treb-main.treb-main .treb-tooltip{background:var(--treb-resize-tooltip-background,rgba(0,0,0,.8));border-color:var(--treb-resize-tooltip-background,rgba(0,0,0,.8));color:var(--treb-resize-tooltip-color,#fff);font-size:11pt}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab,.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li{background:var(--treb-tab-bar-tab-background,#eeeef2);color:var(--treb-tab-bar-tab-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-spreadsheet-footer .treb-add-tab[selected],.treb-main.treb-main .treb-spreadsheet-footer .treb-spreadsheet-tabs>li[selected]{background:var(--treb-tab-bar-active-tab-background,#fff);border-bottom-color:var(--treb-tab-bar-active-tab-border-color,currentColor);color:var(--treb-tab-bar-active-tab-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-formula-bar .treb-address-label,.treb-main.treb-main .treb-formula-bar .treb-editor-container{background:var(--treb-formula-bar-background,transparent);color:var(--treb-formula-bar-color,var(--treb-ui-color,inherit))}.treb-main.treb-main .treb-formula-bar .treb-address-label[locked],.treb-main.treb-main .treb-formula-bar .treb-editor-container[locked]{background:var(--treb-formula-bar-locked-background,#eef4fc);position:relative}.treb-main.treb-main .treb-formula-bar .treb-address-label[locked]:after,.treb-main.treb-main .treb-formula-bar .treb-editor-container[locked]:after{content:"";height:12px;opacity:.4;position:absolute;right:2px;top:2px;width:12px;--icon:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='currentColor' d='M416 224h-16v-80C400 65 335 0 256 0S112 65 112 144v80H96c-35 0-64 29-64 64v160c0 35 29 64 64 64h320c35 0 64-29 64-64V288c0-35-29-64-64-64m-240-80c0-44 36-80 80-80s80 36 80 80v80H176z'/%3E%3C/svg%3E");background:var(--treb-formula-bar-lock-icon-color,currentColor);mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:12px 12px;-webkit-mask-size:12px 12px}.treb-main.treb-main .treb-annotation-textbox{background:Canvas;height:100%;left:0;overflow:hidden;padding:.5em;position:relative;top:0;width:100%}.treb-main.treb-main .treb-annotation-textbox p{margin-block-end:0;margin-block-start:0}.treb-dark-theme{--treb-autocomplete-background:#333;--treb-autocomplete-border-color:#fff;--treb-autocomplete-entry-color:#fff;--treb-autocomplete-selected-entry-background:darkred;--treb-autocomplete-tooltip-background:darkred;--treb-autocomplete-tooltip-border-color:#fff;--treb-autocomplete-tooltip-color:#fff;--treb-chart-background:#000;--treb-chart-grid-color:#976;--treb-chart-grid-zero-color:#fdd;--treb-chart-text-color:#fff;--treb-dialog-background:#000;--treb-dialog-color:#fff;--treb-dropdown-background:#000;--treb-dropdown-border-color:#fff;--treb-dropdown-caret-active-background:darkred;--treb-dropdown-caret-background:#444;--treb-dropdown-caret-border-color:#fff;--treb-dropdown-caret-color:#fff;--treb-dropdown-color:#fff;--treb-dropdown-selected-background:darkred;--treb-grid-background:#000;--treb-grid-default-color:#fff;--treb-grid-grid-color:#444;--treb-grid-header-background:#444;--treb-grid-header-grid-color:#000;--treb-note-background:#333;--treb-note-border-color:#aaa;--treb-note-color:#fff;--treb-note-marker-color:pink;--treb-resize-tooltip-background:#fff;--treb-resize-tooltip-color:#000;--treb-scale-slider-accent-color:#fff;--treb-scale-slider-background:#333;--treb-scale-slider-border-color:#aaa;--treb-selection-color:#ff0;--treb-selection-fill-opacity:.2;--treb-sidebar-button-background:#000;--treb-sidebar-button-border-color:#888;--treb-stats-value-background:#223;--treb-tab-bar-tab-background:#000;--treb-tab-bar-tab-color:#fff;--treb-theme-color-1:#222;--treb-theme-color-2:#ddd;--treb-toolbar-active-button-background:#555;--treb-toolbar-button-background:#000;--treb-toolbar-hover-button-background:#444;--treb-ui-color:#fff;--treb-table-header-background:#334;--treb-table-odd-background:#122;--treb-table-header-font-weight:700;--treb-table-header-border-top:#889;--treb-table-header-border-bottom:#889;--treb-table-footer-border-bottom:#889;--treb-table-odd-border-top:#889;--treb-table-odd-border-bottom:#889;--treb-table-even-border-top:#889;--treb-table-even-border-bottom:#889;--treb-table-total-border-top:#889;--treb-table-total-border-bottom:#889;--treb-table-total-background:#334;--treb-table-total-font-weight:700;--treb-color-scheme:dark;--treb-resize-handle-color:#add8e6;--treb-resize-frame-color:#add8e6;--treb-formula-bar-locked-background:#234;--treb-grid-background:#1e1e1e;--treb-grid-header-background:#565656;--treb-grid-header-color:#ddd;--treb-tab-bar-active-tab-background:#444;--treb-tab-bar-tab-background:transparent;--treb-tab-bar-tab-border-color:#444;--treb-ui-border-color:#aaa;--treb-toolbar-button-background:#565656;--treb-toolbar-button-background:#212121;--treb-toolbar-border-color:#434343;--treb-toolbar-color:#ddd;--treb-spill-border-color:pink;--treb-spill-border-filter:drop-shadow(3px 3px 2px hsla(0,0%,100%,.95))}@media (prefers-color-scheme:dark){.treb-light-dark-theme{--treb-autocomplete-background:#333;--treb-autocomplete-border-color:#fff;--treb-autocomplete-entry-color:#fff;--treb-autocomplete-selected-entry-background:darkred;--treb-autocomplete-tooltip-background:darkred;--treb-autocomplete-tooltip-border-color:#fff;--treb-autocomplete-tooltip-color:#fff;--treb-chart-background:#000;--treb-chart-grid-color:#976;--treb-chart-grid-zero-color:#fdd;--treb-chart-text-color:#fff;--treb-dialog-background:#000;--treb-dialog-color:#fff;--treb-dropdown-background:#000;--treb-dropdown-border-color:#fff;--treb-dropdown-caret-active-background:darkred;--treb-dropdown-caret-background:#444;--treb-dropdown-caret-border-color:#fff;--treb-dropdown-caret-color:#fff;--treb-dropdown-color:#fff;--treb-dropdown-selected-background:darkred;--treb-grid-background:#000;--treb-grid-default-color:#fff;--treb-grid-grid-color:#444;--treb-grid-header-background:#444;--treb-grid-header-grid-color:#000;--treb-note-background:#333;--treb-note-border-color:#aaa;--treb-note-color:#fff;--treb-note-marker-color:pink;--treb-resize-tooltip-background:#fff;--treb-resize-tooltip-color:#000;--treb-scale-slider-accent-color:#fff;--treb-scale-slider-background:#333;--treb-scale-slider-border-color:#aaa;--treb-selection-color:#ff0;--treb-selection-fill-opacity:.2;--treb-sidebar-button-background:#000;--treb-sidebar-button-border-color:#888;--treb-stats-value-background:#223;--treb-tab-bar-tab-background:#000;--treb-tab-bar-tab-color:#fff;--treb-theme-color-1:#222;--treb-theme-color-2:#ddd;--treb-toolbar-active-button-background:#555;--treb-toolbar-button-background:#000;--treb-toolbar-hover-button-background:#444;--treb-ui-color:#fff;--treb-table-header-background:#334;--treb-table-odd-background:#122;--treb-table-header-font-weight:700;--treb-table-header-border-top:#889;--treb-table-header-border-bottom:#889;--treb-table-footer-border-bottom:#889;--treb-table-odd-border-top:#889;--treb-table-odd-border-bottom:#889;--treb-table-even-border-top:#889;--treb-table-even-border-bottom:#889;--treb-table-total-border-top:#889;--treb-table-total-border-bottom:#889;--treb-table-total-background:#334;--treb-table-total-font-weight:700;--treb-color-scheme:dark;--treb-resize-handle-color:#add8e6;--treb-resize-frame-color:#add8e6;--treb-formula-bar-locked-background:#234;--treb-grid-background:#1e1e1e;--treb-grid-header-background:#565656;--treb-grid-header-color:#ddd;--treb-tab-bar-active-tab-background:#444;--treb-tab-bar-tab-background:transparent;--treb-tab-bar-tab-border-color:#444;--treb-ui-border-color:#aaa;--treb-toolbar-button-background:#565656;--treb-toolbar-button-background:#212121;--treb-toolbar-border-color:#434343;--treb-toolbar-color:#ddd;--treb-spill-border-color:pink;--treb-spill-border-filter:drop-shadow(3px 3px 2px hsla(0,0%,100%,.95))}}.treb-chart,.treb-main.treb-main .treb-chart{background:var(--treb-chart-background,#fff)}.treb-main.treb-main .treb-inherit-font .treb-chart{font-family:inherit}.treb-chart{--segment-2-offset:-20;--segment-3-offset:10;--segment-4-offset:-10;--segment-5-offset:20;--segment-6-offset:-25}.treb-chart .series-1{color:var(--treb-applied-theme-color-1)}.treb-chart .series-2{color:var(--treb-applied-theme-color-2)}.treb-chart .series-3{color:var(--treb-applied-theme-color-3)}.treb-chart .series-4{color:var(--treb-applied-theme-color-4)}.treb-chart .series-5{color:var(--treb-applied-theme-color-5)}.treb-chart .series-6{color:var(--treb-applied-theme-color-6)}.treb-chart .series-7{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-8{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-9{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-10{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-11{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-12{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-2-offset)) c h)}.treb-chart .series-13{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-14{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-15{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-16{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-17{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-18{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-3-offset)) c h)}.treb-chart .series-19{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-20{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-21{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-22{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-23{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-24{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-4-offset)) c h)}.treb-chart .series-25{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-26{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-27{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-28{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-29{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-30{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-5-offset)) c h)}.treb-chart .series-31{color:lch(from var(--treb-applied-theme-color-1) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-32{color:lch(from var(--treb-applied-theme-color-2) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-33{color:lch(from var(--treb-applied-theme-color-3) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-34{color:lch(from var(--treb-applied-theme-color-4) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-35{color:lch(from var(--treb-applied-theme-color-5) calc(l + var(--segment-6-offset)) c h)}.treb-chart .series-36{color:lch(from var(--treb-applied-theme-color-6) calc(l + var(--segment-6-offset)) c h)}.treb-chart .chart-title{font-size:1.4em}.treb-chart .axis-group{font-size:.9em}.treb-chart .axis-group .series-name{font-size:1.3em}.treb-chart text{fill:var(--treb-chart-text-color,#000);stroke:none}.treb-chart .legend{font-size:1.05em}.treb-chart .legend rect{fill:currentColor}.treb-chart .legend circle{fill:currentColor;fill-opacity:.5;stroke:currentColor;stroke-width:2px;r:.25em}.treb-chart .chart-grid,.treb-chart .chart-ticks{stroke:var(--treb-chart-grid-color,#ddd)}.treb-chart .chart-grid.zero,.treb-chart .chart-ticks.zero{stroke:var(--treb-chart-grid-zero-color,var(--treb-chart-grid-color,#999))}.treb-chart .label-target{stroke:none;fill:transparent}.treb-chart path.label-target{transition:fill .2s}.treb-chart path.label-target:hover{fill:rgba(0,0,0,.15)}.treb-chart .data-label{opacity:0;pointer-events:none;transition:opacity .2s ease-in-out}.treb-chart .data-label text{fill:#fff}.treb-chart .data-label path{fill:#000}.treb-chart .data-label .marker-highlight{fill:currentColor;stroke:none}.treb-chart .label-target:hover+.data-label{opacity:1}.treb-chart .chart-line{stroke:currentColor;fill:none;stroke-width:2}.treb-chart .chart-area .line{stroke:currentColor;stroke-width:2px;fill:none}.treb-chart .chart-area .fill{fill:currentColor;opacity:.5}.treb-chart .box-plot .iqr{fill:none;stroke:CanvasText;stroke-width:1px}.treb-chart .box-plot .median{stroke-width:3px;stroke:CanvasText;fill:none}.treb-chart .box-plot .outlier{r:3}.treb-chart .box-plot .outlier,.treb-chart .box-plot .whisker,.treb-chart .box-plot .whisker-extent{stroke-width:1px;stroke:CanvasText;fill:none}.treb-chart .box-plot .whisker-extent{stroke-dasharray:3 3}.treb-chart .bubble-chart{stroke-width:3;fill:color-mix(in srgb,currentColor 75%,transparent);stroke:currentColor}.treb-chart .bubble-label .label-background{stroke:none;fill:none}.treb-chart .bubble-label .label-text{transform:translate(var(--translate-offset),var(--translate-offset))}.treb-chart .scatter-plot{stroke-width:3;fill:none;stroke:currentColor}.treb-chart .scatter-plot .fill{fill:currentColor;opacity:.5;stroke:none}.treb-chart .scatter-plot .marker{stroke-width:2.5px;fill:#fff;transition:stroke-width .15s ease-in}.treb-chart .scatter-plot .marker:hover{stroke-width:5px}.treb-chart .donut path{fill:currentColor}.treb-chart .donut path.callout{fill:none;stroke:#999;stroke-dasharray:2 2}.treb-chart .donut text.callout-label{font-size:1em}.treb-chart .chart-column{fill:currentColor;stroke:none}.treb-chart .mc-correlation{stroke:currentColor;stroke-width:1}.treb-main.treb-main{--treb-icon-svg:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='153.073' height='133.742' viewBox='0.673 4.629 153.073 133.742'%3E%3ClinearGradient id='a' x1='.673' x2='153.746' y1='71.5' y2='71.5' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' style='stop-color:%235cb5ff'/%3E%3Cstop offset='1' style='stop-color:%230059b9'/%3E%3C/linearGradient%3E%3Cpath fill='url(%23a)' d='M91.656 28.313c-4.989 0-17.266 6.249-21.305 8.504-2.344-2.473-2.603-6.162-3.036-10.933-2.344 2.429-.824 9.806 0 12.496-10.238 7.635-18.83 15.531-27.597 24.471-2.992-4.729-5.031-8.593-5.726-17.183-3.038 6.509.867 15.057 3.121 19.784-9.674 12.193-19.263 25.297-27.03 37.834-35.488-74.973 72.853-119.534 143.663-88.855-43.867 29.199-55.192 121.353-132.248 96.843-5.423 7.809-9.069 18.006-13.538 27.072-3.73.263-6.334-1.646-7.288-3.12 7.506-18.181 17.183-34.192 27.075-49.984 10.718.306 21.346.478 30.198-1.04-7.681-2.038-16.877-.78-26.032-3.123C37.51 70.361 45.667 62.203 53.78 54.004c8.808.782 17.746 3.21 27.074 1.041-8.111-1.431-15.966-1.952-22.909-4.165 7.594-8.378 22.777-17.491 33.711-22.567'/%3E%3C/svg%3E")}.treb-main.treb-main .treb-icon-64{background:no-repeat 50%/100% var(--treb-icon-svg);height:64px;width:64px}.treb-main.treb-main .treb-dialog-mask{align-items:center;display:flex;height:100%;justify-content:center;left:0;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .2s;width:100%;z-index:1000}.treb-main.treb-main .treb-embed-dialog{align-items:center;background:var(--treb-dialog-background,#fff);border:1px solid var(--treb-dialog-border-color,var(--treb-ui-border-color,#999));border-radius:3px;border-top:3px solid #999;box-shadow:0 4px 6px -4px rgba(0,0,0,.3);color:var(--treb-dialog-color,#000);display:flex;flex-direction:row;font-size:var(--treb-dialog-font-size,16px);line-height:1.6em;padding:1rem;position:relative;text-align:left}.treb-main.treb-main .treb-embed-dialog>*{display:none}.treb-main.treb-main .treb-embed-dialog>div{position:relative}.treb-main.treb-main .treb-embed-dialog>:nth-child(2){display:block;flex-grow:1;padding:2px 20px 2px 12px}.treb-main.treb-main .treb-embed-dialog>.treb-close-box{background:transparent;border:0;padding:4px;position:absolute;right:0;top:0}.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg{fill:#73828c;cursor:default;height:20px;width:20px}.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg:active,.treb-main.treb-main .treb-embed-dialog>.treb-close-box>svg:hover{fill:#049cfb}.treb-main.treb-main .treb-embed-dialog small{display:block;font-size:.9em}.treb-main.treb-main .treb-embed-dialog a{color:inherit;text-decoration:none}.treb-main.treb-main .treb-embed-dialog a:active,.treb-main.treb-main .treb-embed-dialog a:hover{color:#049cfb}.treb-main.treb-main .treb-embed-dialog.dialog-type-success{border-top-color:#44d926;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-about{border-top-color:#009dff;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-error{border-top-color:#f92f06;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog.dialog-type-info{border-top-color:#009dff;border-top-width:3px}.treb-main.treb-main .treb-embed-dialog .treb-embed-dialog-message,.treb-main.treb-main .treb-embed-dialog .treb-embed-dialog-title{white-space:pre}.treb-main.treb-main .treb-embed-dialog .treb-embed-progress-container{border:1px solid #ddd;height:6px;margin:1rem auto .5rem;position:relative;width:100%}.treb-main.treb-main .treb-embed-dialog .treb-embed-progress-bar{background:#52880b;height:100%;left:0;position:relative;top:0}.treb-main.treb-main .treb-spinner{align-items:center;background:transparent;display:flex;height:100%;justify-content:center;left:0;opacity:0;position:absolute;top:0;transition:visibility .25s,opacity .25s ease;visibility:collapse;width:100%;z-index:1000}.treb-main.treb-main .treb-spinner.visible{opacity:1;transition:visibility 0s,opacity 1s ease;visibility:visible}.treb-main.treb-main .treb-spinner>div{display:inline-block;height:80px;position:relative;width:80px}.treb-main.treb-main .treb-spinner>div div{animation:treb-spinner 1.2s cubic-bezier(.5,0,.5,1) infinite;border:8px solid #fff;border-color:var(--treb-spinner-color,currentColor) transparent transparent transparent;border-radius:50%;box-sizing:border-box;display:block;height:64px;margin:8px;position:absolute;width:64px}.treb-main.treb-main .treb-spinner>div div:first-child{animation-delay:-.45s}.treb-main.treb-main .treb-spinner>div div:nth-child(2){animation-delay:-.3s}.treb-main.treb-main .treb-spinner>div div:nth-child(3){animation-delay:-.15s}@keyframes treb-spinner{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.treb-main.treb-main{--icon-x:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg>');--icon-popout:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28"><path fill="currentColor" d="M22 14.5v5c0 2.484-2.016 4.5-4.5 4.5h-13A4.5 4.5 0 0 1 0 19.5v-13C0 4.016 2.016 2 4.5 2h11c.281 0 .5.219.5.5v1c0 .281-.219.5-.5.5h-11A2.507 2.507 0 0 0 2 6.5v13C2 20.875 3.125 22 4.5 22h13c1.375 0 2.5-1.125 2.5-2.5v-5c0-.281.219-.5.5-.5h1c.281 0 .5.219.5.5M28 1v8c0 .547-.453 1-1 1a1 1 0 0 1-.703-.297l-2.75-2.75L13.36 17.14c-.094.094-.234.156-.359.156s-.266-.063-.359-.156l-1.781-1.781c-.094-.094-.156-.234-.156-.359s.063-.266.156-.359L21.048 4.454l-2.75-2.75a1 1 0 0 1-.297-.703c0-.547.453-1 1-1h8c.547 0 1 .453 1 1z"/></svg>');--icon-toolbar:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M5.5 22v2H0v-2zm5.5-2c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1H7c-.547 0-1-.453-1-1v-4c0-.547.453-1 1-1zm2.5-6v2H0v-2zm-10-8v2H0V6zM24 22v2H12.5v-2zM9 4c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1H5c-.547 0-1-.453-1-1V5c0-.547.453-1 1-1zm10 8c.547 0 1 .453 1 1v4c0 .547-.453 1-1 1h-4c-.547 0-1-.453-1-1v-4c0-.547.453-1 1-1zm5 2v2h-3.5v-2zm0-8v2H10.5V6z"/></svg>');--icon-export:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 28"><path fill="currentColor" d="M20 21c0-.547-.453-1-1-1s-1 .453-1 1 .453 1 1 1 1-.453 1-1m4 0c0-.547-.453-1-1-1s-1 .453-1 1 .453 1 1 1 1-.453 1-1m2-3.5v5a1.5 1.5 0 0 1-1.5 1.5h-23A1.5 1.5 0 0 1 0 22.5v-5A1.5 1.5 0 0 1 1.5 16h7.266l2.109 2.125c.578.562 1.328.875 2.125.875s1.547-.313 2.125-.875L17.25 16h7.25a1.5 1.5 0 0 1 1.5 1.5m-5.078-8.891a.98.98 0 0 1-.219 1.094l-7 7c-.187.203-.453.297-.703.297s-.516-.094-.703-.297l-7-7a.98.98 0 0 1-.219-1.094C5.234 8.25 5.594 8 6 8h4V1c0-.547.453-1 1-1h4c.547 0 1 .453 1 1v7h4c.406 0 .766.25.922.609"/></svg>');--icon-reset:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M23.609 16.5c0 .031 0 .078-.016.109C22.265 22.14 17.702 26 11.937 26c-3.047 0-6-1.203-8.219-3.313l-2.016 2.016A1 1 0 0 1 .999 25c-.547 0-1-.453-1-1v-7c0-.547.453-1 1-1h7c.547 0 1 .453 1 1a1 1 0 0 1-.297.703l-2.141 2.141A7.99 7.99 0 0 0 11.998 22a7.98 7.98 0 0 0 6.813-3.813c.375-.609.562-1.203.828-1.828.078-.219.234-.359.469-.359h3c.281 0 .5.234.5.5zM24 4v7c0 .547-.453 1-1 1h-7c-.547 0-1-.453-1-1a1 1 0 0 1 .297-.703l2.156-2.156A8.04 8.04 0 0 0 12 6a7.98 7.98 0 0 0-6.813 3.813c-.375.609-.562 1.203-.828 1.828-.078.219-.234.359-.469.359H.781a.503.503 0 0 1-.5-.5v-.109C1.625 5.844 6.234 2 12 2c3.063 0 6.047 1.219 8.266 3.313l2.031-2.016A1 1 0 0 1 23 3c.547 0 1 .453 1 1"/></svg>');--icon-about:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M14 21.5v-3c0-.281-.219-.5-.5-.5h-3c-.281 0-.5.219-.5.5v3c0 .281.219.5.5.5h3c.281 0 .5-.219.5-.5M18 11c0-2.859-3-5-5.688-5-2.547 0-4.453 1.094-5.797 3.328a.49.49 0 0 0 .125.656l2.063 1.563a.48.48 0 0 0 .297.094.5.5 0 0 0 .391-.187c.734-.938 1.047-1.219 1.344-1.437.266-.187.781-.375 1.344-.375 1 0 1.922.641 1.922 1.328 0 .812-.422 1.219-1.375 1.656-1.109.5-2.625 1.797-2.625 3.313v.562c0 .281.219.5.5.5h3c.281 0 .5-.219.5-.5 0-.359.453-1.125 1.188-1.547 1.188-.672 2.812-1.578 2.812-3.953zm6 3c0 6.625-5.375 12-12 12S0 20.625 0 14 5.375 2 12 2s12 5.375 12 12"/></svg>');--icon-chevron-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 28"><path fill="currentColor" d="M18.297 4.703 10 13l8.297 8.297a.99.99 0 0 1 0 1.406l-2.594 2.594a.99.99 0 0 1-1.406 0L2.703 13.703a.99.99 0 0 1 0-1.406L14.297.703a.99.99 0 0 1 1.406 0l2.594 2.594a.99.99 0 0 1 0 1.406"/></svg>');--icon-chevron-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 28"><path fill="currentColor" d="M17.297 13.703 5.703 25.297a.99.99 0 0 1-1.406 0l-2.594-2.594a.99.99 0 0 1 0-1.406L10 13 1.703 4.703a.99.99 0 0 1 0-1.406L4.297.703a.99.99 0 0 1 1.406 0l11.594 11.594a.99.99 0 0 1 0 1.406"/></svg>');--icon-revert:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28"><path fill="currentColor" d="M24 14c0 6.609-5.391 12-12 12a11.97 11.97 0 0 1-9.234-4.328.52.52 0 0 1 .031-.672l2.141-2.156a.6.6 0 0 1 .391-.141.5.5 0 0 1 .359.187A7.91 7.91 0 0 0 12 21.999c4.406 0 8-3.594 8-8s-3.594-8-8-8A7.95 7.95 0 0 0 6.563 8.14l2.141 2.156a.96.96 0 0 1 .219 1.078 1 1 0 0 1-.922.625h-7c-.547 0-1-.453-1-1v-7c0-.406.25-.766.625-.922a.96.96 0 0 1 1.078.219l2.031 2.016c2.203-2.078 5.187-3.313 8.266-3.313 6.609 0 12 5.391 12 12zM14 9.5v7c0 .281-.219.5-.5.5h-5a.494.494 0 0 1-.5-.5v-1c0-.281.219-.5.5-.5H12V9.5c0-.281.219-.5.5-.5h1c.281 0 .5.219.5.5"/></svg>');--icon-text-indent:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-text-indent-left" viewBox="0 0 16 16"><path d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m.646 2.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L4.293 8 2.646 6.354a.5.5 0 0 1 0-.708M7 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m-5 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-outdent:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-text-indent-right" viewBox="0 0 16 16"><path d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m10.646 2.146a.5.5 0 0 1 .708.708L11.707 8l1.647 1.646a.5.5 0 0 1-.708.708l-2-2a.5.5 0 0 1 0-.708zM2 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-center:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m4-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-4-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/></svg>');--icon-text-align-top:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 15a.5.5 0 0 0 .5-.5V5.707l3.146 3.146a.5.5 0 0 0 .707-.707l-4-4a.5.5 0 0 0-.706-.001l-.001.001-4 4a.5.5 0 0 0 .708.707L7.5 5.707V14.5a.5.5 0 0 0 .5.5'/%3E%3Cpath fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' d='M3 1.5h10'/%3E%3C/svg%3E");--icon-text-align-middle:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8m7-8a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0m-.5 11.707-1.146 1.147a.5.5 0 0 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 11.707V15.5a.5.5 0 0 1-1 0z"/></svg>');--icon-text-align-bottom:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' xml:space='preserve' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath d='M8 1a.5.5 0 0 0-.5.5v8.793L4.354 7.146a.5.5 0 0 0-.707.707l4 4a.5.5 0 0 0 .707.001l.001-.001 4-4a.5.5 0 0 0-.708-.707L8.5 10.293V1.5A.5.5 0 0 0 8 1'/%3E%3Cpath fill='none' stroke='%23000' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' d='M13 14.5H3'/%3E%3C/svg%3E");--icon-file-menu:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/></svg>');--icon-wrap-text:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 5h8a.5.5 0 0 0 0-1H4a.5.5 0 0 0 0 1M10 8H4a.5.5 0 0 0 0 1h6a1.5 1.5 0 0 1 0 3v-1.203l-2.953 1.707L10 14.203V13a2.5 2.5 0 1 0 0-5M3.75 12.5a.5.5 0 0 0 .5.5H6v-1H4.25a.5.5 0 0 0-.5.5"/></svg>');--icon-unmerge-cells:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5"/></svg>');--icon-merge-cells:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5m5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5M0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5m10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0z"/></svg>');--icon-lock:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1"/></svg>');--icon-comment:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>');--icon-fill-color:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.192 2.78c-.458-.677-.927-1.248-1.35-1.643a3 3 0 0 0-.71-.515c-.217-.104-.56-.205-.882-.02-.367.213-.427.63-.43.896-.003.304.064.664.173 1.044.196.687.556 1.528 1.035 2.402L.752 8.22c-.277.277-.269.656-.218.918.055.283.187.593.36.903.348.627.92 1.361 1.626 2.068.707.707 1.441 1.278 2.068 1.626.31.173.62.305.903.36.262.05.64.059.918-.218l5.615-5.615c.118.257.092.512.05.939-.03.292-.068.665-.073 1.176v.123h.003a1 1 0 0 0 1.993 0H14v-.057a1 1 0 0 0-.004-.117c-.055-1.25-.7-2.738-1.86-3.494a4 4 0 0 0-.211-.434c-.349-.626-.92-1.36-1.627-2.067S8.857 3.052 8.23 2.704c-.31-.172-.62-.304-.903-.36-.262-.05-.64-.058-.918.219l-.217.216zM4.16 1.867c.381.356.844.922 1.311 1.632l-.704.705c-.382-.727-.66-1.402-.813-1.938a3.3 3.3 0 0 1-.131-.673q.137.09.337.274m.394 3.965c.54.852 1.107 1.567 1.607 2.033a.5.5 0 1 0 .682-.732c-.453-.422-1.017-1.136-1.564-2.027l1.088-1.088q.081.181.183.365c.349.627.92 1.361 1.627 2.068.706.707 1.44 1.278 2.068 1.626q.183.103.365.183l-4.861 4.862a1 1 0 0 1-.068-.01c-.137-.027-.342-.104-.608-.252-.524-.292-1.186-.8-1.846-1.46s-1.168-1.32-1.46-1.846c-.147-.265-.225-.47-.251-.607a1 1 0 0 1-.01-.068zm2.87-1.935a2.4 2.4 0 0 1-.241-.561c.135.033.324.11.562.241.524.292 1.186.8 1.846 1.46.45.45.83.901 1.118 1.31a3.5 3.5 0 0 0-1.066.091 11 11 0 0 1-.76-.694c-.66-.66-1.167-1.322-1.458-1.847z"/></svg>');--icon-text-color:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="16" height="16" viewBox="0 0 16 16"><path d="m12.259 14.001-1.389-3.727H5.465l-1.354 3.727h-1.3L7.609 1.397h1.178l4.772 12.604zM8.418 3.604a6 6 0 0 1-.127-.387 4 4 0 0 1-.11-.501h-.035a5.5 5.5 0 0 1-.247.888L5.86 9.211h4.614z"/></svg>');--icon-border-bottom:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 15h16v1H0z"/></svg>');--icon-border-top:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0v1h16V0zm1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 16h.969v-.5H1v-.469H.969V15H.5v.031H0zm1.906 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875-.5v.5H16v-.969h-.5V15h-.469v.031H15v.469z"/></svg>');--icon-border-left:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0v16h1V0zm1.906 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM7.5 1.906v.938h1v-.938zm7.5 0v.938h1v-.938zM7.5 3.781v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM7.5 5.656v.938h1v-.938zm7.5 0v.938h1v-.938zM1.906 8.5h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM7.5 9.406v.938h1v-.938zm8.5.938v-.938h-1v.938zm-8.5.937v.938h1v-.938zm8.5.938v-.938h-1v.938zm-8.5.937v.938h1v-.938zm8.5.938v-.938h-1v.938zM1.906 16h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875-.5v.5H16v-.969h-.5V15h-.469v.031H15v.469z"/></svg>');--icon-border-right:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zM16 0h-1v16h1zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zM1 4.719V3.78H0v.938h1zm6.5-.938v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zM0 11.281v.938h1v-.938zm7.5 0v.938h1v-.938zM0 13.156v.938h1v-.938zm7.5 0v.938h1v-.938zM0 16h.969v-.5H1v-.469H.969V15H.5v.031H0zm1.906 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm1.875-.5v.5h.938v-.5H8.5v-.469h-.031V15H7.53v.031H7.5v.469zm1.875.5h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938z"/></svg>');--icon-border-double-bottom:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M.969 0H0v.969h.5V1h.469V.969H1V.5H.969zm.937 1h.938V0h-.938zm1.875 0h.938V0H3.78v1zm1.875 0h.938V0h-.938zM7.531.969V1h.938V.969H8.5V.5h-.031V0H7.53v.5H7.5v.469zM9.406 1h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.938V0h-.938zm1.875 0h.469V.969h.5V0h-.969v.5H15v.469h.031zM1 2.844v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM1 4.719V3.78H0v.938zm6.5-.938v.938h1V3.78h-1zm7.5 0v.938h1V3.78h-1zM1 6.594v-.938H0v.938zm6.5-.938v.938h1v-.938zm7.5 0v.938h1v-.938zM.5 8.5h.469v-.031H1V7.53H.969V7.5H.5v.031H0v.938h.5zm1.406 0h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.469v-.031h.5V7.53h-.5V7.5h-.469v.031H15v.938h.031zM0 9.406v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zm-16 .937v.938h1v-.938zm7.5 0v.938h1v-.938zm8.5.938v-.938h-1v.938zM0 15h16v1H0zm0-2h16v1H0z"/></svg>');--icon-border-all:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0h16v16H0zm1 1v6.5h6.5V1zm7.5 0v6.5H15V1zM15 8.5H8.5V15H15zM7.5 15V8.5H1V15z"/></svg>');--icon-border-outer:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.5 1.906v.938h1v-.938zm0 1.875v.938h1V3.78h-1zm0 1.875v.938h1v-.938zM1.906 8.5h.938v-1h-.938zm1.875 0h.938v-1H3.78v1zm1.875 0h.938v-1h-.938zm2.813 0v-.031H8.5V7.53h-.031V7.5H7.53v.031H7.5v.938h.031V8.5zm.937 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zm1.875 0h.938v-1h-.938zM7.5 9.406v.938h1v-.938zm0 1.875v.938h1v-.938zm0 1.875v.938h1v-.938z"/><path d="M0 0v16h16V0zm1 1h14v14H1z"/></svg>');--icon-border-none:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 0h.969v.5H1v.469H.969V1H.5V.969H0zm2.844 1h-.938V0h.938zm1.875 0H3.78V0h.938v1zm1.875 0h-.938V0h.938zm.937 0V.969H7.5V.5h.031V0h.938v.5H8.5v.469h-.031V1zm2.813 0h-.938V0h.938zm1.875 0h-.938V0h.938zm1.875 0h-.938V0h.938zM15.5 1h-.469V.969H15V.5h.031V0H16v.969h-.5zM1 1.906v.938H0v-.938zm6.5.938v-.938h1v.938zm7.5 0v-.938h1v.938zM1 3.78v.938H0V3.78zm6.5.938V3.78h1v.938zm7.5 0V3.78h1v.938zM1 5.656v.938H0v-.938zm6.5.938v-.938h1v.938zm7.5 0v-.938h1v.938zM.969 8.5H.5v-.031H0V7.53h.5V7.5h.469v.031H1v.938H.969zm1.875 0h-.938v-1h.938zm1.875 0H3.78v-1h.938v1zm1.875 0h-.938v-1h.938zm1.875-.031V8.5H7.53v-.031H7.5V7.53h.031V7.5h.938v.031H8.5v.938zm1.875.031h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.406 0h-.469v-.031H15V7.53h.031V7.5h.469v.031h.5v.938h-.5zM0 10.344v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM0 12.22v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM0 14.094v-.938h1v.938zm7.5 0v-.938h1v.938zm8.5-.938v.938h-1v-.938zM.969 16H0v-.969h.5V15h.469v.031H1v.469H.969zm1.875 0h-.938v-1h.938zm1.875 0H3.78v-1h.938v1zm1.875 0h-.938v-1h.938zm.937 0v-.5H7.5v-.469h.031V15h.938v.031H8.5v.469h-.031v.5zm2.813 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm1.875 0h-.938v-1h.938zm.937 0v-.5H15v-.469h.031V15h.469v.031h.5V16z"/></svg>');--icon-palette:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h5a.5.5 0 0 1 .5.5v5.277l4.147-4.131a.5.5 0 0 1 .707 0l3.535 3.536a.5.5 0 0 1 0 .708L10.261 10H15.5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5.5H3a3 3 0 0 1-2.121-.879A3 3 0 0 1 0 13.044m6-.21 7.328-7.3-2.829-2.828L6 7.188zM4.5 13a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0M15 15v-4H9.258l-4.015 4zM0 .5v12.495zM0 12.995V13z"/></svg>');--icon-layout:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="m3 0 17 17.156v-.114z"/><path d="M3 0H0v16h1V1h1.585L19 17.455V19H4v1h16v-2.844z"/><path d="M6.886 3.922 5.343 5.465a.5.5 0 0 0 .708.707l1.539-1.54zM9.702 6.763l-1.53 1.53A.5.5 0 0 0 8.879 9l1.526-1.526zM12.517 9.604 11 11.121a.5.5 0 0 0 .707.707l1.514-1.514zM15.332 12.445l-1.504 1.504a.5.5 0 0 0 .707.707l1.501-1.5zM1 16H0a4 4 0 0 0 4 4v-1c-1.654 0-3-1.346-3-3M5 9v6h6zm1 2.414L8.586 14H6z"/></svg>');--icon-freeze:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a.5.5 0 0 1-.5-.5v-1.293l-.646.647a.5.5 0 0 1-.707-.708L7.5 12.793V8.866l-3.4 1.963-.496 1.85a.5.5 0 1 1-.966-.26l.237-.882-1.12.646a.5.5 0 0 1-.5-.866l1.12-.646-.884-.237a.5.5 0 1 1 .26-.966l1.848.495L7 8 3.6 6.037l-1.85.495a.5.5 0 0 1-.258-.966l.883-.237-1.12-.646a.5.5 0 1 1 .5-.866l1.12.646-.237-.883a.5.5 0 1 1 .966-.258l.495 1.849L7.5 7.134V3.207L6.147 1.854a.5.5 0 1 1 .707-.708l.646.647V.5a.5.5 0 1 1 1 0v1.293l.647-.647a.5.5 0 1 1 .707.708L8.5 3.207v3.927l3.4-1.963.496-1.85a.5.5 0 1 1 .966.26l-.236.882 1.12-.646a.5.5 0 0 1 .5.866l-1.12.646.883.237a.5.5 0 1 1-.26.966l-1.848-.495L9 8l3.4 1.963 1.849-.495a.5.5 0 0 1 .259.966l-.883.237 1.12.646a.5.5 0 0 1-.5.866l-1.12-.646.236.883a.5.5 0 1 1-.966.258l-.495-1.849-3.4-1.963v3.927l1.353 1.353a.5.5 0 0 1-.707.708l-.647-.647V15.5a.5.5 0 0 1-.5.5z"/></svg>');--icon-column-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M4.5 17.5a.5.5 0 0 1-1 0v-5a.5.5 0 0 1 1 0zM12.5 17.5a.5.5 0 0 1-1 0v-9a.5.5 0 0 1 1 0zM16.5 17.5a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 1 0zM8.5 17.5a.5.5 0 0 1-1 0v-14a.5.5 0 0 1 1 0z"/></svg>');--icon-donut-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M12 1.23v1.548c2.526.701 4.5 2.699 5.203 5.222h1.565A9.01 9.01 0 0 0 12 1.23M2.5 10c0-3.51 2.426-6.456 5.688-7.27V1.183A9 9 0 0 0 1 10c0 1.761.513 3.397 1.387 4.784l1.093-1.093A7.43 7.43 0 0 1 2.5 10M17.221 12c-.878 3.166-3.778 5.5-7.221 5.5a7.45 7.45 0 0 1-3.692-.979l-1.093 1.093A8.96 8.96 0 0 0 10 19c4.282 0 7.859-2.993 8.77-7z"/></svg>');--icon-bar-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M2.5 4.5a.5.5 0 0 1 0-1h5a.5.5 0 0 1 0 1zM2.5 12.5a.5.5 0 0 1 0-1h9a.5.5 0 0 1 0 1zM2.5 16.5a.5.5 0 0 1 0-1h13a.5.5 0 0 1 0 1zM2.5 8.5a.5.5 0 0 1 0-1h14a.5.5 0 0 1 0 1z"/></svg>');--icon-line-chart:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="m1 8 3-3 7 5 8-8v2l-8 8-7-5-3 3z"/></svg>');--icon-image:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/></svg>');--icon-recalculate:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20" height="20" viewBox="0 0 20 20"><path d="M9.478 4.022c2.402-.209 4.583 1.047 5.711 3.014l1.083-.095c-1.233-2.528-3.912-4.175-6.881-3.916-2.97.26-5.321 2.347-6.098 5.051l1.083-.095c.768-2.132 2.698-3.748 5.102-3.959M10.523 15.977c-2.403.211-4.585-1.047-5.712-3.013l-1.08.095c1.234 2.527 3.91 4.175 6.879 3.914 2.971-.259 5.32-2.347 6.095-5.05l-1.08.095c-.769 2.132-2.699 3.749-5.102 3.959"/><path d="m2.272 15.616 5.197-3-4.098-1.097zM17.728 4.384l-5.197 3 4.098 1.098z"/></svg>');--icon-check:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>');--icon-table:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z"/></svg>')}.treb-main.treb-main .treb-layout-header{overflow:hidden;overflow-x:scroll;position:relative;-ms-overflow-style:none;scrollbar-width:none}.treb-main.treb-main .treb-layout-header::-webkit-scrollbar{display:none}.treb-main.treb-main .treb-toolbar{color:var(--treb-toolbar-color,var(--treb-ui-color,#333));display:flex;flex-direction:row;font-size:var(--treb-toolbar-font-size,inherit);gap:.5rem}.treb-main.treb-main .treb-toolbar>div{display:flex;flex-direction:row}.treb-main.treb-main .treb-toolbar>div>input,.treb-main.treb-main .treb-toolbar>input{background-color:var(--treb-toolbar-button-background,transparent);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));height:32px;overflow:hidden;padding-left:.5em;padding-right:.5em;text-overflow:ellipsis}.treb-main.treb-main .treb-toolbar>.treb-menu>button{border-radius:3px}.treb-main.treb-main .treb-toolbar>.group>.treb-menu+button,.treb-main.treb-main .treb-toolbar>.group>button+.treb-menu>button,.treb-main.treb-main .treb-toolbar>.group>button+button,.treb-main.treb-main .treb-toolbar>.group>input+.treb-menu>button,.treb-main.treb-main .treb-toolbar>.group>input+button,.treb-main.treb-main .treb-toolbar>[composite]>.treb-menu+button,.treb-main.treb-main .treb-toolbar>[composite]>button+.treb-menu>button,.treb-main.treb-main .treb-toolbar>[composite]>button+button,.treb-main.treb-main .treb-toolbar>[composite]>input+.treb-menu>button,.treb-main.treb-main .treb-toolbar>[composite]>input+button{border-left-width:0}.treb-main.treb-main .treb-toolbar>.group>button:first-child,.treb-main.treb-main .treb-toolbar>.group>input:first-child,.treb-main.treb-main .treb-toolbar>[composite]>button:first-child,.treb-main.treb-main .treb-toolbar>[composite]>input:first-child{border-bottom-left-radius:3px;border-top-left-radius:3px}.treb-main.treb-main .treb-toolbar>.group>.treb-menu:last-child>button,.treb-main.treb-main .treb-toolbar>.group>button:last-child,.treb-main.treb-main .treb-toolbar>[composite]>.treb-menu:last-child>button,.treb-main.treb-main .treb-toolbar>[composite]>button:last-child{border-bottom-right-radius:3px;border-top-right-radius:3px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button,.treb-main.treb-main .treb-toolbar .treb-menu>button,.treb-main.treb-main .treb-toolbar button[data-icon],.treb-main.treb-main .treb-toolbar>button,.treb-main.treb-main .treb-toolbar>div>button{align-items:center;background-color:var(--treb-toolbar-button-background,transparent);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));display:flex;flex-direction:column;height:32px;justify-content:center;position:relative;width:32px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[dropdown],.treb-main.treb-main .treb-toolbar .treb-menu>button[dropdown],.treb-main.treb-main .treb-toolbar button[data-icon][dropdown],.treb-main.treb-main .treb-toolbar>button[dropdown],.treb-main.treb-main .treb-toolbar>div>button[dropdown]{width:16px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[dropdown]:after,.treb-main.treb-main .treb-toolbar .treb-menu>button[dropdown]:after,.treb-main.treb-main .treb-toolbar button[data-icon][dropdown]:after,.treb-main.treb-main .treb-toolbar>button[dropdown]:after,.treb-main.treb-main .treb-toolbar>div>button[dropdown]:after{border:5px solid transparent;border-top-color:currentcolor;box-sizing:content-box;content:"";height:0;left:50%;position:absolute;top:18px;transform:translate(-50%,-50%);width:0}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button:hover,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[active],.treb-main.treb-main .treb-toolbar .treb-menu>button:hover,.treb-main.treb-main .treb-toolbar .treb-menu>button[active],.treb-main.treb-main .treb-toolbar button[data-icon]:hover,.treb-main.treb-main .treb-toolbar button[data-icon][active],.treb-main.treb-main .treb-toolbar>button:hover,.treb-main.treb-main .treb-toolbar>button[active],.treb-main.treb-main .treb-toolbar>div>button:hover,.treb-main.treb-main .treb-toolbar>div>button[active]{background-color:var(--treb-toolbar-hover-button-background,#f3f4f6)}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar button[data-icon][data-color-bar]:after,.treb-main.treb-main .treb-toolbar>button[data-color-bar]:after,.treb-main.treb-main .treb-toolbar>div>button[data-color-bar]:after{background:var(--treb-color-bar-color,var(--treb-default-color,unset));border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));box-sizing:border-box;content:"";display:block;height:6px;position:relative;width:20px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-command]:before,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-icon]:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-command]:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-icon]:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-command]:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-icon]:before,.treb-main.treb-main .treb-toolbar>button[data-command]:before,.treb-main.treb-main .treb-toolbar>button[data-icon]:before,.treb-main.treb-main .treb-toolbar>div>button[data-command]:before,.treb-main.treb-main .treb-toolbar>div>button[data-icon]:before{background:currentColor;content:"";display:block;height:20px;mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:var(--icon-size,16px 16px);-webkit-mask-size:var(--icon-size,16px 16px);position:relative;width:20px}.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-icon-buttons>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar .treb-menu>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar button[data-icon][data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>button[data-icon].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>div>button[data-command].treb-font-stack:before,.treb-main.treb-main .treb-toolbar>div>button[data-icon].treb-font-stack:before{display:none}.treb-main.treb-main .treb-toolbar .treb-split{display:flex;flex-direction:column;gap:0}.treb-main.treb-main .treb-toolbar .treb-split button[data-command]{font-size:10px}.treb-main.treb-main .treb-toolbar .treb-split button[data-command]:before{display:none}.treb-main.treb-main .treb-toolbar .treb-split>button{align-items:center;display:flex;height:16px;justify-content:center}.treb-main.treb-main .treb-toolbar .treb-split>button:first-child{border-top-left-radius:3px;border-top-right-radius:3px}.treb-main.treb-main .treb-toolbar .treb-split>button:last-child{border-bottom-left-radius:3px;border-bottom-right-radius:3px;border-top:0}.treb-main.treb-main .treb-toolbar .treb-font-stack{align-items:flex-start;overflow:hidden;width:8em}.treb-main.treb-main .treb-toolbar .treb-font-stack:before{display:none}.treb-main.treb-main .treb-toolbar .treb-menu{outline:none}.treb-main.treb-main .treb-toolbar .treb-menu>div{background:var(--treb-toolbar-button-background,#fff);border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px;box-shadow:0 4px 6px -4px rgba(0,0,0,.4);display:none;flex-direction:column;margin-top:.5rem;position:fixed;top:48px;z-index:20}.treb-main.treb-main .treb-toolbar .treb-menu>div button{background:transparent;border:0;margin:3px 0;padding:.4rem 1rem;text-align:left;transition:background-color .125s ease;white-space:nowrap}.treb-main.treb-main .treb-toolbar .treb-menu>div button:hover{background:var(--treb-toolbar-hover-button-background,#f3f4f6)}.treb-main.treb-main .treb-toolbar .treb-menu>div.treb-icon-buttons>.treb-menu>button,.treb-main.treb-main .treb-toolbar .treb-menu>div.treb-icon-buttons>button{padding:0}.treb-main.treb-main .treb-toolbar .treb-menu>div>[separator]{background:var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));height:1px;margin:2px 0}.treb-main.treb-main .treb-toolbar .treb-menu.visible>div,.treb-main.treb-main .treb-toolbar .treb-menu:focus-within>div{display:flex}.treb-main.treb-main .treb-toolbar [data-icon=file-menu]{--icon:var(--icon-file-menu)}.treb-main.treb-main .treb-toolbar [data-command=justify-left]{--icon:var(--icon-text-align-left)}.treb-main.treb-main .treb-toolbar [data-command=justify-right]{--icon:var(--icon-text-align-right)}.treb-main.treb-main .treb-toolbar [data-command=justify-center]{--icon:var(--icon-text-align-center)}.treb-main.treb-main .treb-toolbar [data-command=indent]{--icon:var(--icon-text-indent)}.treb-main.treb-main .treb-toolbar [data-command=outdent]{--icon:var(--icon-text-outdent)}.treb-main.treb-main .treb-toolbar [data-command=align-top]{--icon:var(--icon-text-align-top)}.treb-main.treb-main .treb-toolbar [data-command=align-middle]{--icon:var(--icon-text-align-middle)}.treb-main.treb-main .treb-toolbar [data-command=align-bottom]{--icon:var(--icon-text-align-bottom)}.treb-main.treb-main .treb-toolbar [data-command=merge-cells]{--icon:var(--icon-merge-cells)}.treb-main.treb-main .treb-toolbar [data-command=unmerge-cells]{--icon:var(--icon-unmerge-cells)}.treb-main.treb-main .treb-toolbar [data-command=fill-color]{--icon:var(--icon-fill-color)}.treb-main.treb-main .treb-toolbar [data-command=text-color]{--icon:var(--icon-text-color)}.treb-main.treb-main .treb-toolbar [data-command=lock-cells]{--icon:var(--icon-lock)}.treb-main.treb-main .treb-toolbar [data-command=wrap-text]{--icon:var(--icon-wrap-text)}.treb-main.treb-main .treb-toolbar [data-icon=comment]{--icon:var(--icon-comment)}.treb-main.treb-main .treb-toolbar [data-icon=table]{--icon:var(--icon-table)}.treb-main.treb-main .treb-toolbar [data-icon=layout]{--icon:var(--icon-layout)}.treb-main.treb-main .treb-toolbar [data-command=freeze-panes]{--icon:var(--icon-freeze)}.treb-main.treb-main .treb-toolbar [data-command=insert-column-chart]{--icon:var(--icon-column-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-donut-chart]{--icon:var(--icon-donut-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-bar-chart]{--icon:var(--icon-bar-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-line-chart]{--icon:var(--icon-line-chart)}.treb-main.treb-main .treb-toolbar [data-command=insert-image]{--icon:var(--icon-image)}.treb-main.treb-main .treb-toolbar [data-command=border-bottom]{--icon:var(--icon-border-bottom)}.treb-main.treb-main .treb-toolbar [data-command=border-left]{--icon:var(--icon-border-left)}.treb-main.treb-main .treb-toolbar [data-command=border-right]{--icon:var(--icon-border-right)}.treb-main.treb-main .treb-toolbar [data-command=border-top]{--icon:var(--icon-border-top)}.treb-main.treb-main .treb-toolbar [data-command=border-outside]{--icon:var(--icon-border-outer)}.treb-main.treb-main .treb-toolbar [data-command=border-all]{--icon:var(--icon-border-all)}.treb-main.treb-main .treb-toolbar [data-command=border-none]{--icon:var(--icon-border-none)}.treb-main.treb-main .treb-toolbar [data-command=border-double-bottom]{--icon:var(--icon-border-double-bottom)}.treb-main.treb-main .treb-toolbar [data-icon=palette]{--icon:var(--icon-palette)}.treb-main.treb-main .treb-toolbar [data-command=recalculate]{--icon:var(--icon-recalculate);--icon-size:20px 20px}.treb-main.treb-main .treb-toolbar .treb-font-scale{width:4em}.treb-main.treb-main .treb-toolbar .treb-number-format{width:8em}.treb-main.treb-main .treb-toolbar .treb-color-chooser button[data-command=set-color]{align-items:center;display:flex;justify-content:center;padding:0;width:32px}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div{padding:.75rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div+div{padding-top:0}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child{align-items:center;display:flex;flex-direction:row;gap:.5rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child input{flex-grow:1;padding:0 .5rem}.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child button,.treb-main.treb-main .treb-toolbar .treb-color-chooser>div:last-child input{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px;height:32px}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch button,.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches button{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:2px;height:18px;margin:0;padding:0;width:18px}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch .treb-default-color:before,.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches .treb-default-color:before{background:currentColor;content:"";display:block;height:100%;mask-image:var(--icon-x);-webkit-mask-image:var(--icon-x);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-size:24px 24px;-webkit-mask-size:24px 24px;opacity:.7;position:relative;width:100%}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-default-swatch{align-items:center;display:grid;gap:.5rem;grid-template-columns:auto 1fr}.treb-main.treb-main .treb-toolbar .treb-color-chooser .treb-swatches{display:grid;gap:.5rem;grid-template-columns:repeat(10,1fr)}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));font:inherit;height:10rem;line-height:1.5;margin:.5rem;padding:.25rem;resize:both}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea+div{align-items:center;display:flex;flex-direction:row;gap:.5rem;justify-content:center;padding:0 0 .5rem}.treb-main.treb-main .treb-toolbar .treb-comment-box textarea+div button{border:1px solid var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-radius:3px}.treb-main.treb-main .treb-toolbar .treb-font-scale{padding-left:2em;text-align:right;width:5em}.treb-main.treb-main .treb-toolbar [composite][font-scale]{position:relative}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon{border-radius:3px;left:.5em;line-height:1;opacity:.9;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%)}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:after,.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:before{content:"A";position:relative}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:before{font-size:1.2em}.treb-main.treb-main .treb-toolbar .treb-font-scale-icon:after{font-size:.9em;left:-.125em}.treb-main.treb-main{--treb-font-stack-default-size:14px;--treb-font-stack-calibri-size:16px;--treb-font-stack-tscu-comic-size:16px;--treb-font-stack-helvetica-neue-size:13px;--treb-font-stack-cambria-size:16px;--treb-font-stack-sitka-text-variant:lining-nums tabular-nums}.treb-main.treb-main.treb-ua-osx{--treb-font-stack-system-ui-size:10pt}.treb-main.treb-main .treb-font-stack-default{font-family:calibri,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif"}.treb-main.treb-main .treb-font-stack-transitional{font-family:Charter,Bitstream Charter,Cambria,serif}.treb-main.treb-main .treb-font-stack-old-style{font-family:Iowan Old Style,Palatino Linotype,URW Palladio L,P052,serif}.treb-main.treb-main .treb-font-stack-handwritten{font-family:Segoe Print,Bradley Hand,Chilanka,TSCu_Comic,casual,cursive}.treb-main.treb-main .treb-font-stack-industrial{font-family:Bahnschrift,DIN Alternate,Franklin Gothic Medium,Nimbus Sans Narrow,sans-serif-condensed,sans-serif}.treb-main.treb-main .treb-font-stack-monospace{font-family:ui-monospace,Cascadia Code,Source Code Pro,Menlo,Consolas,DejaVu Sans Mono,monospace}.treb-main.treb-main .treb-font-stack-ui{font-family:system-ui,sans-serif}.treb-main.treb-main{all:revert;box-sizing:border-box;color:inherit;color-scheme:var(--treb-color-scheme,unset);display:grid;font-family:var(--treb-default-font,system-ui,"BlinkMacSystemFont","Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue","sans-serif");font-family:BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,"sans-serif";font-size:14px;font-style:normal;font-weight:400;grid-template-columns:minmax(0,1fr) auto;grid-template-rows:auto minmax(0,1fr);height:100%;line-height:normal;position:relative;text-align:start;width:100%}.treb-main.treb-main a,.treb-main.treb-main button,.treb-main.treb-main div,.treb-main.treb-main input,.treb-main.treb-main li,.treb-main.treb-main ol,.treb-main.treb-main svg,.treb-main.treb-main textarea,.treb-main.treb-main ul{all:revert;box-sizing:border-box;font-family:var(--treb-default-font,system-ui,"BlinkMacSystemFont","Segoe UI","Roboto","Oxygen-Sans","Ubuntu","Cantarell","Helvetica Neue","sans-serif")}.treb-main.treb-main button,.treb-main.treb-main input{color:inherit;font:inherit}.treb-main.treb-main *{box-sizing:border-box}.treb-main.treb-main [contenteditable]{-webkit-user-modify:read-write;-moz-user-modify:read-write}.treb-main.treb-main[animate] .treb-layout-header{transition:height var(--treb-sidebar-transition,.2s ease),opacity var(--treb-sidebar-transition,.2s ease)}.treb-main.treb-main .treb-layout-header{grid-column:1/3;grid-row:1;height:1px;opacity:0}.treb-main.treb-main[toolbar] .treb-layout-header{height:42px;opacity:1}.treb-main.treb-main[dialog] .treb-layout-header,.treb-main.treb-main[dialog]>*{opacity:.6}.treb-main.treb-main[dialog] .treb-dialog-mask{opacity:1;pointer-events:auto}.treb-main.treb-main .treb-layout-spreadsheet{display:flex;flex-direction:row;gap:1em;grid-column:1;grid-row:2;position:relative;transition:opacity .2s ease;z-index:5}.treb-main.treb-main .treb-views.treb-can-revert .treb-view .treb-revert-indicator{opacity:1;pointer-events:auto}.treb-main.treb-main .treb-view{display:grid;flex:1 1 0px;grid-template-columns:minmax(0,1fr);grid-template-rows:auto minmax(0,1fr) auto;position:relative}.treb-main.treb-main .treb-view .treb-spreadsheet-backdrop{box-shadow:0 4px 6px -4px rgba(0,0,0,.4);grid-column:1;grid-row:2;z-index:2}.treb-main.treb-main .treb-view .treb-spreadsheet-body{position:relative;z-index:4}.treb-main.treb-main .treb-view .treb-spreadsheet-footer{position:relative;z-index:5}.treb-main.treb-main .treb-view .treb-layout-resize-handle,.treb-main.treb-main .treb-view .treb-revert-indicator{display:none}.treb-main.treb-main .treb-view:first-of-type .treb-revert-indicator{align-self:start;border-color:orange transparent transparent orange;border-style:solid;border-width:.5em;display:block;grid-area:2/1/3/2;height:1rem;justify-self:start;opacity:0;overflow:hidden;pointer-events:none;position:relative;transition:opacity .125s ease;width:1rem;z-index:20}.treb-main.treb-main .treb-view:last-of-type .treb-layout-resize-handle{align-self:end;border-bottom:.5rem solid var(--treb-resize-handle-color,#0059b9);border-left:.5rem solid transparent;border-right:.5rem solid var(--treb-resize-handle-color,#0059b9);border-top:.5rem solid transparent;cursor:nw-resize;display:block;grid-area:2/1/3/2;height:1rem;justify-self:end;width:1rem;z-index:20}.treb-main.treb-main[animate] .treb-layout-sidebar{transition:width var(--treb-sidebar-transition,.2s ease),opacity var(--treb-sidebar-transition,.2s ease)}.treb-main.treb-main .treb-layout-sidebar{align-items:center;display:flex;flex-direction:column;gap:.75rem;grid-column:2;grid-row:2;justify-content:flex-start;overflow:hidden;padding-top:3rem;width:2.5rem;width:3rem}.treb-main.treb-main[collapsed] .treb-layout-sidebar{opacity:0;width:0}.treb-main.treb-main[collapsed] .treb-toggle-sidebar-button{background:var(--treb-toolbar-button-background,#fff);border-bottom-right-radius:0;border-color:var(--treb-toolbar-border-color,var(--treb-ui-border-color,#d1d5db));border-right-color:var(--treb-toolbar-button-background,transparent);border-top-right-radius:0;right:0}.treb-main.treb-main[collapsed] .treb-toggle-sidebar-button:after{mask-image:var(--icon-chevron-left);-webkit-mask-image:var(--icon-chevron-left)}.treb-main.treb-main .treb-layout-sidebar>button,.treb-main.treb-main .treb-toggle-sidebar-button{background:transparent;border:0;margin:0;padding:0}.treb-main.treb-main .treb-layout-sidebar>button:after,.treb-main.treb-main .treb-toggle-sidebar-button:after{background:#ccc;content:"";display:block;height:24px;mask-image:var(--icon);-webkit-mask-image:var(--icon);mask-position:center;-webkit-mask-position:center;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;transition:background-color .1s ease;width:24px}.treb-main.treb-main .treb-layout-sidebar>button[data-can-revert=false],.treb-main.treb-main .treb-toggle-sidebar-button[data-can-revert=false]{display:none}.treb-main.treb-main .treb-layout-sidebar>button:hover:after,.treb-main.treb-main .treb-toggle-sidebar-button:hover:after{background:#666}.treb-main.treb-main .treb-layout-sidebar>button[data-command=recalculate],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=recalculate]{--icon:var(--icon-reset)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=toggle-toolbar],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=toggle-toolbar]{--icon:var(--icon-toolbar)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=revert],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=revert]{--icon:var(--icon-revert)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=export-xlsx],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=export-xlsx]{--icon:var(--icon-export)}.treb-main.treb-main .treb-layout-sidebar>button[data-command=about],.treb-main.treb-main .treb-toggle-sidebar-button[data-command=about]{--icon:var(--icon-about)}.treb-main.treb-main .treb-toggle-sidebar-button{align-items:center;background:transparent;border:1px solid transparent;border-radius:12px;bottom:6rem;display:flex;height:24px;justify-content:center;margin:0;padding:0;position:absolute;right:.5rem;right:calc(1.5rem - 12px);width:24px;z-index:39}.treb-main.treb-main .treb-toggle-sidebar-button:after{height:12px;mask-image:var(--icon-chevron-right);-webkit-mask-image:var(--icon-chevron-right);width:12px}.treb-main.treb-main .treb-resize-rect{border:1px dotted var(--treb-resize-frame-color,blue);display:block;height:100%;left:0;position:fixed;top:0;width:100%;z-index:9998}.treb-main.treb-main .treb-resize-mask{height:100vh;left:0;position:fixed;top:0;width:100vw;z-index:9999}treb-spreadsheet{display:block;overflow:hidden;position:relative}.treb-default-size{height:550px;width:800px}`,ps='<div class="treb-main treb-theme"><div class="treb-layout-header treb-animate"><div class="treb-toolbar"></div></div><div class="treb-dialog-mask"><div data-bind="dialog" class="treb-embed-dialog"><div data-bind="left"><a href="https://treb.app" target="_blank"><div class="treb-icon-64"></div></a></div><div data-bind="middle"><div data-bind="title" class="treb-embed-dialog-title"></div><div data-bind="message" class="treb-embed-dialog-message"></div><div data-bind="about" class="treb-embed-dialog-body"></div></div><button type="button" data-title="close_dialog" data-bind="close" class="treb-close-box"><svg viewBox="0 0 16 16"><path d="M11.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708-.708l7-7a.5.5 0 0 1 .708 0z"/><path d="M4.146 4.146a.5.5 0 0 0 0 .708l7 7a.5.5 0 0 0 .708-.708l-7-7a.5.5 0 0 0-.708 0z"/></svg></button></div></div><div class="treb-layout-spreadsheet treb-views"><template class="treb-view-template"><div class="treb-view"><div class="treb-formula-bar notranslate" hidden><div class="treb-address-label"><div></div></div><button class="treb-insert-function-button" data-title="insert_function" data-conditional="insert-function">𝑓<small>(x)</small></button><div class="treb-editor-container"><div contenteditable="true"></div></div></div><div class="treb-spreadsheet-backdrop"></div><div class="treb-spreadsheet-body" role="grid"><div class="treb-grid" tabindex="-1"><div class="treb-overlay-container notranslate" translate="no"><div class="treb-overlay-inset"><div class="treb-overlay-editor" contenteditable tabindex="-1" spellcheck="true" role="gridcell"></div></div></div></div></div><div class="treb-spreadsheet-footer" hidden><button class="treb-delete-tab" data-title="delete_sheet" data-command="delete-tab" data-conditional="delete-tab"><svg tabindex="-1" viewbox="0 0 16 16"><path d="M4,4 L12,12 M12,4 L4,12"/></svg></button><div class="treb-spreadsheet-tab-container"><ol class="treb-spreadsheet-tabs" role="tablist"></ol></div><button class="treb-add-tab" data-command="add-tab" data-conditional="add-tab" data-title="add_sheet">+</button><div class="treb-stats-panel"></div><div class="treb-scale-control" data-conditional="scale-control"></div></div><div class="treb-layout-resize-handle" data-conditional="resize"></div><div class="treb-revert-indicator" data-command="revert-indicator" data-title="document_modified"></div></div></template></div><div class="treb-layout-sidebar treb-animate"><button data-command="recalculate" data-title="recalculate"></button> <button data-command="toggle-toolbar" data-conditional="toolbar" data-title="toggle_toolbar"></button> <button data-command="export-xlsx" data-conditional="export" data-title="export"></button> <button data-command="revert" data-conditional="revert" data-title="revert"></button> <button data-command="about" data-title="about"></button></div><button class="treb-toggle-sidebar-button" data-title="toggle_sidebar"></button></div>',_l='<div class="treb-menu" title="File menu" file-menu><button data-icon="file-menu" menu-target></button><div><button data-command="reset">New document</button><div separator></div><button data-command="import-file">Open file...</button> <button data-command="save-json">Save JSON</button><div separator xlsx-support></div><button data-command="export-xlsx" xlsx-support>Export XLSX</button></div></div><div composite narrow><button data-command="justify-left" data-target="justify" title="Left-align text"></button><div class="treb-menu"><button dropdown title="Text justify options"></button><div class="treb-icon-buttons" data-replace="justify"><button data-command="justify-left" title="Left-align text"></button> <button data-command="justify-center" title="Center-align text"></button> <button data-command="justify-right" title="Right-align text"></button></div></div></div><div composite narrow><button data-command="align-top" data-target="align" title="Align to top"></button><div class="treb-menu"><button dropdown title="Text align options"></button><div class="treb-icon-buttons" data-replace="align"><button data-command="align-top" title="Align to top"></button> <button data-command="align-middle" title="Align to middle"></button> <button data-command="align-bottom" title="Align to bottom"></button></div></div></div><div class="group" wide><button data-command="justify-left" title="Left-align text"></button> <button data-command="justify-center" title="Center-align text"></button> <button data-command="justify-right" title="Right-align text"></button></div><div class="group" wide><button data-command="align-top" title="Align to top"></button> <button data-command="align-middle" title="Align to middle"></button> <button data-command="align-bottom" title="Align to bottom"></button></div><div class="group" wide indent-group><button data-command="outdent" title="Decrease indent"></button> <button data-command="indent" title="Incrase indent"></button></div><div class="group"><button data-command="wrap-text" title="Wrap text"></button> <button data-command="merge-cells" data-id="merge" data-inactive-title="Merge cells" data-active-title="Unmerge cells"></button> <button data-command="lock-cells" data-inactive-title="Lock cells" data-active-title="Unlock cells"></button> <button data-command="freeze-panes" data-inactive-title="Freeze panes" data-active-title="Unfreeze panes" freeze-button></button> <button data-command="insert-table" data-icon="table" data-inactive-title="Insert table" data-active-title="Remove table" table-button></button><div class="treb-menu"><button data-icon="comment" data-inactive-title="Comment" data-active-title="Update comment"></button><div class="treb-comment-box"><textarea></textarea><div><button data-command="clear-comment">Clear</button> <button data-command="update-comment">Save</button></div></div></div></div><div composite><button data-command="border-bottom" data-target="border" title="Bottom border"></button><div class="treb-menu"><button dropdown title="Border options"></button><div class="treb-icon-buttons" data-replace="border"><button data-command="border-top" title="Top border"></button> <button data-command="border-left" title="Left border"></button> <button data-command="border-right" title="Right border"></button> <button data-command="border-bottom" title="Bottom border"></button> <button data-command="border-double-bottom" title="Double bottom border"></button> <button data-command="border-outside" title="Outside borders"></button> <button data-command="border-all" title="All borders"></button> <button data-command="border-none" title="Clear borders"></button><div separator></div><div class="treb-menu treb-color-menu treb-submenu" data-color-command="border-color" data-replace-color="border" title="Border color" data-default-color-text="Default border color"><button data-icon="palette" data-color-bar="border" data-color="{}"></button></div></div></div></div><div composite><button data-command="fill-color" data-color-bar="fill" data-color="{}" title="Fill color"></button><div class="treb-menu treb-color-menu" data-color-command="fill-color" data-replace-color="fill" data-default-color-text="No fill"><button dropdown title="Color options"></button><div class="treb-color-chooser"><div class="treb-caption">Theme colors</div><div class="treb-swatches"></div><div class="treb-caption">No color</div><div class="treb-default-swatch"><button class="treb-default-color" data-command="set-color" data-color="{}"></button> <span class="treb-default-color-label" data-command="set-color" data-color="{}">...</span></div><div class="treb-caption">Other colors</div><div class="treb-swatches"></div><div><input placeholder="New color" class="treb-color-input"> <button data-command="set-color" data-color=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg></button></div></div></div></div><div composite><button data-command="text-color" data-color-bar="text" data-color="{}" title="Text color"></button><div class="treb-menu treb-color-menu" data-color-command="text-color" data-replace-color="text" data-default-color-text="Default text color"><button dropdown title="Color options"></button></div></div><div composite font-scale><div class="treb-font-scale-icon"></div><input class="treb-font-scale" title="Font scale"><div class="treb-menu"><button dropdown title="Font scale options"></button><div><button data-command="font-scale" data-scale="0.8">0.80</button> <button data-command="font-scale" data-scale="0.9">0.90</button> <button data-command="font-scale" data-scale="1.0">1.00</button> <button data-command="font-scale" data-scale="1.1">1.10</button> <button data-command="font-scale" data-scale="1.25">1.25</button> <button data-command="font-scale" data-scale="1.5">1.50</button> <button data-command="font-scale" data-scale="2.0">2.00</button></div></div></div><div composite font-stack><button class="treb-font-stack" data-command="font-stack" data-font-stack="" title="Font stack"></button><div class="treb-menu"><button dropdown title="Font stack options"></button><div><button data-command="font-stack" data-font-stack="default"></button> <button data-command="font-stack" data-font-stack="transitional"></button> <button data-command="font-stack" data-font-stack="monospace"></button> <button data-command="font-stack" data-font-stack="handwritten"></button> <button data-command="font-stack" data-font-stack="ui"></button></div></div></div><div composite><input class="treb-number-format" title="Number format"><div class="treb-menu"><button dropdown title="Number formats"></button><div class="treb-number-format-menu"></div></div></div><div class="treb-split"><button data-command="decrease-precision" title="Decrease precision"></button> <button data-command="increase-precision" title="Increase precision"></button></div><div class="treb-menu"><button data-icon="layout" title="Rows & columns"></button><div><button data-command="insert-row">Insert row</button> <button data-command="insert-column">Insert column</button> <button data-command="delete-row">Delete row</button> <button data-command="delete-column">Delete column</button><div separator add-remove-sheet></div><button data-command="insert-sheet" add-remove-sheet>Add sheet</button> <button data-command="delete-sheet" add-remove-sheet>Delete sheet</button></div></div><div composite chart-menu><button data-command="insert-column-chart" data-target="annotation" title="Insert column chart"></button><div class="treb-menu"><button dropdown title="Chart options"></button><div class="treb-icon-buttons" data-replace="annotation"><button data-command="insert-column-chart" title="Insert column chart"></button> <button data-command="insert-donut-chart" title="Insert donut chart"></button> <button data-command="insert-bar-chart" title="Insert bar chart"></button> <button data-command="insert-line-chart" title="Insert line chart"></button><div separator></div><button data-command="insert-image" title="Insert image"></button></div></div></div><button data-command="recalculate" title="Recalculate" recalculate-button></button>',Ya={close_dialog:"Close dialog",insert_function:"Insert function...",delete_sheet:"Delete current sheet",add_sheet:"Add sheet",document_modified:"This document has been modified from the original version.",recalculate:"Recalculate",toggle_toolbar:"Toggle toolbar",export:"Export as XLSX",revert:"Revert to original version",about:"What's this?",toggle_sidebar:"Toggle sidebar"},bs=class{root;sheet;border_color;color_bar_elements={};replace_targets={};layout_element;views;revert_button;revert_state=!1;toolbar_controls={};swatch_lists={};DOM;constructor(e){typeof e=="string"&&(e=document.querySelector(e)),this.DOM=le.GetInstance(e?.ownerDocument),this.DOM.view&&e instanceof this.DOM.view.HTMLElement&&(this.root=e,this.DOM.doc?.head.querySelector("style[treb-stylesheet]")||this.DOM.doc?.head.prepend(this.DOM.Create("style",void 0,void 0,{text:gl,attrs:{"treb-stylesheet":""}})))}CoerceAttributeValue(e){if(e===null||e.toString().toLowerCase()==="true"||e==="")return!0;if(e.toLowerCase()==="false")return!1;{let t=Number(e);if(!isNaN(t))return t}return e||""}ParseOptionAttributes(){let e={};if(this.root){let t=this.root.getAttributeNames();for(let r of t){switch(r){case"class":case"style":case"id":continue;case"data-options":case"options":{let a=(this.root.getAttribute(r)||"").split(",");for(let i of a){let s=i.split(/=/);s.length===1?e[s[0]]=!0:e[s[0]]=this.CoerceAttributeValue(s[1])}}continue;case"data-treb":continue;case"inline-document":continue;case"src":e.document=this.root.getAttribute("src")||void 0;continue}e[r.replace(/-/g,"_")]=this.CoerceAttributeValue(this.root.getAttribute(r))}}return{...e}}AttachElement(e={}){if(e={...this.ParseOptionAttributes(),...e},this.root){if(!e.headless){let t=this.root.getBoundingClientRect();(!t.width||!t.height)&&this.root.classList.add("treb-default-size")}if(this.root.hasAttribute("inline-document")){let t=this.root.getAttribute("inline-document")||"";for(let r of Array.from(this.root.children))if(this.DOM.view&&r instanceof this.DOM.view.HTMLScriptElement&&r.type==="application/json"){let a=r.getAttribute("name")||"";if(a===t||!a&&t==="true"){let i=r.textContent;if(i)try{e.inline_document=JSON.parse(i)}catch(s){console.error(s)}break}}e.inline_document||console.warn("inline document failed")}this.root.innerHTML=ps,e.container=this.root.querySelector(".treb-layout-spreadsheet")}this.sheet=new fs(e),this.root&&this.CreateLayout(this.sheet,this.root)}CreateLayout(e,t){new ResizeObserver(()=>e.Resize()).observe(t),this.layout_element=t.querySelector(".treb-main");let r=t.querySelector(".treb-toggle-sidebar-button");if(r&&this.layout_element){let o=this.layout_element;r.addEventListener("click",()=>{let n=o.getAttribute("collapsed");typeof n=="string"&&(n===""||n==="true")?o.removeAttribute("collapsed"):o.setAttribute("collapsed","")})}(e.options.toolbar==="show"||e.options.toolbar==="show-narrow")&&this.layout_element?.setAttribute("toolbar",""),e.options.collapsed&&this.layout_element?.setAttribute("collapsed","");let a=t.querySelector("[data-command=revert-indicator]");this.DOM.view&&a instanceof this.DOM.view.HTMLElement&&(e.options.revert_indicator?a.addEventListener("click",()=>{e.HandleToolbarMessage({command:"revert-indicator"})}):a.style.display="none"),t.querySelector(".treb-layout-sidebar")?.addEventListener("click",o=>{let n=o.target;if(n.dataset.command)switch(n.dataset.command){case"toggle-toolbar":this.ToggleToolbar();break;default:e.HandleToolbarMessage({command:n.dataset.command});break}}),e.options.toolbar&&this.AttachToolbar(e,t);let i={"table-button":!!e.options.table_button,revert:!!e.options.revert_button,toolbar:!!e.options.toolbar,export:!!e.options.export,"insert-function":!!e.options.insert_function_button,resize:!!e.options.resizable,"add-tab":!!e.options.add_tab,"delete-tab":!!e.options.delete_tab||!!e.options.add_tab};for(let[o,n]of Object.entries(i))if(!n){let l=this.layout_element.querySelectorAll(`[data-conditional=${o}]`);for(let h of Array.from(l))h.style.display="none"}if(e.options.revert_button&&(this.revert_button=this.layout_element.querySelector("[data-command=revert]")||void 0),e.options.resizable){let o={width:0,height:0},n={x:0,y:0},l={x:0,y:0};this.views=t.querySelector(".treb-views")||void 0;let h,d,c=t.querySelector(".treb-layout-resize-handle"),u=()=>f(),m=p=>{p.buttons===0?f():(l.x=p.screenX-n.x,l.y=p.screenY-n.y,d&&(d.style.width=o.width+l.x+"px",d.style.height=o.height+l.y+"px"))},f=()=>{if(l.x||l.y){let p=t.getBoundingClientRect();e.options.constrain_width||(t.style.width=p.width+l.x+"px"),t.style.height=p.height+l.y+"px"}h&&(h.removeEventListener("mouseup",u),h.removeEventListener("mousemove",m),h.parentElement?.removeChild(h),h=void 0),d?.parentElement?.removeChild(d),d=void 0};c.addEventListener("mousedown",p=>{p.stopPropagation(),p.preventDefault();let b=t.querySelector(".treb-main");d=this.DOM.Div("treb-resize-rect",b),h=this.DOM.Div("treb-resize-mask",b,{attrs:{style:"cursor: nw-resize;"},events:{mouseup:u,mousemove:m}}),n.x=p.screenX,n.y=p.screenY,l.x=0,l.y=0;let w=this.views?.querySelectorAll(".treb-spreadsheet-body"),y=Array.from(w||[]).map(g=>g.getBoundingClientRect());if(y.length){let g=JSON.parse(JSON.stringify(y.shift()));for(let _ of y)g.top=Math.min(_.top,g.top),g.left=Math.min(_.left,g.left),g.right=Math.max(_.right,g.right),g.bottom=Math.max(_.bottom,g.bottom);let v=g.right-g.left,x=g.bottom-g.top;d.style.top=g.top+"px",d.style.left=g.left+"px",d.style.width=v+"px",d.style.height=x+"px",o.width=v,o.height=x}})}let s=Array.from(this.layout_element.querySelectorAll("[data-title]"));for(let o of s)if(o instanceof HTMLElement){if(o.dataset.activeTitle)continue;o.dataset.title&&Ya[o.dataset.title]&&(o.title=Ya[o.dataset.title])}setTimeout(()=>this.layout_element?.setAttribute("animate",""),250)}ToggleToolbar(){if(this.layout_element){let e=this.layout_element.getAttribute("toolbar");typeof e=="string"&&(e===""||e==="true")?this.layout_element.removeAttribute("toolbar"):this.layout_element.setAttribute("toolbar","")}}UpdateSelectionStyle(e,t,r){let a=e.selection_state;r.value="";for(let n of Object.values(this.toolbar_controls))n&&(n.removeAttribute("active"),n.dataset.inactiveTitle&&(n.title=n.dataset.inactiveTitle));let i=n=>{n&&(n.setAttribute("active",""),n.dataset.activeTitle&&(n.title=n.dataset.activeTitle))};if(a.comment&&(i(this.toolbar_controls.comment),r.value=a.comment),a.style?.locked&&i(this.toolbar_controls.locked),a.frozen&&i(this.toolbar_controls.freeze),a.style?.wrap&&i(this.toolbar_controls.wrap),this.toolbar_controls.table&&(a.table?(i(this.toolbar_controls.table),this.toolbar_controls.table.dataset.command="remove-table"):this.toolbar_controls.table.dataset.command="insert-table"),this.toolbar_controls.merge&&(a.merge?(i(this.toolbar_controls.merge),this.toolbar_controls.merge.dataset.command="unmerge-cells"):this.toolbar_controls.merge.dataset.command="merge-cells"),this.toolbar_controls.stack)if(a.style?.font_face)if(a.style.font_face.startsWith("stack:")){let n=a.style.font_face.substring(6);this.toolbar_controls.stack.textContent=kr[n]||"",this.toolbar_controls.stack.dataset.fontStack=n}else this.toolbar_controls.stack.textContent="",this.toolbar_controls.stack.dataset.fontStack="";else this.toolbar_controls.stack.textContent=kr.default,this.toolbar_controls.stack.dataset.fontStack="default";let s=this.toolbar_controls.format;s&&(a.style?.number_format?s.value=V.SymbolicName(a.style.number_format)||a.style.number_format:s.value="General");let o=this.toolbar_controls.scale;switch(o&&(o.value=e.FormatNumber(a.relative_font_size||1,"0.00")),a.style?.horizontal_align){case"left":i(this.toolbar_controls.left);break;case"center":i(this.toolbar_controls.center);break;case"right":i(this.toolbar_controls.right);break}switch(a.style?.vertical_align){case"top":i(this.toolbar_controls.top);break;case"middle":i(this.toolbar_controls.middle);break;case"bottom":i(this.toolbar_controls.bottom);break}}UpdateDocumentStyles(e,t){{let o=this.DOM.Fragment(),n=e.document_styles.theme_colors.length,l=["Background","Text","Background","Text","Accent"];if(n){let u=e.document_styles.theme_colors[0].length;for(let m=0;m<u;m++)for(let f=0;f<n;f++){let p=e.document_styles.theme_colors[f][m],b=`background: ${p.resolved};`,w=l[f]||l[4];ra(p.color)&&p.color.tint?w+=` (${(p.color.tint>0?"+":"")+p.color.tint*100}%)`:f===0?this.color_bar_elements.fill?.style.setProperty("--treb-default-color",p.resolved):f===1&&(this.color_bar_elements.text?.style.setProperty("--treb-default-color",p.resolved),this.color_bar_elements.border?.style.setProperty("--treb-default-color",p.resolved)),this.DOM.Create("button",void 0,o,{attrs:{style:b,title:w},data:{command:"set-color",color:JSON.stringify(p.color)}})}}this.swatch_lists.theme?.replaceChildren(o),o=this.DOM.Fragment();let h=["Black","White","Gray","Red","Orange","Yellow","Green","Blue","Indigo","Violet"],d=h.map(u=>u.toLowerCase()),c=e.document_styles.colors.filter(u=>!d.includes(u.toLowerCase()));for(let u of[...h,...c]){let m=`background: ${u.toLowerCase()};`;this.DOM.Create("button",void 0,o,{attrs:{style:m,title:u},data:{command:"set-color",color:JSON.stringify({text:u.toLowerCase()})}})}this.swatch_lists.other?.replaceChildren(o)}let r=["General","Number","Integer","Percent","Fraction","Accounting","Currency","Scientific"],a=["Timestamp","Long Date","Short Date"];for(let o of e.document_styles.number_formats)V.SymbolicName(V.Translate(o))||(V.Get(o).date_format?a.push(o):r.push(o));let i=o=>this.DOM.Create("button",void 0,void 0,{text:o,data:{format:o,command:"number-format"}}),s=this.DOM.Fragment();s.append(...r.map(o=>i(o))),s.append(this.DOM.Div(void 0,void 0,{attrs:{separator:""}})),s.append(...a.map(o=>i(o))),t.textContent="",t.append(s)}UpdateRevertState(e){let t=e.can_revert;this.revert_state!==t&&(this.revert_state=t,(this.revert_button||e.options.revert_indicator)&&(this.revert_state?this.views?.classList.add("treb-can-revert"):this.views?.classList.remove("treb-can-revert"),this.revert_button&&(this.revert_button.dataset.canRevert=t?"true":"false",t?(this.revert_button.classList.remove("sidebar-disabled"),this.revert_button.title="Revert to original version"):(this.revert_button.classList.add("sidebar-disabled"),this.revert_button.title="This is the original version of the document"))))}ReplaceTemplate(e,t,r=!0){let a=e.querySelector(t);if(a&&a.parentElement){for(let i of Array.from(a.content.children))a.parentElement.insertBefore(i,a);r&&a.parentElement.removeChild(a)}else console.warn("template not found",t)}AttachToolbar(e,t){let r=t.querySelector(".treb-layout-header"),a=t.querySelector(".treb-toolbar");a.innerHTML=_l;let i=[];if(e.options.toolbar==="narrow"||e.options.toolbar==="show-narrow"?i.push(...Array.from(a.querySelectorAll("[wide]"))):i.push(...Array.from(a.querySelectorAll("[narrow]"))),e.options.file_menu||i.push(a.querySelector("[file-menu]")),e.options.indent_buttons||i.push(a.querySelector("[indent-group]")),e.options.font_scale||i.push(a.querySelector("[font-scale]")),!e.options.font_stack)i.push(a.querySelector("[font-stack]"));else{let y=a.querySelectorAll("[font-stack] button[data-font-stack]");for(let g of y)if(g.dataset.fontStack){let v=kr[g.dataset.fontStack];g.textContent=v||""}}e.options.chart_menu||i.push(a.querySelector("[chart-menu]")),e.options.freeze_button||i.push(a.querySelector("[freeze-button]")),e.options.table_button||i.push(a.querySelector("[table-button]")),!e.options.add_tab&&!e.options.delete_tab&&i.push(...Array.from(a.querySelectorAll("[add-remove-sheet]"))),e.options.toolbar_recalculate_button||i.push(a.querySelector("[recalculate-button]"));for(let y of i)y&&y.parentElement?.removeChild(y);let s=a.querySelector(".treb-color-chooser"),o=a.querySelector(".treb-comment-box textarea");for(let[y,g]of Object.entries({top:"[wide] [data-command=align-top]",middle:"[wide] [data-command=align-middle]",bottom:"[wide] [data-command=align-bottom]",left:"[wide] [data-command=justify-left]",right:"[wide] [data-command=justify-right]",center:"[wide] [data-command=justify-center]",wrap:"[data-command=wrap-text]",merge:"[data-id=merge]",comment:"[data-icon=comment]",locked:"[data-command=lock-cells]",freeze:"[data-command=freeze-panes]",table:"[data-icon=table]",format:"input.treb-number-format",scale:"input.treb-font-scale",stack:"button.treb-font-stack"})){let v=a.querySelector(g);v&&(this.toolbar_controls[y]=v)}let n=s.querySelectorAll(".treb-swatches");this.swatch_lists={theme:n[0],other:n[1]};let l=t.querySelector("[data-command=increase-precision");l&&(l.textContent=this.sheet?.FormatNumber(0,"0.00")||""),l=t.querySelector("[data-command=decrease-precision"),l&&(l.textContent=this.sheet?.FormatNumber(0,"0.0")||""),l=a.querySelector("[data-command=update-comment]"),o.addEventListener("keydown",y=>{y.key==="Enter"&&(y.shiftKey||y.ctrlKey)&&l.click()});for(let y of["border","annotation","align","justify"])this.replace_targets[y]=a.querySelector(`[data-target=${y}`);for(let y of["fill","text","border"])this.color_bar_elements[y]=a.querySelector(`[data-color-bar=${y}]`);a.addEventListener("click",y=>{let g=y.target,v={format:g.dataset.format,scale:g.dataset.scale,font_stack:g.dataset.fontStack},x=g?.dataset.command;if(x){let _=g.parentElement?.dataset.replace;if(_){let C=this.replace_targets[_];C&&(C.dataset.command=x,C.title=g.title||"")}switch(/^border-/.test(x)&&(v.color=this.border_color||{}),x){case"text-color":case"fill-color":v.color={};try{v.color=JSON.parse(g.dataset.color||"{}")}catch(C){console.error(C)}break;case"set-color":x=s.dataset.colorCommand||"",v.color={};try{v.color=JSON.parse(g.dataset.color||"{}")}catch(C){console.error(C)}if(x==="border-color"&&(this.border_color=v.color),s.dataset.target){let C=this.color_bar_elements[s.dataset.target];C&&(C.style.setProperty("--treb-color-bar-color",g.style.backgroundColor),C.dataset.color=g.dataset.color||"{}")}break;case"update-comment":v.comment=o.value;break}e.HandleToolbarMessage({command:x,...v})}});let h=(y,g)=>{let v=a.querySelector(y);if(v){let x="";v.addEventListener("focusin",()=>x=v.value),v.addEventListener("keydown",_=>{switch(_.key){case"Escape":v.value=x,e.Focus();break;case"Enter":g(v.value)||(v.value=x,e.Focus());break;default:return}_.stopPropagation(),_.preventDefault()})}};h("input.treb-number-format",y=>y?(e.HandleToolbarMessage({command:"number-format",format:y}),!0):!1),h("input.treb-font-scale",y=>{let g=Number(y);return!g||isNaN(g)?(console.warn("invalid scale value"),!1):(e.HandleToolbarMessage({command:"font-scale",scale:g}),!0)});let d=s.querySelector("input"),c=s.querySelector("input + button");d.addEventListener("input",y=>{if(y instanceof InputEvent&&y.isComposing)return;c.style.background=d.value||"";let g=c.style.backgroundColor||"#fff",v=Ue.MeasureColor(g),x=ee.RGBToHSL(v[0],v[1],v[2]);c.style.color=x.l>.5?"#000":"#fff",c.dataset.color=JSON.stringify(c.style.backgroundColor?{text:c.style.backgroundColor}:{})}),d.addEventListener("keydown",y=>{y.key==="Enter"&&(y.stopPropagation(),y.preventDefault(),c.click())}),/firefox/i.test(navigator.userAgent)?r.addEventListener("scroll",()=>{this.DOM.view&&this.DOM.doc?.activeElement instanceof this.DOM.view.HTMLElement&&this.DOM.doc.activeElement?.blur()}):r.addEventListener("scroll",()=>e.Focus());let u=!1,m=y=>{y.key==="Escape"&&(y.stopPropagation(),y.preventDefault(),Promise.resolve().then(()=>e.Focus()))},f=y=>{if(u){if(y.relatedTarget instanceof Node&&a.contains(y.relatedTarget))return;a.removeEventListener("keydown",m),a.removeEventListener("focusout",f),u=!1}},p=y=>{let g=y.target,v=g?.parentElement;if(g?.classList.contains("treb-menu")){v=g;for(let x of Array.from(v.children))if(x.tagName==="BUTTON"){g=x;break}}else if(!v?.classList.contains("treb-menu"))return;if(g&&v){if(u||(a.addEventListener("focusout",f),a.addEventListener("keydown",m),u=!0),v.dataset.colorCommand){s.querySelector(".treb-default-color")?.setAttribute("title",v.dataset.defaultColorText||"Default color");let P=s.querySelector(".treb-default-color-label");P&&(P.textContent=v.dataset.defaultColorText||"Default color"),v.appendChild(s),s.dataset.colorCommand=v.dataset.colorCommand,s.dataset.target=v.dataset.replaceColor||""}let x=v.querySelector("div"),_=r.getBoundingClientRect(),C=g.getBoundingClientRect(),{left:S}=C,R=v.parentElement;R?.hasAttribute("composite")&&(S=R.firstElementChild.getBoundingClientRect().left);let M=x.getBoundingClientRect();v.classList.contains("treb-submenu")?(x.style.top=C.top-M.height/2+"px",S+C.width+6+M.width>_.right?x.style.left=S-6-M.width+"px":x.style.left=S+C.width+6+"px"):(x.style.top=C.bottom+"px",S+M.width>_.right-6?x.style.left=C.right-M.width+"px":x.style.left=S+"px");let A=x.querySelector("textarea");A&&requestAnimationFrame(()=>A.focus())}},b=this.root?.querySelector(".treb-number-format-menu");b&&(this.UpdateDocumentStyles(e,b),this.UpdateSelectionStyle(e,a,o),e.Subscribe(y=>{switch(y.type){case"focus-view":break;case"data":case"document-change":case"load":case"reset":this.UpdateDocumentStyles(e,b),this.UpdateSelectionStyle(e,a,o),this.UpdateRevertState(e);break;case"theme-change":this.UpdateDocumentStyles(e,b),this.UpdateSelectionStyle(e,a,o);break;case"annotation-selection":case"selection":this.UpdateSelectionStyle(e,a,o);break}}));let w=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);if(a.addEventListener("focusin",y=>{p(y)}),w){let y=Array.from(a.querySelectorAll(".treb-menu"));for(let g of y)g.tabIndex=0;a.addEventListener("mousedown",g=>{p(g)})}}},vl=e=>{let t=4+e.data.length,r=new Float64Array(t);return r[0]=e.column,r[1]=e.row,r[2]=e.sheet_id,r[3]=e.data.length,r.set(e.data,4),r},yl=e=>e.length===3+e[2]&&e[2]===5e3?(console.warn("old-style data"),{column:e[0],row:e[1],sheet_id:0,data:e.subarray(3)}):{column:e[0],row:e[1],sheet_id:e[2],data:e.subarray(4)},ei=e=>{if(e.length===1)return e[0];let t=0,r=0;for(let o of e)t=Math.max(t,o.elapsed),r+=o.trials;let a=e[0],i=a.results.map(o=>{let n=new Float64Array(4+r);return n.set(new Float64Array(o)),n}),s=a.trials+4;for(let o=1;o<e.length;o++){let n=e[o];n.results.forEach((l,h)=>{let d=new Float64Array(l),c=i[h];if(c[0]!==d[0]||c[1]!==d[1]||c[2]!==d[2])throw new Error("mismatch in result address");c.set(d.subarray(4),s)}),s+=n.trials}return{elapsed:t,trials:r,results:i.map(o=>o.buffer)}},wl=class{constructor(e=0){this.m_w=0,this.m_z=0,this.Seed(e)}Seed(e=0){e?(this.m_w=Math.round(e&2863311530)||1,this.m_z=Math.round(e&1431655765)||1):(this.m_w=Math.round(Math.random()*1e5),this.m_z=Math.round(new Date().getTime()))}Next(){this.m_z=36969*(this.m_z&65535)+(this.m_z>>16)&4294967295,this.m_w=18e3*(this.m_w&65535)+(this.m_w>>16)&4294967295;let e=(this.m_z<<16)+this.m_w&4294967295;return e/=4294967296,e+.5}GetState(){return[this.m_w,this.m_z]}},te=new wl,Zr=class{static Sort(e,t){this.QuickSort(e,t,0,e.length)}static Partition(e,t,r,a){let i=e[a-1],s=r;for(let o=r;o<a-1;o+=1)e[o]<=i&&(this.Swap(e,t,o,s),s+=1);return this.Swap(e,t,s,a-1),s}static Swap(e,t,r,a){let i=e[r];e[r]=e[a],e[a]=i,i=t[r],t[r]=t[a],t[a]=i}static QuickSort(e,t,r,a){if(r<a){let i=this.Partition(e,t,r,a);this.QuickSort(e,t,r,i),this.QuickSort(e,t,i+1,a)}}},xt=class{static Sort(e){return this.QuickSort(e,0,e.length-1),e}static Swap(e,t,r){let a=e[t];e[t]=e[r],e[r]=a}static Partition(e,t,r){let a=e[Math.floor((r+t)/2)];for(;t<=r;){for(;e[t]<a;)t++;for(;e[r]>a;)r--;t<=r&&(this.Swap(e,t,r),t++,r--)}return t}static QuickSort(e,t,r){var a;return e.length>1&&(a=this.Partition(e,t,r),t<a-1&&this.QuickSort(e,t,a-1),a<r&&this.QuickSort(e,a,r)),e}},xl={min:0,max:0,range:0,median:0,mean:0,N:0,variance:0,stdev:0,skewness:0,kurtosis:0,stderr:0,percentiles:{0:0,5:0,10:0,15:0,20:0,25:0,30:0,35:0,40:0,45:0,50:0,55:0,60:0,65:0,70:0,75:0,80:0,85:0,90:0,95:0,100:0},zero:0,discrete:!0,mode:0},ne=class{static Correlation(e,t){let r=0,a=0,i=0,s=0,o=0,n=0;for(let l=0;l<e.length;l++)a+=e[l]*t[l],i+=e[l],s+=t[l],o+=e[l]*e[l],n+=t[l]*t[l];return r=e.length*a-i*s,r&&(r/=Math.sqrt((e.length*o-i*i)*(e.length*n-s*s))),r}static TickRange(e,t,r=!1){let a=e/(t-1),i=Math.ceil(this.Log10(a)-1),s=Math.pow(10,i);return Math.ceil(a/s)*s}static Log10(e){return Math.log(e)/Math.LN10}static Log2(e){return Math.log(e)/Math.LN2}static Percentiles(e,t){let r=xt.Sort(e.slice(0)),a=r.length,i=new Array(101);for(let s=0;s<100;s++)i[s]=r[Math.round(a*s/100)];return i[100]=r[a-1],i}static Percentile(e,t){let r=xt.Sort(e.slice(0)),a=r.length,i=Math.max(0,Math.min(a-1,Math.round(a*t)));return r[i]}static Interval(e){let t=0;if(!e.data||!e.data.length)return 0;if(typeof e.min>"u"){if(typeof e.max>"u")return 1;for(let r of e.data)r<=e.max&&t++}else if(typeof e.max>"u")for(let r of e.data)r>=e.min&&t++;else for(let r of e.data)r>=e.min&&r<=e.max&&t++;return t/e.data.length}static R22(e,t){let r=[!0,!0];for(let a=0;a<e.length&&!(e[a]!==e[0]&&(r[0]=!1,!r[1])||t[a]!==t[0]&&(r[1]=!1,!r[0]));a++);return r[0]||r[1]?{error:!0}:{r2:this.R2(e,t),error:!1}}static R2(e,t){let r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0;for(let d=0;d<e.length;d++)a=t[d],i=e[d],s+=a*i,o+=a,n+=i,l+=a*a,h+=i*i;return r=e.length*s-o*n,r&&(r/=Math.sqrt((e.length*l-o*o)*(e.length*h-n*n))),r=r*r,r}static ToSD(e,t=2){if(t=t||2,e===0)return e;let r=Math.pow(10,Math.floor(this.Log10(e))+1-t);return Math.round(e/r)*r}static Statistics(e,t=!1){let r=this.Range(e),a=e.length;if(a===0)return JSON.parse(JSON.stringify(xl));let i=!0,s=0,o=0,n=0,l=0,h=t?e:xt.Sort(e.slice(0)),d=0;a%2?d=e[Math.floor(a/2)]:d=(e[a/2]+e[a/2-1])/2;for(let x=0;x<a;x++)s+=e[x];s/=a;let c=s;for(let x=0;x<a;x++){let _=e[x]-s;o+=_*_,l+=_*_*_,n+=_*_*_*_,i&&e[x]%1&&(i=!1)}let u;if(i){let x=[];for(let C=0;C<e.length;C++)x[e[C]]=(x[e[C]]||0)+1;let _=[];for(let C=0;C<x.length;C++)x[C]&&_.push([C,x[C]]);_.length||(u=0),_.sort((C,S)=>S[1]-C[1]),u=_[0][0]}let m=a,f=o/a,p=Math.sqrt(o/a),b=l/((a-1)*Math.pow(p,3)),w=n/((a-1)*Math.pow(p,4)),y=Math.sqrt(o/a)/Math.sqrt(a),g={};for(let x=5;x<100;x+=5)g[x]=h[Math.round(a*x/100)];g[0]=h[0],g[100]=h[a-1];let v=this.Interval({data:e,max:0});return Object.assign(Object.assign({},r),{median:d,mean:c,N:m,variance:f,stdev:p,skewness:b,kurtosis:w,stderr:y,percentiles:g,zero:v,discrete:i,mode:u})}static Truncate(e,t,r){let a=xt.Sort(e.slice(0));return a.slice(Math.round(a.length*t/100),Math.round(a.length*r/100))}static Histogram(e,t="sturges"){let r=!0;for(let o=0;r&&o<e.length;o++)r=r&&e[o]===Math.round(e[o]);let a=this.Range(e);if(typeof t=="string"||!t)if(t==="fd"){let o=this.FD(e);o===0||a.range===0?t=1:t=Math.round(a.range/o+1)}else t=this.Sturges(e);let i=[],s=[];if(r&&t>a.range){t=a.range+1;for(let o=0;o<t;o++)i[o]=0,s[o]=a.min+o;for(let o of e)i[o-a.min]++}else{let o=this.TickRange(a.range,t),n=this.FirstBin(a.max,a.min,t,o),l=Math.ceil(this.Log10(o)-1);for(let d=0;d<t;d++)i[d]=0,s[d]=(n+d*o).toFixed(Math.max(0,-l));let h=n-o;for(let d of e)i[Math.floor((d-h)/o)]++}return{bins:i,labels:s}}static Sturges(e){return Math.ceil(this.Log2(e.length)+1)}static IQR(e){let t=this.Quantiles(e,[.25,.75]);return t[1]-t[0]}static Quantiles(e,t=[0,.25,.5,.75,1]){let r=xt.Sort(e.slice(0));return t.map(a=>r[Math.floor((r.length-1)*a)])}static FD(e){return 2*this.IQR(e)*Math.pow(e.length,-1/3)}static FirstBin(e,t,r,a){let i=(Math.floor(t/a)+1)*a,s=Math.floor((i+(r-1)*a-e)/a);return s>=2?i-s/2*a:i}static Range(e){let t=e.length,r=t>0?e[0]:0,a=t>0?e[0]:0;for(let i=1;i<t;i++)e[i]>a&&(a=e[i]),e[i]<r&&(r=e[i]);return{min:r,max:a,range:a-r}}};ne.EPSILON_DOUBLE=2220446049250313e-31;ne.QUIET_NAN=Number.NaN;ne.s_undefined="undefined";ne.s_object="object";ne.s_number="number";var Kr=class be{constructor(){this.rows=0,this.columns=0,this.data=[]}static Zero(t,r=t){return new be().Reset(t,r)}static Identity(t){let r=this.Zero(t,t);for(let a=0;a<t;a++)r.data[a][a]=1;return r}static Clone(t){let r=new be;r.rows=t.rows,r.columns=t.columns;for(let a of t.data)r.data.push(new Float64Array(a));return r}static FromArray(t,r=!1){let a=t[0].length,i=t.length;if(r){let s=this.Zero(a,i);for(let o=0;o<i;o++)for(let n=0;n<a;n++)s.data[o][n]=t[o][n];return s}else{let s=this.Zero(i,a);for(let o=0;o<i;o++)for(let n=0;n<a;n++)s.data[n][o]=t[o][n]||0;return s}}Reset(t,r){this.data=new Array(r);for(let a=0;a<r;a++)this.data[a]=new Float64Array(t);return this.rows=t,this.columns=r,this}CopyTo(t){t.rows=this.rows,t.columns=this.columns,t.data=new Array(this.columns);for(let r of this.data)t.data.push(new Float64Array(r));return t}GetColumn(t){return this.data[t]}SetColumn(t,r){this.data[t]=new Float64Array(r)}Transpose(){let t=be.Zero(this.columns,this.rows);for(let r=0;r<this.columns;r++)for(let a=0;a<this.rows;a++)t.data[r][a]=this.data[a][r];return t}Symmetrize(t=!1){let r=this.Transpose(),a=be.Clone(this);if(t)for(let i=1;i<this.columns;i++)for(let s=0;s<i;s++)a.data[s][i]=r.data[s][i];else for(let i=1;i<this.rows;i++)for(let s=0;s<i;s++)a.data[i][s]=r.data[i][s];return a}Cholesky(t=!1){if(this.rows!==this.columns)throw new Error("matrix not square");let r=this.rows,a=be.Zero(r);for(let i=0;i<r;i++){let s=0;for(let o=0;o<i;o++){let n=0;for(let l=0;l<o;l++)n+=a.data[o][l]*a.data[i][l];if(a.data[i][o]=n=(this.data[i][o]-n)/a.data[o][o],s=s+n*n,this.data[o][i]!==this.data[i][o])throw new Error("matrix not symmetrical")}if(s=this.data[i][i]-s,s<=0)throw new Error(`matrix not pos-def (${s})`);a.data[i][i]=s>0?Math.sqrt(s):0;for(let o=i+1;o<r;o++)a.data[i][o]=0}return t?a.Transpose():a}Multiply(t){let r=0,a=0,i=be.Zero(this.rows,t.columns);for(let s=0;s<this.rows;s++)for(let o=0;o<t.columns;o++){for(a=r=0;r<this.columns;r++)a+=this.data[r][s]*t.data[o][r];i.data[o][s]=a}return i}Inverse(){if(this.rows!==this.columns)throw new Error("invalid matrix");let t=be.Clone(this),r=0,a=t.rows;for(let i=1;i<a;i++)t.data[i][0]/=t.data[0][0];for(let i=1;i<a;i++){for(let s=i;s<a;s++){r=0;for(let o=0;o<i;o++)r+=t.data[o][s]*t.data[i][o];t.data[i][s]-=r}if(i!==a-1)for(let s=i+1;s<a;s++){r=0;for(let o=0;o<i;o++)r+=t.data[o][i]*t.data[s][o];t.data[s][i]=(t.data[s][i]-r)/t.data[i][i]}}for(let i=0;i<a;i++)for(let s=i;s<a;s++){let o=1;if(i!==s){o=0;for(let n=i;n<s;n++)o-=t.data[n][s]*t.data[i][n]}t.data[i][s]=o/t.data[s][s]}for(let i=0;i<a;i++)for(let s=i;s<a;s++)if(i!==s){r=0;for(let o=i;o<s;o++)r+=t.data[s][o]*(i===o?1:t.data[o][i]);t.data[s][i]=-r}for(let i=0;i<a;i++)for(let s=0;s<a;s++){r=0;for(let o=i>s?i:s;o<a;o++)r+=(s===o?1:t.data[o][s])*t.data[i][o];t.data[i][s]=r}return t}SortColumns(t=!1){let r=be.Clone(this),a=t?(i,s)=>s-i:(i,s)=>i-s;for(let i of r.data)i.sort(a);return r}Rank(t=!1){let r=be.Clone(this),a=new Int32Array(this.rows);for(let i=0;i<this.rows;i++)a[i]=i;for(let i=0;i<this.columns;i++){let s=new Int32Array(a);Zr.Sort(r.data[i],s),t&&s.reverse();for(let o=0;o<this.rows;o++)r.data[i][s[o]]=o}return r}Rank2(t=!1,r){let a=be.Zero(this.rows,this.columns),i=new Int32Array(this.rows);for(let s=0;s<this.rows;s++)i[s]=s;for(let s=0;s<this.columns;s++){let o=new Int32Array(i);Zr.Sort(this.data[s],o),t&&o.reverse();for(let n=0;n<this.rows;n++)a.data[s][o[n]]=r.data[s][n]}return a}Correl(){let t=be.Zero(this.columns,this.columns);for(let r=0;r<this.columns;r++){t.data[r][r]=1;for(let a=0;a<r;a++)t.data[a][r]=ne.Correlation(this.data[r],this.data[a])}return t.Symmetrize()}IsSymmetric(){if(this.rows!==this.columns)return!1;for(let t=0;t<this.columns;t++)for(let r=0;r<this.rows;r++)if(this.data[t][r]!==this.data[r][t])return!1;return!0}toString(t){let r="";t=t||2;for(let a=0;a<this.rows;a++){for(let i=0;i<this.columns;i++){let s=this.data[i][a];s>=0&&(r+=" "),r+=s.toFixed(t),r+=" "}r+=`
`}return r}};Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});var zr=class{constructor(e){this.order=0,this.realvalues=[],this.ivalues=[],this.vectors=[];let t=e.length;this.order=t,this.vectors=[];let r=!0;for(let a=0;r&&a<t;a++){if(e[a].length!==t)throw new Error("not square");for(let i=0;i<t;i++)e[a][i]!==e[i][a]&&(r=!1)}if(r){for(let a=0;a<t;a++)Array.isArray(e[a])?this.vectors.push(e[a].slice(0)):this.vectors.push(Array.from(e[a]));this.tred2(),this.tql2()}else{let a=[],i=[];for(let s=0;s<t;s++){Array.isArray(e[s])?a.push(e[s].slice(0)):a.push(Array.from(e[s])),this.vectors.push([]);for(let o=0;o<t;o++)this.vectors[s][o]=0;i.push(0)}this.orthes(a,i),this.hqr2(a,i)}}GetDiagonal(){let e=[];for(let t=0;t<this.order;t++){e.push([]);for(let r=0;r<this.order;r++)e[t][r]=0;e[t][t]=this.realvalues[t],this.ivalues[t]>0?e[t][t+1]=this.ivalues[t]:this.ivalues[t]<0&&(e[t][t-1]=this.ivalues[t])}return e}tred2(){let e=0,t=0,r=0,a=0,i=0,s=this.order,o=this.vectors,n=this.realvalues,l=this.ivalues;for(let h=0;h<s;h++)n[h]=o[s-1][h];for(let h=s-1;h>0;h--){r=0,a=0;for(let d=0;d<h;d++)r=r+Math.abs(n[d]);if(r===0){l[h]=n[h-1];for(let d=0;d<h;d++)n[d]=o[h-1][d],o[h][d]=0,o[d][h]=0}else{for(let d=0;d<h;d++)n[d]/=r,a+=n[d]*n[d];e=n[h-1],t=Math.sqrt(a),e>0&&(t=-t),l[h]=r*t,a=a-e*t,n[h-1]=e-t;for(let d=0;d<h;d++)l[d]=0;for(let d=0;d<h;d++){e=n[d],o[d][h]=e;let c=l[d]+o[d][d]*e;for(let u=d+1;u<=h-1;u++)c+=o[u][d]*n[u],l[u]+=o[u][d]*e;l[d]=c}e=0;for(let d=0;d<h;d++)l[d]/=a,e+=l[d]*n[d];i=e/(a+a);for(let d=0;d<h;d++)l[d]-=i*n[d];for(let d=0;d<h;d++){e=n[d],t=l[d];for(let c=d;c<=h-1;c++)o[c][d]-=e*l[c]+t*n[c];n[d]=o[h-1][d],o[h][d]=0}}n[h]=a}for(let h=0;h<s-1;h++){if(o[s-1][h]=o[h][h],o[h][h]=1,a=n[h+1],a!==0){for(let d=0;d<=h;d++)n[d]=o[d][h+1]/a;for(let d=0;d<=h;d++){t=0;for(let c=0;c<=h;c++)t+=o[c][h+1]*o[c][d];for(let c=0;c<=h;c++)o[c][d]-=t*n[c]}}for(let d=0;d<=h;d++)o[d][h+1]=0}for(let h=0;h<s;h++)n[h]=o[s-1][h],o[s-1][h]=0;o[s-1][s-1]=1,l[0]=0}tql2(){let e,t,r,a,i,s,o,n,l,h,d,c,u,m,f,p,b,w,y,g=this.order,v=this.vectors,x=this.realvalues,_=this.ivalues;for(e=1;e<g;e++)_[e-1]=_[e];for(_[g-1]=0,o=0,n=0,l=Math.pow(2,-52),t=0;t<g;t++){for(n=Math.max(n,Math.abs(x[t])+Math.abs(_[t])),s=t;s<g&&!(Math.abs(_[s])<=l*n);)s++;if(s>t)do{for(h=x[t],a=(x[t+1]-h)/(2*_[t]),d=Math.hypot(a,1),a<0&&(d=-d),x[t]=_[t]/(a+d),x[t+1]=_[t]*(a+d),c=x[t+1],u=h-x[t],e=t+2;e<g;e++)x[e]-=u;for(o=o+u,a=x[s],m=1,f=m,p=m,b=_[t+1],w=0,y=0,e=s-1;e>=t;e--)for(p=f,f=m,y=w,h=m*_[e],u=m*a,d=Math.hypot(a,_[e]),_[e+1]=w*d,w=_[e]/d,m=a/d,a=m*x[e]-w*h,x[e+1]=u+w*(m*h+w*x[e]),r=0;r<g;r++)u=v[r][e+1],v[r][e+1]=w*v[r][e]+m*u,v[r][e]=m*v[r][e]-w*u;a=-w*y*p*b*_[t]/c,_[t]=w*a,x[t]=m*a}while(Math.abs(_[t])>l*n);x[t]=x[t]+o,_[t]=0}for(e=0;e<g-1;e++){for(r=e,a=x[e],i=e+1;i<g;i++)x[i]<a&&(r=i,a=x[i]);if(r!==e)for(x[r]=x[e],x[e]=a,i=0;i<g;i++)a=v[i][e],v[i][e]=v[i][r],v[i][r]=a}}orthes(e,t){let r=this.order,a=this.vectors;this.realvalues,this.ivalues;let i=0,s=r-1,o,n,l,h,d,c,u;for(c=i+1;c<=s-1;c++){for(u=0,h=c;h<=s;h++)u=u+Math.abs(e[h][c-1]);if(u!==0){for(l=0,h=s;h>=c;h--)t[h]=e[h][c-1]/u,l+=t[h]*t[h];for(n=Math.sqrt(l),t[c]>0&&(n=-n),l=l-t[c]*n,t[c]=t[c]-n,d=c;d<r;d++){for(o=0,h=s;h>=c;h--)o+=t[h]*e[h][d];for(o=o/l,h=c;h<=s;h++)e[h][d]-=o*t[h]}for(h=0;h<=s;h++){for(o=0,d=s;d>=c;d--)o+=t[d]*e[h][d];for(o=o/l,d=c;d<=s;d++)e[h][d]-=o*t[d]}t[c]=u*t[c],e[c][c-1]=u*n}}for(h=0;h<r;h++)for(d=0;d<r;d++)a[h][d]=h===d?1:0;for(c=s-1;c>=i+1;c--)if(e[c][c-1]!==0){for(h=c+1;h<=s;h++)t[h]=e[h][c-1];for(d=c;d<=s;d++){for(n=0,h=c;h<=s;h++)n+=t[h]*a[h][d];for(n=n/t[c]/e[c][c-1],h=c;h<=s;h++)a[h][d]+=n*t[h]}}}cdiv(e,t,r,a){let i=0,s=0;return Math.abs(r)>Math.abs(a)?(i=a/r,s=r+i*a,{r:(e+i*t)/s,i:(t-i*e)/s}):(i=r/a,s=a+i*r,{r:(i*e+t)/s,i:(i*t-e)/s})}hqr2(e,t){let r=this.order,a=this.vectors,i=this.realvalues,s=this.ivalues,o=r,n=o-1,l=0,h=o-1,d=Math.pow(2,-52),c=0,u=0,m=0,f=0,p=0,b=0,w,y,g,v,x,_,C,S,R,M,A,P=0;for(_=0;_<o;_++)for((_<l||_>h)&&(i[_]=e[_][_],s[_]=0),C=Math.max(_-1,0);C<o;C++)P=P+Math.abs(e[_][C]);for(R=0;n>=l;){for(M=n;M>l&&(p=Math.abs(e[M-1][M-1])+Math.abs(e[M][M]),p===0&&(p=P),!(Math.abs(e[M][M-1])<d*p));)M--;if(M===n)e[n][n]=e[n][n]+c,i[n]=e[n][n],s[n]=0,n--,R=0;else if(M===n-1){if(y=e[n][n-1]*e[n-1][n],u=(e[n-1][n-1]-e[n][n])/2,m=u*u+y,b=Math.sqrt(Math.abs(m)),e[n][n]=e[n][n]+c,e[n-1][n-1]=e[n-1][n-1]+c,g=e[n][n],m>=0){for(u>=0?b=u+b:b=u-b,i[n-1]=g+b,i[n]=i[n-1],b!==0&&(i[n]=g-y/b),s[n-1]=0,s[n]=0,g=e[n][n-1],p=Math.abs(g)+Math.abs(b),u=g/p,m=b/p,f=Math.sqrt(u*u+m*m),u=u/f,m=m/f,C=n-1;C<o;C++)b=e[n-1][C],e[n-1][C]=m*b+u*e[n][C],e[n][C]=m*e[n][C]-u*b;for(_=0;_<=n;_++)b=e[_][n-1],e[_][n-1]=m*b+u*e[_][n],e[_][n]=m*e[_][n]-u*b;for(_=l;_<=h;_++)b=a[_][n-1],a[_][n-1]=m*b+u*a[_][n],a[_][n]=m*a[_][n]-u*b}else i[n-1]=g+u,i[n]=g+u,s[n-1]=b,s[n]=-b;n=n-2,R=0}else{if(g=e[n][n],v=0,y=0,M<n&&(v=e[n-1][n-1],y=e[n][n-1]*e[n-1][n]),R===10){for(c+=g,_=l;_<=n;_++)e[_][_]-=g;p=Math.abs(e[n][n-1])+Math.abs(e[n-1][n-2]),g=v=.75*p,y=-.4375*p*p}if(R===30&&(p=(v-g)/2,p=p*p+y,p>0)){for(p=Math.sqrt(p),v<g&&(p=-p),p=g-y/((v-g)/2+p),_=l;_<=n;_++)e[_][_]-=p;c+=p,g=v=y=.964}for(R=R+1,A=n-2;A>=M&&(b=e[A][A],f=g-b,p=v-b,u=(f*p-y)/e[A+1][A]+e[A][A+1],m=e[A+1][A+1]-b-f-p,f=e[A+2][A+1],p=Math.abs(u)+Math.abs(m)+Math.abs(f),u=u/p,m=m/p,f=f/p,!(A===M||Math.abs(e[A][A-1])*(Math.abs(m)+Math.abs(f))<d*(Math.abs(u)*(Math.abs(e[A-1][A-1])+Math.abs(b)+Math.abs(e[A+1][A+1])))));)A--;for(_=A+2;_<=n;_++)e[_][_-2]=0,_>A+2&&(e[_][_-3]=0);for(S=A;S<=n-1;S++){let B=S!==n-1;if(S!==A&&(u=e[S][S-1],m=e[S+1][S-1],f=B?e[S+2][S-1]:0,g=Math.abs(u)+Math.abs(m)+Math.abs(f),g!==0&&(u=u/g,m=m/g,f=f/g)),g===0)break;if(p=Math.sqrt(u*u+m*m+f*f),u<0&&(p=-p),p!==0){for(S!==A?e[S][S-1]=-p*g:M!==A&&(e[S][S-1]=-e[S][S-1]),u=u+p,g=u/p,v=m/p,b=f/p,m=m/u,f=f/u,C=S;C<o;C++)u=e[S][C]+m*e[S+1][C],B&&(u=u+f*e[S+2][C],e[S+2][C]=e[S+2][C]-u*b),e[S][C]=e[S][C]-u*g,e[S+1][C]=e[S+1][C]-u*v;for(_=0;_<=Math.min(n,S+3);_++)u=g*e[_][S]+v*e[_][S+1],B&&(u=u+b*e[_][S+2],e[_][S+2]=e[_][S+2]-u*f),e[_][S]=e[_][S]-u,e[_][S+1]=e[_][S+1]-u*m;for(_=l;_<=h;_++)u=g*a[_][S]+v*a[_][S+1],B&&(u=u+b*a[_][S+2],a[_][S+2]=a[_][S+2]-u*f),a[_][S]=a[_][S]-u,a[_][S+1]=a[_][S+1]-u*m}}}}if(P!==0){for(n=o-1;n>=0;n--)if(u=i[n],m=s[n],m===0)for(M=n,e[n][n]=1,_=n-1;_>=0;_--){for(y=e[_][_]-u,f=0,C=M;C<=n;C++)f=f+e[_][C]*e[C][n];if(s[_]<0)b=y,p=f;else if(M=_,s[_]===0?y!==0?e[_][n]=-f/y:e[_][n]=-f/(d*P):(g=e[_][_+1],v=e[_+1][_],m=(i[_]-u)*(i[_]-u)+s[_]*s[_],w=(g*p-b*f)/m,e[_][n]=w,Math.abs(g)>Math.abs(b)?e[_+1][n]=(-f-y*w)/g:e[_+1][n]=(-p-v*w)/b),w=Math.abs(e[_][n]),d*w*w>1)for(C=_;C<=n;C++)e[C][n]=e[C][n]/w}else if(m<0)for(M=n-1,Math.abs(e[n][n-1])>Math.abs(e[n-1][n])?(e[n-1][n-1]=m/e[n][n-1],e[n-1][n]=-(e[n][n]-u)/e[n][n-1]):(x=this.cdiv(0,-e[n-1][n],e[n-1][n-1]-u,m),e[n-1][n-1]=x.r,e[n-1][n]=x.i),e[n][n-1]=0,e[n][n]=1,_=n-2;_>=0;_--){let B,z,q,D;for(B=0,z=0,C=M;C<=n;C++)B=B+e[_][C]*e[C][n-1],z=z+e[_][C]*e[C][n];if(y=e[_][_]-u,s[_]<0)b=y,f=B,p=z;else if(M=_,s[_]===0?(x=this.cdiv(-B,-z,y,m),e[_][n-1]=x.r,e[_][n]=x.i):(g=e[_][_+1],v=e[_+1][_],q=(i[_]-u)*(i[_]-u)+s[_]*s[_]-m*m,D=(i[_]-u)*2*m,q===0&&D===0&&(q=d*P*(Math.abs(y)+Math.abs(m)+Math.abs(g)+Math.abs(v)+Math.abs(b))),x=this.cdiv(g*f-b*B+m*z,g*p-b*z-m*B,q,D),e[_][n-1]=x.r,e[_][n]=x.i,Math.abs(g)>Math.abs(b)+Math.abs(m)?(e[_+1][n-1]=(-B-y*e[_][n-1]+m*e[_][n])/g,e[_+1][n]=(-z-y*e[_][n]-m*e[_][n-1])/g):(x=this.cdiv(-f-v*e[_][n-1],-p-v*e[_][n],b,m),e[_+1][n-1]=x.r,e[_+1][n]=x.i)),w=Math.max(Math.abs(e[_][n-1]),Math.abs(e[_][n])),d*w*w>1)for(C=_;C<=n;C++)e[C][n-1]=e[C][n-1]/w,e[C][n]=e[C][n]/w}for(_=0;_<o;_++)if(_<l||_>h)for(C=_;C<o;C++)a[_][C]=e[_][C];for(C=o-1;C>=l;C--)for(_=l;_<=h;_++){for(b=0,S=l;S<=Math.min(C,h);S++)b=b+a[_][S]*e[S][C];a[_][C]=b}}}},Cl=Math.pow(2,-52),Xe=class de{constructor(){this.rows=0,this.columns=0,this._data=[]}static FromArray(t){let r=t[0].length,a=t.length,i=this.Zero(a,r);for(let s=0;s<a;s++)for(let o=0;o<r;o++)i._data[s][o]=t[s][o]||0;return i}static Zero(t,r=t){return new de().Reset(t,r)}static Identity(t){let r=this.Zero(t);for(let a=0;a<t;a++)r._data[a][a]=1;return r}static Clone(t){let r=this.Zero(t.rows,t.columns);for(let a=0;a<t.rows;a++)r._data[a]=new Float64Array(t._data[a]);return r}Reset(t,r=t){this._data=new Array(t);for(let a=0;a<t;a++)this._data[a]=new Float64Array(r);return this.rows=t,this.columns=r,this}CopyTo(t){t.rows=this.rows,t.columns=this.columns,t._data=[];for(let r=0;r<this.rows;r++)t._data[r]=new Float64Array(this._data[r]);return t}Row(t,r){return typeof r<"u"&&(this._data[t]=new Float64Array(r)),Array.from(this._data[t])}Column(t,r){if(typeof r<"u")for(let i=0;i<this.rows;i++)this._data[i][t]=arguments[1][i];let a=new Array(this.rows);for(let i=0;i<this.rows;i++)a[i]=this._data[i][t];return a}Transpose(){let t=de.Zero(this.columns,this.rows);for(let r=0;r<this.rows;r++)for(let a=0;a<this.columns;a++)t._data[a][r]=this._data[r][a];return t}ToArray(t=!1){let r=[];if(t)for(let a=0;a<this.columns;a++)r.push(this.Column(a));else for(let a=0;a<this.rows;a++)r.push(this.Row(a));return r}EigenSystem(){return new zr(this._data)}IsPosDef(){return new zr(this._data).realvalues.every(t=>t>0)}MakePosDef(t=Cl){var r=new zr(this._data),a=r.realvalues.length,i=de.Zero(a),s=de.Zero(a),o,n,l=0,h=de.Zero(a);for(r.vectors.forEach((u,m)=>h.Row(m,u)),o=0;o<a;o++){for(n=0;n<a;n++)i._data[o][n]=t;r.realvalues[o]>t&&(i._data[o][o]=r.realvalues[o])}for(o=0;o<a;o++){for(l=0,n=0;n<a;n++)s._data[o][n]=0,l+=r.vectors[o][n]*r.vectors[o][n]*i._data[n][n];s._data[o][o]=Math.sqrt(1/l)}for(o=0;o<a;o++)i._data[o][o]=Math.sqrt(i._data[o][o]);var d=s.Multiply(h.Multiply(i)),c=d.Multiply(d.Transpose()).Symmetrize();for(let u=0;u<c.rows;u++)c._data[u][u]=1;return c}Symmetrize(t=!1){var r=this.Transpose(),a=de.Clone(this),i,s;if(t)for(i=1;i<this.rows;i++)for(s=0;s<i;s++)a._data[i][s]=r._data[i][s];else for(s=1;s<this.columns;s++)for(i=0;i<s;i++)a._data[i][s]=r._data[i][s];return a}Cholesky(t=!1){if(this.rows!==this.columns)throw new Error("matrix not square");var r,a,i,s,o,n=this.rows,l=de.Zero(n);for(s=0;s<n;s++){for(a=0,o=0;o<s;o++){for(r=0,i=0;i<o;i++)r+=l._data[i][o]*l._data[i][s];if(l._data[o][s]=r=(this._data[o][s]-r)/l._data[o][o],a=a+r*r,this._data[o][s]!=this._data[s][o])throw new Error("matrix not symmetrical")}if(a=this._data[s][s]-a,a<=0)throw new Error("matrix not pos-def");for(l._data[s][s]=a>0?Math.sqrt(a):0,o=s+1;o<n;o++)l._data[o][s]=0}return t?l.Transpose():l}Multiply(t){var r,a,i,s,o=de.Zero(this.rows,t.columns);for(r=0;r<this.rows;r++)for(a=0;a<t.columns;a++){for(s=i=0;i<this.columns;i++)s+=this._data[r][i]*t._data[i][a];o._data[r][a]=s}return o}Inverse(){if(this.rows!==this.columns)throw new Error("invalid matrix");let t=de.Clone(this);var r,a,i,s,o=t.rows;for(a=1;a<o;a++)t._data[0][a]/=t._data[0][0];for(a=1;a<o;a++){for(i=a;i<o;i++){for(r=0,s=0;s<a;s++)r+=t._data[i][s]*t._data[s][a];t._data[i][a]-=r}if(a!=o-1)for(i=a+1;i<o;i++){for(r=0,s=0;s<a;s++)r+=t._data[a][s]*t._data[s][i];t._data[a][i]=(t._data[a][i]-r)/t._data[a][a]}}for(a=0;a<o;a++)for(i=a;i<o;i++){var n=1;if(a!=i)for(n=0,s=a;s<i;s++)n-=t._data[i][s]*t._data[s][a];t._data[i][a]=n/t._data[i][i]}for(a=0;a<o;a++)for(i=a;i<o;i++)if(a!=i){for(r=0,s=a;s<i;s++)r+=t._data[s][i]*(a==s?1:t._data[a][s]);t._data[a][i]=-r}for(a=0;a<o;a++)for(i=0;i<o;i++){for(r=0,s=a>i?a:i;s<o;s++)r+=(i==s?1:t._data[i][s])*t._data[s][a];t._data[i][a]=r}return t}SortColumns(t=!1){var r=de.Clone(this),a=t?(i,s)=>s-i:(i,s)=>i-s;for(let i=0;i<this.columns;i++)r.Column(i,this.Column(i).sort(a));return r}Rank(t=!1){for(var r=de.Clone(this),a,i=new Array(this.rows),s=new Array(this.rows),o=0;o<this.columns;o++){for(a=0;a<this.rows;a++)s[a]=a,i[a]=this._data[a][o];for(Zr.Sort(i,s),t&&s.reverse(),a=0;a<this.rows;a++)r._data[s[a]][o]=a}return r}Correl(){for(var t=new Array(this.columns),r=0;r<this.columns;r++)t[r]=this.Column(r);for(var a=de.Zero(this.columns),i=0;i<this.columns;i++){a._data[i][i]=1;for(var s=0;s<i;s++)a._data[i][s]=ne.Correlation(t[i],t[s])}return a.Symmetrize()}IsSymmetric(){if(this.rows!=this.columns)return!1;for(var t=0;t<this.rows;t++)for(var r=0;r<this.columns;r++)if(this._data[t][r]!==this._data[r][t])return!1;return!0}};Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)});var kl=.08333333333333333,Sl=-.002777777777777778,Ml=.0007936507936507937,Al=-.0005952380952380953,Rl=[0,.08106146679532726,.04134069595540929,.02767792568499834,.02079067210376509,.01664469118982119,.01387612882307075,.01189670994589177,.01041126526197209,.009255462182712733,.00833056343336287,.007573675487951841,.00694284010720953,.006408994188004207,.005951370112758848,.005554733551962801,.00520765591960964,.004901395948434738,.004629153749334029,.004385560249232324,.004166319691996922,.00396795421864086,.00378761806844443,.00362296022468309,.00347202138297877,.00333315563672809,.00320497022805504,.00308627868260878,.00297606398355041,.00287344936235247,.00277767492975269],jt=e=>{let t,r;return e>30?(t=1/e,r=t*t,t*(kl+r*(Sl+r*(Ml+r*Al)))):Rl[e]},ti=-1,ri=-1,Le=0,Ee=0,Tr=0,Ve=0,ai=-1,ii=-1,si=0,fe=0,Jt=0,Ct=0,Dr=0,je=0,Wt=0,kt=0,Zt=0,Kt=0,Xt=0,Je=0,nt=0,Qt=0,Yt=0,oi=0,ni=0,zl=.3333333333333333,Tl=.625,Dl=.16666666666666666,Ll=20,El=(e,t)=>{let r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0,c=0,u=0,m=0;if(e!=ti||t!=ai){if(ti=e,ai=t,Le=Math.min(t,1-t),Ve=1-Le,Ee=e*Le,Ee<=0)return-1;l=Ee+Le,fe=Math.floor(l),Ee<10?(Tr=Math.exp(e*Math.log(Ve)),r=Math.floor(Ee+10*Math.sqrt(Ee*Ve)),si=Math.min(e,r)):(Dr=(e+1)*(Ct=Le/Ve),je=Ee*Ve,a=Math.floor(2.195*Math.sqrt(je)-4.6*Ve),Wt=fe+.5,kt=fe-a,Zt=fe+a+1,n=(l-kt)/(l-kt*Le),Kt=n*(1+.5*n),n=(Zt-l)/(Zt*Ve),Xt=n*(1+.5*n),Je=.134+20.5/(15.3+fe),nt=a+.5,Qt=nt*(1+Je+Je),Yt=Qt+Je/Kt,oi=Yt+Je/Xt)}if(Ee<=0)return-1;if(Ee<10){let f;for(i=0,f=Tr,h=te.Next();h>f;)++i,i>si?(h=te.Next(),i=0,f=Tr):(h-=f,f=(e-i+1)*Le*f/(i*Ve));return t>.5?e-i:i}for(;;){if(d=te.Next(),(h=te.Next()*oi)<=nt)return i=Math.floor(Wt-h+nt*d),t>.5?e-i:i;if(h<=Qt){if(c=kt+(h-nt)/Je,(d=d*Je+1-Math.abs(Wt-c)/nt)>=1)continue;i=Math.floor(c)}else if(h<=Yt){if((c=kt+Math.log(d)/Kt)<0)continue;i=Math.floor(c),d*=(h-Qt)*Kt}else{if((i=Math.floor(Zt-Math.log(d)/Xt))>e)continue;d*=(h-Yt)*Xt}if((s=Math.abs(i-fe))<=Ll||s+s+2>=je){if(n=1,fe<i)for(a=fe;a<i&&!((n*=Dr/++a-Ct)<d););else for(a=i;a<fe&&!((d*=Dr/++a-Ct)>n););if(d<=n)break}else if(d=Math.log(d),u=-s*s/(je+je),m=s/je*((s*(s*zl+Tl)+Dl)/je+.5),d<=u-m||d<=u+m&&((e!=ri||Le!=ii)&&(ri=e,ii=Le,Jt=e-fe+1,ni=Wt*Math.log((fe+1)/(Ct*Jt))+jt(fe+1)+jt(Jt)),o=e-i+1,d<=ni+(e+1)*Math.log(Jt/o)+(i+.5)*Math.log(o*Ct/(i+1))-jt(i+1)-jt(o)))break}return t>.5?e-i:i},li=-1,hi=-1,We=0,er=0,di=0,Lr=0,Ce=0,se=0,tr=0,Oe=0,St=0,Fl=.0416666664,Nl=.0208333723,Pl=.0079849875,Ul=.0015746717,Il=-.0003349403,Vl=.0003340332,Ol=.0006053049,Hl=-.0004701849,Gl=171032e-9,ci=.333333333,ui=-.249999949,mi=.199999867,fi=-.166677482,pi=.142873973,bi=-.124385581,gi=.11036831,_i=-.112750886,vi=.104089866,$l=1,Bl=.499999994,ql=.166666848,jl=.041664508,Jl=.008345522,Wl=.001353826,Zl=247453e-9,gs=(e,t)=>{let r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0,c=0,u=0,m=0;if(e<=0||t<=0)return-1;if(e<1){for(We=1+.36788794412*e;;)if(a=We*te.Next(),a<=1){if(r=Math.exp(Math.log(a)/e),Math.log(te.Next())<=-r)return r/t}else if(r=-Math.log((We-a)/e),Math.log(te.Next())<=(e-1)*Math.log(r))return r/t}else{e!=li&&(li=e,Oe=e-.5,se=Math.sqrt(Oe),di=5.656854249-12*se);do c=2*te.Next()-1,u=2*te.Next()-1,m=c*c+u*u;while(m>1);if(s=c*Math.sqrt(-2*Math.log(m)/m),d=se+.5*s,r=d*d,s>=0||(n=te.Next(),di*n<=s*s*s)||(e!=hi&&(hi=e,Ce=1/e,St=((((((((Gl*Ce+Hl)*Ce+Ol)*Ce+Vl)*Ce+Il)*Ce+Ul)*Ce+Pl)*Ce+Nl)*Ce+Fl)*Ce,e>3.686?e>13.022?(We=1.77,tr=.75,er=.1515/se):(We=1.654+.0076*Oe,tr=1.68/se+.275,er=.062/se+.024):(We=.463+se-.178*Oe,tr=1.235,er=.195/se-.079+.016*se)),d>0&&(l=s/(se+se),Math.abs(l)>.25?i=St-se*s+.25*s*s+(Oe+Oe)*Math.log(1+l):i=St+.5*s*s*((((((((vi*l+_i)*l+gi)*l+bi)*l+pi)*l+fi)*l+mi)*l+ui)*l+ci)*l,Math.log(1-n)<=i)))return r/t;for(;;){do Lr=-Math.log(te.Next()),n=te.Next(),n=n+n-1,o=n>0?1:-1,s=We+Lr*tr*o;while(s<=-.71874483771719);if(l=s/(se+se),Math.abs(l)>.25?i=St-se*s+.25*s*s+(Oe+Oe)*Math.log(1+l):i=St+.5*s*s*((((((((vi*l+_i)*l+gi)*l+bi)*l+pi)*l+fi)*l+mi)*l+ui)*l+ci)*l,!(i<=0)&&(i>.5?h=Math.exp(i)-1:h=((((((Zl*i+Wl)*i+Jl)*i+jl)*i+ql)*i+Bl)*i+$l)*i,er*n*o<=h*Math.exp(Lr-.5*s*s)))return d=se+.5*s,d*d/t}}},Er=-1,yi=2e9,wi=[0,0,0],Kl=[76.18009172947146,-86.50532032941678,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18],xi=e=>{let t,r=e-1,a=r+5.5;a-=(r+.5)*Math.log(a);let i=1.000000000190015;for(t=0;t<=5;t++)r+=1,i+=Kl[t]/r;return-a+Math.log(2.5066282746310007*i)},Xl=()=>{let e,t,r;do t=2*te.Next()-1,r=2*te.Next()-1,e=t*t+r*r;while(e>1);let a=Math.sqrt(-2*Math.log(e)/e);return r*a},_s=e=>{let t,r,a,[i,s,o]=wi,n=Er;if(e==-1)return 0;if(e<12){e!=n&&(Er=e,o=Math.exp(-e)),t=-1,r=1;do t+=1,r*=te.Next();while(r>o)}else if(e<yi){e!=n&&(Er=e,i=Math.sqrt(2*e),s=Math.log(e),o=e*s-xi(e+1));do{do a=Math.tan(Math.PI*te.Next()),t=i*a+e;while(t<0);t=Math.floor(t),r=.9*(1+a*a)*Math.exp(t*s-xi(t+1)-o)}while(te.Next()>r)}else t=e+Math.sqrt(e)*Xl(),Math.floor(t)<0&&(t=Math.floor(e)>=0?e:yi);return wi=[i,s,o],Math.floor(t)},Ql=(e,t)=>t===1?0:_s(gs(e,t/(1-t))),T=class Se{static SetRNG(t){this.rng=t}static Binomial(t,r){let a=[];for(let i=0;i<t;i++)a.push(El(r.n,r.p));return a}static NegativeBinomial(t,r){let a=[];for(let i=0;i<t;i++)a.push(Ql(r.n,r.p));return a}static Poisson(t,r){let a=[];for(let i=0;i<t;i++)a.push(_s(r.m));return a}static Gamma(t,r){let a=[];for(let i=0;i<t;i++)a.push(gs(r.a,r.lambda));return a}static Normal(t,r={}){let a=Object.assign({mean:0,sd:1,lhs:!1,ordered:!1},r);return(a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered)).map(i=>this.InverseNormal2(i)*a.sd+a.mean)}static ReverseInverseNormal2(t,r=40){let a=[0,Math.min(1,Math.max(0,.5+t*.125)),1],i=a.map(s=>this.InverseNormal2(s));for(let s=0;s<r;s++){if(Math.abs(i[1]-t)<=1e-6)return a[1];i[1]<t?(a=[a[1],(a[1]+a[2])/2,a[2]],i=[i[1],this.InverseNormal2(a[1]),i[2]]):(a=[a[0],(a[0]+a[1])/2,a[1]],i=[i[0],this.InverseNormal2(a[1]),i[1]])}return a[1]}static TruncatedNormal(t,r={}){let a=Object.assign({mean:0,sd:1,lhs:!1,ordered:!1},r),i=a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered),s=0,o=1;typeof a.min=="number"&&(s=this.ReverseInverseNormal2((a.min-a.mean)/a.sd,a.max_iterations)),typeof a.max=="number"&&(o=this.ReverseInverseNormal2((a.max-a.mean)/a.sd,a.max_iterations));let n=o-s;return i=i.map(l=>l*n+s),i.map(l=>this.InverseNormal2(l)*a.sd+a.mean)}static LogNormal(t,r={}){let a=Object.assign({mean:1,sd:1,lhs:!1,ordered:!1},r),i=a.lhs?this.LHSFieldDouble(t,a.ordered):this.UniformField(t,a.ordered);for(let s=0;s<i.length;s++)i[s]=Math.exp(this.InverseNormal2(i[s])*a.sd+a.mean);return i}static LogNormalReturn(t,r={}){let a=Object.assign({mean:1,sd:1,lhs:!1,ordered:!1},r),i=a.lhs?this.LHSFieldDouble(t,a.ordered):this.UniformField(t,a.ordered);a.mean+=1;let s=a.mean*a.mean,o=a.sd*a.sd,n=Math.log(s/Math.sqrt(s+o)),l=Math.sqrt(Math.log((s+o)/s));for(let h=0;h<t;h++)i[h]=Math.exp(this.InverseNormal2(i[h])*l+n)-1;return i}static Triangular(t,r={}){let a=Object.assign({a:0,b:1,c:.5,lhs:!1,ordered:!1,field:null},r);return(a.field||(a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered))).map(i=>this.InverseTriangular(i,a.a,a.b,a.c))}static PERT(t,r={}){let a=Object.assign({field:null,lhs:!1,a:0,b:1,c:.5,lambda:4,ordered:!1},r),i=a.field||(a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered));return this.InversePERTField(i,a.a,a.b,a.c,a.lambda)}static Uniform(t,r={}){let a=Object.assign({lhs:!1,min:0,max:1,ordered:!1},r),i=a.lhs?this.LHSFieldDouble(t,a.ordered):this.UniformField(t,a.ordered),s=a.max-a.min;for(let o=0;o<i.length;o++)i[o]=i[o]*s+a.min;return i}static Bernoulli(t,r={}){let a=Object.assign({lhs:!1,p:.5},r);return this.Uniform(t,{lhs:a.lhs,min:0,max:1}).map(i=>i<=a.p)}static Beta(t,r={}){let a=Object.assign({lhs:!1,a:0,b:1,ordered:!1},r);return(a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered)).map(i=>this.InverseBeta(i,a.a,a.b))}static Weibull(t,r={}){let a=Object.assign({lhs:!1,a:1,b:1,ordered:!1},r);return(a.lhs?this.LHSField(t,a.ordered):this.UniformField(t,a.ordered)).map(i=>this.InverseWeibull(i,a.a,a.b))}static Discretize(t,r){let a=t.slice(0);r=r||Math.round;for(let i=0;i<a.length;i++)a[i]=r(a[i]);return a}static Constant(t,r){let a=new Array(t);for(let i=0;i<t;i++)a[i]=r;return a}static Fixed(t,r={}){r=Object.assign({value:0},r);let a=new Array(t);for(let i=0;i<t;i++)a[i]=r.value;return a}static Conditional(t,r,a,i,s=0,o){let n=o||this.Bernoulli(t,{lhs:!0,p:r}),l=Math.ceil(t*r),h=a(l,i),d=new Array(t);for(let c=0,u=0;c<t;c++)d[c]=n[c]?h[u++]:s;return d}static Correlate(t,r,a=!1){var i,s=r.length,o=r[0].length,n=[];let l=Xe.Zero(o,s);for(i=0;i<s;i++)l.Column(i,this.VDWField(o));let h=l.Multiply(t.Cholesky(!0).Multiply(l.Correl().Cholesky(!0).Inverse()).Transpose()).Rank();return a?n=r.map((d,c)=>{let u=new Array(d.length),m=h.Column(c);for(i=0;i<m.length;i++)u[i]=d[m[i]];return u}):n=r.map((d,c)=>{let u=d.slice(0).sort((p,b)=>p-b),m=new Array(d.length),f=h.Column(c);for(i=0;i<f.length;i++)m[i]=u[f[i]];return m}),n}static CorrelateCDM(t,r,a=!1){var i,s=r.length,o=r[0].length;let n=Kr.Zero(o,s);for(i=0;i<s;i++)n.SetColumn(i,this.VDWField(o));let l=new Kr;if(l.rows=o,l.columns=s,l.data=r.map(h=>new Float64Array(h)),!a)throw new Error("E_NOTIMPL: correlateCDM !ordered");return n.Multiply(t.Cholesky(!0).Multiply(n.Correl().Cholesky(!0).Inverse()).Transpose()).Rank2(!1,l).data}static P80Pert(t,r,a,i){let s=this.PERTParameters(t,r,a,i),o=(s.max-s.min)/(this.InverseBeta(.9,s.v,s.w)-this.InverseBeta(.1,s.v,s.w)),n=s.min-this.InverseBeta(.1,s.v,s.w)*o,l=s.max+(1-this.InverseBeta(.9,s.v,s.w))*o;return{a:n/s.scale,b:l/s.scale,c:a}}static PERTPercentileParameters(t,r,a,i){if(t.value>=a||r.value<=a||t.value>=r.value||t.percentile>=r.percentile)throw new Error("invalid parameters");let s=this.PERTParameters(t.value,r.value,a,i),o=(s.max-s.min)/(this.InverseBeta(r.percentile,s.v,s.w)-this.InverseBeta(t.percentile,s.v,s.w)),n=s.min-this.InverseBeta(t.percentile,s.v,s.w)*o,l=s.max+(1-this.InverseBeta(r.percentile,s.v,s.w))*o;return{a:n/s.scale,b:l/s.scale,c:a}}static TriangularParameterTest(t,r,a=.1,i=1){let s=i*Math.pow(r-t,2)/(r-1),o=(-s+Math.sqrt(s*(s+4)))/2,n=(-s-Math.sqrt(s*(s+4)))/2;if(o<0&&n<0)throw new Error("double roots");let l=o<0?o:n,h=l*l/((r-l)*(1-l))-a;return{a:l,error:h,negative:h<0}}static TriangularPercentileParameters(t,r,a){if(t.value>=a||r.value<=a||t.value>=r.value||t.percentile>=r.percentile)throw new Error("invalid parameters");let i=t.value,s=r.value,o=t.value;i=0,a-=o,s-=o;let n=a;a=1,i/=n,s/=n;let l=t.percentile/(1-r.percentile),h=64,d=1e-8,c=s*1.5,u=this.TriangularParameterTest(s,c,t.percentile,l),m=u.error<0?c-s:(s-c)/2;for(let f=0;f<h;f++){c+=m;let p=this.TriangularParameterTest(s,c,t.percentile,l);if(Math.abs(p.error)<d){u=p;break}p.negative!==u.negative&&(m=-m/2),u=p}return i=u.a*n+o,s=c*n+o,{a:i,b:s,c:n+o}}static P80Triangular(t,r,a){let i=0,s=1,o=(a-t)/(r-t),n=o<.5;n&&(o=1-o);let l=-.1596122+2.1266864*o-2.1742909*o*o+1.1087738*o*o*o;n&&(l=1-l);let h=.6890868-.4434898*o+.35757*o*o,d=(r-t)/h;return i=a-l*d,s=i+d,{a:i,b:s,c:a}}static BetaDensity(t,r,a){if(typeof t!="number"){let i=new Array(t.length);for(let s=0;s<t.length;s++)t[s]<=0||t[s]>=1?i[s]=0:i[s]=Math.exp((r-1)*Math.log(t[s])+(a-1)*Math.log(1-t[s])-this.LnGamma(r)-this.LnGamma(a)+this.LnGamma(r+a));return i}return t<=0||t>=1?0:Math.exp((r-1)*Math.log(t)+(a-1)*Math.log(1-t)-this.LnGamma(r)-this.LnGamma(a)+this.LnGamma(r+a))}static PERTDensity(t,r,a,i,s=4){var o,n,l=(r+a+s*i)/(s+2);return i===l?o=s/2+1:o=(l-r)*(2*i-r-a)/((i-l)*(a-r)),n=o*(a-l)/(l-r),this.BetaDensity(t,o,n)}static NormalDensity(t){if(typeof t!="number"){let r=new Array(t.length);for(let a=0;a<t.length;a++)r[a]=.398942280401433*Math.exp(-t[a]*t[a]/2);return r}else return .398942280401433*Math.exp(-t*t/2)}static Shuffle(t){var r=t.length,a,i,s;for(i=r-1;i>=0;i--)a=Math.floor(this.rng.Next()*(i+1)),s=t[i],t[i]=t[a],t[a]=s;return t}static VDWField(t){if(this.vdw_cache.length!==t){this.vdw_cache=new Float64Array(t);for(var r=0;r<t;r++)this.vdw_cache[r]=this.InverseNormal2((r+1)/(t+1))}let a=new Float64Array(this.vdw_cache);return this.Shuffle(a)}static LHSFieldDouble(t,r=!1){for(var a=1/t,i=new Float64Array(t),s=0;s<t;s++)i[s]=this.rng.Next()*a+s*a;return r||this.Shuffle(i),i}static LHSField(t,r=!1){for(var a=1/t,i=new Array(t),s=0;s<t;s++)i[s]=this.rng.Next()*a+s*a;return r||this.Shuffle(i),i}static UniformField(t,r=!1){for(var a=new Array(t),i=0;i<t;i++)a[i]=this.rng.Next();return r&&a.sort((s,o)=>s-o),a}static InverseTriangular(t,r,a,i){return r===a?r:t<=(i-r)/(a-r)?r+Math.sqrt((a-r)*(i-r)*t):a-Math.sqrt((a-r)*(a-i)*(1-t))}static InverseNormal(t){if(t===.5)return 0;var r,a,i;return r=t<1&&t>.5?1-t:t,a=Math.sqrt(Math.log(1/Math.pow(r,2))),i=a-(2.515517+.802853*a+.010328*Math.pow(a,2))/(1+1.432788*a+.189269*Math.pow(a,2)+.001308*Math.pow(a,3)),t>.5?i:-i}static InverseNormal2(t){var r,a,i=t-.5;return Math.abs(i)<=.425?(a=.180625-i*i,i*(((((((2509.0809287301227*a+33430.57558358813)*a+67265.7709270087)*a+45921.95393154987)*a+13731.69376550946)*a+1971.5909503065513)*a+133.14166789178438)*a+3.3871328727963665)/(((((((5226.495278852854*a+28729.085735721943)*a+39307.89580009271)*a+21213.794301586597)*a+5394.196021424751)*a+687.1870074920579)*a+42.31333070160091)*a+1)):(a=i<0?t:1-t,a<=0?0:(a=Math.sqrt(-Math.log(a)),a<=5?(a=a-1.6,r=(((((((.0007745450142783414*a+.022723844989269184)*a+.2417807251774506)*a+1.2704582524523684)*a+3.6478483247632045)*a+5.769497221460691)*a+4.630337846156546)*a+1.4234371107496835)/(((((((10507500716444169e-25*a+.0005475938084995345)*a+.015198666563616457)*a+.14810397642748008)*a+.6897673349851)*a+1.6763848301838038)*a+2.053191626637759)*a+1)):(a=a-5,r=(((((((20103343992922881e-23*a+27115555687434876e-21)*a+.0012426609473880784)*a+.026532189526576124)*a+.29656057182850487)*a+1.7848265399172913)*a+5.463784911164114)*a+6.657904643501103)/(((((((20442631033899397e-31*a+1421511758316446e-22)*a+18463183175100548e-21)*a+.0007868691311456133)*a+.014875361290850615)*a+.1369298809227358)*a+.599832206555888)*a+1)),i<0?-r:r))}static Log1p(t){let r=1+t;return Math.log(r)-(r-1-t)/r}static BetaContFrac(t,r,a,i){var s=512,o=2*Number.MIN_VALUE,n=0,l,h=1,d=1-(t+r)*a/(t+1);for(Math.abs(d)<o&&(d=Se.QUIET_NAN),d=1/d,l=d;n<s;){var c=n+1,u=c*(r-c)*a/((t-1+2*c)*(t+2*c)),m;if(d=1+u*d,h=1+u/h,Math.abs(d)<o&&(d=Se.QUIET_NAN),Math.abs(h)<o&&(h=Se.QUIET_NAN),d=1/d,m=d*h,l*=m,u=-(t+c)*(t+r+c)*a/((t+2*c)*(t+2*c+1)),d=1+u*d,h=1+u/h,Math.abs(d)<o&&(d=Se.QUIET_NAN),Math.abs(h)<o&&(h=Se.QUIET_NAN),d=1/d,m=d*h,l*=m,Math.abs(m-1)<2*Se.EPSILON_DOUBLE||l*Math.abs(m-1)<i)break;++n}return n>=s?Se.QUIET_NAN:l}static BetaCDF(t,r,a){if(t<=0)return 0;if(t>=1)return 1;var i=1,s=0;if(t===0)return i*0+s;if(t===1)return i*1+s;var o,n,l,h=this.LnGamma(r)+this.LnGamma(a)-this.LnGamma(r+a),d=-h+r*Math.log(t)+a*this.Log1p(-t),c=Math.exp(d);return t<(r+1)/(r+a+2)?(o=Math.abs(s/(i*c/r))*Se.EPSILON_DOUBLE,n=this.BetaContFrac(r,a,t,o),i*(c*n/r)+s):(o=Math.abs((i+s)/(i*c/a))*Se.EPSILON_DOUBLE,n=this.BetaContFrac(a,r,1-t,o),l=c*n/a,i*(1-l)+s)}static LnGamma(t){var r=t-1,a=r+5.5;a-=(r+.5)*Math.log(a);var i=1;return r+=1,i+=76.18009173/r,r+=1,i+=-86.50532033/r,r+=1,i+=24.01409822/r,r+=1,i+=-1.231739516/r,r+=1,i+=.00120858003/r,r+=1,i+=-536382e-11/r,-a+Math.log(2.50662827465*i)}static BetaPDF(t,r,a){return t<0||t>1?0:Math.exp(this.LnGamma(r+a)-this.LnGamma(r)-this.LnGamma(a))*Math.pow(t,r-1)*Math.pow(1-t,a-1)}static InverseWeibull(t,r,a){return r*Math.pow(-Math.log(1-t),1/a)}static InverseBeta(t,r,a){var i,s,o,n,l,h=0,d,c,u;if(t<0||t>1||r<0||a<0||t===0)return 0;if(t===1)return 1;if(t>.5){var m=1-t;return m>.5?this.InverseBeta(1-m,r,a):1-this.InverseBeta(m,a,r)}if(s=r/(r+a),t<.1){var f=(Math.log(r)+this.LnGamma(r)+this.LnGamma(a)-this.LnGamma(r+a)+Math.log(t))/r;f<=0?(i=Math.exp(f),i*=Math.pow(1-i,-(a-1)/r)):i=s,i>s&&(i=s)}else i=s;do{if(n=t-this.BetaCDF(i,r,a),l=this.BetaPDF(i,r,a),n===0||h++>64)return i;o=n/Math.max(2*Math.abs(n/i),l),c=o,u=-((r-1)/i-(a-1)/(1-i))*o*o/2,d=c,Math.abs(u)<Math.abs(c)?d+=u:d*=2*Math.abs(c/u),i+d>0&&i+d<1?i+=d:i=Math.sqrt(i)*Math.sqrt(s)}while(Math.abs(c)>1e-10*i);return i}static InversePERTField(t,r,a,i,s){if(a<=r)return t.map(()=>r);try{let o=this.PERTParameters(r,a,i,s);return t.map(n=>(this.InverseBeta(n,o.v,o.w)*(o.max-o.min)+o.min)/o.scale)}catch{return r===a?t.map(o=>r):t.map(o=>0)}}static PERTParameters(t,r,a,i=4){if(t>=r||i<0||a<t||a>r)throw new Error("Invalid parameters");for(var s,o,n,l=1,h,d;Math.abs(t)<1&&Math.abs(r)<1;)l*=10,t*=10,r*=10,a*=10;s=(t+r+i*a)/(i+2);var c;return a===0?c=Math.abs(s-a):c=Math.abs((s-a)/a),c<=1e-12?o=i/2+1:(h=(s-t)*(2*a-t-r),d=(a-s)*(r-t),o=h/d),h=o*(r-s),d=s-t,n=h/d,{v:o,w:n,min:t,max:r,scale:l}}static InversePERT(t,r,a,i,s=4){let o=this.PERTParameters(r,a,i,s);return(this.InverseBeta(t,o.v,o.w)*(o.max-o.min)+o.min)/o.scale}};T.rng=te;T.EPSILON_DOUBLE=2220446049250313e-31;T.QUIET_NAN=Number.NaN;T.M_LN_SQRT_2PI=.9189385332046728;T.M_1_SQRT_2PI=.3989422804014327;T.vdw_cache=new Float64Array(0);var Yl=new Array(256);for(let e=0;e<256;++e)Yl[e]=(e+256).toString(16).substr(1);var Ye=(e,t)=>{let r=[];for(let a=0;a<e;a++){let i=[];for(let s=0;s<t;s++)i.push(0);r.push(i)}return{m:e,n:t,data:r}},Ci=e=>{let t=Ye(e,e);for(let r=0;r<e;r++)t.data[r][r]=1;return t},eh=e=>(e=JSON.parse(JSON.stringify(e)),{m:e.length,n:e[0].length,data:e}),Xr=e=>{let t=[];for(let r=0;r<e.n;r++){let a=[];for(let i=0;i<e.m;i++)a.push(e.data[i][r]);t.push(a)}return{m:e.n,n:e.m,data:t}},Qr=(e,t)=>{if(e.n!==t.m)throw new Error("invalid multiply");let r=Ye(e.m,t.n);for(let a=0;a<e.m;a++)for(let i=0;i<t.n;i++){let s=0;for(let o=0;o<t.m;o++)s+=e.data[a][o]*t.data[o][i];r.data[a][i]=s}return r},th=class{constructor(e=Ye(2,2),t=Ye(1,1),r=Ye(1,1)){this.j_matrix=e,this.q_matrix=t,this.r_matrix=r}Inverse(e){if(e.n!==e.m)throw new Error("matrix must be square");let t=Ci(e.m);return this.Decompose(e),this.Solve(t)}Solve(e){let t=Qr(Xr(this.q_matrix),e),r=this.r_matrix.n,a=Ye(1,r);for(let i=r-1;i>=0;i--){a.data[0][i]=t.data[i][0];for(let s=i+1;s<r;s++)a.data[0][i]=a.data[0][i]-a.data[0][s]*this.r_matrix.data[i][s];a.data[0][i]=a.data[0][i]/this.r_matrix.data[i][i]}return a}Decompose(e){let t=e.m,r=e.n;t==r?r--:t<r&&(r=t-1),this.q_matrix=Ci(t),this.r_matrix=e;for(let a=0;a<r;a++)for(let i=a+1;i<t;i++)this.GivensRotation(this.r_matrix.data[a][a],this.r_matrix.data[i][a]),this.PreMultiplyGivens(this.r_matrix,a,i),this.PreMultiplyGivens(this.q_matrix,a,i);this.q_matrix=Xr(this.q_matrix)}GivensRotation(e,t){let r=0,a=0,i=0;t===0?(i=e>=0?1:-1,a=0):e===0?(i=0,a=t>=0?-1:1):Math.abs(t)>Math.abs(e)?(r=e/t,a=-1/Math.sqrt(1+r*r),i=-a*r):(r=t/e,i=1/Math.sqrt(1+r*r),a=-i*r),this.j_matrix.data[0][0]=i,this.j_matrix.data[0][1]=-a,this.j_matrix.data[1][0]=a,this.j_matrix.data[1][1]=i}PreMultiplyGivens(e,t,r){for(let a=0;a<e.n;a++){let i=e.data[t][a]*this.j_matrix.data[0][0]+e.data[r][a]*this.j_matrix.data[0][1];e.data[r][a]=e.data[t][a]*this.j_matrix.data[1][0]+e.data[r][a]*this.j_matrix.data[1][1],e.data[t][a]=i}}},rh=class{eta=0;are=0;mre=0;n=0;nn=0;nmi=0;zerok=!1;p=[];qp=[];k=[];qk=[];svk=[];sr=0;si=0;u=0;v=0;a=0;b=0;c=0;d=0;a1=0;a2=0;a3=0;a6=0;a7=0;e=0;f=0;g=0;h=0;szr=0;szi=0;lzr=0;lzi=0;findRoots(e,t,r,a){let i=0,s=0,o=0,n=0,l=[],h=0,d=0,c=[],u=0,m=0,f=0,p=0,b=0,w=0,y=0,g=0,v=0,x=0,_=0,C=0,S=0,R=0,M=0,A=0,P=0,B=0,z=0,q=0,D=0,O=0,X=0,J=0,I=0,W=!1;if(B=2,this.eta=222e-18,A=34e37,P=12e-39,this.are=this.eta,this.mre=this.eta,u=P/this.eta,p=Math.sqrt(.5),b=-p,d=94,d*=.017453293,w=Math.cos(d),y=Math.sin(d),this.n=t,this.n<1||e[0]==0)return-1;for(;e[this.n]==0;)O=t-this.n,r[O]=0,a[O]=0,this.n--;if(this.n===0)return t;for(l=[],c=[],this.p=[],this.qp=[],this.k=[],this.qk=[],this.svk=[],D=0;D<=this.n;D++)this.p[D]=e[D];e:for(;;){if(this.n==1)return r[t-1]=-this.p[1]/this.p[0],a[t-1]=0,this.n-=1,t-this.n;if(this.n==2){let we={sr:r[t-2],si:a[t-2],lr:r[t-1],li:a[t-1]};return this.quad(this.p[0],this.p[1],this.p[2],we),r[t-2]=we.sr,a[t-2]=we.si,r[t-1]=we.lr,a[t-1]=we.li,this.n-=2,t-this.n}for(m=0,f=A,D=0;D<=this.n;D++)v=Math.abs(this.p[D]),v>m&&(m=v),v!=0&&v<f&&(f=v);switch(!0){case!0:if(x=u/f,x>1&&A/x<m)break;if(x<=1){if(m<10)break;x==0&&(x=P)}if(J=Math.floor(Math.log(x)/Math.log(B)+.5),h=Math.pow(B,J),h!=1)for(D=0;D<=this.n;D++)this.p[D]=h*this.p[D]}for(D=0;D<=this.n;D++)c[D]=Math.abs(this.p[D]);for(c[this.n]=-c[this.n],v=Math.exp((Math.log(-c[this.n])-Math.log(c[0]))/this.n),c[this.n-1]!=0&&(C=-c[this.n]/c[this.n-1],C<v&&(v=C));;){for(C=v*.1,S=c[0],D=1;D<=this.n;D++)S=S*C+c[D];if(S<=0)break;v=C}for(M=v;Math.abs(M/v)>.005;){for(S=c[0],R=S,D=1;D<this.n;D++)S=S*v+c[D],R=R*v+S;S=S*v+c[this.n],M=S/R,v-=M}for(_=v,I=this.n-1,D=1;D<this.n;D++)this.k[D]=(this.n-D)*this.p[D]/this.n;for(this.k[0]=this.p[0],s=this.p[this.n],o=this.p[this.n-1],W=this.k[this.n-1]===0,X=0;X<5;X++)if(n=this.k[this.n-1],W){for(D=0;D<I;D++)O=this.n-D-1,this.k[O]=this.k[O-1];this.k[0]=0,W=this.k[this.n-1]===0}else{for(i=-s/n,D=0;D<I;D++)O=this.n-D-1,this.k[O]=i*this.k[O-1]+this.p[O];this.k[0]=this.p[0],W=Math.abs(this.k[this.n-1])<=Math.abs(o)*this.eta*10}for(D=0;D<this.n;D++)l[D]=this.k[D];for(z=0;z<20;z++){g=w*p-y*b,b=y*p+w*b,p=g,this.sr=_*p,this.si=_*b,this.u=-2*this.sr,this.v=_;{let we={nz:q};this.fxshfr(20*(z+1),we),q=we.nz}if(q!=0){for(O=t-this.n,r[O]=this.szr,a[O]=this.szi,this.n-=q,D=0;D<=this.n;D++)this.p[D]=this.qp[D];q!=1&&(r[O+1]=this.lzr,a[O+1]=this.lzi);continue e}for(D=0;D<this.n;D++)this.k[D]=l[D]}return t-this.n}}quad(e,t,r,a){let i=0,s=0,o=0;if(e==0){t!=0?a.sr=-r/t:a.sr=0,a.lr=0,a.si=0,a.li=0;return}if(r==0){a.sr=0,a.lr=-t/e,a.si=0,a.li=0;return}i=t/2,Math.abs(i)<Math.abs(r)?(r<0?o=-e:o=e,o=i*(i/Math.abs(r))-o,s=Math.sqrt(Math.abs(o))*Math.sqrt(Math.abs(r))):(o=1-e/i*(r/i),s=Math.sqrt(Math.abs(o))*Math.abs(i)),o<0?(a.sr=-i/e,a.lr=a.sr,a.si=Math.abs(s/e),a.li=-a.si):(i>=0&&(s=-s),a.lr=(-i+s)/e,a.sr=0,a.lr!=0&&(a.sr=r/a.lr/e),a.si=0,a.li=0)}fxshfr(e,t){let r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0,c=0,u=0,m=0,f=0,p=0,b=0,w=0,y=0,g=0,v=0,x=0,_=0,C=!1,S=!1,R=0,M=0;t.nz=0,l=.25,n=.25,h=this.sr,d=this.v;{let A={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,A),this.u=A.u,this.v=A.v,this.a=A.a,this.b=A.b}for(g=this.calcsc_(g),x=0;x<e;x++){g=this.nextk_(g),g=this.calcsc_(g);{let A={uu:i,vv:s};this.newest(g,A),i=A.uu,s=A.vv}switch(u=s,c=0,this.k[this.n-1]!=0&&(c=-this.p[this.n]/this.k[this.n-1]),f=1,m=1,!0){case!0:{if(x==0||g==3||(u!=0&&(f=Math.abs((u-d)/u)),c!=0&&(m=Math.abs((c-h)/c)),w=1,f<b&&(w=f*b),y=1,m<p&&(y=m*p),C=w<l,S=y<n,!(S||C)))break;for(r=this.u,a=this.v,v=0;v<this.n;v++)this.svk[v]=this.k[v];o=c,R=0,M=0;let A=!1;(S&&!C||y<w)&&(A=!0);e:for(;;){if(!A){{let P={uu:i,vv:s,nz:t.nz};this.quadit(P),i=P.uu,s=P.vv,t.nz=P.nz}if(t.nz>0)return;R=1,l*=.25}switch(!0){case!0:if(!A){if(M||!S)break;for(v=0;v<this.n;v++)this.k[v]=this.svk[v]}A=!1;{let P={sss:o,nz:t.nz,iflag:_};this.realit(P),o=P.sss,t.nz=P.nz,_=P.iflag}if(t.nz>0)return;if(M=1,n*=.25,_==0)break;i=-(o+o),s=o*o;continue e}for(this.u=r,this.v=a,v=0;v<this.n;v++)this.k[v]=this.svk[v];if(C&&!R)continue e;break}{let P={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,P),this.u=P.u,this.v=P.v,this.a=P.a,this.b=P.b}g=this.calcsc_(g)}}d=u,h=c,b=f,p=m}}quadit(e){let t=0,r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0,c=0,u=0;for(e.nz=0,u=0,this.u=e.uu,this.v=e.vv,c=0;;){{let m={sr:this.szr,si:this.szi,lr:this.lzr,li:this.lzi};this.quad(1,this.u,this.v,m),this.szr=m.sr,this.szi=m.si,this.lzr=m.lr,this.lzi=m.li}if(Math.abs(Math.abs(this.szr)-Math.abs(this.lzr))>.01*Math.max(Math.abs(this.lzr),.1))return;{let m={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,m),this.u=m.u,this.v=m.v,this.a=m.a,this.b=m.b}for(a=Math.abs(this.a-this.szr*this.b)+Math.abs(this.szi*this.b),l=Math.sqrt(Math.abs(this.v)),s=2*Math.abs(this.qp[0]),n=-this.szr*this.b,d=1;d<this.n;d++)s=s*l+Math.abs(this.qp[d]);if(s=s*l+Math.abs(this.a+n),s*=5*this.mre+4*this.are,s=s-(5*this.mre+2*this.are)*(Math.abs(this.a+n)+Math.abs(this.b)*l)+2*this.are*Math.abs(n),a<=20*s){e.nz=2;return}if(c++,c>20)return;switch(!0){case!0:if(c<2||o>.01||a<i||u)break;o<this.eta&&(o=this.eta),o=Math.sqrt(o),this.u=this.u-this.u*o,this.v=this.v+this.v*o;{let m={u:this.u,v:this.v,a:this.a,b:this.b};this.quadsd_(this.n,this.p,this.qp,m),this.u=m.u,this.v=m.v,this.a=m.a,this.b=m.b}for(d=0;d<5;d++)h=this.calcsc_(h),h=this.nextk_(h);u=1,c=0}i=a,h=this.calcsc_(h),h=this.nextk_(h),h=this.calcsc_(h);{let m={uu:t,vv:r};this.newest(h,m),t=m.uu,r=m.vv}if(r==0)return;o=Math.abs((r-this.v)/r),this.u=t,this.v=r}}realit(e){let t=0,r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0;for(e.nz=0,i=e.sss,e.iflag=0,d=0;;){for(t=this.p[0],this.qp[0]=t,h=1;h<=this.n;h++)t=t*i+this.p[h],this.qp[h]=t;for(o=Math.abs(t),s=Math.abs(i),l=this.mre/(this.are+this.mre)*Math.abs(this.qp[0]),h=1;h<=this.n;h++)l=l*s+Math.abs(this.qp[h]);if(o<=20*((this.are+this.mre)*l-this.mre*o)){e.nz=1,this.szr=i,this.szi=0;return}if(d++,d>10)return;switch(!0){case!0:if(d<2||Math.abs(a)>.001*Math.abs(i-a)||o<n)break;e.iflag=1,e.sss=i;return}for(n=o,r=this.k[0],this.qk[0]=r,h=1;h<this.n;h++)r=r*i+this.k[h],this.qk[h]=r;if(Math.abs(r)<=Math.abs(this.k[this.n-1])*10*this.eta)for(this.k[0]=0,h=1;h<this.n;h++)this.k[h]=this.qk[h-1];else for(a=-t/r,this.k[0]=this.qp[0],h=1;h<this.n;h++)this.k[h]=a*this.qk[h-1]+this.qp[h];for(r=this.k[0],h=1;h<this.n;h++)r=r*i+this.k[h];a=0,Math.abs(r)>Math.abs(this.k[this.n-1]*10*this.eta)&&(a=-t/r),i+=a}}calcsc_(e){let t={u:this.u,v:this.v,a:this.c,b:this.d};switch(this.quadsd_(this.n-1,this.k,this.qk,t),this.u=t.u,this.v=t.v,this.c=t.a,this.d=t.b,!0){case!0:if(Math.abs(this.c)>Math.abs(this.k[this.n-1]*100*this.eta)||Math.abs(this.d)>Math.abs(this.k[this.n-2]*100*this.eta))break;return e=3,e}return Math.abs(this.d)<Math.abs(this.c)?(e=1,this.e=this.a/this.c,this.f=this.d/this.c,this.g=this.u*this.e,this.h=this.v*this.b,this.a3=this.a*this.e+(this.h/this.c+this.g)*this.b,this.a1=this.b-this.a*(this.d/this.c),this.a7=this.a+this.g*this.d+this.h*this.f,e):(e=2,this.e=this.a/this.d,this.f=this.c/this.d,this.g=this.u*this.b,this.h=this.v*this.b,this.a3=(this.a+this.g)*this.e+this.h*(this.b/this.d),this.a1=this.b*this.f-this.a,this.a7=(this.f+this.u)*this.a+this.h,e)}nextk_(e){let t=0,r=0;if(e===3){for(this.k[0]=0,this.k[1]=0,r=2;r<this.n;r++)this.k[r]=this.qk[r-2];return e}if(t=this.a,e===1&&(t=this.b),Math.abs(this.a1)<=Math.abs(t)*this.eta*10){for(this.k[0]=0,this.k[1]=-this.a7*this.qp[0],r=2;r<this.n;r++)this.k[r]=this.a3*this.qk[r-2]-this.a7*this.qp[r-1];return e}for(this.a7/=this.a1,this.a3/=this.a1,this.k[0]=this.qp[0],this.k[1]=this.qp[1]-this.a7*this.qp[0],r=2;r<this.n;r++)this.k[r]=this.a3*this.qk[r-2]-this.a7*this.qp[r-1]+this.qp[r];return e}newest(e,t){let r=0,a=0,i=0,s=0,o=0,n=0,l=0,h=0,d=0;if(e==3){t.uu=0,t.vv=0;return}if(e==2?(r=(this.a+this.g)*this.f+this.h,a=(this.f+this.u)*this.c+this.v*this.d):(r=this.a+this.u*this.b+this.h*this.f,a=this.c+(this.u+this.v*this.f)*this.d),i=-this.k[this.n-1]/this.p[this.n],s=-(this.k[this.n-2]+i*this.p[this.n-1])/this.p[this.n],o=this.v*s*this.a1,n=i*this.a7,l=i*i*this.a3,h=o-n-l,d=a+i*r-h,d==0){t.uu=0,t.vv=0;return}t.uu=this.u-(this.u*(l+n)+this.v*(i*this.a1+s*this.a7))/d,t.vv=this.v*(1+h/d)}quadsd_(e,t,r,a){let i=0,s=0;for(a.b=t[0],r[0]=a.b,a.a=t[1]-a.b*a.u,r[1]=a.a,s=2;s<=e;s++)i=t[s]-a.a*a.u-a.b*a.v,r[s]=i,a.b=a.a,a.a=i}},Mt=class{static Roots(e){let t=e.slice(0);for(t.reverse();t.length>0&&t[0]===0;)t.splice(0,1);let r=t.length-1,a=[],i=[],s=new rh().findRoots(t,r,a,i),o=[];for(let n=0;n<s;n++)o.push({real:a[n]||0,imaginary:i[n]||0});return o}static Apply(e,t){if(e.length===0)return 0;let r=0,a=1;for(let i=0;i<e.length;i++)r+=a*e[i],a*=t;return r}static Fit(e,t,r){if(e.length!==t.length)throw new Error("invalid data (x.length !== y.length)");if(!e.length)throw new Error("invalid data (len = 0)");e=e.map(d=>typeof d=="number"?d:0),t=t.map(d=>typeof d=="number"?d:0),r++;let a=e.length,i=eh(t.map(d=>[d])),s=Ye(a,r);for(let d=0;d<a;d++){let c=1;for(let u=0;u<r;u++)s.data[d][u]=c,c*=e[d]}let o=Xr(s),n=Qr(o,s),l=Qr(o,i),h=new th;return h.Decompose(n),h.Solve(l).data[0]}},ki=e=>{let t={},r=e.length;for(let a=0;a<r;a++){if(e[a].length!==r)return t.square=!1,t;if(Math.abs(e[a][a]-1)>1e-7)return t.unit_diagonal=!1,t}if(t.square=!0,t.unit_diagonal=!0,e.some(a=>a.some(i=>typeof i!="number"))){if(r>1&&e[0][1]!==void 0?(t.range="upper",e=Dt(e)):t.range="lower",r>1&&e[1][0]!==void 0)for(let a=0;a<r;a++)for(let i=a+1;i<r;i++){if(typeof e[a][i]<"u"&&e[a][i]!=="")return t.range=void 0,t;e[a][i]=e[i][a]}}else{t.range="full";for(let a=0;a<r;a++)for(let i=1;i<r;i++)if(e[a][i]!==e[i][a])return t;t.symmetric=!0}return t.data=e,t},He=(e,t,r)=>(e=Math.floor(e),t=Math.floor(t),r=Math.floor(r)+1,t=t+(t-e)/(r-e),[e,t,r]),lt=e=>{for(let t=0;t<e.length;t++)e[t]=Math.floor(e[t]);return e},Si=e=>{let t=T.Uniform(e),r=[];for(let a=0;a<e;a++)r[a]=a;for(let a=0;a<e;a++){let i=a+Math.floor(t[a]*(e-a)),s=r[a];r[a]=r[i],r[i]=s}return r},ah=class{constructor(e){this.model=e,this.functions={"Multivariate.Normal":{description:"Returns a sample from the multivariate normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Distribution Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.multivariate_normal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.LogNormal":{description:"Returns a sample from the multivariate log-normal distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard Deviation of underlying Normal distribution",default:1}],fn:this.multivariate_lognormal.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Uniform":{description:"Returns a sample from the multivariate uniform distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value",default:0},{name:"max",description:"Maximum Value",default:1}],fn:this.multivariate_uniform.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Beta":{description:"Returns a sample from the multivariate beta distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.multivariate_beta.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.PERT":{description:"Returns a sample from the multivariate PERT distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"},{name:"lambda",default:4}],fn:this.multivariate_pert.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"Multivariate.Triangular":{description:"Returns a sample from the multivariate triangular distribution",simulation_volatile:!0,arguments:[{name:"range of values",description:"Set of Correlated Distributions (N)",address:!0},{name:"correlation",description:"Correlation Matrix (NxN)"},{name:"min",description:"Minimum Value"},{name:"mode",description:"Most-Likely Value"},{name:"max",description:"Maximum Value"}],fn:this.multivariate_triangular.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformRangeSample:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.uniformrangesample.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SampleValue:{description:"Returns one of a set of values, with equal probability and with replacement",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"}],fn:this.samplevalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"SampleValue.Weighted":{description:"Returns one of a set of values, weighted by a second set of values",simulation_volatile:!0,arguments:[{name:"range",description:"Range of Values"},{name:"weights",description:"Range of Weights"}],fn:this.samplevalue_weighted.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BernoulliValue:{description:"Returns true or false (boolean) based on the given probability",simulation_volatile:!0,arguments:[{name:"p",description:"Probability to return True",default:.5}],fn:this.bernoullivalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},UniformValue:{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"UniformValue.Discrete":{description:"Returns a sample from the uniform distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum",default:0},{name:"max",description:"Maximum",default:1}],fn:this.uniformvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},WeibullValue:{description:"Returns a sample from the Weibull distribution",simulation_volatile:!0,arguments:[{name:"lambda",description:"Scale"},{name:"k",description:"Shape"}],fn:this.weibullvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BetaValue:{description:"Returns a sample from the beta distribution",simulation_volatile:!0,arguments:[{name:"w",description:"Shape Parameter"},{name:"v",description:"Shape Parameter"}],fn:this.betavalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},BinomialValue:{description:"Returns a sample from the binomial distribution",simulation_volatile:!0,arguments:[{name:"Probability of success",description:"Probability of success in each trial"},{name:"Trials",description:"Number of trials"}],fn:this.binomialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NegativeBinomialValue:{description:"Returns a sample from the negative-binomial distribution",simulation_volatile:!0,arguments:[{name:"Probability of success",description:"Probability of success in each trial"},{name:"Target number of trials",description:"Target number of successful trials"}],fn:this.negativebinomialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PoisssonValue:{description:"Returns a sample from the poisson distribution",simulation_volatile:!0,arguments:[{name:"m",description:"Mean"}],fn:this.poissonvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TruncatedNormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1},{name:"min",description:"Minimum Value"},{name:"max",description:"Maximum Value"}],fn:this.truncatednormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},NormalValue:{description:"Returns a sample from the normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean",default:0},{name:"stdev",description:"Standard Deviation",default:1}],fn:this.normalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},PERTValue:{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.Discrete":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},ScaledLognormalValue:{description:"Returns a sample from the log-normal distribution, scaled to the desired mean and standard deviation",simulation_volatile:!0,arguments:[{name:"mean",description:"Target mean",default:0},{name:"stdev",description:"Standard deviation",default:1}],fn:this.scaledlognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},LognormalValue:{description:"Returns a sample from the log-normal distribution",simulation_volatile:!0,arguments:[{name:"mean",description:"Mean of underlying Normal distribution",default:0},{name:"stdev",description:"Standard deviation of underlying Normal distribution",default:1}],fn:this.lognormalvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},SequentialValue:{description:"Returns one from a set of values, in order",simulation_volatile:!0,arguments:[{name:"values",description:"Data Array"},{name:"count",description:"Count",default:0}],fn:this.sequentialvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},IndexValue:{description:"Returns a monotonically increasing value",simulation_volatile:!0,arguments:[{name:"max",description:"Maximum",default:0}],fn:this.indexvalue.bind(this),category:["RiskAMP Random Distributions"],extension:!0},"PERTValue.P":{description:"Returns a sample from the beta-PERT distribution",simulation_volatile:!0,arguments:[{name:"p10",description:"10th-Percentile Value",default:0},{name:"mode",description:"Most-Likely Value",default:.5},{name:"p90",description:"90th-Percentile Value",default:1},{name:"lambda",default:4}],fn:this.pertvalue_p.bind(this),category:["RiskAMP Random Distributions"],extension:!0},TriangularValue:{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this,!1),category:["RiskAMP Random Distributions"],extension:!0},"TriangularValue.Discrete":{description:"Returns a sample from the triangular distribution",simulation_volatile:!0,arguments:[{name:"min",description:"Minimum Value",default:0},{name:"mode",description:"Most Likely Value",default:.5},{name:"max",description:"Maximum Value",default:1}],fn:this.triangularvalue.bind(this,!0),category:["RiskAMP Random Distributions"],extension:!0},SimulationCorrelationMatrix:{description:"Returns the correlation among a set of data, as a matrix",arguments:[{name:"range",description:"Range of data",collector:!0},{name:"full matrix",description:"Return the full matrix"}],fn:this.simulationcorrelationmatrix.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationCorrelation:{description:"Returns the correlation between the data from two cells in the simulation",arguments:[{name:"reference cell",description:"Cell 1",collector:!0},{name:"reference cell",description:"Cell 2",collector:!0}],fn:this.simulationcorrelation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationRSquared:{description:"Returns the r-squared value (coefficient of correlation) of the data from two cells in the simulation",arguments:[{name:"dependent",description:"Dependent Value",collector:!0},{name:"independent",description:"Indepdendent Value",collector:!0}],fn:this.simulationrsquared.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSkewness:{description:"Returns the skewness of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationskewness.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationKurtosis:{description:"Returns the kurtosis (peakedness) of data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationkurtosis.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationPercentile:{description:"Returns the value of a cell at a given percentile in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"percentile",description:"Percentile (as %)"}],fn:this.simulationpercentile.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationIntercept:{arguments:[{name:"x",collector:!0},{name:"y",collector:!0}],fn:this.simulationintercept.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationSlope:{arguments:[{name:"x",collector:!0},{name:"y",collector:!0}],fn:this.simulationslope.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationInterval:{description:"Returns the portion of results in the simulation that fall within some bounds (as a percentage)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"min",description:"Minimum Value (optional, inclusive)"},{name:"max",description:"Maximum Value (optional, inclusive)"}],fn:this.simulationinterval.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMode:{description:"Returns the mode of the data from this cell in the simulation. Use for discrete data only.",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmode.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMean:{description:"Returns the mean (average) value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationGeometricMean:{description:"Returns the geometric mean of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationgeometricmean.bind(this),extension:!0,category:["RiskAMP Simulation Functions"]},SimulationMedian:{description:"Returns the median value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmedian.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValue:{description:"Returns the value of this cell in the simulation at the given trial number",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValue.Cumulative":{description:"Returns the value of this cell in the simulation at the given trial number (cumulative)",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"iteration",description:"Trial Number"}],fn:this.simulationvalue_cumulative.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationHistogramBin:{arguments:[{name:"reference cell",collector:!0},{name:"count"},{name:"index"},{name:"round"}],fn:this.SimulationHistogramBin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationHistogramBinLabel:{arguments:[{name:"reference cell",collector:!0},{name:"count"},{name:"index"},{name:"round"}],fn:this.SimulationHistogramBinLabel.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationValuesArray:{description:"Returns all values of this cell in the simulation, as an array",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvaluesarray.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SortedSimulationIndex:{description:"Returns the iteration number of a sorted value for this cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"index"}],fn:this.sortedsimulationindex.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},"SimulationValuesArray.Ordered":{description:"Returns all values of this cell in the simulation, as an array, ordered by a second cell",arguments:[{name:"reference cell",description:"Source Cell",collector:!0},{name:"order by",description:"Reference Cell for Ordering",collector:!0}],fn:this.simulationvaluesarray_ordered.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMin:{description:"Returns the minimum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmin.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationMax:{description:"Returns the maximum value of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationmax.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardError:{description:"Returns the standard error of the mean from this cell in the simulation",arguments:[{name:"reference cell",collector:!0}],fn:this.simulationstandarderror.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationStandardDeviation:{description:"Returns the standard deviation of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationstandarddeviation.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationVariance:{description:"Returns the variance of the data from this cell in the simulation",arguments:[{name:"reference cell",description:"Source Cell",collector:!0}],fn:this.simulationvariance.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTrials:{description:"Returns the number of trials from the last simulation",fn:this.simulationtrials.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},SimulationTime:{description:"Returns the elapsed time of the last simulation",fn:this.simulationtime.bind(this),category:["RiskAMP Simulation Functions"],extension:!0},HasSimulationData:{description:"Returns TRUE if simulation data is available for a cell",fn:this.hassimulationdata.bind(this),arguments:[{name:"reference cell",description:"Source Cell",metadata:!0}],category:["RiskAMP Simulation Functions"],extension:!0,volatile:!0},"RiskAMP.IsPosDef":{description:"Checks that a matrix is positive-definite",arguments:[{name:"matrix"}],fn:t=>{let r=ki(t);return!r.square||!r.range||!r.data?F():{type:4,value:Xe.FromArray(r.data).IsPosDef()}},extension:!0},"RiskAMP.MakePosDef":{description:"Returns a matrix that is positive-definite",arguments:[{name:"matrix"}],fn:t=>{let r=ki(t);if(!r.square||!r.range||!r.data)return F();let a=[],i=Xe.FromArray(r.data);if(!i.IsPosDef())for(let s=0;s<8&&(i=i.MakePosDef(),!i.IsPosDef());s++);return a=i.ToArray(),{type:8,value:a.map(s=>s.map(o=>({type:3,value:o})))}},extension:!0},Cholesky:{arguments:[{name:"matrix"},{name:"transpose",default:!1}],fn:(t,r=!1)=>!t||!Array.isArray(t)?L():{type:8,value:Xe.FromArray(t).Cholesky(r).ToArray().map(i=>i.map(s=>({type:3,value:s})))},extension:!0},Identity:{description:"Returns the identity matrix for a given size",arguments:[{name:"size",description:"size of matrix in rows/coulmns"},{name:"scale",default:1,description:"optionally multipy by a scalar value"}],fn:(t=0,r=1)=>{if(t<1)return L();let a={type:3,value:0},i=Y(r),s=[];for(let o=0;o<t;o++){let n=[];for(let l=0;l<t;l++)n.push(o===l?i:a);s.push(n)}return{type:8,value:s}}},EigenValues:{description:"Returns the eigenvalues of the matrix (as column vector)",arguments:[{name:"matrix"}],fn:t=>t.some(a=>a.some(i=>typeof i!="number"))?F():{type:8,value:[Xe.FromArray(t).EigenSystem().realvalues.map(a=>({type:3,value:a}))]},extension:!0},EigenVectors:{description:"Returns the eigenvectors of the matrix (as matrix)",arguments:[{name:"matrix"}],fn:t=>t.some(a=>a.some(i=>typeof i!="number"))?F():{type:8,value:Xe.FromArray(t).EigenSystem().vectors.map(a=>Array.from(a).map(i=>({type:3,value:i})))},extension:!0},SimulationQuartiles:{description:"Returns the minimum, 1st quartile, median, 3rd quartile and maximum value",arguments:[{name:"reference cell",collector:!0}],fn:this.SimulationQuartiles.bind(this)},"RiskAMP.Task":{description:"Models a task with dependencies for project planning",arguments:[{name:"Sample"},{name:"Depdendency",repeat:!0}],fn:(t=0,...r)=>{let a=j(r),i=0;for(let s of a)typeof s=="number"&&s>i&&(i=s);return{type:3,value:t+i}},extension:!0},"RiskAMP.Scale":{description:"Creates a uniform scale within a given range",arguments:[{name:"min"},{name:"max"}],fn:this.Scale.bind(this),extension:!0},"RiskAMP.HistogramTable":{description:"Creates a histogram table from a source cell",arguments:[{name:"reference cell",collector:!0},{name:"type",default:1}],fn:this.HistogramTable.bind(this),extension:!0},"RiskAMP.Permutation":{description:"Creates a random permutation of source data",arguments:[{name:"range",boxed:!0}],fn:this.Permutation.bind(this),extension:!0,simulation_volatile:!0},"RiskAMP.Filter":{description:"Filter simulation results based on a second cell",arguments:[{name:"Source",description:"Data source cell",collector:!0},{name:"Filter",description:"Filter criteria cell",collector:!0}],extension:!0,fn:this.Filter.bind(this)},"RiskAMP.CountInRange":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"}],extension:!0,fn:this.CountInRange.bind(this)},"RiskAMP.IntervalStatistics":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"},{name:"Value reference",description:"Value reference",collector:!0}],extension:!0,fn:this.IntervalStatistics.bind(this)},"RiskAMP.IntervalInRange":{description:"Stochastic regression function",arguments:[{name:"Order reference",description:"Order reference",collector:!0},{name:"Order min",description:"Order min"},{name:"Order max",description:"Order max"},{name:"Value reference",description:"Value reference",collector:!0},{name:"Value min",description:"Value min"},{name:"Value max",description:"Value max"}],extension:!0,fn:this.IntervalInRange.bind(this)},"RiskAMP.Polynomial.Fit":{description:"Fit polynomial",arguments:[{name:"x",description:"x"},{name:"y",description:"y"},{name:"degree",description:"degree"}],extension:!0,fn:this.PolynomialFit.bind(this)},"RiskAMP.Polynomial.Apply":{description:"Apply polynomial",arguments:[{name:"coefficients"},{name:"x",boxed:!0}],extension:!0,fn:this.PolynomialApply.bind(this)},"RiskAMP.Polynomial.RealRoots":{description:"Find real roots of a polynomial",arguments:[],extension:!0,fn:this.PolynomialRealRoots.bind(this)},"RiskAMP.Polynomial.Roots":{description:"Find roots of a polynomial",arguments:[],extension:!0,fn:this.PolynomialRoots.bind(this)}},this.lv_functions={"Simulation.LV.Accepted":{description:"Count of accepted trials in a Las Vegas simulation",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVAccepted.bind(this)},"Simulation.LV.Rejected":{description:"Count of rejected trials in a Las Vegas simulation",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVRejected.bind(this)},"Simulation.LV.Succeeded":{description:"Returns TRUE if a Las Vegas simulation completed successfully",simulation_volatile:!0,category:["RiskAMP LV Functions"],extension:!0,volatile:!1,fn:this.LVSucceeded.bind(this)}},this.aliases={IsPosDef:"RiskAMP.IsPosDef",MakePosDef:"RiskAMP.MakePosDef",ProbabilityValue:"BernoulliValue"}}bindings=[];address={row:0,column:0};area;volatile=!1;iteration=0;iterations=0;lhs=!1;state=0;lv_state;first_iteration=0;results=[];distribution_id=0;triples=[];elapsed=0;trials=0;set seed(e){T.rng.Seed(e)}distributions=new Map;correlation_data=new Map;functions;lv_functions;aliases;LVAccepted(){return{type:3,value:this.lv_state?.accepted||0}}LVRejected(){return{type:3,value:this.lv_state?.rejected||0}}LVSucceeded(){let e=!1;return this.lv_state&&(e=!!this.lv_state.succeeded),{type:4,value:e}}CallerArea(){let e=1,t=1,r;if(this.address.sheet_id){let a=this.model.sheets.Find(this.address.sheet_id);a&&a.cells.data[this.address.row]&&(r=a.cells.data[this.address.row][this.address.column])}return r?.area&&(e=r.area.rows,t=r.area.columns),{rows:e,columns:t}}ResetDistributions(){this.distributions.clear(),this.correlation_data.clear()}CorrelateDistributions(){for(let e of this.correlation_data.values()){e.addresses.sort((r,a)=>r.column===a.column?r.row-a.row:r.column-a.column);let t=e.addresses.map(r=>this.distributions.get(r.distribution_id)||[]);try{let r=T.CorrelateCDM(e.correlation,t,!0);for(let[a,i]of e.addresses.entries())this.distributions.set(i.distribution_id,r[a])}catch(r){console.warn(r)}}}StoreCellResults(e){if(e||(e=this.address),!e)return;if(!e.sheet_id)throw new Error("SCR called without sheet id");this.results[e.sheet_id]||(this.results[e.sheet_id]=[]),this.results[e.sheet_id][e.column]||(this.results[e.sheet_id][e.column]=[]);let t=this.results[e.sheet_id][e.column];return t[e.row]||(t[e.row]=[]),t[e.row]}PrepMultivariate(e,t){let r=this.correlation_data.get(e);if(!r){let a=Kr.FromArray(t);if(!a.IsSymmetric()){for(let i=1;i<t.length;i++)for(let s=0;s<i;s++)if(t[i][s]){console.warn("invalid lower-triangular matrix");break}a=a.Symmetrize(!0)}r={correlation:a,addresses:[]},this.correlation_data.set(e,r)}r.addresses.push({column:this.address.column,row:this.address.row,sheet_id:this.address.sheet_id,distribution_id:this.distribution_id})}ValidateCorrelationMatrix(e){let t=Xe.FromArray(e);return t.IsSymmetric()||(t=t.Symmetrize(!0)),!(e.some(r=>r.some(a=>typeof a!="number"&&typeof a<"u"))||!t.IsPosDef())}multivariate_normal(e,t,r=0,a=1,i,s){if(this.state===1)this.PrepMultivariate(e,t),typeof i<"u"||typeof s<"u"?this.distributions.set(this.distribution_id,T.TruncatedNormal(this.iterations,{mean:r,sd:a,lhs:this.lhs,ordered:!0,min:i,max:s})):this.distributions.set(this.distribution_id,T.Normal(this.iterations,{mean:r,sd:a,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?typeof i<"u"||typeof s<"u"?{type:3,value:T.TruncatedNormal(1,{mean:r,sd:a,min:i,max:s})[0]}:{type:3,value:T.Normal(1,{mean:r,sd:a})[0]}:U()}multivariate_lognormal(e,t,r=0,a=1){if(this.state===1)this.PrepMultivariate(e,t),this.distributions.set(this.distribution_id,T.LogNormal(this.iterations,{mean:r,sd:a,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?{type:3,value:T.LogNormal(1,{mean:r,sd:a})[0]}:U()}multivariate_beta(e,t,r=1,a=2){if(this.state===1)this.PrepMultivariate(e,t),this.distributions.set(this.distribution_id,T.Beta(this.iterations,{a:r,b:a,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?{type:3,value:T.Beta(1,{a:r,b:a})[0]}:U()}multivariate_uniform(e,t,r=0,a=1,i=!1){if(this.state===1)this.PrepMultivariate(e,t),i?(r=Math.floor(r),a=Math.floor(a+1),this.distributions.set(this.distribution_id,lt(T.Uniform(this.iterations,{min:r,max:a,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,T.Uniform(this.iterations,{min:r,max:a,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?i?{type:3,value:Math.floor(T.Uniform(1,{min:Math.floor(r),max:Math.floor(a+1)})[0])}:{type:3,value:T.Uniform(1,{min:r,max:a})[0]}:U()}multivariate_pert(e,t,r=0,a=.5,i=1,s=4,o=!1){if(this.state===1)this.PrepMultivariate(e,t),o?([r,a,i]=He(r,a,i),this.distributions.set(this.distribution_id,lt(T.PERT(this.iterations,{a:r,b:i,c:a,lambda:s,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,T.PERT(this.iterations,{a:r,b:i,c:a,lambda:s,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?(o&&([r,a,i]=He(r,a,i)),{type:3,value:o?Math.floor(T.PERT(1,{a:r,b:i,c:a,lambda:s})[0]):T.PERT(1,{a:r,b:i,c:a,lambda:s})[0]}):U()}multivariate_triangular(e,t,r=0,a=.5,i=1,s=!1){if(this.state===1)this.PrepMultivariate(e,t),s?([r,a,i]=He(r,a,i),this.distributions.set(this.distribution_id,lt(T.Triangular(this.iterations,{a:r,b:i,c:a,lhs:this.lhs,ordered:!0})))):this.distributions.set(this.distribution_id,T.Triangular(this.iterations,{a:r,b:i,c:a,lhs:this.lhs,ordered:!0}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return this.ValidateCorrelationMatrix(t)?(s&&([r,a,i]=He(r,a,i)),{type:3,value:s?Math.floor(T.Triangular(1,{a:r,b:i,c:a})[0]):T.Triangular(1,{a:r,b:i,c:a})[0]}):U()}poissonvalue(e){if(this.state===1)this.distributions.set(this.distribution_id,T.Poisson(this.iterations,{m:e,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.Poisson(1,{m:e})[0]}}binomialvalue(e,t){if(e>1||t>0&&t<1)return L();if(this.state===1)this.distributions.set(this.distribution_id,T.Binomial(this.iterations,{n:t,p:e,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.Binomial(1,{n:t,p:e})[0]}}negativebinomialvalue(e,t){if(e>1||t>0&&t<1)return L();if(this.state===1)this.distributions.set(this.distribution_id,T.NegativeBinomial(this.iterations,{n:t,p:e,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.NegativeBinomial(1,{n:t,p:e})[0]}}uniformvalue(e=!1,t=0,r=1){if(this.state===1)e?(t=Math.floor(t),r=Math.floor(r)+1,this.distributions.set(this.distribution_id,lt(T.Uniform(this.iterations,{min:t,max:r,lhs:this.lhs})))):this.distributions.set(this.distribution_id,T.Uniform(this.iterations,{min:t,max:r,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:e?Math.floor(T.Uniform(1,{min:t,max:r+1})[0]):T.Uniform(1,{min:t,max:r})[0]}}bernoullivalue(e=.5){if(this.state===1)this.distributions.set(this.distribution_id,T.Bernoulli(this.iterations,{p:e,lhs:this.lhs}).map(t=>t?1:0));else if(this.state===2)return{type:4,value:!!(this.distributions.get(this.distribution_id)?.[this.iteration]||0)};return{type:4,value:T.Bernoulli(1,{p:e})[0]}}sequentialvalue(e,t=0){if(this.state!==1&&this.state===2){let r=this.iteration+this.first_iteration;t>0&&(r=this.iteration%t);let a=e[0].length,i=Math.floor(r/a)%e.length,s=r%a;return{type:3,value:e[i][s]}}return{type:3,value:e[0][0]}}indexvalue(e=0){return this.state!==1&&this.state===2?e>0?{type:3,value:(this.iteration+this.first_iteration)%e+1}:{type:3,value:this.iteration+this.first_iteration+1}:{type:3,value:1}}scaledlognormalvalue(e=0,t=1){let r=Math.log(e*e/Math.sqrt(e*e+t*t)),a=Math.sqrt(Math.log((e*e+t*t)/(e*e)));return this.lognormalvalue(r,a)}lognormalvalue(e=0,t=1){if(this.state===1)this.distributions.set(this.distribution_id,T.LogNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.LogNormal(1,{mean:e,sd:t})[0]}}truncatednormalvalue(e=0,t=1,r,a){if(this.state===1)this.distributions.set(this.distribution_id,T.TruncatedNormal(this.iterations,{mean:e,sd:t,lhs:this.lhs,min:r,max:a}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.TruncatedNormal(1,{mean:e,sd:t,min:r,max:a})[0]}}normalvalue(e=0,t=1){if(this.state===1)this.distributions.set(this.distribution_id,T.Normal(this.iterations,{mean:e,sd:t,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.Normal(1,{mean:e,sd:t})[0]}}pertvalue(e=!1,t=0,r=.5,a=1,i=4){if(this.state===1)e?([t,r,a]=He(t,r,a),this.distributions.set(this.distribution_id,lt(T.PERT(this.iterations,{a:t,b:a,c:r,lambda:i,lhs:this.lhs})))):this.distributions.set(this.distribution_id,T.PERT(this.iterations,{a:t,b:a,c:r,lambda:i,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return e&&([t,r,a]=He(t,r,a)),{type:3,value:e?Math.floor(T.PERT(1,{a:t,b:a,c:r,lambda:i})[0]):T.PERT(1,{a:t,b:a,c:r,lambda:i})[0]}}pertvalue_p(e=0,t=.5,r=1,a=4){if(this.state===1){let s=T.P80Pert(e,r,t,a);this.distributions.set(this.distribution_id,T.PERT(this.iterations,{...s,lambda:a,lhs:this.lhs}))}else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};let i=T.P80Pert(e,r,t,a);return{type:3,value:T.PERT(1,{...i,lambda:a})[0]}}triangularvalue(e=!1,t=0,r=.5,a=1){if(this.state===1)e?([t,r,a]=He(t,r,a),this.distributions.set(this.distribution_id,lt(T.Triangular(this.iterations,{a:t,b:a,c:r,lhs:this.lhs})))):this.distributions.set(this.distribution_id,T.Triangular(this.iterations,{a:t,b:a,c:r,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return e&&([t,r,a]=He(t,r,a)),{type:3,value:e?Math.floor(T.Triangular(1,{a:t,b:a,c:r})[0]):T.Triangular(1,{a:t,b:a,c:r})[0]}}weibullvalue(e=1,t=1){if(this.state===1)this.distributions.set(this.distribution_id,T.Weibull(this.iterations,{a:e,b:t,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.Weibull(1,{a:e,b:t})[0]}}betavalue(e=1,t=1){if(this.state===1)this.distributions.set(this.distribution_id,T.Beta(this.iterations,{a:e,b:t,lhs:this.lhs}));else if(this.state===2)return{type:3,value:this.distributions.get(this.distribution_id)?.[this.iteration]||0};return{type:3,value:T.Beta(1,{a:e,b:t})[0]}}samplevalue(e){return this.uniformrangesample(e)}samplevalue_weighted(e,t){if(this.state===1)this.distributions.set(this.distribution_id,T.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));else{let r=0;if(this.state===2?r=this.distributions.get(this.distribution_id)?.[this.iteration]||0:r=T.Uniform(1,{min:0,max:1})[0],!e||!e.length)return{type:0,value:void 0};let a=j(t).reduce((o,n)=>typeof n>"u"?o:o+Number(n),0),i=r*a,s=0;for(let o=0;o<e.length;o++)for(let n=0;n<e[o].length;n++)if(s+=t[o][n],s>=i)return{type:3,value:e[o][n]}}return{type:3,value:e[0][0]}}uniformrangesample(e){this.state===1&&this.distributions.set(this.distribution_id,T.Uniform(this.iterations,{min:0,max:1,lhs:this.lhs}));let t=0;if(this.state===2?t=this.distributions.get(this.distribution_id)?.[this.iteration]||0:t=T.Uniform(1,{min:0,max:1})[0],!e||!e.length)return{type:0,value:void 0};let r=Math.floor(e[0].length*e.length*t),a=e[r%e.length][Math.floor(r/e.length)]||"";return Y(a)}hassimulationdata(e){let t=!1;return e?.type===5&&e.key==="metadata"&&(t=!!e.value?.simulation_data?.length),{type:4,value:t}}simulationtrials(){return{type:3,value:this.trials}}simulationtime(){return{type:3,value:this.elapsed/1e3}}PolynomialRoots(e,t=0){e=j(e),t&&(e[0]+=t);let r=Mt.Roots(e);if(r.length){let a=[];for(let i of r)a.push({type:7,value:i});return{type:8,value:[a]}}return{type:0}}PolynomialRealRoots(e,t=0,r,a){e=j(e),t&&(e[0]+=t);let i=Mt.Roots(e).filter(s=>Math.abs(s.imaginary)<1e-12).map(s=>s.real);return typeof r=="number"&&(i=i.filter(s=>s>=r)),typeof a=="number"&&(i=i.filter(s=>s<=a)),i.map(s=>[{type:3,value:s}]).length>0?{type:8,value:i.map(s=>[{type:3,value:s}])}:{type:0}}PolynomialApply(e,t){if(t.type===8){let r={type:8,value:[]};for(let a of t.value){let i=j(e),s=[];for(let o of a)o.type===3?s.push({type:3,value:Mt.Apply(i,o.value)}):s.push({type:0});r.value.push(s)}return r}else if(t.type===3)return{type:3,value:Mt.Apply(j(e),t.value)};return L()}PolynomialFit(e,t,r){let a=[];if(!e||!t||!r)return L();Array.isArray(e)||(e=[Array.from(e)]),Array.isArray(t)||(t=[Array.from(t)]);let i=j(e),s=j(t);if(i.length===0||s.length===0)return U();a=Mt.Fit(i,s,r);let o=a.map(n=>[{type:3,value:n}]);return o.length?{type:8,value:o}:{type:0}}MatchingRange(e,t,r,a){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!a||!a.length||a.length!==e.length)return U();let i=[],s=a.length;for(let o=0;o<s;o++)e[o]>=t&&e[o]<=r&&i.push({type:3,value:a[o]});return{type:8,value:[i]}}Filter(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!t||!t.length)return U();let r=[];for(let[a,i]of t.entries())i&&r.push(Y(e[a]));return{type:8,value:[r]}}CountInRange(e,t,r){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let a=0,i=e.length;for(let s=0;s<i;s++)e[s]>=t&&e[s]<=r&&a++;return{type:3,value:a}}IntervalStatistics(e,t,r,a){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!a||!a.length||(a=this.EnsureSingleCellData(a),e=this.EnsureSingleCellData(e),a.length!==e.length))return U();let i=e.length,s=0,o=[];for(let l=0;l<i;l++)e[l]>=t&&e[l]<=r&&(s+=a[l],o.push(a[l]));o.sort((l,h)=>l-h);let n=this.Quarties(o).map(l=>[{type:3,value:l}]);return{type:8,value:[[{type:3,value:o.length}],[{type:3,value:o.length?s/o.length:0}],...n]}}IntervalInRange(e,t,r,a,i,s){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!a||!a.length||(a=this.EnsureSingleCellData(a),e=this.EnsureSingleCellData(e),a.length!==e.length))return U();let o=0,n=0,l=a.length;if(typeof i=="number"&&typeof s=="number")for(let h=0;h<l;h++)e[h]>=t&&e[h]<=r&&(n++,a[h]>=i&&a[h]<=s&&o++);else if(typeof s=="number")for(let h=0;h<l;h++)e[h]>=t&&e[h]<=r&&(n++,a[h]<=s&&o++);else{i=i||0;for(let h=0;h<l;h++)e[h]>=t&&e[h]<=r&&(n++,a[h]>=i&&o++)}return{type:3,value:n>0?o/n:0}}isDiscrete(e){for(let t of e)if(Math.floor(t)!==t)return!1;return!0}FindFirstBin(e,t,r,a){let i=Math.floor(t/a)*a,s=(t-i)/a,o=(i+r*a-e)/a+s;return o==1?i-=a:i-=o/2*a,i}RoundedTickRange(e,t,r){if(e==0)return 1;let a=e/(t-1),i=Math.ceil(Math.log10(a)-1),s=Math.pow(10,i),o=Math.ceil(a/s)*s;if(r){let n=o;return n<o&&n++,n}return o}SimulationHistogramBin(e,t=10,r=0){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();let a=0,i=e.length,s=0,o=e[0],n=e[0];for(let c of e)c<o&&(o=c),c>n&&(n=c);let l=this.RoundedTickRange(n-o,t,this.isDiscrete(e)),h=this.FindFirstBin(n,o,t,l)+l*(r-1),d=h+l;for(a=0;a<i;a++){let c=e[a];(a==0&&c>=h||c>h)&&c<=d&&s++}return{type:3,value:s}}SimulationHistogramBinLabel(e,t=10,r=0){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();let a=e[0],i=e[0];for(let n of e)n<a&&(a=n),n>i&&(i=n);let s=this.RoundedTickRange(i-a,t,this.isDiscrete(e));return{type:3,value:this.FindFirstBin(i,a,t,s)+s*(r-1)+s}}simulationvaluesarray(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=[];for(let r=0;r<e.length;r++)t[r]={type:3,value:e[r]};return{type:8,value:[t]}}simulationvaluesarray_ordered(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||t&&!t.length)return U();if(e=this.EnsureSingleCellData(e),t&&(t=this.EnsureSingleCellData(t)),!t)return{type:8,value:[Array.prototype.slice.call(e,0).sort((a,i)=>a-i).map(a=>({type:3,value:a}))]};let r=Array.from(e).map((a,i)=>[a,t[i]]);return r.sort((a,i)=>a[1]-i[1]),{type:8,value:[r.map(a=>({type:3,value:a[0]}))]}}simulationrsquared(e,t){if(this.state!==0)return{type:3,value:0};if(!e||!e.length||!t||!t.length)return U();e=this.EnsureSingleCellData(e),t=this.EnsureSingleCellData(t);let{r2:r,error:a}=ne.R22(e,t);return a?F():{type:3,value:r||0}}simulationcorrelation(e,t){return this.state!==0?{type:3,value:0}:!e||!e.length||!t||!t.length?U():(e=this.EnsureSingleCellData(e),t=this.EnsureSingleCellData(t),{type:3,value:ne.Correlation(e,t)})}simulationcorrelationmatrix(e,t=!0){if(this.state!==0)return{type:3,value:0};if(!Array.isArray(e)||!Array.isArray(e[0]))return{type:3,value:1};if(e.length>1&&e[0].length>1)return L();let r=[],a=!1;for(let l of e)for(let h of l)r.push(h),h.length||(a=!0);if(a)return U();let i=r.length,s=[],o=0,n=0;for(o=0;o<i;o++){let l=[];for(n=0;n<=o;n++)l.push({type:3,value:o===n?1:ne.Correlation(r[o],r[n])});for(;n<i;n++)l.push({type:0});s.push(l)}if(t)for(o=0;o<i;o++)for(n=o+1;n<i;n++)s[o][n]={type:3,value:s[n][o].value};else for(o=0;o<i;o++)for(n=o+1;n<i;n++)s[o][n]={type:2,value:""};return{type:8,value:na(s)}}sortedsimulationindex(e,t=1){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();if(e=this.EnsureSingleCellData(e),t<1||t>e.length)return L();let r=Array.from(e).map((a,i)=>[a,i+1]);return r.sort((a,i)=>a[0]-i[0]),{type:3,value:r[t-1][1]}}simulationvalue_cumulative(e,t=1){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();if(e=this.EnsureSingleCellData(e),t<1||t>e.length)return L();let r=0;for(let a=0;a<t;a++)r+=e[a];return{type:3,value:r}}simulationvalue(e,t=1){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),t<1||t>e.length?L():{type:3,value:e[t-1]})}simulationpercentile(e,t=.5){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e),e=e.slice(0),e.sort((i,s)=>i-s);let r=e.length,a=Math.floor(t*r);return a>=r&&(a=r-1),a<0&&(a=0),{type:3,value:e[a]}}EnsureSingleCellData(e){return Array.isArray(e)&&Array.isArray(e[0])?e[0][0]:e}simulationstandarddeviation(e){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),{type:3,value:ne.Statistics(e).stdev})}simulationvariance(e){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),{type:3,value:ne.Statistics(e).variance})}simulationskewness(e){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),{type:3,value:ne.Statistics(e).skewness})}simulationkurtosis(e){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),{type:3,value:ne.Statistics(e).kurtosis})}simulationmedian(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=e.slice(0);t.sort((i,s)=>i-s);let r=t.length,a=0;return r%2?a=t[Math.floor(r/2)]:a=(t[r/2]+t[r/2-1])/2,{type:3,value:a}}Quarties(e){if(!e.length)return[0,0,0,0,0];let t=i=>{let s=i.length;return s%2?i[Math.floor(s/2)]:(i[s/2]+i[s/2-1])/2},r=e.length,a=[e[0],0,t(e),0,e[r-1]];return r%2?(a[1]=t(e.slice(0,Math.ceil(r/2))),a[3]=t(e.slice(Math.floor(r/2)))):(a[1]=t(e.slice(0,r/2)),a[3]=t(e.slice(r/2))),a}SimulationQuartiles(e){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),e.length<1?L():(e=e.slice(0),e.sort((r,a)=>r-a),{type:8,value:[this.Quarties(e).map(r=>({type:3,value:r}))]}))}simulationslope(e,t){if(e&&(e=this.EnsureSingleCellData(e)),t&&(t=this.EnsureSingleCellData(t)),!e||!e.length||!t||!t.length||e.length!==t.length)return U();let r=e.length,a=0,i=0,s=0,o=0;for(let l=0;l<r;l++){let h=e[l],d=t[l];s+=h*d,a+=h,i+=d,o+=h*h}return{type:3,value:(r*s-a*i)/(r*o-a*a)}}simulationintercept(e,t){if(e&&(e=this.EnsureSingleCellData(e)),t&&(t=this.EnsureSingleCellData(t)),!e||!e.length||!t||!t.length||e.length!==t.length)return U();let r=e.length,a=0,i=0,s=0,o=0;for(let l=0;l<r;l++){let h=e[l],d=t[l];s+=h*d,a+=h,i+=d,o+=h*h}let n=r*s-a*i;return n/=r*o-a*a,{type:3,value:(i-n*a)/r}}simulationinterval(e,t,r){return this.state!==0?{type:3,value:0}:!e||!e.length?U():(e=this.EnsureSingleCellData(e),{type:3,value:ne.Interval({data:e,min:t,max:r})})}simulationstandarderror(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=0,r=0;for(let i of e)t+=i||0;let a=t/e.length;for(let i of e){let s=i-a;r+=s*s}return{type:3,value:Math.sqrt(r/e.length)/Math.sqrt(e.length)}}simulationmin(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=e[0];for(let r of e)r<t&&(t=r);return{type:3,value:t}}simulationmax(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=e[0];for(let r of e)r>t&&(t=r);return{type:3,value:t}}simulationmode(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=[],r=[];for(let a of e){let i=Math.floor(a);t[i]=(t[i]||0)+1}return t.forEach((a,i)=>r.push([a,i])),r.sort((a,i)=>i[0]-a[0]),{type:3,value:r[0][1]}}simulationgeometricmean(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e),Array.isArray(e)||(e=Array.from(e));let t=1;for(let r of e)t*=Math.pow(r,1/e.length);return{type:3,value:t}}simulationmean(e){if(this.state!==0)return{type:3,value:0};if(!e||!e.length)return U();e=this.EnsureSingleCellData(e);let t=0;for(let r of e)t+=r;return{type:3,value:t/e.length}}Permutation(e){if(!e){let{rows:t,columns:r}=this.CallerArea(),a=t*r;if(a<=0)return L();let i=Si(a),s=[],o=0;for(let n=0;n<r;n++){let l=[];for(let h=0;h<t;h++)l.push({type:3,value:i[o++]});s.push(l)}return{type:8,value:s}}if(e.type===8){let t=e.value.length,r=e.value[0].length;if(!t||!r)return L();let a=e.value.reduce((l,h)=>h.concat(l),[]),i=t*r;if(a.length!==i)throw console.info("invalid?",i,e,a),new Error("invalid length");let s=Si(i),o=[],n=0;for(let l=0;l<t;l++){let h=[];for(let d=0;d<r;d++){let c=s[n++];h.push({...a[c]})}o.push(h)}return{type:8,value:o}}else return{...e}}Scale(e,t,r=!1){let{rows:a,columns:i}=this.CallerArea(),s=Math.max(a,i),o=e>t?ar(t,e,s-1,!0,r):ar(e,t,s-1,!0,r),n=o.min,l=[[]];if(o.count<s-1&&(n=o.min-Math.ceil((s-o.count)/2)*o.step),e>t)for(let h=0;h<s;h++){let d=n+h*o.step;l[0][s-1-h]={type:3,value:d}}else for(let h=0;h<s;h++){let d=n+h*o.step;l[0][h]={type:3,value:d}}return{type:8,value:a<i?Dt(l):l}}HistogramTable(e,t=1){let{rows:r,columns:a}=this.CallerArea(),i=Math.max(r,a),s=Math.min(r,a);if((typeof t!="number"||t<1||t>4)&&(t=1),Array.isArray(e)||e instanceof Float64Array||e instanceof Float32Array){if(e.length<=1)return{type:3,value:0};Array.isArray(e)||(e=Array.prototype.slice.call(e));let o=e;o.sort((p,b)=>p-b);let n=o[0]||0,l=o[o.length-1]||0,h=!0;for(let p of o)if(p%1!==0){h=!1;break}if(l===n)return{type:3,value:0};let d=[[],[]],c=ar(n,l,i,!0,h),u=c.min,m=0;c.count<i&&(u=c.min-Math.ceil((i-c.count)/2)*c.step);let f=1;for(let p=0;p<i;p++){let b=u+(p+1)*c.step,w=0;for(;m<o.length&&o[m]<=b;m++,w++);t===2&&(w/=o.length),t===3&&(w/=o.length,f-=w,w=f),t===4&&(w/=o.length,f-=w,w=1-f),d[1][p]={type:3,value:w},d[0][p]={type:3,value:b}}return s===1&&(d=[d[1]]),{type:8,value:a>r?Dt(d):d}}return{type:3,value:0}}},ih=class extends ts{simulation_model;constructor(e,t,r){super(e,t,r),this.simulation_model=new ah(e),this.context=this.simulation_model}CallExpression(e,t=!1){let r=this.library.Get(e.name);if(!r){let s=e.name.toUpperCase();return this.LookupBinding(s)?this.ImplicitCall():this.data_model.GetName(s,this.context.address.sheet_id||0)?this.ImplicitCall():()=>Or()}let a=r.arguments||[];this.simulation_model.state===1&&e.args.forEach((s,o)=>{let n=a[o]||{};if(s&&n.collector){if(s.type==="address")this.simulation_model.StoreCellResults(s);else if(s.type==="range"){let l=new k(s.start,s.end);for(let h of l)this.simulation_model.StoreCellResults(h)}else if(s.type==="identifier"){let l=this.data_model.GetName(s.name,this.context.address.sheet_id||0);l?.type==="range"&&this.simulation_model.StoreCellResults(l.area.start)}else if(s.type==="call"){let l=this.CalculateExpression(s,!0);l&&ct(l)&&(l.value.type==="address"?this.simulation_model.StoreCellResults(l.value):l.value.type==="range"&&this.simulation_model.StoreCellResults(l.value.start))}}});let i=this.simulation_model.state===0?0:this.simulation_model.distributions.size;return s=>{this.simulation_model.volatile=this.simulation_model.volatile||!!r.volatile||!!r.simulation_volatile&&this.simulation_model.state!==0;let o=e.name.toUpperCase()==="IF",n=-1,l,h=s.args,d=r.arguments||[],c;r.create_binding_context&&(c=r.create_binding_context.call(0,{args:s.args,descriptors:d}),c?(h=c.args,c.argument_descriptors&&(d=c.argument_descriptors),this.context.bindings.unshift(this.NormalizeBindings(c.context))):l=L());let u=h.map((f,p)=>{if(l)return;let b=d[Math.min(p,d.length-1)]||{};if(b.passthrough)return f;if(p===n)if(this.simulation_model.state===1){let w=!0;if(this.parser.Walk(f,y=>(y.type==="call"&&this.library.Get(y.name)?.simulation_volatile&&(w=!1),w)),w)return b.boxed?{type:0}:void 0}else return b.boxed?{type:0}:void 0;if(typeof f>"u")return o&&p===0&&(n=1),b.boxed?{type:0}:void 0;if(b.address)return b.boxed?{type:2,value:this.parser.Render(f).replace(/\$/g,"")}:this.parser.Render(f).replace(/\$/g,"");if(b.metadata)return this.GetMetadata(f,(w,y)=>({simulation_data:this.simulation_model.state===0?this.simulation_model.StoreCellResults(y):[]}));if(b.collector&&this.simulation_model.state===0){if(f.type==="address")return this.simulation_model.StoreCellResults(f);if(f.type==="range"){let w=[];for(let y=f.start.row;y<=f.end.row;y++){let g=[];for(let v=f.start.column;v<=f.end.column;v++)g.push(this.simulation_model.StoreCellResults({row:y,column:v,sheet_id:f.start.sheet_id}));w.push(g)}return w}else if(f.type==="identifier"){let w=this.data_model.GetName(f.name,this.context.address.sheet_id||0);if(w?.type==="range")return this.simulation_model.StoreCellResults(w.area.start)}else if(f.type==="call"){let w=this.CalculateExpression(f,!0);if(w&&ct(w)){if(w.value.type==="address")return this.simulation_model.StoreCellResults(w.value);if(w.value.type==="range")return this.simulation_model.StoreCellResults(w.value.start)}}return l=Z(),l}else{let w=this.CalculateExpression(f);if(w.type===6){if(b.allow_error)return w;l=w;return}if(o&&p===0&&w.type!==8){let y=!1;if(w.type===2){let g=w.value.toLowerCase().trim();y=g!=="false"&&g!=="f"}else y=!!w.value;n=y?2:1}return b.boxed?w:Array.isArray(w)?(console.warn("AAA 82394"),w.map(y=>y.map(g=>g.value))):w.type===8?w.value.map(y=>y.map(g=>g.value)):w.value}});if(l)return l;this.context.distribution_id=i;let m={address:{...this.context.address},area:this.context.area?{start:{...this.context.area.start},end:{...this.context.area.end}}:void 0};if(r.return_type==="reference"){let f=r.fn.apply(m,u);if(t)return f;if(ct(f)){if(f.value.type==="address")return this.CellFunction2(f.value)();if(f.value.type==="range")return this.CellFunction4(f.value.start,f.value.end)}return f}return r.fn.apply(m,u)}}},rr=Ds(Ls()),vs=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],sh=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];function Mi(e){if(e.length%4)return null;for(var t="",r=0,a=0,i=typeof e=="string"?function(o,n){return o.charCodeAt(n)}:function(o,n){return o[n]};r<e.length;)if(a=a*256+i(e,r++),r%4===0){for(var s=52200625;s>=1;)t+=vs[Math.floor(a/s)%85],s/=85;a=0}return t}function Ai(e){if(e.length%5)return null;for(var t=new Uint8Array(e.length*4/5),r=0,a=0,i=0;a<e.length;){if(!vs.includes(e.charAt(a)))return null;var s=e.charCodeAt(a++)-32;if(i=i*85+sh[s],a%5===0){for(var o=16777216;o>=1;)t[r++]=i/o%256,o/=256;i=0}}return t}var Ri=class extends cs{simulation_expression_calculator;last_simulation_data;constructor(e,t={}){super(e,t),this.expression_calculator=this.simulation_expression_calculator=new ih(this.model,this.library,this.parser),this.library.Register(this.simulation_expression_calculator.simulation_model.functions);let r=this.simulation_expression_calculator.simulation_model.aliases;for(let a of Object.keys(r))this.library.Alias(a,r[a]);t.lv&&this.library.Register(this.simulation_expression_calculator.simulation_model.lv_functions)}RiskAMPFunctionList(){return[...Object.keys(this.simulation_expression_calculator.simulation_model.functions),...Object.keys(this.simulation_expression_calculator.simulation_model.lv_functions)]}CleanUpLVSimulation(e){e.accept?.vertex&&this.RemoveLeafVertex(e.accept.vertex),e.terminate?.vertex&&this.RemoveLeafVertex(e.terminate.vertex),e.fail?.vertex&&this.RemoveLeafVertex(e.fail.vertex)}InitLVSimulation(e,t){let r=a=>{if(a){let i=new Zi;i.use="lv",this.AddLeafVertex(i),this.UpdateLeafVertex(i,a,t);let s=this.Evaluate(a,t,{},!0);return i.result=s,i.updated=!0,{text:a,vertex:i}}};return{accept:r(e.accept),terminate:r(e.terminate),fail:r(e.fail)}}InitSimulation(e,t,r,a,i,s){let o=this.simulation_expression_calculator.simulation_model;if(o.ResetDistributions(),o.first_iteration=e,o.iterations=t,o.results=[],o.lhs=r,o.lv_state=void 0,typeof s=="number"&&(o.seed=s),this.Reset(),i&&i.length)for(let n of i){if(!n.sheet_id)throw new Error("additional cell passed without sheet id");let l=this.model.sheets.Find(n.sheet_id);l&&l.cells.GetCell(n,!1)&&o.StoreCellResults(n)}if(this.RebuildGraph(),this.LoopCheck())throw new Error("Loop (circular dependency) found in graph");return o.state=1,o.iteration=0,this.Recalculate(),o.CorrelateDistributions(),o.state=2,o.triples=[],o.results.forEach((n,l)=>{n.forEach((h,d)=>{h.forEach((c,u)=>{o.triples.push([l,d,u])})})}),0}Resample(){let e=this.simulation_expression_calculator.simulation_model;e.state=1,e.iteration=0,this.Recalculate(),e.CorrelateDistributions(),e.state=2}GetResults(){return this.simulation_expression_calculator.simulation_model.results}SimulationTrial(e,t,r){let a=this.simulation_expression_calculator.simulation_model;a.iteration=e;try{this.Recalculate();let i,s=0;if(r&&t){let o=!0,n=t.accept?.vertex?.result;if(n&&(n.value?(r.accepted++,o=!1):r.rejected++),n=t.terminate?.vertex?.result,n&&(n.type===3?r.accepted>=n.value&&(r.terminated=!0,r.succeeded=!0):n.value&&(r.terminated=!0,r.succeeded=!0)),n=t.fail?.vertex?.result,n&&(n.type===3?r.accepted+r.rejected>=n.value&&(r.failed=!0):n.value&&(r.failed=!0)),o)return{status:0,reference:null};e=r.accepted-1,this.simulation_expression_calculator.simulation_model.lv_state={...r}}for(let[o,n,l]of a.triples)if(s!==o&&(s=o,i=this.model.sheets.Find(o)?.cells),i){let h=i.GetCell({row:l,column:n});if(h){let d=h.GetValue();switch(typeof d){case"number":a.results[o][n][l][e]=d;break;case"boolean":a.results[o][n][l][e]=d?1:0;break;default:a.results[o][n][l][e]=0}}}return{status:0,reference:null}}catch(i){return console.info("calculation error trapped",i),{status:2,reference:null}}}FlattenedResults(){let e=this.simulation_expression_calculator.simulation_model,t=[];for(let r in e.results)for(let a in e.results[r]){let i=e.results[r][a];for(let s in i)t.push(vl({row:Number(s),column:Number(a),sheet_id:Number(r),data:i[s]}).buffer)}return t}FlushSimulationResults(){let e=this.simulation_expression_calculator.simulation_model;e.results=[],e.elapsed=0,e.trials=0,this.last_simulation_data=void 0}CollectorReferences(e,t){let r=[],a={row:0,column:0,sheet_id:t},i=this.parser.Parse(e);if(i.expression&&i.expression.type==="call"){let s=this.library.Get(i.expression.name);if(!s||!s.arguments)return[];for(let o=0;o<s.arguments.length;o++){let n=s.arguments[o];if(!n||!n.collector)continue;let l=i.expression.args[o];if(!l)continue;let h=this.ResolveExpressionAddress(l,a);h&&r.push(h.start)}}return r}ShiftSimulationResults(e,t,r,a){}SerializeSimulationData(e){let t={elapsed:this.last_simulation_data?.elapsed||0,trials:this.last_simulation_data?.trials||0,results:[]},r=this.last_simulation_data?.results||[];return e.float32?(t.bitness=32,t.results=r.map(a=>{let i=Float32Array.from(new Float64Array(a));return e.z85?Mi(new Uint8Array(i.buffer))||"":rr.fromByteArray(new Uint8Array(i.buffer))})):t.results=r.map(a=>e.z85?Mi(new Uint8Array(a))||"":rr.fromByteArray(new Uint8Array(a))),e.z85&&(t.encoding="z85"),t}UnserializeSimulationData(e){let t=e.encoding==="z85";this.last_simulation_data={...e,results:[]},e.bitness===32?this.last_simulation_data.results=(e.results||[]).map(r=>{if(t){let a=Ai(r);return a?Float64Array.from(a).buffer:new Float64Array().buffer}else{let a=new Float32Array(rr.toByteArray(r).buffer);return Float64Array.from(a).buffer}}):this.last_simulation_data.results=(e.results||[]).map(r=>{if(t){let a=Ai(r);return a?a.buffer:new Uint8Array().buffer}else return rr.toByteArray(r).buffer}),this.UpdateResults(!1)}ConsolidateLVState(e){let t={accepted:0,rejected:0,terminated:!1,failed:!1,iteration:0,succeeded:!1};for(let r of e)r&&(t.accepted+=r.accepted,t.rejected+=r.rejected,t.failed=t.failed||r.failed,t.terminated=t.terminated||r.terminated,t.succeeded=t.succeeded||r.succeeded);return this.simulation_expression_calculator.simulation_model.lv_state=t,{...t}}UpdateResults(e=!0){let t=this.simulation_expression_calculator.simulation_model,r=this.last_simulation_data;if(!r)t.results=[],t.elapsed=0,t.trials=0;else{t.results=[],t.elapsed=r.elapsed,t.trials=r.trials;for(let a of r.results){let i=a instanceof ArrayBuffer?yl(new Float64Array(a)):a;i.sheet_id||(i.sheet_id=this.model.sheets.list[0].id),t.results[i.sheet_id]||(t.results[i.sheet_id]=[]),t.results[i.sheet_id][i.column]||(t.results[i.sheet_id][i.column]=[]),t.results[i.sheet_id][i.column][i.row]=i.data,e&&this.SetDirty(i)}}}},Yr=(e=>(e[e.Normal=0]="Normal",e[e["Log-normal"]=1]="Log-normal",e[e.Triangular=2]="Triangular",e[e.Uniform=3]="Uniform",e[e.PERT=4]="PERT",e[e.Beta=5]="Beta",e[e.Weibull=6]="Weibull",e[e["Half-normal"]=7]="Half-normal",e))(Yr||{}),la=e=>{let t=e.slice(0),r={mean:0,variance:0,stdev:0,range:0,min:t[0],max:t[0]};for(let a of t)r.mean+=a,r.min=Math.min(r.min,a),r.max=Math.max(r.max,a);r.mean/=t.length,r.range=r.max-r.min;for(let a of t){let i=a-r.mean;r.variance+=i*i}return r.variance/=t.length,r.stdev=Math.sqrt(r.variance),r},Ge=(e,t)=>{let r=e.length,a={mean_square:0,aggregate:0,max:0,mean:0};for(let i=0;i<r;i++){let s=Math.abs(e[i]-t[i]);a.aggregate+=s,a.mean_square+=s*s,s>a.max&&(a.max=s)}return a.mean=a.aggregate/r,a.mean_square/=r,a},ke=(e,t,r=0)=>{let a=e.slice(0),i=la(a),s=[];for(let n=0;n<t;n++)s[n]=0;let o=Math.floor(t/2);for(let n of a){n+=r;let l=Math.floor((n-i.mean)/i.stdev)+o;l>=0&&l<t&&s[l]++}for(let n=0;n<t;n++)s[n]=s[n]/a.length;return s},oh=e=>{for(let d of e)if(d<0)return!1;let t=1,r=1,a=e.length,i=d=>{let c=0,u=0,m=0;for(let f of e){let p=Math.log(f),b=Math.pow(f,d);u+=b*p,m+=b,c+=p}return u/m-1/d-1/a*c},s=100,o=1e-6,n=1,l=.2,h=[{found:!1,value:0},{found:!1,value:0}];for(let d=0;d<s;d++){let c=i(n);if(Math.abs(c)<=o){r=n;let u=0;for(let m of e)u+=Math.pow(m,r);return t=Math.pow(1/a*u,1/r),{alpha:t,beta:r}}if(c<0){if(h[0].value=h[0].found?Math.max(h[0].value,n):n,h[0].found=!0,!h[1].found){n+=l;continue}}else if(h[1].value=h[1].found?Math.min(h[1].value,n):n,h[1].found=!0,!h[0].found){n-=l;continue}n=h[0].value+(h[1].value-h[0].value)/2}return!1},nh=(e,t)=>{for(let a of e)if(a<0||a>1)return!1;let r=t.mean*(1-t.mean);if(t.variance<r){let a=r/t.variance,i=t.mean*(a-1),s=(1-t.mean)*(a-1);return{alpha:i,beta:s}}return!1},lh=e=>{if(!e.length)return!1;let t=0;for(let a of e){if(a<0)return!1;t+=a*a}t=Math.sqrt(t/e.length);let r=t/(4*e.length);return{mean:0,stdev:t-r}},hh=(e,t)=>{for(let i of e)if(i<0)return!1;let r=e.slice(0),a=0;t.min<0&&(a=t.min+.001);for(let i=0;i<r.length;i++)r[i]=Math.log(r[i]+a);return t=la(r),{mean:t.mean,stdev:t.stdev,offset:a}},dh=(e=4,t)=>{let r=(t.mean*(e+2)-t.min-t.max)/e;return r<=t.min&&(r=t.min+.01*t.range),r>=t.max&&(r=t.max-.01*t.range),{a:t.min,c:r,b:t.max}},ch=e=>{let t=3*e.mean-e.min-e.max;return t<e.min&&(t=e.min+.01*e.range),t>e.max&&(t=e.max-.01*e.range),{a:e.min,c:t,b:e.max}},uh=e=>({min:e.min,max:e.max}),mh=e=>({mean:e.mean,stdev:e.stdev}),fh=(e,t)=>{let r=e.slice(0),a=r.length;if(t==="Rate"){for(let M=a-1;M>0;M--)r[M]=r[M]/r[M-1];r.shift()}else if(t==="Delta"){for(let M=a-1;M>0;M--)r[M]=r[M]-r[M-1];r.shift()}let i=1e3,s=10;r.length>100&&(s=16);let o=T.Normal(i,{mean:0,sd:1,lhs:!0}),n=ke(o,s),l=Array.from(T.Uniform(i,{min:0,max:1,lhs:!0})),h=ke(l,s),d=la(r),c=(d.mean*3-d.min-d.max-d.min)/d.range;c<=0&&(c=.01),c>=1&&(c=.99);let u=T.Triangular(i,{a:0,b:1,c,lhs:!0}),m=ke(u,s),f=4,p=((d.mean*(f+2)-d.min-d.max)/f-d.min)/d.range;p<=0&&(p=.01),p>=1&&(p=.99);let b=T.PERT(i,{a:0,b:1,c:p,lhs:!0}),w=ke(b,s),y=ke(r,s),g=[];for(let M of r)g.push(Math.log(M-d.min+1));let v=ke(g,s),x=[{error:Ge(y,n),distribution:"Normal",parameters:mh(d),sample:o,stats:d},{error:Ge(y,h),distribution:"Uniform",parameters:uh(d),sample:l,stats:d},{error:Ge(y,m),distribution:"Triangular",parameters:ch(d),sample:u,stats:d},{error:Ge(y,w),distribution:"PERT",parameters:dh(4,d),sample:b,stats:d}],_=lh(e);if(_){let M=T.Normal(i,{mean:0,sd:_.stdev,lhs:!0});for(let[B,z]of M.entries())M[B]=Math.abs(z);let A=ke(M,s),P=ke(e,s,d.min);x.push({error:Ge(P,A),distribution:"Half-normal",parameters:_,sample:M,stats:d})}let C=hh(r,d);C&&!isNaN(C.mean)&&!isNaN(C.stdev)&&x.push({error:Ge(v,n),distribution:"Log-normal",parameters:C,sample:o,stats:d});let S=oh(r);if(S){let M=T.Weibull(i,{a:S.alpha,b:S.beta,lhs:!0}),A=ke(M,s);x.push({error:Ge(y,A),distribution:"Weibull",parameters:S,sample:M,stats:d})}let R=nh(r,d);if(R){let M=T.Beta(i,{a:R.alpha,b:R.beta,lhs:!0}),A=ke(M,s);x.push({error:Ge(y,A),distribution:"Beta",parameters:R,sample:M,stats:d})}return x.sort((M,A)=>M.error.mean_square!=A.error.mean_square?M.error.mean_square<A.error.mean_square?-1:1:M.error.mean!=A.error.mean?M.error.mean<A.error.mean?-1:1:M.error.max!=A.error.max?M.error.max<A.error.max?-1:1:M.error.aggregate!=A.error.aggregate?M.error.aggregate<A.error.aggregate?-1:1:Yr[M.distribution]>Yr[A.distribution]?-1:1),x},zi=(...e)=>({type:5,value:e,key:"arguments"}),Ti={"MC.Correlation":{arguments:[{name:"Reference Cell 1",metadata:!0,collector:!0},{name:"Reference Cell 2",metadata:!0,collector:!0},{name:"Title"}],fn:zi},"MC.Histogram":{arguments:[{name:"Reference Cell",metadata:!0,collector:!0},{name:"Title"}],fn:zi},...ms},ph=class extends sr{Exec(e,t){switch(e.toLowerCase()){case"mc.histogram":this.CreateHistogram(t.value);break;case"mc.correlation":this.CreateScatter(t.value);break;default:super.Exec(e,t);break}}CreateScatter([e,t,r]){if(!e||e.type!==5||!this.IsCellData(e.value)){console.warn("invalid args [0]",e),this.Clear();return}if(!t||t.type!==5||!this.IsCellData(t.value)){console.warn("invalid args [1]",t),this.Clear();return}r=r||"";let a=e.value,i=t.value,s=(a.simulation_data||[]).slice(0),o=(i.simulation_data||[]).slice(0),n=Math.min.apply(0,s),l=Math.max.apply(0,s)-n;s=s.map(u=>(u-n)/l);let h=Math.min.apply(0,o),d=Math.max.apply(0,o)-h;o=o.map(u=>(u-h)/d);let c=Math.min(s.length,o.length);this.chart_data={type:"scatter",x:s,y:o,count:c,title:r}}CreateBoxPlot(e,t=!1){let r={type:8,value:[[]]};for(let a of e)typeof a=="number"&&r.value[0].push({type:3,value:a});this.chart_data=us([r,void 0,t])}CreateHistogram([e,t,r,a]){if(!e){this.Clear();return}let i=[],s=[],o=Array.isArray(e.value)?e.value:[e],n=!0;for(let f of o){if(!f||f.type!==5||!this.IsCellData(f.value)){console.warn("invalid args [0]",e),this.Clear();return}let p=f.value.simulation_data||[];if(p.length){let b=Et(p);if(i.push(b.min),s.push(b.max),n){for(let w of p)if(w%1){n=!1;break}}}}if(!i.length||!s.length){this.Clear();return}let l=K.Scale(Math.min.apply(0,i),Math.max.apply(0,s),a||12,void 0,n),h=[];for(let f=0;f<=l.count;f++)h[f]=l.min+f*l.step;let d=o.map(f=>{let p=f.value.simulation_data||[],b=[];for(let v=0;v<=l.count;v++)b[v]=0;for(let v of p){let x=Math.round((v-l.min)/l.step);b[x]++}let w=V.Get("#,##0"),y=b.filter(v=>v||v===0),g={y:{data:b,format:"#,##0",labels:b.map(v=>v===void 0?void 0:w.Format(v)),range:{min:Math.min.apply(0,y),max:Math.max.apply(0,y)}},x:{data:[],range:{min:0,max:Math.max(0,b.length-1)}}};for(let v=0;v<g.y.data.length;v++)g.x.data.push(v);return g}),c=pt(d),u=V.Get(o[0].value?.format||"General"),m=h.map(f=>u.Format(f));d[0].y.labels=(d[0].y.labels||[]).map((f,p)=>m[p]+" "+f),this.chart_data={type:"column",series2:d,scale:c.y.scale,title:t,y_labels:c.y.labels,x_labels:m,data_labels:!0}}IsCellData(e){return!!e&&typeof e=="object"&&typeof e.address=="object"&&typeof e.address.row=="number"&&typeof e.address.column=="number"}},bh=class extends fs{replay_buffer=[];simulation_resolution=[];workers=[];simulation_status={running:!1,threads:0,results:[],completed:0,progress:[],aggregate_progress:0,lv_state:[]};worker_loader={loading:Promise.resolve()};constructor(e){if(super(e),this.worker_loader.loading=this.LoadWorkerModule(),this.dialog){let t=this.dialog.Node("about");if(t){let a=t.textContent||"",i="",s=a.match(/treb version (\d+\.\d+\.\d+)/i);s&&(i=s[1]),t.innerHTML=`<div>RiskAMP web</div><small>TREB version ${i}</small><small><a target=_blank href='https://web.riskamp.com/about'>https://web.riskamp.com</a></small>`}let r=this.dialog.Node("left");r&&(r.style.alignSelf="flex-start",r.style.marginTop="8px",r.innerHTML=`<a href='https://riskamp.com/' style='font-size: 32px;'><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1em" height="1em" viewBox="0 0 170 170" enable-background="new 0 0 170 170" xml:space="preserve"> <circle cx="85" cy="85" r="80" style="fill: var(--logo-background-color, none);"></circle> <path style="fill: var(--logo-color, #0477BE);" d="M85,0C38.056,0,0,38.056,0,85s38.056,85,85,85c46.944,0,85-38.056,85-85S131.944,0,85,0z M55,135H40V92h15	V135z M80,135H65V62.333h15V135z M105,135H90V35h15V135z M130,135h-15V45.333h15V135z"/></svg></a>`)}}ResetInternal(){super.ResetInternal(),this.FlushSimulationResults()}CreateChart(){return this.calculator.RegisterLibrary("treb-charts",Ti)&&this.UpdateAC(),new ph}Fit=(e,t)=>fh(e,t);SimulationData(e){let t=this.model.ResolveAddress(e,this.grid.active_sheet);e=$(t)?t:t.start;let r=e.sheet_id||this.grid.active_sheet.id,a=this.calculator.GetResults();if(!a||!a[r]||!a[r][e.column])return;let i=a[r][e.column][e.row];if(i)return Array.isArray(i)?i.slice(0):Array.from(i)}SerializeDocument(e={}){e={preserve_simulation_data:e.optimize!=="size",...e};let t=super.SerializeDocument(e);return e.preserve_simulation_data&&this.calculator.last_simulation_data&&(t.simulation_data=this.calculator.SerializeSimulationData(e)),t}HandleToolbarMessage(e){e.command==="run-simulation"?(this.RunSimulation(),this.Focus()):super.HandleToolbarMessage(e)}async Transmogrify(){let e=new Set(this.calculator.RiskAMPFunctionList().map(i=>i.toUpperCase())),t=this.SerializeDocument({preserve_simulation_data:!1,rendered_values:!0,expand_arrays:!0,export_colors:!0,decorated_cells:!0,tables:!0,share_resources:!1,export_functions:!0,apply_row_pattern:!0});t.decimal_mark=G.decimal_separator;let r=new Set,a=(i,s,o)=>{if(typeof i.value=="string"&&i.value.startsWith("=")){let n=this.parser.Parse(i.value),l=!1;n.expression&&this.parser.Walk(n.expression,h=>{if(h.type==="call"){let d=h.name.toUpperCase();if(e.has(d))return l=!0,!1}return!0}),l&&(i.area&&(r.add(new k(i.area.start,i.area.end)),i.area=void 0),i.value=i.calculated,i.type=i.calculated_type)}else if(i.calculated!==void 0&&i.value===void 0){for(let n of r)if(n.Contains({row:s,column:o})){i.value=i.calculated,i.type=i.calculated_type,i.area=void 0;break}}};if(t.sheet_data){let i=Array.isArray(t.sheet_data)?t.sheet_data:[t.sheet_data];for(let s of i)if(r.clear(),dr(s.data))for(let o of s.data)a(o,o.row,o.column);else if(ta(s.data))for(let o of s.data)for(let n of o.cells)a(n,o.row,n.column);else for(let o of s.data)for(let n of o.cells)a(n,n.row,o.column)}try{let i=await this.ExportBlob(t),s="export";this.grid.model.document_name&&(s=this.grid.model.document_name.toLowerCase().replace(/\s+/g,"-")),i&&this.SaveAs(i,s+".xlsx")}catch(i){throw i instanceof Error&&/invalid uri/i.test(i.message)&&this.dialog?.ShowDialog({title:"Error exporting file",close_box:!0,message:"The worker cannot run from the filesystem, please use a web server.",timeout:3e3,type:"error"}),i}console.info(t)}EnsureChartsLib(){this.calculator.RegisterLibrary("treb-charts",Ti)&&this.UpdateAC()}async RunSimulation(e=this.options.default_trials||5e3,t={}){let{lhs:r,stepped:a,abort_on_dialog_close:i}={abort_on_dialog_close:!0,lhs:!!this.options.lhs,stepped:this.options.screen_updates||!1,...t},s=t.additional_cells||[];if(this.simulation_status.running)throw new Error("simulation already running");typeof t.seed=="number"&&T.rng.Seed(t.seed),this.dialog?.ShowDialog({title:"Running Monte Carlo simulation",message:"Starting"}).then(()=>{this.simulation_status.running&&i&&this.AbortSimulation()});let o=!1,n=this.options.max_workers||1;if(typeof t.workers=="number"&&(n=t.workers),this.workers.length?e<n&&this.workers.length>1?(n=1,o=!0):(e>=n&&this.workers.length===1&&this.workers.length<n||this.workers.length!==n)&&(o=!0):e<n&&(n=1),!this.workers.length||o)try{await this.InitWorkers(n)}catch{throw this.dialog?.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:"error",timeout:3e3}),new Error("worker not initialized")}if(!this.workers[0])throw this.dialog?.ShowDialog({title:"Calculation failed",message:"Worker not initialized.",close_box:!0,type:"error",timeout:3e3}),new Error("worker not initialized");this.Publish({type:"running-simulation",trials:e}),this.simulation_status.running=!0,this.simulation_status.threads=this.workers.length,this.simulation_status.progress=[],this.simulation_status.results=[],this.simulation_status.aggregate_progress=0,this.simulation_status.completed=0,this.simulation_status.lv_state=[];for(let m=0;m<this.workers.length;m++)this.simulation_status.progress.push(0);for(let m of this.model.sheets.list)for(let f of m.annotations)f.data.formula&&s.push(...this.calculator.CollectorReferences(f.data.formula,m.id));s=this.calculator.FlattenCellList(s);let l;if(this.grid.model.macro_functions){l=[];for(let m of this.model.macro_functions.values())l.push(JSON.parse(JSON.stringify(m)))}let h=this.workers.map(()=>Math.round(T.rng.Next()*1e14));t.replay&&this.replay_buffer.map((m,f)=>h[f]=m);for(let m=0;m<this.workers.length;m++)this.workers[m].postMessage({type:"configure",seed:h[m],locale:G.locale,sheets:this.grid.model.sheets.list.map(f=>f.toJSON({rendered_values:!0,preserve_type:!0})),active_sheet:this.grid.view.active_sheet.id,named:this.model.SerializeNames(),macro_functions:l,additional_cells:s,lv_config:t.lv_config});this.replay_buffer=h,T.rng.Seed(h[0]);let d=e,c=this.workers.length,u=0;for(let m of this.workers){let f=Math.floor(d/c--);m.postMessage({type:"start",trials:f,first_trial:u,lhs:r,screen_updates:a}),u+=f,d-=f}await new Promise(m=>{this.simulation_resolution.push(m)})}Subscribe(e){return this.events.Subscribe(e)}CreateCalculator(e,t){return new Ri(e,{complex_numbers:t.complex,lv:t.lv,spill:t.spill})}Publish(e){this.events.Publish(e)}FlushSimulationResults(){this.calculator.FlushSimulationResults()}async LoadLanguage(e=""){(!e||e==="locale")&&(e=(G.locale||"").split(/-/).map(r=>r.toLowerCase())[0]),e=e.toLowerCase();let t;if(e&&["es","fr","pt","nl","de","pl","sv","no","da","it"].includes(e))try{t=await Fr(Object.assign({"./languages/riskamp-web-i18n-da.mjs":()=>pe(()=>import("./riskamp-web-i18n-da.DeTuwYZg.js"),[]),"./languages/riskamp-web-i18n-de.mjs":()=>pe(()=>import("./riskamp-web-i18n-de.BA_YMXN8.js"),[]),"./languages/riskamp-web-i18n-es.mjs":()=>pe(()=>import("./riskamp-web-i18n-es.BiBcGyPF.js"),[]),"./languages/riskamp-web-i18n-fr.mjs":()=>pe(()=>import("./riskamp-web-i18n-fr.C8C-GFHG.js"),[]),"./languages/riskamp-web-i18n-it.mjs":()=>pe(()=>import("./riskamp-web-i18n-it.CX6Qib0d.js"),[]),"./languages/riskamp-web-i18n-nl.mjs":()=>pe(()=>import("./riskamp-web-i18n-nl.dL0zRlTo.js"),[]),"./languages/riskamp-web-i18n-no.mjs":()=>pe(()=>import("./riskamp-web-i18n-no.BdgYKNB9.js"),[]),"./languages/riskamp-web-i18n-pl.mjs":()=>pe(()=>import("./riskamp-web-i18n-pl.CW0QuZcC.js"),[]),"./languages/riskamp-web-i18n-pt.mjs":()=>pe(()=>import("./riskamp-web-i18n-pt.CI3wD_SY.js"),[]),"./languages/riskamp-web-i18n-sv.mjs":()=>pe(()=>import("./riskamp-web-i18n-sv.qoHZjFqn.js"),[])}),`./languages/riskamp-web-i18n-${e}.mjs`,3)}catch(r){console.error(r)}t?this.model.SetLanguage(t.LanguageMap):this.model.SetLanguage(),this.grid.Reselect(),this.grid.Update(!0),this.UpdateAC()}async LoadWorkerModule(){try{let e="calculation";this.worker_loader.CreateWorker=(await Fr(Object.assign({"./riskamp-calculation-worker.mjs":()=>pe(()=>import("./riskamp-calculation-worker.C63d3wu3.js"),[])}),`./riskamp-${e}-worker.mjs`,2)).CreateWorker;return}catch(e){throw console.error(e),e}}async LoadMCWorker(){if(await this.worker_loader.loading,this.worker_loader.CreateWorker)return await this.worker_loader.CreateWorker();throw new Error("worker not initialized")}async InitWorkers(e=this.options.max_workers){if(e=e||1,this.workers.length){for(let r of this.workers)r.terminate();this.workers=[]}let t=Math.max(1,e);typeof navigator.hardwareConcurrency=="number"&&(t=Math.min(t,navigator.hardwareConcurrency)),console.info(`creating ${t} thread${t===1?"":"s"}`);for(let r=0;r<t;r++)this.workers[r]=await this.LoadMCWorker(),this.workers[r].onmessage=a=>{let i=a.data;this.HandleWorkerMessage(i,r)},this.workers[r].onerror=a=>{console.error(`worker error (worker #${r})`),console.info(a);let i=a.message||"Worker error.";this.dialog?.ShowDialog({title:"Calculation failed",message:i,close_box:!0,type:"error",timeout:3e3});for(let s of this.simulation_resolution)s.call(this);this.simulation_resolution=[],this.simulation_status.running=!1;for(let s of this.workers)s.terminate();this.workers=[]}}InitCalculator(){return new Ri(this.model)}ImportDocumentData(e,t){super.ImportDocumentData(e,t),e.simulation_data?this.calculator.UnserializeSimulationData(e.simulation_data):this.FlushSimulationResults()}UpdateProgress(e,t){this.simulation_status.progress[t]=e||0;let r=Math.round(this.simulation_status.progress.reduce((a,i)=>a+i,0)/this.simulation_status.threads);r!==this.simulation_status.aggregate_progress&&(this.simulation_status.aggregate_progress=r,this.dialog?.Update({message:`${r}% complete`}),this.Publish({type:"simulation-progress",progress:r}))}HandleWorkerMessage(e,t){switch(e.type){case"update":this.UpdateProgress(e.percent_complete,t),this.simulation_status.results[t]=e.trial_data,e.lv_state&&(this.simulation_status.lv_state[t]=e.lv_state),this.calculator.ConsolidateLVState(this.simulation_status.lv_state),this.calculator.last_simulation_data=ei(this.simulation_status.results.filter(r=>!!r)),this.calculator.UpdateResults(),this.Recalculate(),this.workers[t].postMessage({type:"step"});break;case"progress":this.UpdateProgress(e.percent_complete,t);break;case"complete":this.simulation_status.progress[t]=100,this.simulation_status.results[t]=e.trial_data,this.simulation_status.completed++,e.lv_state&&(this.simulation_status.lv_state[t]=e.lv_state),this.simulation_status.completed===this.simulation_status.threads?(this.simulation_status.running=!1,this.calculator.last_simulation_data=ei(this.simulation_status.results),this.calculator.ConsolidateLVState(this.simulation_status.lv_state),requestAnimationFrame(()=>{this.calculator.UpdateResults(),this.Recalculate(),this.grid.headless||this.Focus(),setTimeout(()=>{this.dialog?.HideDialog(),this.Publish({type:"simulation-complete",elapsed:this.calculator.last_simulation_data?.elapsed||0,trials:this.calculator.last_simulation_data?.trials||0});for(let r of this.simulation_resolution)r.call(this);this.simulation_resolution=[]},500)})):this.UpdateProgress(100,t);break;default:console.info("unhandled worker message",e);break}}AbortSimulation(){console.warn("aborting simulation");for(let e of this.workers)e.terminate();this.workers=[],this.simulation_status.running=!1,requestAnimationFrame(()=>{this.Recalculate(),this.grid.headless||this.Focus(),this.Publish({type:"simulation-aborted"});for(let e of this.simulation_resolution)e.call(this);this.simulation_resolution=[]})}},gh=`riskamp-web{display:block;position:relative}.treb-main [data-command=run-simulation]{--icon:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 28'%3E%3Cpath fill='currentColor' d='M18.5 14a.97.97 0 0 1-.5.859l-8.5 5c-.156.094-.328.141-.5.141s-.344-.047-.5-.125A1.01 1.01 0 0 1 8 19V9c0-.359.187-.688.5-.875a.99.99 0 0 1 1 .016l8.5 5c.313.172.5.5.5.859'/%3E%3Cpath d='M20.5 14c0-4.688-3.813-8.5-8.5-8.5S3.5 9.313 3.5 14s3.813 8.5 8.5 8.5 8.5-3.813 8.5-8.5m3.5 0c0 6.625-5.375 12-12 12S0 20.625 0 14 5.375 2 12 2s12 5.375 12 12'/%3E%3C/svg%3E")}`,ys=class extends bs{constructor(e){if(super(e),typeof HTMLElement<"u"&&e instanceof HTMLElement&&!document.head.querySelector("style[riskamp-web-stylesheet]")){let t=document.createElement("style");t.setAttribute("riskamp-web-stylesheet",""),t.textContent=gh,document.head.prepend(t)}}AttachElement(e={}){if(e={...this.ParseOptionAttributes(),...e},this.root){if(!e.headless){let a=this.root.getBoundingClientRect();(!a.width||!a.height)&&this.root.classList.add("treb-default-size")}this.root.innerHTML=ps;let t=this.root.querySelector(".treb-layout-sidebar"),r=document.createElement("button");r.dataset.command="run-simulation",r.title="Run simulation",t&&t.insertBefore(r,t.firstChild),e.container=this.root.querySelector(".treb-layout-spreadsheet")}this.sheet=new bh(e),this.root&&this.CreateLayout(this.sheet,this.root)}},_h=class{version="32.1.1";CreateSpreadsheet(e){let t=e.container,r=new bs(t);if(r.AttachElement(e),!r.sheet)throw new Error("construction failed");return r.sheet}},vh=class extends _h{version="32.1.1";CreateSpreadsheet(e){let t=e.container,r=new ys(t);if(r.AttachElement(e),!r.sheet)throw new Error("construction failed");return r.sheet}},yh=new vh;if(typeof HTMLElement<"u"){class e extends HTMLElement{get sheet(){return this.instance.sheet}instance;constructor(){super(),this.instance=new ys(this)}connectedCallback(){this.instance.AttachElement()}}typeof customElements<"u"&&(customElements.get("riskamp-web")?console.info("custom element riskamp-web is already defined."):customElements.define("riskamp-web",e))}for(const e of document.querySelectorAll(".embedded-spreadsheet"))if(e instanceof HTMLElement&&!e.dataset.populated){let t={};e.dataset.options&&(t=JSON.parse(e.dataset.options));const r={container:e,scale:.95,screen_updates:50,tab_bar:"auto",...t};e.dataset.doc&&(r.document=e.dataset.doc),e.dataset.populated="true",yh.CreateSpreadsheet(r)}
